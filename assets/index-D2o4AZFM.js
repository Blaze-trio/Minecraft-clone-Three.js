import{r as y,u as de,c as w2,a as We,_ as _e,D as wi,V as K,b as Fe,P as ri,O as vi,R as Us,d as Sc,e as Hs,M as Me,Q as ht,f as bn,S as fa,g as Ci,C as et,E as Wn,h as x0,T as LI,i as Mm,j as wn,k as ot,v as cc,l as je,I as Lm,m as Fr,n as Mi,F as hi,o as Ln,N as li,B as Jt,p as PI,q as S0,s as B2,t as Gi,w as nn,x as un,y as FI,z as bi,A as R2,G as eh,H as th,J as Pm,K as kI,L as qo,U as Ca,W as Ei,X as Th,Y as ms,Z as ia,$ as Qn,a0 as Gr,a1 as ji,a2 as Mt,a3 as an,a4 as Qr,a5 as D2,a6 as Tc,a7 as fs,a8 as xr,a9 as Ia,aa as or,ab as oi,ac as Af,ad as OI,ae as Kl,af as _i,ag as jt,ah as Fm,ai as UI,aj as Ur,ak as na,al as In,am as es,an as M2,ao as T0,ap as L2,aq as $l,ar as lr,as as NI,at as GI,au as uc,av as QI,aw as zI,ax as HI,ay as VI,az as Bn,aA as P2,aB as Uu,aC as bh,aD as jl,aE as km,aF as KI,aG as $I,aH as jI,aI as F2,aJ as b0,aK as YI,aL as k2,aM as eo,aN as tn,aO as w0,aP as Yl,aQ as WI,aR as qI,aS as O2,aT as XI,aU as pf,aV as Om,aW as U2,aX as JI,aY as ZI,aZ as Ir,a_ as wh,a$ as N2,b0 as $i,b1 as gp,b2 as Fs,b3 as Xo,b4 as Ai,b5 as e_,b6 as t_,b7 as i_,b8 as n_,b9 as s_,ba as r_,bb as o_,bc as a_,bd as l_,be as G2,bf as Jo,bg as c_,bh as u_,bi as Q2,bj as gf,bk as Um,bl as B0,bm as h_,bn as R0,bo as Ns,bp as f_,bq as d_,br as z2,bs as m_,bt as gi,bu as A_,bv as p_,bw as H2,bx as V2,by as Zo,bz as fr,bA as g_,bB as Bh,bC as xi,bD as Nm,bE as y_,bF as hc,bG as uo,bH as K2,bI as v_,bJ as $2,bK as ih,bL as no,bM as Rh,bN as Dh,bO as j2,bP as E_,bQ as Nr,bR as Y2,bS as Gm,bT as C_,bU as W2,bV as q2,bW as Qm,bX as zm,bY as Hm,bZ as Mh,b_ as X2,b$ as I_,c0 as Nu,c1 as D0,c2 as J2,c3 as Z2,c4 as __,c5 as Sn,c6 as x_,c7 as nh,c8 as S_,c9 as M0,ca as T_,cb as yp,cc as b_,cd as w_,ce as B_,cf as R_,cg as yf,ch as D_,ci as vf,cj as M_,ck as L_,cl as eE,cm as P_}from"./index-ZNtRKNWs.js";import{cn as rU,co as oU,cp as aU}from"./index-ZNtRKNWs.js";const fc=new K,Vm=new K,F_=new K,vp=new Fe;function k_(r,e,t){const i=fc.setFromMatrixPosition(r.matrixWorld);i.project(e);const n=t.width/2,s=t.height/2;return[i.x*n+n,-(i.y*s)+s]}function O_(r,e){const t=fc.setFromMatrixPosition(r.matrixWorld),i=Vm.setFromMatrixPosition(e.matrixWorld),n=t.sub(i),s=e.getWorldDirection(F_);return n.angleTo(s)>Math.PI/2}function U_(r,e,t,i){const n=fc.setFromMatrixPosition(r.matrixWorld),s=n.clone();s.project(e),vp.set(s.x,s.y),t.setFromCamera(vp,e);const o=t.intersectObjects(i,!0);if(o.length){const a=o[0].distance;return n.distanceTo(t.ray.origin)<a}return!0}function N_(r,e){if(e instanceof vi)return e.zoom;if(e instanceof ri){const t=fc.setFromMatrixPosition(r.matrixWorld),i=Vm.setFromMatrixPosition(e.matrixWorld),n=e.fov*Math.PI/180,s=t.distanceTo(i);return 1/(2*Math.tan(n/2)*s)}else return 1}function G_(r,e,t){if(e instanceof ri||e instanceof vi){const i=fc.setFromMatrixPosition(r.matrixWorld),n=Vm.setFromMatrixPosition(e.matrixWorld),s=i.distanceTo(n),o=(t[1]-t[0])/(e.far-e.near),a=t[1]-o*e.far;return Math.round(o*s+a)}}const L0=r=>Math.abs(r)<1e-10?0:r;function tE(r,e,t=""){let i="matrix3d(";for(let n=0;n!==16;n++)i+=L0(e[n]*r.elements[n])+(n!==15?",":")");return t+i}const Q_=(r=>e=>tE(e,r))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),z_=(r=>(e,t)=>tE(e,r(t),"translate(-50%,-50%)"))(r=>[1/r,1/r,1/r,1,-1/r,-1/r,-1/r,-1,1/r,1/r,1/r,1,1,1,1,1]);function H_(r){return r&&typeof r=="object"&&"current"in r}const Lh=y.forwardRef(({children:r,eps:e=.001,style:t,className:i,prepend:n,center:s,fullscreen:o,portal:a,distanceFactor:l,sprite:c=!1,transform:u=!1,occlude:h,onOcclude:f,castShadow:d,receiveShadow:m,material:A,geometry:p,zIndexRange:g=[16777271,0],calculatePosition:v=k_,as:E="div",wrapperClass:C,pointerEvents:I="auto",..._},x)=>{const{gl:S,camera:b,scene:T,size:B,raycaster:w,events:R,viewport:D}=de(),[G]=y.useState(()=>document.createElement(E)),z=y.useRef(),W=y.useRef(null),q=y.useRef(0),F=y.useRef([0,0]),N=y.useRef(null),L=y.useRef(null),$=a?.current||R.connected||S.domElement.parentNode,j=y.useRef(null),V=y.useRef(!1),k=y.useMemo(()=>h&&h!=="blending"||Array.isArray(h)&&h.length&&H_(h[0]),[h]);y.useLayoutEffect(()=>{const le=S.domElement;h&&h==="blending"?(le.style.zIndex=`${Math.floor(g[0]/2)}`,le.style.position="absolute",le.style.pointerEvents="none"):(le.style.zIndex=null,le.style.position=null,le.style.pointerEvents=null)},[h]),y.useLayoutEffect(()=>{if(W.current){const le=z.current=w2.createRoot(G);if(T.updateMatrixWorld(),u)G.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const ee=v(W.current,b,B);G.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${ee[0]}px,${ee[1]}px,0);transform-origin:0 0;`}return $&&(n?$.prepend(G):$.appendChild(G)),()=>{$&&$.removeChild(G),le.unmount()}}},[$,u]),y.useLayoutEffect(()=>{C&&(G.className=C)},[C]);const Q=y.useMemo(()=>u?{position:"absolute",top:0,left:0,width:B.width,height:B.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:s?"translate3d(-50%,-50%,0)":"none",...o&&{top:-B.height/2,left:-B.width/2,width:B.width,height:B.height},...t},[t,s,o,B,u]),O=y.useMemo(()=>({position:"absolute",pointerEvents:I}),[I]);y.useLayoutEffect(()=>{if(V.current=!1,u){var le;(le=z.current)==null||le.render(y.createElement("div",{ref:N,style:Q},y.createElement("div",{ref:L,style:O},y.createElement("div",{ref:x,className:i,style:t,children:r}))))}else{var ee;(ee=z.current)==null||ee.render(y.createElement("div",{ref:x,style:Q,className:i,children:r}))}});const U=y.useRef(!0);We(le=>{if(W.current){b.updateMatrixWorld(),W.current.updateWorldMatrix(!0,!1);const ee=u?F.current:v(W.current,b,B);if(u||Math.abs(q.current-b.zoom)>e||Math.abs(F.current[0]-ee[0])>e||Math.abs(F.current[1]-ee[1])>e){const se=O_(W.current,b);let Ee=!1;k&&(Array.isArray(h)?Ee=h.map(Ae=>Ae.current):h!=="blending"&&(Ee=[T]));const Ie=U.current;if(Ee){const Ae=U_(W.current,b,w,Ee);U.current=Ae&&!se}else U.current=!se;Ie!==U.current&&(f?f(!U.current):G.style.display=U.current?"block":"none");const oe=Math.floor(g[0]/2),ce=h?k?[g[0],oe]:[oe-1,0]:g;if(G.style.zIndex=`${G_(W.current,b,ce)}`,u){const[Ae,he]=[B.width/2,B.height/2],Z=b.projectionMatrix.elements[5]*he,{isOrthographicCamera:J,top:ue,left:Te,bottom:we,right:Le}=b,Be=Q_(b.matrixWorldInverse),qe=J?`scale(${Z})translate(${L0(-(Le+Te)/2)}px,${L0((ue+we)/2)}px)`:`translateZ(${Z}px)`;let Oe=W.current.matrixWorld;c&&(Oe=b.matrixWorldInverse.clone().transpose().copyPosition(Oe).scale(W.current.scale),Oe.elements[3]=Oe.elements[7]=Oe.elements[11]=0,Oe.elements[15]=1),G.style.width=B.width+"px",G.style.height=B.height+"px",G.style.perspective=J?"":`${Z}px`,N.current&&L.current&&(N.current.style.transform=`${qe}${Be}translate(${Ae}px,${he}px)`,L.current.style.transform=z_(Oe,1/((l||10)/400)))}else{const Ae=l===void 0?1:N_(W.current,b)*l;G.style.transform=`translate3d(${ee[0]}px,${ee[1]}px,0) scale(${Ae})`}F.current=ee,q.current=b.zoom}}if(!k&&j.current&&!V.current)if(u){if(N.current){const ee=N.current.children[0];if(ee!=null&&ee.clientWidth&&ee!=null&&ee.clientHeight){const{isOrthographicCamera:se}=b;if(se||p)_.scale&&(Array.isArray(_.scale)?_.scale instanceof K?j.current.scale.copy(_.scale.clone().divideScalar(1)):j.current.scale.set(1/_.scale[0],1/_.scale[1],1/_.scale[2]):j.current.scale.setScalar(1/_.scale));else{const Ee=(l||10)/400,Ie=ee.clientWidth*Ee,oe=ee.clientHeight*Ee;j.current.scale.set(Ie,oe,1)}V.current=!0}}}else{const ee=G.children[0];if(ee!=null&&ee.clientWidth&&ee!=null&&ee.clientHeight){const se=1/D.factor,Ee=ee.clientWidth*se,Ie=ee.clientHeight*se;j.current.scale.set(Ee,Ie,1),V.current=!0}j.current.lookAt(le.camera.position)}});const te=y.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return y.createElement("group",_e({},_,{ref:W}),h&&!k&&y.createElement("mesh",{castShadow:d,receiveShadow:m,ref:j},p||y.createElement("planeGeometry",null),A||y.createElement("shaderMaterial",{side:wi,vertexShader:te.vertexShader,fragmentShader:te.fragmentShader})))});function nF({onChanged:r,portal:e,preventDefault:t=!0,scroll:i=!0,keyCode:n=9}){const s=y.useRef(0),o=de(c=>c.setEvents),a=de(c=>c.get),l=de(c=>c.gl);return y.useEffect(()=>{var c;let u=[],h;const f=a().events.filter,d=(c=e?.current)!==null&&c!==void 0?c:l.domElement.parentNode,m=()=>d&&r&&r(u,Math.round(s.current)%u.length);o({filter:(E,C)=>{let I=[...E];(I.length!==u.length||!u.every(_=>I.map(x=>x.object.uuid).includes(_.object.uuid)))&&(s.current=0,u=I,m()),f&&(I=f(I,C));for(let _=0;_<Math.round(s.current)%I.length;_++){const x=I.shift();I=[...I,x]}return I}});const A=E=>{var C,I;s.current=E(s.current),(C=a().events.handlers)==null||C.onPointerCancel(void 0),(I=a().events.handlers)==null||I.onPointerMove(h),m()},p=E=>{(E.keyCode||E.which)===n&&(t&&E.preventDefault(),u.length>1&&A(C=>C+1))},g=E=>{t&&E.preventDefault();let C=0;E||(E=window.event),E.wheelDelta?C=E.wheelDelta/120:E.detail&&(C=-E.detail/3),u.length>1&&A(I=>Math.abs(I-C))},v=E=>h=E;return document.addEventListener("pointermove",v,{passive:!0}),i&&document.addEventListener("wheel",g),n!==void 0&&document.addEventListener("keydown",p),()=>{o({filter:f}),n!==void 0&&document.removeEventListener("keydown",p),i&&document.removeEventListener("wheel",g),document.removeEventListener("pointermove",v)}},[l,a,o,t,i,n]),null}function sF(r,e="pointer",t="auto",i=document.body){y.useEffect(()=>{if(r)return i.style.cursor=e,()=>void(i.style.cursor=t)},[r])}const Ep=r=>{let e;const t=new Set,i=(c,u)=>{const h=typeof c=="function"?c(e):c;if(!Object.is(h,e)){const f=e;e=u??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(d=>d(e,f))}},n=()=>e,a={setState:i,getState:n,getInitialState:()=>l,subscribe:c=>(t.add(c),()=>t.delete(c))},l=e=r(i,n,a);return a},V_=r=>r?Ep(r):Ep,K_=r=>r;function $_(r,e=K_){const t=Us.useSyncExternalStore(r.subscribe,()=>e(r.getState()),()=>e(r.getInitialState()));return Us.useDebugValue(t),t}const Cp=r=>{const e=V_(r),t=i=>$_(e,i);return Object.assign(t,e),t},iE=r=>r?Cp(r):Cp;let Ma=0;const nE=iE(r=>(Sc.onStart=(e,t,i)=>{r({active:!0,item:e,loaded:t,total:i,progress:(t-Ma)/(i-Ma)*100})},Sc.onLoad=()=>{r({active:!1})},Sc.onError=e=>r(t=>({errors:[...t.errors,e]})),Sc.onProgress=(e,t,i)=>{t===i&&(Ma=i),r({active:!0,item:e,loaded:t,total:i,progress:(t-Ma)/(i-Ma)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}));function rF({children:r}){const e=nE();return y.createElement(y.Fragment,null,r?.(e))}const j_=r=>`Loading ${r.toFixed(2)}%`;function oF({containerStyles:r,innerStyles:e,barStyles:t,dataStyles:i,dataInterpolation:n=j_,initialState:s=o=>o}){const{active:o,progress:a}=nE(),l=y.useRef(0),c=y.useRef(0),u=y.useRef(null),[h,f]=y.useState(s(o));y.useEffect(()=>{let m;return o!==h&&(m=setTimeout(()=>f(o),300)),()=>clearTimeout(m)},[h,o]);const d=y.useCallback(()=>{u.current&&(l.current+=(a-l.current)/2,(l.current>.95*a||a===100)&&(l.current=a),u.current.innerText=n(l.current),l.current<a&&(c.current=requestAnimationFrame(d)))},[n,a]);return y.useEffect(()=>(d(),()=>cancelAnimationFrame(c.current)),[d]),h?y.createElement("div",{style:{...bc.container,opacity:o?1:0,...r}},y.createElement("div",null,y.createElement("div",{style:{...bc.inner,...e}},y.createElement("div",{style:{...bc.bar,transform:`scaleX(${a/100})`,...t}}),y.createElement("span",{ref:u,style:{...bc.data,...i}})))):null}const bc={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};var Ef={exports:{}},Fn={},Di={},La={},Ip;function Y_(){if(Ip)return La;Ip=1;function r(s,o,a){return Math.max(o,Math.min(s,a))}const e={toVector(s,o){return s===void 0&&(s=o),Array.isArray(s)?s:[s,s]},add(s,o){return[s[0]+o[0],s[1]+o[1]]},sub(s,o){return[s[0]-o[0],s[1]-o[1]]},addTo(s,o){s[0]+=o[0],s[1]+=o[1]},subTo(s,o){s[0]-=o[0],s[1]-=o[1]}};function t(s,o,a){return o===0||Math.abs(o)===1/0?Math.pow(s,a*5):s*o*a/(o+a*s)}function i(s,o,a,l=.15){return l===0?r(s,o,a):s<o?-t(o-s,a-o,l)+o:s>a?+t(s-a,a-o,l)+a:s}function n(s,[o,a],[l,c]){const[[u,h],[f,d]]=s;return[i(o,u,h,l),i(a,f,d,c)]}return La.V=e,La.computeRubberband=n,La.rubberbandIfOutOfBounds=i,La}var _p;function sE(){if(_p)return Di;_p=1;var r=Y_();function e(ie,P){if(typeof ie!="object"||ie===null)return ie;var Y=ie[Symbol.toPrimitive];if(Y!==void 0){var ae=Y.call(ie,P);if(typeof ae!="object")return ae;throw new TypeError("@@toPrimitive must return a primitive value.")}return(P==="string"?String:Number)(ie)}function t(ie){var P=e(ie,"string");return typeof P=="symbol"?P:String(P)}function i(ie,P,Y){return P=t(P),P in ie?Object.defineProperty(ie,P,{value:Y,enumerable:!0,configurable:!0,writable:!0}):ie[P]=Y,ie}function n(ie,P){var Y=Object.keys(ie);if(Object.getOwnPropertySymbols){var ae=Object.getOwnPropertySymbols(ie);P&&(ae=ae.filter(function(ke){return Object.getOwnPropertyDescriptor(ie,ke).enumerable})),Y.push.apply(Y,ae)}return Y}function s(ie){for(var P=1;P<arguments.length;P++){var Y=arguments[P]!=null?arguments[P]:{};P%2?n(Object(Y),!0).forEach(function(ae){i(ie,ae,Y[ae])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ie,Object.getOwnPropertyDescriptors(Y)):n(Object(Y)).forEach(function(ae){Object.defineProperty(ie,ae,Object.getOwnPropertyDescriptor(Y,ae))})}return ie}const o={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function a(ie){return ie?ie[0].toUpperCase()+ie.slice(1):""}const l=["enter","leave"];function c(ie=!1,P){return ie&&!l.includes(P)}function u(ie,P="",Y=!1){const ae=o[ie],ke=ae&&ae[P]||P;return"on"+a(ie)+a(ke)+(c(Y,ke)?"Capture":"")}const h=["gotpointercapture","lostpointercapture"];function f(ie){let P=ie.substring(2).toLowerCase();const Y=!!~P.indexOf("passive");Y&&(P=P.replace("passive",""));const ae=h.includes(P)?"capturecapture":"capture",ke=!!~P.indexOf(ae);return ke&&(P=P.replace("capture","")),{device:P,capture:ke,passive:Y}}function d(ie,P=""){const Y=o[ie],ae=Y&&Y[P]||P;return ie+ae}function m(ie){return"touches"in ie}function A(ie){return m(ie)?"touch":"pointerType"in ie?ie.pointerType:"mouse"}function p(ie){return Array.from(ie.touches).filter(P=>{var Y,ae;return P.target===ie.currentTarget||((Y=ie.currentTarget)===null||Y===void 0||(ae=Y.contains)===null||ae===void 0?void 0:ae.call(Y,P.target))})}function g(ie){return ie.type==="touchend"||ie.type==="touchcancel"?ie.changedTouches:ie.targetTouches}function v(ie){return m(ie)?g(ie)[0]:ie}function E(ie,P){try{const Y=P.clientX-ie.clientX,ae=P.clientY-ie.clientY,ke=(P.clientX+ie.clientX)/2,at=(P.clientY+ie.clientY)/2,bt=Math.hypot(Y,ae);return{angle:-(Math.atan2(Y,ae)*180)/Math.PI,distance:bt,origin:[ke,at]}}catch{}return null}function C(ie){return p(ie).map(P=>P.identifier)}function I(ie,P){const[Y,ae]=Array.from(ie.touches).filter(ke=>P.includes(ke.identifier));return E(Y,ae)}function _(ie){const P=v(ie);return m(ie)?P.identifier:P.pointerId}function x(ie){const P=v(ie);return[P.clientX,P.clientY]}const S=40,b=800;function T(ie){let{deltaX:P,deltaY:Y,deltaMode:ae}=ie;return ae===1?(P*=S,Y*=S):ae===2&&(P*=b,Y*=b),[P,Y]}function B(ie){var P,Y;const{scrollX:ae,scrollY:ke,scrollLeft:at,scrollTop:bt}=ie.currentTarget;return[(P=ae??at)!==null&&P!==void 0?P:0,(Y=ke??bt)!==null&&Y!==void 0?Y:0]}function w(ie){const P={};if("buttons"in ie&&(P.buttons=ie.buttons),"shiftKey"in ie){const{shiftKey:Y,altKey:ae,metaKey:ke,ctrlKey:at}=ie;Object.assign(P,{shiftKey:Y,altKey:ae,metaKey:ke,ctrlKey:at})}return P}function R(ie,...P){return typeof ie=="function"?ie(...P):ie}function D(){}function G(...ie){return ie.length===0?D:ie.length===1?ie[0]:function(){let P;for(const Y of ie)P=Y.apply(this,arguments)||P;return P}}function z(ie,P){return Object.assign({},P,ie||{})}const W=32;class q{constructor(P,Y,ae){this.ctrl=P,this.args=Y,this.key=ae,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(P){this.ctrl.state[this.key]=P}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:P,shared:Y,ingKey:ae,args:ke}=this;Y[ae]=P._active=P.active=P._blocked=P._force=!1,P._step=[!1,!1],P.intentional=!1,P._movement=[0,0],P._distance=[0,0],P._direction=[0,0],P._delta=[0,0],P._bounds=[[-1/0,1/0],[-1/0,1/0]],P.args=ke,P.axis=void 0,P.memo=void 0,P.elapsedTime=P.timeDelta=0,P.direction=[0,0],P.distance=[0,0],P.overflow=[0,0],P._movementBound=[!1,!1],P.velocity=[0,0],P.movement=[0,0],P.delta=[0,0],P.timeStamp=0}start(P){const Y=this.state,ae=this.config;Y._active||(this.reset(),this.computeInitial(),Y._active=!0,Y.target=P.target,Y.currentTarget=P.currentTarget,Y.lastOffset=ae.from?R(ae.from,Y):Y.offset,Y.offset=Y.lastOffset,Y.startTime=Y.timeStamp=P.timeStamp)}computeValues(P){const Y=this.state;Y._values=P,Y.values=this.config.transform(P)}computeInitial(){const P=this.state;P._initial=P._values,P.initial=P.values}compute(P){const{state:Y,config:ae,shared:ke}=this;Y.args=this.args;let at=0;if(P&&(Y.event=P,ae.preventDefault&&P.cancelable&&Y.event.preventDefault(),Y.type=P.type,ke.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,ke.locked=!!document.pointerLockElement,Object.assign(ke,w(P)),ke.down=ke.pressed=ke.buttons%2===1||ke.touches>0,at=P.timeStamp-Y.timeStamp,Y.timeStamp=P.timeStamp,Y.elapsedTime=Y.timeStamp-Y.startTime),Y._active){const Ne=Y._delta.map(Math.abs);r.V.addTo(Y._distance,Ne)}this.axisIntent&&this.axisIntent(P);const[bt,Yt]=Y._movement,[Pi,Bi]=ae.threshold,{_step:Ft,values:At}=Y;if(ae.hasCustomTransform?(Ft[0]===!1&&(Ft[0]=Math.abs(bt)>=Pi&&At[0]),Ft[1]===!1&&(Ft[1]=Math.abs(Yt)>=Bi&&At[1])):(Ft[0]===!1&&(Ft[0]=Math.abs(bt)>=Pi&&Math.sign(bt)*Pi),Ft[1]===!1&&(Ft[1]=Math.abs(Yt)>=Bi&&Math.sign(Yt)*Bi)),Y.intentional=Ft[0]!==!1||Ft[1]!==!1,!Y.intentional)return;const ni=[0,0];if(ae.hasCustomTransform){const[Ne,Qe]=At;ni[0]=Ft[0]!==!1?Ne-Ft[0]:0,ni[1]=Ft[1]!==!1?Qe-Ft[1]:0}else ni[0]=Ft[0]!==!1?bt-Ft[0]:0,ni[1]=Ft[1]!==!1?Yt-Ft[1]:0;this.restrictToAxis&&!Y._blocked&&this.restrictToAxis(ni);const fn=Y.offset,H=Y._active&&!Y._blocked||Y.active;H&&(Y.first=Y._active&&!Y.active,Y.last=!Y._active&&Y.active,Y.active=ke[this.ingKey]=Y._active,P&&(Y.first&&("bounds"in ae&&(Y._bounds=R(ae.bounds,Y)),this.setup&&this.setup()),Y.movement=ni,this.computeOffset()));const[X,ne]=Y.offset,[[pe,xe],[Se,Ge]]=Y._bounds;Y.overflow=[X<pe?-1:X>xe?1:0,ne<Se?-1:ne>Ge?1:0],Y._movementBound[0]=Y.overflow[0]?Y._movementBound[0]===!1?Y._movement[0]:Y._movementBound[0]:!1,Y._movementBound[1]=Y.overflow[1]?Y._movementBound[1]===!1?Y._movement[1]:Y._movementBound[1]:!1;const Pe=Y._active?ae.rubberband||[0,0]:[0,0];if(Y.offset=r.computeRubberband(Y._bounds,Y.offset,Pe),Y.delta=r.V.sub(Y.offset,fn),this.computeMovement(),H&&(!Y.last||at>W)){Y.delta=r.V.sub(Y.offset,fn);const Ne=Y.delta.map(Math.abs);r.V.addTo(Y.distance,Ne),Y.direction=Y.delta.map(Math.sign),Y._direction=Y._delta.map(Math.sign),!Y.first&&at>0&&(Y.velocity=[Ne[0]/at,Ne[1]/at],Y.timeDelta=at)}}emit(){const P=this.state,Y=this.shared,ae=this.config;if(P._active||this.clean(),(P._blocked||!P.intentional)&&!P._force&&!ae.triggerAllEvents)return;const ke=this.handler(s(s(s({},Y),P),{},{[this.aliasKey]:P.values}));ke!==void 0&&(P.memo=ke)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}function F([ie,P],Y){const ae=Math.abs(ie),ke=Math.abs(P);if(ae>ke&&ae>Y)return"x";if(ke>ae&&ke>Y)return"y"}class N extends q{constructor(...P){super(...P),i(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=r.V.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=r.V.sub(this.state.offset,this.state.lastOffset)}axisIntent(P){const Y=this.state,ae=this.config;if(!Y.axis&&P){const ke=typeof ae.axisThreshold=="object"?ae.axisThreshold[A(P)]:ae.axisThreshold;Y.axis=F(Y._movement,ke)}Y._blocked=(ae.lockDirection||!!ae.axis)&&!Y.axis||!!ae.axis&&ae.axis!==Y.axis}restrictToAxis(P){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":P[1]=0;break;case"y":P[0]=0;break}}}const L=ie=>ie,$=.15,j={enabled(ie=!0){return ie},eventOptions(ie,P,Y){return s(s({},Y.shared.eventOptions),ie)},preventDefault(ie=!1){return ie},triggerAllEvents(ie=!1){return ie},rubberband(ie=0){switch(ie){case!0:return[$,$];case!1:return[0,0];default:return r.V.toVector(ie)}},from(ie){if(typeof ie=="function")return ie;if(ie!=null)return r.V.toVector(ie)},transform(ie,P,Y){const ae=ie||Y.shared.transform;return this.hasCustomTransform=!!ae,ae||L},threshold(ie){return r.V.toVector(ie,0)}},V=0,k=s(s({},j),{},{axis(ie,P,{axis:Y}){if(this.lockDirection=Y==="lock",!this.lockDirection)return Y},axisThreshold(ie=V){return ie},bounds(ie={}){if(typeof ie=="function")return at=>k.bounds(ie(at));if("current"in ie)return()=>ie.current;if(typeof HTMLElement=="function"&&ie instanceof HTMLElement)return ie;const{left:P=-1/0,right:Y=1/0,top:ae=-1/0,bottom:ke=1/0}=ie;return[[P,Y],[ae,ke]]}}),Q={ArrowRight:(ie,P=1)=>[ie*P,0],ArrowLeft:(ie,P=1)=>[-1*ie*P,0],ArrowUp:(ie,P=1)=>[0,-1*ie*P],ArrowDown:(ie,P=1)=>[0,ie*P]};class O extends N{constructor(...P){super(...P),i(this,"ingKey","dragging")}reset(){super.reset();const P=this.state;P._pointerId=void 0,P._pointerActive=!1,P._keyboardActive=!1,P._preventScroll=!1,P._delayed=!1,P.swipe=[0,0],P.tap=!1,P.canceled=!1,P.cancel=this.cancel.bind(this)}setup(){const P=this.state;if(P._bounds instanceof HTMLElement){const Y=P._bounds.getBoundingClientRect(),ae=P.currentTarget.getBoundingClientRect(),ke={left:Y.left-ae.left+P.offset[0],right:Y.right-ae.right+P.offset[0],top:Y.top-ae.top+P.offset[1],bottom:Y.bottom-ae.bottom+P.offset[1]};P._bounds=k.bounds(ke)}}cancel(){const P=this.state;P.canceled||(P.canceled=!0,P._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(P){const Y=this.config,ae=this.state;if(P.buttons!=null&&(Array.isArray(Y.pointerButtons)?!Y.pointerButtons.includes(P.buttons):Y.pointerButtons!==-1&&Y.pointerButtons!==P.buttons))return;const ke=this.ctrl.setEventIds(P);Y.pointerCapture&&P.target.setPointerCapture(P.pointerId),!(ke&&ke.size>1&&ae._pointerActive)&&(this.start(P),this.setupPointer(P),ae._pointerId=_(P),ae._pointerActive=!0,this.computeValues(x(P)),this.computeInitial(),Y.preventScrollAxis&&A(P)!=="mouse"?(ae._active=!1,this.setupScrollPrevention(P)):Y.delay>0?(this.setupDelayTrigger(P),Y.triggerAllEvents&&(this.compute(P),this.emit())):this.startPointerDrag(P))}startPointerDrag(P){const Y=this.state;Y._active=!0,Y._preventScroll=!0,Y._delayed=!1,this.compute(P),this.emit()}pointerMove(P){const Y=this.state,ae=this.config;if(!Y._pointerActive)return;const ke=_(P);if(Y._pointerId!==void 0&&ke!==Y._pointerId)return;const at=x(P);if(document.pointerLockElement===P.target?Y._delta=[P.movementX,P.movementY]:(Y._delta=r.V.sub(at,Y._values),this.computeValues(at)),r.V.addTo(Y._movement,Y._delta),this.compute(P),Y._delayed&&Y.intentional){this.timeoutStore.remove("dragDelay"),Y.active=!1,this.startPointerDrag(P);return}if(ae.preventScrollAxis&&!Y._preventScroll)if(Y.axis)if(Y.axis===ae.preventScrollAxis||ae.preventScrollAxis==="xy"){Y._active=!1,this.clean();return}else{this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(P);return}else return;this.emit()}pointerUp(P){this.ctrl.setEventIds(P);try{this.config.pointerCapture&&P.target.hasPointerCapture(P.pointerId)&&P.target.releasePointerCapture(P.pointerId)}catch{}const Y=this.state,ae=this.config;if(!Y._active||!Y._pointerActive)return;const ke=_(P);if(Y._pointerId!==void 0&&ke!==Y._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(P);const[at,bt]=Y._distance;if(Y.tap=at<=ae.tapsThreshold&&bt<=ae.tapsThreshold,Y.tap&&ae.filterTaps)Y._force=!0;else{const[Yt,Pi]=Y._delta,[Bi,Ft]=Y._movement,[At,ni]=ae.swipe.velocity,[fn,H]=ae.swipe.distance,X=ae.swipe.duration;if(Y.elapsedTime<X){const ne=Math.abs(Yt/Y.timeDelta),pe=Math.abs(Pi/Y.timeDelta);ne>At&&Math.abs(Bi)>fn&&(Y.swipe[0]=Math.sign(Yt)),pe>ni&&Math.abs(Ft)>H&&(Y.swipe[1]=Math.sign(Pi))}}this.emit()}pointerClick(P){!this.state.tap&&P.detail>0&&(P.preventDefault(),P.stopPropagation())}setupPointer(P){const Y=this.config,ae=Y.device;Y.pointerLock&&P.currentTarget.requestPointerLock(),Y.pointerCapture||(this.eventStore.add(this.sharedConfig.window,ae,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,ae,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,ae,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(P){this.state._preventScroll&&P.cancelable&&P.preventDefault()}setupScrollPrevention(P){this.state._preventScroll=!1,U(P);const Y=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",Y),this.eventStore.add(this.sharedConfig.window,"touch","cancel",Y),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,P)}setupDelayTrigger(P){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(P)},this.config.delay)}keyDown(P){const Y=Q[P.key];if(Y){const ae=this.state,ke=P.shiftKey?10:P.altKey?.1:1;this.start(P),ae._delta=Y(this.config.keyboardDisplacement,ke),ae._keyboardActive=!0,r.V.addTo(ae._movement,ae._delta),this.compute(P),this.emit()}}keyUp(P){P.key in Q&&(this.state._keyboardActive=!1,this.setActive(),this.compute(P),this.emit())}bind(P){const Y=this.config.device;P(Y,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(P(Y,"change",this.pointerMove.bind(this)),P(Y,"end",this.pointerUp.bind(this)),P(Y,"cancel",this.pointerUp.bind(this)),P("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(P("key","down",this.keyDown.bind(this)),P("key","up",this.keyUp.bind(this))),this.config.filterTaps&&P("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}}function U(ie){"persist"in ie&&typeof ie.persist=="function"&&ie.persist()}const te=typeof window<"u"&&window.document&&window.document.createElement;function le(){return te&&"ontouchstart"in window}function ee(){return le()||te&&window.navigator.maxTouchPoints>1}function se(){return te&&"onpointerdown"in window}function Ee(){return te&&"exitPointerLock"in window.document}function Ie(){try{return"constructor"in GestureEvent}catch{return!1}}const oe={isBrowser:te,gesture:Ie(),touch:le(),touchscreen:ee(),pointer:se(),pointerLock:Ee()},ce=250,Ae=180,he=.5,Z=50,J=250,ue=10,Te={mouse:0,touch:0,pen:8},we=s(s({},k),{},{device(ie,P,{pointer:{touch:Y=!1,lock:ae=!1,mouse:ke=!1}={}}){return this.pointerLock=ae&&oe.pointerLock,oe.touch&&Y?"touch":this.pointerLock?"mouse":oe.pointer&&!ke?"pointer":oe.touch?"touch":"mouse"},preventScrollAxis(ie,P,{preventScroll:Y}){if(this.preventScrollDelay=typeof Y=="number"?Y:Y||Y===void 0&&ie?ce:void 0,!(!oe.touchscreen||Y===!1))return ie||(Y!==void 0?"y":void 0)},pointerCapture(ie,P,{pointer:{capture:Y=!0,buttons:ae=1,keys:ke=!0}={}}){return this.pointerButtons=ae,this.keys=ke,!this.pointerLock&&this.device==="pointer"&&Y},threshold(ie,P,{filterTaps:Y=!1,tapsThreshold:ae=3,axis:ke=void 0}){const at=r.V.toVector(ie,Y?ae:ke?1:0);return this.filterTaps=Y,this.tapsThreshold=ae,at},swipe({velocity:ie=he,distance:P=Z,duration:Y=J}={}){return{velocity:this.transform(r.V.toVector(ie)),distance:this.transform(r.V.toVector(P)),duration:Y}},delay(ie=0){switch(ie){case!0:return Ae;case!1:return 0;default:return ie}},axisThreshold(ie){return ie?s(s({},Te),ie):Te},keyboardDisplacement(ie=ue){return ie}});function Le(ie){const[P,Y]=ie.overflow,[ae,ke]=ie._delta,[at,bt]=ie._direction;(P<0&&ae>0&&at<0||P>0&&ae<0&&at>0)&&(ie._movement[0]=ie._movementBound[0]),(Y<0&&ke>0&&bt<0||Y>0&&ke<0&&bt>0)&&(ie._movement[1]=ie._movementBound[1])}const Be=30,qe=100;class Oe extends q{constructor(...P){super(...P),i(this,"ingKey","pinching"),i(this,"aliasKey","da")}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();const P=this.state;P._touchIds=[],P.canceled=!1,P.cancel=this.cancel.bind(this),P.turns=0}computeOffset(){const{type:P,movement:Y,lastOffset:ae}=this.state;P==="wheel"?this.state.offset=r.V.add(Y,ae):this.state.offset=[(1+Y[0])*ae[0],Y[1]+ae[1]]}computeMovement(){const{offset:P,lastOffset:Y}=this.state;this.state.movement=[P[0]/Y[0],P[1]-Y[1]]}axisIntent(){const P=this.state,[Y,ae]=P._movement;if(!P.axis){const ke=Math.abs(Y)*Be-Math.abs(ae);ke<0?P.axis="angle":ke>0&&(P.axis="scale")}}restrictToAxis(P){this.config.lockDirection&&(this.state.axis==="scale"?P[1]=0:this.state.axis==="angle"&&(P[0]=0))}cancel(){const P=this.state;P.canceled||setTimeout(()=>{P.canceled=!0,P._active=!1,this.compute(),this.emit()},0)}touchStart(P){this.ctrl.setEventIds(P);const Y=this.state,ae=this.ctrl.touchIds;if(Y._active&&Y._touchIds.every(at=>ae.has(at))||ae.size<2)return;this.start(P),Y._touchIds=Array.from(ae).slice(0,2);const ke=I(P,Y._touchIds);ke&&this.pinchStart(P,ke)}pointerStart(P){if(P.buttons!=null&&P.buttons%2!==1)return;this.ctrl.setEventIds(P),P.target.setPointerCapture(P.pointerId);const Y=this.state,ae=Y._pointerEvents,ke=this.ctrl.pointerIds;if(Y._active&&Array.from(ae.keys()).every(bt=>ke.has(bt))||(ae.size<2&&ae.set(P.pointerId,P),Y._pointerEvents.size<2))return;this.start(P);const at=E(...Array.from(ae.values()));at&&this.pinchStart(P,at)}pinchStart(P,Y){const ae=this.state;ae.origin=Y.origin,this.computeValues([Y.distance,Y.angle]),this.computeInitial(),this.compute(P),this.emit()}touchMove(P){if(!this.state._active)return;const Y=I(P,this.state._touchIds);Y&&this.pinchMove(P,Y)}pointerMove(P){const Y=this.state._pointerEvents;if(Y.has(P.pointerId)&&Y.set(P.pointerId,P),!this.state._active)return;const ae=E(...Array.from(Y.values()));ae&&this.pinchMove(P,ae)}pinchMove(P,Y){const ae=this.state,ke=ae._values[1],at=Y.angle-ke;let bt=0;Math.abs(at)>270&&(bt+=Math.sign(at)),this.computeValues([Y.distance,Y.angle-360*bt]),ae.origin=Y.origin,ae.turns=bt,ae._movement=[ae._values[0]/ae._initial[0]-1,ae._values[1]-ae._initial[1]],this.compute(P),this.emit()}touchEnd(P){this.ctrl.setEventIds(P),this.state._active&&this.state._touchIds.some(Y=>!this.ctrl.touchIds.has(Y))&&(this.state._active=!1,this.compute(P),this.emit())}pointerEnd(P){const Y=this.state;this.ctrl.setEventIds(P);try{P.target.releasePointerCapture(P.pointerId)}catch{}Y._pointerEvents.has(P.pointerId)&&Y._pointerEvents.delete(P.pointerId),Y._active&&Y._pointerEvents.size<2&&(Y._active=!1,this.compute(P),this.emit())}gestureStart(P){P.cancelable&&P.preventDefault();const Y=this.state;Y._active||(this.start(P),this.computeValues([P.scale,P.rotation]),Y.origin=[P.clientX,P.clientY],this.compute(P),this.emit())}gestureMove(P){if(P.cancelable&&P.preventDefault(),!this.state._active)return;const Y=this.state;this.computeValues([P.scale,P.rotation]),Y.origin=[P.clientX,P.clientY];const ae=Y._movement;Y._movement=[P.scale-1,P.rotation],Y._delta=r.V.sub(Y._movement,ae),this.compute(P),this.emit()}gestureEnd(P){this.state._active&&(this.state._active=!1,this.compute(P),this.emit())}wheel(P){const Y=this.config.modifierKey;Y&&(Array.isArray(Y)?!Y.find(ae=>P[ae]):!P[Y])||(this.state._active?this.wheelChange(P):this.wheelStart(P),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(P){this.start(P),this.wheelChange(P)}wheelChange(P){"uv"in P||P.cancelable&&P.preventDefault();const ae=this.state;ae._delta=[-T(P)[1]/qe*ae.offset[0],0],r.V.addTo(ae._movement,ae._delta),Le(ae),this.state.origin=[P.clientX,P.clientY],this.compute(P),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(P){const Y=this.config.device;Y&&(P(Y,"start",this[Y+"Start"].bind(this)),P(Y,"change",this[Y+"Move"].bind(this)),P(Y,"end",this[Y+"End"].bind(this)),P(Y,"cancel",this[Y+"End"].bind(this)),P("lostPointerCapture","",this[Y+"End"].bind(this))),this.config.pinchOnWheel&&P("wheel","",this.wheel.bind(this),{passive:!1})}}const Ke=s(s({},j),{},{device(ie,P,{shared:Y,pointer:{touch:ae=!1}={}}){if(Y.target&&!oe.touch&&oe.gesture)return"gesture";if(oe.touch&&ae)return"touch";if(oe.touchscreen){if(oe.pointer)return"pointer";if(oe.touch)return"touch"}},bounds(ie,P,{scaleBounds:Y={},angleBounds:ae={}}){const ke=bt=>{const Yt=z(R(Y,bt),{min:-1/0,max:1/0});return[Yt.min,Yt.max]},at=bt=>{const Yt=z(R(ae,bt),{min:-1/0,max:1/0});return[Yt.min,Yt.max]};return typeof Y!="function"&&typeof ae!="function"?[ke(),at()]:bt=>[ke(bt),at(bt)]},threshold(ie,P,Y){return this.lockDirection=Y.axis==="lock",r.V.toVector(ie,this.lockDirection?[.1,3]:0)},modifierKey(ie){return ie===void 0?"ctrlKey":ie},pinchOnWheel(ie=!0){return ie}});class $e extends N{constructor(...P){super(...P),i(this,"ingKey","moving")}move(P){this.config.mouseOnly&&P.pointerType!=="mouse"||(this.state._active?this.moveChange(P):this.moveStart(P),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(P){this.start(P),this.computeValues(x(P)),this.compute(P),this.computeInitial(),this.emit()}moveChange(P){if(!this.state._active)return;const Y=x(P),ae=this.state;ae._delta=r.V.sub(Y,ae._values),r.V.addTo(ae._movement,ae._delta),this.computeValues(Y),this.compute(P),this.emit()}moveEnd(P){this.state._active&&(this.state._active=!1,this.compute(P),this.emit())}bind(P){P("pointer","change",this.move.bind(this)),P("pointer","leave",this.moveEnd.bind(this))}}const Ze=s(s({},k),{},{mouseOnly:(ie=!0)=>ie});class ut extends N{constructor(...P){super(...P),i(this,"ingKey","scrolling")}scroll(P){this.state._active||this.start(P),this.scrollChange(P),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(P){P.cancelable&&P.preventDefault();const Y=this.state,ae=B(P);Y._delta=r.V.sub(ae,Y._values),r.V.addTo(Y._movement,Y._delta),this.computeValues(ae),this.compute(P),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(P){P("scroll","",this.scroll.bind(this))}}const Ct=k;class lt extends N{constructor(...P){super(...P),i(this,"ingKey","wheeling")}wheel(P){this.state._active||this.start(P),this.wheelChange(P),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(P){const Y=this.state;Y._delta=T(P),r.V.addTo(Y._movement,Y._delta),Le(Y),this.compute(P),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(P){P("wheel","",this.wheel.bind(this))}}const tt=k;class Je extends N{constructor(...P){super(...P),i(this,"ingKey","hovering")}enter(P){this.config.mouseOnly&&P.pointerType!=="mouse"||(this.start(P),this.computeValues(x(P)),this.compute(P),this.emit())}leave(P){if(this.config.mouseOnly&&P.pointerType!=="mouse")return;const Y=this.state;if(!Y._active)return;Y._active=!1;const ae=x(P);Y._movement=Y._delta=r.V.sub(ae,Y._values),this.computeValues(ae),this.compute(P),Y.delta=Y.movement,this.emit()}bind(P){P("pointer","enter",this.enter.bind(this)),P("pointer","leave",this.leave.bind(this))}}const re=s(s({},k),{},{mouseOnly:(ie=!0)=>ie}),Re=new Map,Ue=new Map;function Xe(ie){Re.set(ie.key,ie.engine),Ue.set(ie.key,ie.resolver)}const ve={key:"drag",engine:O,resolver:we},ft={key:"hover",engine:Je,resolver:re},ii={key:"move",engine:$e,resolver:Ze},kt={key:"pinch",engine:Oe,resolver:Ke},It={key:"scroll",engine:ut,resolver:Ct},Pt={key:"wheel",engine:lt,resolver:tt};return Di.ConfigResolverMap=Ue,Di.EngineMap=Re,Di.SUPPORT=oe,Di._defineProperty=i,Di._objectSpread2=s,Di.chain=G,Di.dragAction=ve,Di.hoverAction=ft,Di.isTouch=m,Di.moveAction=ii,Di.parseProp=f,Di.pinchAction=kt,Di.registerAction=Xe,Di.scrollAction=It,Di.toDomEventType=d,Di.toHandlerProp=u,Di.touchIds=C,Di.wheelAction=Pt,Di}var xp;function W_(){if(xp)return Fn;xp=1,Object.defineProperty(Fn,"__esModule",{value:!0});var r=sE();return Fn.ConfigResolverMap=r.ConfigResolverMap,Fn.EngineMap=r.EngineMap,Fn.dragAction=r.dragAction,Fn.hoverAction=r.hoverAction,Fn.moveAction=r.moveAction,Fn.pinchAction=r.pinchAction,Fn.registerAction=r.registerAction,Fn.scrollAction=r.scrollAction,Fn.wheelAction=r.wheelAction,Fn}var Sp;function q_(){return Sp||(Sp=1,Ef.exports=W_()),Ef.exports}var Xr=q_(),Cf={exports:{}},Pa={},Tp;function X_(){if(Tp)return Pa;Tp=1,Object.defineProperty(Pa,"__esModule",{value:!0});var r=sE();function e(g,v){if(g==null)return{};var E={},C=Object.keys(g),I,_;for(_=0;_<C.length;_++)I=C[_],!(v.indexOf(I)>=0)&&(E[I]=g[I]);return E}function t(g,v){if(g==null)return{};var E=e(g,v),C,I;if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(g);for(I=0;I<_.length;I++)C=_[I],!(v.indexOf(C)>=0)&&Object.prototype.propertyIsEnumerable.call(g,C)&&(E[C]=g[C])}return E}const i={target(g){if(g)return()=>"current"in g?g.current:g},enabled(g=!0){return g},window(g=r.SUPPORT.isBrowser?window:void 0){return g},eventOptions({passive:g=!0,capture:v=!1}={}){return{passive:g,capture:v}},transform(g){return g}},n=["target","eventOptions","window","enabled","transform"];function s(g={},v){const E={};for(const[C,I]of Object.entries(v))switch(typeof I){case"function":E[C]=I.call(E,g[C],C,g);break;case"object":E[C]=s(g[C],I);break;case"boolean":I&&(E[C]=g[C]);break}return E}function o(g,v,E={}){const C=g,{target:I,eventOptions:_,window:x,enabled:S,transform:b}=C,T=t(C,n);if(E.shared=s({target:I,eventOptions:_,window:x,enabled:S,transform:b},i),v){const B=r.ConfigResolverMap.get(v);E[v]=s(r._objectSpread2({shared:E.shared},T),B)}else for(const B in T){const w=r.ConfigResolverMap.get(B);w&&(E[B]=s(r._objectSpread2({shared:E.shared},T[B]),w))}return E}class a{constructor(v,E){r._defineProperty(this,"_listeners",new Set),this._ctrl=v,this._gestureKey=E}add(v,E,C,I,_){const x=this._listeners,S=r.toDomEventType(E,C),b=this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},T=r._objectSpread2(r._objectSpread2({},b),_);v.addEventListener(S,I,T);const B=()=>{v.removeEventListener(S,I,T),x.delete(B)};return x.add(B),B}clean(){this._listeners.forEach(v=>v()),this._listeners.clear()}}class l{constructor(){r._defineProperty(this,"_timeouts",new Map)}add(v,E,C=140,...I){this.remove(v),this._timeouts.set(v,window.setTimeout(E,C,...I))}remove(v){const E=this._timeouts.get(v);E&&window.clearTimeout(E)}clean(){this._timeouts.forEach(v=>void window.clearTimeout(v)),this._timeouts.clear()}}class c{constructor(v){r._defineProperty(this,"gestures",new Set),r._defineProperty(this,"_targetEventStore",new a(this)),r._defineProperty(this,"gestureEventStores",{}),r._defineProperty(this,"gestureTimeoutStores",{}),r._defineProperty(this,"handlers",{}),r._defineProperty(this,"config",{}),r._defineProperty(this,"pointerIds",new Set),r._defineProperty(this,"touchIds",new Set),r._defineProperty(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),h(this,v)}setEventIds(v){if(r.isTouch(v))return this.touchIds=new Set(r.touchIds(v)),this.touchIds;if("pointerId"in v)return v.type==="pointerup"||v.type==="pointercancel"?this.pointerIds.delete(v.pointerId):v.type==="pointerdown"&&this.pointerIds.add(v.pointerId),this.pointerIds}applyHandlers(v,E){this.handlers=v,this.nativeHandlers=E}applyConfig(v,E){this.config=o(v,E,this.config)}clean(){this._targetEventStore.clean();for(const v of this.gestures)this.gestureEventStores[v].clean(),this.gestureTimeoutStores[v].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...v){const E=this.config.shared,C={};let I;if(!(E.target&&(I=E.target(),!I))){if(E.enabled){for(const x of this.gestures){const S=this.config[x],b=f(C,S.eventOptions,!!I);if(S.enabled){const T=r.EngineMap.get(x);new T(this,v,x).bind(b)}}const _=f(C,E.eventOptions,!!I);for(const x in this.nativeHandlers)_(x,"",S=>this.nativeHandlers[x](r._objectSpread2(r._objectSpread2({},this.state.shared),{},{event:S,args:v})),void 0,!0)}for(const _ in C)C[_]=r.chain(...C[_]);if(!I)return C;for(const _ in C){const{device:x,capture:S,passive:b}=r.parseProp(_);this._targetEventStore.add(I,x,"",C[_],{capture:S,passive:b})}}}}function u(g,v){g.gestures.add(v),g.gestureEventStores[v]=new a(g,v),g.gestureTimeoutStores[v]=new l}function h(g,v){v.drag&&u(g,"drag"),v.wheel&&u(g,"wheel"),v.scroll&&u(g,"scroll"),v.move&&u(g,"move"),v.pinch&&u(g,"pinch"),v.hover&&u(g,"hover")}const f=(g,v,E)=>(C,I,_,x={},S=!1)=>{var b,T;const B=(b=x.capture)!==null&&b!==void 0?b:v.capture,w=(T=x.passive)!==null&&T!==void 0?T:v.passive;let R=S?C:r.toHandlerProp(C,I,B);E&&w&&(R+="Passive"),g[R]=g[R]||[],g[R].push(_)},d=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function m(g){const v={},E={},C=new Set;for(let I in g)d.test(I)?(C.add(RegExp.lastMatch),E[I]=g[I]):v[I]=g[I];return[E,v,C]}function A(g,v,E,C,I,_){if(!g.has(E)||!r.EngineMap.has(C))return;const x=E+"Start",S=E+"End",b=T=>{let B;return T.first&&x in v&&v[x](T),E in v&&(B=v[E](T)),T.last&&S in v&&v[S](T),B};I[C]=b,_[C]=_[C]||{}}function p(g,v){const[E,C,I]=m(g),_={};return A(I,E,"onDrag","drag",_,v),A(I,E,"onWheel","wheel",_,v),A(I,E,"onScroll","scroll",_,v),A(I,E,"onPinch","pinch",_,v),A(I,E,"onMove","move",_,v),A(I,E,"onHover","hover",_,v),{handlers:_,config:v,nativeHandlers:C}}return Pa.Controller=c,Pa.parseMergedHandlers=p,Pa}var bp;function J_(){return bp||(bp=1,Cf.exports=X_()),Cf.exports}var rE=J_();function Z_(r,e={},t,i){const n=Us.useMemo(()=>new rE.Controller(r),[]);if(n.applyHandlers(r,i),n.applyConfig(e,t),Us.useEffect(n.effect.bind(n)),Us.useEffect(()=>n.clean.bind(n),[]),e.target===void 0)return n.bind.bind(n)}function ex(r){return r.forEach(Xr.registerAction),function(t,i){const{handlers:n,nativeHandlers:s,config:o}=rE.parseMergedHandlers(t,i||{});return Z_(n,o,void 0,s)}}function oE(r,e){return ex([Xr.dragAction,Xr.pinchAction,Xr.scrollAction,Xr.wheelAction,Xr.moveAction,Xr.hoverAction])(r,e||{})}const If=new K,wp=new Fe,zr=new K,wc=new K,Fa=new K,Bp=new Hs,aF=y.forwardRef(({autoTransform:r=!0,matrix:e,axisLock:t,dragLimits:i,onHover:n,onDragStart:s,onDrag:o,onDragEnd:a,children:l,dragConfig:c,...u},h)=>{const f=de(E=>E.controls),{camera:d,size:m,raycaster:A,invalidate:p}=de(),g=y.useRef(null),v=oE({onHover:({hovering:E})=>n&&n(E??!1),onDragStart:({event:E})=>{f&&(f.enabled=!1);const{point:C}=E;g.current.matrix.decompose(If,new ht,new K),zr.copy(C),wc.copy(zr).sub(If),s&&s(If),p()},onDrag:({xy:[E,C],intentional:I})=>{if(!I)return;const _=(E-m.left)/m.width*2-1,x=-((C-m.top)/m.height)*2+1;if(wp.set(_,x),A.setFromCamera(wp,d),!t)d.getWorldDirection(Fa).negate();else switch(t){case"x":Fa.set(1,0,0);break;case"y":Fa.set(0,1,0);break;case"z":Fa.set(0,0,1);break}Bp.setFromNormalAndCoplanarPoint(Fa,zr),A.ray.intersectPlane(Bp,zr);const S=g.current.matrix.clone(),b=g.current.matrixWorld.clone(),T=new K(zr.x-wc.x,zr.y-wc.y,zr.z-wc.z);if(i&&(T.x=i[0]?Math.max(Math.min(T.x,i[0][1]),i[0][0]):T.x,T.y=i[1]?Math.max(Math.min(T.y,i[1][1]),i[1][0]):T.y,T.z=i[2]?Math.max(Math.min(T.z,i[2][1]),i[2][0]):T.z),r){g.current.matrix.setPosition(T);const B=g.current.matrix.clone().multiply(S.invert()),w=g.current.matrix.clone().multiply(b.invert());o&&o(g.current.matrix,B,g.current.matrixWorld,w)}else{const B=new Me().copy(g.current.matrix);B.setPosition(T);const w=B.clone().multiply(S.invert()),R=B.clone().multiply(b.invert());o&&o(B,w,g.current.matrixWorld,R)}p()},onDragEnd:()=>{f&&(f.enabled=!0),a&&a(),p()}},{drag:{filterTaps:!0,threshold:1,...typeof c=="object"?c:{}}});return y.useImperativeHandle(h,()=>g.current,[]),y.useLayoutEffect(()=>{e&&(g.current.matrix=e)},[e]),y.createElement("group",_e({ref:g},v(),{matrix:e,matrixAutoUpdate:!1},u),l)});function Dl(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function P0(r,e){return P0=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},P0(r,e)}function tx(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ix(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];var i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8];return i*a*h+n*l*c+s*o*u-s*a*c-n*o*h-i*l*u}function Rp(r,e){for(var t=[],i=r.toArray(),n=e.toArray(),s=0;s<i.length;s++)t[s]=i[s]+n[s];return new bn().fromArray(t)}function nx(r){if(Array.isArray(r))return r}function sx(r,e){var t=r==null?null:typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(t!=null){var i=[],n=!0,s=!1,o,a;try{for(t=t.call(r);!(n=(o=t.next()).done)&&(i.push(o.value),!(e&&i.length===e));n=!0);}catch(l){s=!0,a=l}finally{try{!n&&t.return!=null&&t.return()}finally{if(s)throw a}}return i}}function F0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function aE(r,e){if(r){if(typeof r=="string")return F0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return F0(r,e)}}function rx(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Gs(r,e){return nx(r)||sx(r,e)||aE(r,e)||rx()}function ox(r){if(Array.isArray(r))return F0(r)}function ax(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function lx(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function sh(r){return ox(r)||ax(r)||aE(r)||lx()}function Gu(r,e,t){return tx()?Gu=Reflect.construct:Gu=function(n,s,o){var a=[null];a.push.apply(a,s);var l=Function.bind.apply(n,a),c=new l;return o&&P0(c,o.prototype),c},Gu.apply(null,arguments)}function cx(r){var e=Gs(r[0],2),t=e[0],i=e[1],n=Gs(r[1],2),s=n[0],o=n[1],a=Gs(r[2],2),l=a[0],c=a[1];return ix(t,i,1,s,o,1,l,c,1)}function ux(r){return cx(r)===0}var hx=new Fe,fx=new Fe;function Dp(r){var e=r.map(function(c){return Array.isArray(c)?Gu(Fe,sh(c)):c}),t=Gs(e,3),i=t[0],n=t[1],s=t[2];if(ux(r))return!1;var o=hx.subVectors(n,i),a=fx.subVectors(s,i),l=a.cross(o);return l>0}function lE(r,e,t){return Math.max(e,Math.min(t,r))}function cE(r,e){return lE(r-Math.floor(r/e)*e,0,e)}function uE(r,e){var t=cE(e-r,Math.PI*2);return t>Math.PI&&(t-=Math.PI*2),t}function dx(r){return r/180*Math.PI}function mx(r){return r*180/Math.PI}function Ax(r,e){for(var t=e.radius,i=t===void 0?1:t,n=r.length/3,s=2/n,o=Math.PI*(3-2.2360679775),a=0;a<r.length;a+=3){var l=a*s-1+s/2,c=Math.sqrt(1-Math.pow(l,2)),u=a%n*o,h=Math.cos(u)*c,f=Math.sin(u)*c;r[a]=h*i,r[a+1]=l*i,r[a+2]=f*i}}function px(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Number.EPSILON;return Math.abs(r.x-e.x)<t&&Math.abs(r.y-e.y)<t&&Math.abs(r.z-e.z)<t}function hE(r,e){return r.x===e.x?typeof r.z<"u"&&r.y===e.y?r.z-e.z:r.y-e.y:r.x-e.x}function gx(r){for(var e=r.sort(hE),t=[e[0],e[1]],i=2;i<e.length;i++)for(t.push(e[i]);t.length>2&&Dp(sh(t.slice(-3)));)t.splice(t.length-2,1);for(var n=[e[e.length-1],e[e.length-2]],s=e.length-3;s>=0;s--)for(n.push(e[s]);n.length>2&&Dp(sh(n.slice(-3)));)n.splice(n.length-2,1);n.splice(0,1),n.splice(n.length-1,1);var o=[].concat(t,n);return o}function yx(r,e,t){var i=Gs(e,2),n=i[0],s=i[1],o=Gs(t,2),a=o[0],l=o[1];return a+(r-n)*(l-a)/(s-n)}function vx(r){return r*r*r*(r*(r*6-15)+10)}function Ex(r,e,t){return r*(1-t)+e*t}function fE(r,e,t){return(t-r)/(e-r)}function Cx(r,e,t){var i=Math.sqrt(r*r+e*e+t*t);return[r/i,e/i,t/i]}function Ix(r,e,t){var i=r*r,n=e*e,s=t*t,o=r*Math.sqrt(1-(n+s)/2+n*s/3),a=e*Math.sqrt(1-(s+i)/2+s*i/3),l=t*Math.sqrt(1-(i+n)/2+i*n/3);return[o,a,l]}function dE(r,e){var t=new K().crossVectors(r,e),i=r.dot(e),n=new bn().identity(),s=new bn().set(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0),o=new bn().multiplyMatrices(s,s).multiplyScalar(1/(1+i)),a=Rp(Rp(n,s),o);return a}function _x(r,e,t){var i=Math.asin(e),n=Math.atan2(r,-t);return[i,n]}function xx(r,e){var t=Math.sin(r),i=Math.cos(r),n=Math.sin(e)*i,s=-Math.cos(e)*i;return[n,t,s]}function Sx(r,e){var t=Gs(e,2),i=t[0],n=t[1],s=dE(r.normal,new K(0,1,0)),o=fE(i.clone().applyMatrix3(s).y,n.clone().applyMatrix3(s).y,0);return new K().lerpVectors(i,n,o)}function Tx(r,e){var t=e.normal.dot(r);return t}function bx(r,e){var t=Gs(r,3),i=t[0],n=t[1],s=t[2],o=Gs(e,2),a=o[0],l=o[1];return s*a*l+n*a+i}function wx(r,e){var t=Gs(e,2),i=t[0],n=t[1],s=i*n,o=r/s,a=r-s*o,l=a/i,c=a%i;return[c,l,o]}function Bx(r,e){return r[0]+e[0]*r[1]}function Rx(r,e){var t=r%e,i=Math.floor(r/e);return[t,i]}var Bc=Object.freeze({__proto__:null,clamp:lE,repeat:cE,deltaAngle:uE,degToRad:dx,radToDeg:mx,fibonacciOnSphere:Ax,vectorEquals:px,lexicographic:hE,convexHull:gx,remap:yx,fade:vx,lerp:Ex,inverseLerp:fE,normalize:Cx,pointOnCubeToPointOnSphere:Ix,rotateVectorOnVector:dE,pointToCoordinate:_x,coordinateToPoint:xx,planeSegmentIntersection:Sx,pointToPlaneDistance:Tx,getIndexFrom3D:bx,get3DFromIndex:wx,getIndexFrom2D:Bx,get2DFromIndex:Rx});function mE(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var kn=function r(e,t,i){var n=this;mE(this,r),Dl(this,"dot2",function(s,o){return n.x*s+n.y*o}),Dl(this,"dot3",function(s,o,a){return n.x*s+n.y*o+n.z*a}),this.x=e,this.y=t,this.z=i},Dx=[new kn(1,1,0),new kn(-1,1,0),new kn(1,-1,0),new kn(-1,-1,0),new kn(1,0,1),new kn(-1,0,1),new kn(1,0,-1),new kn(-1,0,-1),new kn(0,1,1),new kn(0,-1,1),new kn(0,1,-1),new kn(0,-1,-1)],Mp=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Lp=new Array(512),Pp=new Array(512),Mx=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(var t=0;t<256;t++){var i;t&1?i=Mp[t]^e&255:i=Mp[t]^e>>8&255,Lp[t]=Lp[t+256]=i,Pp[t]=Pp[t+256]=Dx[i%12]}};Mx(0);function Lx(r){if(typeof r=="number")r=Math.abs(r);else if(typeof r=="string"){var e=r;r=0;for(var t=0;t<e.length;t++)r=(r+(t+1)*(e.charCodeAt(t)%96))%2147483647}return r===0&&(r=311),r}function Fp(r){var e=Lx(r);return function(){var t=e*48271%2147483647;return e=t,t/2147483647}}var Px=function r(e){var t=this;mE(this,r),Dl(this,"seed",0),Dl(this,"init",function(i){t.seed=i,t.value=Fp(i)}),Dl(this,"value",Fp(this.seed)),this.init(e)};new Px(Math.random());var Fx=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.01,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1/(2*Math.PI);return i/Math.atan(1/t)*Math.atan(Math.sin(2*Math.PI*e*n)/t)},AE=function(e){return 1/(1+e+.48*e*e+.235*e*e*e)},kx=function(e){return e},Ox={in:function(e){return 1-Math.cos(e*Math.PI/2)},out:function(e){return Math.sin(e*Math.PI/2)},inOut:function(e){return-(Math.cos(Math.PI*e)-1)/2}},Ux={in:function(e){return e*e*e},out:function(e){return 1-Math.pow(1-e,3)},inOut:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},Nx={in:function(e){return e*e*e*e*e},out:function(e){return 1-Math.pow(1-e,5)},inOut:function(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}},Gx={in:function(e){return 1-Math.sqrt(1-Math.pow(e,2))},out:function(e){return Math.sqrt(1-Math.pow(e-1,2))},inOut:function(e){return e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2}},Qx={in:function(e){return e*e*e*e},out:function(e){return 1- --e*e*e*e},inOut:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}},zx={in:function(e){return e===0?0:Math.pow(2,10*e-10)},out:function(e){return e===1?1:1-Math.pow(2,-10*e)},inOut:function(e){return e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2}};function Qi(r,e,t){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:.25,n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:.01,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1/0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:AE,a=arguments.length>7&&arguments[7]!==void 0?arguments[7]:.001,l="velocity_"+e;if(r.__damp===void 0&&(r.__damp={}),r.__damp[l]===void 0&&(r.__damp[l]=0),Math.abs(r[e]-t)<=a)return r[e]=t,!1;i=Math.max(1e-4,i);var c=2/i,u=o(c*n),h=r[e]-t,f=t,d=s*i;h=Math.min(Math.max(h,-d),d),t=r[e]-h;var m=(r.__damp[l]+c*h)*n;r.__damp[l]=(r.__damp[l]-c*m)*u;var A=t+(h+m)*u;return f-r[e]>0==A>f&&(A=f,r.__damp[l]=(A-f)/n),r[e]=A,!0}var Hx=function(e){return e&&e.isCamera},Vx=function(e){return e&&e.isLight},ka=new K,kp=new ht,Op=new ht,Oa=new Me,_f=new K;function Kx(r,e,t,i,n,s,o){typeof e=="number"?ka.setScalar(e):Array.isArray(e)?ka.set(e[0],e[1],e[2]):ka.copy(e);var a=r.parent;r.updateWorldMatrix(!0,!1),_f.setFromMatrixPosition(r.matrixWorld),Hx(r)||Vx(r)?Oa.lookAt(_f,ka,r.up):Oa.lookAt(ka,_f,r.up),rh(r.quaternion,Op.setFromRotationMatrix(Oa),t,i,n,s,o),a&&(Oa.extractRotation(a.matrixWorld),kp.setFromRotationMatrix(Oa),rh(r.quaternion,Op.copy(r.quaternion).premultiply(kp.invert()),t,i,n,s,o))}function sa(r,e,t,i,n,s,o,a){return Qi(r,e,r[e]+uE(r[e],t),i,n,s,o,a)}var Ua=new Fe,Up,Np;function $x(r,e,t,i,n,s,o){return typeof e=="number"?Ua.setScalar(e):Array.isArray(e)?Ua.set(e[0],e[1]):Ua.copy(e),Up=Qi(r,"x",Ua.x,t,i,n,s,o),Np=Qi(r,"y",Ua.y,t,i,n,s,o),Up||Np}var Ao=new K,Gp,Qp,zp;function k0(r,e,t,i,n,s,o){return typeof e=="number"?Ao.setScalar(e):Array.isArray(e)?Ao.set(e[0],e[1],e[2]):Ao.copy(e),Gp=Qi(r,"x",Ao.x,t,i,n,s,o),Qp=Qi(r,"y",Ao.y,t,i,n,s,o),zp=Qi(r,"z",Ao.z,t,i,n,s,o),Gp||Qp||zp}var Hr=new Ci,Hp,Vp,Kp,$p;function jx(r,e,t,i,n,s,o){return typeof e=="number"?Hr.setScalar(e):Array.isArray(e)?Hr.set(e[0],e[1],e[2],e[3]):Hr.copy(e),Hp=Qi(r,"x",Hr.x,t,i,n,s,o),Vp=Qi(r,"y",Hr.y,t,i,n,s,o),Kp=Qi(r,"z",Hr.z,t,i,n,s,o),$p=Qi(r,"w",Hr.w,t,i,n,s,o),Hp||Vp||Kp||$p}var Na=new Wn,jp,Yp,Wp;function Yx(r,e,t,i,n,s,o){return Array.isArray(e)?Na.set(e[0],e[1],e[2],e[3]):Na.copy(e),jp=sa(r,"x",Na.x,t,i,n,s,o),Yp=sa(r,"y",Na.y,t,i,n,s,o),Wp=sa(r,"z",Na.z,t,i,n,s,o),jp||Yp||Wp}var po=new et,qp,Xp,Jp;function Wx(r,e,t,i,n,s,o){return e instanceof et?po.copy(e):Array.isArray(e)?po.setRGB(e[0],e[1],e[2]):po.set(e),qp=Qi(r,"r",po.r,t,i,n,s,o),Xp=Qi(r,"g",po.g,t,i,n,s,o),Jp=Qi(r,"b",po.b,t,i,n,s,o),qp||Xp||Jp}var ss=new ht,Ks=new Ci,Zp=new Ci,Ga=new Ci,eg,tg,ig,ng;function rh(r,e,t,i,n,s,o){var a=r;Array.isArray(e)?ss.set(e[0],e[1],e[2],e[3]):ss.copy(e);var l=r.dot(ss)>0?1:-1;return ss.x*=l,ss.y*=l,ss.z*=l,ss.w*=l,eg=Qi(r,"x",ss.x,t,i,n,s,o),tg=Qi(r,"y",ss.y,t,i,n,s,o),ig=Qi(r,"z",ss.z,t,i,n,s,o),ng=Qi(r,"w",ss.w,t,i,n,s,o),Ks.set(r.x,r.y,r.z,r.w).normalize(),Zp.set(a.__damp.velocity_x,a.__damp.velocity_y,a.__damp.velocity_z,a.__damp.velocity_w),Ga.copy(Ks).multiplyScalar(Zp.dot(Ks)/Ks.dot(Ks)),a.__damp.velocity_x-=Ga.x,a.__damp.velocity_y-=Ga.y,a.__damp.velocity_z-=Ga.z,a.__damp.velocity_w-=Ga.w,r.set(Ks.x,Ks.y,Ks.z,Ks.w),eg||tg||ig||ng}var Qa=new fa,sg,rg,og;function qx(r,e,t,i,n,s,o){return Array.isArray(e)?Qa.set(e[0],e[1],e[2]):Qa.copy(e),sg=Qi(r,"radius",Qa.radius,t,i,n,s,o),rg=sa(r,"phi",Qa.phi,t,i,n,s,o),og=sa(r,"theta",Qa.theta,t,i,n,s,o),sg||rg||og}var Rc=new Me,ag=new K,lg=new ht,cg=new K,ug,hg,fg;function Xx(r,e,t,i,n,s,o){var a=r;return a.__damp===void 0&&(a.__damp={position:new K,rotation:new ht,scale:new K},r.decompose(a.__damp.position,a.__damp.rotation,a.__damp.scale)),Array.isArray(e)?Rc.set.apply(Rc,sh(e)):Rc.copy(e),Rc.decompose(ag,lg,cg),ug=k0(a.__damp.position,ag,t,i,n,s,o),hg=rh(a.__damp.rotation,lg,t,i,n,s,o),fg=k0(a.__damp.scale,cg,t,i,n,s,o),r.compose(a.__damp.position,a.__damp.rotation,a.__damp.scale),ug||hg||fg}var da=Object.freeze({__proto__:null,rsqw:Fx,exp:AE,linear:kx,sine:Ox,cubic:Ux,quint:Nx,circ:Gx,quart:Qx,expo:zx,damp:Qi,dampLookAt:Kx,dampAngle:sa,damp2:$x,damp3:k0,damp4:jx,dampE:Yx,dampC:Wx,dampQ:rh,dampS:qx,dampM:Xx});const Km=y.createContext(null);function pE(){return y.useContext(Km)}function lF({eps:r=1e-5,enabled:e=!0,infinite:t,horizontal:i,pages:n=1,distance:s=1,damping:o=.25,maxSpeed:a=1/0,prepend:l=!1,style:c={},children:u}){const{get:h,setEvents:f,gl:d,size:m,invalidate:A,events:p}=de(),[g]=y.useState(()=>document.createElement("div")),[v]=y.useState(()=>document.createElement("div")),[E]=y.useState(()=>document.createElement("div")),C=d.domElement.parentNode,I=y.useRef(0),_=y.useMemo(()=>({el:g,eps:r,fill:v,fixed:E,horizontal:i,damping:o,offset:0,delta:0,scroll:I,pages:n,range(b,T,B=0){const w=b-B,R=w+T+B*2;return this.offset<w?0:this.offset>R?1:(this.offset-w)/(R-w)},curve(b,T,B=0){return Math.sin(this.range(b,T,B)*Math.PI)},visible(b,T,B=0){const w=b-B,R=w+T+B*2;return this.offset>=w&&this.offset<=R}}),[r,o,i,n]);y.useEffect(()=>{g.style.position="absolute",g.style.width="100%",g.style.height="100%",g.style[i?"overflowX":"overflowY"]="auto",g.style[i?"overflowY":"overflowX"]="hidden",g.style.top="0px",g.style.left="0px";for(const T in c)g.style[T]=c[T];E.style.position="sticky",E.style.top="0px",E.style.left="0px",E.style.width="100%",E.style.height="100%",E.style.overflow="hidden",g.appendChild(E),v.style.height=i?"100%":`${n*s*100}%`,v.style.width=i?`${n*s*100}%`:"100%",v.style.pointerEvents="none",g.appendChild(v),l?C.prepend(g):C.appendChild(g),g[i?"scrollLeft":"scrollTop"]=1;const S=p.connected||d.domElement;requestAnimationFrame(()=>p.connect==null?void 0:p.connect(g));const b=h().events.compute;return f({compute(T,B){const{left:w,top:R}=C.getBoundingClientRect(),D=T.clientX-w,G=T.clientY-R;B.pointer.set(D/B.size.width*2-1,-(G/B.size.height)*2+1),B.raycaster.setFromCamera(B.pointer,B.camera)}}),()=>{C.removeChild(g),f({compute:b}),p.connect==null||p.connect(S)}},[n,s,i,g,v,E,C]),y.useEffect(()=>{if(p.connected===g){const S=m[i?"width":"height"],b=g[i?"scrollWidth":"scrollHeight"],T=b-S;let B=0,w=!0,R=!0;const D=()=>{if(!(!e||R)&&(A(),B=g[i?"scrollLeft":"scrollTop"],I.current=B/T,t)){if(!w){if(B>=T){const z=1-_.offset;g[i?"scrollLeft":"scrollTop"]=1,I.current=_.offset=-z,w=!0}else if(B<=0){const z=1+_.offset;g[i?"scrollLeft":"scrollTop"]=b,I.current=_.offset=z,w=!0}}w&&setTimeout(()=>w=!1,40)}};g.addEventListener("scroll",D,{passive:!0}),requestAnimationFrame(()=>R=!1);const G=z=>g.scrollLeft+=z.deltaY/2;return i&&g.addEventListener("wheel",G,{passive:!0}),()=>{g.removeEventListener("scroll",D),i&&g.removeEventListener("wheel",G)}}},[g,p,m,t,_,A,i,e]);let x=0;return We((S,b)=>{x=_.offset,da.damp(_,"offset",I.current,o,b,a,void 0,r),da.damp(_,"delta",Math.abs(x-_.offset),o,b,a,void 0,r),_.delta>r&&A()}),y.createElement(Km.Provider,{value:_},u)}const Jx=y.forwardRef(({children:r},e)=>{const t=y.useRef(null);y.useImperativeHandle(e,()=>t.current,[]);const i=pE(),{width:n,height:s}=de(o=>o.viewport);return We(()=>{t.current.position.x=i.horizontal?-n*(i.pages-1)*i.offset:0,t.current.position.y=i.horizontal?0:s*(i.pages-1)*i.offset}),y.createElement("group",{ref:t},r)}),Zx=y.forwardRef(({children:r,style:e,...t},i)=>{const n=pE(),s=y.useRef(null);y.useImperativeHandle(i,()=>s.current,[]);const{width:o,height:a}=de(u=>u.size),l=y.useContext(x0),c=y.useMemo(()=>w2.createRoot(n.fixed),[n.fixed]);return We(()=>{n.delta>n.eps&&(s.current.style.transform=`translate3d(${n.horizontal?-o*(n.pages-1)*n.offset:0}px,${n.horizontal?0:a*(n.pages-1)*-n.offset}px,0)`)}),c.render(y.createElement("div",_e({ref:s,style:{...e,position:"absolute",top:0,left:0,willChange:"transform"}},t),y.createElement(Km.Provider,{value:n},y.createElement(x0.Provider,{value:l},r)))),null}),cF=y.forwardRef(({html:r,...e},t)=>{const i=r?Zx:Jx;return y.createElement(i,_e({ref:t},e))});var $m=mc(),Et=r=>dc(r,$m),jm=mc();Et.write=r=>dc(r,jm);var Ph=mc();Et.onStart=r=>dc(r,Ph);var Ym=mc();Et.onFrame=r=>dc(r,Ym);var Wm=mc();Et.onFinish=r=>dc(r,Wm);var ra=[];Et.setTimeout=(r,e)=>{const t=Et.now()+e,i=()=>{const s=ra.findIndex(o=>o.cancel==i);~s&&ra.splice(s,1),Br-=~s?1:0},n={time:t,handler:r,cancel:i};return ra.splice(gE(t),0,n),Br+=1,yE(),n};var gE=r=>~(~ra.findIndex(e=>e.time>r)||~ra.length);Et.cancel=r=>{Ph.delete(r),Ym.delete(r),Wm.delete(r),$m.delete(r),jm.delete(r)};Et.sync=r=>{O0=!0,Et.batchedUpdates(r),O0=!1};Et.throttle=r=>{let e;function t(){try{r(...e)}finally{e=null}}function i(...n){e=n,Et.onStart(t)}return i.handler=r,i.cancel=()=>{Ph.delete(t),e=null},i};var qm=typeof window<"u"?window.requestAnimationFrame:()=>{};Et.use=r=>qm=r;Et.now=typeof performance<"u"?()=>performance.now():Date.now;Et.batchedUpdates=r=>r();Et.catch=console.error;Et.frameLoop="always";Et.advance=()=>{Et.frameLoop!=="demand"?console.warn("Cannot call the manual advancement of rafz whilst frameLoop is not set as demand"):EE()};var wr=-1,Br=0,O0=!1;function dc(r,e){O0?(e.delete(r),r(0)):(e.add(r),yE())}function yE(){wr<0&&(wr=0,Et.frameLoop!=="demand"&&qm(vE))}function e5(){wr=-1}function vE(){~wr&&(qm(vE),Et.batchedUpdates(EE))}function EE(){const r=wr;wr=Et.now();const e=gE(wr);if(e&&(CE(ra.splice(0,e),t=>t.handler()),Br-=e),!Br){e5();return}Ph.flush(),$m.flush(r?Math.min(64,wr-r):16.667),Ym.flush(),jm.flush(),Wm.flush()}function mc(){let r=new Set,e=r;return{add(t){Br+=e==r&&!r.has(t)?1:0,r.add(t)},delete(t){return Br-=e==r&&r.has(t)?1:0,r.delete(t)},flush(t){e.size&&(r=new Set,Br-=e.size,CE(e,i=>i(t)&&r.add(i)),Br+=r.size,e=r)}}}function CE(r,e){r.forEach(t=>{try{e(t)}catch(i){Et.catch(i)}})}var t5=Object.defineProperty,i5=(r,e)=>{for(var t in e)t5(r,t,{get:e[t],enumerable:!0})},gs={};i5(gs,{assign:()=>s5,colors:()=>Mr,createStringInterpolator:()=>Jm,skipAnimation:()=>_E,to:()=>IE,willAdvance:()=>Zm});function U0(){}var n5=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,configurable:!0}),Ve={arr:Array.isArray,obj:r=>!!r&&r.constructor.name==="Object",fun:r=>typeof r=="function",str:r=>typeof r=="string",num:r=>typeof r=="number",und:r=>r===void 0};function Zs(r,e){if(Ve.arr(r)){if(!Ve.arr(e)||r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}return r===e}var $t=(r,e)=>r.forEach(e);function cr(r,e,t){if(Ve.arr(r)){for(let i=0;i<r.length;i++)e.call(t,r[i],`${i}`);return}for(const i in r)r.hasOwnProperty(i)&&e.call(t,r[i],i)}var qn=r=>Ve.und(r)?[]:Ve.arr(r)?r:[r];function Ml(r,e){if(r.size){const t=Array.from(r);r.clear(),$t(t,e)}}var xl=(r,...e)=>Ml(r,t=>t(...e)),Xm=()=>typeof window>"u"||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent),Jm,IE,Mr=null,_E=!1,Zm=U0,s5=r=>{r.to&&(IE=r.to),r.now&&(Et.now=r.now),r.colors!==void 0&&(Mr=r.colors),r.skipAnimation!=null&&(_E=r.skipAnimation),r.createStringInterpolator&&(Jm=r.createStringInterpolator),r.requestAnimationFrame&&Et.use(r.requestAnimationFrame),r.batchedUpdates&&(Et.batchedUpdates=r.batchedUpdates),r.willAdvance&&(Zm=r.willAdvance),r.frameLoop&&(Et.frameLoop=r.frameLoop)},Ll=new Set,jn=[],xf=[],oh=0,Fh={get idle(){return!Ll.size&&!jn.length},start(r){oh>r.priority?(Ll.add(r),Et.onStart(r5)):(xE(r),Et(N0))},advance:N0,sort(r){if(oh)Et.onFrame(()=>Fh.sort(r));else{const e=jn.indexOf(r);~e&&(jn.splice(e,1),SE(r))}},clear(){jn=[],Ll.clear()}};function r5(){Ll.forEach(xE),Ll.clear(),Et(N0)}function xE(r){jn.includes(r)||SE(r)}function SE(r){jn.splice(o5(jn,e=>e.priority>r.priority),0,r)}function N0(r){const e=xf;for(let t=0;t<jn.length;t++){const i=jn[t];oh=i.priority,i.idle||(Zm(i),i.advance(r),i.idle||e.push(i))}return oh=0,xf=jn,xf.length=0,jn=e,jn.length>0}function o5(r,e){const t=r.findIndex(e);return t<0?r.length:t}var a5={transparent:0,aliceblue:4042850303,antiquewhite:4209760255,aqua:16777215,aquamarine:2147472639,azure:4043309055,beige:4126530815,bisque:4293182719,black:255,blanchedalmond:4293643775,blue:65535,blueviolet:2318131967,brown:2771004159,burlywood:3736635391,burntsienna:3934150143,cadetblue:1604231423,chartreuse:2147418367,chocolate:3530104575,coral:4286533887,cornflowerblue:1687547391,cornsilk:4294499583,crimson:3692313855,cyan:16777215,darkblue:35839,darkcyan:9145343,darkgoldenrod:3095792639,darkgray:2846468607,darkgreen:6553855,darkgrey:2846468607,darkkhaki:3182914559,darkmagenta:2332068863,darkolivegreen:1433087999,darkorange:4287365375,darkorchid:2570243327,darkred:2332033279,darksalmon:3918953215,darkseagreen:2411499519,darkslateblue:1211993087,darkslategray:793726975,darkslategrey:793726975,darkturquoise:13554175,darkviolet:2483082239,deeppink:4279538687,deepskyblue:12582911,dimgray:1768516095,dimgrey:1768516095,dodgerblue:512819199,firebrick:2988581631,floralwhite:4294635775,forestgreen:579543807,fuchsia:4278255615,gainsboro:3705462015,ghostwhite:4177068031,gold:4292280575,goldenrod:3668254975,gray:2155905279,green:8388863,greenyellow:2919182335,grey:2155905279,honeydew:4043305215,hotpink:4285117695,indianred:3445382399,indigo:1258324735,ivory:4294963455,khaki:4041641215,lavender:3873897215,lavenderblush:4293981695,lawngreen:2096890111,lemonchiffon:4294626815,lightblue:2916673279,lightcoral:4034953471,lightcyan:3774873599,lightgoldenrodyellow:4210742015,lightgray:3553874943,lightgreen:2431553791,lightgrey:3553874943,lightpink:4290167295,lightsalmon:4288707327,lightseagreen:548580095,lightskyblue:2278488831,lightslategray:2005441023,lightslategrey:2005441023,lightsteelblue:2965692159,lightyellow:4294959359,lime:16711935,limegreen:852308735,linen:4210091775,magenta:4278255615,maroon:2147483903,mediumaquamarine:1724754687,mediumblue:52735,mediumorchid:3126187007,mediumpurple:2473647103,mediumseagreen:1018393087,mediumslateblue:2070474495,mediumspringgreen:16423679,mediumturquoise:1221709055,mediumvioletred:3340076543,midnightblue:421097727,mintcream:4127193855,mistyrose:4293190143,moccasin:4293178879,navajowhite:4292783615,navy:33023,oldlace:4260751103,olive:2155872511,olivedrab:1804477439,orange:4289003775,orangered:4282712319,orchid:3664828159,palegoldenrod:4008225535,palegreen:2566625535,paleturquoise:2951671551,palevioletred:3681588223,papayawhip:4293907967,peachpuff:4292524543,peru:3448061951,pink:4290825215,plum:3718307327,powderblue:2967529215,purple:2147516671,rebeccapurple:1714657791,red:4278190335,rosybrown:3163525119,royalblue:1097458175,saddlebrown:2336560127,salmon:4202722047,sandybrown:4104413439,seagreen:780883967,seashell:4294307583,sienna:2689740287,silver:3233857791,skyblue:2278484991,slateblue:1784335871,slategray:1887473919,slategrey:1887473919,snow:4294638335,springgreen:16744447,steelblue:1182971135,tan:3535047935,teal:8421631,thistle:3636451583,tomato:4284696575,turquoise:1088475391,violet:4001558271,wheat:4125012991,white:4294967295,whitesmoke:4126537215,yellow:4294902015,yellowgreen:2597139199},As="[-+]?\\d*\\.?\\d+",ah=As+"%";function kh(...r){return"\\(\\s*("+r.join(")\\s*,\\s*(")+")\\s*\\)"}var l5=new RegExp("rgb"+kh(As,As,As)),c5=new RegExp("rgba"+kh(As,As,As,As)),u5=new RegExp("hsl"+kh(As,ah,ah)),h5=new RegExp("hsla"+kh(As,ah,ah,As)),f5=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,d5=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,m5=/^#([0-9a-fA-F]{6})$/,A5=/^#([0-9a-fA-F]{8})$/;function p5(r){let e;return typeof r=="number"?r>>>0===r&&r>=0&&r<=4294967295?r:null:(e=m5.exec(r))?parseInt(e[1]+"ff",16)>>>0:Mr&&Mr[r]!==void 0?Mr[r]:(e=l5.exec(r))?(go(e[1])<<24|go(e[2])<<16|go(e[3])<<8|255)>>>0:(e=c5.exec(r))?(go(e[1])<<24|go(e[2])<<16|go(e[3])<<8|Ag(e[4]))>>>0:(e=f5.exec(r))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+"ff",16)>>>0:(e=A5.exec(r))?parseInt(e[1],16)>>>0:(e=d5.exec(r))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+e[4]+e[4],16)>>>0:(e=u5.exec(r))?(dg(mg(e[1]),Dc(e[2]),Dc(e[3]))|255)>>>0:(e=h5.exec(r))?(dg(mg(e[1]),Dc(e[2]),Dc(e[3]))|Ag(e[4]))>>>0:null}function Sf(r,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?r+(e-r)*6*t:t<1/2?e:t<2/3?r+(e-r)*(2/3-t)*6:r}function dg(r,e,t){const i=t<.5?t*(1+e):t+e-t*e,n=2*t-i,s=Sf(n,i,r+1/3),o=Sf(n,i,r),a=Sf(n,i,r-1/3);return Math.round(s*255)<<24|Math.round(o*255)<<16|Math.round(a*255)<<8}function go(r){const e=parseInt(r,10);return e<0?0:e>255?255:e}function mg(r){return(parseFloat(r)%360+360)%360/360}function Ag(r){const e=parseFloat(r);return e<0?0:e>1?255:Math.round(e*255)}function Dc(r){const e=parseFloat(r);return e<0?0:e>100?1:e/100}function pg(r){let e=p5(r);if(e===null)return r;e=e||0;const t=(e&4278190080)>>>24,i=(e&16711680)>>>16,n=(e&65280)>>>8,s=(e&255)/255;return`rgba(${t}, ${i}, ${n}, ${s})`}var Wl=(r,e,t)=>{if(Ve.fun(r))return r;if(Ve.arr(r))return Wl({range:r,output:e,extrapolate:t});if(Ve.str(r.output[0]))return Jm(r);const i=r,n=i.output,s=i.range||[0,1],o=i.extrapolateLeft||i.extrapolate||"extend",a=i.extrapolateRight||i.extrapolate||"extend",l=i.easing||(c=>c);return c=>{const u=y5(c,s);return g5(c,s[u],s[u+1],n[u],n[u+1],l,o,a,i.map)}};function g5(r,e,t,i,n,s,o,a,l){let c=l?l(r):r;if(c<e){if(o==="identity")return c;o==="clamp"&&(c=e)}if(c>t){if(a==="identity")return c;a==="clamp"&&(c=t)}return i===n?i:e===t?r<=e?i:n:(e===-1/0?c=-c:t===1/0?c=c-e:c=(c-e)/(t-e),c=s(c),i===-1/0?c=-c:n===1/0?c=c+i:c=c*(n-i)+i,c)}function y5(r,e){for(var t=1;t<e.length-1&&!(e[t]>=r);++t);return t-1}var v5={linear:r=>r},ql=Symbol.for("FluidValue.get"),ma=Symbol.for("FluidValue.observers"),Ds=r=>!!(r&&r[ql]),$n=r=>r&&r[ql]?r[ql]():r,gg=r=>r[ma]||null;function E5(r,e){r.eventObserved?r.eventObserved(e):r(e)}function lh(r,e){const t=r[ma];t&&t.forEach(i=>{E5(i,e)})}var C5=class{constructor(r){if(!r&&!(r=this.get))throw Error("Unknown getter");I5(this,r)}},I5=(r,e)=>TE(r,ql,e);function Ac(r,e){if(r[ql]){let t=r[ma];t||TE(r,ma,t=new Set),t.has(e)||(t.add(e),r.observerAdded&&r.observerAdded(t.size,e))}return e}function ch(r,e){const t=r[ma];if(t&&t.has(e)){const i=t.size-1;i?t.delete(e):r[ma]=null,r.observerRemoved&&r.observerRemoved(i,e)}}var TE=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,configurable:!0}),Qu=/[+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,_5=/(#(?:[0-9a-f]{2}){2,4}|(#[0-9a-f]{3})|(rgb|hsl)a?\((-?\d+%?[,\s]+){2,3}\s*[\d\.]+%?\))/gi,yg=new RegExp(`(${Qu.source})(%|[a-z]+)`,"i"),x5=/rgba\(([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+)\)/gi,Oh=/var\((--[a-zA-Z0-9-_]+),? ?([a-zA-Z0-9 ()%#.,-]+)?\)/,bE=r=>{const[e,t]=S5(r);if(!e||Xm())return r;const i=window.getComputedStyle(document.documentElement).getPropertyValue(e);if(i)return i.trim();if(t&&t.startsWith("--")){const n=window.getComputedStyle(document.documentElement).getPropertyValue(t);return n||r}else{if(t&&Oh.test(t))return bE(t);if(t)return t}return r},S5=r=>{const e=Oh.exec(r);if(!e)return[,];const[,t,i]=e;return[t,i]},Tf,T5=(r,e,t,i,n)=>`rgba(${Math.round(e)}, ${Math.round(t)}, ${Math.round(i)}, ${n})`,wE=r=>{Tf||(Tf=Mr?new RegExp(`(${Object.keys(Mr).join("|")})(?!\\w)`,"g"):/^\b$/);const e=r.output.map(s=>$n(s).replace(Oh,bE).replace(_5,pg).replace(Tf,pg)),t=e.map(s=>s.match(Qu).map(Number)),n=t[0].map((s,o)=>t.map(a=>{if(!(o in a))throw Error('The arity of each "output" value must be equal');return a[o]})).map(s=>Wl({...r,output:s}));return s=>{const o=!yg.test(e[0])&&e.find(l=>yg.test(l))?.replace(Qu,"");let a=0;return e[0].replace(Qu,()=>`${n[a++](s)}${o||""}`).replace(x5,T5)}},eA="react-spring: ",BE=r=>{const e=r;let t=!1;if(typeof e!="function")throw new TypeError(`${eA}once requires a function parameter`);return(...i)=>{t||(e(...i),t=!0)}},b5=BE(console.warn);function w5(){b5(`${eA}The "interpolate" function is deprecated in v9 (use "to" instead)`)}var B5=BE(console.warn);function R5(){B5(`${eA}Directly calling start instead of using the api object is deprecated in v9 (use ".start" instead), this will be removed in later 0.X.0 versions`)}function Uh(r){return Ve.str(r)&&(r[0]=="#"||/\d/.test(r)||!Xm()&&Oh.test(r)||r in(Mr||{}))}var tA=Xm()?y.useEffect:y.useLayoutEffect,D5=()=>{const r=y.useRef(!1);return tA(()=>(r.current=!0,()=>{r.current=!1}),[]),r};function RE(){const r=y.useState()[1],e=D5();return()=>{e.current&&r(Math.random())}}function M5(r,e){const[t]=y.useState(()=>({inputs:e,result:r()})),i=y.useRef(),n=i.current;let s=n;return s?e&&s.inputs&&L5(e,s.inputs)||(s={inputs:e,result:r()}):s=t,y.useEffect(()=>{i.current=s,n==t&&(t.inputs=t.result=void 0)},[s]),s.result}function L5(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}var DE=r=>y.useEffect(r,P5),P5=[];function vg(r){const e=y.useRef();return y.useEffect(()=>{e.current=r}),e.current}var Xl=Symbol.for("Animated:node"),F5=r=>!!r&&r[Xl]===r,Bs=r=>r&&r[Xl],iA=(r,e)=>n5(r,Xl,e),Nh=r=>r&&r[Xl]&&r[Xl].getPayload(),ME=class{constructor(){iA(this,this)}getPayload(){return this.payload||[]}},pc=class extends ME{constructor(r){super(),this._value=r,this.done=!0,this.durationProgress=0,Ve.num(this._value)&&(this.lastPosition=this._value)}static create(r){return new pc(r)}getPayload(){return[this]}getValue(){return this._value}setValue(r,e){return Ve.num(r)&&(this.lastPosition=r,e&&(r=Math.round(r/e)*e,this.done&&(this.lastPosition=r))),this._value===r?!1:(this._value=r,!0)}reset(){const{done:r}=this;this.done=!1,Ve.num(this._value)&&(this.elapsedTime=0,this.durationProgress=0,this.lastPosition=this._value,r&&(this.lastVelocity=null),this.v0=null)}},Jl=class extends pc{constructor(r){super(0),this._string=null,this._toString=Wl({output:[r,r]})}static create(r){return new Jl(r)}getValue(){const r=this._string;return r??(this._string=this._toString(this._value))}setValue(r){if(Ve.str(r)){if(r==this._string)return!1;this._string=r,this._value=1}else if(super.setValue(r))this._string=null;else return!1;return!0}reset(r){r&&(this._toString=Wl({output:[this.getValue(),r]})),this._value=0,super.reset()}},uh={dependencies:null},nA=class extends ME{constructor(r){super(),this.source=r,this.setValue(r)}getValue(r){const e={};return cr(this.source,(t,i)=>{F5(t)?e[i]=t.getValue(r):Ds(t)?e[i]=$n(t):r||(e[i]=t)}),e}setValue(r){this.source=r,this.payload=this._makePayload(r)}reset(){this.payload&&$t(this.payload,r=>r.reset())}_makePayload(r){if(r){const e=new Set;return cr(r,this._addToPayload,e),Array.from(e)}}_addToPayload(r){uh.dependencies&&Ds(r)&&uh.dependencies.add(r);const e=Nh(r);e&&$t(e,t=>this.add(t))}},LE=class extends nA{constructor(r){super(r)}static create(r){return new LE(r)}getValue(){return this.source.map(r=>r.getValue())}setValue(r){const e=this.getPayload();return r.length==e.length?e.map((t,i)=>t.setValue(r[i])).some(Boolean):(super.setValue(r.map(k5)),!0)}};function k5(r){return(Uh(r)?Jl:pc).create(r)}function G0(r){const e=Bs(r);return e?e.constructor:Ve.arr(r)?LE:Uh(r)?Jl:pc}var Eg=(r,e)=>{const t=!Ve.fun(r)||r.prototype&&r.prototype.isReactComponent;return y.forwardRef((i,n)=>{const s=y.useRef(null),o=t&&y.useCallback(m=>{s.current=N5(n,m)},[n]),[a,l]=U5(i,e),c=RE(),u=()=>{const m=s.current;if(t&&!m)return;(m?e.applyAnimatedValues(m,a.getValue(!0)):!1)===!1&&c()},h=new O5(u,l),f=y.useRef();tA(()=>(f.current=h,$t(l,m=>Ac(m,h)),()=>{f.current&&($t(f.current.deps,m=>ch(m,f.current)),Et.cancel(f.current.update))})),y.useEffect(u,[]),DE(()=>()=>{const m=f.current;$t(m.deps,A=>ch(A,m))});const d=e.getComponentProps(a.getValue());return y.createElement(r,{...d,ref:o})})},O5=class{constructor(r,e){this.update=r,this.deps=e}eventObserved(r){r.type=="change"&&Et.write(this.update)}};function U5(r,e){const t=new Set;return uh.dependencies=t,r.style&&(r={...r,style:e.createAnimatedStyle(r.style)}),r=new nA(r),uh.dependencies=null,[r,t]}function N5(r,e){return r&&(Ve.fun(r)?r(e):r.current=e),e}var Cg=Symbol.for("AnimatedComponent"),G5=(r,{applyAnimatedValues:e=()=>!1,createAnimatedStyle:t=n=>new nA(n),getComponentProps:i=n=>n}={})=>{const n={applyAnimatedValues:e,createAnimatedStyle:t,getComponentProps:i},s=o=>{const a=Ig(o)||"Anonymous";return Ve.str(o)?o=s[o]||(s[o]=Eg(o,n)):o=o[Cg]||(o[Cg]=Eg(o,n)),o.displayName=`Animated(${a})`,o};return cr(r,(o,a)=>{Ve.arr(r)&&(a=Ig(o)),s[a]=s(o)}),{animated:s}},Ig=r=>Ve.str(r)?r:r&&Ve.str(r.displayName)?r.displayName:Ve.fun(r)&&r.name||null;function Zr(r,...e){return Ve.fun(r)?r(...e):r}var Pl=(r,e)=>r===!0||!!(e&&r&&(Ve.fun(r)?r(e):qn(r).includes(e))),PE=(r,e)=>Ve.obj(r)?e&&r[e]:r,FE=(r,e)=>r.default===!0?r[e]:r.default?r.default[e]:void 0,Q5=r=>r,sA=(r,e=Q5)=>{let t=z5;r.default&&r.default!==!0&&(r=r.default,t=Object.keys(r));const i={};for(const n of t){const s=e(r[n],n);Ve.und(s)||(i[n]=s)}return i},z5=["config","onProps","onStart","onChange","onPause","onResume","onRest"],H5={config:1,from:1,to:1,ref:1,loop:1,reset:1,pause:1,cancel:1,reverse:1,immediate:1,default:1,delay:1,onProps:1,onStart:1,onChange:1,onPause:1,onResume:1,onRest:1,onResolve:1,items:1,trail:1,sort:1,expires:1,initial:1,enter:1,update:1,leave:1,children:1,onDestroyed:1,keys:1,callId:1,parentId:1};function V5(r){const e={};let t=0;if(cr(r,(i,n)=>{H5[n]||(e[n]=i,t++)}),t)return e}function kE(r){const e=V5(r);if(e){const t={to:e};return cr(r,(i,n)=>n in e||(t[n]=i)),t}return{...r}}function Zl(r){return r=$n(r),Ve.arr(r)?r.map(Zl):Uh(r)?gs.createStringInterpolator({range:[0,1],output:[r,r]})(1):r}function K5(r){for(const e in r)return!0;return!1}function Q0(r){return Ve.fun(r)||Ve.arr(r)&&Ve.obj(r[0])}function $5(r,e){r.ref?.delete(r),e?.delete(r)}function j5(r,e){e&&r.ref!==e&&(r.ref?.delete(r),e.add(r),r.ref=e)}var Y5={default:{tension:170,friction:26}},z0={...Y5.default,mass:1,damping:1,easing:v5.linear,clamp:!1},W5=class{constructor(){this.velocity=0,Object.assign(this,z0)}};function q5(r,e,t){t&&(t={...t},_g(t,e),e={...t,...e}),_g(r,e),Object.assign(r,e);for(const o in z0)r[o]==null&&(r[o]=z0[o]);let{frequency:i,damping:n}=r;const{mass:s}=r;return Ve.und(i)||(i<.01&&(i=.01),n<0&&(n=0),r.tension=Math.pow(2*Math.PI/i,2)*s,r.friction=4*Math.PI*n*s/i),r}function _g(r,e){if(!Ve.und(e.decay))r.duration=void 0;else{const t=!Ve.und(e.tension)||!Ve.und(e.friction);(t||!Ve.und(e.frequency)||!Ve.und(e.damping)||!Ve.und(e.mass))&&(r.duration=void 0,r.decay=void 0),t&&(r.frequency=void 0)}}var xg=[],X5=class{constructor(){this.changed=!1,this.values=xg,this.toValues=null,this.fromValues=xg,this.config=new W5,this.immediate=!1}};function OE(r,{key:e,props:t,defaultProps:i,state:n,actions:s}){return new Promise((o,a)=>{let l,c,u=Pl(t.cancel??i?.cancel,e);if(u)d();else{Ve.und(t.pause)||(n.paused=Pl(t.pause,e));let m=i?.pause;m!==!0&&(m=n.paused||Pl(m,e)),l=Zr(t.delay||0,e),m?(n.resumeQueue.add(f),s.pause()):(s.resume(),f())}function h(){n.resumeQueue.add(f),n.timeouts.delete(c),c.cancel(),l=c.time-Et.now()}function f(){l>0&&!gs.skipAnimation?(n.delayed=!0,c=Et.setTimeout(d,l),n.pauseQueue.add(h),n.timeouts.add(c)):d()}function d(){n.delayed&&(n.delayed=!1),n.pauseQueue.delete(h),n.timeouts.delete(c),r<=(n.cancelId||0)&&(u=!0);try{s.start({...t,callId:r,cancel:u},o)}catch(m){a(m)}}})}var rA=(r,e)=>e.length==1?e[0]:e.some(t=>t.cancelled)?oa(r.get()):e.every(t=>t.noop)?UE(r.get()):ds(r.get(),e.every(t=>t.finished)),UE=r=>({value:r,noop:!0,finished:!0,cancelled:!1}),ds=(r,e,t=!1)=>({value:r,finished:e,cancelled:t}),oa=r=>({value:r,cancelled:!0,finished:!1});function NE(r,e,t,i){const{callId:n,parentId:s,onRest:o}=e,{asyncTo:a,promise:l}=t;return!s&&r===a&&!e.reset?l:t.promise=(async()=>{t.asyncId=n,t.asyncTo=r;const c=sA(e,(p,g)=>g==="onRest"?void 0:p);let u,h;const f=new Promise((p,g)=>(u=p,h=g)),d=p=>{const g=n<=(t.cancelId||0)&&oa(i)||n!==t.asyncId&&ds(i,!1);if(g)throw p.result=g,h(p),p},m=(p,g)=>{const v=new Sg,E=new Tg;return(async()=>{if(gs.skipAnimation)throw ec(t),E.result=ds(i,!1),h(E),E;d(v);const C=Ve.obj(p)?{...p}:{...g,to:p};C.parentId=n,cr(c,(_,x)=>{Ve.und(C[x])&&(C[x]=_)});const I=await i.start(C);return d(v),t.paused&&await new Promise(_=>{t.resumeQueue.add(_)}),I})()};let A;if(gs.skipAnimation)return ec(t),ds(i,!1);try{let p;Ve.arr(r)?p=(async g=>{for(const v of g)await m(v)})(r):p=Promise.resolve(r(m,i.stop.bind(i))),await Promise.all([p.then(u),f]),A=ds(i.get(),!0,!1)}catch(p){if(p instanceof Sg)A=p.result;else if(p instanceof Tg)A=p.result;else throw p}finally{n==t.asyncId&&(t.asyncId=s,t.asyncTo=s?a:void 0,t.promise=s?l:void 0)}return Ve.fun(o)&&Et.batchedUpdates(()=>{o(A,i,i.item)}),A})()}function ec(r,e){Ml(r.timeouts,t=>t.cancel()),r.pauseQueue.clear(),r.resumeQueue.clear(),r.asyncId=r.asyncTo=r.promise=void 0,e&&(r.cancelId=e)}var Sg=class extends Error{constructor(){super("An async animation has been interrupted. You see this error because you forgot to use `await` or `.catch(...)` on its returned promise.")}},Tg=class extends Error{constructor(){super("SkipAnimationSignal")}},H0=r=>r instanceof oA,J5=1,oA=class extends C5{constructor(){super(...arguments),this.id=J5++,this._priority=0}get priority(){return this._priority}set priority(r){this._priority!=r&&(this._priority=r,this._onPriorityChange(r))}get(){const r=Bs(this);return r&&r.getValue()}to(...r){return gs.to(this,r)}interpolate(...r){return w5(),gs.to(this,r)}toJSON(){return this.get()}observerAdded(r){r==1&&this._attach()}observerRemoved(r){r==0&&this._detach()}_attach(){}_detach(){}_onChange(r,e=!1){lh(this,{type:"change",parent:this,value:r,idle:e})}_onPriorityChange(r){this.idle||Fh.sort(this),lh(this,{type:"priority",parent:this,priority:r})}},lo=Symbol.for("SpringPhase"),GE=1,QE=2,zE=4,bf=r=>(r[lo]&GE)>0,pr=r=>(r[lo]&QE)>0,za=r=>(r[lo]&zE)>0,bg=(r,e)=>e?r[lo]|=QE|GE:r[lo]&=-3,wg=(r,e)=>e?r[lo]|=zE:r[lo]&=-5,Z5=class extends oA{constructor(r,e){if(super(),this.animation=new X5,this.defaultProps={},this._state={paused:!1,delayed:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._pendingCalls=new Set,this._lastCallId=0,this._lastToId=0,this._memoizedDuration=0,!Ve.und(r)||!Ve.und(e)){const t=Ve.obj(r)?{...r}:{...e,from:r};Ve.und(t.default)&&(t.default=!0),this.start(t)}}get idle(){return!(pr(this)||this._state.asyncTo)||za(this)}get goal(){return $n(this.animation.to)}get velocity(){const r=Bs(this);return r instanceof pc?r.lastVelocity||0:r.getPayload().map(e=>e.lastVelocity||0)}get hasAnimated(){return bf(this)}get isAnimating(){return pr(this)}get isPaused(){return za(this)}get isDelayed(){return this._state.delayed}advance(r){let e=!0,t=!1;const i=this.animation;let{toValues:n}=i;const{config:s}=i,o=Nh(i.to);!o&&Ds(i.to)&&(n=qn($n(i.to))),i.values.forEach((c,u)=>{if(c.done)return;const h=c.constructor==Jl?1:o?o[u].lastPosition:n[u];let f=i.immediate,d=h;if(!f){if(d=c.lastPosition,s.tension<=0){c.done=!0;return}let m=c.elapsedTime+=r;const A=i.fromValues[u],p=c.v0!=null?c.v0:c.v0=Ve.arr(s.velocity)?s.velocity[u]:s.velocity;let g;const v=s.precision||(A==h?.005:Math.min(1,Math.abs(h-A)*.001));if(Ve.und(s.duration))if(s.decay){const E=s.decay===!0?.998:s.decay,C=Math.exp(-(1-E)*m);d=A+p/(1-E)*(1-C),f=Math.abs(c.lastPosition-d)<=v,g=p*C}else{g=c.lastVelocity==null?p:c.lastVelocity;const E=s.restVelocity||v/10,C=s.clamp?0:s.bounce,I=!Ve.und(C),_=A==h?c.v0>0:A<h;let x,S=!1;const b=1,T=Math.ceil(r/b);for(let B=0;B<T&&(x=Math.abs(g)>E,!(!x&&(f=Math.abs(h-d)<=v,f)));++B){I&&(S=d==h||d>h==_,S&&(g=-g*C,d=h));const w=-s.tension*1e-6*(d-h),R=-s.friction*.001*g,D=(w+R)/s.mass;g=g+D*b,d=d+g*b}}else{let E=1;s.duration>0&&(this._memoizedDuration!==s.duration&&(this._memoizedDuration=s.duration,c.durationProgress>0&&(c.elapsedTime=s.duration*c.durationProgress,m=c.elapsedTime+=r)),E=(s.progress||0)+m/this._memoizedDuration,E=E>1?1:E<0?0:E,c.durationProgress=E),d=A+s.easing(E)*(h-A),g=(d-c.lastPosition)/r,f=E==1}c.lastVelocity=g,Number.isNaN(d)&&(console.warn("Got NaN while animating:",this),f=!0)}o&&!o[u].done&&(f=!1),f?c.done=!0:e=!1,c.setValue(d,s.round)&&(t=!0)});const a=Bs(this),l=a.getValue();if(e){const c=$n(i.to);(l!==c||t)&&!s.decay?(a.setValue(c),this._onChange(c)):t&&s.decay&&this._onChange(l),this._stop()}else t&&this._onChange(l)}set(r){return Et.batchedUpdates(()=>{this._stop(),this._focus(r),this._set(r)}),this}pause(){this._update({pause:!0})}resume(){this._update({pause:!1})}finish(){if(pr(this)){const{to:r,config:e}=this.animation;Et.batchedUpdates(()=>{this._onStart(),e.decay||this._set(r,!1),this._stop()})}return this}update(r){return(this.queue||(this.queue=[])).push(r),this}start(r,e){let t;return Ve.und(r)?(t=this.queue||[],this.queue=[]):t=[Ve.obj(r)?r:{...e,to:r}],Promise.all(t.map(i=>this._update(i))).then(i=>rA(this,i))}stop(r){const{to:e}=this.animation;return this._focus(this.get()),ec(this._state,r&&this._lastCallId),Et.batchedUpdates(()=>this._stop(e,r)),this}reset(){this._update({reset:!0})}eventObserved(r){r.type=="change"?this._start():r.type=="priority"&&(this.priority=r.priority+1)}_prepareNode(r){const e=this.key||"";let{to:t,from:i}=r;t=Ve.obj(t)?t[e]:t,(t==null||Q0(t))&&(t=void 0),i=Ve.obj(i)?i[e]:i,i==null&&(i=void 0);const n={to:t,from:i};return bf(this)||(r.reverse&&([t,i]=[i,t]),i=$n(i),Ve.und(i)?Bs(this)||this._set(t):this._set(i)),n}_update({...r},e){const{key:t,defaultProps:i}=this;r.default&&Object.assign(i,sA(r,(o,a)=>/^on/.test(a)?PE(o,t):o)),Rg(this,r,"onProps"),Va(this,"onProps",r,this);const n=this._prepareNode(r);if(Object.isFrozen(this))throw Error("Cannot animate a `SpringValue` object that is frozen. Did you forget to pass your component to `animated(...)` before animating its props?");const s=this._state;return OE(++this._lastCallId,{key:t,props:r,defaultProps:i,state:s,actions:{pause:()=>{za(this)||(wg(this,!0),xl(s.pauseQueue),Va(this,"onPause",ds(this,Ha(this,this.animation.to)),this))},resume:()=>{za(this)&&(wg(this,!1),pr(this)&&this._resume(),xl(s.resumeQueue),Va(this,"onResume",ds(this,Ha(this,this.animation.to)),this))},start:this._merge.bind(this,n)}}).then(o=>{if(r.loop&&o.finished&&!(e&&o.noop)){const a=HE(r);if(a)return this._update(a,!0)}return o})}_merge(r,e,t){if(e.cancel)return this.stop(!0),t(oa(this));const i=!Ve.und(r.to),n=!Ve.und(r.from);if(i||n)if(e.callId>this._lastToId)this._lastToId=e.callId;else return t(oa(this));const{key:s,defaultProps:o,animation:a}=this,{to:l,from:c}=a;let{to:u=l,from:h=c}=r;n&&!i&&(!e.default||Ve.und(u))&&(u=h),e.reverse&&([u,h]=[h,u]);const f=!Zs(h,c);f&&(a.from=h),h=$n(h);const d=!Zs(u,l);d&&this._focus(u);const m=Q0(e.to),{config:A}=a,{decay:p,velocity:g}=A;(i||n)&&(A.velocity=0),e.config&&!m&&q5(A,Zr(e.config,s),e.config!==o.config?Zr(o.config,s):void 0);let v=Bs(this);if(!v||Ve.und(u))return t(ds(this,!0));const E=Ve.und(e.reset)?n&&!e.default:!Ve.und(h)&&Pl(e.reset,s),C=E?h:this.get(),I=Zl(u),_=Ve.num(I)||Ve.arr(I)||Uh(I),x=!m&&(!_||Pl(o.immediate||e.immediate,s));if(d){const B=G0(u);if(B!==v.constructor)if(x)v=this._set(I);else throw Error(`Cannot animate between ${v.constructor.name} and ${B.name}, as the "to" prop suggests`)}const S=v.constructor;let b=Ds(u),T=!1;if(!b){const B=E||!bf(this)&&f;(d||B)&&(T=Zs(Zl(C),I),b=!T),(!Zs(a.immediate,x)&&!x||!Zs(A.decay,p)||!Zs(A.velocity,g))&&(b=!0)}if(T&&pr(this)&&(a.changed&&!E?b=!0:b||this._stop(l)),!m&&((b||Ds(l))&&(a.values=v.getPayload(),a.toValues=Ds(u)?null:S==Jl?[1]:qn(I)),a.immediate!=x&&(a.immediate=x,!x&&!E&&this._set(l)),b)){const{onRest:B}=a;$t(tS,R=>Rg(this,e,R));const w=ds(this,Ha(this,l));xl(this._pendingCalls,w),this._pendingCalls.add(t),a.changed&&Et.batchedUpdates(()=>{a.changed=!E,B?.(w,this),E?Zr(o.onRest,w):a.onStart?.(w,this)})}E&&this._set(C),m?t(NE(e.to,e,this._state,this)):b?this._start():pr(this)&&!d?this._pendingCalls.add(t):t(UE(C))}_focus(r){const e=this.animation;r!==e.to&&(gg(this)&&this._detach(),e.to=r,gg(this)&&this._attach())}_attach(){let r=0;const{to:e}=this.animation;Ds(e)&&(Ac(e,this),H0(e)&&(r=e.priority+1)),this.priority=r}_detach(){const{to:r}=this.animation;Ds(r)&&ch(r,this)}_set(r,e=!0){const t=$n(r);if(!Ve.und(t)){const i=Bs(this);if(!i||!Zs(t,i.getValue())){const n=G0(t);!i||i.constructor!=n?iA(this,n.create(t)):i.setValue(t),i&&Et.batchedUpdates(()=>{this._onChange(t,e)})}}return Bs(this)}_onStart(){const r=this.animation;r.changed||(r.changed=!0,Va(this,"onStart",ds(this,Ha(this,r.to)),this))}_onChange(r,e){e||(this._onStart(),Zr(this.animation.onChange,r,this)),Zr(this.defaultProps.onChange,r,this),super._onChange(r,e)}_start(){const r=this.animation;Bs(this).reset($n(r.to)),r.immediate||(r.fromValues=r.values.map(e=>e.lastPosition)),pr(this)||(bg(this,!0),za(this)||this._resume())}_resume(){gs.skipAnimation?this.finish():Fh.start(this)}_stop(r,e){if(pr(this)){bg(this,!1);const t=this.animation;$t(t.values,n=>{n.done=!0}),t.toValues&&(t.onChange=t.onPause=t.onResume=void 0),lh(this,{type:"idle",parent:this});const i=e?oa(this.get()):ds(this.get(),Ha(this,r??t.to));xl(this._pendingCalls,i),t.changed&&(t.changed=!1,Va(this,"onRest",i,this))}}};function Ha(r,e){const t=Zl(e),i=Zl(r.get());return Zs(i,t)}function HE(r,e=r.loop,t=r.to){const i=Zr(e);if(i){const n=i!==!0&&kE(i),s=(n||r).reverse,o=!n||n.reset;return tc({...r,loop:e,default:!1,pause:void 0,to:!s||Q0(t)?t:void 0,from:o?r.from:void 0,reset:o,...n})}}function tc(r){const{to:e,from:t}=r=kE(r),i=new Set;return Ve.obj(e)&&Bg(e,i),Ve.obj(t)&&Bg(t,i),r.keys=i.size?Array.from(i):null,r}function eS(r){const e=tc(r);return Ve.und(e.default)&&(e.default=sA(e)),e}function Bg(r,e){cr(r,(t,i)=>t!=null&&e.add(i))}var tS=["onStart","onRest","onChange","onPause","onResume"];function Rg(r,e,t){r.animation[t]=e[t]!==FE(e,t)?PE(e[t],r.key):void 0}function Va(r,e,...t){r.animation[e]?.(...t),r.defaultProps[e]?.(...t)}var iS=["onStart","onChange","onRest"],nS=1,sS=class{constructor(r,e){this.id=nS++,this.springs={},this.queue=[],this._lastAsyncId=0,this._active=new Set,this._changed=new Set,this._started=!1,this._state={paused:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._events={onStart:new Map,onChange:new Map,onRest:new Map},this._onFrame=this._onFrame.bind(this),e&&(this._flush=e),r&&this.start({default:!0,...r})}get idle(){return!this._state.asyncTo&&Object.values(this.springs).every(r=>r.idle&&!r.isDelayed&&!r.isPaused)}get item(){return this._item}set item(r){this._item=r}get(){const r={};return this.each((e,t)=>r[t]=e.get()),r}set(r){for(const e in r){const t=r[e];Ve.und(t)||this.springs[e].set(t)}}update(r){return r&&this.queue.push(tc(r)),this}start(r){let{queue:e}=this;return r?e=qn(r).map(tc):this.queue=[],this._flush?this._flush(this,e):(YE(this,e),V0(this,e))}stop(r,e){if(r!==!!r&&(e=r),e){const t=this.springs;$t(qn(e),i=>t[i].stop(!!r))}else ec(this._state,this._lastAsyncId),this.each(t=>t.stop(!!r));return this}pause(r){if(Ve.und(r))this.start({pause:!0});else{const e=this.springs;$t(qn(r),t=>e[t].pause())}return this}resume(r){if(Ve.und(r))this.start({pause:!1});else{const e=this.springs;$t(qn(r),t=>e[t].resume())}return this}each(r){cr(this.springs,r)}_onFrame(){const{onStart:r,onChange:e,onRest:t}=this._events,i=this._active.size>0,n=this._changed.size>0;(i&&!this._started||n&&!this._started)&&(this._started=!0,Ml(r,([a,l])=>{l.value=this.get(),a(l,this,this._item)}));const s=!i&&this._started,o=n||s&&t.size?this.get():null;n&&e.size&&Ml(e,([a,l])=>{l.value=o,a(l,this,this._item)}),s&&(this._started=!1,Ml(t,([a,l])=>{l.value=o,a(l,this,this._item)}))}eventObserved(r){if(r.type=="change")this._changed.add(r.parent),r.idle||this._active.add(r.parent);else if(r.type=="idle")this._active.delete(r.parent);else return;Et.onFrame(this._onFrame)}};function V0(r,e){return Promise.all(e.map(t=>VE(r,t))).then(t=>rA(r,t))}async function VE(r,e,t){const{keys:i,to:n,from:s,loop:o,onRest:a,onResolve:l}=e,c=Ve.obj(e.default)&&e.default;o&&(e.loop=!1),n===!1&&(e.to=null),s===!1&&(e.from=null);const u=Ve.arr(n)||Ve.fun(n)?n:void 0;u?(e.to=void 0,e.onRest=void 0,c&&(c.onRest=void 0)):$t(iS,A=>{const p=e[A];if(Ve.fun(p)){const g=r._events[A];e[A]=({finished:v,cancelled:E})=>{const C=g.get(p);C?(v||(C.finished=!1),E&&(C.cancelled=!0)):g.set(p,{value:null,finished:v||!1,cancelled:E||!1})},c&&(c[A]=e[A])}});const h=r._state;e.pause===!h.paused?(h.paused=e.pause,xl(e.pause?h.pauseQueue:h.resumeQueue)):h.paused&&(e.pause=!0);const f=(i||Object.keys(r.springs)).map(A=>r.springs[A].start(e)),d=e.cancel===!0||FE(e,"cancel")===!0;(u||d&&h.asyncId)&&f.push(OE(++r._lastAsyncId,{props:e,state:h,actions:{pause:U0,resume:U0,start(A,p){d?(ec(h,r._lastAsyncId),p(oa(r))):(A.onRest=a,p(NE(u,A,h,r)))}}})),h.paused&&await new Promise(A=>{h.resumeQueue.add(A)});const m=rA(r,await Promise.all(f));if(o&&m.finished&&!(t&&m.noop)){const A=HE(e,o,n);if(A)return YE(r,[A]),VE(r,A,!0)}return l&&Et.batchedUpdates(()=>l(m,r,r.item)),m}function Dg(r,e){const t={...r.springs};return e&&$t(qn(e),i=>{Ve.und(i.keys)&&(i=tc(i)),Ve.obj(i.to)||(i={...i,to:void 0}),jE(t,i,n=>$E(n))}),KE(r,t),t}function KE(r,e){cr(e,(t,i)=>{r.springs[i]||(r.springs[i]=t,Ac(t,r))})}function $E(r,e){const t=new Z5;return t.key=r,e&&Ac(t,e),t}function jE(r,e,t){e.keys&&$t(e.keys,i=>{(r[i]||(r[i]=t(i)))._prepareNode(e)})}function YE(r,e){$t(e,t=>{jE(r.springs,t,i=>$E(i,r))})}var Gh=({children:r,...e})=>{const t=y.useContext(hh),i=e.pause||!!t.pause,n=e.immediate||!!t.immediate;e=M5(()=>({pause:i,immediate:n}),[i,n]);const{Provider:s}=hh;return y.createElement(s,{value:e},r)},hh=rS(Gh,{});Gh.Provider=hh.Provider;Gh.Consumer=hh.Consumer;function rS(r,e){return Object.assign(r,y.createContext(e)),r.Provider._context=r,r.Consumer._context=r,r}var oS=()=>{const r=[],e=function(i){R5();const n=[];return $t(r,(s,o)=>{if(Ve.und(i))n.push(s.start());else{const a=t(i,s,o);a&&n.push(s.start(a))}}),n};e.current=r,e.add=function(i){r.includes(i)||r.push(i)},e.delete=function(i){const n=r.indexOf(i);~n&&r.splice(n,1)},e.pause=function(){return $t(r,i=>i.pause(...arguments)),this},e.resume=function(){return $t(r,i=>i.resume(...arguments)),this},e.set=function(i){$t(r,(n,s)=>{const o=Ve.fun(i)?i(s,n):i;o&&n.set(o)})},e.start=function(i){const n=[];return $t(r,(s,o)=>{if(Ve.und(i))n.push(s.start());else{const a=this._getProps(i,s,o);a&&n.push(s.start(a))}}),n},e.stop=function(){return $t(r,i=>i.stop(...arguments)),this},e.update=function(i){return $t(r,(n,s)=>n.update(this._getProps(i,n,s))),this};const t=function(i,n,s){return Ve.fun(i)?i(s,n):i};return e._getProps=t,e};function aS(r,e,t){const i=Ve.fun(e)&&e;i&&!t&&(t=[]);const n=y.useMemo(()=>i||arguments.length==3?oS():void 0,[]),s=y.useRef(0),o=RE(),a=y.useMemo(()=>({ctrls:[],queue:[],flush(g,v){const E=Dg(g,v);return s.current>0&&!a.queue.length&&!Object.keys(E).some(I=>!g.springs[I])?V0(g,v):new Promise(I=>{KE(g,E),a.queue.push(()=>{I(V0(g,v))}),o()})}}),[]),l=y.useRef([...a.ctrls]),c=[],u=vg(r)||0;y.useMemo(()=>{$t(l.current.slice(r,u),g=>{$5(g,n),g.stop(!0)}),l.current.length=r,h(u,r)},[r]),y.useMemo(()=>{h(0,Math.min(u,r))},t);function h(g,v){for(let E=g;E<v;E++){const C=l.current[E]||(l.current[E]=new sS(null,a.flush)),I=i?i(E,C):e[E];I&&(c[E]=eS(I))}}const f=l.current.map((g,v)=>Dg(g,c[v])),d=y.useContext(Gh),m=vg(d),A=d!==m&&K5(d);tA(()=>{s.current++,a.ctrls=l.current;const{queue:g}=a;g.length&&(a.queue=[],$t(g,v=>v())),$t(l.current,(v,E)=>{n?.add(v),A&&v.start({default:d});const C=c[E];C&&(j5(v,C.ref),v.ref?v.queue.push(C):v.start(C))})}),DE(()=>()=>{$t(a.ctrls,g=>g.stop(!0))});const p=f.map(g=>({...g}));return n?[p,n]:p}function lS(r,e){const t=Ve.fun(r),[[i],n]=aS(1,t?r:[r],t?[]:e);return t||arguments.length==2?[i,n]:i}var cS=class extends oA{constructor(r,e){super(),this.source=r,this.idle=!0,this._active=new Set,this.calc=Wl(...e);const t=this._get(),i=G0(t);iA(this,i.create(t))}advance(r){const e=this._get(),t=this.get();Zs(e,t)||(Bs(this).setValue(e),this._onChange(e,this.idle)),!this.idle&&Mg(this._active)&&wf(this)}_get(){const r=Ve.arr(this.source)?this.source.map($n):qn($n(this.source));return this.calc(...r)}_start(){this.idle&&!Mg(this._active)&&(this.idle=!1,$t(Nh(this),r=>{r.done=!1}),gs.skipAnimation?(Et.batchedUpdates(()=>this.advance()),wf(this)):Fh.start(this))}_attach(){let r=1;$t(qn(this.source),e=>{Ds(e)&&Ac(e,this),H0(e)&&(e.idle||this._active.add(e),r=Math.max(r,e.priority+1))}),this.priority=r,this._start()}_detach(){$t(qn(this.source),r=>{Ds(r)&&ch(r,this)}),this._active.clear(),wf(this)}eventObserved(r){r.type=="change"?r.idle?this.advance():(this._active.add(r.parent),this._start()):r.type=="idle"?this._active.delete(r.parent):r.type=="priority"&&(this.priority=qn(this.source).reduce((e,t)=>Math.max(e,(H0(t)?t.priority:0)+1),0))}};function uS(r){return r.idle!==!1}function Mg(r){return!r.size||Array.from(r).every(uS)}function wf(r){r.idle||(r.idle=!0,$t(Nh(r),e=>{e.done=!0}),lh(r,{type:"idle",parent:r}))}gs.assign({createStringInterpolator:wE,to:(r,e)=>new cS(r,e)});var hS=["primitive"].concat(Object.keys(LI).filter(r=>/^[A-Z]/.test(r)).map(r=>r[0].toLowerCase()+r.slice(1)));gs.assign({createStringInterpolator:wE,colors:a5,frameLoop:"demand"});Mm(()=>{Et.advance()});var fS=G5(hS,{applyAnimatedValues:wn}),dS=fS.animated;function uF({enabled:r=!0,snap:e,global:t,domElement:i,cursor:n=!0,children:s,speed:o=1,rotation:a=[0,0,0],zoom:l=1,polar:c=[0,Math.PI/2],azimuth:u=[-1/0,1/0],config:h={mass:1,tension:170,friction:26}}){const f=de(_=>_.events),d=de(_=>_.gl),m=i||f.connected||d.domElement,{size:A}=de(),p=y.useMemo(()=>[a[0]+c[0],a[0]+c[1]],[a[0],c[0],c[1]]),g=y.useMemo(()=>[a[1]+u[0],a[1]+u[1]],[a[1],u[0],u[1]]),v=y.useMemo(()=>[ot.clamp(a[0],...p),ot.clamp(a[1],...g),a[2]],[a[0],a[1],a[2],p,g]),[E,C]=lS(()=>({scale:1,rotation:v,config:h}));y.useEffect(()=>void C.start({scale:1,rotation:v,config:h}),[v]),y.useEffect(()=>{if(t&&n&&r)return m.style.cursor="grab",d.domElement.style.cursor="",()=>{m.style.cursor="default",d.domElement.style.cursor="default"}},[t,n,m,r]);const I=oE({onHover:({last:_})=>{n&&!t&&r&&(m.style.cursor=_?"auto":"grab")},onDrag:({down:_,delta:[x,S],memo:[b,T]=E.rotation.animation.to||v})=>{if(!r)return[S,x];n&&(m.style.cursor=_?"grabbing":"grab"),x=ot.clamp(T+x/A.width*Math.PI*o,...g),S=ot.clamp(b+S/A.height*Math.PI*o,...p);const B=e&&!_&&typeof e!="boolean"?e:h;return C.start({scale:_&&S>p[1]/2?l:1,rotation:e&&!_?v:[S,x,0],config:w=>w==="scale"?{...B,friction:B.friction*3}:B}),[S,x]}},{target:t?m:void 0});return y.createElement(dS.group,_e({},I?.(),E),s)}const mS=r=>(e,t,i)=>{const n=i.subscribe;return i.subscribe=(o,a,l)=>{let c=o;if(a){const u=l?.equalityFn||Object.is;let h=o(i.getState());c=f=>{const d=o(f);if(!u(h,d)){const m=h;a(h=d,m)}},l?.fireImmediately&&a(h,h)}return n(c)},r(e,t,i)},AS=mS,WE=y.createContext(null);function hF({map:r,children:e,onChange:t,domElement:i}){const n=r.map(l=>l.name+l.keys).join("-"),s=y.useMemo(()=>iE(AS(()=>r.reduce((l,c)=>({...l,[c.name]:!1}),{}))),[n]),o=y.useMemo(()=>[s.subscribe,s.getState,s],[n]),a=s.setState;return y.useEffect(()=>{const c=r.map(({name:d,keys:m,up:A})=>({keys:m,up:A,fn:p=>{a({[d]:p}),t&&t(d,p,o[1]())}})).reduce((d,{keys:m,fn:A,up:p=!0})=>(m.forEach(g=>d[g]={fn:A,pressed:!1,up:p}),d),{}),u=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,pressed:g,up:v}=A;A.pressed=!0,(v||!g)&&p(!0)},h=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,up:g}=A;A.pressed=!1,g&&p(!1)},f=i||window;return f.addEventListener("keydown",u,{passive:!0}),f.addEventListener("keyup",h,{passive:!0}),()=>{f.removeEventListener("keydown",u),f.removeEventListener("keyup",h)}},[i,n]),y.createElement(WE.Provider,{value:o,children:e})}function fF(r){const[e,t,i]=y.useContext(WE);return r?i(r):[e,t]}const aA=cc>=125?"uv1":"uv2";var pS=Object.defineProperty,gS=(r,e,t)=>e in r?pS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ka=(r,e,t)=>(gS(r,typeof e!="symbol"?e+"":e,t),t);const Yo=4,aa=1024,Ls=4,yS=(r=1)=>{const e=new Float32Array(aa*Ls*r*Yo),t=new Fr(e,aa,Ls*r,Mi,hi);return t.wrapS=Ln,t.wrapT=Ln,t.magFilter=li,t.needsUpdate=!0,t},vS=(r,e,t=0)=>{const i=Math.floor(aa*(Ls/4));e.arcLengthDivisions=i/2,e.updateArcLengths();const n=e.getSpacedPoints(i),s=e.computeFrenetFrames(i,!0);for(let o=0;o<i;o++){const a=Math.floor(o/aa),l=o%aa;let c=n[o];Mc(r,l,c.x,c.y,c.z,0+a+Ls*t),c=s.tangents[o],Mc(r,l,c.x,c.y,c.z,1+a+Ls*t),c=s.normals[o],Mc(r,l,c.x,c.y,c.z,2+a+Ls*t),c=s.binormals[o],Mc(r,l,c.x,c.y,c.z,3+a+Ls*t)}r.needsUpdate=!0},Mc=(r,e,t,i,n,s)=>{const o=r.image,{data:a}=o,l=Yo*aa*s;a[e*Yo+l+0]=t,a[e*Yo+l+1]=i,a[e*Yo+l+2]=n,a[e*Yo+l+3]=1},ES=r=>({spineTexture:{value:r},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}});function CS(r,e,t=1){r.__ok||(r.__ok=!0,r.onBeforeCompile=i=>{if(i.__modified)return;i.__modified=!0,Object.assign(i.uniforms,e);const n=`
		uniform sampler2D spineTexture;
		uniform float pathOffset;
		uniform float pathSegment;
		uniform float spineOffset;
		uniform float spineLength;
		uniform int flow;

		float textureLayers = ${Ls*t}.;
		float textureStacks = ${Ls/4}.;

		${i.vertexShader}
		`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,`
        void main() {
        #include <beginnormal_vertex>

        vec4 worldPos = modelMatrix * vec4(position, 1.);

        bool bend = flow > 0;
        float xWeight = bend ? 0. : 1.;

        #ifdef USE_INSTANCING
        float pathOffsetFromInstanceMatrix = instanceMatrix[3][2];
        float spineLengthFromInstanceMatrix = instanceMatrix[3][0];
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;
        float mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;
        #else
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;
        float mt = (spinePortion * pathSegment + pathOffset)*textureStacks;
        #endif

        mt = mod(mt, textureStacks);
        float rowOffset = floor(mt);

        #ifdef USE_INSTANCING
        rowOffset += instanceMatrix[3][1] * ${Ls}.;
        #endif

        vec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;
        mat3 basis = mat3(a, b, c);

        vec3 transformed = basis
          * vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)
          + spinePos;

        vec3 transformedNormal = normalMatrix * (basis * objectNormal);
			`).replace("#include <project_vertex>",`vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );
				gl_Position = projectionMatrix * mvPosition;`);i.vertexShader=n})}class IS{constructor(e,t=1){Ka(this,"curveArray"),Ka(this,"curveLengthArray"),Ka(this,"object3D"),Ka(this,"splineTexure"),Ka(this,"uniforms");const i=e.clone(),n=yS(t),s=ES(n);i.traverse(o=>{(o instanceof je||o instanceof Lm)&&(o.material=o.material.clone(),CS(o.material,s,t))}),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=i,this.splineTexure=n,this.uniforms=s}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const i=t.getLength();this.uniforms.spineLength.value=i,this.curveLengthArray[e]=i,this.curveArray[e]=t,vS(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}function _S(r,e=1e-4){e=Math.max(e,Number.EPSILON);const t={},i=r.getIndex(),n=r.getAttribute("position"),s=i?i.count:n.count;let o=0;const a=Object.keys(r.attributes),l={},c={},u=[],h=["getX","getY","getZ","getW"];for(let A=0,p=a.length;A<p;A++){const g=a[A];l[g]=[];const v=r.morphAttributes[g];v&&(c[g]=new Array(v.length).fill(0).map(()=>[]))}const f=Math.log10(1/e),d=Math.pow(10,f);for(let A=0;A<s;A++){const p=i?i.getX(A):A;let g="";for(let v=0,E=a.length;v<E;v++){const C=a[v],I=r.getAttribute(C),_=I.itemSize;for(let x=0;x<_;x++)g+=`${~~(I[h[x]](p)*d)},`}if(g in t)u.push(t[g]);else{for(let v=0,E=a.length;v<E;v++){const C=a[v],I=r.getAttribute(C),_=r.morphAttributes[C],x=I.itemSize,S=l[C],b=c[C];for(let T=0;T<x;T++){const B=h[T];if(S.push(I[B](p)),_)for(let w=0,R=_.length;w<R;w++)b[w].push(_[w][B](p))}}t[g]=o,u.push(o),o++}}const m=r.clone();for(let A=0,p=a.length;A<p;A++){const g=a[A],v=r.getAttribute(g),E=new v.array.constructor(l[g]),C=new Jt(E,v.itemSize,v.normalized);if(m.setAttribute(g,C),g in c)for(let I=0;I<c[g].length;I++){const _=r.morphAttributes[g][I],x=new _.array.constructor(c[g][I]),S=new Jt(x,_.itemSize,_.normalized);m.morphAttributes[g][I]=S}}return m.setIndex(u),m}function Lg(r,e){if(e===PI)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(e===S0||e===B2){let t=r.getIndex();if(t===null){const o=[],a=r.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);r.setIndex(o),t=r.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r}const i=t.count-2,n=[];if(t)if(e===S0)for(let o=1;o<=i;o++)n.push(t.getX(0)),n.push(t.getX(o)),n.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(n.push(t.getX(o)),n.push(t.getX(o+1)),n.push(t.getX(o+2))):(n.push(t.getX(o+2)),n.push(t.getX(o+1)),n.push(t.getX(o)));n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=r.clone();return s.setIndex(n),s.clearGroups(),s}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),r}function qE(r,e=Math.PI/3){const t=Math.cos(e),i=(1+1e-10)*100,n=[new K,new K,new K],s=new K,o=new K,a=new K,l=new K;function c(A){const p=~~(A.x*i),g=~~(A.y*i),v=~~(A.z*i);return`${p},${g},${v}`}const u=r.index?r.toNonIndexed():r,h=u.attributes.position,f={};for(let A=0,p=h.count/3;A<p;A++){const g=3*A,v=n[0].fromBufferAttribute(h,g+0),E=n[1].fromBufferAttribute(h,g+1),C=n[2].fromBufferAttribute(h,g+2);s.subVectors(C,E),o.subVectors(v,E);const I=new K().crossVectors(s,o).normalize();for(let _=0;_<3;_++){const x=n[_],S=c(x);S in f||(f[S]=[]),f[S].push(I)}}const d=new Float32Array(h.count*3),m=new Jt(d,3,!1);for(let A=0,p=h.count/3;A<p;A++){const g=3*A,v=n[0].fromBufferAttribute(h,g+0),E=n[1].fromBufferAttribute(h,g+1),C=n[2].fromBufferAttribute(h,g+2);s.subVectors(C,E),o.subVectors(v,E),a.crossVectors(s,o).normalize();for(let I=0;I<3;I++){const _=n[I],x=c(_),S=f[x];l.set(0,0,0);for(let b=0,T=S.length;b<T;b++){const B=S[b];a.dot(B)>t&&l.add(B)}l.normalize(),m.setXYZ(g+I,l.x,l.y,l.z)}}return u.setAttribute("normal",m),u}var Yn=Uint8Array,Rr=Uint16Array,K0=Uint32Array,XE=new Yn([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),JE=new Yn([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),xS=new Yn([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ZE=function(r,e){for(var t=new Rr(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new K0(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return[t,n]},e3=ZE(XE,2),t3=e3[0],SS=e3[1];t3[28]=258,SS[258]=28;var TS=ZE(JE,0),bS=TS[0],$0=new Rr(32768);for(var ui=0;ui<32768;++ui){var gr=(ui&43690)>>>1|(ui&21845)<<1;gr=(gr&52428)>>>2|(gr&13107)<<2,gr=(gr&61680)>>>4|(gr&3855)<<4,$0[ui]=((gr&65280)>>>8|(gr&255)<<8)>>>1}var Fl=function(r,e,t){for(var i=r.length,n=0,s=new Rr(e);n<i;++n)++s[r[n]-1];var o=new Rr(e);for(n=0;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new Rr(1<<e);var l=15-e;for(n=0;n<i;++n)if(r[n])for(var c=n<<4|r[n],u=e-r[n],h=o[r[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[$0[h]>>>l]=c}else for(a=new Rr(i),n=0;n<i;++n)r[n]&&(a[n]=$0[o[r[n]-1]++]>>>15-r[n]);return a},gc=new Yn(288);for(var ui=0;ui<144;++ui)gc[ui]=8;for(var ui=144;ui<256;++ui)gc[ui]=9;for(var ui=256;ui<280;++ui)gc[ui]=7;for(var ui=280;ui<288;++ui)gc[ui]=8;var i3=new Yn(32);for(var ui=0;ui<32;++ui)i3[ui]=5;var wS=Fl(gc,9,1),BS=Fl(i3,5,1),Bf=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},rs=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},Rf=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},RS=function(r){return(r/8|0)+(r&7&&1)},DS=function(r,e,t){(t==null||t>r.length)&&(t=r.length);var i=new(r instanceof Rr?Rr:r instanceof K0?K0:Yn)(t-e);return i.set(r.subarray(e,t)),i},MS=function(r,e,t){var i=r.length;if(!i||t&&!t.l&&i<5)return e||new Yn(0);var n=!e||t,s=!t||t.i;t||(t={}),e||(e=new Yn(i*3));var o=function(Q){var O=e.length;if(Q>O){var U=new Yn(Math.max(O*2,Q));U.set(e),e=U}},a=t.f||0,l=t.p||0,c=t.b||0,u=t.l,h=t.d,f=t.m,d=t.n,m=i*8;do{if(!u){t.f=a=rs(r,l,1);var A=rs(r,l+1,3);if(l+=3,A)if(A==1)u=wS,h=BS,f=9,d=5;else if(A==2){var E=rs(r,l,31)+257,C=rs(r,l+10,15)+4,I=E+rs(r,l+5,31)+1;l+=14;for(var _=new Yn(I),x=new Yn(19),S=0;S<C;++S)x[xS[S]]=rs(r,l+S*3,7);l+=C*3;for(var b=Bf(x),T=(1<<b)-1,B=Fl(x,b,1),S=0;S<I;){var w=B[rs(r,l,T)];l+=w&15;var p=w>>>4;if(p<16)_[S++]=p;else{var R=0,D=0;for(p==16?(D=3+rs(r,l,3),l+=2,R=_[S-1]):p==17?(D=3+rs(r,l,7),l+=3):p==18&&(D=11+rs(r,l,127),l+=7);D--;)_[S++]=R}}var G=_.subarray(0,E),z=_.subarray(E);f=Bf(G),d=Bf(z),u=Fl(G,f,1),h=Fl(z,d,1)}else throw"invalid block type";else{var p=RS(l)+4,g=r[p-4]|r[p-3]<<8,v=p+g;if(v>i){if(s)throw"unexpected EOF";break}n&&o(c+g),e.set(r.subarray(p,v),c),t.b=c+=g,t.p=l=v*8;continue}if(l>m){if(s)throw"unexpected EOF";break}}n&&o(c+131072);for(var W=(1<<f)-1,q=(1<<d)-1,F=l;;F=l){var R=u[Rf(r,l)&W],N=R>>>4;if(l+=R&15,l>m){if(s)throw"unexpected EOF";break}if(!R)throw"invalid length/literal";if(N<256)e[c++]=N;else if(N==256){F=l,u=null;break}else{var L=N-254;if(N>264){var S=N-257,$=XE[S];L=rs(r,l,(1<<$)-1)+t3[S],l+=$}var j=h[Rf(r,l)&q],V=j>>>4;if(!j)throw"invalid distance";l+=j&15;var z=bS[V];if(V>3){var $=JE[V];z+=Rf(r,l)&(1<<$)-1,l+=$}if(l>m){if(s)throw"unexpected EOF";break}n&&o(c+131072);for(var k=c+L;c<k;c+=4)e[c]=e[c-z],e[c+1]=e[c+1-z],e[c+2]=e[c+2-z],e[c+3]=e[c+3-z];c=k}}t.l=u,t.p=F,t.b=c,u&&(a=1,t.m=f,t.d=h,t.n=d)}while(!a);return c==e.length?e:DS(e,0,c)},LS=new Yn(0),PS=function(r){if((r[0]&15)!=8||r[0]>>>4>7||(r[0]<<8|r[1])%31)throw"invalid zlib data";if(r[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function Sl(r,e){return MS((PS(r),r.subarray(2,-4)),e)}var FS=typeof TextDecoder<"u"&&new TextDecoder,kS=0;try{FS.decode(LS,{stream:!0}),kS=1}catch{}let OS=class extends je{constructor(e,t,i=!1,n=!1,s=1e4){const o=new Gi;super(o,t),this.isMarchingCubes=!0;const a=this,l=new Float32Array(12*3),c=new Float32Array(12*3),u=new Float32Array(12*3);this.enableUvs=i,this.enableColors=n,this.init=function(v){this.resolution=v,this.isolation=80,this.size=v,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(this.size3*3),this.palette=new Float32Array(this.size3*3),this.count=0;const E=s*3;this.positionArray=new Float32Array(E*3);const C=new Jt(this.positionArray,3);C.setUsage(nn),o.setAttribute("position",C),this.normalArray=new Float32Array(E*3);const I=new Jt(this.normalArray,3);if(I.setUsage(nn),o.setAttribute("normal",I),this.enableUvs){this.uvArray=new Float32Array(E*2);const _=new Jt(this.uvArray,2);_.setUsage(nn),o.setAttribute("uv",_)}if(this.enableColors){this.colorArray=new Float32Array(E*3);const _=new Jt(this.colorArray,3);_.setUsage(nn),o.setAttribute("color",_)}o.boundingSphere=new un(new K,1)};function h(v,E,C){return v+(E-v)*C}function f(v,E,C,I,_,x,S,b,T,B){const w=(C-S)/(b-S),R=a.normal_cache;l[E+0]=I+w*a.delta,l[E+1]=_,l[E+2]=x,c[E+0]=h(R[v+0],R[v+3],w),c[E+1]=h(R[v+1],R[v+4],w),c[E+2]=h(R[v+2],R[v+5],w),u[E+0]=h(a.palette[T*3+0],a.palette[B*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[B*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[B*3+2],w)}function d(v,E,C,I,_,x,S,b,T,B){const w=(C-S)/(b-S),R=a.normal_cache;l[E+0]=I,l[E+1]=_+w*a.delta,l[E+2]=x;const D=v+a.yd*3;c[E+0]=h(R[v+0],R[D+0],w),c[E+1]=h(R[v+1],R[D+1],w),c[E+2]=h(R[v+2],R[D+2],w),u[E+0]=h(a.palette[T*3+0],a.palette[B*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[B*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[B*3+2],w)}function m(v,E,C,I,_,x,S,b,T,B){const w=(C-S)/(b-S),R=a.normal_cache;l[E+0]=I,l[E+1]=_,l[E+2]=x+w*a.delta;const D=v+a.zd*3;c[E+0]=h(R[v+0],R[D+0],w),c[E+1]=h(R[v+1],R[D+1],w),c[E+2]=h(R[v+2],R[D+2],w),u[E+0]=h(a.palette[T*3+0],a.palette[B*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[B*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[B*3+2],w)}function A(v){const E=v*3;a.normal_cache[E]===0&&(a.normal_cache[E+0]=a.field[v-1]-a.field[v+1],a.normal_cache[E+1]=a.field[v-a.yd]-a.field[v+a.yd],a.normal_cache[E+2]=a.field[v-a.zd]-a.field[v+a.zd])}function p(v,E,C,I,_){const x=I+1,S=I+a.yd,b=I+a.zd,T=x+a.yd,B=x+a.zd,w=I+a.yd+a.zd,R=x+a.yd+a.zd;let D=0;const G=a.field[I],z=a.field[x],W=a.field[S],q=a.field[T],F=a.field[b],N=a.field[B],L=a.field[w],$=a.field[R];G<_&&(D|=1),z<_&&(D|=2),W<_&&(D|=8),q<_&&(D|=4),F<_&&(D|=16),N<_&&(D|=32),L<_&&(D|=128),$<_&&(D|=64);const j=US[D];if(j===0)return 0;const V=a.delta,k=v+V,Q=E+V,O=C+V;j&1&&(A(I),A(x),f(I*3,0,_,v,E,C,G,z,I,x)),j&2&&(A(x),A(T),d(x*3,3,_,k,E,C,z,q,x,T)),j&4&&(A(S),A(T),f(S*3,6,_,v,Q,C,W,q,S,T)),j&8&&(A(I),A(S),d(I*3,9,_,v,E,C,G,W,I,S)),j&16&&(A(b),A(B),f(b*3,12,_,v,E,O,F,N,b,B)),j&32&&(A(B),A(R),d(B*3,15,_,k,E,O,N,$,B,R)),j&64&&(A(w),A(R),f(w*3,18,_,v,Q,O,L,$,w,R)),j&128&&(A(b),A(w),d(b*3,21,_,v,E,O,F,L,b,w)),j&256&&(A(I),A(b),m(I*3,24,_,v,E,C,G,F,I,b)),j&512&&(A(x),A(B),m(x*3,27,_,k,E,C,z,N,x,B)),j&1024&&(A(T),A(R),m(T*3,30,_,k,Q,C,q,$,T,R)),j&2048&&(A(S),A(w),m(S*3,33,_,v,Q,C,W,L,S,w)),D<<=4;let U,te,le,ee=0,se=0;for(;Lc[D+se]!=-1;)U=D+se,te=U+1,le=U+2,g(l,c,u,3*Lc[U],3*Lc[te],3*Lc[le]),se+=3,ee++;return ee}function g(v,E,C,I,_,x){const S=a.count*3;if(a.positionArray[S+0]=v[I],a.positionArray[S+1]=v[I+1],a.positionArray[S+2]=v[I+2],a.positionArray[S+3]=v[_],a.positionArray[S+4]=v[_+1],a.positionArray[S+5]=v[_+2],a.positionArray[S+6]=v[x],a.positionArray[S+7]=v[x+1],a.positionArray[S+8]=v[x+2],a.material.flatShading===!0){const b=(E[I+0]+E[_+0]+E[x+0])/3,T=(E[I+1]+E[_+1]+E[x+1])/3,B=(E[I+2]+E[_+2]+E[x+2])/3;a.normalArray[S+0]=b,a.normalArray[S+1]=T,a.normalArray[S+2]=B,a.normalArray[S+3]=b,a.normalArray[S+4]=T,a.normalArray[S+5]=B,a.normalArray[S+6]=b,a.normalArray[S+7]=T,a.normalArray[S+8]=B}else a.normalArray[S+0]=E[I+0],a.normalArray[S+1]=E[I+1],a.normalArray[S+2]=E[I+2],a.normalArray[S+3]=E[_+0],a.normalArray[S+4]=E[_+1],a.normalArray[S+5]=E[_+2],a.normalArray[S+6]=E[x+0],a.normalArray[S+7]=E[x+1],a.normalArray[S+8]=E[x+2];if(a.enableUvs){const b=a.count*2;a.uvArray[b+0]=v[I+0],a.uvArray[b+1]=v[I+2],a.uvArray[b+2]=v[_+0],a.uvArray[b+3]=v[_+2],a.uvArray[b+4]=v[x+0],a.uvArray[b+5]=v[x+2]}a.enableColors&&(a.colorArray[S+0]=C[I+0],a.colorArray[S+1]=C[I+1],a.colorArray[S+2]=C[I+2],a.colorArray[S+3]=C[_+0],a.colorArray[S+4]=C[_+1],a.colorArray[S+5]=C[_+2],a.colorArray[S+6]=C[x+0],a.colorArray[S+7]=C[x+1],a.colorArray[S+8]=C[x+2]),a.count+=3}this.addBall=function(v,E,C,I,_,x){const S=Math.sign(I);I=Math.abs(I);const b=x!=null;let T=new et(v,E,C);if(b)try{T=x instanceof et?x:Array.isArray(x)?new et(Math.min(Math.abs(x[0]),1),Math.min(Math.abs(x[1]),1),Math.min(Math.abs(x[2]),1)):new et(x)}catch{T=new et(v,E,C)}const B=this.size*Math.sqrt(I/_),w=C*this.size,R=E*this.size,D=v*this.size;let G=Math.floor(w-B);G<1&&(G=1);let z=Math.floor(w+B);z>this.size-1&&(z=this.size-1);let W=Math.floor(R-B);W<1&&(W=1);let q=Math.floor(R+B);q>this.size-1&&(q=this.size-1);let F=Math.floor(D-B);F<1&&(F=1);let N=Math.floor(D+B);N>this.size-1&&(N=this.size-1);let L,$,j,V,k,Q,O,U,te,le,ee;for(j=G;j<z;j++)for(k=this.size2*j,U=j/this.size-C,te=U*U,$=W;$<q;$++)for(V=k+this.size*$,O=$/this.size-E,le=O*O,L=F;L<N;L++)if(Q=L/this.size-v,ee=I/(1e-6+Q*Q+le+te)-_,ee>0){this.field[V+L]+=ee*S;const se=Math.sqrt((L-D)*(L-D)+($-R)*($-R)+(j-w)*(j-w))/B,Ee=1-se*se*se*(se*(se*6-15)+10);this.palette[(V+L)*3+0]+=T.r*Ee,this.palette[(V+L)*3+1]+=T.g*Ee,this.palette[(V+L)*3+2]+=T.b*Ee}},this.addPlaneX=function(v,E){const C=this.size,I=this.yd,_=this.zd,x=this.field;let S,b,T,B,w,R,D,G=C*Math.sqrt(v/E);for(G>C&&(G=C),S=0;S<G;S++)if(R=S/C,B=R*R,w=v/(1e-4+B)-E,w>0)for(b=0;b<C;b++)for(D=S+b*I,T=0;T<C;T++)x[_*T+D]+=w},this.addPlaneY=function(v,E){const C=this.size,I=this.yd,_=this.zd,x=this.field;let S,b,T,B,w,R,D,G,z=C*Math.sqrt(v/E);for(z>C&&(z=C),b=0;b<z;b++)if(R=b/C,B=R*R,w=v/(1e-4+B)-E,w>0)for(D=b*I,S=0;S<C;S++)for(G=D+S,T=0;T<C;T++)x[_*T+G]+=w},this.addPlaneZ=function(v,E){const C=this.size,I=this.yd,_=this.zd,x=this.field;let S,b,T,B,w,R,D,G,z=C*Math.sqrt(v/E);for(z>C&&(z=C),T=0;T<z;T++)if(R=T/C,B=R*R,w=v/(1e-4+B)-E,w>0)for(D=_*T,b=0;b<C;b++)for(G=D+b*I,S=0;S<C;S++)x[G+S]+=w},this.setCell=function(v,E,C,I){const _=this.size2*C+this.size*E+v;this.field[_]=I},this.getCell=function(v,E,C){const I=this.size2*C+this.size*E+v;return this.field[I]},this.blur=function(v=1){const E=this.field,C=E.slice(),I=this.size,_=this.size2;for(let x=0;x<I;x++)for(let S=0;S<I;S++)for(let b=0;b<I;b++){const T=_*b+I*S+x;let B=C[T],w=1;for(let R=-1;R<=1;R+=2){const D=R+x;if(!(D<0||D>=I))for(let G=-1;G<=1;G+=2){const z=G+S;if(!(z<0||z>=I))for(let W=-1;W<=1;W+=2){const q=W+b;if(q<0||q>=I)continue;const F=_*q+I*z+D,N=C[F];w++,B+=v*(N-B)/w}}}E[T]=B}},this.reset=function(){for(let v=0;v<this.size3;v++)this.normal_cache[v*3]=0,this.field[v]=0,this.palette[v*3]=this.palette[v*3+1]=this.palette[v*3+2]=0},this.update=function(){this.count=0;const v=this.size-2;for(let E=1;E<v;E++){const C=this.size2*E,I=(E-this.halfsize)/this.halfsize;for(let _=1;_<v;_++){const x=C+this.size*_,S=(_-this.halfsize)/this.halfsize;for(let b=1;b<v;b++){const T=(b-this.halfsize)/this.halfsize,B=x+b;p(T,S,I,B,this.isolation)}}}this.geometry.setDrawRange(0,this.count),o.getAttribute("position").needsUpdate=!0,o.getAttribute("normal").needsUpdate=!0,this.enableUvs&&(o.getAttribute("uv").needsUpdate=!0),this.enableColors&&(o.getAttribute("color").needsUpdate=!0),this.count/3>s&&console.warn("THREE.MarchingCubes: Geometry buffers too small for rendering. Please create an instance with a higher poly count.")},this.init(e)}};const US=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),Lc=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]);var NS=Object.defineProperty,GS=(r,e,t)=>e in r?NS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,os=(r,e,t)=>(GS(r,typeof e!="symbol"?e+"":e,t),t);class Df{constructor(e=Math){os(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),os(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),os(this,"p",[]),os(this,"perm",[]),os(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),os(this,"dot",(t,i,n)=>t[0]*i+t[1]*n),os(this,"dot3",(t,i,n,s)=>t[0]*i+t[1]*n+t[2]*s),os(this,"dot4",(t,i,n,s,o)=>t[0]*i+t[1]*n+t[2]*s+t[3]*o),os(this,"noise",(t,i)=>{let n,s,o;const a=.5*(Math.sqrt(3)-1),l=(t+i)*a,c=Math.floor(t+l),u=Math.floor(i+l),h=(3-Math.sqrt(3))/6,f=(c+u)*h,d=c-f,m=u-f,A=t-d,p=i-m;let g=0,v=1;A>p&&(g=1,v=0);const E=A-g+h,C=p-v+h,I=A-1+2*h,_=p-1+2*h,x=c&255,S=u&255,b=this.perm[x+this.perm[S]]%12,T=this.perm[x+g+this.perm[S+v]]%12,B=this.perm[x+1+this.perm[S+1]]%12;let w=.5-A*A-p*p;w<0?n=0:(w*=w,n=w*w*this.dot(this.grad3[b],A,p));let R=.5-E*E-C*C;R<0?s=0:(R*=R,s=R*R*this.dot(this.grad3[T],E,C));let D=.5-I*I-_*_;return D<0?o=0:(D*=D,o=D*D*this.dot(this.grad3[B],I,_)),70*(n+s+o)}),os(this,"noise3d",(t,i,n)=>{let s,o,a,l;const u=(t+i+n)*.3333333333333333,h=Math.floor(t+u),f=Math.floor(i+u),d=Math.floor(n+u),m=1/6,A=(h+f+d)*m,p=h-A,g=f-A,v=d-A,E=t-p,C=i-g,I=n-v;let _,x,S,b,T,B;E>=C?C>=I?(_=1,x=0,S=0,b=1,T=1,B=0):E>=I?(_=1,x=0,S=0,b=1,T=0,B=1):(_=0,x=0,S=1,b=1,T=0,B=1):C<I?(_=0,x=0,S=1,b=0,T=1,B=1):E<I?(_=0,x=1,S=0,b=0,T=1,B=1):(_=0,x=1,S=0,b=1,T=1,B=0);const w=E-_+m,R=C-x+m,D=I-S+m,G=E-b+2*m,z=C-T+2*m,W=I-B+2*m,q=E-1+3*m,F=C-1+3*m,N=I-1+3*m,L=h&255,$=f&255,j=d&255,V=this.perm[L+this.perm[$+this.perm[j]]]%12,k=this.perm[L+_+this.perm[$+x+this.perm[j+S]]]%12,Q=this.perm[L+b+this.perm[$+T+this.perm[j+B]]]%12,O=this.perm[L+1+this.perm[$+1+this.perm[j+1]]]%12;let U=.6-E*E-C*C-I*I;U<0?s=0:(U*=U,s=U*U*this.dot3(this.grad3[V],E,C,I));let te=.6-w*w-R*R-D*D;te<0?o=0:(te*=te,o=te*te*this.dot3(this.grad3[k],w,R,D));let le=.6-G*G-z*z-W*W;le<0?a=0:(le*=le,a=le*le*this.dot3(this.grad3[Q],G,z,W));let ee=.6-q*q-F*F-N*N;return ee<0?l=0:(ee*=ee,l=ee*ee*this.dot3(this.grad3[O],q,F,N)),32*(s+o+a+l)}),os(this,"noise4d",(t,i,n,s)=>{const o=this.grad4,a=this.simplex,l=this.perm,c=(Math.sqrt(5)-1)/4,u=(5-Math.sqrt(5))/20;let h,f,d,m,A;const p=(t+i+n+s)*c,g=Math.floor(t+p),v=Math.floor(i+p),E=Math.floor(n+p),C=Math.floor(s+p),I=(g+v+E+C)*u,_=g-I,x=v-I,S=E-I,b=C-I,T=t-_,B=i-x,w=n-S,R=s-b,D=T>B?32:0,G=T>w?16:0,z=B>w?8:0,W=T>R?4:0,q=B>R?2:0,F=w>R?1:0,N=D+G+z+W+q+F;let L,$,j,V,k,Q,O,U,te,le,ee,se;L=a[N][0]>=3?1:0,$=a[N][1]>=3?1:0,j=a[N][2]>=3?1:0,V=a[N][3]>=3?1:0,k=a[N][0]>=2?1:0,Q=a[N][1]>=2?1:0,O=a[N][2]>=2?1:0,U=a[N][3]>=2?1:0,te=a[N][0]>=1?1:0,le=a[N][1]>=1?1:0,ee=a[N][2]>=1?1:0,se=a[N][3]>=1?1:0;const Ee=T-L+u,Ie=B-$+u,oe=w-j+u,ce=R-V+u,Ae=T-k+2*u,he=B-Q+2*u,Z=w-O+2*u,J=R-U+2*u,ue=T-te+3*u,Te=B-le+3*u,we=w-ee+3*u,Le=R-se+3*u,Be=T-1+4*u,qe=B-1+4*u,Oe=w-1+4*u,Ke=R-1+4*u,$e=g&255,Ze=v&255,ut=E&255,Ct=C&255,lt=l[$e+l[Ze+l[ut+l[Ct]]]]%32,tt=l[$e+L+l[Ze+$+l[ut+j+l[Ct+V]]]]%32,Je=l[$e+k+l[Ze+Q+l[ut+O+l[Ct+U]]]]%32,re=l[$e+te+l[Ze+le+l[ut+ee+l[Ct+se]]]]%32,Re=l[$e+1+l[Ze+1+l[ut+1+l[Ct+1]]]]%32;let Ue=.6-T*T-B*B-w*w-R*R;Ue<0?h=0:(Ue*=Ue,h=Ue*Ue*this.dot4(o[lt],T,B,w,R));let Xe=.6-Ee*Ee-Ie*Ie-oe*oe-ce*ce;Xe<0?f=0:(Xe*=Xe,f=Xe*Xe*this.dot4(o[tt],Ee,Ie,oe,ce));let ve=.6-Ae*Ae-he*he-Z*Z-J*J;ve<0?d=0:(ve*=ve,d=ve*ve*this.dot4(o[Je],Ae,he,Z,J));let ft=.6-ue*ue-Te*Te-we*we-Le*Le;ft<0?m=0:(ft*=ft,m=ft*ft*this.dot4(o[re],ue,Te,we,Le));let ii=.6-Be*Be-qe*qe-Oe*Oe-Ke*Ke;return ii<0?A=0:(ii*=ii,A=ii*ii*this.dot4(o[Re],Be,qe,Oe,Ke)),27*(h+f+d+m+A)});for(let t=0;t<256;t++)this.p[t]=Math.floor(e.random()*256);for(let t=0;t<512;t++)this.perm[t]=this.p[t&255]}}const QS=r=>r&&r.isCubeTexture;class zS extends je{constructor(e,t){var i,n;const s=QS(e),a=((n=s?(i=e.image[0])==null?void 0:i.width:e.image.width)!=null?n:1024)/4,l=Math.floor(Math.log2(a)),c=Math.pow(2,l),u=3*Math.max(c,16*7),h=4*c,f=[s?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/u}`,`#define CUBEUV_TEXEL_HEIGHT ${1/h}`,`#define CUBEUV_MAX_MIP ${l}.0`],d=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,m=f.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${cc>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,A={map:{value:e},height:{value:t?.height||15},radius:{value:t?.radius||100}},p=new FI(1,16),g=new bi({uniforms:A,fragmentShader:m,vertexShader:d,side:wi});super(p,g)}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}function n3(r,e,t={}){const i=new K,n=new ht,s=new K,o=new Me,a=new Me,l=new Me;t.preserveMatrix=t.preserveMatrix!==void 0?t.preserveMatrix:!0,t.preservePosition=t.preservePosition!==void 0?t.preservePosition:!0,t.preserveHipPosition=t.preserveHipPosition!==void 0?t.preserveHipPosition:!1,t.useTargetMatrix=t.useTargetMatrix!==void 0?t.useTargetMatrix:!1,t.hip=t.hip!==void 0?t.hip:"hip",t.names=t.names||{};const c=e.isObject3D?e.skeleton.bones:fh(e),u=r.isObject3D?r.skeleton.bones:fh(r);let h,f,d,m,A;if(r.isObject3D?r.skeleton.pose():(t.useTargetMatrix=!0,t.preserveMatrix=!1),t.preservePosition){A=[];for(let p=0;p<u.length;p++)A.push(u[p].position.clone())}if(t.preserveMatrix){r.updateMatrixWorld(),r.matrixWorld.identity();for(let p=0;p<r.children.length;++p)r.children[p].updateMatrixWorld(!0)}if(t.offsets){h=[];for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,t.offsets[d]&&(f.matrix.multiply(t.offsets[d]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),h.push(f.matrixWorld.clone())}for(let p=0;p<u.length;++p){if(f=u[p],d=t.names[f.name]||f.name,m=s3(d,c),l.copy(f.matrixWorld),m){if(m.updateMatrixWorld(),t.useTargetMatrix?a.copy(m.matrixWorld):(a.copy(r.matrixWorld).invert(),a.multiply(m.matrixWorld)),s.setFromMatrixScale(a),a.scale(s.set(1/s.x,1/s.y,1/s.z)),l.makeRotationFromQuaternion(n.setFromRotationMatrix(a)),r.isObject3D){const g=u.indexOf(f),v=h?h[g]:o.copy(r.skeleton.boneInverses[g]).invert();l.multiply(v)}l.copyPosition(a)}f.parent&&f.parent.isBone?(f.matrix.copy(f.parent.matrixWorld).invert(),f.matrix.multiply(l)):f.matrix.copy(l),t.preserveHipPosition&&d===t.hip&&f.matrix.setPosition(i.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(t.preservePosition)for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,d!==t.hip&&f.position.copy(A[p]);t.preserveMatrix&&r.updateMatrixWorld(!0)}function HS(r,e,t,i={}){i.useFirstFramePosition=i.useFirstFramePosition!==void 0?i.useFirstFramePosition:!1,i.fps=i.fps!==void 0?i.fps:30,i.names=i.names||[],e.isObject3D||(e=KS(e));const n=Math.round(t.duration*(i.fps/1e3)*1e3),s=1/i.fps,o=[],a=new R2(e),l=fh(r.skeleton),c=[];let u,h,f,d,m;a.clipAction(t).play(),a.update(0),e.updateMatrixWorld();for(let A=0;A<n;++A){const p=A*s;n3(r,e,i);for(let g=0;g<l.length;++g)m=i.names[l[g].name]||l[g].name,f=s3(m,e.skeleton),f&&(h=l[g],d=c[g]=c[g]||{bone:h},i.hip===m&&(d.pos||(d.pos={times:new Float32Array(n),values:new Float32Array(n*3)}),i.useFirstFramePosition&&(A===0&&(u=h.position.clone()),h.position.sub(u)),d.pos.times[A]=p,h.position.toArray(d.pos.values,A*3)),d.quat||(d.quat={times:new Float32Array(n),values:new Float32Array(n*4)}),d.quat.times[A]=p,h.quaternion.toArray(d.quat.values,A*4));a.update(s),e.updateMatrixWorld()}for(let A=0;A<c.length;++A)d=c[A],d&&(d.pos&&o.push(new eh(".bones["+d.bone.name+"].position",d.pos.times,d.pos.values)),o.push(new th(".bones["+d.bone.name+"].quaternion",d.quat.times,d.quat.values)));return a.uncacheAction(t),new Pm(t.name,-1,o)}function VS(r){const e=new Map,t=new Map,i=r.clone();return r3(r,i,function(n,s){e.set(s,n),t.set(n,s)}),i.traverse(function(n){if(!n.isSkinnedMesh)return;const s=n,o=e.get(n),a=o.skeleton.bones;s.skeleton=o.skeleton.clone(),s.bindMatrix.copy(o.bindMatrix),s.skeleton.bones=a.map(function(l){return t.get(l)}),s.bind(s.skeleton,s.bindMatrix)}),i}function s3(r,e){for(let t=0,i=fh(e);t<i.length;t++)if(r===i[t].name)return i[t]}function fh(r){return Array.isArray(r)?r:r.bones}function KS(r){const e=new kI(r.bones[0]);return e.skeleton=r,e}function r3(r,e,t){t(r,e);for(let i=0;i<r.children.length;i++)r3(r.children[i],e.children[i],t)}const $S={retarget:n3,retargetClip:HS,clone:VS},Wi=new qo,Pc=new K;class jS{constructor(e){let t=e.geometry;t.index&&(console.warn("THREE.MeshSurfaceSampler: Converting geometry to non-indexed BufferGeometry."),t=t.toNonIndexed()),this.geometry=t,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.colorAttribute=this.geometry.getAttribute("color"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(e){return this.weightAttribute=e?this.geometry.getAttribute(e):null,this}build(){const e=this.positionAttribute,t=this.weightAttribute,i=new Float32Array(e.count/3);for(let s=0;s<e.count;s+=3){let o=1;t&&(o=t.getX(s)+t.getX(s+1)+t.getX(s+2)),Wi.a.fromBufferAttribute(e,s),Wi.b.fromBufferAttribute(e,s+1),Wi.c.fromBufferAttribute(e,s+2),o*=Wi.getArea(),i[s/3]=o}this.distribution=new Float32Array(e.count/3);let n=0;for(let s=0;s<i.length;s++)n+=i[s],this.distribution[s]=n;return this}setRandomGenerator(e){return this.randomFunction=e,this}sample(e,t,i){const n=this.sampleFaceIndex();return this.sampleFace(n,e,t,i)}sampleFaceIndex(){const e=this.distribution[this.distribution.length-1];return this.binarySearch(this.randomFunction()*e)}binarySearch(e){const t=this.distribution;let i=0,n=t.length-1,s=-1;for(;i<=n;){const o=Math.ceil((i+n)/2);if(o===0||t[o-1]<=e&&t[o]>e){s=o;break}else e<t[o]?n=o-1:i=o+1}return s}sampleFace(e,t,i,n){let s=this.randomFunction(),o=this.randomFunction();return s+o>1&&(s=1-s,o=1-o),Wi.a.fromBufferAttribute(this.positionAttribute,e*3),Wi.b.fromBufferAttribute(this.positionAttribute,e*3+1),Wi.c.fromBufferAttribute(this.positionAttribute,e*3+2),t.set(0,0,0).addScaledVector(Wi.a,s).addScaledVector(Wi.b,o).addScaledVector(Wi.c,1-(s+o)),i!==void 0&&Wi.getNormal(i),n!==void 0&&this.colorAttribute!==void 0&&(Wi.a.fromBufferAttribute(this.colorAttribute,e*3),Wi.b.fromBufferAttribute(this.colorAttribute,e*3+1),Wi.c.fromBufferAttribute(this.colorAttribute,e*3+2),Pc.set(0,0,0).addScaledVector(Wi.a,s).addScaledVector(Wi.b,o).addScaledVector(Wi.c,1-(s+o)),n.r=Pc.x,n.g=Pc.y,n.b=Pc.z),this}}var YS=Object.defineProperty,WS=(r,e,t)=>e in r?YS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,yt=(r,e,t)=>(WS(r,typeof e!="symbol"?e+"":e,t),t);const Pg=new K;let qS=class extends Ca{constructor(e,t){super(),yt(this,"object"),yt(this,"domElement"),yt(this,"enabled",!0),yt(this,"movementSpeed",1),yt(this,"lookSpeed",.005),yt(this,"lookVertical",!0),yt(this,"autoForward",!1),yt(this,"activeLook",!0),yt(this,"heightSpeed",!1),yt(this,"heightCoef",1),yt(this,"heightMin",0),yt(this,"heightMax",1),yt(this,"constrainVertical",!1),yt(this,"verticalMin",0),yt(this,"verticalMax",Math.PI),yt(this,"mouseDragOn",!1),yt(this,"autoSpeedFactor",0),yt(this,"mouseX",0),yt(this,"mouseY",0),yt(this,"moveForward",!1),yt(this,"moveBackward",!1),yt(this,"moveLeft",!1),yt(this,"moveRight",!1),yt(this,"moveUp",!1),yt(this,"moveDown",!1),yt(this,"viewHalfX",0),yt(this,"viewHalfY",0),yt(this,"lat",0),yt(this,"lon",0),yt(this,"lookDirection",new K),yt(this,"spherical",new fa),yt(this,"target",new K),yt(this,"connect",i=>{i.setAttribute("tabindex","-1"),i.style.touchAction="none",i.addEventListener("contextmenu",this.contextmenu),i.addEventListener("mousemove",this.onMouseMove),i.addEventListener("mousedown",this.onMouseDown),i.addEventListener("mouseup",this.onMouseUp),this.domElement=i,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()}),yt(this,"dispose",()=>{var i,n,s,o;(i=this.domElement)==null||i.removeEventListener("contextmenu",this.contextmenu),(n=this.domElement)==null||n.removeEventListener("mousedown",this.onMouseDown),(s=this.domElement)==null||s.removeEventListener("mousemove",this.onMouseMove),(o=this.domElement)==null||o.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}),yt(this,"handleResize",()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}),yt(this,"onMouseDown",i=>{var n;if((n=this.domElement)==null||n.focus(),this.activeLook)switch(i.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0;break}this.mouseDragOn=!0}),yt(this,"onMouseUp",i=>{if(this.activeLook)switch(i.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1;break}this.mouseDragOn=!1}),yt(this,"onMouseMove",i=>{this.domElement&&(this.mouseX=i.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=i.pageY-this.domElement.offsetTop-this.viewHalfY)}),yt(this,"onKeyDown",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0;break}}),yt(this,"onKeyUp",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1;break}}),yt(this,"lookAt",(i,n,s)=>(i instanceof K?this.target.copy(i):n&&s&&this.target.set(i,n,s),this.object.lookAt(this.target),this.setOrientation(),this)),yt(this,"update",i=>{if(!this.enabled)return;if(this.heightSpeed){const h=ot.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=i*(h*this.heightCoef)}else this.autoSpeedFactor=0;const n=i*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(n+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(n),this.moveLeft&&this.object.translateX(-n),this.moveRight&&this.object.translateX(n),this.moveUp&&this.object.translateY(n),this.moveDown&&this.object.translateY(-n);let s=i*this.lookSpeed;this.activeLook||(s=0);let o=1;this.constrainVertical&&(o=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*s,this.lookVertical&&(this.lat-=this.mouseY*s*o),this.lat=Math.max(-85,Math.min(85,this.lat));let a=ot.degToRad(90-this.lat);const l=ot.degToRad(this.lon);this.constrainVertical&&(a=ot.mapLinear(a,0,Math.PI,this.verticalMin,this.verticalMax));const c=this.object.position;Pg.setFromSphericalCoords(1,a,l).add(c),this.object.lookAt(Pg)}),yt(this,"contextmenu",i=>i.preventDefault()),yt(this,"setOrientation",()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-ot.radToDeg(this.spherical.phi),this.lon=ot.radToDeg(this.spherical.theta)}),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}};var XS=Object.defineProperty,JS=(r,e,t)=>e in r?XS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,be=(r,e,t)=>(JS(r,typeof e!="symbol"?e+"":e,t),t);let ZS=class extends Ei{constructor(e,t){super(),be(this,"isTransformControls",!0),be(this,"visible",!1),be(this,"domElement"),be(this,"raycaster",new Th),be(this,"gizmo"),be(this,"plane"),be(this,"tempVector",new K),be(this,"tempVector2",new K),be(this,"tempQuaternion",new ht),be(this,"unit",{X:new K(1,0,0),Y:new K(0,1,0),Z:new K(0,0,1)}),be(this,"pointStart",new K),be(this,"pointEnd",new K),be(this,"offset",new K),be(this,"rotationAxis",new K),be(this,"startNorm",new K),be(this,"endNorm",new K),be(this,"rotationAngle",0),be(this,"cameraPosition",new K),be(this,"cameraQuaternion",new ht),be(this,"cameraScale",new K),be(this,"parentPosition",new K),be(this,"parentQuaternion",new ht),be(this,"parentQuaternionInv",new ht),be(this,"parentScale",new K),be(this,"worldPositionStart",new K),be(this,"worldQuaternionStart",new ht),be(this,"worldScaleStart",new K),be(this,"worldPosition",new K),be(this,"worldQuaternion",new ht),be(this,"worldQuaternionInv",new ht),be(this,"worldScale",new K),be(this,"eye",new K),be(this,"positionStart",new K),be(this,"quaternionStart",new ht),be(this,"scaleStart",new K),be(this,"camera"),be(this,"object"),be(this,"enabled",!0),be(this,"axis",null),be(this,"mode","translate"),be(this,"translationSnap",null),be(this,"rotationSnap",null),be(this,"scaleSnap",null),be(this,"space","world"),be(this,"size",1),be(this,"dragging",!1),be(this,"showX",!0),be(this,"showY",!0),be(this,"showZ",!0),be(this,"changeEvent",{type:"change"}),be(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),be(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),be(this,"objectChangeEvent",{type:"objectChange"}),be(this,"intersectObjectWithRay",(n,s,o)=>{const a=s.intersectObject(n,!0);for(let l=0;l<a.length;l++)if(a[l].object.visible||o)return a[l];return!1}),be(this,"attach",n=>(this.object=n,this.visible=!0,this)),be(this,"detach",()=>(this.object=void 0,this.visible=!1,this.axis=null,this)),be(this,"reset",()=>this.enabled?(this.dragging&&this.object!==void 0&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this),be(this,"updateMatrixWorld",()=>{this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()}),be(this,"pointerHover",n=>{if(this.object===void 0||this.dragging===!0)return;this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);s?this.axis=s.object.name:this.axis=null}),be(this,"pointerDown",n=>{if(!(this.object===void 0||this.dragging===!0||n.button!==0)&&this.axis!==null){this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(s){let o=this.space;if(this.mode==="scale"?o="local":(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ")&&(o="world"),o==="local"&&this.mode==="rotate"){const a=this.rotationSnap;this.axis==="X"&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),this.axis==="Y"&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),this.axis==="Z"&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(s.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}}),be(this,"pointerMove",n=>{const s=this.axis,o=this.mode,a=this.object;let l=this.space;if(o==="scale"?l="local":(s==="E"||s==="XYZE"||s==="XYZ")&&(l="world"),a===void 0||s===null||this.dragging===!1||n.button!==-1)return;this.raycaster.setFromCamera(n,this.camera);const c=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(c){if(this.pointEnd.copy(c.point).sub(this.worldPositionStart),o==="translate")this.offset.copy(this.pointEnd).sub(this.pointStart),l==="local"&&s!=="XYZ"&&this.offset.applyQuaternion(this.worldQuaternionInv),s.indexOf("X")===-1&&(this.offset.x=0),s.indexOf("Y")===-1&&(this.offset.y=0),s.indexOf("Z")===-1&&(this.offset.z=0),l==="local"&&s!=="XYZ"?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),a.position.copy(this.offset).add(this.positionStart),this.translationSnap&&(l==="local"&&(a.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this.quaternionStart)),l==="world"&&(a.parent&&a.position.add(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld)),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld))));else if(o==="scale"){if(s.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),this.tempVector2.set(u,u,u)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),s.search("X")===-1&&(this.tempVector2.x=1),s.search("Y")===-1&&(this.tempVector2.y=1),s.search("Z")===-1&&(this.tempVector2.z=1);a.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(s.search("X")!==-1&&(this.object.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(o==="rotate"){this.offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));s==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):s==="XYZE"?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*u):(s==="X"||s==="Y"||s==="Z")&&(this.rotationAxis.copy(this.unit[s]),this.tempVector.copy(this.unit[s]),l==="local"&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*u),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),l==="local"&&s!=="E"&&s!=="XYZE"?(a.quaternion.copy(this.quaternionStart),a.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),a.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}}),be(this,"pointerUp",n=>{n.button===0&&(this.dragging&&this.axis!==null&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)}),be(this,"getPointer",n=>{var s;if(this.domElement&&((s=this.domElement.ownerDocument)!=null&&s.pointerLockElement))return{x:0,y:0,button:n.button};{const o=n.changedTouches?n.changedTouches[0]:n,a=this.domElement.getBoundingClientRect();return{x:(o.clientX-a.left)/a.width*2-1,y:-(o.clientY-a.top)/a.height*2+1,button:n.button}}}),be(this,"onPointerHover",n=>{if(this.enabled)switch(n.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(n));break}}),be(this,"onPointerDown",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(n)),this.pointerDown(this.getPointer(n)))}),be(this,"onPointerMove",n=>{this.enabled&&this.pointerMove(this.getPointer(n))}),be(this,"onPointerUp",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(n)))}),be(this,"getMode",()=>this.mode),be(this,"setMode",n=>{this.mode=n}),be(this,"setTranslationSnap",n=>{this.translationSnap=n}),be(this,"setRotationSnap",n=>{this.rotationSnap=n}),be(this,"setScaleSnap",n=>{this.scaleSnap=n}),be(this,"setSize",n=>{this.size=n}),be(this,"setSpace",n=>{this.space=n}),be(this,"update",()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}),be(this,"connect",n=>{n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)}),be(this,"dispose",()=>{var n,s,o,a,l,c;(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointermove",this.onPointerHover),(a=(o=this.domElement)==null?void 0:o.ownerDocument)==null||a.removeEventListener("pointermove",this.onPointerMove),(c=(l=this.domElement)==null?void 0:l.ownerDocument)==null||c.removeEventListener("pointerup",this.onPointerUp),this.traverse(u=>{const h=u;h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()})}),this.domElement=t,this.camera=e,this.gizmo=new eT,this.add(this.gizmo),this.plane=new tT,this.add(this.plane);const i=(n,s)=>{let o=s;Object.defineProperty(this,n,{get:function(){return o!==void 0?o:s},set:function(a){o!==a&&(o=a,this.plane[n]=a,this.gizmo[n]=a,this.dispatchEvent({type:n+"-changed",value:a}),this.dispatchEvent(this.changeEvent))}}),this[n]=s,this.plane[n]=s,this.gizmo[n]=s};i("camera",this.camera),i("object",this.object),i("enabled",this.enabled),i("axis",this.axis),i("mode",this.mode),i("translationSnap",this.translationSnap),i("rotationSnap",this.rotationSnap),i("scaleSnap",this.scaleSnap),i("space",this.space),i("size",this.size),i("dragging",this.dragging),i("showX",this.showX),i("showY",this.showY),i("showZ",this.showZ),i("worldPosition",this.worldPosition),i("worldPositionStart",this.worldPositionStart),i("worldQuaternion",this.worldQuaternion),i("worldQuaternionStart",this.worldQuaternionStart),i("cameraPosition",this.cameraPosition),i("cameraQuaternion",this.cameraQuaternion),i("pointStart",this.pointStart),i("pointEnd",this.pointEnd),i("rotationAxis",this.rotationAxis),i("rotationAngle",this.rotationAngle),i("eye",this.eye),t!==void 0&&this.connect(t)}};class eT extends Ei{constructor(){super(),be(this,"isTransformControlsGizmo",!0),be(this,"type","TransformControlsGizmo"),be(this,"tempVector",new K(0,0,0)),be(this,"tempEuler",new Wn),be(this,"alignVector",new K(0,1,0)),be(this,"zeroVector",new K(0,0,0)),be(this,"lookAtMatrix",new Me),be(this,"tempQuaternion",new ht),be(this,"tempQuaternion2",new ht),be(this,"identityQuaternion",new ht),be(this,"unitX",new K(1,0,0)),be(this,"unitY",new K(0,1,0)),be(this,"unitZ",new K(0,0,1)),be(this,"gizmo"),be(this,"picker"),be(this,"helper"),be(this,"rotationAxis",new K),be(this,"cameraPosition",new K),be(this,"worldPositionStart",new K),be(this,"worldQuaternionStart",new ht),be(this,"worldPosition",new K),be(this,"worldQuaternion",new ht),be(this,"eye",new K),be(this,"camera",null),be(this,"enabled",!0),be(this,"axis",null),be(this,"mode","translate"),be(this,"space","world"),be(this,"size",1),be(this,"dragging",!1),be(this,"showX",!0),be(this,"showY",!0),be(this,"showZ",!0),be(this,"updateMatrixWorld",()=>{let N=this.space;this.mode==="scale"&&(N="local");const L=N==="local"?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let $=[];$=$.concat(this.picker[this.mode].children),$=$.concat(this.gizmo[this.mode].children),$=$.concat(this.helper[this.mode].children);for(let j=0;j<$.length;j++){const V=$[j];V.visible=!0,V.rotation.set(0,0,0),V.position.copy(this.worldPosition);let k;if(this.camera.isOrthographicCamera?k=(this.camera.top-this.camera.bottom)/this.camera.zoom:k=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),V.scale.set(1,1,1).multiplyScalar(k*this.size/7),V.tag==="helper"){V.visible=!1,V.name==="AXIS"?(V.position.copy(this.worldPositionStart),V.visible=!!this.axis,this.axis==="X"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),V.quaternion.copy(L).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(L).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="Y"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),V.quaternion.copy(L).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(L).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="Z"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),V.quaternion.copy(L).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(L).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="XYZE"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),V.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),V.quaternion.multiply(this.tempQuaternion),V.visible=this.dragging),this.axis==="E"&&(V.visible=!1)):V.name==="START"?(V.position.copy(this.worldPositionStart),V.visible=this.dragging):V.name==="END"?(V.position.copy(this.worldPosition),V.visible=this.dragging):V.name==="DELTA"?(V.position.copy(this.worldPositionStart),V.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),V.scale.copy(this.tempVector),V.visible=this.dragging):(V.quaternion.copy(L),this.dragging?V.position.copy(this.worldPositionStart):V.position.copy(this.worldPosition),this.axis&&(V.visible=this.axis.search(V.name)!==-1));continue}V.quaternion.copy(L),this.mode==="translate"||this.mode==="scale"?((V.name==="X"||V.name==="XYZX")&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(L).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),(V.name==="Y"||V.name==="XYZY")&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(L).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),(V.name==="Z"||V.name==="XYZZ")&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(L).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="XY"&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(L).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="YZ"&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(L).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="XZ"&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(L).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name.search("X")!==-1&&(this.alignVector.copy(this.unitX).applyQuaternion(L).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.x*=-1:V.tag==="bwd"&&(V.visible=!1)),V.name.search("Y")!==-1&&(this.alignVector.copy(this.unitY).applyQuaternion(L).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.y*=-1:V.tag==="bwd"&&(V.visible=!1)),V.name.search("Z")!==-1&&(this.alignVector.copy(this.unitZ).applyQuaternion(L).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.z*=-1:V.tag==="bwd"&&(V.visible=!1))):this.mode==="rotate"&&(this.tempQuaternion2.copy(L),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(L).invert()),V.name.search("E")!==-1&&V.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),V.name==="X"&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion)),V.name==="Y"&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion)),V.name==="Z"&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion))),V.visible=V.visible&&(V.name.indexOf("X")===-1||this.showX),V.visible=V.visible&&(V.name.indexOf("Y")===-1||this.showY),V.visible=V.visible&&(V.name.indexOf("Z")===-1||this.showZ),V.visible=V.visible&&(V.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),V.material.tempOpacity=V.material.tempOpacity||V.material.opacity,V.material.tempColor=V.material.tempColor||V.material.color.clone(),V.material.color.copy(V.material.tempColor),V.material.opacity=V.material.tempOpacity,this.enabled?this.axis&&(V.name===this.axis?(V.material.opacity=1,V.material.color.lerp(new et(1,1,1),.5)):this.axis.split("").some(function(Q){return V.name===Q})?(V.material.opacity=1,V.material.color.lerp(new et(1,1,1),.5)):(V.material.opacity*=.25,V.material.color.lerp(new et(1,1,1),.5))):(V.material.opacity*=.5,V.material.color.lerp(new et(1,1,1),.5))}super.updateMatrixWorld()});const e=new ms({depthTest:!1,depthWrite:!1,transparent:!0,side:wi,fog:!1,toneMapped:!1}),t=new ia({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;const n=e.clone();n.opacity=.33;const s=e.clone();s.color.set(16711680);const o=e.clone();o.color.set(65280);const a=e.clone();a.color.set(255);const l=e.clone();l.opacity=.25;const c=l.clone();c.color.set(16776960);const u=l.clone();u.color.set(65535);const h=l.clone();h.color.set(16711935),e.clone().color.set(16776960);const d=t.clone();d.color.set(16711680);const m=t.clone();m.color.set(65280);const A=t.clone();A.color.set(255);const p=t.clone();p.color.set(65535);const g=t.clone();g.color.set(16711935);const v=t.clone();v.color.set(16776960);const E=t.clone();E.color.set(7895160);const C=v.clone();C.opacity=.25;const I=new Qn(0,.05,.2,12,1,!1),_=new Gr(.125,.125,.125),x=new Gi;x.setAttribute("position",new ji([0,0,0,1,0,0],3));const S=(N,L)=>{const $=new Gi,j=[];for(let V=0;V<=64*L;++V)j.push(0,Math.cos(V/32*Math.PI)*N,Math.sin(V/32*Math.PI)*N);return $.setAttribute("position",new ji(j,3)),$},b=()=>{const N=new Gi;return N.setAttribute("position",new ji([0,0,0,1,1,1],3)),N},T={X:[[new je(I,s),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new je(I,s),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Mt(x,d)]],Y:[[new je(I,o),[0,1,0],null,null,"fwd"],[new je(I,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Mt(x,m),null,[0,0,Math.PI/2]]],Z:[[new je(I,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new je(I,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Mt(x,A),null,[0,-Math.PI/2,0]]],XYZ:[[new je(new Qr(.1,0),l.clone()),[0,0,0],[0,0,0]]],XY:[[new je(new an(.295,.295),c.clone()),[.15,.15,0]],[new Mt(x,v),[.18,.3,0],null,[.125,1,1]],[new Mt(x,v),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new je(new an(.295,.295),u.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new Mt(x,p),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Mt(x,p),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new je(new an(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new Mt(x,g),[.18,0,.3],null,[.125,1,1]],[new Mt(x,g),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},B={X:[[new je(new Qn(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new je(new Qn(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new je(new Qn(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new je(new Qr(.2,0),i)]],XY:[[new je(new an(.4,.4),i),[.2,.2,0]]],YZ:[[new je(new an(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new je(new an(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},w={START:[[new je(new Qr(.01,2),n),null,null,null,"helper"]],END:[[new je(new Qr(.01,2),n),null,null,null,"helper"]],DELTA:[[new Mt(b(),n),null,null,null,"helper"]],X:[[new Mt(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Mt(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Mt(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},R={X:[[new Mt(S(1,.5),d)],[new je(new Qr(.04,0),s),[0,0,.99],null,[1,3,1]]],Y:[[new Mt(S(1,.5),m),null,[0,0,-Math.PI/2]],[new je(new Qr(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new Mt(S(1,.5),A),null,[0,Math.PI/2,0]],[new je(new Qr(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new Mt(S(1.25,1),C),null,[0,Math.PI/2,0]],[new je(new Qn(.03,0,.15,4,1,!1),C),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new je(new Qn(.03,0,.15,4,1,!1),C),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new je(new Qn(.03,0,.15,4,1,!1),C),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new je(new Qn(.03,0,.15,4,1,!1),C),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Mt(S(1,1),E),null,[0,Math.PI/2,0]]]},D={AXIS:[[new Mt(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},G={X:[[new je(new Tc(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new je(new Tc(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new je(new Tc(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new je(new Tc(1.25,.1,2,24),i)]],XYZE:[[new je(new D2(.7,10,8),i)]]},z={X:[[new je(_,s),[.8,0,0],[0,0,-Math.PI/2]],[new Mt(x,d),null,null,[.8,1,1]]],Y:[[new je(_,o),[0,.8,0]],[new Mt(x,m),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new je(_,a),[0,0,.8],[Math.PI/2,0,0]],[new Mt(x,A),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new je(_,c),[.85,.85,0],null,[2,2,.2]],[new Mt(x,v),[.855,.98,0],null,[.125,1,1]],[new Mt(x,v),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new je(_,u),[0,.85,.85],null,[.2,2,2]],[new Mt(x,p),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Mt(x,p),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new je(_,h),[.85,0,.85],null,[2,.2,2]],[new Mt(x,g),[.855,0,.98],null,[.125,1,1]],[new Mt(x,g),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new je(new Gr(.125,.125,.125),l.clone()),[1.1,0,0]]],XYZY:[[new je(new Gr(.125,.125,.125),l.clone()),[0,1.1,0]]],XYZZ:[[new je(new Gr(.125,.125,.125),l.clone()),[0,0,1.1]]]},W={X:[[new je(new Qn(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new je(new Qn(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new je(new Qn(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new je(_,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new je(_,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new je(_,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new je(new Gr(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new je(new Gr(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new je(new Gr(.2,.2,.2),i),[0,0,1.1]]]},q={X:[[new Mt(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Mt(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Mt(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},F=N=>{const L=new Ei;for(let $ in N)for(let j=N[$].length;j--;){const V=N[$][j][0].clone(),k=N[$][j][1],Q=N[$][j][2],O=N[$][j][3],U=N[$][j][4];V.name=$,V.tag=U,k&&V.position.set(k[0],k[1],k[2]),Q&&V.rotation.set(Q[0],Q[1],Q[2]),O&&V.scale.set(O[0],O[1],O[2]),V.updateMatrix();const te=V.geometry.clone();te.applyMatrix4(V.matrix),V.geometry=te,V.renderOrder=1/0,V.position.set(0,0,0),V.rotation.set(0,0,0),V.scale.set(1,1,1),L.add(V)}return L};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=F(T)),this.add(this.gizmo.rotate=F(R)),this.add(this.gizmo.scale=F(z)),this.add(this.picker.translate=F(B)),this.add(this.picker.rotate=F(G)),this.add(this.picker.scale=F(W)),this.add(this.helper.translate=F(w)),this.add(this.helper.rotate=F(D)),this.add(this.helper.scale=F(q)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class tT extends je{constructor(){super(new an(1e5,1e5,2,2),new ms({visible:!1,wireframe:!0,side:wi,transparent:!0,opacity:.1,toneMapped:!1})),be(this,"isTransformControlsPlane",!0),be(this,"type","TransformControlsPlane"),be(this,"unitX",new K(1,0,0)),be(this,"unitY",new K(0,1,0)),be(this,"unitZ",new K(0,0,1)),be(this,"tempVector",new K),be(this,"dirVector",new K),be(this,"alignVector",new K),be(this,"tempMatrix",new Me),be(this,"identityQuaternion",new ht),be(this,"cameraQuaternion",new ht),be(this,"worldPosition",new K),be(this,"worldQuaternion",new ht),be(this,"eye",new K),be(this,"axis",null),be(this,"mode","translate"),be(this,"space","world"),be(this,"updateMatrixWorld",()=>{let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),this.unitX.set(1,0,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0);break}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()})}}var iT=Object.defineProperty,nT=(r,e,t)=>e in r?iT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Oi=(r,e,t)=>(nT(r,typeof e!="symbol"?e+"":e,t),t);let sT=class extends Ca{constructor(e){super(),Oi(this,"object"),Oi(this,"changeEvent",{type:"change"}),Oi(this,"EPS",1e-6),Oi(this,"enabled",!0),Oi(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),Oi(this,"screenOrientation",0),Oi(this,"alphaOffset",0),Oi(this,"onDeviceOrientationChangeEvent",t=>{this.deviceOrientation=t}),Oi(this,"onScreenOrientationChangeEvent",()=>{this.screenOrientation=window.orientation||0}),Oi(this,"zee",new K(0,0,1)),Oi(this,"euler",new Wn),Oi(this,"q0",new ht),Oi(this,"q1",new ht(-Math.sqrt(.5),0,0,Math.sqrt(.5))),Oi(this,"setObjectQuaternion",(t,i,n,s,o)=>{this.euler.set(n,i,-s,"YXZ"),t.setFromEuler(this.euler),t.multiply(this.q1),t.multiply(this.q0.setFromAxisAngle(this.zee,-o))}),Oi(this,"connect",()=>{this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(t=>{t=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(t=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0}),Oi(this,"disconnect",()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1}),Oi(this,"lastQuaternion",new ht),Oi(this,"update",()=>{if(this.enabled===!1)return;const t=this.deviceOrientation;if(t){const i=t.alpha?ot.degToRad(t.alpha)+this.alphaOffset:0,n=t.beta?ot.degToRad(t.beta):0,s=t.gamma?ot.degToRad(t.gamma):0,o=this.screenOrientation?ot.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,i,n,s,o),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}}),Oi(this,"dispose",()=>this.disconnect()),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}};var rT=Object.defineProperty,oT=(r,e,t)=>e in r?rT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,He=(r,e,t)=>(oT(r,typeof e!="symbol"?e+"":e,t),t);let aT=class extends Ca{constructor(e,t){super(),He(this,"enabled",!0),He(this,"screen",{left:0,top:0,width:0,height:0}),He(this,"rotateSpeed",1),He(this,"zoomSpeed",1.2),He(this,"panSpeed",.3),He(this,"noRotate",!1),He(this,"noZoom",!1),He(this,"noPan",!1),He(this,"staticMoving",!1),He(this,"dynamicDampingFactor",.2),He(this,"minDistance",0),He(this,"maxDistance",1/0),He(this,"keys",["KeyA","KeyS","KeyD"]),He(this,"mouseButtons",{LEFT:fs.ROTATE,MIDDLE:fs.DOLLY,RIGHT:fs.PAN}),He(this,"object"),He(this,"domElement"),He(this,"cursorZoom",!1),He(this,"target",new K),He(this,"mousePosition",new Fe),He(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),He(this,"EPS",1e-6),He(this,"lastZoom",1),He(this,"lastPosition",new K),He(this,"cursorVector",new K),He(this,"targetVector",new K),He(this,"_state",this.STATE.NONE),He(this,"_keyState",this.STATE.NONE),He(this,"_eye",new K),He(this,"_movePrev",new Fe),He(this,"_moveCurr",new Fe),He(this,"_lastAxis",new K),He(this,"_lastAngle",0),He(this,"_zoomStart",new Fe),He(this,"_zoomEnd",new Fe),He(this,"_touchZoomDistanceStart",0),He(this,"_touchZoomDistanceEnd",0),He(this,"_panStart",new Fe),He(this,"_panEnd",new Fe),He(this,"target0"),He(this,"position0"),He(this,"up0"),He(this,"zoom0"),He(this,"changeEvent",{type:"change"}),He(this,"startEvent",{type:"start"}),He(this,"endEvent",{type:"end"}),He(this,"onScreenVector",new Fe),He(this,"getMouseOnScreen",(i,n)=>(this.onScreenVector.set((i-this.screen.left)/this.screen.width,(n-this.screen.top)/this.screen.height),this.onScreenVector)),He(this,"onCircleVector",new Fe),He(this,"getMouseOnCircle",(i,n)=>(this.onCircleVector.set((i-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-n))/this.screen.width),this.onCircleVector)),He(this,"axis",new K),He(this,"quaternion",new ht),He(this,"eyeDirection",new K),He(this,"objectUpDirection",new K),He(this,"objectSidewaysDirection",new K),He(this,"moveDirection",new K),He(this,"angle",0),He(this,"rotateCamera",()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)}),He(this,"zoomCamera",()=>{let i;if(this._state===this.STATE.TOUCH_ZOOM_PAN)i=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(i):this.object.isOrthographicCamera?(this.object.zoom/=i,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(i=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(i-1)>this.EPS&&i>0&&(this.object.isPerspectiveCamera?(i>1&&this._eye.length()>=this.maxDistance-this.EPS&&(i=1),this._eye.multiplyScalar(i)):this.object.isOrthographicCamera?(i>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(i=1),this.object.zoom/=i):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let n=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(n,this.target,i)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}}),He(this,"mouseChange",new Fe),He(this,"objectUp",new K),He(this,"pan",new K),He(this,"panCamera",()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const i=this.object,n=(i.right-i.left)/this.object.zoom,s=(i.top-i.bottom)/this.object.zoom;this.mouseChange.x*=n,this.mouseChange.y*=s}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}),He(this,"checkDistances",()=>{(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}),He(this,"handleResize",()=>{if(!this.domElement)return;const i=this.domElement.getBoundingClientRect(),n=this.domElement.ownerDocument.documentElement;this.screen.left=i.left+window.pageXOffset-n.clientLeft,this.screen.top=i.top+window.pageYOffset-n.clientTop,this.screen.width=i.width,this.screen.height=i.height}),He(this,"update",()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")}),He(this,"reset",()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom}),He(this,"keydown",i=>{this.enabled!==!1&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(i.code===this.keys[this.STATE.ROTATE]&&!this.noRotate?this._keyState=this.STATE.ROTATE:i.code===this.keys[this.STATE.ZOOM]&&!this.noZoom?this._keyState=this.STATE.ZOOM:i.code===this.keys[this.STATE.PAN]&&!this.noPan&&(this._keyState=this.STATE.PAN)))}),He(this,"onPointerDown",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseDown(i);break}}),He(this,"onPointerMove",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseMove(i);break}}),He(this,"onPointerUp",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseUp();break}}),He(this,"keyup",()=>{this.enabled!==!1&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))}),He(this,"onMouseDown",i=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(i.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN;break}const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY)),this._movePrev.copy(this._moveCurr)):n===this.STATE.ZOOM&&!this.noZoom?(this._zoomStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._zoomEnd.copy(this._zoomStart)):n===this.STATE.PAN&&!this.noPan&&(this._panStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._panEnd.copy(this._panStart)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)}),He(this,"onMouseMove",i=>{if(this.enabled===!1)return;const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY))):n===this.STATE.ZOOM&&!this.noZoom?this._zoomEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY)):n===this.STATE.PAN&&!this.noPan&&this._panEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY))}),He(this,"onMouseUp",()=>{this.domElement&&this.enabled!==!1&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))}),He(this,"mousewheel",i=>{if(this.enabled!==!1&&this.noZoom!==!0){switch(i.preventDefault(),i.deltaMode){case 2:this._zoomStart.y-=i.deltaY*.025;break;case 1:this._zoomStart.y-=i.deltaY*.01;break;default:this._zoomStart.y-=i.deltaY*25e-5;break}this.mousePosition.x=i.offsetX/this.screen.width*2-1,this.mousePosition.y=-(i.offsetY/this.screen.height)*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}}),He(this,"touchstart",i=>{if(this.enabled!==!1){switch(i.preventDefault(),i.touches.length){case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=this.STATE.TOUCH_ZOOM_PAN;const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(o,a)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(this.startEvent)}}),He(this,"touchmove",i=>{if(this.enabled!==!1)switch(i.preventDefault(),i.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY));break;default:const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(o,a));break}}),He(this,"touchend",i=>{if(this.enabled!==!1){switch(i.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break}this.dispatchEvent(this.endEvent)}}),He(this,"contextmenu",i=>{this.enabled!==!1&&i.preventDefault()}),He(this,"connect",i=>{i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=i,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()}),He(this,"dispose",()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))}),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,t!==void 0&&this.connect(t),this.update()}};var lT=Object.defineProperty,cT=(r,e,t)=>e in r?lT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,dt=(r,e,t)=>(cT(r,typeof e!="symbol"?e+"":e,t),t);const Fc=new Ia,Fg=new Hs,uT=Math.cos(70*(Math.PI/180)),kg=(r,e)=>(r%e+e)%e;let o3=class extends Ca{constructor(e,t){super(),dt(this,"object"),dt(this,"domElement"),dt(this,"enabled",!0),dt(this,"target",new K),dt(this,"minDistance",0),dt(this,"maxDistance",1/0),dt(this,"minZoom",0),dt(this,"maxZoom",1/0),dt(this,"minPolarAngle",0),dt(this,"maxPolarAngle",Math.PI),dt(this,"minAzimuthAngle",-1/0),dt(this,"maxAzimuthAngle",1/0),dt(this,"enableDamping",!1),dt(this,"dampingFactor",.05),dt(this,"enableZoom",!0),dt(this,"zoomSpeed",1),dt(this,"enableRotate",!0),dt(this,"rotateSpeed",1),dt(this,"enablePan",!0),dt(this,"panSpeed",1),dt(this,"screenSpacePanning",!0),dt(this,"keyPanSpeed",7),dt(this,"zoomToCursor",!1),dt(this,"autoRotate",!1),dt(this,"autoRotateSpeed",2),dt(this,"reverseOrbit",!1),dt(this,"reverseHorizontalOrbit",!1),dt(this,"reverseVerticalOrbit",!1),dt(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),dt(this,"mouseButtons",{LEFT:fs.ROTATE,MIDDLE:fs.DOLLY,RIGHT:fs.PAN}),dt(this,"touches",{ONE:xr.ROTATE,TWO:xr.DOLLY_PAN}),dt(this,"target0"),dt(this,"position0"),dt(this,"zoom0"),dt(this,"_domElementKeyEvents",null),dt(this,"getPolarAngle"),dt(this,"getAzimuthalAngle"),dt(this,"setPolarAngle"),dt(this,"setAzimuthalAngle"),dt(this,"getDistance"),dt(this,"getZoomScale"),dt(this,"listenToKeyEvents"),dt(this,"stopListenToKeyEvents"),dt(this,"saveState"),dt(this,"reset"),dt(this,"update"),dt(this,"connect"),dt(this,"dispose"),dt(this,"dollyIn"),dt(this,"dollyOut"),dt(this,"getScale"),dt(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>u.phi,this.getAzimuthalAngle=()=>u.theta,this.setPolarAngle=re=>{let Re=kg(re,2*Math.PI),Ue=u.phi;Ue<0&&(Ue+=2*Math.PI),Re<0&&(Re+=2*Math.PI);let Xe=Math.abs(Re-Ue);2*Math.PI-Xe<Xe&&(Re<Ue?Re+=2*Math.PI:Ue+=2*Math.PI),h.phi=Re-Ue,i.update()},this.setAzimuthalAngle=re=>{let Re=kg(re,2*Math.PI),Ue=u.theta;Ue<0&&(Ue+=2*Math.PI),Re<0&&(Re+=2*Math.PI);let Xe=Math.abs(Re-Ue);2*Math.PI-Xe<Xe&&(Re<Ue?Re+=2*Math.PI:Ue+=2*Math.PI),h.theta=Re-Ue,i.update()},this.getDistance=()=>i.object.position.distanceTo(i.target),this.listenToKeyEvents=re=>{re.addEventListener("keydown",Ke),this._domElementKeyEvents=re},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Ke),this._domElementKeyEvents=null},this.saveState=()=>{i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=()=>{i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(n),i.update(),l=a.NONE},this.update=(()=>{const re=new K,Re=new K(0,1,0),Ue=new ht().setFromUnitVectors(e.up,Re),Xe=Ue.clone().invert(),ve=new K,ft=new ht,ii=2*Math.PI;return function(){const It=i.object.position;Ue.setFromUnitVectors(e.up,Re),Xe.copy(Ue).invert(),re.copy(It).sub(i.target),re.applyQuaternion(Ue),u.setFromVector3(re),i.autoRotate&&l===a.NONE&&D(w()),i.enableDamping?(u.theta+=h.theta*i.dampingFactor,u.phi+=h.phi*i.dampingFactor):(u.theta+=h.theta,u.phi+=h.phi);let Pt=i.minAzimuthAngle,ie=i.maxAzimuthAngle;isFinite(Pt)&&isFinite(ie)&&(Pt<-Math.PI?Pt+=ii:Pt>Math.PI&&(Pt-=ii),ie<-Math.PI?ie+=ii:ie>Math.PI&&(ie-=ii),Pt<=ie?u.theta=Math.max(Pt,Math.min(ie,u.theta)):u.theta=u.theta>(Pt+ie)/2?Math.max(Pt,u.theta):Math.min(ie,u.theta)),u.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,u.phi)),u.makeSafe(),i.enableDamping===!0?i.target.addScaledVector(d,i.dampingFactor):i.target.add(d),i.zoomToCursor&&b||i.object.isOrthographicCamera?u.radius=j(u.radius):u.radius=j(u.radius*f),re.setFromSpherical(u),re.applyQuaternion(Xe),It.copy(i.target).add(re),i.object.matrixAutoUpdate||i.object.updateMatrix(),i.object.lookAt(i.target),i.enableDamping===!0?(h.theta*=1-i.dampingFactor,h.phi*=1-i.dampingFactor,d.multiplyScalar(1-i.dampingFactor)):(h.set(0,0,0),d.set(0,0,0));let P=!1;if(i.zoomToCursor&&b){let Y=null;if(i.object instanceof ri&&i.object.isPerspectiveCamera){const ae=re.length();Y=j(ae*f);const ke=ae-Y;i.object.position.addScaledVector(x,ke),i.object.updateMatrixWorld()}else if(i.object.isOrthographicCamera){const ae=new K(S.x,S.y,0);ae.unproject(i.object),i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix(),P=!0;const ke=new K(S.x,S.y,0);ke.unproject(i.object),i.object.position.sub(ke).add(ae),i.object.updateMatrixWorld(),Y=re.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),i.zoomToCursor=!1;Y!==null&&(i.screenSpacePanning?i.target.set(0,0,-1).transformDirection(i.object.matrix).multiplyScalar(Y).add(i.object.position):(Fc.origin.copy(i.object.position),Fc.direction.set(0,0,-1).transformDirection(i.object.matrix),Math.abs(i.object.up.dot(Fc.direction))<uT?e.lookAt(i.target):(Fg.setFromNormalAndCoplanarPoint(i.object.up,i.target),Fc.intersectPlane(Fg,i.target))))}else i.object instanceof vi&&i.object.isOrthographicCamera&&(P=f!==1,P&&(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix()));return f=1,b=!1,P||ve.distanceToSquared(i.object.position)>c||8*(1-ft.dot(i.object.quaternion))>c?(i.dispatchEvent(n),ve.copy(i.object.position),ft.copy(i.object.quaternion),P=!1,!0):!1}})(),this.connect=re=>{i.domElement=re,i.domElement.style.touchAction="none",i.domElement.addEventListener("contextmenu",ut),i.domElement.addEventListener("pointerdown",Te),i.domElement.addEventListener("pointercancel",Le),i.domElement.addEventListener("wheel",Oe)},this.dispose=()=>{var re,Re,Ue,Xe,ve,ft;i.domElement&&(i.domElement.style.touchAction="auto"),(re=i.domElement)==null||re.removeEventListener("contextmenu",ut),(Re=i.domElement)==null||Re.removeEventListener("pointerdown",Te),(Ue=i.domElement)==null||Ue.removeEventListener("pointercancel",Le),(Xe=i.domElement)==null||Xe.removeEventListener("wheel",Oe),(ve=i.domElement)==null||ve.ownerDocument.removeEventListener("pointermove",we),(ft=i.domElement)==null||ft.ownerDocument.removeEventListener("pointerup",Le),i._domElementKeyEvents!==null&&i._domElementKeyEvents.removeEventListener("keydown",Ke)};const i=this,n={type:"change"},s={type:"start"},o={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=a.NONE;const c=1e-6,u=new fa,h=new fa;let f=1;const d=new K,m=new Fe,A=new Fe,p=new Fe,g=new Fe,v=new Fe,E=new Fe,C=new Fe,I=new Fe,_=new Fe,x=new K,S=new Fe;let b=!1;const T=[],B={};function w(){return 2*Math.PI/60/60*i.autoRotateSpeed}function R(){return Math.pow(.95,i.zoomSpeed)}function D(re){i.reverseOrbit||i.reverseHorizontalOrbit?h.theta+=re:h.theta-=re}function G(re){i.reverseOrbit||i.reverseVerticalOrbit?h.phi+=re:h.phi-=re}const z=(()=>{const re=new K;return function(Ue,Xe){re.setFromMatrixColumn(Xe,0),re.multiplyScalar(-Ue),d.add(re)}})(),W=(()=>{const re=new K;return function(Ue,Xe){i.screenSpacePanning===!0?re.setFromMatrixColumn(Xe,1):(re.setFromMatrixColumn(Xe,0),re.crossVectors(i.object.up,re)),re.multiplyScalar(Ue),d.add(re)}})(),q=(()=>{const re=new K;return function(Ue,Xe){const ve=i.domElement;if(ve&&i.object instanceof ri&&i.object.isPerspectiveCamera){const ft=i.object.position;re.copy(ft).sub(i.target);let ii=re.length();ii*=Math.tan(i.object.fov/2*Math.PI/180),z(2*Ue*ii/ve.clientHeight,i.object.matrix),W(2*Xe*ii/ve.clientHeight,i.object.matrix)}else ve&&i.object instanceof vi&&i.object.isOrthographicCamera?(z(Ue*(i.object.right-i.object.left)/i.object.zoom/ve.clientWidth,i.object.matrix),W(Xe*(i.object.top-i.object.bottom)/i.object.zoom/ve.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}})();function F(re){i.object instanceof ri&&i.object.isPerspectiveCamera||i.object instanceof vi&&i.object.isOrthographicCamera?f=re:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function N(re){F(f/re)}function L(re){F(f*re)}function $(re){if(!i.zoomToCursor||!i.domElement)return;b=!0;const Re=i.domElement.getBoundingClientRect(),Ue=re.clientX-Re.left,Xe=re.clientY-Re.top,ve=Re.width,ft=Re.height;S.x=Ue/ve*2-1,S.y=-(Xe/ft)*2+1,x.set(S.x,S.y,1).unproject(i.object).sub(i.object.position).normalize()}function j(re){return Math.max(i.minDistance,Math.min(i.maxDistance,re))}function V(re){m.set(re.clientX,re.clientY)}function k(re){$(re),C.set(re.clientX,re.clientY)}function Q(re){g.set(re.clientX,re.clientY)}function O(re){A.set(re.clientX,re.clientY),p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const Re=i.domElement;Re&&(D(2*Math.PI*p.x/Re.clientHeight),G(2*Math.PI*p.y/Re.clientHeight)),m.copy(A),i.update()}function U(re){I.set(re.clientX,re.clientY),_.subVectors(I,C),_.y>0?N(R()):_.y<0&&L(R()),C.copy(I),i.update()}function te(re){v.set(re.clientX,re.clientY),E.subVectors(v,g).multiplyScalar(i.panSpeed),q(E.x,E.y),g.copy(v),i.update()}function le(re){$(re),re.deltaY<0?L(R()):re.deltaY>0&&N(R()),i.update()}function ee(re){let Re=!1;switch(re.code){case i.keys.UP:q(0,i.keyPanSpeed),Re=!0;break;case i.keys.BOTTOM:q(0,-i.keyPanSpeed),Re=!0;break;case i.keys.LEFT:q(i.keyPanSpeed,0),Re=!0;break;case i.keys.RIGHT:q(-i.keyPanSpeed,0),Re=!0;break}Re&&(re.preventDefault(),i.update())}function se(){if(T.length==1)m.set(T[0].pageX,T[0].pageY);else{const re=.5*(T[0].pageX+T[1].pageX),Re=.5*(T[0].pageY+T[1].pageY);m.set(re,Re)}}function Ee(){if(T.length==1)g.set(T[0].pageX,T[0].pageY);else{const re=.5*(T[0].pageX+T[1].pageX),Re=.5*(T[0].pageY+T[1].pageY);g.set(re,Re)}}function Ie(){const re=T[0].pageX-T[1].pageX,Re=T[0].pageY-T[1].pageY,Ue=Math.sqrt(re*re+Re*Re);C.set(0,Ue)}function oe(){i.enableZoom&&Ie(),i.enablePan&&Ee()}function ce(){i.enableZoom&&Ie(),i.enableRotate&&se()}function Ae(re){if(T.length==1)A.set(re.pageX,re.pageY);else{const Ue=Je(re),Xe=.5*(re.pageX+Ue.x),ve=.5*(re.pageY+Ue.y);A.set(Xe,ve)}p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const Re=i.domElement;Re&&(D(2*Math.PI*p.x/Re.clientHeight),G(2*Math.PI*p.y/Re.clientHeight)),m.copy(A)}function he(re){if(T.length==1)v.set(re.pageX,re.pageY);else{const Re=Je(re),Ue=.5*(re.pageX+Re.x),Xe=.5*(re.pageY+Re.y);v.set(Ue,Xe)}E.subVectors(v,g).multiplyScalar(i.panSpeed),q(E.x,E.y),g.copy(v)}function Z(re){const Re=Je(re),Ue=re.pageX-Re.x,Xe=re.pageY-Re.y,ve=Math.sqrt(Ue*Ue+Xe*Xe);I.set(0,ve),_.set(0,Math.pow(I.y/C.y,i.zoomSpeed)),N(_.y),C.copy(I)}function J(re){i.enableZoom&&Z(re),i.enablePan&&he(re)}function ue(re){i.enableZoom&&Z(re),i.enableRotate&&Ae(re)}function Te(re){var Re,Ue;i.enabled!==!1&&(T.length===0&&((Re=i.domElement)==null||Re.ownerDocument.addEventListener("pointermove",we),(Ue=i.domElement)==null||Ue.ownerDocument.addEventListener("pointerup",Le)),Ct(re),re.pointerType==="touch"?$e(re):Be(re))}function we(re){i.enabled!==!1&&(re.pointerType==="touch"?Ze(re):qe(re))}function Le(re){var Re,Ue,Xe;lt(re),T.length===0&&((Re=i.domElement)==null||Re.releasePointerCapture(re.pointerId),(Ue=i.domElement)==null||Ue.ownerDocument.removeEventListener("pointermove",we),(Xe=i.domElement)==null||Xe.ownerDocument.removeEventListener("pointerup",Le)),i.dispatchEvent(o),l=a.NONE}function Be(re){let Re;switch(re.button){case 0:Re=i.mouseButtons.LEFT;break;case 1:Re=i.mouseButtons.MIDDLE;break;case 2:Re=i.mouseButtons.RIGHT;break;default:Re=-1}switch(Re){case fs.DOLLY:if(i.enableZoom===!1)return;k(re),l=a.DOLLY;break;case fs.ROTATE:if(re.ctrlKey||re.metaKey||re.shiftKey){if(i.enablePan===!1)return;Q(re),l=a.PAN}else{if(i.enableRotate===!1)return;V(re),l=a.ROTATE}break;case fs.PAN:if(re.ctrlKey||re.metaKey||re.shiftKey){if(i.enableRotate===!1)return;V(re),l=a.ROTATE}else{if(i.enablePan===!1)return;Q(re),l=a.PAN}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function qe(re){if(i.enabled!==!1)switch(l){case a.ROTATE:if(i.enableRotate===!1)return;O(re);break;case a.DOLLY:if(i.enableZoom===!1)return;U(re);break;case a.PAN:if(i.enablePan===!1)return;te(re);break}}function Oe(re){i.enabled===!1||i.enableZoom===!1||l!==a.NONE&&l!==a.ROTATE||(re.preventDefault(),i.dispatchEvent(s),le(re),i.dispatchEvent(o))}function Ke(re){i.enabled===!1||i.enablePan===!1||ee(re)}function $e(re){switch(tt(re),T.length){case 1:switch(i.touches.ONE){case xr.ROTATE:if(i.enableRotate===!1)return;se(),l=a.TOUCH_ROTATE;break;case xr.PAN:if(i.enablePan===!1)return;Ee(),l=a.TOUCH_PAN;break;default:l=a.NONE}break;case 2:switch(i.touches.TWO){case xr.DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;oe(),l=a.TOUCH_DOLLY_PAN;break;case xr.DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;ce(),l=a.TOUCH_DOLLY_ROTATE;break;default:l=a.NONE}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function Ze(re){switch(tt(re),l){case a.TOUCH_ROTATE:if(i.enableRotate===!1)return;Ae(re),i.update();break;case a.TOUCH_PAN:if(i.enablePan===!1)return;he(re),i.update();break;case a.TOUCH_DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;J(re),i.update();break;case a.TOUCH_DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;ue(re),i.update();break;default:l=a.NONE}}function ut(re){i.enabled!==!1&&re.preventDefault()}function Ct(re){T.push(re)}function lt(re){delete B[re.pointerId];for(let Re=0;Re<T.length;Re++)if(T[Re].pointerId==re.pointerId){T.splice(Re,1);return}}function tt(re){let Re=B[re.pointerId];Re===void 0&&(Re=new Fe,B[re.pointerId]=Re),Re.set(re.pageX,re.pageY)}function Je(re){const Re=re.pointerId===T[0].pointerId?T[1]:T[0];return B[Re.pointerId]}this.dollyIn=(re=R())=>{L(re),i.update()},this.dollyOut=(re=R())=>{N(re),i.update()},this.getScale=()=>f,this.setScale=re=>{F(re),i.update()},this.getZoomScale=()=>R(),t!==void 0&&this.connect(t),this.update()}},hT=class extends o3{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=fs.PAN,this.mouseButtons.RIGHT=fs.ROTATE,this.touches.ONE=xr.PAN,this.touches.TWO=xr.DOLLY_ROTATE}};var fT=Object.defineProperty,dT=(r,e,t)=>e in r?fT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ge=(r,e,t)=>(dT(r,typeof e!="symbol"?e+"":e,t),t);const ct={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},Xt={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},_t={x:0,y:0},Tn={camera:new Me,gizmos:new Me},ci={type:"change"},as={type:"start"},On={type:"end"};let mT=class extends Ca{constructor(e,t=null,i=null){super(),ge(this,"camera"),ge(this,"domElement"),ge(this,"scene"),ge(this,"mouseActions"),ge(this,"_mouseOp"),ge(this,"_v2_1"),ge(this,"_v3_1"),ge(this,"_v3_2"),ge(this,"_m4_1"),ge(this,"_m4_2"),ge(this,"_quat"),ge(this,"_translationMatrix"),ge(this,"_rotationMatrix"),ge(this,"_scaleMatrix"),ge(this,"_rotationAxis"),ge(this,"_cameraMatrixState"),ge(this,"_cameraProjectionState"),ge(this,"_fovState"),ge(this,"_upState"),ge(this,"_zoomState"),ge(this,"_nearPos"),ge(this,"_farPos"),ge(this,"_gizmoMatrixState"),ge(this,"_up0"),ge(this,"_zoom0"),ge(this,"_fov0"),ge(this,"_initialNear"),ge(this,"_nearPos0"),ge(this,"_initialFar"),ge(this,"_farPos0"),ge(this,"_cameraMatrixState0"),ge(this,"_gizmoMatrixState0"),ge(this,"_button"),ge(this,"_touchStart"),ge(this,"_touchCurrent"),ge(this,"_input"),ge(this,"_switchSensibility"),ge(this,"_startFingerDistance"),ge(this,"_currentFingerDistance"),ge(this,"_startFingerRotation"),ge(this,"_currentFingerRotation"),ge(this,"_devPxRatio"),ge(this,"_downValid"),ge(this,"_nclicks"),ge(this,"_downEvents"),ge(this,"_clickStart"),ge(this,"_maxDownTime"),ge(this,"_maxInterval"),ge(this,"_posThreshold"),ge(this,"_movementThreshold"),ge(this,"_currentCursorPosition"),ge(this,"_startCursorPosition"),ge(this,"_grid"),ge(this,"_gridPosition"),ge(this,"_gizmos"),ge(this,"_curvePts"),ge(this,"_timeStart"),ge(this,"_animationId"),ge(this,"focusAnimationTime"),ge(this,"_timePrev"),ge(this,"_timeCurrent"),ge(this,"_anglePrev"),ge(this,"_angleCurrent"),ge(this,"_cursorPosPrev"),ge(this,"_cursorPosCurr"),ge(this,"_wPrev"),ge(this,"_wCurr"),ge(this,"adjustNearFar"),ge(this,"scaleFactor"),ge(this,"dampingFactor"),ge(this,"wMax"),ge(this,"enableAnimations"),ge(this,"enableGrid"),ge(this,"cursorZoom"),ge(this,"minFov"),ge(this,"maxFov"),ge(this,"enabled"),ge(this,"enablePan"),ge(this,"enableRotate"),ge(this,"enableZoom"),ge(this,"minDistance"),ge(this,"maxDistance"),ge(this,"minZoom"),ge(this,"maxZoom"),ge(this,"target"),ge(this,"_currentTarget"),ge(this,"_tbRadius"),ge(this,"_state"),ge(this,"onWindowResize",()=>{const n=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const c=this.calculateTbRadius(this.camera);c!==void 0&&(this._tbRadius=c)}const s=this._tbRadius/n,a=new Af(0,0,s,s).getPoints(this._curvePts),l=new Gi().setFromPoints(a);for(const c in this._gizmos.children){const u=this._gizmos.children[c];u.geometry=l}this.dispatchEvent(ci)}),ge(this,"onContextMenu",n=>{if(this.enabled){for(let s=0;s<this.mouseActions.length;s++)if(this.mouseActions[s].mouse==2){n.preventDefault();break}}}),ge(this,"onPointerCancel",()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=Xt.NONE}),ge(this,"onPointerDown",n=>{if(n.button==0&&n.isPrimary?(this._downValid=!0,this._downEvents.push(n)):this._downValid=!1,n.pointerType=="touch"&&this._input!=Xt.CURSOR)switch(this._touchStart.push(n),this._touchCurrent.push(n),this._input){case Xt.NONE:this._input=Xt.ONE_FINGER,this.onSinglePanStart(n,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case Xt.ONE_FINGER:case Xt.ONE_FINGER_SWITCHED:this._input=Xt.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case Xt.TWO_FINGER:this._input=Xt.MULT_FINGER,this.onTriplePanStart();break}else if(n.pointerType!="touch"&&this._input==Xt.NONE){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT"),this._mouseOp=this.getOpFromAction(n.button,s),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=Xt.CURSOR,this._button=n.button,this.onSinglePanStart(n,this._mouseOp))}}),ge(this,"onPointerMove",n=>{if(n.pointerType=="touch"&&this._input!=Xt.CURSOR)switch(this._input){case Xt.ONE_FINGER:this.updateTouchEvent(n),this.onSinglePanMove(n,ct.ROTATE);break;case Xt.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],n)*this._devPxRatio>=this._switchSensibility){this._input=Xt.ONE_FINGER,this.updateTouchEvent(n),this.onSinglePanStart(n,"ROTATE");break}break;case Xt.TWO_FINGER:this.updateTouchEvent(n),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case Xt.MULT_FINGER:this.updateTouchEvent(n),this.onTriplePanMove();break}else if(n.pointerType!="touch"&&this._input==Xt.CURSOR){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT");const o=this.getOpStateFromAction(this._button,s);o&&this.onSinglePanMove(n,o)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],n)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}),ge(this,"onPointerUp",n=>{if(n.pointerType=="touch"&&this._input!=Xt.CURSOR){const s=this._touchCurrent.length;for(let o=0;o<s;o++)if(this._touchCurrent[o].pointerId==n.pointerId){this._touchCurrent.splice(o,1),this._touchStart.splice(o,1);break}switch(this._input){case Xt.ONE_FINGER:case Xt.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Xt.NONE,this.onSinglePanEnd();break;case Xt.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=Xt.ONE_FINGER_SWITCHED;break;case Xt.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Xt.NONE,this.onTriplePanEnd());break}}else n.pointerType!="touch"&&this._input==Xt.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Xt.NONE,this.onSinglePanEnd(),this._button=-1);if(n.isPrimary)if(this._downValid)if(n.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const o=n.timeStamp-this._clickStart,a=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;o<=this._maxInterval&&a<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(n)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}),ge(this,"onWheel",n=>{var s,o;if(this.enabled&&this.enableZoom&&this.domElement){let a=null;n.ctrlKey||n.metaKey?a="CTRL":n.shiftKey&&(a="SHIFT");const l=this.getOpFromAction("WHEEL",a);if(l){n.preventDefault(),this.dispatchEvent(as);const c=125;let u=n.deltaY/c,h=1;switch(u>0?h=1/this.scaleFactor:u<0&&(h=this.scaleFactor),l){case"ZOOM":if(this.updateTbState(ct.SCALE,!0),u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u)),this.cursorZoom&&this.enablePan){let f;this.camera instanceof vi&&(f=(s=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof ri&&(f=(o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:o.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),f!==void 0&&this.applyTransformMatrix(this.applyScale(h,f))}else this.applyTransformMatrix(this.applyScale(h,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(ct.IDLE,!1),this.dispatchEvent(ci),this.dispatchEvent(On);break;case"FOV":if(this.camera instanceof ri){this.updateTbState(ct.FOV,!0),n.deltaX!=0&&(u=n.deltaX/c,h=1,u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const f=this._v3_1.distanceTo(this._gizmos.position);let d=f/h;d=ot.clamp(d,this.minDistance,this.maxDistance);const m=f*Math.tan(ot.DEG2RAD*this.camera.fov*.5);let A=ot.RAD2DEG*(Math.atan(m/d)*2);A>this.maxFov?A=this.maxFov:A<this.minFov&&(A=this.minFov);const p=m/Math.tan(ot.DEG2RAD*(A/2));h=f/p,this.setFov(A),this.applyTransformMatrix(this.applyScale(h,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(ct.IDLE,!1),this.dispatchEvent(ci),this.dispatchEvent(On);break}}}}),ge(this,"onSinglePanStart",(n,s)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(as),this.setCenter(n.clientX,n.clientY),s){case"PAN":if(!this.enablePan)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ci)),this.camera){this.updateTbState(ct.PAN,!0);const o=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement);o!==void 0&&this._startCursorPosition.copy(o),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(ci))}break;case"ROTATE":if(!this.enableRotate)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState(ct.ROTATE,!0);const o=this.unprojectOnTbSurface(this.camera,_t.x,_t.y,this.domElement,this._tbRadius);o!==void 0&&this._startCursorPosition.copy(o),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(ci);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof ri&&(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ci)),this.updateTbState(ct.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ci)),this.updateTbState(ct.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}),ge(this,"onSinglePanMove",(n,s)=>{if(this.enabled&&this.domElement){const o=s!=this._state;switch(this.setCenter(n.clientX,n.clientY),s){case ct.PAN:if(this.enablePan&&this.camera)if(o){this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0);const a=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const a=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement);a!==void 0&&this._currentCursorPosition.copy(a),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case ct.ROTATE:if(this.enableRotate&&this.camera)if(o){this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0);const a=this.unprojectOnTbSurface(this.camera,_t.x,_t.y,this.domElement,this._tbRadius);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const a=this.unprojectOnTbSurface(this.camera,_t.x,_t.y,this.domElement,this._tbRadius);a!==void 0&&this._currentCursorPosition.copy(a);const l=this._startCursorPosition.distanceTo(this._currentCursorPosition),c=this._startCursorPosition.angleTo(this._currentCursorPosition),u=Math.max(l/this._tbRadius,c);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),u)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=u,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case ct.SCALE:if(this.enableZoom)if(o)this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this.applyTransformMatrix(this.applyScale(c,this._gizmos.position))}break;case ct.FOV:if(this.enableZoom&&this.camera instanceof ri)if(o)this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=ot.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(ot.DEG2RAD*this._fovState*.5);let d=ot.RAD2DEG*(Math.atan(f/h)*2);d=ot.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(ot.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z)}break}this.dispatchEvent(ci)}}),ge(this,"onSinglePanEnd",()=>{if(this._state==ct.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const s=Math.abs((this._wPrev+this._wCurr)/2),o=this;this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(ct.ANIMATION_ROTATE,!0);const l=o.calculateRotationAxis(o._cursorPosPrev,o._cursorPosCurr);o.onRotationAnim(a,l,Math.min(s,o.wMax))})}else this.updateTbState(ct.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ci);else this.updateTbState(ct.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ci)}else(this._state==ct.PAN||this._state==ct.IDLE)&&(this.updateTbState(ct.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(ci));this.dispatchEvent(On)}),ge(this,"onDoubleTap",n=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(as),this.setCenter(n.clientX,n.clientY);const s=this.unprojectOnObj(this.getCursorNDC(_t.x,_t.y,this.domElement),this.camera);if(s&&this.enableAnimations){const o=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(ct.ANIMATION_FOCUS,!0),o.onFocusAnim(a,s,o._cameraMatrixState,o._gizmoMatrixState)})}else s&&!this.enableAnimations&&(this.updateTbState(ct.FOCUS,!0),this.focus(s,this.scaleFactor),this.updateTbState(ct.IDLE,!1),this.dispatchEvent(ci))}this.dispatchEvent(On)}),ge(this,"onDoublePanStart",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(as),this.updateTbState(ct.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const n=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement,!0);n!==void 0&&this._startCursorPosition.copy(n),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}}),ge(this,"onDoublePanMove",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=ct.PAN&&(this.updateTbState(ct.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const n=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement,!0);n!==void 0&&this._currentCursorPosition.copy(n),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(ci)}}),ge(this,"onDoublePanEnd",()=>{this.updateTbState(ct.IDLE,!1),this.dispatchEvent(On)}),ge(this,"onRotateStart",()=>{var n;this.enabled&&this.enableRotate&&(this.dispatchEvent(as),this.updateTbState(ct.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,(n=this.camera)==null||n.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}),ge(this,"onRotateMove",()=>{var n;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let s;this._state!=ct.ZROTATE&&(this.updateTbState(ct.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),s=(n=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):s=new K().setFromMatrixPosition(this._gizmoMatrixState);const o=ot.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);s!==void 0&&this.applyTransformMatrix(this.zRotate(s,o)),this.dispatchEvent(ci)}}),ge(this,"onRotateEnd",()=>{this.updateTbState(ct.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(On)}),ge(this,"onPinchStart",()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(as),this.updateTbState(ct.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}),ge(this,"onPinchMove",()=>{var n,s;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const o=12;this._state!=ct.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(ct.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),o*this._devPxRatio);const a=this._currentFingerDistance/this._startFingerDistance;let l;this.enablePan?this.camera instanceof vi?l=(n=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof ri&&(l=(s=this.unprojectOnTbPlane(this.camera,_t.x,_t.y,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):l=this._gizmos.position,l!==void 0&&this.applyTransformMatrix(this.applyScale(a,l)),this.dispatchEvent(ci)}}),ge(this,"onPinchEnd",()=>{this.updateTbState(ct.IDLE,!1),this.dispatchEvent(On)}),ge(this,"onTriplePanStart",()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(as),this.updateTbState(ct.SCALE,!0);let n=0,s=0;const o=this._touchCurrent.length;for(let a=0;a<o;a++)n+=this._touchCurrent[a].clientX,s+=this._touchCurrent[a].clientY;this.setCenter(n/o,s/o),this._startCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}),ge(this,"onTriplePanMove",()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let n=0,s=0;const o=this._touchCurrent.length;for(let p=0;p<o;p++)n+=this._touchCurrent[p].clientX,s+=this._touchCurrent[p].clientY;this.setCenter(n/o,s/o);const a=8;this._currentCursorPosition.setY(this.getCursorNDC(_t.x,_t.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*a):l>0&&(c=Math.pow(this.scaleFactor,l*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=ot.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(ot.DEG2RAD*this._fovState*.5);let d=ot.RAD2DEG*(Math.atan(f/h)*2);d=ot.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(ot.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z),this.dispatchEvent(ci)}}),ge(this,"onTriplePanEnd",()=>{this.updateTbState(ct.IDLE,!1),this.dispatchEvent(On)}),ge(this,"setCenter",(n,s)=>{_t.x=n,_t.y=s}),ge(this,"initializeMouseActions",()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}),ge(this,"setMouseAction",(n,s,o=null)=>{const a=["PAN","ROTATE","ZOOM","FOV"],l=[0,1,2,"WHEEL"],c=["CTRL","SHIFT",null];let u;if(!a.includes(n)||!l.includes(s)||!c.includes(o)||s=="WHEEL"&&n!="ZOOM"&&n!="FOV")return!1;switch(n){case"PAN":u=ct.PAN;break;case"ROTATE":u=ct.ROTATE;break;case"ZOOM":u=ct.SCALE;break;case"FOV":u=ct.FOV;break}const h={operation:n,mouse:s,key:o,state:u};for(let f=0;f<this.mouseActions.length;f++)if(this.mouseActions[f].mouse==h.mouse&&this.mouseActions[f].key==h.key)return this.mouseActions.splice(f,1,h),!0;return this.mouseActions.push(h),!0}),ge(this,"getOpFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.operation;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.operation}return null}),ge(this,"getOpStateFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.state;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.state}return null}),ge(this,"getAngle",(n,s)=>Math.atan2(s.clientY-n.clientY,s.clientX-n.clientX)*180/Math.PI),ge(this,"updateTouchEvent",n=>{for(let s=0;s<this._touchCurrent.length;s++)if(this._touchCurrent[s].pointerId==n.pointerId){this._touchCurrent.splice(s,1,n);break}}),ge(this,"calculateAngularSpeed",(n,s,o,a)=>{const l=s-n,c=(a-o)/1e3;return c==0?0:l/c}),ge(this,"calculatePointersDistance",(n,s)=>Math.sqrt(Math.pow(s.clientX-n.clientX,2)+Math.pow(s.clientY-n.clientY,2))),ge(this,"calculateRotationAxis",(n,s)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(n,s).applyQuaternion(this._quat),this._rotationAxis.normalize().clone())),ge(this,"calculateTbRadius",n=>{const o=n.position.distanceTo(this._gizmos.position);if(n instanceof ri){const a=ot.DEG2RAD*n.fov*.5,l=Math.atan(n.aspect*Math.tan(a));return Math.tan(Math.min(a,l))*o*.67}else if(n instanceof vi)return Math.min(n.top,n.right)*.67}),ge(this,"focus",(n,s,o=1)=>{if(this.camera){const a=n.clone();a.sub(this._gizmos.position).multiplyScalar(o),this._translationMatrix.makeTranslation(a.x,a.y,a.z);const l=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const c=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(s,this._gizmos.position)),this._gizmoMatrixState.copy(l),this._cameraMatrixState.copy(c)}}),ge(this,"drawGrid",()=>{if(this.scene){let o,a,l,c;if(this.camera instanceof vi){const u=this.camera.right-this.camera.left,h=this.camera.bottom-this.camera.top;l=Math.max(u,h),c=l/20,o=l/this.camera.zoom*3,a=o/c*this.camera.zoom}else if(this.camera instanceof ri){const u=this.camera.position.distanceTo(this._gizmos.position),h=ot.DEG2RAD*this.camera.fov*.5,f=Math.atan(this.camera.aspect*Math.tan(h));l=Math.tan(Math.max(h,f))*u*2,c=l/20,o=l*3,a=o/c}this._grid==null&&this.camera&&(this._grid=new OI(o,a,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}),ge(this,"connect",n=>{n===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)}),ge(this,"dispose",()=>{var n,s,o,a,l;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointercancel",this.onPointerCancel),(o=this.domElement)==null||o.removeEventListener("wheel",this.onWheel),(a=this.domElement)==null||a.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),(l=this.scene)==null||l.remove(this._gizmos),this.disposeGrid()}),ge(this,"disposeGrid",()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)}),ge(this,"easeOutCubic",n=>1-Math.pow(1-n,3)),ge(this,"activateGizmos",n=>{for(const s of this._gizmos.children)s.material.setValues({opacity:n?1:.6})}),ge(this,"getCursorNDC",(n,s,o)=>{const a=o.getBoundingClientRect();return this._v2_1.setX((n-a.left)/a.width*2-1),this._v2_1.setY((a.bottom-s)/a.height*2-1),this._v2_1.clone()}),ge(this,"getCursorPosition",(n,s,o)=>(this._v2_1.copy(this.getCursorNDC(n,s,o)),this.camera instanceof vi&&(this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5),this._v2_1.clone())),ge(this,"setCamera",n=>{if(n){n.lookAt(this.target),n.updateMatrix(),n instanceof ri&&(this._fov0=n.fov,this._fovState=n.fov),this._cameraMatrixState0.copy(n.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(n.projectionMatrix),this._zoom0=n.zoom,this._zoomState=this._zoom0,this._initialNear=n.near,this._nearPos0=n.position.distanceTo(this.target)-n.near,this._nearPos=this._initialNear,this._initialFar=n.far,this._farPos0=n.position.distanceTo(this.target)-n.far,this._farPos=this._initialFar,this._up0.copy(n.up),this._upState.copy(n.up),this.camera=n,this.camera.updateProjectionMatrix();const s=this.calculateTbRadius(n);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius)}}),ge(this,"makeGizmos",(n,s)=>{const a=new Af(0,0,s,s).getPoints(this._curvePts),l=new Gi().setFromPoints(a),c=new ia({color:16744576,fog:!1,transparent:!0,opacity:.6}),u=new ia({color:8454016,fog:!1,transparent:!0,opacity:.6}),h=new ia({color:8421631,fog:!1,transparent:!0,opacity:.6}),f=new Mt(l,c),d=new Mt(l,u),m=new Mt(l,h),A=Math.PI*.5;if(f.rotation.x=A,d.rotation.y=A,this._gizmoMatrixState0.identity().setPosition(n),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&this.camera.zoom!=1){const p=1/this.camera.zoom;this._scaleMatrix.makeScale(p,p,p),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(n.x,n.y,n.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(f),this._gizmos.add(d),this._gizmos.add(m)}),ge(this,"onFocusAnim",(n,s,o,a)=>{if(this._timeStart==-1&&(this._timeStart=n),this._state==ct.ANIMATION_FOCUS){const c=(n-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(a),c>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,this.scaleFactor),this._timeStart=-1,this.updateTbState(ct.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ci);else{const u=this.easeOutCubic(c),h=1-u+this.scaleFactor*u;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,h,u),this.dispatchEvent(ci);const f=this;this._animationId=window.requestAnimationFrame(function(d){f.onFocusAnim(d,s,o,a.clone())})}}else this._animationId=-1,this._timeStart=-1}),ge(this,"onRotationAnim",(n,s,o)=>{if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=n),this._state==ct.ANIMATION_ROTATE){const a=(n-this._timeStart)/1e3;if(o+-this.dampingFactor*a>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(a,2)+o*a+0,this.applyTransformMatrix(this.rotate(s,this._angleCurrent)),this.dispatchEvent(ci);const c=this;this._animationId=window.requestAnimationFrame(function(u){c.onRotationAnim(u,s,o)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(ct.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ci)}else this._animationId=-1,this._timeStart=-1,this._state!=ct.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(ci))}),ge(this,"pan",(n,s,o=!1)=>{if(this.camera){const a=n.clone().sub(s);if(this.camera instanceof vi&&a.multiplyScalar(1/this.camera.zoom),this.camera instanceof ri&&o){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const l=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);a.multiplyScalar(1/l)}this._v3_1.set(a.x,a.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return Tn}),ge(this,"reset",()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof ri&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const n=this.calculateTbRadius(this.camera);n!==void 0&&(this._tbRadius=n),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(ct.IDLE,!1),this.dispatchEvent(ci)}}),ge(this,"rotate",(n,s)=>{const o=this._gizmos.position;return this._translationMatrix.makeTranslation(-o.x,-o.y,-o.z),this._rotationMatrix.makeRotationAxis(n,-s),this._m4_1.makeTranslation(o.x,o.y,o.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),Tn}),ge(this,"copyState",()=>{if(this.camera){const n=JSON.stringify(this.camera instanceof vi?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(n)}}),ge(this,"pasteState",()=>{const n=this;navigator.clipboard.readText().then(function(o){n.setStateFromJSON(o)})}),ge(this,"saveState",()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof ri&&(this._fov0=this.camera.fov))}),ge(this,"applyScale",(n,s,o=!0)=>{if(!this.camera)return;const a=s.clone();let l=1/n;if(this.camera instanceof vi){this.camera.zoom=this._zoomState,this.camera.zoom*=n,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,l=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,l=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(l,l,l),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),a.sub(this._v3_1);const c=a.clone().multiplyScalar(l);return a.sub(c),this._m4_1.makeTranslation(a.x,a.y,a.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),Tn}if(this.camera instanceof ri){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let c=this._v3_1.distanceTo(a),u=c-c*l;const h=c-u;h<this.minDistance?(l=this.minDistance/c,u=c-c*l):h>this.maxDistance&&(l=this.maxDistance/c,u=c-c*l);let f=a.clone().sub(this._v3_1).normalize().multiplyScalar(u);if(this._m4_1.makeTranslation(f.x,f.y,f.z),o){const d=this._v3_2;c=d.distanceTo(a),u=c-c*l,f=a.clone().sub(this._v3_2).normalize().multiplyScalar(u),this._translationMatrix.makeTranslation(d.x,d.y,d.z),this._scaleMatrix.makeScale(l,l,l),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-d.x,-d.y,-d.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return Tn}}),ge(this,"setFov",n=>{this.camera instanceof ri&&(this.camera.fov=ot.clamp(n,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}),ge(this,"setTarget",(n,s,o)=>{if(this.camera){this.target.set(n,s,o),this._gizmos.position.set(n,s,o);const a=this.calculateTbRadius(this.camera);a!==void 0&&(this._tbRadius=a),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}}),ge(this,"zRotate",(n,s)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,s),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._m4_1.makeTranslation(n.x,n.y,n.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(n),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,s),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),Tn)),ge(this,"unprojectOnObj",(n,s)=>{if(!this.scene)return null;const o=new Th;o.near=s.near,o.far=s.far,o.setFromCamera(n,s);const a=o.intersectObjects(this.scene.children,!0);for(let l=0;l<a.length;l++)if(a[l].object.uuid!=this._gizmos.uuid&&a[l].face)return a[l].point.clone();return null}),ge(this,"unprojectOnTbSurface",(n,s,o,a,l)=>{if(n instanceof vi){this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const c=Math.pow(this._v2_1.x,2),u=Math.pow(this._v2_1.y,2),h=Math.pow(this._tbRadius,2);return c+u<=h*.5?this._v3_1.setZ(Math.sqrt(h-(c+u))):this._v3_1.setZ(h*.5/Math.sqrt(c+u)),this._v3_1}if(n instanceof ri){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=n.position.distanceTo(this._gizmos.position),h=Math.pow(l,2),f=this._v3_1.z,d=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(d==0)return c.set(this._v3_1.x,this._v3_1.y,l),c;const m=f/d,A=u;let p=Math.pow(m,2)+1,g=2*m*A,v=Math.pow(A,2)-h,E=Math.pow(g,2)-4*p*v;if(E>=0&&(this._v2_1.setX((-g-Math.sqrt(E))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A),ot.RAD2DEG*this._v2_1.angle()>=45)){const _=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(_),c.z+=u,c}p=m,g=A,v=-h*.5,E=Math.pow(g,2)-4*p*v,this._v2_1.setX((-g-Math.sqrt(E))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A);const C=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(C),c.z+=u,c}}),ge(this,"unprojectOnTbPlane",(n,s,o,a,l=!1)=>{if(n instanceof vi)return this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(n instanceof ri){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let f;if(l?f=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):f=n.position.distanceTo(this._gizmos.position),h==0)return c.set(0,0,0),c;const d=u/h,m=f,A=-m/d,p=Math.sqrt(Math.pow(m,2)+Math.pow(A,2));return c.multiplyScalar(p),c.z=0,c}}),ge(this,"updateMatrixState",()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof vi&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof ri&&(this._fovState=this.camera.fov))}),ge(this,"updateTbState",(n,s)=>{this._state=n,s&&this.updateMatrixState()}),ge(this,"update",()=>{if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const s=this.calculateTbRadius(this.camera);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof vi&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const s=ot.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(s/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof ri){const s=this.camera.position.distanceTo(this._gizmos.position);if(s>this.maxDistance+1e-6||s<this.minDistance-1e-6){const l=ot.clamp(s,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(l/s,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=ot.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const o=this._tbRadius,a=this.calculateTbRadius(this.camera);if(a!==void 0&&(this._tbRadius=a),o<this._tbRadius-1e-6||o>this._tbRadius+1e-6){const l=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,c=this._tbRadius/l,h=new Af(0,0,c,c).getPoints(this._curvePts),f=new Gi().setFromPoints(h);for(const d in this._gizmos.children){const m=this._gizmos.children[d];m.geometry=f}}}this.camera.lookAt(this._gizmos.position)}}),ge(this,"setStateFromJSON",n=>{const s=JSON.parse(n);if(s.arcballState&&this.camera){this._cameraMatrixState.fromArray(s.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(s.arcballState.cameraUp),this.camera.near=s.arcballState.cameraNear,this.camera.far=s.arcballState.cameraFar,this.camera.zoom=s.arcballState.cameraZoom,this.camera instanceof ri&&(this.camera.fov=s.arcballState.cameraFov),this._gizmoMatrixState.fromArray(s.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const o=this.calculateTbRadius(this.camera);o!==void 0&&(this._tbRadius=o);const a=new Me().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(a),this.camera.lookAt(this._gizmos.position),this.updateTbState(ct.IDLE,!1),this.dispatchEvent(ci)}}),this.camera=null,this.domElement=t,this.scene=i,this.mouseActions=[],this._mouseOp=null,this._v2_1=new Fe,this._v3_1=new K,this._v3_2=new K,this._m4_1=new Me,this._m4_2=new Me,this._quat=new ht,this._translationMatrix=new Me,this._rotationMatrix=new Me,this._scaleMatrix=new Me,this._rotationAxis=new K,this._cameraMatrixState=new Me,this._cameraProjectionState=new Me,this._fovState=1,this._upState=new K,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new Me,this._up0=new K,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new Me,this._gizmoMatrixState0=new Me,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=Xt.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new K,this._startCursorPosition=new K,this._grid=null,this._gridPosition=new K,this._gizmos=new or,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new K,this._cursorPosCurr=new K,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new K(0,0,0),this._currentTarget=new K(0,0,0),this._tbRadius=1,this._state=ct.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if(e?.camera&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==ct.ROTATE||this._state==ct.ZROTATE||this._state==ct.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),e?.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==ct.SCALE||this._state==ct.FOCUS||this._state==ct.ANIMATION_FOCUS)&&this.camera){const t=this.calculateTbRadius(this.camera);if(t!==void 0&&(this._tbRadius=t),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),n=new oi;n.setFromObject(this._gizmos);const s=new un;n.getBoundingSphere(s);const o=Math.max(this._nearPos0,s.radius+s.center.length()),a=i-this._initialNear,l=Math.min(o,a);this.camera.near=i-l;const c=Math.min(this._farPos0,-s.radius+s.center.length()),u=i-this._initialFar,h=Math.min(c,u);this.camera.far=i-h,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(ci)}setTransformationMatrices(e=null,t=null){e?Tn.camera?Tn.camera.copy(e):Tn.camera=e.clone():Tn.camera=null,t?Tn.gizmos?Tn.gizmos.copy(t):Tn.gizmos=t.clone():Tn.gizmos=null}};var AT=Object.defineProperty,pT=(r,e,t)=>e in r?AT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,si=(r,e,t)=>(pT(r,typeof e!="symbol"?e+"":e,t),t);function Og(r){r.preventDefault()}let gT=class extends Ca{constructor(e,t){super(),si(this,"object"),si(this,"domElement",null),si(this,"movementSpeed",1),si(this,"rollSpeed",.005),si(this,"dragToLook",!1),si(this,"autoForward",!1),si(this,"changeEvent",{type:"change"}),si(this,"EPS",1e-6),si(this,"tmpQuaternion",new ht),si(this,"mouseStatus",0),si(this,"movementSpeedMultiplier",1),si(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),si(this,"moveVector",new K(0,0,0)),si(this,"rotationVector",new K(0,0,0)),si(this,"keydown",i=>{if(!i.altKey){switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1;break}this.updateMovementVector(),this.updateRotationVector()}}),si(this,"keyup",i=>{switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0;break}this.updateMovementVector(),this.updateRotationVector()}),si(this,"pointerdown",i=>{if(this.dragToLook)this.mouseStatus++;else{switch(i.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1;break}this.updateMovementVector()}}),si(this,"pointermove",i=>{if(!this.dragToLook||this.mouseStatus>0){const n=this.getContainerDimensions(),s=n.size[0]/2,o=n.size[1]/2;this.moveState.yawLeft=-(i.pageX-n.offset[0]-s)/s,this.moveState.pitchDown=(i.pageY-n.offset[1]-o)/o,this.updateRotationVector()}}),si(this,"pointerup",i=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(i.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0;break}this.updateMovementVector()}this.updateRotationVector()}),si(this,"lastQuaternion",new ht),si(this,"lastPosition",new K),si(this,"update",i=>{const n=i*this.movementSpeed,s=i*this.rollSpeed;this.object.translateX(this.moveVector.x*n),this.object.translateY(this.moveVector.y*n),this.object.translateZ(this.moveVector.z*n),this.tmpQuaternion.set(this.rotationVector.x*s,this.rotationVector.y*s,this.rotationVector.z*s,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))}),si(this,"updateMovementVector",()=>{const i=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-i+this.moveState.back}),si(this,"updateRotationVector",()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}),si(this,"getContainerDimensions",()=>this.domElement!=document&&!(this.domElement instanceof Document)?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}),si(this,"connect",i=>{this.domElement=i,i instanceof Document||i.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",Og),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}),si(this,"dispose",()=>{this.domElement.removeEventListener("contextmenu",Og),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)}),this.object=e,t!==void 0&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}};var yT=Object.defineProperty,vT=(r,e,t)=>e in r?yT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,to=(r,e,t)=>(vT(r,typeof e!="symbol"?e+"":e,t),t);class Qh{constructor(){to(this,"enabled",!0),to(this,"needsSwap",!0),to(this,"clear",!1),to(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,i,n,s){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class nr{constructor(e){to(this,"camera",new vi(-1,1,1,-1,0,1)),to(this,"geometry",new an(2,2)),to(this,"mesh"),this.mesh=new je(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var ET=Object.defineProperty,CT=(r,e,t)=>e in r?ET(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,kc=(r,e,t)=>(CT(r,typeof e!="symbol"?e+"":e,t),t);class j0 extends Qh{constructor(e,t="tDiffuse"){super(),kc(this,"textureID"),kc(this,"uniforms"),kc(this,"material"),kc(this,"fsQuad"),this.textureID=t,e instanceof bi?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=Kl.clone(e.uniforms),this.material=new bi({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new nr(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const Ug={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform float opacity;

    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );
    	gl_FragColor = opacity * texel;

    }
  `};var IT=Object.defineProperty,_T=(r,e,t)=>e in r?IT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Mf=(r,e,t)=>(_T(r,typeof e!="symbol"?e+"":e,t),t);class Ng extends Qh{constructor(e,t){super(),Mf(this,"scene"),Mf(this,"camera"),Mf(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const n=e.getContext(),s=e.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),s.buffers.stencil.setFunc(n.ALWAYS,o,4294967295),s.buffers.stencil.setClear(a),s.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(n.EQUAL,1,4294967295),s.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),s.buffers.stencil.setLocked(!0)}}class xT extends Qh{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var ST=Object.defineProperty,TT=(r,e,t)=>e in r?ST(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Un=(r,e,t)=>(TT(r,typeof e!="symbol"?e+"":e,t),t);class bT{constructor(e,t){if(Un(this,"renderer"),Un(this,"_pixelRatio"),Un(this,"_width"),Un(this,"_height"),Un(this,"renderTarget1"),Un(this,"renderTarget2"),Un(this,"writeBuffer"),Un(this,"readBuffer"),Un(this,"renderToScreen"),Un(this,"passes",[]),Un(this,"copyPass"),Un(this,"clock"),this.renderer=e,t===void 0){const i={minFilter:jt,magFilter:jt,format:Mi},n=e.getSize(new Fe);this._pixelRatio=e.getPixelRatio(),this._width=n.width,this._height=n.height,t=new _i(this._width*this._pixelRatio,this._height*this._pixelRatio,i),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,Ug===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),j0===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new j0(Ug),this.copyPass.material.blending=Fm,this.clock=new UI}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;const n=this.passes.length;for(let s=0;s<n;s++){const o=this.passes[s];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),o.needsSwap){if(i){const a=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),l.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}Ng!==void 0&&(o instanceof Ng?i=!0:o instanceof xT&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new Fe);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(i,n),this.renderTarget2.setSize(i,n);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(i,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var wT=Object.defineProperty,BT=(r,e,t)=>e in r?wT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Vr=(r,e,t)=>(BT(r,typeof e!="symbol"?e+"":e,t),t);class RT extends Qh{constructor(e,t,i,n,s=0){super(),Vr(this,"scene"),Vr(this,"camera"),Vr(this,"overrideMaterial"),Vr(this,"clearColor"),Vr(this,"clearAlpha"),Vr(this,"clearDepth",!1),Vr(this,"_oldClearColor",new et),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=s,this.clear=!0,this.needsSwap=!1}render(e,t,i){let n=e.autoClear;e.autoClear=!1;let s,o=null;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,s),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=n}}function Aa(r){if(typeof TextDecoder<"u")return new TextDecoder().decode(r);let e="";for(let t=0,i=r.length;t<i;t++)e+=String.fromCharCode(r[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const io="srgb",ar="srgb-linear",Gg=3001,DT=3e3;class lA extends Ur{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new kT(t)}),this.register(function(t){return new OT(t)}),this.register(function(t){return new $T(t)}),this.register(function(t){return new jT(t)}),this.register(function(t){return new YT(t)}),this.register(function(t){return new NT(t)}),this.register(function(t){return new GT(t)}),this.register(function(t){return new QT(t)}),this.register(function(t){return new zT(t)}),this.register(function(t){return new FT(t)}),this.register(function(t){return new HT(t)}),this.register(function(t){return new UT(t)}),this.register(function(t){return new KT(t)}),this.register(function(t){return new VT(t)}),this.register(function(t){return new LT(t)}),this.register(function(t){return new WT(t)}),this.register(function(t){return new qT(t)})}load(e,t,i,n){const s=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=na.extractUrlBase(e);o=na.resolveURL(c,this.path)}else o=na.extractUrlBase(e);this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),s.manager.itemError(e),s.manager.itemEnd(e)},l=new In(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{s.parse(c,o,function(u){t(u),s.manager.itemEnd(e)},a)}catch(u){a(u)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let s;const o={},a={};if(typeof e=="string")s=JSON.parse(e);else if(e instanceof ArrayBuffer)if(Aa(new Uint8Array(e.slice(0,4)))===a3){try{o[Dt.KHR_BINARY_GLTF]=new XT(e)}catch(u){n&&n(u);return}s=JSON.parse(o[Dt.KHR_BINARY_GLTF].content)}else s=JSON.parse(Aa(new Uint8Array(e)));else s=e;if(s.asset===void 0||s.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new u6(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const u=this.pluginCallbacks[c](l);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const u=s.extensionsUsed[c],h=s.extensionsRequired||[];switch(u){case Dt.KHR_MATERIALS_UNLIT:o[u]=new PT;break;case Dt.KHR_DRACO_MESH_COMPRESSION:o[u]=new JT(s,this.dracoLoader);break;case Dt.KHR_TEXTURE_TRANSFORM:o[u]=new ZT;break;case Dt.KHR_MESH_QUANTIZATION:o[u]=new e6;break;default:h.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(o),l.setPlugins(a),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise(function(n,s){i.parse(e,t,n,s)})}}function MT(){let r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}const Dt={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class LT{constructor(e){this.parser=e,this.name=Dt.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const s=t[i];s.extensions&&s.extensions[this.name]&&s.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const s=t.json,l=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let c;const u=new et(16777215);l.color!==void 0&&u.setRGB(l.color[0],l.color[1],l.color[2],ar);const h=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new L2(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new T0(u),c.distance=h;break;case"spot":c=new M2(u),c.distance=h,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,er(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),n=Promise.resolve(c),t.cache.add(i,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,s=i.json.nodes[e],a=(s.extensions&&s.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return i._getNodeRef(t.cache,a,l)})}}class PT{constructor(){this.name=Dt.KHR_MATERIALS_UNLIT}getMaterialType(){return ms}extendParams(e,t,i){const n=[];e.color=new et(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const o=s.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],ar),e.opacity=o[3]}s.baseColorTexture!==void 0&&n.push(i.assignTexture(e,"map",s.baseColorTexture,io))}return Promise.all(n)}}class FT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name].emissiveStrength;return s!==void 0&&(t.emissiveIntensity=s),Promise.resolve()}}class kT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(s.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Fe(a,a)}return Promise.all(s)}}class OT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.dispersion=s.dispersion!==void 0?s.dispersion:0,Promise.resolve()}}class UT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class NT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new et(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],ar)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&s.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,io)),o.sheenRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class GT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&s.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class QT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&s.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new et().setRGB(a[0],a[1],a[2],ar),Promise.all(s)}}class zT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.ior=s.ior!==void 0?s.ior:1.5,Promise.resolve()}}class HT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&s.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new et().setRGB(a[0],a[1],a[2],ar),o.specularColorTexture!==void 0&&s.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,io)),Promise.all(s)}}class VT{constructor(e){this.parser=e,this.name=Dt.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&s.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(s)}}class KT{constructor(e){this.parser=e,this.name=Dt.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:es}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&s.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class $T{constructor(e){this.parser=e,this.name=Dt.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class jT{constructor(e){this.parser=e,this.name=Dt.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class YT{constructor(e){this.parser=e,this.name=Dt.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class WT{constructor(e){this.name=Dt.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const n=i.extensions[this.name],s=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,u=n.count,h=n.byteStride,f=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(u,h,f,n.mode,n.filter).then(function(d){return d.buffer}):o.ready.then(function(){const d=new ArrayBuffer(u*h);return o.decodeGltfBuffer(new Uint8Array(d),u,h,f,n.mode,n.filter),d})})}else return null}}class qT{constructor(e){this.name=Dt.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const n=t.meshes[i.mesh];for(const c of n.primitives)if(c.mode!==Hn.TRIANGLES&&c.mode!==Hn.TRIANGLE_STRIP&&c.mode!==Hn.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=i.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(u=>(l[c]=u,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const u=c.pop(),h=u.isGroup?u.children:[u],f=c[0].count,d=[];for(const m of h){const A=new Me,p=new K,g=new ht,v=new K(1,1,1),E=new Lm(m.geometry,m.material,f);for(let C=0;C<f;C++)l.TRANSLATION&&p.fromBufferAttribute(l.TRANSLATION,C),l.ROTATION&&g.fromBufferAttribute(l.ROTATION,C),l.SCALE&&v.fromBufferAttribute(l.SCALE,C),E.setMatrixAt(C,A.compose(p,g,v));for(const C in l)if(C==="_COLOR_0"){const I=l[C];E.instanceColor=new $l(I.array,I.itemSize,I.normalized)}else C!=="TRANSLATION"&&C!=="ROTATION"&&C!=="SCALE"&&m.geometry.setAttribute(C,l[C]);Ei.prototype.copy.call(E,m),this.parser.assignFinalMaterial(E),d.push(E)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const a3="glTF",$a=12,Qg={JSON:1313821514,BIN:5130562};class XT{constructor(e){this.name=Dt.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,$a);if(this.header={magic:Aa(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==a3)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-$a,n=new DataView(e,$a);let s=0;for(;s<i;){const o=n.getUint32(s,!0);s+=4;const a=n.getUint32(s,!0);if(s+=4,a===Qg.JSON){const l=new Uint8Array(e,$a+s,o);this.content=Aa(l)}else if(a===Qg.BIN){const l=$a+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class JT{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Dt.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const u in o){const h=Y0[u]||u.toLowerCase();a[h]=o[u]}for(const u in e.attributes){const h=Y0[u]||u.toLowerCase();if(o[u]!==void 0){const f=i.accessors[e.attributes[u]],d=la[f.componentType];c[h]=d.name,l[h]=f.normalized===!0}}return t.getDependency("bufferView",s).then(function(u){return new Promise(function(h,f){n.decodeDracoFile(u,function(d){for(const m in d.attributes){const A=d.attributes[m],p=l[m];p!==void 0&&(A.normalized=p)}h(d)},a,c,ar,f)})})}}class ZT{constructor(){this.name=Dt.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class e6{constructor(){this.name=Dt.KHR_MESH_QUANTIZATION}}class l3 extends WI{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=i[s+o];return t}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,u=n-t,h=(i-t)/u,f=h*h,d=f*h,m=e*c,A=m-c,p=-2*d+3*f,g=d-f,v=1-p,E=g-f+h;for(let C=0;C!==a;C++){const I=o[A+C+a],_=o[A+C+l]*u,x=o[m+C+a],S=o[m+C]*u;s[C]=v*I+E*_+p*x+g*S}return s}}const t6=new ht;class i6 extends l3{interpolate_(e,t,i,n){const s=super.interpolate_(e,t,i,n);return t6.fromArray(s).normalize().toArray(s),s}}const Hn={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},la={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},zg={9728:li,9729:jt,9984:HI,9985:zI,9986:QI,9987:uc},Hg={33071:Bn,33648:VI,10497:Ln},Lf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Y0={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...cc>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},yr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},n6={CUBICSPLINE:void 0,LINEAR:k2,STEP:YI},Pf={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function s6(r){return r.DefaultMaterial===void 0&&(r.DefaultMaterial=new bh({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Yl})),r.DefaultMaterial}function Kr(r,e,t){for(const i in t.extensions)r[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function er(r,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(r.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function r6(r,e,t){let i=!1,n=!1,s=!1;for(let c=0,u=e.length;c<u;c++){const h=e[c];if(h.POSITION!==void 0&&(i=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(s=!0),i&&n&&s)break}if(!i&&!n&&!s)return Promise.resolve(r);const o=[],a=[],l=[];for(let c=0,u=e.length;c<u;c++){const h=e[c];if(i){const f=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):r.attributes.position;o.push(f)}if(n){const f=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):r.attributes.normal;a.push(f)}if(s){const f=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):r.attributes.color;l.push(f)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const u=c[0],h=c[1],f=c[2];return i&&(r.morphAttributes.position=u),n&&(r.morphAttributes.normal=h),s&&(r.morphAttributes.color=f),r.morphTargetsRelative=!0,r})}function o6(r,e){if(r.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)r.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(r.morphTargetInfluences.length===t.length){r.morphTargetDictionary={};for(let i=0,n=t.length;i<n;i++)r.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function a6(r){let e;const t=r.extensions&&r.extensions[Dt.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ff(t.attributes):e=r.indices+":"+Ff(r.attributes)+":"+r.mode,r.targets!==void 0)for(let i=0,n=r.targets.length;i<n;i++)e+=":"+Ff(r.targets[i]);return e}function Ff(r){let e="";const t=Object.keys(r).sort();for(let i=0,n=t.length;i<n;i++)e+=t[i]+":"+r[t[i]]+";";return e}function W0(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function l6(r){return r.search(/\.jpe?g($|\?)/i)>0||r.search(/^data\:image\/jpeg/)===0?"image/jpeg":r.search(/\.webp($|\?)/i)>0||r.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const c6=new Me;class u6{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new MT,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||i||n&&s<98?this.textureLoader=new lr(this.options.manager):this.textureLoader=new NI(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new In(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:i,userData:{}};return Kr(s,a,n),er(a,n),Promise.all(i._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){for(const l of a.scenes)l.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const o=t[n].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),s=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,u]of o.children.entries())s(u,a.children[c])};return s(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&i.push(s)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(s){return s.loadNode&&s.loadNode(t)});break;case"mesh":n=this._invokeOne(function(s){return s.loadMesh&&s.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(s){return s.loadBufferView&&s.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(s){return s.loadMaterial&&s.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(s){return s.loadTexture&&s.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(s){return s.loadAnimation&&s.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(s,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[Dt.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(s,o){i.load(na.resolveURL(t.uri,n.path),s,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const n=t.byteLength||0,s=t.byteOffset||0;return i.slice(s,s+n)})}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Lf[n.type],a=la[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new Jt(c,o,l))}const s=[];return n.bufferView!==void 0?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),n.sparse!==void 0&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then(function(o){const a=o[0],l=Lf[n.type],c=la[n.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=n.byteOffset||0,d=n.bufferView!==void 0?i.bufferViews[n.bufferView].byteStride:void 0,m=n.normalized===!0;let A,p;if(d&&d!==h){const g=Math.floor(f/d),v="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count;let E=t.cache.get(v);E||(A=new c(a,g*d,n.count*d/u),E=new GI(A,d/u),t.cache.add(v,E)),p=new eo(E,l,f%d/u,m)}else a===null?A=new c(n.count*l):A=new c(a,f,n.count*l),p=new Jt(A,l,m);if(n.sparse!==void 0){const g=Lf.SCALAR,v=la[n.sparse.indices.componentType],E=n.sparse.indices.byteOffset||0,C=n.sparse.values.byteOffset||0,I=new v(o[1],E,n.sparse.count*g),_=new c(o[2],C,n.sparse.count*l);a!==null&&(p=new Jt(p.array.slice(),p.itemSize,p.normalized));for(let x=0,S=I.length;x<S;x++){const b=I[x];if(p.setX(b,_[x*l]),l>=2&&p.setY(b,_[x*l+1]),l>=3&&p.setZ(b,_[x*l+2]),l>=4&&p.setW(b,_[x*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(e){const t=this.json,i=this.options,s=t.textures[e].source,o=t.images[s];let a=this.textureLoader;if(o.uri){const l=i.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,s,a)}loadTextureImage(e,t,i){const n=this,s=this.json,o=s.textures[e],a=s.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,i).then(function(u){u.flipY=!1,u.name=o.name||a.name||"",u.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(u.name=a.uri);const f=(s.samplers||{})[o.sampler]||{};return u.magFilter=zg[f.magFilter]||jt,u.minFilter=zg[f.minFilter]||uc,u.wrapS=Hg[f.wrapS]||Ln,u.wrapT=Hg[f.wrapT]||Ln,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){const i=this,n=this.json,s=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=n.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1;if(o.bufferView!==void 0)l=i.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const f=new Blob([h],{type:o.mimeType});return l=a.createObjectURL(f),l});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(l).then(function(h){return new Promise(function(f,d){let m=f;t.isImageBitmapLoader===!0&&(m=function(A){const p=new tn(A);p.needsUpdate=!0,f(p)}),t.load(na.resolveURL(h,s.path),m,void 0,d)})}).then(function(h){return c===!0&&a.revokeObjectURL(l),er(h,o),h.userData.mimeType=o.mimeType||l6(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),h});return this.sourceCache[e]=u,u}assignTexture(e,t,i,n){const s=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),s.extensions[Dt.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[Dt.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=s.associations.get(o);o=s.extensions[Dt.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),s.associations.set(o,l)}}return n!==void 0&&(typeof n=="number"&&(n=n===Gg?io:ar),"colorSpace"in o?o.colorSpace=n:o.encoding=n===io?Gg:DT),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=t.attributes.tangent===void 0,s=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new P2,Uu.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,l.sizeAttenuation=!1,this.cache.add(a,l)),i=l}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new ia,Uu.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,this.cache.add(a,l)),i=l}if(n||s||o){let a="ClonedMaterial:"+i.uuid+":";n&&(a+="derivative-tangents:"),s&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=i.clone(),s&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(i))),i=l}e.material=i}getMaterialType(){return bh}loadMaterial(e){const t=this,i=this.json,n=this.extensions,s=i.materials[e];let o;const a={},l=s.extensions||{},c=[];if(l[Dt.KHR_MATERIALS_UNLIT]){const h=n[Dt.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(a,s,t))}else{const h=s.pbrMetallicRoughness||{};if(a.color=new et(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const f=h.baseColorFactor;a.color.setRGB(f[0],f[1],f[2],ar),a.opacity=f[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",h.baseColorTexture,io)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,a)})))}s.doubleSided===!0&&(a.side=wi);const u=s.alphaMode||Pf.OPAQUE;if(u===Pf.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===Pf.MASK&&(a.alphaTest=s.alphaCutoff!==void 0?s.alphaCutoff:.5)),s.normalTexture!==void 0&&o!==ms&&(c.push(t.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new Fe(1,1),s.normalTexture.scale!==void 0)){const h=s.normalTexture.scale;a.normalScale.set(h,h)}if(s.occlusionTexture!==void 0&&o!==ms&&(c.push(t.assignTexture(a,"aoMap",s.occlusionTexture)),s.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=s.occlusionTexture.strength)),s.emissiveFactor!==void 0&&o!==ms){const h=s.emissiveFactor;a.emissive=new et().setRGB(h[0],h[1],h[2],ar)}return s.emissiveTexture!==void 0&&o!==ms&&c.push(t.assignTexture(a,"emissiveMap",s.emissiveTexture,io)),Promise.all(c).then(function(){const h=new o(a);return s.name&&(h.name=s.name),er(h,s),t.associations.set(h,{materials:e}),s.extensions&&Kr(n,h,s),h})}createUniqueName(e){const t=jl.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function s(a){return i[Dt.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return Vg(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],u=a6(c),h=n[u];if(h)o.push(h.promise);else{let f;c.extensions&&c.extensions[Dt.KHR_DRACO_MESH_COMPRESSION]?f=s(c):f=Vg(new Gi,c,t),n[u]={primitive:c,promise:f},o.push(f)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,n=this.extensions,s=i.meshes[e],o=s.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const u=o[l].material===void 0?s6(this.cache):this.getDependency("material",o[l].material);a.push(u)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),u=l[l.length-1],h=[];for(let d=0,m=u.length;d<m;d++){const A=u[d],p=o[d];let g;const v=c[d];if(p.mode===Hn.TRIANGLES||p.mode===Hn.TRIANGLE_STRIP||p.mode===Hn.TRIANGLE_FAN||p.mode===void 0)g=s.isSkinnedMesh===!0?new km(A,v):new je(A,v),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),p.mode===Hn.TRIANGLE_STRIP?g.geometry=Lg(g.geometry,B2):p.mode===Hn.TRIANGLE_FAN&&(g.geometry=Lg(g.geometry,S0));else if(p.mode===Hn.LINES)g=new KI(A,v);else if(p.mode===Hn.LINE_STRIP)g=new Mt(A,v);else if(p.mode===Hn.LINE_LOOP)g=new $I(A,v);else if(p.mode===Hn.POINTS)g=new jI(A,v);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(g.geometry.morphAttributes).length>0&&o6(g,s),g.name=t.createUniqueName(s.name||"mesh_"+e),er(g,s),p.extensions&&Kr(n,g,p),t.assignFinalMaterial(g),h.push(g)}for(let d=0,m=h.length;d<m;d++)t.associations.set(h[d],{meshes:e,primitives:d});if(h.length===1)return s.extensions&&Kr(n,h[0],s),h[0];const f=new or;s.extensions&&Kr(n,f,s),t.associations.set(f,{meshes:e});for(let d=0,m=h.length;d<m;d++)f.add(h[d]);return f})}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new ri(ot.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):i.type==="orthographic"&&(t=new vi(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),er(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let n=0,s=t.joints.length;n<s;n++)i.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(n){const s=n.pop(),o=n,a=[],l=[];for(let c=0,u=o.length;c<u;c++){const h=o[c];if(h){a.push(h);const f=new Me;s!==null&&f.fromArray(s.array,c*16),l.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new F2(a,l)})}loadAnimation(e){const t=this.json,i=this,n=t.animations[e],s=n.name?n.name:"animation_"+e,o=[],a=[],l=[],c=[],u=[];for(let h=0,f=n.channels.length;h<f;h++){const d=n.channels[h],m=n.samplers[d.sampler],A=d.target,p=A.node,g=n.parameters!==void 0?n.parameters[m.input]:m.input,v=n.parameters!==void 0?n.parameters[m.output]:m.output;A.node!==void 0&&(o.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",g)),l.push(this.getDependency("accessor",v)),c.push(m),u.push(A))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(h){const f=h[0],d=h[1],m=h[2],A=h[3],p=h[4],g=[];for(let v=0,E=f.length;v<E;v++){const C=f[v],I=d[v],_=m[v],x=A[v],S=p[v];if(C===void 0)continue;C.updateMatrix&&C.updateMatrix();const b=i._createAnimationTracks(C,I,_,x,S);if(b)for(let T=0;T<b.length;T++)g.push(b[T])}return new Pm(s,void 0,g)})}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return n.mesh===void 0?null:i.getDependency("mesh",n.mesh).then(function(s){const o=i._getNodeRef(i.meshCache,n.mesh,s);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(e){const t=this.json,i=this,n=t.nodes[e],s=i._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,u=a.length;c<u;c++)o.push(i.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):i.getDependency("skin",n.skin);return Promise.all([s,Promise.all(o),l]).then(function(c){const u=c[0],h=c[1],f=c[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,c6)});for(let d=0,m=h.length;d<m;d++)u.add(h[d]);return u})}_loadNodeShallow(e){const t=this.json,i=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),s.camera!==void 0&&a.push(n.getDependency("camera",s.camera).then(function(c){return n._getNodeRef(n.cameraCache,s.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let u;if(s.isBone===!0?u=new b0:c.length>1?u=new or:c.length===1?u=c[0]:u=new Ei,u!==c[0])for(let h=0,f=c.length;h<f;h++)u.add(c[h]);if(s.name&&(u.userData.name=s.name,u.name=o),er(u,s),s.extensions&&Kr(i,u,s),s.matrix!==void 0){const h=new Me;h.fromArray(s.matrix),u.applyMatrix4(h)}else s.translation!==void 0&&u.position.fromArray(s.translation),s.rotation!==void 0&&u.quaternion.fromArray(s.rotation),s.scale!==void 0&&u.scale.fromArray(s.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,s=new or;i.name&&(s.name=n.createUniqueName(i.name)),er(s,i),i.extensions&&Kr(t,s,i);const o=i.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let u=0,h=l.length;u<h;u++)s.add(l[u]);const c=u=>{const h=new Map;for(const[f,d]of n.associations)(f instanceof Uu||f instanceof tn)&&h.set(f,d);return u.traverse(f=>{const d=n.associations.get(f);d!=null&&h.set(f,d)}),h};return n.associations=c(s),s})}_createAnimationTracks(e,t,i,n,s){const o=[],a=e.name?e.name:e.uuid,l=[];yr[s.path]===yr.weights?e.traverse(function(f){f.morphTargetInfluences&&l.push(f.name?f.name:f.uuid)}):l.push(a);let c;switch(yr[s.path]){case yr.weights:c=w0;break;case yr.rotation:c=th;break;case yr.position:case yr.scale:c=eh;break;default:switch(i.itemSize){case 1:c=w0;break;case 2:case 3:default:c=eh;break}break}const u=n.interpolation!==void 0?n6[n.interpolation]:k2,h=this._getArrayFromAccessor(i);for(let f=0,d=l.length;f<d;f++){const m=new c(l[f]+"."+yr[s.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),o.push(m)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=W0(t.constructor),n=new Float32Array(t.length);for(let s=0,o=t.length;s<o;s++)n[s]=t[s]*i;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const n=this instanceof th?i6:l3;return new n(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function h6(r,e,t){const i=e.attributes,n=new oi;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new K(l[0],l[1],l[2]),new K(c[0],c[1],c[2])),a.normalized){const u=W0(la[a.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const s=e.targets;if(s!==void 0){const a=new K,l=new K;for(let c=0,u=s.length;c<u;c++){const h=s[c];if(h.POSITION!==void 0){const f=t.json.accessors[h.POSITION],d=f.min,m=f.max;if(d!==void 0&&m!==void 0){if(l.setX(Math.max(Math.abs(d[0]),Math.abs(m[0]))),l.setY(Math.max(Math.abs(d[1]),Math.abs(m[1]))),l.setZ(Math.max(Math.abs(d[2]),Math.abs(m[2]))),f.normalized){const A=W0(la[f.componentType]);l.multiplyScalar(A)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}r.boundingBox=n;const o=new un;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,r.boundingSphere=o}function Vg(r,e,t){const i=e.attributes,n=[];function s(o,a){return t.getDependency("accessor",o).then(function(l){r.setAttribute(a,l)})}for(const o in i){const a=Y0[o]||o.toLowerCase();a in r.attributes||n.push(s(i[o],a))}if(e.indices!==void 0&&!r.index){const o=t.getDependency("accessor",e.indices).then(function(a){r.setIndex(a)});n.push(o)}return er(r,e),h6(r,e,t),Promise.all(n).then(function(){return e.targets!==void 0?r6(r,e.targets,t):r})}class f6 extends Gi{constructor(e,t,i,n){super();const s=[],o=[],a=[],l=new K,c=new Me;c.makeRotationFromEuler(i),c.setPosition(t);const u=new Me;u.copy(c).invert(),h(),this.setAttribute("position",new ji(s,3)),this.setAttribute("normal",new ji(o,3)),this.setAttribute("uv",new ji(a,2));function h(){let A,p=[];const g=new K,v=new K;if(e.geometry.isGeometry===!0){console.error("THREE.DecalGeometry no longer supports THREE.Geometry. Use BufferGeometry instead.");return}const E=e.geometry,C=E.attributes.position,I=E.attributes.normal;if(E.index!==null){const _=E.index;for(A=0;A<_.count;A++)g.fromBufferAttribute(C,_.getX(A)),v.fromBufferAttribute(I,_.getX(A)),f(p,g,v)}else for(A=0;A<C.count;A++)g.fromBufferAttribute(C,A),v.fromBufferAttribute(I,A),f(p,g,v);for(p=d(p,l.set(1,0,0)),p=d(p,l.set(-1,0,0)),p=d(p,l.set(0,1,0)),p=d(p,l.set(0,-1,0)),p=d(p,l.set(0,0,1)),p=d(p,l.set(0,0,-1)),A=0;A<p.length;A++){const _=p[A];a.push(.5+_.position.x/n.x,.5+_.position.y/n.y),_.position.applyMatrix4(c),s.push(_.position.x,_.position.y,_.position.z),o.push(_.normal.x,_.normal.y,_.normal.z)}}function f(A,p,g){p.applyMatrix4(e.matrixWorld),p.applyMatrix4(u),g.transformDirection(e.matrixWorld),A.push(new Kg(p.clone(),g.clone()))}function d(A,p){const g=[],v=.5*Math.abs(n.dot(p));for(let E=0;E<A.length;E+=3){let C,I,_,x=0,S,b,T,B;const w=A[E+0].position.dot(p)-v,R=A[E+1].position.dot(p)-v,D=A[E+2].position.dot(p)-v;switch(C=w>0,I=R>0,_=D>0,x=(C?1:0)+(I?1:0)+(_?1:0),x){case 0:{g.push(A[E]),g.push(A[E+1]),g.push(A[E+2]);break}case 1:{if(C&&(S=A[E+1],b=A[E+2],T=m(A[E],S,p,v),B=m(A[E],b,p,v)),I){S=A[E],b=A[E+2],T=m(A[E+1],S,p,v),B=m(A[E+1],b,p,v),g.push(T),g.push(b.clone()),g.push(S.clone()),g.push(b.clone()),g.push(T.clone()),g.push(B);break}_&&(S=A[E],b=A[E+1],T=m(A[E+2],S,p,v),B=m(A[E+2],b,p,v)),g.push(S.clone()),g.push(b.clone()),g.push(T),g.push(B),g.push(T.clone()),g.push(b.clone());break}case 2:{C||(S=A[E].clone(),b=m(S,A[E+1],p,v),T=m(S,A[E+2],p,v),g.push(S),g.push(b),g.push(T)),I||(S=A[E+1].clone(),b=m(S,A[E+2],p,v),T=m(S,A[E],p,v),g.push(S),g.push(b),g.push(T)),_||(S=A[E+2].clone(),b=m(S,A[E],p,v),T=m(S,A[E+1],p,v),g.push(S),g.push(b),g.push(T));break}}}return g}function m(A,p,g,v){const E=A.position.dot(g)-v,C=p.position.dot(g)-v,I=E/(E-C);return new Kg(new K(A.position.x+I*(p.position.x-A.position.x),A.position.y+I*(p.position.y-A.position.y),A.position.z+I*(p.position.z-A.position.z)),new K(A.normal.x+I*(p.normal.x-A.normal.x),A.normal.y+I*(p.normal.y-A.normal.y),A.normal.z+I*(p.normal.z-A.normal.z)))}}}class Kg{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}class d6 extends qI{constructor(e,t={}){const{bevelEnabled:i=!1,bevelSize:n=8,bevelThickness:s=10,font:o,height:a=50,size:l=100,lineHeight:c=1,letterSpacing:u=0,...h}=t;if(o===void 0)super();else{const f=o.generateShapes(e,l,{lineHeight:c,letterSpacing:u});super(f,{...h,bevelEnabled:i,bevelSize:n,bevelThickness:s,depth:a})}this.type="TextGeometry"}}const m6={uniforms:{tDiffuse:{value:null}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 tex = texture2D( tDiffuse, vUv );

    	#ifdef LinearTosRGB
    		gl_FragColor = LinearTosRGB( tex );
    	#else
    		gl_FragColor = sRGBTransferOETF( tex );
    	#endif

    }
  `},A6={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},p6={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `},kf=new O2,Of=new K,yo=new K,ls=new K,$s=new K,Es=new K,js=new K,Ys=new K,ja=new K,Ya=new K,Wa=new K,Oc=new K,qa=new K,Xa=new K,Ja=new K;class g6{constructor(e,t,i){this.camera=e,this.scene=t,this.startPoint=new K,this.endPoint=new K,this.collection=[],this.deep=i||Number.MAX_VALUE}select(e,t){return this.startPoint=e||this.startPoint,this.endPoint=t||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(kf,this.scene),this.collection}updateFrustum(e,t){if(e=e||this.startPoint,t=t||this.endPoint,e.x===t.x&&(t.x+=Number.EPSILON),e.y===t.y&&(t.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.isPerspectiveCamera){yo.copy(e),yo.x=Math.min(e.x,t.x),yo.y=Math.max(e.y,t.y),t.x=Math.max(e.x,t.x),t.y=Math.min(e.y,t.y),ls.setFromMatrixPosition(this.camera.matrixWorld),$s.copy(yo),Es.set(t.x,yo.y,0),js.copy(t),Ys.set(yo.x,t.y,0),$s.unproject(this.camera),Es.unproject(this.camera),js.unproject(this.camera),Ys.unproject(this.camera),qa.copy($s).sub(ls),Xa.copy(Es).sub(ls),Ja.copy(js).sub(ls),qa.normalize(),Xa.normalize(),Ja.normalize(),qa.multiplyScalar(this.deep),Xa.multiplyScalar(this.deep),Ja.multiplyScalar(this.deep),qa.add(ls),Xa.add(ls),Ja.add(ls);var i=kf.planes;i[0].setFromCoplanarPoints(ls,$s,Es),i[1].setFromCoplanarPoints(ls,Es,js),i[2].setFromCoplanarPoints(js,Ys,ls),i[3].setFromCoplanarPoints(Ys,$s,ls),i[4].setFromCoplanarPoints(Es,js,Ys),i[5].setFromCoplanarPoints(Ja,Xa,qa),i[5].normal.multiplyScalar(-1)}else if(this.camera.isOrthographicCamera){const n=Math.min(e.x,t.x),s=Math.max(e.y,t.y),o=Math.max(e.x,t.x),a=Math.min(e.y,t.y);$s.set(n,s,-1),Es.set(o,s,-1),js.set(o,a,-1),Ys.set(n,a,-1),ja.set(n,s,1),Ya.set(o,s,1),Wa.set(o,a,1),Oc.set(n,a,1),$s.unproject(this.camera),Es.unproject(this.camera),js.unproject(this.camera),Ys.unproject(this.camera),ja.unproject(this.camera),Ya.unproject(this.camera),Wa.unproject(this.camera),Oc.unproject(this.camera);var i=kf.planes;i[0].setFromCoplanarPoints($s,ja,Ya),i[1].setFromCoplanarPoints(Es,Ya,Wa),i[2].setFromCoplanarPoints(Wa,Oc,Ys),i[3].setFromCoplanarPoints(Oc,ja,$s),i[4].setFromCoplanarPoints(Es,js,Ys),i[5].setFromCoplanarPoints(Wa,Ya,ja),i[5].normal.multiplyScalar(-1)}else console.error("THREE.SelectionBox: Unsupported camera type.")}searchChildInFrustum(e,t){if((t.isMesh||t.isLine||t.isPoints)&&t.material!==void 0&&(t.geometry.boundingSphere===null&&t.geometry.computeBoundingSphere(),Of.copy(t.geometry.boundingSphere.center),Of.applyMatrix4(t.matrixWorld),e.containsPoint(Of)&&this.collection.push(t)),t.children.length>0)for(let i=0;i<t.children.length;i++)this.searchChildInFrustum(e,t.children[i])}}class y6{constructor(e,t=" .:-=+*#%@",i={}){const n=i.resolution||.15,s=i.scale||1,o=i.color||!1,a=i.alpha||!1,l=i.block||!1,c=i.invert||!1,u=i.strResolution||"low";let h,f;const d=document.createElement("div");d.style.cursor="default";const m=document.createElement("table");d.appendChild(m);let A,p,g;this.setSize=function(D,G){h=D,f=G,e.setSize(D,G),v()},this.render=function(D,G){e.render(D,G),R(m)},this.domElement=d;function v(){A=Math.floor(h*n),p=Math.floor(f*n),x.width=A,x.height=p,g=e.domElement,g.style.backgroundColor&&(m.rows[0].cells[0].style.backgroundColor=g.style.backgroundColor,m.rows[0].cells[0].style.color=g.style.color),m.cellSpacing=0,m.cellPadding=0;const D=m.style;D.whiteSpace="pre",D.margin="0px",D.padding="0px",D.letterSpacing=w+"px",D.fontFamily=I,D.fontSize=T+"px",D.lineHeight=B+"px",D.textAlign="left",D.textDecoration="none"}const E=" .,:;i1tfLCG08@".split(""),C=" CGO08@".split(""),I="courier new, monospace",_=e.domElement,x=document.createElement("canvas");if(!x.getContext)return;const S=x.getContext("2d");if(!S.getImageData)return;let b=o?C:E;t&&(b=t);const T=2/n*s,B=2/n*s;let w=0;if(u=="low")switch(s){case 1:w=-1;break;case 2:case 3:w=-2.1;break;case 4:w=-3.1;break;case 5:w=-4.15;break}if(u=="medium")switch(s){case 1:w=0;break;case 2:w=-1;break;case 3:w=-1.04;break;case 4:case 5:w=-2.1;break}if(u=="high")switch(s){case 1:case 2:w=0;break;case 3:case 4:case 5:w=-1;break}function R(D){S.clearRect(0,0,A,p),S.drawImage(_,0,0,A,p);const G=S.getImageData(0,0,A,p).data;let z="";for(let W=0;W<p;W+=2){for(let q=0;q<A;q++){const F=(W*A+q)*4,N=G[F],L=G[F+1],$=G[F+2],j=G[F+3];let V,k;k=(.3*N+.59*L+.11*$)/255,j==0&&(k=1),V=Math.floor((1-k)*(b.length-1)),c&&(V=b.length-V-1);let Q=b[V];(Q===void 0||Q==" ")&&(Q="&nbsp;"),o?z+="<span style='color:rgb("+N+","+L+","+$+");"+(l?"background-color:rgb("+N+","+L+","+$+");":"")+(a?"opacity:"+j/255+";":"")+"'>"+Q+"</span>":z+=Q}z+="<br/>"}D.innerHTML=`<tr><td style="display:block;width:${h}px;height:${f}px;overflow:hidden">${z}</td></tr>`}}}function c3(r,e,t){const i=t.length-r-1;if(e>=t[i])return i-1;if(e<=t[r])return r;let n=r,s=i,o=Math.floor((n+s)/2);for(;e<t[o]||e>=t[o+1];)e<t[o]?s=o:n=o,o=Math.floor((n+s)/2);return o}function v6(r,e,t,i){const n=[],s=[],o=[];n[0]=1;for(let a=1;a<=t;++a){s[a]=e-i[r+1-a],o[a]=i[r+a]-e;let l=0;for(let c=0;c<a;++c){const u=o[c+1],h=s[a-c],f=n[c]/(u+h);n[c]=l+u*f,l=h*f}n[a]=l}return n}function E6(r,e,t,i){const n=c3(r,i,e),s=v6(n,i,r,e),o=new Ci(0,0,0,0);for(let a=0;a<=r;++a){const l=t[n-r+a],c=s[a],u=l.w*c;o.x+=l.x*u,o.y+=l.y*u,o.z+=l.z*u,o.w+=l.w*c}return o}function C6(r,e,t,i,n){const s=[];for(let h=0;h<=t;++h)s[h]=0;const o=[];for(let h=0;h<=i;++h)o[h]=s.slice(0);const a=[];for(let h=0;h<=t;++h)a[h]=s.slice(0);a[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let h=1;h<=t;++h){l[h]=e-n[r+1-h],c[h]=n[r+h]-e;let f=0;for(let d=0;d<h;++d){const m=c[d+1],A=l[h-d];a[h][d]=m+A;const p=a[d][h-1]/a[h][d];a[d][h]=f+m*p,f=A*p}a[h][h]=f}for(let h=0;h<=t;++h)o[0][h]=a[h][t];for(let h=0;h<=t;++h){let f=0,d=1;const m=[];for(let A=0;A<=t;++A)m[A]=s.slice(0);m[0][0]=1;for(let A=1;A<=i;++A){let p=0;const g=h-A,v=t-A;h>=A&&(m[d][0]=m[f][0]/a[v+1][g],p=m[d][0]*a[g][v]);const E=g>=-1?1:-g,C=h-1<=v?A-1:t-h;for(let _=E;_<=C;++_)m[d][_]=(m[f][_]-m[f][_-1])/a[v+1][g+_],p+=m[d][_]*a[g+_][v];h<=v&&(m[d][A]=-m[f][A-1]/a[v+1][h],p+=m[d][A]*a[h][v]),o[A][h]=p;const I=f;f=d,d=I}}let u=t;for(let h=1;h<=i;++h){for(let f=0;f<=t;++f)o[h][f]*=u;u*=t-h}return o}function I6(r,e,t,i,n){const s=n<r?n:r,o=[],a=c3(r,i,e),l=C6(a,i,r,s,e),c=[];for(let u=0;u<t.length;++u){const h=t[u].clone(),f=h.w;h.x*=f,h.y*=f,h.z*=f,c[u]=h}for(let u=0;u<=s;++u){const h=c[a-r].clone().multiplyScalar(l[u][0]);for(let f=1;f<=r;++f)h.add(c[a-r+f].clone().multiplyScalar(l[u][f]));o[u]=h}for(let u=s+1;u<=n+1;++u)o[u]=new Ci(0,0,0);return o}function _6(r,e){let t=1;for(let n=2;n<=r;++n)t*=n;let i=1;for(let n=2;n<=e;++n)i*=n;for(let n=2;n<=r-e;++n)i*=n;return t/i}function x6(r){const e=r.length,t=[],i=[];for(let s=0;s<e;++s){const o=r[s];t[s]=new K(o.x,o.y,o.z),i[s]=o.w}const n=[];for(let s=0;s<e;++s){const o=t[s].clone();for(let a=1;a<=s;++a)o.sub(n[s-a].clone().multiplyScalar(_6(s,a)*i[a]));n[s]=o.divideScalar(i[0])}return n}function S6(r,e,t,i,n){const s=I6(r,e,t,i,n);return x6(s)}class $g extends XI{constructor(e,t,i,n,s){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=s||this.knots.length-1;for(let o=0;o<i.length;++o){const a=i[o];this.controlPoints[o]=new Ci(a.x,a.y,a.z,a.w)}}getPoint(e,t){const i=t||new K,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),s=E6(this.degree,this.knots,this.controlPoints,n);return s.w!=1&&s.divideScalar(s.w),i.set(s.x,s.y,s.z)}getTangent(e,t){const i=t||new K,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),s=S6(this.degree,this.knots,this.controlPoints,n,1);return i.copy(s[1]).normalize(),i}}let Rt,Ti,yn;class cA extends Ur{constructor(e){super(e)}load(e,t,i,n){const s=this,o=s.path===""?na.extractUrlBase(e):s.path,a=new In(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(e,function(l){try{t(s.parse(l,o))}catch(c){n?n(c):console.error(c),s.manager.itemError(e)}},i,n)}parse(e,t){if(D6(e))Rt=new R6().parse(e);else{const n=d3(e);if(!M6(n))throw new Error("THREE.FBXLoader: Unknown format.");if(Yg(n)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Yg(n));Rt=new B6().parse(n)}const i=new lr(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new T6(i,this.manager).parse(Rt)}}class T6{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Ti=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),i=this.parseMaterials(t),n=this.parseDeformers(),s=new b6().parse(n);return this.parseScene(n,s,i),yn}parseConnections(){const e=new Map;return"Connections"in Rt&&Rt.Connections.connections.forEach(function(i){const n=i[0],s=i[1],o=i[2];e.has(n)||e.set(n,{parents:[],children:[]});const a={ID:s,relationship:o};e.get(n).parents.push(a),e.has(s)||e.set(s,{parents:[],children:[]});const l={ID:n,relationship:o};e.get(s).children.push(l)}),e}parseImages(){const e={},t={};if("Video"in Rt.Objects){const i=Rt.Objects.Video;for(const n in i){const s=i[n],o=parseInt(n);if(e[o]=s.RelativeFilename||s.Filename,"Content"in s){const a=s.Content instanceof ArrayBuffer&&s.Content.byteLength>0,l=typeof s.Content=="string"&&s.Content!=="";if(a||l){const c=this.parseImage(i[n]);t[s.RelativeFilename||s.Filename]=c}}}}for(const i in e){const n=e[i];t[n]!==void 0?e[i]=t[n]:e[i]=e[i].split("\\").pop()}return e}parseImage(e){const t=e.Content,i=e.RelativeFilename||e.Filename,n=i.slice(i.lastIndexOf(".")+1).toLowerCase();let s;switch(n){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",i),s="image/tga";break;default:console.warn('FBXLoader: Image type "'+n+'" is not supported.');return}if(typeof t=="string")return"data:"+s+";base64,"+t;{const o=new Uint8Array(t);return window.URL.createObjectURL(new Blob([o],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in Rt.Objects){const i=Rt.Objects.Texture;for(const n in i){const s=this.parseTexture(i[n],e);t.set(parseInt(n),s)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const n=e.WrapModeU,s=e.WrapModeV,o=n!==void 0?n.value:0,a=s!==void 0?s.value:0;if(i.wrapS=o===0?Ln:Bn,i.wrapT=a===0?Ln:Bn,"Scaling"in e){const l=e.Scaling.value;i.repeat.x=l[0],i.repeat.y=l[1]}return i}loadTexture(e,t){let i;const n=this.textureLoader.path,s=Ti.get(e.id).children;s!==void 0&&s.length>0&&t[s[0].ID]!==void 0&&(i=t[s[0].ID],(i.indexOf("blob:")===0||i.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const a=e.FileName.slice(-3).toLowerCase();if(a==="tga"){const l=this.manager.getHandler(".tga");l===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new tn):(l.setPath(this.textureLoader.path),o=l.load(i))}else a==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new tn):o=this.textureLoader.load(i);return this.textureLoader.setPath(n),o}parseMaterials(e){const t=new Map;if("Material"in Rt.Objects){const i=Rt.Objects.Material;for(const n in i){const s=this.parseMaterial(i[n],e);s!==null&&t.set(parseInt(n),s)}}return t}parseMaterial(e,t){const i=e.id,n=e.attrName;let s=e.ShadingModel;if(typeof s=="object"&&(s=s.value),!Ti.has(i))return null;const o=this.parseParameters(e,t,i);let a;switch(s.toLowerCase()){case"phong":a=new pf;break;case"lambert":a=new Om;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),a=new pf;break}return a.setValues(o),a.name=n,a}parseParameters(e,t,i){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=new et().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(n.color=new et().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=new et().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(n.emissive=new et().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(n.opacity=parseFloat(e.Opacity.value)),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=new et().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(n.specular=new et().fromArray(e.SpecularColor.value));const s=this;return Ti.get(i).children.forEach(function(o){const a=o.relationship;switch(a){case"Bump":n.bumpMap=s.getTexture(t,o.ID);break;case"Maya|TEX_ao_map":n.aoMap=s.getTexture(t,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=s.getTexture(t,o.ID),n.map!==void 0&&("colorSpace"in n.map?n.map.colorSpace="srgb":n.map.encoding=3001);break;case"DisplacementColor":n.displacementMap=s.getTexture(t,o.ID);break;case"EmissiveColor":n.emissiveMap=s.getTexture(t,o.ID),n.emissiveMap!==void 0&&("colorSpace"in n.emissiveMap?n.emissiveMap.colorSpace="srgb":n.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=s.getTexture(t,o.ID);break;case"ReflectionColor":n.envMap=s.getTexture(t,o.ID),n.envMap!==void 0&&(n.envMap.mapping=U2,"colorSpace"in n.envMap?n.envMap.colorSpace="srgb":n.envMap.encoding=3001);break;case"SpecularColor":n.specularMap=s.getTexture(t,o.ID),n.specularMap!==void 0&&("colorSpace"in n.specularMap?n.specularMap.colorSpace="srgb":n.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=s.getTexture(t,o.ID),n.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a);break}}),n}getTexture(e,t){return"LayeredTexture"in Rt.Objects&&t in Rt.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Ti.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Rt.Objects){const i=Rt.Objects.Deformer;for(const n in i){const s=i[n],o=Ti.get(parseInt(n));if(s.attrType==="Skin"){const a=this.parseSkeleton(o,i);a.ID=n,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=o.parents[0].ID,e[n]=a}else if(s.attrType==="BlendShape"){const a={id:n};a.rawTargets=this.parseMorphTargets(o,i),a.id=n,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[n]=a}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach(function(n){const s=t[n.ID];if(s.attrType!=="Cluster")return;const o={ID:n.ID,indices:[],weights:[],transformLink:new Me().fromArray(s.TransformLink.a)};"Indexes"in s&&(o.indices=s.Indexes.a,o.weights=s.Weights.a),i.push(o)}),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const i=[];for(let n=0;n<e.children.length;n++){const s=e.children[n],o=t[s.ID],a={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;a.geoID=Ti.get(parseInt(s.ID)).children.filter(function(l){return l.relationship===void 0})[0].ID,i.push(a)}return i}parseScene(e,t,i){yn=new or;const n=this.parseModels(e.skeletons,t,i),s=Rt.Objects.Model,o=this;n.forEach(function(l){const c=s[l.ID];o.setLookAtProperties(l,c),Ti.get(l.ID).parents.forEach(function(h){const f=n.get(h.ID);f!==void 0&&f.add(l)}),l.parent===null&&yn.add(l)}),this.bindSkeleton(e.skeletons,t,n),this.createAmbientLight(),yn.traverse(function(l){if(l.userData.transformData){l.parent&&(l.userData.transformData.parentMatrix=l.parent.matrix,l.userData.transformData.parentMatrixWorld=l.parent.matrixWorld);const c=h3(l.userData.transformData);l.applyMatrix4(c),l.updateWorldMatrix()}});const a=new w6().parse();yn.children.length===1&&yn.children[0].isGroup&&(yn.children[0].animations=a,yn=yn.children[0]),yn.animations=a}parseModels(e,t,i){const n=new Map,s=Rt.Objects.Model;for(const o in s){const a=parseInt(o),l=s[o],c=Ti.get(a);let u=this.buildSkeleton(c,e,a,l.attrName);if(!u){switch(l.attrType){case"Camera":u=this.createCamera(c);break;case"Light":u=this.createLight(c);break;case"Mesh":u=this.createMesh(c,t,i);break;case"NurbsCurve":u=this.createCurve(c,t);break;case"LimbNode":case"Root":u=new b0;break;case"Null":default:u=new or;break}u.name=l.attrName?jl.sanitizeNodeName(l.attrName):"",u.ID=a}this.getTransformData(u,l),n.set(a,u)}return n}buildSkeleton(e,t,i,n){let s=null;return e.parents.forEach(function(o){for(const a in t){const l=t[a];l.rawBones.forEach(function(c,u){if(c.ID===o.ID){const h=s;s=new b0,s.matrixWorld.copy(c.transformLink),s.name=n?jl.sanitizeNodeName(n):"",s.ID=i,l.bones[u]=s,h!==null&&s.add(h)}})}}),s}createCamera(e){let t,i;if(e.children.forEach(function(n){const s=Rt.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new Ei;else{let n=0;i.CameraProjectionType!==void 0&&i.CameraProjectionType.value===1&&(n=1);let s=1;i.NearPlane!==void 0&&(s=i.NearPlane.value/1e3);let o=1e3;i.FarPlane!==void 0&&(o=i.FarPlane.value/1e3);let a=window.innerWidth,l=window.innerHeight;i.AspectWidth!==void 0&&i.AspectHeight!==void 0&&(a=i.AspectWidth.value,l=i.AspectHeight.value);const c=a/l;let u=45;i.FieldOfView!==void 0&&(u=i.FieldOfView.value);const h=i.FocalLength?i.FocalLength.value:null;switch(n){case 0:t=new ri(u,c,s,o),h!==null&&t.setFocalLength(h);break;case 1:t=new vi(-a/2,a/2,l/2,-l/2,s,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+n+"."),t=new Ei;break}}return t}createLight(e){let t,i;if(e.children.forEach(function(n){const s=Rt.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new Ei;else{let n;i.LightType===void 0?n=0:n=i.LightType.value;let s=16777215;i.Color!==void 0&&(s=new et().fromArray(i.Color.value));let o=i.Intensity===void 0?1:i.Intensity.value/100;i.CastLightOnObject!==void 0&&i.CastLightOnObject.value===0&&(o=0);let a=0;i.FarAttenuationEnd!==void 0&&(i.EnableFarAttenuation!==void 0&&i.EnableFarAttenuation.value===0?a=0:a=i.FarAttenuationEnd.value);const l=1;switch(n){case 0:t=new T0(s,o,a,l);break;case 1:t=new L2(s,o);break;case 2:let c=Math.PI/3;i.InnerAngle!==void 0&&(c=ot.degToRad(i.InnerAngle.value));let u=0;i.OuterAngle!==void 0&&(u=ot.degToRad(i.OuterAngle.value),u=Math.max(u,1)),t=new M2(s,o,a,c,u,l);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new T0(s,o);break}i.CastShadows!==void 0&&i.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,i){let n,s=null,o=null;const a=[];return e.children.forEach(function(l){t.has(l.ID)&&(s=t.get(l.ID)),i.has(l.ID)&&a.push(i.get(l.ID))}),a.length>1?o=a:a.length>0?o=a[0]:(o=new pf({color:13421772}),a.push(o)),"color"in s.attributes&&a.forEach(function(l){l.vertexColors=!0}),s.FBX_Deformer?(n=new km(s,o),n.normalizeSkinWeights()):n=new je(s,o),n}createCurve(e,t){const i=e.children.reduce(function(s,o){return t.has(o.ID)&&(s=t.get(o.ID)),s},null),n=new ia({color:3342591,linewidth:1});return new Mt(i,n)}getTransformData(e,t){const i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?i.eulerOrder=f3(t.RotationOrder.value):i.eulerOrder="ZYX","Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i}setLookAtProperties(e,t){"LookAtProperty"in t&&Ti.get(e.ID).children.forEach(function(n){if(n.relationship==="LookAtProperty"){const s=Rt.Objects.Model[n.ID];if("Lcl_Translation"in s){const o=s.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),yn.add(e.target)):e.lookAt(new K().fromArray(o))}}})}bindSkeleton(e,t,i){const n=this.parsePoseNodes();for(const s in e){const o=e[s];Ti.get(parseInt(o.ID)).parents.forEach(function(l){if(t.has(l.ID)){const c=l.ID;Ti.get(c).parents.forEach(function(h){i.has(h.ID)&&i.get(h.ID).bind(new F2(o.bones),n[h.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in Rt.Objects){const t=Rt.Objects.Pose;for(const i in t)if(t[i].attrType==="BindPose"&&t[i].NbPoseNodes>0){const n=t[i].PoseNode;Array.isArray(n)?n.forEach(function(s){e[s.Node]=new Me().fromArray(s.Matrix.a)}):e[n.Node]=new Me().fromArray(n.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Rt&&"AmbientColor"in Rt.GlobalSettings){const e=Rt.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],n=e[2];if(t!==0||i!==0||n!==0){const s=new et(t,i,n);yn.add(new JI(s,1))}}}}class b6{parse(e){const t=new Map;if("Geometry"in Rt.Objects){const i=Rt.Objects.Geometry;for(const n in i){const s=Ti.get(parseInt(n)),o=this.parseGeometry(s,i[n],e);t.set(parseInt(n),o)}}return t}parseGeometry(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,i){const n=i.skeletons,s=[],o=e.parents.map(function(h){return Rt.Objects.Model[h.ID]});if(o.length===0)return;const a=e.children.reduce(function(h,f){return n[f.ID]!==void 0&&(h=n[f.ID]),h},null);e.children.forEach(function(h){i.morphTargets[h.ID]!==void 0&&s.push(i.morphTargets[h.ID])});const l=o[0],c={};"RotationOrder"in l&&(c.eulerOrder=f3(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);const u=h3(c);return this.genGeometry(t,a,s,u)}genGeometry(e,t,i,n){const s=new Gi;e.attrName&&(s.name=e.attrName);const o=this.parseGeoNode(e,t),a=this.genBuffers(o),l=new ji(a.vertex,3);if(l.applyMatrix4(n),s.setAttribute("position",l),a.colors.length>0&&s.setAttribute("color",new ji(a.colors,3)),t&&(s.setAttribute("skinIndex",new ZI(a.weightsIndices,4)),s.setAttribute("skinWeight",new ji(a.vertexWeights,4)),s.FBX_Deformer=t),a.normal.length>0){const c=new bn().getNormalMatrix(n),u=new ji(a.normal,3);u.applyNormalMatrix(c),s.setAttribute("normal",u)}if(a.uvs.forEach(function(c,u){aA==="uv2"&&u++;const h=u===0?"uv":`uv${u}`;s.setAttribute(h,new ji(a.uvs[u],2))}),o.material&&o.material.mappingType!=="AllSame"){let c=a.materialIndex[0],u=0;if(a.materialIndex.forEach(function(h,f){h!==c&&(s.addGroup(u,f-u,c),c=h,u=f)}),s.groups.length>0){const h=s.groups[s.groups.length-1],f=h.start+h.count;f!==a.materialIndex.length&&s.addGroup(f,a.materialIndex.length-f,c)}s.groups.length===0&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,e,i,n),s}parseGeoNode(e,t){const i={};if(i.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],i.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];let n=0;for(;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return i.weightTable={},t!==null&&(i.skeleton=t,t.rawBones.forEach(function(n,s){n.indices.forEach(function(o,a){i.weightTable[o]===void 0&&(i.weightTable[o]=[]),i.weightTable[o].push({id:s,weight:n.weights[a]})})})),i}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,n=0,s=!1,o=[],a=[],l=[],c=[],u=[],h=[];const f=this;return e.vertexIndices.forEach(function(d,m){let A,p=!1;d<0&&(d=d^-1,p=!0);let g=[],v=[];if(o.push(d*3,d*3+1,d*3+2),e.color){const E=Uc(m,i,d,e.color);l.push(E[0],E[1],E[2])}if(e.skeleton){if(e.weightTable[d]!==void 0&&e.weightTable[d].forEach(function(E){v.push(E.weight),g.push(E.id)}),v.length>4){s||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),s=!0);const E=[0,0,0,0],C=[0,0,0,0];v.forEach(function(I,_){let x=I,S=g[_];C.forEach(function(b,T,B){if(x>b){B[T]=x,x=b;const w=E[T];E[T]=S,S=w}})}),g=E,v=C}for(;v.length<4;)v.push(0),g.push(0);for(let E=0;E<4;++E)u.push(v[E]),h.push(g[E])}if(e.normal){const E=Uc(m,i,d,e.normal);a.push(E[0],E[1],E[2])}e.material&&e.material.mappingType!=="AllSame"&&(A=Uc(m,i,d,e.material)[0]),e.uv&&e.uv.forEach(function(E,C){const I=Uc(m,i,d,E);c[C]===void 0&&(c[C]=[]),c[C].push(I[0]),c[C].push(I[1])}),n++,p&&(f.genFace(t,e,o,A,a,l,c,u,h,n),i++,n=0,o=[],a=[],l=[],c=[],u=[],h=[])}),t}genFace(e,t,i,n,s,o,a,l,c,u){for(let h=2;h<u;h++)e.vertex.push(t.vertexPositions[i[0]]),e.vertex.push(t.vertexPositions[i[1]]),e.vertex.push(t.vertexPositions[i[2]]),e.vertex.push(t.vertexPositions[i[(h-1)*3]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+1]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+2]]),e.vertex.push(t.vertexPositions[i[h*3]]),e.vertex.push(t.vertexPositions[i[h*3+1]]),e.vertex.push(t.vertexPositions[i[h*3+2]]),t.skeleton&&(e.vertexWeights.push(l[0]),e.vertexWeights.push(l[1]),e.vertexWeights.push(l[2]),e.vertexWeights.push(l[3]),e.vertexWeights.push(l[(h-1)*4]),e.vertexWeights.push(l[(h-1)*4+1]),e.vertexWeights.push(l[(h-1)*4+2]),e.vertexWeights.push(l[(h-1)*4+3]),e.vertexWeights.push(l[h*4]),e.vertexWeights.push(l[h*4+1]),e.vertexWeights.push(l[h*4+2]),e.vertexWeights.push(l[h*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(h-1)*4]),e.weightsIndices.push(c[(h-1)*4+1]),e.weightsIndices.push(c[(h-1)*4+2]),e.weightsIndices.push(c[(h-1)*4+3]),e.weightsIndices.push(c[h*4]),e.weightsIndices.push(c[h*4+1]),e.weightsIndices.push(c[h*4+2]),e.weightsIndices.push(c[h*4+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(h-1)*3]),e.colors.push(o[(h-1)*3+1]),e.colors.push(o[(h-1)*3+2]),e.colors.push(o[h*3]),e.colors.push(o[h*3+1]),e.colors.push(o[h*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(s[0]),e.normal.push(s[1]),e.normal.push(s[2]),e.normal.push(s[(h-1)*3]),e.normal.push(s[(h-1)*3+1]),e.normal.push(s[(h-1)*3+2]),e.normal.push(s[h*3]),e.normal.push(s[h*3+1]),e.normal.push(s[h*3+2])),t.uv&&t.uv.forEach(function(f,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(a[d][0]),e.uvs[d].push(a[d][1]),e.uvs[d].push(a[d][(h-1)*2]),e.uvs[d].push(a[d][(h-1)*2+1]),e.uvs[d].push(a[d][h*2]),e.uvs[d].push(a[d][h*2+1])})}addMorphTargets(e,t,i,n){if(i.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const s=this;i.forEach(function(o){o.rawTargets.forEach(function(a){const l=Rt.Objects.Geometry[a.geoID];l!==void 0&&s.genMorphGeometry(e,t,l,n,a.name)})})}genMorphGeometry(e,t,i,n,s){const o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],a=i.Vertices!==void 0?i.Vertices.a:[],l=i.Indexes!==void 0?i.Indexes.a:[],c=e.attributes.position.count*3,u=new Float32Array(c);for(let m=0;m<l.length;m++){const A=l[m]*3;u[A]=a[m*3],u[A+1]=a[m*3+1],u[A+2]=a[m*3+2]}const h={vertexIndices:o,vertexPositions:u},f=this.genBuffers(h),d=new ji(f.vertex,3);d.name=s||i.attrName,d.applyMatrix4(n),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Normals.a;let s=[];return i==="IndexToDirect"&&("NormalIndex"in e?s=e.NormalIndex.a:"NormalsIndex"in e&&(s=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:s,mappingType:t,referenceType:i}}parseUVs(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.UV.a;let s=[];return i==="IndexToDirect"&&(s=e.UVIndex.a),{dataSize:2,buffer:n,indices:s,mappingType:t,referenceType:i}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Colors.a;let s=[];return i==="IndexToDirect"&&(s=e.ColorIndex.a),{dataSize:4,buffer:n,indices:s,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,i=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const n=e.Materials.a,s=[];for(let o=0;o<n.length;++o)s.push(o);return{dataSize:1,buffer:n,indices:s,mappingType:t,referenceType:i}}parseNurbsGeometry(e){if($g===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new Gi;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new Gi;const i=t-1,n=e.KnotVector.a,s=[],o=e.Points.a;for(let h=0,f=o.length;h<f;h+=4)s.push(new Ci().fromArray(o,h));let a,l;if(e.Form==="Closed")s.push(s[0]);else if(e.Form==="Periodic"){a=i,l=n.length-1-a;for(let h=0;h<i;++h)s.push(s[h])}const u=new $g(i,n,s,a,l).getPoints(s.length*12);return new Gi().setFromPoints(u)}}class w6{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const i in t){const n=t[i],s=this.addClip(n);e.push(s)}return e}parseClips(){if(Rt.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Rt.Objects.AnimationCurveNode,t=new Map;for(const i in e){const n=e[i];if(n.attrName.match(/S|R|T|DeformPercent/)!==null){const s={id:n.id,attr:n.attrName,curves:{}};t.set(s.id,s)}}return t}parseAnimationCurves(e){const t=Rt.Objects.AnimationCurve;for(const i in t){const n={id:t[i].id,times:t[i].KeyTime.a.map(L6),values:t[i].KeyValueFloat.a},s=Ti.get(n.id);if(s!==void 0){const o=s.parents[0].ID,a=s.parents[0].relationship;a.match(/X/)?e.get(o).curves.x=n:a.match(/Y/)?e.get(o).curves.y=n:a.match(/Z/)?e.get(o).curves.z=n:a.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=n)}}}parseAnimationLayers(e){const t=Rt.Objects.AnimationLayer,i=new Map;for(const n in t){const s=[],o=Ti.get(parseInt(n));o!==void 0&&(o.children.forEach(function(l,c){if(e.has(l.ID)){const u=e.get(l.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(s[c]===void 0){const h=Ti.get(l.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(h!==void 0){const f=Rt.Objects.Model[h.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",l);return}const d={modelName:f.attrName?jl.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};yn.traverse(function(m){m.ID===f.id&&(d.transform=m.matrix,m.userData.transformData&&(d.eulerOrder=m.userData.transformData.eulerOrder))}),d.transform||(d.transform=new Me),"PreRotation"in f&&(d.preRotation=f.PreRotation.value),"PostRotation"in f&&(d.postRotation=f.PostRotation.value),s[c]=d}}s[c]&&(s[c][u.attr]=u)}else if(u.curves.morph!==void 0){if(s[c]===void 0){const h=Ti.get(l.ID).parents.filter(function(g){return g.relationship!==void 0})[0].ID,f=Ti.get(h).parents[0].ID,d=Ti.get(f).parents[0].ID,m=Ti.get(d).parents[0].ID,A=Rt.Objects.Model[m],p={modelName:A.attrName?jl.sanitizeNodeName(A.attrName):"",morphName:Rt.Objects.Deformer[h].attrName};s[c]=p}s[c][u.attr]=u}}}),i.set(parseInt(n),s))}return i}parseAnimStacks(e){const t=Rt.Objects.AnimationStack,i={};for(const n in t){const s=Ti.get(parseInt(n)).children;s.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(s[0].ID);i[n]={name:t[n].attrName,layer:o}}return i}addClip(e){let t=[];const i=this;return e.layer.forEach(function(n){t=t.concat(i.generateTracks(n))}),new Pm(e.name,-1,t)}generateTracks(e){const t=[];let i=new K,n=new ht,s=new K;if(e.transform&&e.transform.decompose(i,n,s),i=i.toArray(),n=new Wn().setFromQuaternion(n,e.eulerOrder).toArray(),s=s.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");o!==void 0&&t.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&t.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&t.push(o)}return t}generateVectorTrack(e,t,i,n){const s=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(s,t,i);return new eh(e+"."+n,s,o)}generateRotationTrack(e,t,i,n,s,o){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(ot.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(ot.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(ot.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,i);n!==void 0&&(n=n.map(ot.degToRad),n.push(o),n=new Wn().fromArray(n),n=new ht().setFromEuler(n)),s!==void 0&&(s=s.map(ot.degToRad),s.push(o),s=new Wn().fromArray(s),s=new ht().setFromEuler(s).invert());const c=new ht,u=new Wn,h=[];for(let f=0;f<l.length;f+=3)u.set(l[f],l[f+1],l[f+2],o),c.setFromEuler(u),n!==void 0&&c.premultiply(n),s!==void 0&&c.multiply(s),c.toArray(h,f/3*4);return new th(e+".quaternion",a,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map(function(s){return s/100}),n=yn.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new w0(e.modelName+".morphTargetInfluences["+n+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(i,n){return i-n}),t.length>1){let i=1,n=t[0];for(let s=1;s<t.length;s++){const o=t[s];o!==n&&(t[i]=o,n=o,i++)}t=t.slice(0,i)}return t}getKeyframeTrackValues(e,t,i){const n=i,s=[];let o=-1,a=-1,l=-1;return e.forEach(function(c){if(t.x&&(o=t.x.times.indexOf(c)),t.y&&(a=t.y.times.indexOf(c)),t.z&&(l=t.z.times.indexOf(c)),o!==-1){const u=t.x.values[o];s.push(u),n[0]=u}else s.push(n[0]);if(a!==-1){const u=t.y.values[a];s.push(u),n[1]=u}else s.push(n[1]);if(l!==-1){const u=t.z.values[l];s.push(u),n[2]=u}else s.push(n[2])}),s}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const i=e.values[t-1],n=e.values[t]-i,s=Math.abs(n);if(s>=180){const o=s/180,a=n/o;let l=i+a;const c=e.times[t-1],h=(e.times[t]-c)/o;let f=c+h;const d=[],m=[];for(;f<e.times[t];)d.push(f),f+=h,m.push(l),l+=a;e.times=Wg(e.times,t,d),e.values=Wg(e.values,t,m)}}}}class B6{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new u3,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,i=e.split(/[\r\n]+/);return i.forEach(function(n,s){const o=n.match(/^[\s\t]*;/),a=n.match(/^[\s\t]*$/);if(o||a)return;const l=n.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),c=n.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=n.match("^\\t{"+(t.currentIndent-1)+"}}");l?t.parseNodeBegin(n,l):c?t.parseNodeProperty(n,c,i[++s]):u?t.popStack():n.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(n)}),this.allNodes}parseNodeBegin(e,t){const i=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(l){return l.trim().replace(/^"/,"").replace(/"$/,"")}),s={name:i},o=this.parseNodeAttr(n),a=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(i,s):i in a?(i==="PoseNode"?a.PoseNode.push(s):a[i].id!==void 0&&(a[i]={},a[i][a[i].id]=a[i]),o.id!==""&&(a[i][o.id]=s)):typeof o.id=="number"?(a[i]={},a[i][o.id]=s):i!=="Properties70"&&(i==="PoseNode"?a[i]=[s]:a[i]=s),typeof o.id=="number"&&(s.id=o.id),o.name!==""&&(s.attrName=o.name),o.type!==""&&(s.attrType=o.type),this.pushStack(s)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}}parseNodeProperty(e,t,i){let n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),s=t[2].replace(/^"/,"").replace(/"$/,"").trim();n==="Content"&&s===","&&(s=i.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,n,s);return}if(n==="C"){const l=s.split(",").slice(1),c=parseInt(l[0]),u=parseInt(l[1]);let h=s.split(",").slice(3);h=h.map(function(f){return f.trim().replace(/^"/,"")}),n="connections",s=[c,u],F6(s,h),o[n]===void 0&&(o[n]=[])}n==="Node"&&(o.id=s),n in o&&Array.isArray(o[n])?o[n].push(s):n!=="a"?o[n]=s:o.a=s,this.setCurrentProp(o,n),n==="a"&&s.slice(-1)!==","&&(o.a=Nf(s))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Nf(t.a))}parseNodeSpecialProperty(e,t,i){const n=i.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),s=n[0],o=n[1],a=n[2],l=n[3];let c=n[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=Nf(c);break}this.getPrevNode()[s]={type:o,type2:a,flag:l,value:c},this.setCurrentProp(this.getPrevNode(),s)}}class R6{parse(e){const t=new jg(e);t.skip(23);const i=t.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const n=new u3;for(;!this.endOfContent(t);){const s=this.parseNode(t,i);s!==null&&n.add(s.name,s)}return n}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const i={},n=t>=7500?e.getUint64():e.getUint32(),s=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),a=e.getString(o);if(n===0)return null;const l=[];for(let f=0;f<s;f++)l.push(this.parseProperty(e));const c=l.length>0?l[0]:"",u=l.length>1?l[1]:"",h=l.length>2?l[2]:"";for(i.singleProperty=s===1&&e.getOffset()===n;n>e.getOffset();){const f=this.parseNode(e,t);f!==null&&this.parseSubNode(a,i,f)}return i.propertyList=l,typeof c=="number"&&(i.id=c),u!==""&&(i.attrName=u),h!==""&&(i.attrType=h),a!==""&&(i.name=a),i}parseSubNode(e,t,i){if(i.singleProperty===!0){const n=i.propertyList[0];Array.isArray(n)?(t[i.name]=i,i.a=n):t[i.name]=n}else if(e==="Connections"&&i.name==="C"){const n=[];i.propertyList.forEach(function(s,o){o!==0&&n.push(s)}),t.connections===void 0&&(t.connections=[]),t.connections.push(n)}else if(i.name==="Properties70")Object.keys(i).forEach(function(s){t[s]=i[s]});else if(e==="Properties70"&&i.name==="P"){let n=i.propertyList[0],s=i.propertyList[1];const o=i.propertyList[2],a=i.propertyList[3];let l;n.indexOf("Lcl ")===0&&(n=n.replace("Lcl ","Lcl_")),s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),s==="Color"||s==="ColorRGB"||s==="Vector"||s==="Vector3D"||s.indexOf("Lcl_")===0?l=[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:l=i.propertyList[4],t[n]={type:s,type2:o,flag:a,value:l}}else t[i.name]===void 0?typeof i.id=="number"?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:i.name==="PoseNode"?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):t[i.name][i.id]===void 0&&(t[i.name][i.id]=i)}parseProperty(e){const t=e.getString(1);let i;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return i=e.getUint32(),e.getArrayBuffer(i);case"S":return i=e.getUint32(),e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=e.getUint32(),s=e.getUint32(),o=e.getUint32();if(s===0)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}const a=Sl(new Uint8Array(e.getArrayBuffer(o))),l=new jg(a.buffer);switch(t){case"b":case"c":return l.getBooleanArray(n);case"d":return l.getFloat64Array(n);case"f":return l.getFloat32Array(n);case"i":return l.getInt32Array(n);case"l":return l.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class jg{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let i=0;i<e;i++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const i=t.indexOf(0);return i>=0&&(t=t.slice(0,i)),Aa(new Uint8Array(t))}}class u3{add(e,t){this[e]=t}}function D6(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===d3(r,0,e.length)}function M6(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function i(n){const s=r[n-1];return r=r.slice(t+n),t++,s}for(let n=0;n<e.length;++n)if(i(1)===e[n])return!1;return!0}function Yg(r){const e=/FBXVersion: (\d+)/,t=r.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function L6(r){return r/46186158e3}const P6=[];function Uc(r,e,t,i){let n;switch(i.mappingType){case"ByPolygonVertex":n=r;break;case"ByPolygon":n=e;break;case"ByVertice":n=t;break;case"AllSame":n=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}i.referenceType==="IndexToDirect"&&(n=i.indices[n]);const s=n*i.dataSize,o=s+i.dataSize;return k6(P6,i.buffer,s,o)}const Uf=new Wn,vo=new K;function h3(r){const e=new Me,t=new Me,i=new Me,n=new Me,s=new Me,o=new Me,a=new Me,l=new Me,c=new Me,u=new Me,h=new Me,f=new Me,d=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(vo.fromArray(r.translation)),r.preRotation){const T=r.preRotation.map(ot.degToRad);T.push(r.eulerOrder),t.makeRotationFromEuler(Uf.fromArray(T))}if(r.rotation){const T=r.rotation.map(ot.degToRad);T.push(r.eulerOrder),i.makeRotationFromEuler(Uf.fromArray(T))}if(r.postRotation){const T=r.postRotation.map(ot.degToRad);T.push(r.eulerOrder),n.makeRotationFromEuler(Uf.fromArray(T)),n.invert()}r.scale&&s.scale(vo.fromArray(r.scale)),r.scalingOffset&&a.setPosition(vo.fromArray(r.scalingOffset)),r.scalingPivot&&o.setPosition(vo.fromArray(r.scalingPivot)),r.rotationOffset&&l.setPosition(vo.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(vo.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(h.copy(r.parentMatrix),u.copy(r.parentMatrixWorld));const m=t.clone().multiply(i).multiply(n),A=new Me;A.extractRotation(u);const p=new Me;p.copyPosition(u);const g=p.clone().invert().multiply(u),v=A.clone().invert().multiply(g),E=s,C=new Me;if(d===0)C.copy(A).multiply(m).multiply(v).multiply(E);else if(d===1)C.copy(A).multiply(v).multiply(m).multiply(E);else{const B=new Me().scale(new K().setFromMatrixScale(h)).clone().invert(),w=v.clone().multiply(B);C.copy(A).multiply(m).multiply(w).multiply(E)}const I=c.clone().invert(),_=o.clone().invert();let x=e.clone().multiply(l).multiply(c).multiply(t).multiply(i).multiply(n).multiply(I).multiply(a).multiply(o).multiply(s).multiply(_);const S=new Me().copyPosition(x),b=u.clone().multiply(S);return f.copyPosition(b),x=f.clone().multiply(C),x.premultiply(u.invert()),x}function f3(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function Nf(r){return r.split(",").map(function(t){return parseFloat(t)})}function d3(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=r.byteLength),Aa(new Uint8Array(r,e,t))}function F6(r,e){for(let t=0,i=r.length,n=e.length;t<n;t++,i++)r[i]=e[t]}function k6(r,e,t,i){for(let n=t,s=0;n<i;n++,s++)r[s]=e[n];return r}function Wg(r,e,t){return r.slice(0,e).concat(t).concat(r.slice(e))}var O6=Object.defineProperty,U6=(r,e,t)=>e in r?O6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Gf=(r,e,t)=>(U6(r,typeof e!="symbol"?e+"":e,t),t);class N6 extends Ur{constructor(e){super(e)}load(e,t,i,n){const s=new In(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{if(typeof o!="string")throw new Error("unsupported data type");const a=JSON.parse(o),l=this.parse(a);t&&t(l)},i,n)}loadAsync(e,t){return super.loadAsync(e,t)}parse(e){return new G6(e)}}class G6{constructor(e){Gf(this,"data"),Gf(this,"isFont",!0),Gf(this,"type","Font"),this.data=e}generateShapes(e,t=100,i){const n=[],s={letterSpacing:0,lineHeight:1,...i},o=Q6(e,t,this.data,s);for(let a=0,l=o.length;a<l;a++)Array.prototype.push.apply(n,o[a].toShapes(!1));return n}}function Q6(r,e,t,i){const n=Array.from(r),s=e/t.resolution,o=(t.boundingBox.yMax-t.boundingBox.yMin+t.underlineThickness)*s,a=[];let l=0,c=0;for(let u=0;u<n.length;u++){const h=n[u];if(h===`
`)l=0,c-=o*i.lineHeight;else{const f=z6(h,s,l,c,t);f&&(l+=f.offsetX+i.letterSpacing,a.push(f.path))}}return a}function z6(r,e,t,i,n){const s=n.glyphs[r]||n.glyphs["?"];if(!s){console.error('THREE.Font: character "'+r+'" does not exists in font family '+n.familyName+".");return}const o=new Ir;let a,l,c,u,h,f,d,m;if(s.o){const A=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let p=0,g=A.length;p<g;)switch(A[p++]){case"m":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.moveTo(a,l);break;case"l":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.lineTo(a,l);break;case"q":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,o.quadraticCurveTo(h,f,c,u);break;case"b":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,d=parseInt(A[p++])*e+t,m=parseInt(A[p++])*e+i,o.bezierCurveTo(h,f,d,m,c,u);break}}return{offsetX:s.ha*e,path:o}}class H6 extends tn{constructor(e=null,t=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=li,this.minFilter=li,this.wrapR=Bn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class V6{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:n,msg:s,transfer:o}=this.queue.shift();this.workersResolve[e]=n,this.workers[e].postMessage(s,o)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const n=this._getIdleWorker();n!==-1?(this._initWorker(n),this.workerStatus|=1<<n,this.workersResolve[n]=i,this.workers[n].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const m3=0,qg=2,K6=0,$6=0,j6=2,Y6=0,W6=0,q6=1,q0=2,X6=0,A3=1,J6=10,Z6=64,p3=0,g3=9,y3=15,v3=16,E3=22,C3=37,I3=43,_3=76,x3=83,S3=97,T3=100,b3=103,w3=109,B3=165,R3=166;class eb{constructor(){this.vkFormat=p3,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=m3,this.levels=[],this.dataFormatDescriptor=[{vendorId:$6,descriptorType:K6,descriptorBlockSize:0,versionNumber:j6,colorModel:Y6,colorPrimaries:A3,transferFunction:q0,flags:W6,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Za{constructor(e,t,i,n){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=n,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),i=e+2**32*t;return this._offset+=8,i}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){t===void 0&&(t=0);const i=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==t&&n<e;)n++,this._offset++;return n<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,n)}}const on=[171,75,84,88,32,50,48,187,13,10,26,10];function Xg(r){return typeof TextDecoder<"u"?new TextDecoder().decode(r):Buffer.from(r).toString("utf8")}function tb(r){const e=new Uint8Array(r.buffer,r.byteOffset,on.length);if(e[0]!==on[0]||e[1]!==on[1]||e[2]!==on[2]||e[3]!==on[3]||e[4]!==on[4]||e[5]!==on[5]||e[6]!==on[6]||e[7]!==on[7]||e[8]!==on[8]||e[9]!==on[9]||e[10]!==on[10]||e[11]!==on[11])throw new Error("Missing KTX 2.0 identifier.");const t=new eb,i=17*Uint32Array.BYTES_PER_ELEMENT,n=new Za(r,on.length,i,!0);t.vkFormat=n._nextUint32(),t.typeSize=n._nextUint32(),t.pixelWidth=n._nextUint32(),t.pixelHeight=n._nextUint32(),t.pixelDepth=n._nextUint32(),t.layerCount=n._nextUint32(),t.faceCount=n._nextUint32();const s=n._nextUint32();t.supercompressionScheme=n._nextUint32();const o=n._nextUint32(),a=n._nextUint32(),l=n._nextUint32(),c=n._nextUint32(),u=n._nextUint64(),h=n._nextUint64(),f=s*3*8,d=new Za(r,on.length+i,f,!0);for(let N=0;N<s;N++)t.levels.push({levelData:new Uint8Array(r.buffer,r.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const m=new Za(r,o,a,!0),A={vendorId:m._skip(4)._nextUint16(),descriptorType:m._nextUint16(),versionNumber:m._nextUint16(),descriptorBlockSize:m._nextUint16(),colorModel:m._nextUint8(),colorPrimaries:m._nextUint8(),transferFunction:m._nextUint8(),flags:m._nextUint8(),texelBlockDimension:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],bytesPlane:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],samples:[]},v=(A.descriptorBlockSize/4-6)/4;for(let N=0;N<v;N++){const L={bitOffset:m._nextUint16(),bitLength:m._nextUint8(),channelType:m._nextUint8(),samplePosition:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};L.channelType&Z6?(L.sampleLower=m._nextInt32(),L.sampleUpper=m._nextInt32()):(L.sampleLower=m._nextUint32(),L.sampleUpper=m._nextUint32()),A.samples[N]=L}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(A);const E=new Za(r,l,c,!0);for(;E._offset<c;){const N=E._nextUint32(),L=E._scan(N),$=Xg(L);if(t.keyValue[$]=E._nextUint8Array(N-L.byteLength-1),$.match(/^ktx/i)){const V=Xg(t.keyValue[$]);t.keyValue[$]=V.substring(0,V.lastIndexOf("\0"))}const j=N%4?4-N%4:0;E._skip(j)}if(h<=0)return t;const C=new Za(r,u,h,!0),I=C._nextUint16(),_=C._nextUint16(),x=C._nextUint32(),S=C._nextUint32(),b=C._nextUint32(),T=C._nextUint32(),B=[];for(let N=0;N<s;N++)B.push({imageFlags:C._nextUint32(),rgbSliceByteOffset:C._nextUint32(),rgbSliceByteLength:C._nextUint32(),alphaSliceByteOffset:C._nextUint32(),alphaSliceByteLength:C._nextUint32()});const w=u+C._offset,R=w+x,D=R+S,G=D+b,z=new Uint8Array(r.buffer,r.byteOffset+w,x),W=new Uint8Array(r.buffer,r.byteOffset+R,S),q=new Uint8Array(r.buffer,r.byteOffset+D,b),F=new Uint8Array(r.buffer,r.byteOffset+G,T);return t.globalData={endpointCount:I,selectorCount:_,imageDescs:B,endpointsData:z,selectorsData:W,tablesData:q,extendedData:F},t}let el,Xs,X0;const Qf={env:{emscripten_notify_memory_growth:function(r){X0=new Uint8Array(Xs.exports.memory.buffer)}}};class ib{init(){return el||(typeof fetch<"u"?el=fetch("data:application/wasm;base64,"+Jg).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,Qf)).then(this._init):el=WebAssembly.instantiate(Buffer.from(Jg,"base64"),Qf).then(this._init),el)}_init(e){Xs=e.instance,Qf.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Xs)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,n=Xs.exports.malloc(i);X0.set(e,n),t=t||Number(Xs.exports.ZSTD_findDecompressedSize(n,i));const s=Xs.exports.malloc(t),o=Xs.exports.ZSTD_decompress(s,t,n,i),a=X0.slice(s,s+o);return Xs.exports.free(n),Xs.exports.free(s),a}}const Jg="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ";class nb extends wh{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,N2),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class sb extends wh{constructor(e,t,i,n,s,o){super(e,t,i,s,o),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=Bn}}var rb=Object.defineProperty,ob=(r,e,t)=>e in r?rb(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Nc=(r,e,t)=>(ob(r,typeof e!="symbol"?e+"":e,t),t);const D3=3e3,M3=3001,Zg="",ab="display-p3",lb="display-p3-linear",cb="srgb-linear",uA="srgb",zf=new WeakMap;let Hf=0,Vf;const hA=(()=>{const r=class extends Ur{constructor(t){super(t),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new V6,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(t){return this.transcoderPath=t,this}setWorkerLimit(t){return this.workerPool.setWorkerLimit(t),this}detectSupport(t){return this.workerConfig={astcSupported:t.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:t.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:t.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:t.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:t.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:t.extensions.has("WEBGL_compressed_texture_pvrtc")||t.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},t.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const t=new In(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const i=t.loadAsync("basis_transcoder.js"),n=new In(this.manager);n.setPath(this.transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const s=n.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([i,s]).then(([o,a])=>{const l=r.BasisWorker.toString(),c=["/* constants */","let _EngineFormat = "+JSON.stringify(r.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(r.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(r.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",l.substring(l.indexOf("{")+1,l.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([c])),this.transcoderBinary=a,this.workerPool.setWorkerCreator(()=>{const u=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return u.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),u})}),Hf>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Hf++}return this.transcoderPending}load(t,i,n,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const o=new In(this.manager);o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials),o.load(t,a=>{if(zf.has(a))return zf.get(a).promise.then(i).catch(s);this._createTexture(a).then(l=>i?i(l):null).catch(s)},n,s)}_createTextureFrom(t,i){const{faces:n,width:s,height:o,format:a,type:l,error:c,dfdFlags:u}=t;if(l==="error")return Promise.reject(c);let h;if(i.faceCount===6)h=new nb(n,a,$i);else{const d=n[0].mipmaps;h=i.layerCount>1?new sb(d,s,o,i.layerCount,a,$i):new wh(d,s,o,a,$i)}h.minFilter=n[0].mipmaps.length===1?jt:uc,h.magFilter=jt,h.generateMipmaps=!1,h.needsUpdate=!0;const f=L3(i);return"colorSpace"in h?h.colorSpace=f:h.encoding=f===uA?M3:D3,h.premultiplyAlpha=!!(u&q6),h}async _createTexture(t,i={}){const n=tb(new Uint8Array(t));if(n.vkFormat!==p3)return hb(n);const s=i,o=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:t,taskConfig:s},[t])).then(a=>this._createTextureFrom(a.data,n));return zf.set(t,{promise:o}),o}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Hf--,this}};let e=r;return Nc(e,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),Nc(e,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),Nc(e,"EngineFormat",{RGBAFormat:Mi,RGBA_ASTC_4x4_Format:l_,RGBA_BPTC_Format:a_,RGBA_ETC2_EAC_Format:o_,RGBA_PVRTC_4BPPV1_Format:r_,RGBA_S3TC_DXT5_Format:s_,RGB_ETC1_Format:n_,RGB_ETC2_Format:i_,RGB_PVRTC_4BPPV1_Format:t_,RGB_S3TC_DXT1_Format:e_}),Nc(e,"BasisWorker",function(){let t,i,n;const s=_EngineFormat,o=_TranscoderFormat,a=_BasisFormat;self.addEventListener("message",function(p){const g=p.data;switch(g.type){case"init":t=g.config,l(g.transcoderBinary);break;case"transcode":i.then(()=>{try{const{faces:v,buffers:E,width:C,height:I,hasAlpha:_,format:x,dfdFlags:S}=c(g.buffer);self.postMessage({type:"transcode",id:g.id,faces:v,width:C,height:I,hasAlpha:_,format:x,dfdFlags:S},E)}catch(v){console.error(v),self.postMessage({type:"error",id:g.id,error:v.message})}});break}});function l(p){i=new Promise(g=>{n={wasmBinary:p,onRuntimeInitialized:g},BASIS(n)}).then(()=>{n.initializeBasis(),n.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function c(p){const g=new n.KTX2File(new Uint8Array(p));function v(){g.close(),g.delete()}if(!g.isValid())throw v(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");const E=g.isUASTC()?a.UASTC_4x4:a.ETC1S,C=g.getWidth(),I=g.getHeight(),_=g.getLayers()||1,x=g.getLevels(),S=g.getFaces(),b=g.getHasAlpha(),T=g.getDFDFlags(),{transcoderFormat:B,engineFormat:w}=d(E,C,I,b);if(!C||!I||!x)throw v(),new Error("THREE.KTX2Loader:	Invalid texture");if(!g.startTranscoding())throw v(),new Error("THREE.KTX2Loader: .startTranscoding failed");const R=[],D=[];for(let G=0;G<S;G++){const z=[];for(let W=0;W<x;W++){const q=[];let F,N;for(let $=0;$<_;$++){const j=g.getImageLevelInfo(W,$,G);G===0&&W===0&&$===0&&(j.origWidth%4!==0||j.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),x>1?(F=j.origWidth,N=j.origHeight):(F=j.width,N=j.height);const V=new Uint8Array(g.getImageTranscodedSizeInBytes(W,$,0,B));if(!g.transcodeImage(V,W,$,G,B,0,-1,-1))throw v(),new Error("THREE.KTX2Loader: .transcodeImage failed.");q.push(V)}const L=A(q);z.push({data:L,width:F,height:N}),D.push(L.buffer)}R.push({mipmaps:z,width:C,height:I,format:w})}return v(),{faces:R,buffers:D,width:C,height:I,hasAlpha:b,format:w,dfdFlags:T}}const u=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],h=u.sort(function(p,g){return p.priorityETC1S-g.priorityETC1S}),f=u.sort(function(p,g){return p.priorityUASTC-g.priorityUASTC});function d(p,g,v,E){let C,I;const _=p===a.ETC1S?h:f;for(let x=0;x<_.length;x++){const S=_[x];if(t[S.if]&&S.basisFormat.includes(p)&&!(E&&S.transcoderFormat.length<2)&&!(S.needsPowerOfTwo&&!(m(g)&&m(v))))return C=S.transcoderFormat[E?1:0],I=S.engineFormat[E?1:0],{transcoderFormat:C,engineFormat:I}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),C=o.RGBA32,I=s.RGBAFormat,{transcoderFormat:C,engineFormat:I}}function m(p){return p<=2?!0:(p&p-1)===0&&p!==0}function A(p){if(p.length===1)return p[0];let g=0;for(let C=0;C<p.length;C++){const I=p[C];g+=I.byteLength}const v=new Uint8Array(g);let E=0;for(let C=0;C<p.length;C++){const I=p[C];v.set(I,E),E+=I.byteLength}return v}}),e})(),ub=new Set([Mi,Xo,Fs]),Kf={[w3]:Mi,[S3]:Mi,[C3]:Mi,[I3]:Mi,[b3]:Xo,[x3]:Xo,[v3]:Xo,[E3]:Xo,[T3]:Fs,[_3]:Fs,[y3]:Fs,[g3]:Fs,[R3]:gp,[B3]:gp},$f={[w3]:hi,[S3]:Ai,[C3]:$i,[I3]:$i,[b3]:hi,[x3]:Ai,[v3]:$i,[E3]:$i,[T3]:hi,[_3]:Ai,[y3]:$i,[g3]:$i,[R3]:$i,[B3]:$i};async function hb(r){const{vkFormat:e}=r;if(Kf[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let t;r.supercompressionScheme===qg&&(Vf||(Vf=new Promise(async o=>{const a=new ib;await a.init(),o(a)})),t=await Vf);const i=[];for(let o=0;o<r.levels.length;o++){const a=Math.max(1,r.pixelWidth>>o),l=Math.max(1,r.pixelHeight>>o),c=r.pixelDepth?Math.max(1,r.pixelDepth>>o):0,u=r.levels[o];let h;if(r.supercompressionScheme===m3)h=u.levelData;else if(r.supercompressionScheme===qg)h=t.decode(u.levelData,u.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let f;$f[e]===hi?f=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):$f[e]===Ai?f=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):f=h,i.push({data:f,width:a,height:l,depth:c})}let n;if(ub.has(Kf[e]))n=r.pixelDepth===0?new Fr(i[0].data,r.pixelWidth,r.pixelHeight):new H6(i[0].data,r.pixelWidth,r.pixelHeight,r.pixelDepth);else{if(r.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");n=new wh(i,r.pixelWidth,r.pixelHeight)}n.mipmaps=i,n.type=$f[e],n.format=Kf[e],n.needsUpdate=!0;const s=L3(r);return"colorSpace"in n?n.colorSpace=s:n.encoding=s===uA?M3:D3,Promise.resolve(n)}function L3(r){const e=r.dataFormatDescriptor[0];return e.colorPrimaries===A3?e.transferFunction===q0?uA:cb:e.colorPrimaries===J6?e.transferFunction===q0?ab:lb:(e.colorPrimaries===X6||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),Zg)}class fb extends G2{constructor(e){super(e),this.type=Ai}parse(e){const o=function(S,b){switch(S){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(b||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(b||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(b||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(b||""))}},u=`
`,h=function(S,b,T){b=b||1024;let w=S.pos,R=-1,D=0,G="",z=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));for(;0>(R=z.indexOf(u))&&D<b&&w<S.byteLength;)G+=z,D+=z.length,w+=128,z+=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));return-1<R?(S.pos+=D+R+1,G+z.slice(0,R)):!1},f=function(S){const b=/^#\?(\S+)/,T=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,B=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,w=/^\s*FORMAT=(\S+)\s*$/,R=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,D={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let G,z;for((S.pos>=S.byteLength||!(G=h(S)))&&o(1,"no header found"),(z=G.match(b))||o(3,"bad initial token"),D.valid|=1,D.programtype=z[1],D.string+=G+`
`;G=h(S),G!==!1;){if(D.string+=G+`
`,G.charAt(0)==="#"){D.comments+=G+`
`;continue}if((z=G.match(T))&&(D.gamma=parseFloat(z[1])),(z=G.match(B))&&(D.exposure=parseFloat(z[1])),(z=G.match(w))&&(D.valid|=2,D.format=z[1]),(z=G.match(R))&&(D.valid|=4,D.height=parseInt(z[1],10),D.width=parseInt(z[2],10)),D.valid&2&&D.valid&4)break}return D.valid&2||o(3,"missing format specifier"),D.valid&4||o(3,"missing image size specifier"),D},d=function(S,b,T){const B=b;if(B<8||B>32767||S[0]!==2||S[1]!==2||S[2]&128)return new Uint8Array(S);B!==(S[2]<<8|S[3])&&o(3,"wrong scanline width");const w=new Uint8Array(4*b*T);w.length||o(4,"unable to allocate buffer space");let R=0,D=0;const G=4*B,z=new Uint8Array(4),W=new Uint8Array(G);let q=T;for(;q>0&&D<S.byteLength;){D+4>S.byteLength&&o(1),z[0]=S[D++],z[1]=S[D++],z[2]=S[D++],z[3]=S[D++],(z[0]!=2||z[1]!=2||(z[2]<<8|z[3])!=B)&&o(3,"bad rgbe scanline format");let F=0,N;for(;F<G&&D<S.byteLength;){N=S[D++];const $=N>128;if($&&(N-=128),(N===0||F+N>G)&&o(3,"bad scanline data"),$){const j=S[D++];for(let V=0;V<N;V++)W[F++]=j}else W.set(S.subarray(D,D+N),F),F+=N,D+=N}const L=B;for(let $=0;$<L;$++){let j=0;w[R]=W[$+j],j+=B,w[R+1]=W[$+j],j+=B,w[R+2]=W[$+j],j+=B,w[R+3]=W[$+j],R+=4}q--}return w},m=function(S,b,T,B){const w=S[b+3],R=Math.pow(2,w-128)/255;T[B+0]=S[b+0]*R,T[B+1]=S[b+1]*R,T[B+2]=S[b+2]*R,T[B+3]=1},A=function(S,b,T,B){const w=S[b+3],R=Math.pow(2,w-128)/255;T[B+0]=Jo.toHalfFloat(Math.min(S[b+0]*R,65504)),T[B+1]=Jo.toHalfFloat(Math.min(S[b+1]*R,65504)),T[B+2]=Jo.toHalfFloat(Math.min(S[b+2]*R,65504)),T[B+3]=Jo.toHalfFloat(1)},p=new Uint8Array(e);p.pos=0;const g=f(p),v=g.width,E=g.height,C=d(p.subarray(p.pos),v,E);let I,_,x;switch(this.type){case hi:x=C.length/4;const S=new Float32Array(x*4);for(let T=0;T<x;T++)m(C,T*4,S,T*4);I=S,_=hi;break;case Ai:x=C.length/4;const b=new Uint16Array(x*4);for(let T=0;T<x;T++)A(C,T*4,b,T*4);I=b,_=Ai;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:v,height:E,data:I,header:g.string,gamma:g.gamma,exposure:g.exposure,type:_}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){switch(o.type){case hi:case Ai:"colorSpace"in o?o.colorSpace="srgb-linear":o.encoding=3e3,o.minFilter=jt,o.magFilter=jt,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,s,i,n)}}const tl=cc>=152;class db extends G2{constructor(e){super(e),this.type=Ai}parse(e){const b=Math.pow(2.7182818,2.2);function T(H,X){for(var ne=0,pe=0;pe<65536;++pe)(pe==0||H[pe>>3]&1<<(pe&7))&&(X[ne++]=pe);for(var xe=ne-1;ne<65536;)X[ne++]=0;return xe}function B(H){for(var X=0;X<16384;X++)H[X]={},H[X].len=0,H[X].lit=0,H[X].p=null}const w={l:0,c:0,lc:0};function R(H,X,ne,pe,xe){for(;ne<H;)X=X<<8|Je(pe,xe),ne+=8;ne-=H,w.l=X>>ne&(1<<H)-1,w.c=X,w.lc=ne}const D=new Array(59);function G(H){for(var X=0;X<=58;++X)D[X]=0;for(var X=0;X<65537;++X)D[H[X]]+=1;for(var ne=0,X=58;X>0;--X){var pe=ne+D[X]>>1;D[X]=ne,ne=pe}for(var X=0;X<65537;++X){var xe=H[X];xe>0&&(H[X]=xe|D[xe]++<<6)}}function z(H,X,ne,pe,xe,Se,Ge){for(var Pe=ne,Ne=0,Qe=0;xe<=Se;xe++){if(Pe.value-ne.value>pe)return!1;R(6,Ne,Qe,H,Pe);var ze=w.l;if(Ne=w.c,Qe=w.lc,Ge[xe]=ze,ze==63){if(Pe.value-ne.value>pe)throw"Something wrong with hufUnpackEncTable";R(8,Ne,Qe,H,Pe);var Ce=w.l+6;if(Ne=w.c,Qe=w.lc,xe+Ce>Se+1)throw"Something wrong with hufUnpackEncTable";for(;Ce--;)Ge[xe++]=0;xe--}else if(ze>=59){var Ce=ze-59+2;if(xe+Ce>Se+1)throw"Something wrong with hufUnpackEncTable";for(;Ce--;)Ge[xe++]=0;xe--}}G(Ge)}function W(H){return H&63}function q(H){return H>>6}function F(H,X,ne,pe){for(;X<=ne;X++){var xe=q(H[X]),Se=W(H[X]);if(xe>>Se)throw"Invalid table entry";if(Se>14){var Ge=pe[xe>>Se-14];if(Ge.len)throw"Invalid table entry";if(Ge.lit++,Ge.p){var Pe=Ge.p;Ge.p=new Array(Ge.lit);for(var Ne=0;Ne<Ge.lit-1;++Ne)Ge.p[Ne]=Pe[Ne]}else Ge.p=new Array(1);Ge.p[Ge.lit-1]=X}else if(Se)for(var Qe=0,Ne=1<<14-Se;Ne>0;Ne--){var Ge=pe[(xe<<14-Se)+Qe];if(Ge.len||Ge.p)throw"Invalid table entry";Ge.len=Se,Ge.lit=X,Qe++}}return!0}const N={c:0,lc:0};function L(H,X,ne,pe){H=H<<8|Je(ne,pe),X+=8,N.c=H,N.lc=X}const $={c:0,lc:0};function j(H,X,ne,pe,xe,Se,Ge,Pe,Ne,Qe){if(H==X){pe<8&&(L(ne,pe,xe,Ge),ne=N.c,pe=N.lc),pe-=8;var ze=ne>>pe,ze=new Uint8Array([ze])[0];if(Ne.value+ze>Qe)return!1;for(var Ce=Pe[Ne.value-1];ze-- >0;)Pe[Ne.value++]=Ce}else if(Ne.value<Qe)Pe[Ne.value++]=H;else return!1;$.c=ne,$.lc=pe}function V(H){return H&65535}function k(H){var X=V(H);return X>32767?X-65536:X}const Q={a:0,b:0};function O(H,X){var ne=k(H),pe=k(X),xe=pe,Se=ne+(xe&1)+(xe>>1),Ge=Se,Pe=Se-xe;Q.a=Ge,Q.b=Pe}function U(H,X){var ne=V(H),pe=V(X),xe=ne-(pe>>1)&65535,Se=pe+xe-32768&65535;Q.a=Se,Q.b=xe}function te(H,X,ne,pe,xe,Se,Ge){for(var Pe=Ge<16384,Ne=ne>xe?xe:ne,Qe=1,ze;Qe<=Ne;)Qe<<=1;for(Qe>>=1,ze=Qe,Qe>>=1;Qe>=1;){for(var Ce=0,Wt=Ce+Se*(xe-ze),rt=Se*Qe,st=Se*ze,pt=pe*Qe,xt=pe*ze,Ut,Nt,di,Hi;Ce<=Wt;Ce+=st){for(var Gt=Ce,_n=Ce+pe*(ne-ze);Gt<=_n;Gt+=xt){var qt=Gt+pt,Si=Gt+rt,rn=Si+pt;Pe?(O(H[Gt+X],H[Si+X]),Ut=Q.a,di=Q.b,O(H[qt+X],H[rn+X]),Nt=Q.a,Hi=Q.b,O(Ut,Nt),H[Gt+X]=Q.a,H[qt+X]=Q.b,O(di,Hi),H[Si+X]=Q.a,H[rn+X]=Q.b):(U(H[Gt+X],H[Si+X]),Ut=Q.a,di=Q.b,U(H[qt+X],H[rn+X]),Nt=Q.a,Hi=Q.b,U(Ut,Nt),H[Gt+X]=Q.a,H[qt+X]=Q.b,U(di,Hi),H[Si+X]=Q.a,H[rn+X]=Q.b)}if(ne&Qe){var Si=Gt+rt;Pe?O(H[Gt+X],H[Si+X]):U(H[Gt+X],H[Si+X]),Ut=Q.a,H[Si+X]=Q.b,H[Gt+X]=Ut}}if(xe&Qe)for(var Gt=Ce,_n=Ce+pe*(ne-ze);Gt<=_n;Gt+=xt){var qt=Gt+pt;Pe?O(H[Gt+X],H[qt+X]):U(H[Gt+X],H[qt+X]),Ut=Q.a,H[qt+X]=Q.b,H[Gt+X]=Ut}ze=Qe,Qe>>=1}return Ce}function le(H,X,ne,pe,xe,Se,Ge,Pe,Ne,Qe){for(var ze=0,Ce=0,Wt=Pe,rt=Math.trunc(xe.value+(Se+7)/8);xe.value<rt;)for(L(ze,Ce,ne,xe),ze=N.c,Ce=N.lc;Ce>=14;){var st=ze>>Ce-14&16383,pt=X[st];if(pt.len)Ce-=pt.len,j(pt.lit,Ge,ze,Ce,ne,pe,xe,Ne,Qe,Wt),ze=$.c,Ce=$.lc;else{if(!pt.p)throw"hufDecode issues";var xt;for(xt=0;xt<pt.lit;xt++){for(var Ut=W(H[pt.p[xt]]);Ce<Ut&&xe.value<rt;)L(ze,Ce,ne,xe),ze=N.c,Ce=N.lc;if(Ce>=Ut&&q(H[pt.p[xt]])==(ze>>Ce-Ut&(1<<Ut)-1)){Ce-=Ut,j(pt.p[xt],Ge,ze,Ce,ne,pe,xe,Ne,Qe,Wt),ze=$.c,Ce=$.lc;break}}if(xt==pt.lit)throw"hufDecode issues"}}var Nt=8-Se&7;for(ze>>=Nt,Ce-=Nt;Ce>0;){var pt=X[ze<<14-Ce&16383];if(pt.len)Ce-=pt.len,j(pt.lit,Ge,ze,Ce,ne,pe,xe,Ne,Qe,Wt),ze=$.c,Ce=$.lc;else throw"hufDecode issues"}return!0}function ee(H,X,ne,pe,xe,Se){var Ge={value:0},Pe=ne.value,Ne=tt(X,ne),Qe=tt(X,ne);ne.value+=4;var ze=tt(X,ne);if(ne.value+=4,Ne<0||Ne>=65537||Qe<0||Qe>=65537)throw"Something wrong with HUF_ENCSIZE";var Ce=new Array(65537),Wt=new Array(16384);B(Wt);var rt=pe-(ne.value-Pe);if(z(H,X,ne,rt,Ne,Qe,Ce),ze>8*(pe-(ne.value-Pe)))throw"Something wrong with hufUncompress";F(Ce,Ne,Qe,Wt),le(Ce,Wt,H,X,ne,ze,Qe,Se,xe,Ge)}function se(H,X,ne){for(var pe=0;pe<ne;++pe)X[pe]=H[X[pe]]}function Ee(H){for(var X=1;X<H.length;X++){var ne=H[X-1]+H[X]-128;H[X]=ne}}function Ie(H,X){for(var ne=0,pe=Math.floor((H.length+1)/2),xe=0,Se=H.length-1;!(xe>Se||(X[xe++]=H[ne++],xe>Se));)X[xe++]=H[pe++]}function oe(H){for(var X=H.byteLength,ne=new Array,pe=0,xe=new DataView(H);X>0;){var Se=xe.getInt8(pe++);if(Se<0){var Ge=-Se;X-=Ge+1;for(var Pe=0;Pe<Ge;Pe++)ne.push(xe.getUint8(pe++))}else{var Ge=Se;X-=2;for(var Ne=xe.getUint8(pe++),Pe=0;Pe<Ge+1;Pe++)ne.push(Ne)}}return ne}function ce(H,X,ne,pe,xe,Se){var qt=new DataView(Se.buffer),Ge=ne[H.idx[0]].width,Pe=ne[H.idx[0]].height,Ne=3,Qe=Math.floor(Ge/8),ze=Math.ceil(Ge/8),Ce=Math.ceil(Pe/8),Wt=Ge-(ze-1)*8,rt=Pe-(Ce-1)*8,st={value:0},pt=new Array(Ne),xt=new Array(Ne),Ut=new Array(Ne),Nt=new Array(Ne),di=new Array(Ne);for(let Qt=0;Qt<Ne;++Qt)di[Qt]=X[H.idx[Qt]],pt[Qt]=Qt<1?0:pt[Qt-1]+ze*Ce,xt[Qt]=new Float32Array(64),Ut[Qt]=new Uint16Array(64),Nt[Qt]=new Uint16Array(ze*64);for(let Qt=0;Qt<Ce;++Qt){var Hi=8;Qt==Ce-1&&(Hi=rt);var Gt=8;for(let ti=0;ti<ze;++ti){ti==ze-1&&(Gt=Wt);for(let wt=0;wt<Ne;++wt)Ut[wt].fill(0),Ut[wt][0]=xe[pt[wt]++],Ae(st,pe,Ut[wt]),he(Ut[wt],xt[wt]),Z(xt[wt]);J(xt);for(let wt=0;wt<Ne;++wt)ue(xt[wt],Nt[wt],ti*64)}let Ri=0;for(let ti=0;ti<Ne;++ti){const wt=ne[H.idx[ti]].type;for(let dn=8*Qt;dn<8*Qt+Hi;++dn){Ri=di[ti][dn];for(let Pn=0;Pn<Qe;++Pn){const ki=Pn*64+(dn&7)*8;qt.setUint16(Ri+0*2*wt,Nt[ti][ki+0],!0),qt.setUint16(Ri+1*2*wt,Nt[ti][ki+1],!0),qt.setUint16(Ri+2*2*wt,Nt[ti][ki+2],!0),qt.setUint16(Ri+3*2*wt,Nt[ti][ki+3],!0),qt.setUint16(Ri+4*2*wt,Nt[ti][ki+4],!0),qt.setUint16(Ri+5*2*wt,Nt[ti][ki+5],!0),qt.setUint16(Ri+6*2*wt,Nt[ti][ki+6],!0),qt.setUint16(Ri+7*2*wt,Nt[ti][ki+7],!0),Ri+=8*2*wt}}if(Qe!=ze)for(let dn=8*Qt;dn<8*Qt+Hi;++dn){const Pn=di[ti][dn]+8*Qe*2*wt,ki=Qe*64+(dn&7)*8;for(let ts=0;ts<Gt;++ts)qt.setUint16(Pn+ts*2*wt,Nt[ti][ki+ts],!0)}}}for(var _n=new Uint16Array(Ge),qt=new DataView(Se.buffer),Si=0;Si<Ne;++Si){ne[H.idx[Si]].decoded=!0;var rn=ne[H.idx[Si]].type;if(ne[Si].type==2)for(var Vs=0;Vs<Pe;++Vs){const Qt=di[Si][Vs];for(var Fi=0;Fi<Ge;++Fi)_n[Fi]=qt.getUint16(Qt+Fi*2*rn,!0);for(var Fi=0;Fi<Ge;++Fi)qt.setFloat32(Qt+Fi*2*rn,ve(_n[Fi]),!0)}}}function Ae(H,X,ne){for(var pe,xe=1;xe<64;)pe=X[H.value],pe==65280?xe=64:pe>>8==255?xe+=pe&255:(ne[xe]=pe,xe++),H.value++}function he(H,X){X[0]=ve(H[0]),X[1]=ve(H[1]),X[2]=ve(H[5]),X[3]=ve(H[6]),X[4]=ve(H[14]),X[5]=ve(H[15]),X[6]=ve(H[27]),X[7]=ve(H[28]),X[8]=ve(H[2]),X[9]=ve(H[4]),X[10]=ve(H[7]),X[11]=ve(H[13]),X[12]=ve(H[16]),X[13]=ve(H[26]),X[14]=ve(H[29]),X[15]=ve(H[42]),X[16]=ve(H[3]),X[17]=ve(H[8]),X[18]=ve(H[12]),X[19]=ve(H[17]),X[20]=ve(H[25]),X[21]=ve(H[30]),X[22]=ve(H[41]),X[23]=ve(H[43]),X[24]=ve(H[9]),X[25]=ve(H[11]),X[26]=ve(H[18]),X[27]=ve(H[24]),X[28]=ve(H[31]),X[29]=ve(H[40]),X[30]=ve(H[44]),X[31]=ve(H[53]),X[32]=ve(H[10]),X[33]=ve(H[19]),X[34]=ve(H[23]),X[35]=ve(H[32]),X[36]=ve(H[39]),X[37]=ve(H[45]),X[38]=ve(H[52]),X[39]=ve(H[54]),X[40]=ve(H[20]),X[41]=ve(H[22]),X[42]=ve(H[33]),X[43]=ve(H[38]),X[44]=ve(H[46]),X[45]=ve(H[51]),X[46]=ve(H[55]),X[47]=ve(H[60]),X[48]=ve(H[21]),X[49]=ve(H[34]),X[50]=ve(H[37]),X[51]=ve(H[47]),X[52]=ve(H[50]),X[53]=ve(H[56]),X[54]=ve(H[59]),X[55]=ve(H[61]),X[56]=ve(H[35]),X[57]=ve(H[36]),X[58]=ve(H[48]),X[59]=ve(H[49]),X[60]=ve(H[57]),X[61]=ve(H[58]),X[62]=ve(H[62]),X[63]=ve(H[63])}function Z(H){const X=.5*Math.cos(.7853975),ne=.5*Math.cos(3.14159/16),pe=.5*Math.cos(3.14159/8),xe=.5*Math.cos(3*3.14159/16),Se=.5*Math.cos(5*3.14159/16),Ge=.5*Math.cos(3*3.14159/8),Pe=.5*Math.cos(7*3.14159/16);for(var Ne=new Array(4),Qe=new Array(4),ze=new Array(4),Ce=new Array(4),Wt=0;Wt<8;++Wt){var rt=Wt*8;Ne[0]=pe*H[rt+2],Ne[1]=Ge*H[rt+2],Ne[2]=pe*H[rt+6],Ne[3]=Ge*H[rt+6],Qe[0]=ne*H[rt+1]+xe*H[rt+3]+Se*H[rt+5]+Pe*H[rt+7],Qe[1]=xe*H[rt+1]-Pe*H[rt+3]-ne*H[rt+5]-Se*H[rt+7],Qe[2]=Se*H[rt+1]-ne*H[rt+3]+Pe*H[rt+5]+xe*H[rt+7],Qe[3]=Pe*H[rt+1]-Se*H[rt+3]+xe*H[rt+5]-ne*H[rt+7],ze[0]=X*(H[rt+0]+H[rt+4]),ze[3]=X*(H[rt+0]-H[rt+4]),ze[1]=Ne[0]+Ne[3],ze[2]=Ne[1]-Ne[2],Ce[0]=ze[0]+ze[1],Ce[1]=ze[3]+ze[2],Ce[2]=ze[3]-ze[2],Ce[3]=ze[0]-ze[1],H[rt+0]=Ce[0]+Qe[0],H[rt+1]=Ce[1]+Qe[1],H[rt+2]=Ce[2]+Qe[2],H[rt+3]=Ce[3]+Qe[3],H[rt+4]=Ce[3]-Qe[3],H[rt+5]=Ce[2]-Qe[2],H[rt+6]=Ce[1]-Qe[1],H[rt+7]=Ce[0]-Qe[0]}for(var st=0;st<8;++st)Ne[0]=pe*H[16+st],Ne[1]=Ge*H[16+st],Ne[2]=pe*H[48+st],Ne[3]=Ge*H[48+st],Qe[0]=ne*H[8+st]+xe*H[24+st]+Se*H[40+st]+Pe*H[56+st],Qe[1]=xe*H[8+st]-Pe*H[24+st]-ne*H[40+st]-Se*H[56+st],Qe[2]=Se*H[8+st]-ne*H[24+st]+Pe*H[40+st]+xe*H[56+st],Qe[3]=Pe*H[8+st]-Se*H[24+st]+xe*H[40+st]-ne*H[56+st],ze[0]=X*(H[st]+H[32+st]),ze[3]=X*(H[st]-H[32+st]),ze[1]=Ne[0]+Ne[3],ze[2]=Ne[1]-Ne[2],Ce[0]=ze[0]+ze[1],Ce[1]=ze[3]+ze[2],Ce[2]=ze[3]-ze[2],Ce[3]=ze[0]-ze[1],H[0+st]=Ce[0]+Qe[0],H[8+st]=Ce[1]+Qe[1],H[16+st]=Ce[2]+Qe[2],H[24+st]=Ce[3]+Qe[3],H[32+st]=Ce[3]-Qe[3],H[40+st]=Ce[2]-Qe[2],H[48+st]=Ce[1]-Qe[1],H[56+st]=Ce[0]-Qe[0]}function J(H){for(var X=0;X<64;++X){var ne=H[0][X],pe=H[1][X],xe=H[2][X];H[0][X]=ne+1.5747*xe,H[1][X]=ne-.1873*pe-.4682*xe,H[2][X]=ne+1.8556*pe}}function ue(H,X,ne){for(var pe=0;pe<64;++pe)X[ne+pe]=Jo.toHalfFloat(Te(H[pe]))}function Te(H){return H<=1?Math.sign(H)*Math.pow(Math.abs(H),2.2):Math.sign(H)*Math.pow(b,Math.abs(H)-1)}function we(H){return new DataView(H.array.buffer,H.offset.value,H.size)}function Le(H){var X=H.viewer.buffer.slice(H.offset.value,H.offset.value+H.size),ne=new Uint8Array(oe(X)),pe=new Uint8Array(ne.length);return Ee(ne),Ie(ne,pe),new DataView(pe.buffer)}function Be(H){var X=H.array.slice(H.offset.value,H.offset.value+H.size),ne=Sl(X),pe=new Uint8Array(ne.length);return Ee(ne),Ie(ne,pe),new DataView(pe.buffer)}function qe(H){for(var X=H.viewer,ne={value:H.offset.value},pe=new Uint16Array(H.width*H.scanlineBlockSize*(H.channels*H.type)),xe=new Uint8Array(8192),Se=0,Ge=new Array(H.channels),Pe=0;Pe<H.channels;Pe++)Ge[Pe]={},Ge[Pe].start=Se,Ge[Pe].end=Ge[Pe].start,Ge[Pe].nx=H.width,Ge[Pe].ny=H.lines,Ge[Pe].size=H.type,Se+=Ge[Pe].nx*Ge[Pe].ny*Ge[Pe].size;var Ne=ft(X,ne),Qe=ft(X,ne);if(Qe>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(Ne<=Qe)for(var Pe=0;Pe<Qe-Ne+1;Pe++)xe[Pe+Ne]=re(X,ne);var ze=new Uint16Array(65536),Ce=T(xe,ze),Wt=tt(X,ne);ee(H.array,X,ne,Wt,pe,Se);for(var Pe=0;Pe<H.channels;++Pe)for(var rt=Ge[Pe],st=0;st<Ge[Pe].size;++st)te(pe,rt.start+st,rt.nx,rt.size,rt.ny,rt.nx*rt.size,Ce);se(ze,pe,Se);for(var pt=0,xt=new Uint8Array(pe.buffer.byteLength),Ut=0;Ut<H.lines;Ut++)for(var Nt=0;Nt<H.channels;Nt++){var rt=Ge[Nt],di=rt.nx*rt.size,Hi=new Uint8Array(pe.buffer,rt.end*2,di*2);xt.set(Hi,pt),pt+=di*2,rt.end+=di}return new DataView(xt.buffer)}function Oe(H){var X=H.array.slice(H.offset.value,H.offset.value+H.size),ne=Sl(X);const pe=H.lines*H.channels*H.width,xe=H.type==1?new Uint16Array(pe):new Uint32Array(pe);let Se=0,Ge=0;const Pe=new Array(4);for(let Ne=0;Ne<H.lines;Ne++)for(let Qe=0;Qe<H.channels;Qe++){let ze=0;switch(H.type){case 1:Pe[0]=Se,Pe[1]=Pe[0]+H.width,Se=Pe[1]+H.width;for(let Ce=0;Ce<H.width;++Ce){const Wt=ne[Pe[0]++]<<8|ne[Pe[1]++];ze+=Wt,xe[Ge]=ze,Ge++}break;case 2:Pe[0]=Se,Pe[1]=Pe[0]+H.width,Pe[2]=Pe[1]+H.width,Se=Pe[2]+H.width;for(let Ce=0;Ce<H.width;++Ce){const Wt=ne[Pe[0]++]<<24|ne[Pe[1]++]<<16|ne[Pe[2]++]<<8;ze+=Wt,xe[Ge]=ze,Ge++}break}}return new DataView(xe.buffer)}function Ke(H){var X=H.viewer,ne={value:H.offset.value},pe=new Uint8Array(H.width*H.lines*(H.channels*H.type*2)),xe={version:Re(X,ne),unknownUncompressedSize:Re(X,ne),unknownCompressedSize:Re(X,ne),acCompressedSize:Re(X,ne),dcCompressedSize:Re(X,ne),rleCompressedSize:Re(X,ne),rleUncompressedSize:Re(X,ne),rleRawSize:Re(X,ne),totalAcUncompressedCount:Re(X,ne),totalDcUncompressedCount:Re(X,ne),acCompression:Re(X,ne)};if(xe.version<2)throw"EXRLoader.parse: "+Ft.compression+" version "+xe.version+" is unsupported";for(var Se=new Array,Ge=ft(X,ne)-2;Ge>0;){var Pe=$e(X.buffer,ne),Ne=re(X,ne),Qe=Ne>>2&3,ze=(Ne>>4)-1,Ce=new Int8Array([ze])[0],Wt=re(X,ne);Se.push({name:Pe,index:Ce,type:Wt,compression:Qe}),Ge-=Pe.length+3}for(var rt=Ft.channels,st=new Array(H.channels),pt=0;pt<H.channels;++pt){var xt=st[pt]={},Ut=rt[pt];xt.name=Ut.name,xt.compression=0,xt.decoded=!1,xt.type=Ut.pixelType,xt.pLinear=Ut.pLinear,xt.width=H.width,xt.height=H.lines}for(var Nt={idx:new Array(3)},di=0;di<H.channels;++di)for(var xt=st[di],pt=0;pt<Se.length;++pt){var Hi=Se[pt];xt.name==Hi.name&&(xt.compression=Hi.compression,Hi.index>=0&&(Nt.idx[Hi.index]=di),xt.offset=di)}if(xe.acCompressedSize>0)switch(xe.acCompression){case 0:var qt=new Uint16Array(xe.totalAcUncompressedCount);ee(H.array,X,ne,xe.acCompressedSize,qt,xe.totalAcUncompressedCount);break;case 1:var Gt=H.array.slice(ne.value,ne.value+xe.totalAcUncompressedCount),_n=Sl(Gt),qt=new Uint16Array(_n.buffer);ne.value+=xe.totalAcUncompressedCount;break}if(xe.dcCompressedSize>0){var Si={array:H.array,offset:ne,size:xe.dcCompressedSize},rn=new Uint16Array(Be(Si).buffer);ne.value+=xe.dcCompressedSize}if(xe.rleRawSize>0){var Gt=H.array.slice(ne.value,ne.value+xe.rleCompressedSize),_n=Sl(Gt),Vs=oe(_n.buffer);ne.value+=xe.rleCompressedSize}for(var Fi=0,Qt=new Array(st.length),pt=0;pt<Qt.length;++pt)Qt[pt]=new Array;for(var Ri=0;Ri<H.lines;++Ri)for(var ti=0;ti<st.length;++ti)Qt[ti].push(Fi),Fi+=st[ti].width*H.type*2;ce(Nt,Qt,st,qt,rn,pe);for(var pt=0;pt<st.length;++pt){var xt=st[pt];if(!xt.decoded)switch(xt.compression){case 2:for(var wt=0,dn=0,Ri=0;Ri<H.lines;++Ri){for(var Pn=Qt[pt][wt],ki=0;ki<xt.width;++ki){for(var ts=0;ts<2*xt.type;++ts)pe[Pn++]=Vs[dn+ts*xt.width*xt.height];dn++}wt++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(pe.buffer)}function $e(H,X){for(var ne=new Uint8Array(H),pe=0;ne[X.value+pe]!=0;)pe+=1;var xe=new TextDecoder().decode(ne.slice(X.value,X.value+pe));return X.value=X.value+pe+1,xe}function Ze(H,X,ne){var pe=new TextDecoder().decode(new Uint8Array(H).slice(X.value,X.value+ne));return X.value=X.value+ne,pe}function ut(H,X){var ne=lt(H,X),pe=tt(H,X);return[ne,pe]}function Ct(H,X){var ne=tt(H,X),pe=tt(H,X);return[ne,pe]}function lt(H,X){var ne=H.getInt32(X.value,!0);return X.value=X.value+4,ne}function tt(H,X){var ne=H.getUint32(X.value,!0);return X.value=X.value+4,ne}function Je(H,X){var ne=H[X.value];return X.value=X.value+1,ne}function re(H,X){var ne=H.getUint8(X.value);return X.value=X.value+1,ne}const Re=function(H,X){let ne;return"getBigInt64"in DataView.prototype?ne=Number(H.getBigInt64(X.value,!0)):ne=H.getUint32(X.value+4,!0)+Number(H.getUint32(X.value,!0)<<32),X.value+=8,ne};function Ue(H,X){var ne=H.getFloat32(X.value,!0);return X.value+=4,ne}function Xe(H,X){return Jo.toHalfFloat(Ue(H,X))}function ve(H){var X=(H&31744)>>10,ne=H&1023;return(H>>15?-1:1)*(X?X===31?ne?NaN:1/0:Math.pow(2,X-15)*(1+ne/1024):6103515625e-14*(ne/1024))}function ft(H,X){var ne=H.getUint16(X.value,!0);return X.value+=2,ne}function ii(H,X){return ve(ft(H,X))}function kt(H,X,ne,pe){for(var xe=ne.value,Se=[];ne.value<xe+pe-1;){var Ge=$e(X,ne),Pe=lt(H,ne),Ne=re(H,ne);ne.value+=3;var Qe=lt(H,ne),ze=lt(H,ne);Se.push({name:Ge,pixelType:Pe,pLinear:Ne,xSampling:Qe,ySampling:ze})}return ne.value+=1,Se}function It(H,X){var ne=Ue(H,X),pe=Ue(H,X),xe=Ue(H,X),Se=Ue(H,X),Ge=Ue(H,X),Pe=Ue(H,X),Ne=Ue(H,X),Qe=Ue(H,X);return{redX:ne,redY:pe,greenX:xe,greenY:Se,blueX:Ge,blueY:Pe,whiteX:Ne,whiteY:Qe}}function Pt(H,X){var ne=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],pe=re(H,X);return ne[pe]}function ie(H,X){var ne=tt(H,X),pe=tt(H,X),xe=tt(H,X),Se=tt(H,X);return{xMin:ne,yMin:pe,xMax:xe,yMax:Se}}function P(H,X){var ne=["INCREASING_Y"],pe=re(H,X);return ne[pe]}function Y(H,X){var ne=Ue(H,X),pe=Ue(H,X);return[ne,pe]}function ae(H,X){var ne=Ue(H,X),pe=Ue(H,X),xe=Ue(H,X);return[ne,pe,xe]}function ke(H,X,ne,pe,xe){if(pe==="string"||pe==="stringvector"||pe==="iccProfile")return Ze(X,ne,xe);if(pe==="chlist")return kt(H,X,ne,xe);if(pe==="chromaticities")return It(H,ne);if(pe==="compression")return Pt(H,ne);if(pe==="box2i")return ie(H,ne);if(pe==="lineOrder")return P(H,ne);if(pe==="float")return Ue(H,ne);if(pe==="v2f")return Y(H,ne);if(pe==="v3f")return ae(H,ne);if(pe==="int")return lt(H,ne);if(pe==="rational")return ut(H,ne);if(pe==="timecode")return Ct(H,ne);if(pe==="preview")return ne.value+=xe,"skipped";ne.value+=xe}function at(H,X,ne){const pe={};if(H.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";pe.version=H.getUint8(4);const xe=H.getUint8(5);pe.spec={singleTile:!!(xe&2),longName:!!(xe&4),deepFormat:!!(xe&8),multiPart:!!(xe&16)},ne.value=8;for(var Se=!0;Se;){var Ge=$e(X,ne);if(Ge==0)Se=!1;else{var Pe=$e(X,ne),Ne=tt(H,ne),Qe=ke(H,X,ne,Pe,Ne);Qe===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${Pe}'.`):pe[Ge]=Qe}}if((xe&-5)!=0)throw console.error("EXRHeader:",pe),"THREE.EXRLoader: provided file is currently unsupported.";return pe}function bt(H,X,ne,pe,xe){const Se={size:0,viewer:X,array:ne,offset:pe,width:H.dataWindow.xMax-H.dataWindow.xMin+1,height:H.dataWindow.yMax-H.dataWindow.yMin+1,channels:H.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:H.channels[0].pixelType,uncompress:null,getter:null,format:null,[tl?"colorSpace":"encoding"]:null};switch(H.compression){case"NO_COMPRESSION":Se.lines=1,Se.uncompress=we;break;case"RLE_COMPRESSION":Se.lines=1,Se.uncompress=Le;break;case"ZIPS_COMPRESSION":Se.lines=1,Se.uncompress=Be;break;case"ZIP_COMPRESSION":Se.lines=16,Se.uncompress=Be;break;case"PIZ_COMPRESSION":Se.lines=32,Se.uncompress=qe;break;case"PXR24_COMPRESSION":Se.lines=16,Se.uncompress=Oe;break;case"DWAA_COMPRESSION":Se.lines=32,Se.uncompress=Ke;break;case"DWAB_COMPRESSION":Se.lines=256,Se.uncompress=Ke;break;default:throw"EXRLoader.parse: "+H.compression+" is unsupported"}if(Se.scanlineBlockSize=Se.lines,Se.type==1)switch(xe){case hi:Se.getter=ii,Se.inputSize=2;break;case Ai:Se.getter=ft,Se.inputSize=2;break}else if(Se.type==2)switch(xe){case hi:Se.getter=Ue,Se.inputSize=4;break;case Ai:Se.getter=Xe,Se.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+Se.type+" for "+H.compression+".";Se.blockCount=(H.dataWindow.yMax+1)/Se.scanlineBlockSize;for(var Ge=0;Ge<Se.blockCount;Ge++)Re(X,pe);Se.outputChannels=Se.channels==3?4:Se.channels;const Pe=Se.width*Se.height*Se.outputChannels;switch(xe){case hi:Se.byteArray=new Float32Array(Pe),Se.channels<Se.outputChannels&&Se.byteArray.fill(1,0,Pe);break;case Ai:Se.byteArray=new Uint16Array(Pe),Se.channels<Se.outputChannels&&Se.byteArray.fill(15360,0,Pe);break;default:console.error("THREE.EXRLoader: unsupported type: ",xe);break}return Se.bytesPerLine=Se.width*Se.inputSize*Se.channels,Se.outputChannels==4?Se.format=Mi:Se.format=Fs,tl?Se.colorSpace="srgb-linear":Se.encoding=3e3,Se}const Yt=new DataView(e),Pi=new Uint8Array(e),Bi={value:0},Ft=at(Yt,e,Bi),At=bt(Ft,Yt,Pi,Bi,this.type),ni={value:0},fn={R:0,G:1,B:2,A:3,Y:0};for(let H=0;H<At.height/At.scanlineBlockSize;H++){const X=tt(Yt,Bi);At.size=tt(Yt,Bi),At.lines=X+At.scanlineBlockSize>At.height?At.height-X:At.scanlineBlockSize;const pe=At.size<At.lines*At.bytesPerLine?At.uncompress(At):we(At);Bi.value+=At.size;for(let xe=0;xe<At.scanlineBlockSize;xe++){const Se=xe+H*At.scanlineBlockSize;if(Se>=At.height)break;for(let Ge=0;Ge<At.channels;Ge++){const Pe=fn[Ft.channels[Ge].name];for(let Ne=0;Ne<At.width;Ne++){ni.value=(xe*(At.channels*At.width)+Ge*At.width+Ne)*At.inputSize;const Qe=(At.height-1-Se)*(At.width*At.outputChannels)+Ne*At.outputChannels+Pe;At.byteArray[Qe]=At.getter(pe,ni)}}}}return{header:Ft,width:At.width,height:At.height,data:At.byteArray,format:At.format,[tl?"colorSpace":"encoding"]:At[tl?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){tl?o.colorSpace=a.colorSpace:o.encoding=a.encoding,o.minFilter=jt,o.magFilter=jt,o.generateMipmaps=!1,o.flipY=!1,t&&t(o,a)}return super.load(e,s,i,n)}}const mb="srgb",jf=(()=>{class r extends Ur{constructor(t){super(t),this.defaultDPI=90,this.defaultUnit="px"}load(t,i,n,s){const o=this,a=new In(o.manager);a.setPath(o.path),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(t,function(l){try{i(o.parse(l))}catch(c){s?s(c):console.error(c),o.manager.itemError(t)}},n,s)}parse(t){const i=this;function n(k,Q){if(k.nodeType!==1)return;const O=I(k);let U=!1,te=null;switch(k.nodeName){case"svg":Q=A(k,Q);break;case"style":o(k);break;case"g":Q=A(k,Q);break;case"path":Q=A(k,Q),k.hasAttribute("d")&&(te=s(k));break;case"rect":Q=A(k,Q),te=c(k);break;case"polygon":Q=A(k,Q),te=u(k);break;case"polyline":Q=A(k,Q),te=h(k);break;case"circle":Q=A(k,Q),te=f(k);break;case"ellipse":Q=A(k,Q),te=d(k);break;case"line":Q=A(k,Q),te=m(k);break;case"defs":U=!0;break;case"use":Q=A(k,Q);const se=(k.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),Ee=k.viewportElement.getElementById(se);Ee?n(Ee,Q):console.warn("SVGLoader: 'use node' references non-existent node id: "+se);break}te&&(Q.fill!==void 0&&Q.fill!=="none"&&te.color.setStyle(Q.fill,mb),x(te,$),R.push(te),te.userData={node:k,style:Q});const le=k.childNodes;for(let ee=0;ee<le.length;ee++){const se=le[ee];U&&se.nodeName!=="style"&&se.nodeName!=="defs"||n(se,Q)}O&&(G.pop(),G.length>0?$.copy(G[G.length-1]):$.identity())}function s(k){const Q=new Ir,O=new Fe,U=new Fe,te=new Fe;let le=!0,ee=!1;const se=k.getAttribute("d");if(se===""||se==="none")return null;const Ee=se.match(/[a-df-z][^a-df-z]*/gi);for(let Ie=0,oe=Ee.length;Ie<oe;Ie++){const ce=Ee[Ie],Ae=ce.charAt(0),he=ce.slice(1).trim();le===!0&&(ee=!0,le=!1);let Z;switch(Ae){case"M":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2)O.x=Z[J+0],O.y=Z[J+1],U.x=O.x,U.y=O.y,J===0?Q.moveTo(O.x,O.y):Q.lineTo(O.x,O.y),J===0&&te.copy(O);break;case"H":Z=g(he);for(let J=0,ue=Z.length;J<ue;J++)O.x=Z[J],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"V":Z=g(he);for(let J=0,ue=Z.length;J<ue;J++)O.y=Z[J],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"L":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2)O.x=Z[J+0],O.y=Z[J+1],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"C":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=6)Q.bezierCurveTo(Z[J+0],Z[J+1],Z[J+2],Z[J+3],Z[J+4],Z[J+5]),U.x=Z[J+2],U.y=Z[J+3],O.x=Z[J+4],O.y=Z[J+5],J===0&&ee===!0&&te.copy(O);break;case"S":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=4)Q.bezierCurveTo(p(O.x,U.x),p(O.y,U.y),Z[J+0],Z[J+1],Z[J+2],Z[J+3]),U.x=Z[J+0],U.y=Z[J+1],O.x=Z[J+2],O.y=Z[J+3],J===0&&ee===!0&&te.copy(O);break;case"Q":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=4)Q.quadraticCurveTo(Z[J+0],Z[J+1],Z[J+2],Z[J+3]),U.x=Z[J+0],U.y=Z[J+1],O.x=Z[J+2],O.y=Z[J+3],J===0&&ee===!0&&te.copy(O);break;case"T":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2){const Te=p(O.x,U.x),we=p(O.y,U.y);Q.quadraticCurveTo(Te,we,Z[J+0],Z[J+1]),U.x=Te,U.y=we,O.x=Z[J+0],O.y=Z[J+1],J===0&&ee===!0&&te.copy(O)}break;case"A":Z=g(he,[3,4],7);for(let J=0,ue=Z.length;J<ue;J+=7){if(Z[J+5]==O.x&&Z[J+6]==O.y)continue;const Te=O.clone();O.x=Z[J+5],O.y=Z[J+6],U.x=O.x,U.y=O.y,a(Q,Z[J],Z[J+1],Z[J+2],Z[J+3],Z[J+4],Te,O),J===0&&ee===!0&&te.copy(O)}break;case"m":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2)O.x+=Z[J+0],O.y+=Z[J+1],U.x=O.x,U.y=O.y,J===0?Q.moveTo(O.x,O.y):Q.lineTo(O.x,O.y),J===0&&te.copy(O);break;case"h":Z=g(he);for(let J=0,ue=Z.length;J<ue;J++)O.x+=Z[J],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"v":Z=g(he);for(let J=0,ue=Z.length;J<ue;J++)O.y+=Z[J],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"l":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2)O.x+=Z[J+0],O.y+=Z[J+1],U.x=O.x,U.y=O.y,Q.lineTo(O.x,O.y),J===0&&ee===!0&&te.copy(O);break;case"c":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=6)Q.bezierCurveTo(O.x+Z[J+0],O.y+Z[J+1],O.x+Z[J+2],O.y+Z[J+3],O.x+Z[J+4],O.y+Z[J+5]),U.x=O.x+Z[J+2],U.y=O.y+Z[J+3],O.x+=Z[J+4],O.y+=Z[J+5],J===0&&ee===!0&&te.copy(O);break;case"s":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=4)Q.bezierCurveTo(p(O.x,U.x),p(O.y,U.y),O.x+Z[J+0],O.y+Z[J+1],O.x+Z[J+2],O.y+Z[J+3]),U.x=O.x+Z[J+0],U.y=O.y+Z[J+1],O.x+=Z[J+2],O.y+=Z[J+3],J===0&&ee===!0&&te.copy(O);break;case"q":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=4)Q.quadraticCurveTo(O.x+Z[J+0],O.y+Z[J+1],O.x+Z[J+2],O.y+Z[J+3]),U.x=O.x+Z[J+0],U.y=O.y+Z[J+1],O.x+=Z[J+2],O.y+=Z[J+3],J===0&&ee===!0&&te.copy(O);break;case"t":Z=g(he);for(let J=0,ue=Z.length;J<ue;J+=2){const Te=p(O.x,U.x),we=p(O.y,U.y);Q.quadraticCurveTo(Te,we,O.x+Z[J+0],O.y+Z[J+1]),U.x=Te,U.y=we,O.x=O.x+Z[J+0],O.y=O.y+Z[J+1],J===0&&ee===!0&&te.copy(O)}break;case"a":Z=g(he,[3,4],7);for(let J=0,ue=Z.length;J<ue;J+=7){if(Z[J+5]==0&&Z[J+6]==0)continue;const Te=O.clone();O.x+=Z[J+5],O.y+=Z[J+6],U.x=O.x,U.y=O.y,a(Q,Z[J],Z[J+1],Z[J+2],Z[J+3],Z[J+4],Te,O),J===0&&ee===!0&&te.copy(O)}break;case"Z":case"z":Q.currentPath.autoClose=!0,Q.currentPath.curves.length>0&&(O.copy(te),Q.currentPath.currentPoint.copy(O),le=!0);break;default:console.warn(ce)}ee=!1}return Q}function o(k){if(!(!k.sheet||!k.sheet.cssRules||!k.sheet.cssRules.length))for(let Q=0;Q<k.sheet.cssRules.length;Q++){const O=k.sheet.cssRules[Q];if(O.type!==1)continue;const U=O.selectorText.split(/,/gm).filter(Boolean).map(te=>te.trim());for(let te=0;te<U.length;te++){const le=Object.fromEntries(Object.entries(O.style).filter(([,ee])=>ee!==""));D[U[te]]=Object.assign(D[U[te]]||{},le)}}}function a(k,Q,O,U,te,le,ee,se){if(Q==0||O==0){k.lineTo(se.x,se.y);return}U=U*Math.PI/180,Q=Math.abs(Q),O=Math.abs(O);const Ee=(ee.x-se.x)/2,Ie=(ee.y-se.y)/2,oe=Math.cos(U)*Ee+Math.sin(U)*Ie,ce=-Math.sin(U)*Ee+Math.cos(U)*Ie;let Ae=Q*Q,he=O*O;const Z=oe*oe,J=ce*ce,ue=Z/Ae+J/he;if(ue>1){const ut=Math.sqrt(ue);Q=ut*Q,O=ut*O,Ae=Q*Q,he=O*O}const Te=Ae*J+he*Z,we=(Ae*he-Te)/Te;let Le=Math.sqrt(Math.max(0,we));te===le&&(Le=-Le);const Be=Le*Q*ce/O,qe=-Le*O*oe/Q,Oe=Math.cos(U)*Be-Math.sin(U)*qe+(ee.x+se.x)/2,Ke=Math.sin(U)*Be+Math.cos(U)*qe+(ee.y+se.y)/2,$e=l(1,0,(oe-Be)/Q,(ce-qe)/O),Ze=l((oe-Be)/Q,(ce-qe)/O,(-oe-Be)/Q,(-ce-qe)/O)%(Math.PI*2);k.currentPath.absellipse(Oe,Ke,Q,O,$e,$e+Ze,le===0,U)}function l(k,Q,O,U){const te=k*O+Q*U,le=Math.sqrt(k*k+Q*Q)*Math.sqrt(O*O+U*U);let ee=Math.acos(Math.max(-1,Math.min(1,te/le)));return k*U-Q*O<0&&(ee=-ee),ee}function c(k){const Q=C(k.getAttribute("x")||0),O=C(k.getAttribute("y")||0),U=C(k.getAttribute("rx")||k.getAttribute("ry")||0),te=C(k.getAttribute("ry")||k.getAttribute("rx")||0),le=C(k.getAttribute("width")),ee=C(k.getAttribute("height")),se=1-.551915024494,Ee=new Ir;return Ee.moveTo(Q+U,O),Ee.lineTo(Q+le-U,O),(U!==0||te!==0)&&Ee.bezierCurveTo(Q+le-U*se,O,Q+le,O+te*se,Q+le,O+te),Ee.lineTo(Q+le,O+ee-te),(U!==0||te!==0)&&Ee.bezierCurveTo(Q+le,O+ee-te*se,Q+le-U*se,O+ee,Q+le-U,O+ee),Ee.lineTo(Q+U,O+ee),(U!==0||te!==0)&&Ee.bezierCurveTo(Q+U*se,O+ee,Q,O+ee-te*se,Q,O+ee-te),Ee.lineTo(Q,O+te),(U!==0||te!==0)&&Ee.bezierCurveTo(Q,O+te*se,Q+U*se,O,Q+U,O),Ee}function u(k){function Q(le,ee,se){const Ee=C(ee),Ie=C(se);te===0?U.moveTo(Ee,Ie):U.lineTo(Ee,Ie),te++}const O=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,U=new Ir;let te=0;return k.getAttribute("points").replace(O,Q),U.currentPath.autoClose=!0,U}function h(k){function Q(le,ee,se){const Ee=C(ee),Ie=C(se);te===0?U.moveTo(Ee,Ie):U.lineTo(Ee,Ie),te++}const O=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,U=new Ir;let te=0;return k.getAttribute("points").replace(O,Q),U.currentPath.autoClose=!1,U}function f(k){const Q=C(k.getAttribute("cx")||0),O=C(k.getAttribute("cy")||0),U=C(k.getAttribute("r")||0),te=new gf;te.absarc(Q,O,U,0,Math.PI*2);const le=new Ir;return le.subPaths.push(te),le}function d(k){const Q=C(k.getAttribute("cx")||0),O=C(k.getAttribute("cy")||0),U=C(k.getAttribute("rx")||0),te=C(k.getAttribute("ry")||0),le=new gf;le.absellipse(Q,O,U,te,0,Math.PI*2);const ee=new Ir;return ee.subPaths.push(le),ee}function m(k){const Q=C(k.getAttribute("x1")||0),O=C(k.getAttribute("y1")||0),U=C(k.getAttribute("x2")||0),te=C(k.getAttribute("y2")||0),le=new Ir;return le.moveTo(Q,O),le.lineTo(U,te),le.currentPath.autoClose=!1,le}function A(k,Q){Q=Object.assign({},Q);let O={};if(k.hasAttribute("class")){const ee=k.getAttribute("class").split(/\s/).filter(Boolean).map(se=>se.trim());for(let se=0;se<ee.length;se++)O=Object.assign(O,D["."+ee[se]])}k.hasAttribute("id")&&(O=Object.assign(O,D["#"+k.getAttribute("id")]));function U(ee,se,Ee){Ee===void 0&&(Ee=function(oe){return oe.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),oe}),k.hasAttribute(ee)&&(Q[se]=Ee(k.getAttribute(ee))),O[ee]&&(Q[se]=Ee(O[ee])),k.style&&k.style[ee]!==""&&(Q[se]=Ee(k.style[ee]))}function te(ee){return Math.max(0,Math.min(1,C(ee)))}function le(ee){return Math.max(0,C(ee))}return U("fill","fill"),U("fill-opacity","fillOpacity",te),U("fill-rule","fillRule"),U("opacity","opacity",te),U("stroke","stroke"),U("stroke-opacity","strokeOpacity",te),U("stroke-width","strokeWidth",le),U("stroke-linejoin","strokeLineJoin"),U("stroke-linecap","strokeLineCap"),U("stroke-miterlimit","strokeMiterLimit",le),U("visibility","visibility"),Q}function p(k,Q){return k-(Q-k)}function g(k,Q,O){if(typeof k!="string")throw new TypeError("Invalid input: "+typeof k);const U={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},te=0,le=1,ee=2,se=3;let Ee=te,Ie=!0,oe="",ce="";const Ae=[];function he(Te,we,Le){const Be=new SyntaxError('Unexpected character "'+Te+'" at index '+we+".");throw Be.partial=Le,Be}function Z(){oe!==""&&(ce===""?Ae.push(Number(oe)):Ae.push(Number(oe)*Math.pow(10,Number(ce)))),oe="",ce=""}let J;const ue=k.length;for(let Te=0;Te<ue;Te++){if(J=k[Te],Array.isArray(Q)&&Q.includes(Ae.length%O)&&U.FLAGS.test(J)){Ee=le,oe=J,Z();continue}if(Ee===te){if(U.WHITESPACE.test(J))continue;if(U.DIGIT.test(J)||U.SIGN.test(J)){Ee=le,oe=J;continue}if(U.POINT.test(J)){Ee=ee,oe=J;continue}U.COMMA.test(J)&&(Ie&&he(J,Te,Ae),Ie=!0)}if(Ee===le){if(U.DIGIT.test(J)){oe+=J;continue}if(U.POINT.test(J)){oe+=J,Ee=ee;continue}if(U.EXP.test(J)){Ee=se;continue}U.SIGN.test(J)&&oe.length===1&&U.SIGN.test(oe[0])&&he(J,Te,Ae)}if(Ee===ee){if(U.DIGIT.test(J)){oe+=J;continue}if(U.EXP.test(J)){Ee=se;continue}U.POINT.test(J)&&oe[oe.length-1]==="."&&he(J,Te,Ae)}if(Ee===se){if(U.DIGIT.test(J)){ce+=J;continue}if(U.SIGN.test(J)){if(ce===""){ce+=J;continue}ce.length===1&&U.SIGN.test(ce)&&he(J,Te,Ae)}}U.WHITESPACE.test(J)?(Z(),Ee=te,Ie=!1):U.COMMA.test(J)?(Z(),Ee=te,Ie=!0):U.SIGN.test(J)?(Z(),Ee=le,oe=J):U.POINT.test(J)?(Z(),Ee=ee,oe=J):he(J,Te,Ae)}return Z(),Ae}const v=["mm","cm","in","pt","pc","px"],E={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:72/6,pc:1,px:-1},px:{px:1}};function C(k){let Q="px";if(typeof k=="string"||k instanceof String)for(let U=0,te=v.length;U<te;U++){const le=v[U];if(k.endsWith(le)){Q=le,k=k.substring(0,k.length-le.length);break}}let O;return Q==="px"&&i.defaultUnit!=="px"?O=E.in[i.defaultUnit]/i.defaultDPI:(O=E[Q][i.defaultUnit],O<0&&(O=E[Q].in*i.defaultDPI)),O*parseFloat(k)}function I(k){if(!(k.hasAttribute("transform")||k.nodeName==="use"&&(k.hasAttribute("x")||k.hasAttribute("y"))))return null;const Q=_(k);return G.length>0&&Q.premultiply(G[G.length-1]),$.copy(Q),G.push(Q),Q}function _(k){const Q=new bn,O=z;if(k.nodeName==="use"&&(k.hasAttribute("x")||k.hasAttribute("y"))){const U=C(k.getAttribute("x")),te=C(k.getAttribute("y"));Q.translate(U,te)}if(k.hasAttribute("transform")){const U=k.getAttribute("transform").split(")");for(let te=U.length-1;te>=0;te--){const le=U[te].trim();if(le==="")continue;const ee=le.indexOf("("),se=le.length;if(ee>0&&ee<se){const Ee=le.slice(0,ee),Ie=g(le.slice(ee+1));switch(O.identity(),Ee){case"translate":if(Ie.length>=1){const oe=Ie[0];let ce=0;Ie.length>=2&&(ce=Ie[1]),O.translate(oe,ce)}break;case"rotate":if(Ie.length>=1){let oe=0,ce=0,Ae=0;oe=Ie[0]*Math.PI/180,Ie.length>=3&&(ce=Ie[1],Ae=Ie[2]),W.makeTranslation(-ce,-Ae),q.makeRotation(oe),F.multiplyMatrices(q,W),W.makeTranslation(ce,Ae),O.multiplyMatrices(W,F)}break;case"scale":if(Ie.length>=1){const oe=Ie[0];let ce=oe;Ie.length>=2&&(ce=Ie[1]),O.scale(oe,ce)}break;case"skewX":Ie.length===1&&O.set(1,Math.tan(Ie[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":Ie.length===1&&O.set(1,0,0,Math.tan(Ie[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":Ie.length===6&&O.set(Ie[0],Ie[2],Ie[4],Ie[1],Ie[3],Ie[5],0,0,1);break}}Q.premultiply(O)}}return Q}function x(k,Q){function O(ee){L.set(ee.x,ee.y,1).applyMatrix3(Q),ee.set(L.x,L.y)}function U(ee){const se=ee.xRadius,Ee=ee.yRadius,Ie=Math.cos(ee.aRotation),oe=Math.sin(ee.aRotation),ce=new K(se*Ie,se*oe,0),Ae=new K(-Ee*oe,Ee*Ie,0),he=ce.applyMatrix3(Q),Z=Ae.applyMatrix3(Q),J=z.set(he.x,Z.x,0,he.y,Z.y,0,0,0,1),ue=W.copy(J).invert(),Le=q.copy(ue).transpose().multiply(ue).elements,Be=w(Le[0],Le[1],Le[4]),qe=Math.sqrt(Be.rt1),Oe=Math.sqrt(Be.rt2);if(ee.xRadius=1/qe,ee.yRadius=1/Oe,ee.aRotation=Math.atan2(Be.sn,Be.cs),!((ee.aEndAngle-ee.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const $e=W.set(qe,0,0,0,Oe,0,0,0,1),Ze=q.set(Be.cs,Be.sn,0,-Be.sn,Be.cs,0,0,0,1),ut=$e.multiply(Ze).multiply(J),Ct=lt=>{const{x:tt,y:Je}=new K(Math.cos(lt),Math.sin(lt),0).applyMatrix3(ut);return Math.atan2(Je,tt)};ee.aStartAngle=Ct(ee.aStartAngle),ee.aEndAngle=Ct(ee.aEndAngle),S(Q)&&(ee.aClockwise=!ee.aClockwise)}}function te(ee){const se=T(Q),Ee=B(Q);ee.xRadius*=se,ee.yRadius*=Ee;const Ie=se>Number.EPSILON?Math.atan2(Q.elements[1],Q.elements[0]):Math.atan2(-Q.elements[3],Q.elements[4]);ee.aRotation+=Ie,S(Q)&&(ee.aStartAngle*=-1,ee.aEndAngle*=-1,ee.aClockwise=!ee.aClockwise)}const le=k.subPaths;for(let ee=0,se=le.length;ee<se;ee++){const Ie=le[ee].curves;for(let oe=0;oe<Ie.length;oe++){const ce=Ie[oe];ce.isLineCurve?(O(ce.v1),O(ce.v2)):ce.isCubicBezierCurve?(O(ce.v0),O(ce.v1),O(ce.v2),O(ce.v3)):ce.isQuadraticBezierCurve?(O(ce.v0),O(ce.v1),O(ce.v2)):ce.isEllipseCurve&&(N.set(ce.aX,ce.aY),O(N),ce.aX=N.x,ce.aY=N.y,b(Q)?U(ce):te(ce))}}}function S(k){const Q=k.elements;return Q[0]*Q[4]-Q[1]*Q[3]<0}function b(k){const Q=k.elements,O=Q[0]*Q[3]+Q[1]*Q[4];if(O===0)return!1;const U=T(k),te=B(k);return Math.abs(O/(U*te))>Number.EPSILON}function T(k){const Q=k.elements;return Math.sqrt(Q[0]*Q[0]+Q[1]*Q[1])}function B(k){const Q=k.elements;return Math.sqrt(Q[3]*Q[3]+Q[4]*Q[4])}function w(k,Q,O){let U,te,le,ee,se;const Ee=k+O,Ie=k-O,oe=Math.sqrt(Ie*Ie+4*Q*Q);return Ee>0?(U=.5*(Ee+oe),se=1/U,te=k*se*O-Q*se*Q):Ee<0?te=.5*(Ee-oe):(U=.5*oe,te=-.5*oe),Ie>0?le=Ie+oe:le=Ie-oe,Math.abs(le)>2*Math.abs(Q)?(se=-2*Q/le,ee=1/Math.sqrt(1+se*se),le=se*ee):Math.abs(Q)===0?(le=1,ee=0):(se=-.5*le/Q,le=1/Math.sqrt(1+se*se),ee=se*le),Ie>0&&(se=le,le=-ee,ee=se),{rt1:U,rt2:te,cs:le,sn:ee}}const R=[],D={},G=[],z=new bn,W=new bn,q=new bn,F=new bn,N=new Fe,L=new K,$=new bn,j=new DOMParser().parseFromString(t,"image/svg+xml");return n(j.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:R,xml:j.documentElement}}static createShapes(t){const n={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},s={loc:n.ORIGIN,t:0};function o(p,g,v,E){const C=p.x,I=g.x,_=v.x,x=E.x,S=p.y,b=g.y,T=v.y,B=E.y,w=(x-_)*(S-T)-(B-T)*(C-_),R=(I-C)*(S-T)-(b-S)*(C-_),D=(B-T)*(I-C)-(x-_)*(b-S),G=w/D,z=R/D;if(D===0&&w!==0||G<=0||G>=1||z<0||z>1)return null;if(w===0&&D===0){for(let W=0;W<2;W++)if(a(W===0?v:E,p,g),s.loc==n.ORIGIN){const q=W===0?v:E;return{x:q.x,y:q.y,t:s.t}}else if(s.loc==n.BETWEEN){const q=+(C+s.t*(I-C)).toPrecision(10),F=+(S+s.t*(b-S)).toPrecision(10);return{x:q,y:F,t:s.t}}return null}else{for(let F=0;F<2;F++)if(a(F===0?v:E,p,g),s.loc==n.ORIGIN){const N=F===0?v:E;return{x:N.x,y:N.y,t:s.t}}const W=+(C+G*(I-C)).toPrecision(10),q=+(S+G*(b-S)).toPrecision(10);return{x:W,y:q,t:G}}}function a(p,g,v){const E=v.x-g.x,C=v.y-g.y,I=p.x-g.x,_=p.y-g.y,x=E*_-I*C;if(p.x===g.x&&p.y===g.y){s.loc=n.ORIGIN,s.t=0;return}if(p.x===v.x&&p.y===v.y){s.loc=n.DESTINATION,s.t=1;return}if(x<-Number.EPSILON){s.loc=n.LEFT;return}if(x>Number.EPSILON){s.loc=n.RIGHT;return}if(E*I<0||C*_<0){s.loc=n.BEHIND;return}if(Math.sqrt(E*E+C*C)<Math.sqrt(I*I+_*_)){s.loc=n.BEYOND;return}let S;E!==0?S=I/E:S=_/C,s.loc=n.BETWEEN,s.t=S}function l(p,g){const v=[],E=[];for(let C=1;C<p.length;C++){const I=p[C-1],_=p[C];for(let x=1;x<g.length;x++){const S=g[x-1],b=g[x],T=o(I,_,S,b);T!==null&&v.find(B=>B.t<=T.t+Number.EPSILON&&B.t>=T.t-Number.EPSILON)===void 0&&(v.push(T),E.push(new Fe(T.x,T.y)))}}return E}function c(p,g,v){const E=new Fe;g.getCenter(E);const C=[];return v.forEach(I=>{I.boundingBox.containsPoint(E)&&l(p,I.points).forEach(x=>{C.push({identifier:I.identifier,isCW:I.isCW,point:x})})}),C.sort((I,_)=>I.point.x-_.point.x),C}function u(p,g,v,E,C){(C==null||C==="")&&(C="nonzero");const I=new Fe;p.boundingBox.getCenter(I);const _=[new Fe(v,I.y),new Fe(E,I.y)],x=c(_,p.boundingBox,g);x.sort((R,D)=>R.point.x-D.point.x);const S=[],b=[];x.forEach(R=>{R.identifier===p.identifier?S.push(R):b.push(R)});const T=S[0].point.x,B=[];let w=0;for(;w<b.length&&b[w].point.x<T;)B.length>0&&B[B.length-1]===b[w].identifier?B.pop():B.push(b[w].identifier),w++;if(B.push(p.identifier),C==="evenodd"){const R=B.length%2===0,D=B[B.length-2];return{identifier:p.identifier,isHole:R,for:D}}else if(C==="nonzero"){let R=!0,D=null,G=null;for(let z=0;z<B.length;z++){const W=B[z];R?(G=g[W].isCW,R=!1,D=W):G!==g[W].isCW&&(G=g[W].isCW,R=!0)}return{identifier:p.identifier,isHole:R,for:D}}else console.warn('fill-rule: "'+C+'" is currently not implemented.')}let h=999999999,f=-999999999,d=t.subPaths.map(p=>{const g=p.getPoints();let v=-999999999,E=999999999,C=-999999999,I=999999999;for(let _=0;_<g.length;_++){const x=g[_];x.y>v&&(v=x.y),x.y<E&&(E=x.y),x.x>C&&(C=x.x),x.x<I&&(I=x.x)}return f<=C&&(f=C+1),h>=I&&(h=I-1),{curves:p.curves,points:g,isCW:u_.isClockWise(g),identifier:-1,boundingBox:new c_(new Fe(I,E),new Fe(C,v))}});d=d.filter(p=>p.points.length>1);for(let p=0;p<d.length;p++)d[p].identifier=p;const m=d.map(p=>u(p,d,h,f,t.userData?t.userData.style.fillRule:void 0)),A=[];return d.forEach(p=>{if(!m[p.identifier].isHole){const v=new Q2;v.curves=p.curves,m.filter(C=>C.isHole&&C.for===p.identifier).forEach(C=>{const I=d[C.identifier],_=new gf;_.curves=I.curves,v.holes.push(_)}),A.push(v)}}),A}static getStrokeStyle(t,i,n,s,o){return t=t!==void 0?t:1,i=i!==void 0?i:"#000",n=n!==void 0?n:"miter",s=s!==void 0?s:"butt",o=o!==void 0?o:4,{strokeColor:i,strokeWidth:t,strokeLineJoin:n,strokeLineCap:s,strokeMiterLimit:o}}static pointsToStroke(t,i,n,s){const o=[],a=[],l=[];if(r.pointsToStrokeWithBuffers(t,i,n,s,o,a,l)===0)return null;const c=new Gi;return c.setAttribute("position",new ji(o,3)),c.setAttribute("normal",new ji(a,3)),c.setAttribute("uv",new ji(l,2)),c}static pointsToStrokeWithBuffers(t,i,n,s,o,a,l,c){const u=new Fe,h=new Fe,f=new Fe,d=new Fe,m=new Fe,A=new Fe,p=new Fe,g=new Fe,v=new Fe,E=new Fe,C=new Fe,I=new Fe,_=new Fe,x=new Fe,S=new Fe,b=new Fe,T=new Fe;n=n!==void 0?n:12,s=s!==void 0?s:.001,c=c!==void 0?c:0,t=Ie(t);const B=t.length;if(B<2)return 0;const w=t[0].equals(t[B-1]);let R,D=t[0],G;const z=i.strokeWidth/2,W=1/(B-1);let q=0,F,N,L,$,j=!1,V=0,k=c*3,Q=c*2;O(t[0],t[1],u).multiplyScalar(z),g.copy(t[0]).sub(u),v.copy(t[0]).add(u),E.copy(g),C.copy(v);for(let oe=1;oe<B;oe++){R=t[oe],oe===B-1?w?G=t[1]:G=void 0:G=t[oe+1];const ce=u;if(O(D,R,ce),f.copy(ce).multiplyScalar(z),I.copy(R).sub(f),_.copy(R).add(f),F=q+W,N=!1,G!==void 0){O(R,G,h),f.copy(h).multiplyScalar(z),x.copy(R).sub(f),S.copy(R).add(f),L=!0,f.subVectors(G,D),ce.dot(f)<0&&(L=!1),oe===1&&(j=L),f.subVectors(G,R),f.normalize();const Ae=Math.abs(ce.dot(f));if(Ae>Number.EPSILON){const he=z/Ae;f.multiplyScalar(-he),d.subVectors(R,D),m.copy(d).setLength(he).add(f),b.copy(m).negate();const Z=m.length(),J=d.length();d.divideScalar(J),A.subVectors(G,R);const ue=A.length();switch(A.divideScalar(ue),d.dot(b)<J&&A.dot(b)<ue&&(N=!0),T.copy(m).add(R),b.add(R),$=!1,N?L?(S.copy(b),_.copy(b)):(x.copy(b),I.copy(b)):le(),i.strokeLineJoin){case"bevel":ee(L,N,F);break;case"round":se(L,N),L?te(R,I,x,F,0):te(R,S,_,F,1);break;case"miter":case"miter-clip":default:const Te=z*i.strokeMiterLimit/Z;if(Te<1)if(i.strokeLineJoin!=="miter-clip"){ee(L,N,F);break}else se(L,N),L?(A.subVectors(T,I).multiplyScalar(Te).add(I),p.subVectors(T,x).multiplyScalar(Te).add(x),U(I,F,0),U(A,F,0),U(R,F,.5),U(R,F,.5),U(A,F,0),U(p,F,0),U(R,F,.5),U(p,F,0),U(x,F,0)):(A.subVectors(T,_).multiplyScalar(Te).add(_),p.subVectors(T,S).multiplyScalar(Te).add(S),U(_,F,1),U(A,F,1),U(R,F,.5),U(R,F,.5),U(A,F,1),U(p,F,1),U(R,F,.5),U(p,F,1),U(S,F,1));else N?(L?(U(v,q,1),U(g,q,0),U(T,F,0),U(v,q,1),U(T,F,0),U(b,F,1)):(U(v,q,1),U(g,q,0),U(T,F,1),U(g,q,0),U(b,F,0),U(T,F,1)),L?x.copy(T):S.copy(T)):L?(U(I,F,0),U(T,F,0),U(R,F,.5),U(R,F,.5),U(T,F,0),U(x,F,0)):(U(_,F,1),U(T,F,1),U(R,F,.5),U(R,F,.5),U(T,F,1),U(S,F,1)),$=!0;break}}else le()}else le();!w&&oe===B-1&&Ee(t[0],E,C,L,!0,q),q=F,D=R,g.copy(x),v.copy(S)}if(!w)Ee(R,I,_,L,!1,F);else if(N&&o){let oe=T,ce=b;j!==L&&(oe=b,ce=T),L?($||j)&&(ce.toArray(o,0*3),ce.toArray(o,3*3),$&&oe.toArray(o,1*3)):($||!j)&&(ce.toArray(o,1*3),ce.toArray(o,3*3),$&&oe.toArray(o,0*3))}return V;function O(oe,ce,Ae){return Ae.subVectors(ce,oe),Ae.set(-Ae.y,Ae.x).normalize()}function U(oe,ce,Ae){o&&(o[k]=oe.x,o[k+1]=oe.y,o[k+2]=0,a&&(a[k]=0,a[k+1]=0,a[k+2]=1),k+=3,l&&(l[Q]=ce,l[Q+1]=Ae,Q+=2)),V+=3}function te(oe,ce,Ae,he,Z){u.copy(ce).sub(oe).normalize(),h.copy(Ae).sub(oe).normalize();let J=Math.PI;const ue=u.dot(h);Math.abs(ue)<1&&(J=Math.abs(Math.acos(ue))),J/=n,f.copy(ce);for(let Te=0,we=n-1;Te<we;Te++)d.copy(f).rotateAround(oe,J),U(f,he,Z),U(d,he,Z),U(oe,he,.5),f.copy(d);U(d,he,Z),U(Ae,he,Z),U(oe,he,.5)}function le(){U(v,q,1),U(g,q,0),U(I,F,0),U(v,q,1),U(I,F,0),U(_,F,1)}function ee(oe,ce,Ae){ce?oe?(U(v,q,1),U(g,q,0),U(I,F,0),U(v,q,1),U(I,F,0),U(b,F,1),U(I,Ae,0),U(x,Ae,0),U(b,Ae,.5)):(U(v,q,1),U(g,q,0),U(_,F,1),U(g,q,0),U(b,F,0),U(_,F,1),U(_,Ae,1),U(b,Ae,0),U(S,Ae,1)):oe?(U(I,Ae,0),U(x,Ae,0),U(R,Ae,.5)):(U(_,Ae,1),U(S,Ae,0),U(R,Ae,.5))}function se(oe,ce){ce&&(oe?(U(v,q,1),U(g,q,0),U(I,F,0),U(v,q,1),U(I,F,0),U(b,F,1),U(I,q,0),U(R,F,.5),U(b,F,1),U(R,F,.5),U(x,q,0),U(b,F,1)):(U(v,q,1),U(g,q,0),U(_,F,1),U(g,q,0),U(b,F,0),U(_,F,1),U(_,q,1),U(b,F,0),U(R,F,.5),U(R,F,.5),U(b,F,0),U(S,q,1)))}function Ee(oe,ce,Ae,he,Z,J){switch(i.strokeLineCap){case"round":Z?te(oe,Ae,ce,J,.5):te(oe,ce,Ae,J,.5);break;case"square":if(Z)u.subVectors(ce,oe),h.set(u.y,-u.x),f.addVectors(u,h).add(oe),d.subVectors(h,u).add(oe),he?(f.toArray(o,1*3),d.toArray(o,0*3),d.toArray(o,3*3)):(f.toArray(o,1*3),l[3*2+1]===1?d.toArray(o,3*3):f.toArray(o,3*3),d.toArray(o,0*3));else{u.subVectors(Ae,oe),h.set(u.y,-u.x),f.addVectors(u,h).add(oe),d.subVectors(h,u).add(oe);const ue=o.length;he?(f.toArray(o,ue-1*3),d.toArray(o,ue-2*3),d.toArray(o,ue-4*3)):(d.toArray(o,ue-2*3),f.toArray(o,ue-1*3),d.toArray(o,ue-4*3))}break}}function Ie(oe){let ce=!1;for(let he=1,Z=oe.length-1;he<Z;he++)if(oe[he].distanceTo(oe[he+1])<s){ce=!0;break}if(!ce)return oe;const Ae=[];Ae.push(oe[0]);for(let he=1,Z=oe.length-1;he<Z;he++)oe[he].distanceTo(oe[he+1])>=s&&Ae.push(oe[he]);return Ae.push(oe[oe.length-1]),Ae}}}return r})(),Yf=new WeakMap;class Ab extends Ur{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,n){const s=new In(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{const a={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,a).then(t).catch(n)},i,n)}decodeDracoFile(e,t,i,n){const s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,s).then(t)}decodeGeometry(e,t){for(const l in t.attributeTypes){const c=t.attributeTypes[l];c.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[l]=c.name)}const i=JSON.stringify(t);if(Yf.has(e)){const l=Yf.get(e);if(l.key===i)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(s,o).then(l=>(n=l,new Promise((c,u)=>{n._callbacks[s]={resolve:c,reject:u},n.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return a.catch(()=>!0).then(()=>{n&&s&&this._releaseTask(n,s)}),Yf.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new Gi;e.index&&t.setIndex(new Jt(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const n=e.attributes[i],s=n.name,o=n.array,a=n.itemSize;t.setAttribute(s,new Jt(o,a))}return t}_loadLibrary(e,t){const i=new In(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((n,s)=>{i.load(e,n,void 0,s)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const n=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const s=pb.toString(),o=["/* draco decoder */",n,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(s){const o=s.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,s){return n._taskLoad>s._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function pb(){let r,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":r=a.decoderConfig,e=new Promise(function(u){r.onModuleLoaded=function(h){u({draco:h})},DracoDecoderModule(r)});break;case"decode":const l=a.buffer,c=a.taskConfig;e.then(u=>{const h=u.draco,f=new h.Decoder,d=new h.DecoderBuffer;d.Init(new Int8Array(l),l.byteLength);try{const m=t(h,f,d,c),A=m.attributes.map(p=>p.array.buffer);m.index&&A.push(m.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:m},A)}catch(m){console.error(m),self.postMessage({type:"error",id:a.id,error:m.message})}finally{h.destroy(d),h.destroy(f)}});break}};function t(o,a,l,c){const u=c.attributeIDs,h=c.attributeTypes;let f,d;const m=a.GetEncodedGeometryType(l);if(m===o.TRIANGULAR_MESH)f=new o.Mesh,d=a.DecodeBufferToMesh(l,f);else if(m===o.POINT_CLOUD)f=new o.PointCloud,d=a.DecodeBufferToPointCloud(l,f);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!d.ok()||f.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+d.error_msg());const A={index:null,attributes:[]};for(const p in u){const g=self[h[p]];let v,E;if(c.useUniqueIDs)E=u[p],v=a.GetAttributeByUniqueId(f,E);else{if(E=a.GetAttributeId(f,o[u[p]]),E===-1)continue;v=a.GetAttribute(f,E)}A.attributes.push(n(o,a,f,p,g,v))}return m===o.TRIANGULAR_MESH&&(A.index=i(o,a,f)),o.destroy(f),A}function i(o,a,l){const u=l.num_faces()*3,h=u*4,f=o._malloc(h);a.GetTrianglesUInt32Array(l,h,f);const d=new Uint32Array(o.HEAPF32.buffer,f,u).slice();return o._free(f),{array:d,itemSize:1}}function n(o,a,l,c,u,h){const f=h.num_components(),m=l.num_points()*f,A=m*u.BYTES_PER_ELEMENT,p=s(o,u),g=o._malloc(A);a.GetAttributeDataArrayForAllPoints(l,h,p,A,g);const v=new u(o.HEAPF32.buffer,g,m).slice();return o._free(g),{name:c,array:v,itemSize:f}}function s(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const e1=new oi,Gc=new K;class zh extends Um{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.setAttribute("position",new ji(e,3)),this.setAttribute("uv",new ji(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new B0(t,6,1);return this.setAttribute("instanceStart",new eo(i,3,0)),this.setAttribute("instanceEnd",new eo(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let i;e instanceof Float32Array?i=e:Array.isArray(e)&&(i=new Float32Array(e));const n=new B0(i,t*2,1);return this.setAttribute("instanceColorStart",new eo(n,t,0)),this.setAttribute("instanceColorEnd",new eo(n,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new h_(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new oi);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),e1.setFromBufferAttribute(t),this.boundingBox.union(e1))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new un),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let n=0;for(let s=0,o=e.count;s<o;s++)Gc.fromBufferAttribute(e,s),n=Math.max(n,i.distanceToSquared(Gc)),Gc.fromBufferAttribute(t,s),n=Math.max(n,i.distanceToSquared(Gc));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class P3 extends zh{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return super.setPositions(i),this}setColors(e,t=3){const i=e.length-t,n=new Float32Array(2*i);if(t===3)for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5];else for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5],n[2*s+6]=e[s+6],n[2*s+7]=e[s+7];return super.setColors(n,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Hh extends bi{constructor(e){super({type:"LineMaterial",uniforms:Kl.clone(Kl.merge([R0.common,R0.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new Fe(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${cc>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const Wf=new Ci,t1=new K,i1=new K,qi=new Ci,Xi=new Ci,Cs=new Ci,qf=new K,Xf=new Me,en=new Ns,n1=new K,Qc=new oi,zc=new un,Is=new Ci;let Ps,so;function s1(r,e,t){return Is.set(0,0,-e,1).applyMatrix4(r.projectionMatrix),Is.multiplyScalar(1/Is.w),Is.x=so/t.width,Is.y=so/t.height,Is.applyMatrix4(r.projectionMatrixInverse),Is.multiplyScalar(1/Is.w),Math.abs(Math.max(Is.x,Is.y))}function gb(r,e){const t=r.matrixWorld,i=r.geometry,n=i.attributes.instanceStart,s=i.attributes.instanceEnd,o=Math.min(i.instanceCount,n.count);for(let a=0,l=o;a<l;a++){en.start.fromBufferAttribute(n,a),en.end.fromBufferAttribute(s,a),en.applyMatrix4(t);const c=new K,u=new K;Ps.distanceSqToSegment(en.start,en.end,u,c),u.distanceTo(c)<so*.5&&e.push({point:u,pointOnLine:c,distance:Ps.origin.distanceTo(u),object:r,face:null,faceIndex:a,uv:null,[aA]:null})}}function yb(r,e,t){const i=e.projectionMatrix,s=r.material.resolution,o=r.matrixWorld,a=r.geometry,l=a.attributes.instanceStart,c=a.attributes.instanceEnd,u=Math.min(a.instanceCount,l.count),h=-e.near;Ps.at(1,Cs),Cs.w=1,Cs.applyMatrix4(e.matrixWorldInverse),Cs.applyMatrix4(i),Cs.multiplyScalar(1/Cs.w),Cs.x*=s.x/2,Cs.y*=s.y/2,Cs.z=0,qf.copy(Cs),Xf.multiplyMatrices(e.matrixWorldInverse,o);for(let f=0,d=u;f<d;f++){if(qi.fromBufferAttribute(l,f),Xi.fromBufferAttribute(c,f),qi.w=1,Xi.w=1,qi.applyMatrix4(Xf),Xi.applyMatrix4(Xf),qi.z>h&&Xi.z>h)continue;if(qi.z>h){const E=qi.z-Xi.z,C=(qi.z-h)/E;qi.lerp(Xi,C)}else if(Xi.z>h){const E=Xi.z-qi.z,C=(Xi.z-h)/E;Xi.lerp(qi,C)}qi.applyMatrix4(i),Xi.applyMatrix4(i),qi.multiplyScalar(1/qi.w),Xi.multiplyScalar(1/Xi.w),qi.x*=s.x/2,qi.y*=s.y/2,Xi.x*=s.x/2,Xi.y*=s.y/2,en.start.copy(qi),en.start.z=0,en.end.copy(Xi),en.end.z=0;const A=en.closestPointToPointParameter(qf,!0);en.at(A,n1);const p=ot.lerp(qi.z,Xi.z,A),g=p>=-1&&p<=1,v=qf.distanceTo(n1)<so*.5;if(g&&v){en.start.fromBufferAttribute(l,f),en.end.fromBufferAttribute(c,f),en.start.applyMatrix4(o),en.end.applyMatrix4(o);const E=new K,C=new K;Ps.distanceSqToSegment(en.start,en.end,C,E),t.push({point:C,pointOnLine:E,distance:Ps.origin.distanceTo(C),object:r,face:null,faceIndex:f,uv:null,[aA]:null})}}}class F3 extends je{constructor(e=new zh,t=new Hh({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,n=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)t1.fromBufferAttribute(t,o),i1.fromBufferAttribute(i,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+t1.distanceTo(i1);const s=new B0(n,2,1);return e.setAttribute("instanceDistanceStart",new eo(s,1,0)),e.setAttribute("instanceDistanceEnd",new eo(s,1,1)),this}raycast(e,t){const i=this.material.worldUnits,n=e.camera;n===null&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const s=e.params.Line2!==void 0&&e.params.Line2.threshold||0;Ps=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;so=l.linewidth+s,a.boundingSphere===null&&a.computeBoundingSphere(),zc.copy(a.boundingSphere).applyMatrix4(o);let c;if(i)c=so*.5;else{const h=Math.max(n.near,zc.distanceToPoint(Ps.origin));c=s1(n,h,l.resolution)}if(zc.radius+=c,Ps.intersectsSphere(zc)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),Qc.copy(a.boundingBox).applyMatrix4(o);let u;if(i)u=so*.5;else{const h=Math.max(n.near,Qc.distanceToPoint(Ps.origin));u=s1(n,h,l.resolution)}Qc.expandByScalar(u),Ps.intersectsBox(Qc)!==!1&&(i?gb(this,t):yb(this,n,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Wf),this.material.uniforms.resolution.value.set(Wf.z,Wf.w))}}class k3 extends F3{constructor(e=new P3,t=new Hh({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}let Hc;const Jf=()=>{if(Hc)return Hc;const r="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",e="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if(typeof WebAssembly!="object")return{supported:!1};let n=r;WebAssembly.validate(t)&&(n=e);let s;const o=WebAssembly.instantiate(a(n),{}).then(h=>{s=h.instance,s.exports.__wasm_call_ctors()});function a(h){const f=new Uint8Array(h.length);for(let m=0;m<h.length;++m){const A=h.charCodeAt(m);f[m]=A>96?A-71:A>64?A-65:A>47?A+4:A>46?63:62}let d=0;for(let m=0;m<h.length;++m)f[d++]=f[m]<60?i[f[m]]:(f[m]-60)*64+f[++m];return f.buffer.slice(0,d)}function l(h,f,d,m,A,p){const g=s.exports.sbrk,v=d+3&-4,E=g(v*m),C=g(A.length),I=new Uint8Array(s.exports.memory.buffer);I.set(A,C);const _=h(E,d,m,C,A.length);if(_===0&&p&&p(E,v,m),f.set(I.subarray(E,E+d*m)),g(E-g(0)),_!==0)throw new Error(`Malformed buffer data: ${_}`)}const c={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return Hc={ready:o,supported:!0,decodeVertexBuffer(h,f,d,m,A){l(s.exports.meshopt_decodeVertexBuffer,h,f,d,m,s.exports[c[A]])},decodeIndexBuffer(h,f,d,m){l(s.exports.meshopt_decodeIndexBuffer,h,f,d,m)},decodeIndexSequence(h,f,d,m){l(s.exports.meshopt_decodeIndexSequence,h,f,d,m)},decodeGltfBuffer(h,f,d,m,A,p){l(s.exports[u[A]],h,f,d,m,s.exports[c[p]])}},Hc},r1=r=>Symbol.iterator in r,o1=r=>"entries"in r,a1=(r,e)=>{const t=r instanceof Map?r:new Map(r.entries()),i=e instanceof Map?e:new Map(e.entries());if(t.size!==i.size)return!1;for(const[n,s]of t)if(!Object.is(s,i.get(n)))return!1;return!0},vb=(r,e)=>{const t=r[Symbol.iterator](),i=e[Symbol.iterator]();let n=t.next(),s=i.next();for(;!n.done&&!s.done;){if(!Object.is(n.value,s.value))return!1;n=t.next(),s=i.next()}return!!n.done&&!!s.done};function Eb(r,e){return Object.is(r,e)?!0:typeof r!="object"||r===null||typeof e!="object"||e===null||Object.getPrototypeOf(r)!==Object.getPrototypeOf(e)?!1:r1(r)&&r1(e)?o1(r)&&o1(e)?a1(r,e):vb(r,e):a1({entries:()=>Object.entries(r)},{entries:()=>Object.entries(e)})}const O3=y.createContext([]);function IF({box:r,multiple:e,children:t,onChange:i,onChangePointerUp:n,border:s="1px solid #55aaff",backgroundColor:o="rgba(75, 160, 255, 0.1)",filter:a=c=>c,...l}){const[c,u]=y.useState(!1),{setEvents:h,camera:f,raycaster:d,gl:m,controls:A,size:p,get:g}=de(),[v,E]=y.useState(!1),[C,I]=y.useReducer((b,{object:T,shift:B})=>T===void 0?[]:Array.isArray(T)?T:B?b.includes(T)?b.filter(w=>w!==T):[T,...b]:b[0]===T?[]:[T],[]);y.useEffect(()=>{c?i?.(C):n?.(C)},[C,c]);const _=y.useCallback(b=>{b.stopPropagation(),I({object:a([b.object])[0],shift:e&&b.shiftKey})},[]),x=y.useCallback(b=>!v&&I({}),[v]),S=y.useRef(null);return y.useEffect(()=>{if(!r||!e)return;const b=new g6(f,S.current),T=document.createElement("div");T.style.pointerEvents="none",T.style.border=s,T.style.backgroundColor=o,T.style.position="fixed";const B=new Fe,w=new Fe,R=new Fe,D=g().events.enabled,G=A?.enabled;let z=!1;function W(k,Q){const{offsetX:O,offsetY:U}=k,{width:te,height:le}=p;Q.set(O/te*2-1,-(U/le)*2+1)}function q(k){var Q;A&&(A.enabled=!1),h({enabled:!1}),u(z=!0),(Q=m.domElement.parentElement)==null||Q.appendChild(T),T.style.left=`${k.clientX}px`,T.style.top=`${k.clientY}px`,T.style.width="0px",T.style.height="0px",B.x=k.clientX,B.y=k.clientY}function F(k){R.x=Math.max(B.x,k.clientX),R.y=Math.max(B.y,k.clientY),w.x=Math.min(B.x,k.clientX),w.y=Math.min(B.y,k.clientY),T.style.left=`${w.x}px`,T.style.top=`${w.y}px`,T.style.width=`${R.x-w.x}px`,T.style.height=`${R.y-w.y}px`}function N(){if(z){var k;A&&(A.enabled=G),h({enabled:D}),u(z=!1),(k=T.parentElement)==null||k.removeChild(T)}}function L(k){k.shiftKey&&(q(k),W(k,b.startPoint))}let $=[];function j(k){if(z){F(k),W(k,b.endPoint);const Q=b.select().sort(O=>O.uuid).filter(O=>O.isMesh);Eb(Q,$)||($=Q,I({object:a(Q)}))}}function V(k){z&&N()}return document.addEventListener("pointerdown",L,{passive:!0}),document.addEventListener("pointermove",j,{passive:!0,capture:!0}),document.addEventListener("pointerup",V,{passive:!0}),()=>{document.removeEventListener("pointerdown",L),document.removeEventListener("pointermove",j,!0),document.removeEventListener("pointerup",V)}},[p.width,p.height,d,f,A,m]),y.createElement("group",_e({ref:S,onClick:_,onPointerOver:()=>E(!0),onPointerOut:()=>E(!1),onPointerMissed:x},l),y.createElement(O3.Provider,{value:C},t))}function _F(){return y.useContext(O3)}const Cb=y.forwardRef(function({children:e,follow:t=!0,lockX:i=!1,lockY:n=!1,lockZ:s=!1,...o},a){const l=y.useRef(null),c=y.useRef(null),u=new ht;return We(({camera:h})=>{if(!t||!c.current)return;const f=l.current.rotation.clone();c.current.updateMatrix(),c.current.updateWorldMatrix(!1,!1),c.current.getWorldQuaternion(u),h.getWorldQuaternion(l.current.quaternion).premultiply(u.invert()),i&&(l.current.rotation.x=f.x),n&&(l.current.rotation.y=f.y),s&&(l.current.rotation.z=f.z)}),y.useImperativeHandle(a,()=>c.current,[]),y.createElement("group",_e({ref:c},o),y.createElement("group",{ref:l},e))}),xF=y.forwardRef(({children:r,depth:e=-1,...t},i)=>{const n=y.useRef(null);return y.useImperativeHandle(i,()=>n.current,[]),We(({camera:s})=>{n.current.quaternion.copy(s.quaternion),n.current.position.copy(s.position)}),y.createElement("group",_e({ref:n},t),y.createElement("group",{"position-z":-e},r))}),Ib=new K,_b=new K,xb=new K,Sb=(r,e,t)=>{const i=t.width/2,n=t.height/2;e.updateMatrixWorld(!1);const s=r.project(e);return s.x=s.x*i+i,s.y=-(s.y*n)+n,s},Tb=(r,e,t,i=1)=>{const n=Ib.set(r.x/t.width*2-1,-(r.y/t.height)*2+1,i);return n.unproject(e),n},fA=(r,e,t,i)=>{const n=Sb(xb.copy(r),t,i);let s=0;for(let o=0;o<2;++o){const a=_b.copy(n).setComponent(o,n.getComponent(o)+e),l=Tb(a,t,i,a.z);s=Math.max(s,r.distanceTo(l))}return s},bb=new K,SF=y.forwardRef(({scale:r=1,...e},t)=>{const i=y.useRef(null);return y.useImperativeHandle(t,()=>i.current,[]),We(n=>{const s=i.current;if(!s)return;const o=fA(s.getWorldPosition(bb),r,n.camera,n.size);s.scale.setScalar(o*r)}),y.createElement("object3D",_e({ref:i},e))}),Qs=y.forwardRef(function({points:e,color:t=16777215,vertexColors:i,linewidth:n,lineWidth:s,segments:o,dashed:a,...l},c){var u,h;const f=de(g=>g.size),d=y.useMemo(()=>o?new F3:new k3,[o]),[m]=y.useState(()=>new Hh),A=(i==null||(u=i[0])==null?void 0:u.length)===4?4:3,p=y.useMemo(()=>{const g=o?new zh:new P3,v=e.map(E=>{const C=Array.isArray(E);return E instanceof K||E instanceof Ci?[E.x,E.y,E.z]:E instanceof Fe?[E.x,E.y,0]:C&&E.length===3?[E[0],E[1],E[2]]:C&&E.length===2?[E[0],E[1],0]:E});if(g.setPositions(v.flat()),i){t=16777215;const E=i.map(C=>C instanceof et?C.toArray():C);g.setColors(E.flat(),A)}return g},[e,o,i,A]);return y.useLayoutEffect(()=>{d.computeLineDistances()},[e,d]),y.useLayoutEffect(()=>{a?m.defines.USE_DASH="":delete m.defines.USE_DASH,m.needsUpdate=!0},[a,m]),y.useEffect(()=>()=>{p.dispose(),m.dispose()},[p]),y.createElement("primitive",_e({object:d,ref:c},l),y.createElement("primitive",{object:p,attach:"geometry"}),y.createElement("primitive",_e({object:m,attach:"material",color:t,vertexColors:!!i,resolution:[f.width,f.height],linewidth:(h=n??s)!==null&&h!==void 0?h:1,dashed:a,transparent:A===4},l)))}),wb=new K,TF=y.forwardRef(function({start:e=[0,0,0],end:t=[0,0,0],mid:i,segments:n=20,...s},o){const a=y.useRef(null);y.useImperativeHandle(o,()=>a.current);const[l]=y.useState(()=>new f_(void 0,void 0,void 0)),c=y.useCallback((h,f,d,m=20)=>(h instanceof K?l.v0.copy(h):l.v0.set(...h),f instanceof K?l.v2.copy(f):l.v2.set(...f),d instanceof K?l.v1.copy(d):Array.isArray(d)?l.v1.set(...d):l.v1.copy(l.v0.clone().add(l.v2.clone().sub(l.v0)).add(wb.set(0,l.v0.y-l.v2.y,0))),l.getPoints(m)),[]);y.useLayoutEffect(()=>{a.current.setPoints=(h,f,d)=>{const m=c(h,f,d);a.current.geometry&&a.current.geometry.setPositions(m.map(A=>A.toArray()).flat())}},[]);const u=y.useMemo(()=>c(e,t,i,n),[e,t,i,n]);return y.createElement(Qs,_e({ref:a,points:u},s))}),bF=y.forwardRef(function({start:e,end:t,midA:i,midB:n,segments:s=20,...o},a){const l=y.useMemo(()=>{const c=e instanceof K?e:new K(...e),u=t instanceof K?t:new K(...t),h=i instanceof K?i:new K(...i),f=n instanceof K?n:new K(...n);return new d_(c,h,f,u).getPoints(s)},[e,t,i,n,s]);return y.createElement(Qs,_e({ref:a,points:l},o))}),wF=y.forwardRef(function({points:e,closed:t=!1,curveType:i="centripetal",tension:n=.5,segments:s=20,vertexColors:o,...a},l){const c=y.useMemo(()=>{const f=e.map(d=>d instanceof K?d:new K(...d));return new z2(f,t,i,n)},[e,t,i,n]),u=y.useMemo(()=>c.getPoints(s),[c,s]),h=y.useMemo(()=>{if(!o||o.length<2)return;if(o.length===s+1)return o;const f=o.map(A=>A instanceof et?A:new et(...A));t&&f.push(f[0].clone());const d=[f[0]],m=s/(f.length-1);for(let A=1;A<s;A++){const p=A%m/m,g=Math.floor(A/m);d.push(f[g].clone().lerp(f[g+1],p))}return d.push(f[f.length-1]),d},[o,s]);return y.createElement(Qs,_e({ref:l,points:u,vertexColors:h},a))}),BF=y.forwardRef(({url:r,distance:e=1,loop:t=!0,autoplay:i,...n},s)=>{const o=y.useRef(null);y.useImperativeHandle(s,()=>o.current,[]);const a=de(({camera:u})=>u),[l]=y.useState(()=>new m_),c=gi(A_,r);return y.useEffect(()=>{const u=o.current;u&&(u.setBuffer(c),u.setRefDistance(e),u.setLoop(t),i&&!u.isPlaying&&u.play())},[c,a,e,t]),y.useEffect(()=>{const u=o.current;return a.add(l),()=>{a.remove(l),u&&(u.isPlaying&&u.stop(),u.source&&u.source._connected&&u.disconnect())}},[]),y.createElement("positionalAudio",_e({ref:o,args:[l]},n))});function Bb(){var r=Object.create(null);function e(n,s){var o=n.id,a=n.name,l=n.dependencies;l===void 0&&(l=[]);var c=n.init;c===void 0&&(c=function(){});var u=n.getTransferables;if(u===void 0&&(u=null),!r[o])try{l=l.map(function(f){return f&&f.isWorkerModule&&(e(f,function(d){if(d instanceof Error)throw d}),f=r[f.id].value),f}),c=i("<"+a+">.init",c),u&&(u=i("<"+a+">.getTransferables",u));var h=null;typeof c=="function"?h=c.apply(void 0,l):console.error("worker module init function failed to rehydrate"),r[o]={id:o,value:h,getTransferables:u},s(h)}catch(f){f&&f.noLog||console.error(f),s(f)}}function t(n,s){var o,a=n.id,l=n.args;(!r[a]||typeof r[a].value!="function")&&s(new Error("Worker module "+a+": not found or its 'init' did not return a function"));try{var c=(o=r[a]).value.apply(o,l);c&&typeof c.then=="function"?c.then(u,function(h){return s(h instanceof Error?h:new Error(""+h))}):u(c)}catch(h){s(h)}function u(h){try{var f=r[a].getTransferables&&r[a].getTransferables(h);(!f||!Array.isArray(f)||!f.length)&&(f=void 0),s(h,f)}catch(d){console.error(d),s(d)}}}function i(n,s){var o=void 0;self.troikaDefine=function(l){return o=l};var a=URL.createObjectURL(new Blob(["/** "+n.replace(/\*/g,"")+` **/

troikaDefine(
`+s+`
)`],{type:"application/javascript"}));try{importScripts(a)}catch(l){console.error(l)}return URL.revokeObjectURL(a),delete self.troikaDefine,o}self.addEventListener("message",function(n){var s=n.data,o=s.messageId,a=s.action,l=s.data;try{a==="registerModule"&&e(l,function(c){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:{isCallable:typeof c=="function"}})}),a==="callModule"&&t(l,function(c,u){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:c},u||void 0)})}catch(c){postMessage({messageId:o,success:!1,error:c.stack})}})}function Rb(r){var e=function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];return e._getInitResult().then(function(n){if(typeof n=="function")return n.apply(void 0,t);throw new Error("Worker module function was called but `init` did not return a callable function")})};return e._getInitResult=function(){var t=r.dependencies,i=r.init;t=Array.isArray(t)?t.map(function(s){return s&&(s=s.onMainThread||s,s._getInitResult&&(s=s._getInitResult())),s}):[];var n=Promise.all(t).then(function(s){return i.apply(null,s)});return e._getInitResult=function(){return n},n},e}var U3=function(){var r=!1;if(typeof window<"u"&&typeof window.document<"u")try{var e=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));e.terminate(),r=!0}catch(t){console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+t.message+"]")}return U3=function(){return r},r},Db=0,Mb=0,Zf=!1,kl=Object.create(null),Ol=Object.create(null),J0=Object.create(null);function _a(r){if((!r||typeof r.init!="function")&&!Zf)throw new Error("requires `options.init` function");var e=r.dependencies,t=r.init,i=r.getTransferables,n=r.workerId,s=Rb(r);n==null&&(n="#default");var o="workerModule"+ ++Db,a=r.name||o,l=null;e=e&&e.map(function(u){return typeof u=="function"&&!u.workerModuleData&&(Zf=!0,u=_a({workerId:n,name:"<"+a+"> function dependency: "+u.name,init:`function(){return (
`+zu(u)+`
)}`}),Zf=!1),u&&u.workerModuleData&&(u=u.workerModuleData),u});function c(){for(var u=[],h=arguments.length;h--;)u[h]=arguments[h];if(!U3())return s.apply(void 0,u);if(!l){l=l1(n,"registerModule",c.workerModuleData);var f=function(){l=null,Ol[n].delete(f)};(Ol[n]||(Ol[n]=new Set)).add(f)}return l.then(function(d){var m=d.isCallable;if(m)return l1(n,"callModule",{id:o,args:u});throw new Error("Worker module function was called but `init` did not return a callable function")})}return c.workerModuleData={isWorkerModule:!0,id:o,name:a,dependencies:e,init:zu(t),getTransferables:i&&zu(i)},c.onMainThread=s,c}function Lb(r){Ol[r]&&Ol[r].forEach(function(e){e()}),kl[r]&&(kl[r].terminate(),delete kl[r])}function zu(r){var e=r.toString();return!/^function/.test(e)&&/^\w+\s*\(/.test(e)&&(e="function "+e),e}function Pb(r){var e=kl[r];if(!e){var t=zu(Bb);e=kl[r]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+r.replace(/\*/g,"")+` **/

;(`+t+")()"],{type:"application/javascript"}))),e.onmessage=function(i){var n=i.data,s=n.messageId,o=J0[s];if(!o)throw new Error("WorkerModule response with empty or unknown messageId");delete J0[s],o(n)}}return e}function l1(r,e,t){return new Promise(function(i,n){var s=++Mb;J0[s]=function(o){o.success?i(o.result):n(new Error("Error in worker "+e+" call: "+o.error))},Pb(r).postMessage({messageId:s,action:e,data:t})})}function N3(){var r=function(e){function t(F,N,L,$,j,V,k,Q){var O=1-k;Q.x=O*O*F+2*O*k*L+k*k*j,Q.y=O*O*N+2*O*k*$+k*k*V}function i(F,N,L,$,j,V,k,Q,O,U){var te=1-O;U.x=te*te*te*F+3*te*te*O*L+3*te*O*O*j+O*O*O*k,U.y=te*te*te*N+3*te*te*O*$+3*te*O*O*V+O*O*O*Q}function n(F,N){for(var L=/([MLQCZ])([^MLQCZ]*)/g,$,j,V,k,Q;$=L.exec(F);){var O=$[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map(function(U){return parseFloat(U)});switch($[1]){case"M":k=j=O[0],Q=V=O[1];break;case"L":(O[0]!==k||O[1]!==Q)&&N("L",k,Q,k=O[0],Q=O[1]);break;case"Q":{N("Q",k,Q,k=O[2],Q=O[3],O[0],O[1]);break}case"C":{N("C",k,Q,k=O[4],Q=O[5],O[0],O[1],O[2],O[3]);break}case"Z":(k!==j||Q!==V)&&N("L",k,Q,j,V);break}}}function s(F,N,L){L===void 0&&(L=16);var $={x:0,y:0};n(F,function(j,V,k,Q,O,U,te,le,ee){switch(j){case"L":N(V,k,Q,O);break;case"Q":{for(var se=V,Ee=k,Ie=1;Ie<L;Ie++)t(V,k,U,te,Q,O,Ie/(L-1),$),N(se,Ee,$.x,$.y),se=$.x,Ee=$.y;break}case"C":{for(var oe=V,ce=k,Ae=1;Ae<L;Ae++)i(V,k,U,te,le,ee,Q,O,Ae/(L-1),$),N(oe,ce,$.x,$.y),oe=$.x,ce=$.y;break}}})}var o="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",a="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",l=new WeakMap,c={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function u(F,N){var L=F.getContext?F.getContext("webgl",c):F,$=l.get(L);if(!$){let te=function(oe){var ce=V[oe];if(!ce&&(ce=V[oe]=L.getExtension(oe),!ce))throw new Error(oe+" not supported");return ce},le=function(oe,ce){var Ae=L.createShader(ce);return L.shaderSource(Ae,oe),L.compileShader(Ae),Ae},ee=function(oe,ce,Ae,he){if(!k[oe]){var Z={},J={},ue=L.createProgram();L.attachShader(ue,le(ce,L.VERTEX_SHADER)),L.attachShader(ue,le(Ae,L.FRAGMENT_SHADER)),L.linkProgram(ue),k[oe]={program:ue,transaction:function(we){L.useProgram(ue),we({setUniform:function(Be,qe){for(var Oe=[],Ke=arguments.length-2;Ke-- >0;)Oe[Ke]=arguments[Ke+2];var $e=J[qe]||(J[qe]=L.getUniformLocation(ue,qe));L["uniform"+Be].apply(L,[$e].concat(Oe))},setAttribute:function(Be,qe,Oe,Ke,$e){var Ze=Z[Be];Ze||(Ze=Z[Be]={buf:L.createBuffer(),loc:L.getAttribLocation(ue,Be),data:null}),L.bindBuffer(L.ARRAY_BUFFER,Ze.buf),L.vertexAttribPointer(Ze.loc,qe,L.FLOAT,!1,0,0),L.enableVertexAttribArray(Ze.loc),j?L.vertexAttribDivisor(Ze.loc,Ke):te("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(Ze.loc,Ke),$e!==Ze.data&&(L.bufferData(L.ARRAY_BUFFER,$e,Oe),Ze.data=$e)}})}}}k[oe].transaction(he)},se=function(oe,ce){O++;try{L.activeTexture(L.TEXTURE0+O);var Ae=Q[oe];Ae||(Ae=Q[oe]=L.createTexture(),L.bindTexture(L.TEXTURE_2D,Ae),L.texParameteri(L.TEXTURE_2D,L.TEXTURE_MIN_FILTER,L.NEAREST),L.texParameteri(L.TEXTURE_2D,L.TEXTURE_MAG_FILTER,L.NEAREST)),L.bindTexture(L.TEXTURE_2D,Ae),ce(Ae,O)}finally{O--}},Ee=function(oe,ce,Ae){var he=L.createFramebuffer();U.push(he),L.bindFramebuffer(L.FRAMEBUFFER,he),L.activeTexture(L.TEXTURE0+ce),L.bindTexture(L.TEXTURE_2D,oe),L.framebufferTexture2D(L.FRAMEBUFFER,L.COLOR_ATTACHMENT0,L.TEXTURE_2D,oe,0);try{Ae(he)}finally{L.deleteFramebuffer(he),L.bindFramebuffer(L.FRAMEBUFFER,U[--U.length-1]||null)}},Ie=function(){V={},k={},Q={},O=-1,U.length=0};var j=typeof WebGL2RenderingContext<"u"&&L instanceof WebGL2RenderingContext,V={},k={},Q={},O=-1,U=[];L.canvas.addEventListener("webglcontextlost",function(oe){Ie(),oe.preventDefault()},!1),l.set(L,$={gl:L,isWebGL2:j,getExtension:te,withProgram:ee,withTexture:se,withTextureFramebuffer:Ee,handleContextLoss:Ie})}N($)}function h(F,N,L,$,j,V,k,Q){k===void 0&&(k=15),Q===void 0&&(Q=null),u(F,function(O){var U=O.gl,te=O.withProgram,le=O.withTexture;le("copy",function(ee,se){U.texImage2D(U.TEXTURE_2D,0,U.RGBA,j,V,0,U.RGBA,U.UNSIGNED_BYTE,N),te("copy",o,a,function(Ee){var Ie=Ee.setUniform,oe=Ee.setAttribute;oe("aUV",2,U.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),Ie("1i","image",se),U.bindFramebuffer(U.FRAMEBUFFER,Q||null),U.disable(U.BLEND),U.colorMask(k&8,k&4,k&2,k&1),U.viewport(L,$,j,V),U.scissor(L,$,j,V),U.drawArrays(U.TRIANGLES,0,3)})})})}function f(F,N,L){var $=F.width,j=F.height;u(F,function(V){var k=V.gl,Q=new Uint8Array($*j*4);k.readPixels(0,0,$,j,k.RGBA,k.UNSIGNED_BYTE,Q),F.width=N,F.height=L,h(k,Q,0,0,$,j)})}var d=Object.freeze({__proto__:null,withWebGLContext:u,renderImageData:h,resizeWebGLCanvasWithoutClearing:f});function m(F,N,L,$,j,V){V===void 0&&(V=1);var k=new Uint8Array(F*N),Q=$[2]-$[0],O=$[3]-$[1],U=[];s(L,function(oe,ce,Ae,he){U.push({x1:oe,y1:ce,x2:Ae,y2:he,minX:Math.min(oe,Ae),minY:Math.min(ce,he),maxX:Math.max(oe,Ae),maxY:Math.max(ce,he)})}),U.sort(function(oe,ce){return oe.maxX-ce.maxX});for(var te=0;te<F;te++)for(var le=0;le<N;le++){var ee=Ee($[0]+Q*(te+.5)/F,$[1]+O*(le+.5)/N),se=Math.pow(1-Math.abs(ee)/j,V)/2;ee<0&&(se=1-se),se=Math.max(0,Math.min(255,Math.round(se*255))),k[le*F+te]=se}return k;function Ee(oe,ce){for(var Ae=1/0,he=1/0,Z=U.length;Z--;){var J=U[Z];if(J.maxX+he<=oe)break;if(oe+he>J.minX&&ce-he<J.maxY&&ce+he>J.minY){var ue=g(oe,ce,J.x1,J.y1,J.x2,J.y2);ue<Ae&&(Ae=ue,he=Math.sqrt(Ae))}}return Ie(oe,ce)&&(he=-he),he}function Ie(oe,ce){for(var Ae=0,he=U.length;he--;){var Z=U[he];if(Z.maxX<=oe)break;var J=Z.y1>ce!=Z.y2>ce&&oe<(Z.x2-Z.x1)*(ce-Z.y1)/(Z.y2-Z.y1)+Z.x1;J&&(Ae+=Z.y1<Z.y2?1:-1)}return Ae!==0}}function A(F,N,L,$,j,V,k,Q,O,U){V===void 0&&(V=1),Q===void 0&&(Q=0),O===void 0&&(O=0),U===void 0&&(U=0),p(F,N,L,$,j,V,k,null,Q,O,U)}function p(F,N,L,$,j,V,k,Q,O,U,te){V===void 0&&(V=1),O===void 0&&(O=0),U===void 0&&(U=0),te===void 0&&(te=0);for(var le=m(F,N,L,$,j,V),ee=new Uint8Array(le.length*4),se=0;se<le.length;se++)ee[se*4+te]=le[se];h(k,ee,O,U,F,N,1<<3-te,Q)}function g(F,N,L,$,j,V){var k=j-L,Q=V-$,O=k*k+Q*Q,U=O?Math.max(0,Math.min(1,((F-L)*k+(N-$)*Q)/O)):0,te=F-(L+U*k),le=N-($+U*Q);return te*te+le*le}var v=Object.freeze({__proto__:null,generate:m,generateIntoCanvas:A,generateIntoFramebuffer:p}),E="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",C="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",I="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",_=new Float32Array([0,0,2,0,0,2]),x=null,S=!1,b={},T=new WeakMap;function B(F){if(!S&&!G(F))throw new Error("WebGL generation not supported")}function w(F,N,L,$,j,V,k){if(V===void 0&&(V=1),k===void 0&&(k=null),!k&&(k=x,!k)){var Q=typeof OffscreenCanvas=="function"?new OffscreenCanvas(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!Q)throw new Error("OffscreenCanvas or DOM canvas not supported");k=x=Q.getContext("webgl",{depth:!1})}B(k);var O=new Uint8Array(F*N*4);u(k,function(ee){var se=ee.gl,Ee=ee.withTexture,Ie=ee.withTextureFramebuffer;Ee("readable",function(oe,ce){se.texImage2D(se.TEXTURE_2D,0,se.RGBA,F,N,0,se.RGBA,se.UNSIGNED_BYTE,null),Ie(oe,ce,function(Ae){D(F,N,L,$,j,V,se,Ae,0,0,0),se.readPixels(0,0,F,N,se.RGBA,se.UNSIGNED_BYTE,O)})})});for(var U=new Uint8Array(F*N),te=0,le=0;te<O.length;te+=4)U[le++]=O[te];return U}function R(F,N,L,$,j,V,k,Q,O,U){V===void 0&&(V=1),Q===void 0&&(Q=0),O===void 0&&(O=0),U===void 0&&(U=0),D(F,N,L,$,j,V,k,null,Q,O,U)}function D(F,N,L,$,j,V,k,Q,O,U,te){V===void 0&&(V=1),O===void 0&&(O=0),U===void 0&&(U=0),te===void 0&&(te=0),B(k);var le=[];s(L,function(ee,se,Ee,Ie){le.push(ee,se,Ee,Ie)}),le=new Float32Array(le),u(k,function(ee){var se=ee.gl,Ee=ee.isWebGL2,Ie=ee.getExtension,oe=ee.withProgram,ce=ee.withTexture,Ae=ee.withTextureFramebuffer,he=ee.handleContextLoss;if(ce("rawDistances",function(Z,J){(F!==Z._lastWidth||N!==Z._lastHeight)&&se.texImage2D(se.TEXTURE_2D,0,se.RGBA,Z._lastWidth=F,Z._lastHeight=N,0,se.RGBA,se.UNSIGNED_BYTE,null),oe("main",E,C,function(ue){var Te=ue.setAttribute,we=ue.setUniform,Le=!Ee&&Ie("ANGLE_instanced_arrays"),Be=!Ee&&Ie("EXT_blend_minmax");Te("aUV",2,se.STATIC_DRAW,0,_),Te("aLineSegment",4,se.DYNAMIC_DRAW,1,le),we.apply(void 0,["4f","uGlyphBounds"].concat($)),we("1f","uMaxDistance",j),we("1f","uExponent",V),Ae(Z,J,function(qe){se.enable(se.BLEND),se.colorMask(!0,!0,!0,!0),se.viewport(0,0,F,N),se.scissor(0,0,F,N),se.blendFunc(se.ONE,se.ONE),se.blendEquationSeparate(se.FUNC_ADD,Ee?se.MAX:Be.MAX_EXT),se.clear(se.COLOR_BUFFER_BIT),Ee?se.drawArraysInstanced(se.TRIANGLES,0,3,le.length/4):Le.drawArraysInstancedANGLE(se.TRIANGLES,0,3,le.length/4)})}),oe("post",o,I,function(ue){ue.setAttribute("aUV",2,se.STATIC_DRAW,0,_),ue.setUniform("1i","tex",J),se.bindFramebuffer(se.FRAMEBUFFER,Q),se.disable(se.BLEND),se.colorMask(te===0,te===1,te===2,te===3),se.viewport(O,U,F,N),se.scissor(O,U,F,N),se.drawArrays(se.TRIANGLES,0,3)})}),se.isContextLost())throw he(),new Error("webgl context lost")})}function G(F){var N=!F||F===x?b:F.canvas||F,L=T.get(N);if(L===void 0){S=!0;var $=null;try{var j=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],V=w(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,F);L=V&&j.length===V.length&&V.every(function(k,Q){return k===j[Q]}),L||($="bad trial run results",console.info(j,V))}catch(k){L=!1,$=k.message}$&&console.warn("WebGL SDF generation not supported:",$),S=!1,T.set(N,L)}return L}var z=Object.freeze({__proto__:null,generate:w,generateIntoCanvas:R,generateIntoFramebuffer:D,isSupported:G});function W(F,N,L,$,j,V){j===void 0&&(j=Math.max($[2]-$[0],$[3]-$[1])/2),V===void 0&&(V=1);try{return w.apply(z,arguments)}catch(k){return console.info("WebGL SDF generation failed, falling back to JS",k),m.apply(v,arguments)}}function q(F,N,L,$,j,V,k,Q,O,U){j===void 0&&(j=Math.max($[2]-$[0],$[3]-$[1])/2),V===void 0&&(V=1),Q===void 0&&(Q=0),O===void 0&&(O=0),U===void 0&&(U=0);try{return R.apply(z,arguments)}catch(te){return console.info("WebGL SDF generation failed, falling back to JS",te),A.apply(v,arguments)}}return e.forEachPathCommand=n,e.generate=W,e.generateIntoCanvas=q,e.javascript=v,e.pathToLineSegments=s,e.webgl=z,e.webglUtils=d,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return r}function Fb(){var r=function(e){var t={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},i={},n={};i.L=1,n[1]="L",Object.keys(t).forEach(function(he,Z){i[he]=1<<Z+1,n[i[he]]=he}),Object.freeze(i);var s=i.LRI|i.RLI|i.FSI,o=i.L|i.R|i.AL,a=i.B|i.S|i.WS|i.ON|i.FSI|i.LRI|i.RLI|i.PDI,l=i.BN|i.RLE|i.LRE|i.RLO|i.LRO|i.PDF,c=i.S|i.WS|i.B|s|i.PDI|l,u=null;function h(){if(!u){u=new Map;var he=function(J){if(t.hasOwnProperty(J)){var ue=0;t[J].split(",").forEach(function(Te){var we=Te.split("+"),Le=we[0],Be=we[1];Le=parseInt(Le,36),Be=Be?parseInt(Be,36):0,u.set(ue+=Le,i[J]);for(var qe=0;qe<Be;qe++)u.set(++ue,i[J])})}};for(var Z in t)he(Z)}}function f(he){return h(),u.get(he.codePointAt(0))||i.L}function d(he){return n[f(he)]}var m={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function A(he,Z){var J=36,ue=0,Te=new Map,we=Z&&new Map,Le;return he.split(",").forEach(function Be(qe){if(qe.indexOf("+")!==-1)for(var Oe=+qe;Oe--;)Be(Le);else{Le=qe;var Ke=qe.split(">"),$e=Ke[0],Ze=Ke[1];$e=String.fromCodePoint(ue+=parseInt($e,J)),Ze=String.fromCodePoint(ue+=parseInt(Ze,J)),Te.set($e,Ze),Z&&we.set(Ze,$e)}}),{map:Te,reverseMap:we}}var p,g,v;function E(){if(!p){var he=A(m.pairs,!0),Z=he.map,J=he.reverseMap;p=Z,g=J,v=A(m.canonical,!1).map}}function C(he){return E(),p.get(he)||null}function I(he){return E(),g.get(he)||null}function _(he){return E(),v.get(he)||null}var x=i.L,S=i.R,b=i.EN,T=i.ES,B=i.ET,w=i.AN,R=i.CS,D=i.B,G=i.S,z=i.ON,W=i.BN,q=i.NSM,F=i.AL,N=i.LRO,L=i.RLO,$=i.LRE,j=i.RLE,V=i.PDF,k=i.LRI,Q=i.RLI,O=i.FSI,U=i.PDI;function te(he,Z){for(var J=125,ue=new Uint32Array(he.length),Te=0;Te<he.length;Te++)ue[Te]=f(he[Te]);var we=new Map;function Le(mn,ns){var An=ue[mn];ue[mn]=ns,we.set(An,we.get(An)-1),An&a&&we.set(a,we.get(a)-1),we.set(ns,(we.get(ns)||0)+1),ns&a&&we.set(a,(we.get(a)||0)+1)}for(var Be=new Uint8Array(he.length),qe=new Map,Oe=[],Ke=null,$e=0;$e<he.length;$e++)Ke||Oe.push(Ke={start:$e,end:he.length-1,level:Z==="rtl"?1:Z==="ltr"?0:Ap($e,!1)}),ue[$e]&D&&(Ke.end=$e,Ke=null);for(var Ze=j|$|L|N|s|U|V|D,ut=function(mn){return mn+(mn&1?1:2)},Ct=function(mn){return mn+(mn&1?2:1)},lt=0;lt<Oe.length;lt++){Ke=Oe[lt];var tt=[{_level:Ke.level,_override:0,_isolate:0}],Je=void 0,re=0,Re=0,Ue=0;we.clear();for(var Xe=Ke.start;Xe<=Ke.end;Xe++){var ve=ue[Xe];if(Je=tt[tt.length-1],we.set(ve,(we.get(ve)||0)+1),ve&a&&we.set(a,(we.get(a)||0)+1),ve&Ze)if(ve&(j|$)){Be[Xe]=Je._level;var ft=(ve===j?Ct:ut)(Je._level);ft<=J&&!re&&!Re?tt.push({_level:ft,_override:0,_isolate:0}):re||Re++}else if(ve&(L|N)){Be[Xe]=Je._level;var ii=(ve===L?Ct:ut)(Je._level);ii<=J&&!re&&!Re?tt.push({_level:ii,_override:ve&L?S:x,_isolate:0}):re||Re++}else if(ve&s){ve&O&&(ve=Ap(Xe+1,!0)===1?Q:k),Be[Xe]=Je._level,Je._override&&Le(Xe,Je._override);var kt=(ve===Q?Ct:ut)(Je._level);kt<=J&&re===0&&Re===0?(Ue++,tt.push({_level:kt,_override:0,_isolate:1,_isolInitIndex:Xe})):re++}else if(ve&U){if(re>0)re--;else if(Ue>0){for(Re=0;!tt[tt.length-1]._isolate;)tt.pop();var It=tt[tt.length-1]._isolInitIndex;It!=null&&(qe.set(It,Xe),qe.set(Xe,It)),tt.pop(),Ue--}Je=tt[tt.length-1],Be[Xe]=Je._level,Je._override&&Le(Xe,Je._override)}else ve&V?(re===0&&(Re>0?Re--:!Je._isolate&&tt.length>1&&(tt.pop(),Je=tt[tt.length-1])),Be[Xe]=Je._level):ve&D&&(Be[Xe]=Ke.level);else Be[Xe]=Je._level,Je._override&&ve!==W&&Le(Xe,Je._override)}for(var Pt=[],ie=null,P=Ke.start;P<=Ke.end;P++){var Y=ue[P];if(!(Y&l)){var ae=Be[P],ke=Y&s,at=Y===U;ie&&ae===ie._level?(ie._end=P,ie._endsWithIsolInit=ke):Pt.push(ie={_start:P,_end:P,_level:ae,_startsWithPDI:at,_endsWithIsolInit:ke})}}for(var bt=[],Yt=0;Yt<Pt.length;Yt++){var Pi=Pt[Yt];if(!Pi._startsWithPDI||Pi._startsWithPDI&&!qe.has(Pi._start)){for(var Bi=[ie=Pi],Ft=void 0;ie&&ie._endsWithIsolInit&&(Ft=qe.get(ie._end))!=null;)for(var At=Yt+1;At<Pt.length;At++)if(Pt[At]._start===Ft){Bi.push(ie=Pt[At]);break}for(var ni=[],fn=0;fn<Bi.length;fn++)for(var H=Bi[fn],X=H._start;X<=H._end;X++)ni.push(X);for(var ne=Be[ni[0]],pe=Ke.level,xe=ni[0]-1;xe>=0;xe--)if(!(ue[xe]&l)){pe=Be[xe];break}var Se=ni[ni.length-1],Ge=Be[Se],Pe=Ke.level;if(!(ue[Se]&s)){for(var Ne=Se+1;Ne<=Ke.end;Ne++)if(!(ue[Ne]&l)){Pe=Be[Ne];break}}bt.push({_seqIndices:ni,_sosType:Math.max(pe,ne)%2?S:x,_eosType:Math.max(Pe,Ge)%2?S:x})}}for(var Qe=0;Qe<bt.length;Qe++){var ze=bt[Qe],Ce=ze._seqIndices,Wt=ze._sosType,rt=ze._eosType,st=Be[Ce[0]]&1?S:x;if(we.get(q))for(var pt=0;pt<Ce.length;pt++){var xt=Ce[pt];if(ue[xt]&q){for(var Ut=Wt,Nt=pt-1;Nt>=0;Nt--)if(!(ue[Ce[Nt]]&l)){Ut=ue[Ce[Nt]];break}Le(xt,Ut&(s|U)?z:Ut)}}if(we.get(b))for(var di=0;di<Ce.length;di++){var Hi=Ce[di];if(ue[Hi]&b)for(var Gt=di-1;Gt>=-1;Gt--){var _n=Gt===-1?Wt:ue[Ce[Gt]];if(_n&o){_n===F&&Le(Hi,w);break}}}if(we.get(F))for(var qt=0;qt<Ce.length;qt++){var Si=Ce[qt];ue[Si]&F&&Le(Si,S)}if(we.get(T)||we.get(R))for(var rn=1;rn<Ce.length-1;rn++){var Vs=Ce[rn];if(ue[Vs]&(T|R)){for(var Fi=0,Qt=0,Ri=rn-1;Ri>=0&&(Fi=ue[Ce[Ri]],!!(Fi&l));Ri--);for(var ti=rn+1;ti<Ce.length&&(Qt=ue[Ce[ti]],!!(Qt&l));ti++);Fi===Qt&&(ue[Vs]===T?Fi===b:Fi&(b|w))&&Le(Vs,Fi)}}if(we.get(b))for(var wt=0;wt<Ce.length;wt++){var dn=Ce[wt];if(ue[dn]&b){for(var Pn=wt-1;Pn>=0&&ue[Ce[Pn]]&(B|l);Pn--)Le(Ce[Pn],b);for(wt++;wt<Ce.length&&ue[Ce[wt]]&(B|l|b);wt++)ue[Ce[wt]]!==b&&Le(Ce[wt],b)}}if(we.get(B)||we.get(T)||we.get(R))for(var ki=0;ki<Ce.length;ki++){var ts=Ce[ki];if(ue[ts]&(B|T|R)){Le(ts,z);for(var vc=ki-1;vc>=0&&ue[Ce[vc]]&l;vc--)Le(Ce[vc],z);for(var Ec=ki+1;Ec<Ce.length&&ue[Ce[Ec]]&l;Ec++)Le(Ce[Ec],z)}}if(we.get(b))for(var rf=0,np=Wt;rf<Ce.length;rf++){var sp=Ce[rf],of=ue[sp];of&b?np===x&&Le(sp,x):of&o&&(np=of)}if(we.get(a)){var Sa=S|b|w,rp=Sa|x,Cc=[];{for(var fo=[],mo=0;mo<Ce.length;mo++)if(ue[Ce[mo]]&a){var Ta=he[Ce[mo]],op=void 0;if(C(Ta)!==null)if(fo.length<63)fo.push({char:Ta,seqIndex:mo});else break;else if((op=I(Ta))!==null)for(var ba=fo.length-1;ba>=0;ba--){var af=fo[ba].char;if(af===op||af===I(_(Ta))||C(_(af))===Ta){Cc.push([fo[ba].seqIndex,mo]),fo.length=ba;break}}}Cc.sort(function(mn,ns){return mn[0]-ns[0]})}for(var lf=0;lf<Cc.length;lf++){for(var ap=Cc[lf],Ic=ap[0],cf=ap[1],lp=!1,is=0,uf=Ic+1;uf<cf;uf++){var cp=Ce[uf];if(ue[cp]&rp){lp=!0;var up=ue[cp]&Sa?S:x;if(up===st){is=up;break}}}if(lp&&!is){is=Wt;for(var hf=Ic-1;hf>=0;hf--){var hp=Ce[hf];if(ue[hp]&rp){var fp=ue[hp]&Sa?S:x;fp!==st?is=fp:is=st;break}}}if(is){if(ue[Ce[Ic]]=ue[Ce[cf]]=is,is!==st){for(var wa=Ic+1;wa<Ce.length;wa++)if(!(ue[Ce[wa]]&l)){f(he[Ce[wa]])&q&&(ue[Ce[wa]]=is);break}}if(is!==st){for(var Ba=cf+1;Ba<Ce.length;Ba++)if(!(ue[Ce[Ba]]&l)){f(he[Ce[Ba]])&q&&(ue[Ce[Ba]]=is);break}}}}for(var mr=0;mr<Ce.length;mr++)if(ue[Ce[mr]]&a){for(var dp=mr,ff=mr,df=Wt,Ra=mr-1;Ra>=0;Ra--)if(ue[Ce[Ra]]&l)dp=Ra;else{df=ue[Ce[Ra]]&Sa?S:x;break}for(var mp=rt,Da=mr+1;Da<Ce.length;Da++)if(ue[Ce[Da]]&(a|l))ff=Da;else{mp=ue[Ce[Da]]&Sa?S:x;break}for(var mf=dp;mf<=ff;mf++)ue[Ce[mf]]=df===mp?df:st;mr=ff}}}for(var xn=Ke.start;xn<=Ke.end;xn++){var DI=Be[xn],_c=ue[xn];if(DI&1?_c&(x|b|w)&&Be[xn]++:_c&S?Be[xn]++:_c&(w|b)&&(Be[xn]+=2),_c&l&&(Be[xn]=xn===0?Ke.level:Be[xn-1]),xn===Ke.end||f(he[xn])&(G|D))for(var xc=xn;xc>=0&&f(he[xc])&c;xc--)Be[xc]=Ke.level}}return{levels:Be,paragraphs:Oe};function Ap(mn,ns){for(var An=mn;An<he.length;An++){var Ar=ue[An];if(Ar&(S|F))return 1;if(Ar&(D|x)||ns&&Ar===U)return 0;if(Ar&s){var pp=MI(An);An=pp===-1?he.length:pp}}return 0}function MI(mn){for(var ns=1,An=mn+1;An<he.length;An++){var Ar=ue[An];if(Ar&D)break;if(Ar&U){if(--ns===0)return An}else Ar&s&&ns++}return-1}}var le="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",ee;function se(){if(!ee){var he=A(le,!0),Z=he.map,J=he.reverseMap;J.forEach(function(ue,Te){Z.set(Te,ue)}),ee=Z}}function Ee(he){return se(),ee.get(he)||null}function Ie(he,Z,J,ue){var Te=he.length;J=Math.max(0,J==null?0:+J),ue=Math.min(Te-1,ue==null?Te-1:+ue);for(var we=new Map,Le=J;Le<=ue;Le++)if(Z[Le]&1){var Be=Ee(he[Le]);Be!==null&&we.set(Le,Be)}return we}function oe(he,Z,J,ue){var Te=he.length;J=Math.max(0,J==null?0:+J),ue=Math.min(Te-1,ue==null?Te-1:+ue);var we=[];return Z.paragraphs.forEach(function(Le){var Be=Math.max(J,Le.start),qe=Math.min(ue,Le.end);if(Be<qe){for(var Oe=Z.levels.slice(Be,qe+1),Ke=qe;Ke>=Be&&f(he[Ke])&c;Ke--)Oe[Ke]=Le.level;for(var $e=Le.level,Ze=1/0,ut=0;ut<Oe.length;ut++){var Ct=Oe[ut];Ct>$e&&($e=Ct),Ct<Ze&&(Ze=Ct|1)}for(var lt=$e;lt>=Ze;lt--)for(var tt=0;tt<Oe.length;tt++)if(Oe[tt]>=lt){for(var Je=tt;tt+1<Oe.length&&Oe[tt+1]>=lt;)tt++;tt>Je&&we.push([Je+Be,tt+Be])}}}),we}function ce(he,Z,J,ue){var Te=Ae(he,Z,J,ue),we=[].concat(he);return Te.forEach(function(Le,Be){we[Be]=(Z.levels[Le]&1?Ee(he[Le]):null)||he[Le]}),we.join("")}function Ae(he,Z,J,ue){for(var Te=oe(he,Z,J,ue),we=[],Le=0;Le<he.length;Le++)we[Le]=Le;return Te.forEach(function(Be){for(var qe=Be[0],Oe=Be[1],Ke=we.slice(qe,Oe+1),$e=Ke.length;$e--;)we[Oe-$e]=Ke[$e]}),we}return e.closingToOpeningBracket=I,e.getBidiCharType=f,e.getBidiCharTypeName=d,e.getCanonicalBracket=_,e.getEmbeddingLevels=te,e.getMirroredCharacter=Ee,e.getMirroredCharactersMap=Ie,e.getReorderSegments=oe,e.getReorderedIndices=Ae,e.getReorderedString=ce,e.openingToClosingBracket=C,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return r}const G3=/\bvoid\s+main\s*\(\s*\)\s*{/g;function Z0(r){const e=/^[ \t]*#include +<([\w\d./]+)>/gm;function t(i,n){let s=Zo[n];return s?Z0(s):i}return r.replace(e,t)}const Zi=[];for(let r=0;r<256;r++)Zi[r]=(r<16?"0":"")+r.toString(16);function kb(){const r=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(Zi[r&255]+Zi[r>>8&255]+Zi[r>>16&255]+Zi[r>>24&255]+"-"+Zi[e&255]+Zi[e>>8&255]+"-"+Zi[e>>16&15|64]+Zi[e>>24&255]+"-"+Zi[t&63|128]+Zi[t>>8&255]+"-"+Zi[t>>16&255]+Zi[t>>24&255]+Zi[i&255]+Zi[i>>8&255]+Zi[i>>16&255]+Zi[i>>24&255]).toUpperCase()}const $r=Object.assign||function(){let r=arguments[0];for(let e=1,t=arguments.length;e<t;e++){let i=arguments[e];if(i)for(let n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])}return r},Ob=Date.now(),c1=new WeakMap,u1=new Map;let Ub=1e10;function em(r,e){const t=zb(e);let i=c1.get(r);if(i||c1.set(r,i=Object.create(null)),i[t])return new i[t];const n=`_onBeforeCompile${t}`,s=function(c,u){r.onBeforeCompile.call(this,c,u);const h=this.customProgramCacheKey()+"|"+c.vertexShader+"|"+c.fragmentShader;let f=u1[h];if(!f){const d=Nb(this,c,e,t);f=u1[h]=d}c.vertexShader=f.vertexShader,c.fragmentShader=f.fragmentShader,$r(c.uniforms,this.uniforms),e.timeUniform&&(c.uniforms[e.timeUniform]={get value(){return Date.now()-Ob}}),this[n]&&this[n](c)},o=function(){return a(e.chained?r:r.clone())},a=function(c){const u=Object.create(c,l);return Object.defineProperty(u,"baseMaterial",{value:r}),Object.defineProperty(u,"id",{value:Ub++}),u.uuid=kb(),u.uniforms=$r({},c.uniforms,e.uniforms),u.defines=$r({},c.defines,e.defines),u.defines[`TROIKA_DERIVED_MATERIAL_${t}`]="",u.extensions=$r({},c.extensions,e.extensions),u._listeners=void 0,u},l={constructor:{value:o},isDerivedMaterial:{value:!0},type:{get:()=>r.type,set:c=>{r.type=c}},isDerivedFrom:{writable:!0,configurable:!0,value:function(c){const u=this.baseMaterial;return c===u||u.isDerivedMaterial&&u.isDerivedFrom(c)||!1}},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r.customProgramCacheKey()+"|"+t}},onBeforeCompile:{get(){return s},set(c){this[n]=c}},copy:{writable:!0,configurable:!0,value:function(c){return r.copy.call(this,c),!r.isShaderMaterial&&!r.isDerivedMaterial&&($r(this.extensions,c.extensions),$r(this.defines,c.defines),$r(this.uniforms,Kl.clone(c.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const c=new r.constructor;return a(c).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let c=this._depthMaterial;return c||(c=this._depthMaterial=em(r.isDerivedMaterial?r.getDepthMaterial():new H2({depthPacking:V2}),e),c.defines.IS_DEPTH_MATERIAL="",c.uniforms=this.uniforms),c}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let c=this._distanceMaterial;return c||(c=this._distanceMaterial=em(r.isDerivedMaterial?r.getDistanceMaterial():new p_,e),c.defines.IS_DISTANCE_MATERIAL="",c.uniforms=this.uniforms),c}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:c,_distanceMaterial:u}=this;c&&c.dispose(),u&&u.dispose(),r.dispose.call(this)}}};return i[t]=o,new o}function Nb(r,{vertexShader:e,fragmentShader:t},i,n){let{vertexDefs:s,vertexMainIntro:o,vertexMainOutro:a,vertexTransform:l,fragmentDefs:c,fragmentMainIntro:u,fragmentMainOutro:h,fragmentColorTransform:f,customRewriter:d,timeUniform:m}=i;if(s=s||"",o=o||"",a=a||"",c=c||"",u=u||"",h=h||"",(l||d)&&(e=Z0(e)),(f||d)&&(t=t.replace(/^[ \t]*#include <((?:tonemapping|encodings|colorspace|fog|premultiplied_alpha|dithering)_fragment)>/gm,`
//!BEGIN_POST_CHUNK $1
$&
//!END_POST_CHUNK
`),t=Z0(t)),d){let A=d({vertexShader:e,fragmentShader:t});e=A.vertexShader,t=A.fragmentShader}if(f){let A=[];t=t.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,p=>(A.push(p),"")),h=`${f}
${A.join(`
`)}
${h}`}if(m){const A=`
uniform float ${m};
`;s=A+s,c=A+c}return l&&(e=`vec3 troika_position_${n};
vec3 troika_normal_${n};
vec2 troika_uv_${n};
${e}
`,s=`${s}
void troikaVertexTransform${n}(inout vec3 position, inout vec3 normal, inout vec2 uv) {
  ${l}
}
`,o=`
troika_position_${n} = vec3(position);
troika_normal_${n} = vec3(normal);
troika_uv_${n} = vec2(uv);
troikaVertexTransform${n}(troika_position_${n}, troika_normal_${n}, troika_uv_${n});
${o}
`,e=e.replace(/\b(position|normal|uv)\b/g,(A,p,g,v)=>/\battribute\s+vec[23]\s+$/.test(v.substr(0,g))?p:`troika_${p}_${n}`),r.map&&r.map.channel>0||(e=e.replace(/\bMAP_UV\b/g,`troika_uv_${n}`))),e=h1(e,n,s,o,a),t=h1(t,n,c,u,h),{vertexShader:e,fragmentShader:t}}function h1(r,e,t,i,n){return(i||n||t)&&(r=r.replace(G3,`
${t}
void troikaOrigMain${e}() {`),r+=`
void main() {
  ${i}
  troikaOrigMain${e}();
  ${n}
}`),r}function Gb(r,e){return r==="uniforms"?void 0:typeof e=="function"?e.toString():e}let Qb=0;const f1=new Map;function zb(r){const e=JSON.stringify(r,Gb);let t=f1.get(e);return t==null&&f1.set(e,t=++Qb),t}/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/function Hb(){return typeof window>"u"&&(self.window=self),function(r){var e={parse:function(n){var s=e._bin,o=new Uint8Array(n);if(s.readASCII(o,0,4)=="ttcf"){var a=4;s.readUshort(o,a),a+=2,s.readUshort(o,a),a+=2;var l=s.readUint(o,a);a+=4;for(var c=[],u=0;u<l;u++){var h=s.readUint(o,a);a+=4,c.push(e._readFont(o,h))}return c}return[e._readFont(o,0)]},_readFont:function(n,s){var o=e._bin,a=s;o.readFixed(n,s),s+=4;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2;for(var c=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],u={_data:n,_offset:a},h={},f=0;f<l;f++){var d=o.readASCII(n,s,4);s+=4,o.readUint(n,s),s+=4;var m=o.readUint(n,s);s+=4;var A=o.readUint(n,s);s+=4,h[d]={offset:m,length:A}}for(f=0;f<c.length;f++){var p=c[f];h[p]&&(u[p.trim()]=e[p.trim()].parse(n,h[p].offset,h[p].length,u))}return u},_tabOffset:function(n,s,o){for(var a=e._bin,l=a.readUshort(n,o+4),c=o+12,u=0;u<l;u++){var h=a.readASCII(n,c,4);c+=4,a.readUint(n,c),c+=4;var f=a.readUint(n,c);if(c+=4,a.readUint(n,c),c+=4,h==s)return f}return 0}};e._bin={readFixed:function(n,s){return(n[s]<<8|n[s+1])+(n[s+2]<<8|n[s+3])/65540},readF2dot14:function(n,s){return e._bin.readShort(n,s)/16384},readInt:function(n,s){return e._bin._view(n).getInt32(s)},readInt8:function(n,s){return e._bin._view(n).getInt8(s)},readShort:function(n,s){return e._bin._view(n).getInt16(s)},readUshort:function(n,s){return e._bin._view(n).getUint16(s)},readUshorts:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(e._bin.readUshort(n,s+2*l));return a},readUint:function(n,s){return e._bin._view(n).getUint32(s)},readUint64:function(n,s){return 4294967296*e._bin.readUint(n,s)+e._bin.readUint(n,s+4)},readASCII:function(n,s,o){for(var a="",l=0;l<o;l++)a+=String.fromCharCode(n[s+l]);return a},readUnicode:function(n,s,o){for(var a="",l=0;l<o;l++){var c=n[s++]<<8|n[s++];a+=String.fromCharCode(c)}return a},_tdec:typeof window<"u"&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(n,s,o){var a=e._bin._tdec;return a&&s==0&&o==n.length?a.decode(n):e._bin.readASCII(n,s,o)},readBytes:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(n[s+l]);return a},readASCIIArray:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(String.fromCharCode(n[s+l]));return a},_view:function(n){return n._dataView||(n._dataView=n.buffer?new DataView(n.buffer,n.byteOffset,n.byteLength):new DataView(new Uint8Array(n).buffer))}},e._lctf={},e._lctf.parse=function(n,s,o,a,l){var c=e._bin,u={},h=s;c.readFixed(n,s),s+=4;var f=c.readUshort(n,s);s+=2;var d=c.readUshort(n,s);s+=2;var m=c.readUshort(n,s);return s+=2,u.scriptList=e._lctf.readScriptList(n,h+f),u.featureList=e._lctf.readFeatureList(n,h+d),u.lookupList=e._lctf.readLookupList(n,h+m,l),u},e._lctf.readLookupList=function(n,s,o){var a=e._bin,l=s,c=[],u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=a.readUshort(n,s);s+=2;var d=e._lctf.readLookupTable(n,l+f,o);c.push(d)}return c},e._lctf.readLookupTable=function(n,s,o){var a=e._bin,l=s,c={tabs:[]};c.ltype=a.readUshort(n,s),s+=2,c.flag=a.readUshort(n,s),s+=2;var u=a.readUshort(n,s);s+=2;for(var h=c.ltype,f=0;f<u;f++){var d=a.readUshort(n,s);s+=2;var m=o(n,h,l+d,c);c.tabs.push(m)}return c},e._lctf.numOfOnes=function(n){for(var s=0,o=0;o<32;o++)(n>>>o&1)!=0&&s++;return s},e._lctf.readClassDef=function(n,s){var o=e._bin,a=[],l=o.readUshort(n,s);if(s+=2,l==1){var c=o.readUshort(n,s);s+=2;var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++)a.push(c+h),a.push(c+h),a.push(o.readUshort(n,s)),s+=2}if(l==2){var f=o.readUshort(n,s);for(s+=2,h=0;h<f;h++)a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2}return a},e._lctf.getInterval=function(n,s){for(var o=0;o<n.length;o+=3){var a=n[o],l=n[o+1];if(n[o+2],a<=s&&s<=l)return o}return-1},e._lctf.readCoverage=function(n,s){var o=e._bin,a={};a.fmt=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.fmt==1&&(a.tab=o.readUshorts(n,s,l)),a.fmt==2&&(a.tab=o.readUshorts(n,s,3*l)),a},e._lctf.coverageIndex=function(n,s){var o=n.tab;if(n.fmt==1)return o.indexOf(s);if(n.fmt==2){var a=e._lctf.getInterval(o,s);if(a!=-1)return o[a+2]+(s-o[a])}return-1},e._lctf.readFeatureList=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2;var d=e._lctf.readFeatureTable(n,a+f);d.tag=h.trim(),l.push(d)}return l},e._lctf.readFeatureTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.featureParams=a+c);var u=o.readUshort(n,s);s+=2,l.tab=[];for(var h=0;h<u;h++)l.tab.push(o.readUshort(n,s+2*h));return l},e._lctf.readScriptList=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2,l[h.trim()]=e._lctf.readScriptTable(n,a+f)}return l},e._lctf.readScriptTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.default=e._lctf.readLangSysTable(n,a+c));var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=o.readASCII(n,s,4);s+=4;var d=o.readUshort(n,s);s+=2,l[f.trim()]=e._lctf.readLangSysTable(n,a+d)}return l},e._lctf.readLangSysTable=function(n,s){var o=e._bin,a={};o.readUshort(n,s),s+=2,a.reqFeature=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.features=o.readUshorts(n,s,l),a},e.CFF={},e.CFF.parse=function(n,s,o){var a=e._bin;(n=new Uint8Array(n.buffer,s,o))[s=0],n[++s],n[++s],n[++s],s++;var l=[];s=e.CFF.readIndex(n,s,l);for(var c=[],u=0;u<l.length-1;u++)c.push(a.readASCII(n,s+l[u],l[u+1]-l[u]));s+=l[l.length-1];var h=[];s=e.CFF.readIndex(n,s,h);var f=[];for(u=0;u<h.length-1;u++)f.push(e.CFF.readDict(n,s+h[u],s+h[u+1]));s+=h[h.length-1];var d=f[0],m=[];s=e.CFF.readIndex(n,s,m);var A=[];for(u=0;u<m.length-1;u++)A.push(a.readASCII(n,s+m[u],m[u+1]-m[u]));if(s+=m[m.length-1],e.CFF.readSubrs(n,s,d),d.CharStrings){s=d.CharStrings,m=[],s=e.CFF.readIndex(n,s,m);var p=[];for(u=0;u<m.length-1;u++)p.push(a.readBytes(n,s+m[u],m[u+1]-m[u]));d.CharStrings=p}if(d.ROS){s=d.FDArray;var g=[];for(s=e.CFF.readIndex(n,s,g),d.FDArray=[],u=0;u<g.length-1;u++){var v=e.CFF.readDict(n,s+g[u],s+g[u+1]);e.CFF._readFDict(n,v,A),d.FDArray.push(v)}s+=g[g.length-1],s=d.FDSelect,d.FDSelect=[];var E=n[s];if(s++,E!=3)throw E;var C=a.readUshort(n,s);for(s+=2,u=0;u<C+1;u++)d.FDSelect.push(a.readUshort(n,s),n[s+2]),s+=3}return d.Encoding&&(d.Encoding=e.CFF.readEncoding(n,d.Encoding,d.CharStrings.length)),d.charset&&(d.charset=e.CFF.readCharset(n,d.charset,d.CharStrings.length)),e.CFF._readFDict(n,d,A),d},e.CFF._readFDict=function(n,s,o){var a;for(var l in s.Private&&(a=s.Private[1],s.Private=e.CFF.readDict(n,a,a+s.Private[0]),s.Private.Subrs&&e.CFF.readSubrs(n,a+s.Private.Subrs,s.Private)),s)["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(l)!=-1&&(s[l]=o[s[l]-426+35])},e.CFF.readSubrs=function(n,s,o){var a=e._bin,l=[];s=e.CFF.readIndex(n,s,l);var c,u=l.length;c=u<1240?107:u<33900?1131:32768,o.Bias=c,o.Subrs=[];for(var h=0;h<l.length-1;h++)o.Subrs.push(a.readBytes(n,s+l[h],l[h+1]-l[h]))},e.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],e.CFF.glyphByUnicode=function(n,s){for(var o=0;o<n.charset.length;o++)if(n.charset[o]==s)return o;return-1},e.CFF.glyphBySE=function(n,s){return s<0||s>255?-1:e.CFF.glyphByUnicode(n,e.CFF.tableSE[s])},e.CFF.readEncoding=function(n,s,o){e._bin;var a=[".notdef"],l=n[s];if(s++,l!=0)throw"error: unknown encoding format: "+l;var c=n[s];s++;for(var u=0;u<c;u++)a.push(n[s+u]);return a},e.CFF.readCharset=function(n,s,o){var a=e._bin,l=[".notdef"],c=n[s];if(s++,c==0)for(var u=0;u<o;u++){var h=a.readUshort(n,s);s+=2,l.push(h)}else{if(c!=1&&c!=2)throw"error: format: "+c;for(;l.length<o;){h=a.readUshort(n,s),s+=2;var f=0;for(c==1?(f=n[s],s++):(f=a.readUshort(n,s),s+=2),u=0;u<=f;u++)l.push(h),h++}}return l},e.CFF.readIndex=function(n,s,o){var a=e._bin,l=a.readUshort(n,s)+1,c=n[s+=2];if(s++,c==1)for(var u=0;u<l;u++)o.push(n[s+u]);else if(c==2)for(u=0;u<l;u++)o.push(a.readUshort(n,s+2*u));else if(c==3)for(u=0;u<l;u++)o.push(16777215&a.readUint(n,s+3*u-1));else if(l!=1)throw"unsupported offset size: "+c+", count: "+l;return(s+=l*c)-1},e.CFF.getCharString=function(n,s,o){var a=e._bin,l=n[s],c=n[s+1];n[s+2],n[s+3],n[s+4];var u=1,h=null,f=null;l<=20&&(h=l,u=1),l==12&&(h=100*l+c,u=2),21<=l&&l<=27&&(h=l,u=1),l==28&&(f=a.readShort(n,s+1),u=3),29<=l&&l<=31&&(h=l,u=1),32<=l&&l<=246&&(f=l-139,u=1),247<=l&&l<=250&&(f=256*(l-247)+c+108,u=2),251<=l&&l<=254&&(f=256*-(l-251)-c-108,u=2),l==255&&(f=a.readInt(n,s+1)/65535,u=5),o.val=f??"o"+h,o.size=u},e.CFF.readCharString=function(n,s,o){for(var a=s+o,l=e._bin,c=[];s<a;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;u<=20&&(d=u,f=1),u==12&&(d=100*u+h,f=2),u!=19&&u!=20||(d=u,f=2),21<=u&&u<=27&&(d=u,f=1),u==28&&(m=l.readShort(n,s+1),f=3),29<=u&&u<=31&&(d=u,f=1),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255&&(m=l.readInt(n,s+1)/65535,f=5),c.push(m??"o"+d),s+=f}return c},e.CFF.readDict=function(n,s,o){for(var a=e._bin,l={},c=[];s<o;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;if(u==28&&(m=a.readShort(n,s+1),f=3),u==29&&(m=a.readInt(n,s+1),f=5),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255)throw m=a.readInt(n,s+1)/65535,f=5,"unknown number";if(u==30){var A=[];for(f=1;;){var p=n[s+f];f++;var g=p>>4,v=15&p;if(g!=15&&A.push(g),v!=15&&A.push(v),v==15)break}for(var E="",C=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],I=0;I<A.length;I++)E+=C[A[I]];m=parseFloat(E)}u<=21&&(d=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][u],f=1,u==12&&(d=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][h],f=2)),d!=null?(l[d]=c.length==1?c[0]:c,c=[]):c.push(m),s+=f}return l},e.cmap={},e.cmap.parse=function(n,s,o){n=new Uint8Array(n.buffer,s,o),s=0;var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2;var u=[];l.tables=[];for(var h=0;h<c;h++){var f=a.readUshort(n,s);s+=2;var d=a.readUshort(n,s);s+=2;var m=a.readUint(n,s);s+=4;var A="p"+f+"e"+d,p=u.indexOf(m);if(p==-1){var g;p=l.tables.length,u.push(m);var v=a.readUshort(n,m);v==0?g=e.cmap.parse0(n,m):v==4?g=e.cmap.parse4(n,m):v==6?g=e.cmap.parse6(n,m):v==12?g=e.cmap.parse12(n,m):console.debug("unknown format: "+v,f,d,m),l.tables.push(g)}if(l[A]!=null)throw"multiple tables for one platform+encoding";l[A]=p}return l},e.cmap.parse0=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,a.map=[];for(var c=0;c<l-6;c++)a.map.push(n[s+c]);return a},e.cmap.parse4=function(n,s){var o=e._bin,a=s,l={};l.format=o.readUshort(n,s),s+=2;var c=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2;var u=o.readUshort(n,s);s+=2;var h=u/2;l.searchRange=o.readUshort(n,s),s+=2,l.entrySelector=o.readUshort(n,s),s+=2,l.rangeShift=o.readUshort(n,s),s+=2,l.endCount=o.readUshorts(n,s,h),s+=2*h,s+=2,l.startCount=o.readUshorts(n,s,h),s+=2*h,l.idDelta=[];for(var f=0;f<h;f++)l.idDelta.push(o.readShort(n,s)),s+=2;for(l.idRangeOffset=o.readUshorts(n,s,h),s+=2*h,l.glyphIdArray=[];s<a+c;)l.glyphIdArray.push(o.readUshort(n,s)),s+=2;return l},e.cmap.parse6=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,a.firstCode=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,a.glyphIdArray=[];for(var c=0;c<l;c++)a.glyphIdArray.push(o.readUshort(n,s)),s+=2;return a},e.cmap.parse12=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,s+=2,o.readUint(n,s),s+=4,o.readUint(n,s),s+=4;var l=o.readUint(n,s);s+=4,a.groups=[];for(var c=0;c<l;c++){var u=s+12*c,h=o.readUint(n,u+0),f=o.readUint(n,u+4),d=o.readUint(n,u+8);a.groups.push([h,f,d])}return a},e.glyf={},e.glyf.parse=function(n,s,o,a){for(var l=[],c=0;c<a.maxp.numGlyphs;c++)l.push(null);return l},e.glyf._parseGlyf=function(n,s){var o=e._bin,a=n._data,l=e._tabOffset(a,"glyf",n._offset)+n.loca[s];if(n.loca[s]==n.loca[s+1])return null;var c={};if(c.noc=o.readShort(a,l),l+=2,c.xMin=o.readShort(a,l),l+=2,c.yMin=o.readShort(a,l),l+=2,c.xMax=o.readShort(a,l),l+=2,c.yMax=o.readShort(a,l),l+=2,c.xMin>=c.xMax||c.yMin>=c.yMax)return null;if(c.noc>0){c.endPts=[];for(var u=0;u<c.noc;u++)c.endPts.push(o.readUshort(a,l)),l+=2;var h=o.readUshort(a,l);if(l+=2,a.length-l<h)return null;c.instructions=o.readBytes(a,l,h),l+=h;var f=c.endPts[c.noc-1]+1;for(c.flags=[],u=0;u<f;u++){var d=a[l];if(l++,c.flags.push(d),(8&d)!=0){var m=a[l];l++;for(var A=0;A<m;A++)c.flags.push(d),u++}}for(c.xs=[],u=0;u<f;u++){var p=(2&c.flags[u])!=0,g=(16&c.flags[u])!=0;p?(c.xs.push(g?a[l]:-a[l]),l++):g?c.xs.push(0):(c.xs.push(o.readShort(a,l)),l+=2)}for(c.ys=[],u=0;u<f;u++)p=(4&c.flags[u])!=0,g=(32&c.flags[u])!=0,p?(c.ys.push(g?a[l]:-a[l]),l++):g?c.ys.push(0):(c.ys.push(o.readShort(a,l)),l+=2);var v=0,E=0;for(u=0;u<f;u++)v+=c.xs[u],E+=c.ys[u],c.xs[u]=v,c.ys[u]=E}else{var C;c.parts=[];do{C=o.readUshort(a,l),l+=2;var I={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(c.parts.push(I),I.glyphIndex=o.readUshort(a,l),l+=2,1&C){var _=o.readShort(a,l);l+=2;var x=o.readShort(a,l);l+=2}else _=o.readInt8(a,l),l++,x=o.readInt8(a,l),l++;2&C?(I.m.tx=_,I.m.ty=x):(I.p1=_,I.p2=x),8&C?(I.m.a=I.m.d=o.readF2dot14(a,l),l+=2):64&C?(I.m.a=o.readF2dot14(a,l),l+=2,I.m.d=o.readF2dot14(a,l),l+=2):128&C&&(I.m.a=o.readF2dot14(a,l),l+=2,I.m.b=o.readF2dot14(a,l),l+=2,I.m.c=o.readF2dot14(a,l),l+=2,I.m.d=o.readF2dot14(a,l),l+=2)}while(32&C);if(256&C){var S=o.readUshort(a,l);for(l+=2,c.instr=[],u=0;u<S;u++)c.instr.push(a[l]),l++}}return c},e.GDEF={},e.GDEF.parse=function(n,s,o,a){var l=s;s+=4;var c=e._bin.readUshort(n,s);return{glyphClassDef:c===0?null:e._lctf.readClassDef(n,l+c)}},e.GPOS={},e.GPOS.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GPOS.subt)},e.GPOS.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s==1||s==2||s==3||s==7||s==8&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,h+c)}if(s==1&&u.fmt==1){var f=l.readUshort(n,o);o+=2,f!=0&&(u.pos=e.GPOS.readValueRecord(n,o,f))}else if(s==2&&u.fmt>=1&&u.fmt<=2){f=l.readUshort(n,o),o+=2;var d=l.readUshort(n,o);o+=2;var m=e._lctf.numOfOnes(f),A=e._lctf.numOfOnes(d);if(u.fmt==1){u.pairsets=[];var p=l.readUshort(n,o);o+=2;for(var g=0;g<p;g++){var v=c+l.readUshort(n,o);o+=2;var E=l.readUshort(n,v);v+=2;for(var C=[],I=0;I<E;I++){var _=l.readUshort(n,v);v+=2,f!=0&&(w=e.GPOS.readValueRecord(n,v,f),v+=2*m),d!=0&&(R=e.GPOS.readValueRecord(n,v,d),v+=2*A),C.push({gid2:_,val1:w,val2:R})}u.pairsets.push(C)}}if(u.fmt==2){var x=l.readUshort(n,o);o+=2;var S=l.readUshort(n,o);o+=2;var b=l.readUshort(n,o);o+=2;var T=l.readUshort(n,o);for(o+=2,u.classDef1=e._lctf.readClassDef(n,c+x),u.classDef2=e._lctf.readClassDef(n,c+S),u.matrix=[],g=0;g<b;g++){var B=[];for(I=0;I<T;I++){var w=null,R=null;f!=0&&(w=e.GPOS.readValueRecord(n,o,f),o+=2*m),d!=0&&(R=e.GPOS.readValueRecord(n,o,d),o+=2*A),B.push({val1:w,val2:R})}u.matrix.push(B)}}}else if(s==4&&u.fmt==1)u.markCoverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.baseCoverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.markArray=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.baseArray=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else if(s==6&&u.fmt==1)u.mark1Coverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.mark2Coverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.mark1Array=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.mark2Array=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else{if(s==9&&u.fmt==1){var D=l.readUshort(n,o);o+=2;var G=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=D;else if(a.ltype!=D)throw"invalid extension substitution";return e.GPOS.subt(n,a.ltype,c+G)}console.debug("unsupported GPOS table LookupType",s,"format",u.fmt)}return u},e.GPOS.readValueRecord=function(n,s,o){var a=e._bin,l=[];return l.push(1&o?a.readShort(n,s):0),s+=1&o?2:0,l.push(2&o?a.readShort(n,s):0),s+=2&o?2:0,l.push(4&o?a.readShort(n,s):0),s+=4&o?2:0,l.push(8&o?a.readShort(n,s):0),s+=8&o?2:0,l},e.GPOS.readBaseArray=function(n,s,o){var a=e._bin,l=[],c=s,u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){for(var f=[],d=0;d<o;d++)f.push(e.GPOS.readAnchorRecord(n,c+a.readUshort(n,s))),s+=2;l.push(f)}return l},e.GPOS.readMarkArray=function(n,s){var o=e._bin,a=[],l=s,c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=e.GPOS.readAnchorRecord(n,o.readUshort(n,s+2)+l);h.markClass=o.readUshort(n,s),a.push(h),s+=4}return a},e.GPOS.readAnchorRecord=function(n,s){var o=e._bin,a={};return a.fmt=o.readUshort(n,s),a.x=o.readShort(n,s+2),a.y=o.readShort(n,s+4),a},e.GSUB={},e.GSUB.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GSUB.subt)},e.GSUB.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s!=1&&s!=2&&s!=4&&s!=5&&s!=6)return null;if(s==1||s==2||s==4||s==5&&u.fmt<=2||s==6&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,c+h)}if(s==1&&u.fmt>=1&&u.fmt<=2){if(u.fmt==1)u.delta=l.readShort(n,o),o+=2;else if(u.fmt==2){var f=l.readUshort(n,o);o+=2,u.newg=l.readUshorts(n,o,f),o+=2*u.newg.length}}else if(s==2&&u.fmt==1){f=l.readUshort(n,o),o+=2,u.seqs=[];for(var d=0;d<f;d++){var m=l.readUshort(n,o)+c;o+=2;var A=l.readUshort(n,m);u.seqs.push(l.readUshorts(n,m+2,A))}}else if(s==4)for(u.vals=[],f=l.readUshort(n,o),o+=2,d=0;d<f;d++){var p=l.readUshort(n,o);o+=2,u.vals.push(e.GSUB.readLigatureSet(n,c+p))}else if(s==5&&u.fmt==2){if(u.fmt==2){var g=l.readUshort(n,o);o+=2,u.cDef=e._lctf.readClassDef(n,c+g),u.scset=[];var v=l.readUshort(n,o);for(o+=2,d=0;d<v;d++){var E=l.readUshort(n,o);o+=2,u.scset.push(E==0?null:e.GSUB.readSubClassSet(n,c+E))}}}else if(s==6&&u.fmt==3){if(u.fmt==3){for(d=0;d<3;d++){f=l.readUshort(n,o),o+=2;for(var C=[],I=0;I<f;I++)C.push(e._lctf.readCoverage(n,c+l.readUshort(n,o+2*I)));o+=2*f,d==0&&(u.backCvg=C),d==1&&(u.inptCvg=C),d==2&&(u.ahedCvg=C)}f=l.readUshort(n,o),o+=2,u.lookupRec=e.GSUB.readSubstLookupRecords(n,o,f)}}else{if(s==7&&u.fmt==1){var _=l.readUshort(n,o);o+=2;var x=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=_;else if(a.ltype!=_)throw"invalid extension substitution";return e.GSUB.subt(n,a.ltype,c+x)}console.debug("unsupported GSUB table LookupType",s,"format",u.fmt)}return u},e.GSUB.readSubClassSet=function(n,s){var o=e._bin.readUshort,a=s,l=[],c=o(n,s);s+=2;for(var u=0;u<c;u++){var h=o(n,s);s+=2,l.push(e.GSUB.readSubClassRule(n,a+h))}return l},e.GSUB.readSubClassRule=function(n,s){var o=e._bin.readUshort,a={},l=o(n,s),c=o(n,s+=2);s+=2,a.input=[];for(var u=0;u<l-1;u++)a.input.push(o(n,s)),s+=2;return a.substLookupRecords=e.GSUB.readSubstLookupRecords(n,s,c),a},e.GSUB.readSubstLookupRecords=function(n,s,o){for(var a=e._bin.readUshort,l=[],c=0;c<o;c++)l.push(a(n,s),a(n,s+2)),s+=4;return l},e.GSUB.readChainSubClassSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readChainSubClassRule(n,a+h))}return l},e.GSUB.readChainSubClassRule=function(n,s){for(var o=e._bin,a={},l=["backtrack","input","lookahead"],c=0;c<l.length;c++){var u=o.readUshort(n,s);s+=2,c==1&&u--,a[l[c]]=o.readUshorts(n,s,u),s+=2*a[l[c]].length}return u=o.readUshort(n,s),s+=2,a.subst=o.readUshorts(n,s,2*u),s+=2*a.subst.length,a},e.GSUB.readLigatureSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readLigature(n,a+h))}return l},e.GSUB.readLigature=function(n,s){var o=e._bin,a={chain:[]};a.nglyph=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2;for(var c=0;c<l-1;c++)a.chain.push(o.readUshort(n,s)),s+=2;return a},e.head={},e.head.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.fontRevision=a.readFixed(n,s),s+=4,a.readUint(n,s),s+=4,a.readUint(n,s),s+=4,l.flags=a.readUshort(n,s),s+=2,l.unitsPerEm=a.readUshort(n,s),s+=2,l.created=a.readUint64(n,s),s+=8,l.modified=a.readUint64(n,s),s+=8,l.xMin=a.readShort(n,s),s+=2,l.yMin=a.readShort(n,s),s+=2,l.xMax=a.readShort(n,s),s+=2,l.yMax=a.readShort(n,s),s+=2,l.macStyle=a.readUshort(n,s),s+=2,l.lowestRecPPEM=a.readUshort(n,s),s+=2,l.fontDirectionHint=a.readShort(n,s),s+=2,l.indexToLocFormat=a.readShort(n,s),s+=2,l.glyphDataFormat=a.readShort(n,s),s+=2,l},e.hhea={},e.hhea.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.ascender=a.readShort(n,s),s+=2,l.descender=a.readShort(n,s),s+=2,l.lineGap=a.readShort(n,s),s+=2,l.advanceWidthMax=a.readUshort(n,s),s+=2,l.minLeftSideBearing=a.readShort(n,s),s+=2,l.minRightSideBearing=a.readShort(n,s),s+=2,l.xMaxExtent=a.readShort(n,s),s+=2,l.caretSlopeRise=a.readShort(n,s),s+=2,l.caretSlopeRun=a.readShort(n,s),s+=2,l.caretOffset=a.readShort(n,s),s+=2,s+=8,l.metricDataFormat=a.readShort(n,s),s+=2,l.numberOfHMetrics=a.readUshort(n,s),s+=2,l},e.hmtx={},e.hmtx.parse=function(n,s,o,a){for(var l=e._bin,c={aWidth:[],lsBearing:[]},u=0,h=0,f=0;f<a.maxp.numGlyphs;f++)f<a.hhea.numberOfHMetrics&&(u=l.readUshort(n,s),s+=2,h=l.readShort(n,s),s+=2),c.aWidth.push(u),c.lsBearing.push(h);return c},e.kern={},e.kern.parse=function(n,s,o,a){var l=e._bin,c=l.readUshort(n,s);if(s+=2,c==1)return e.kern.parseV1(n,s-2,o,a);var u=l.readUshort(n,s);s+=2;for(var h={glyph1:[],rval:[]},f=0;f<u;f++){s+=2,o=l.readUshort(n,s),s+=2;var d=l.readUshort(n,s);s+=2;var m=d>>>8;if((m&=15)!=0)throw"unknown kern table format: "+m;s=e.kern.readFormat0(n,s,h)}return h},e.kern.parseV1=function(n,s,o,a){var l=e._bin;l.readFixed(n,s),s+=4;var c=l.readUint(n,s);s+=4;for(var u={glyph1:[],rval:[]},h=0;h<c;h++){l.readUint(n,s),s+=4;var f=l.readUshort(n,s);s+=2,l.readUshort(n,s),s+=2;var d=f>>>8;if((d&=15)!=0)throw"unknown kern table format: "+d;s=e.kern.readFormat0(n,s,u)}return u},e.kern.readFormat0=function(n,s,o){var a=e._bin,l=-1,c=a.readUshort(n,s);s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2;for(var u=0;u<c;u++){var h=a.readUshort(n,s);s+=2;var f=a.readUshort(n,s);s+=2;var d=a.readShort(n,s);s+=2,h!=l&&(o.glyph1.push(h),o.rval.push({glyph2:[],vals:[]}));var m=o.rval[o.rval.length-1];m.glyph2.push(f),m.vals.push(d),l=h}return s},e.loca={},e.loca.parse=function(n,s,o,a){var l=e._bin,c=[],u=a.head.indexToLocFormat,h=a.maxp.numGlyphs+1;if(u==0)for(var f=0;f<h;f++)c.push(l.readUshort(n,s+(f<<1))<<1);if(u==1)for(f=0;f<h;f++)c.push(l.readUint(n,s+(f<<2)));return c},e.maxp={},e.maxp.parse=function(n,s,o){var a=e._bin,l={},c=a.readUint(n,s);return s+=4,l.numGlyphs=a.readUshort(n,s),s+=2,c==65536&&(l.maxPoints=a.readUshort(n,s),s+=2,l.maxContours=a.readUshort(n,s),s+=2,l.maxCompositePoints=a.readUshort(n,s),s+=2,l.maxCompositeContours=a.readUshort(n,s),s+=2,l.maxZones=a.readUshort(n,s),s+=2,l.maxTwilightPoints=a.readUshort(n,s),s+=2,l.maxStorage=a.readUshort(n,s),s+=2,l.maxFunctionDefs=a.readUshort(n,s),s+=2,l.maxInstructionDefs=a.readUshort(n,s),s+=2,l.maxStackElements=a.readUshort(n,s),s+=2,l.maxSizeOfInstructions=a.readUshort(n,s),s+=2,l.maxComponentElements=a.readUshort(n,s),s+=2,l.maxComponentDepth=a.readUshort(n,s),s+=2),l},e.name={},e.name.parse=function(n,s,o){var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2,a.readUshort(n,s);for(var u,h=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],f=s+=2,d=0;d<c;d++){var m=a.readUshort(n,s);s+=2;var A=a.readUshort(n,s);s+=2;var p=a.readUshort(n,s);s+=2;var g=a.readUshort(n,s);s+=2;var v=a.readUshort(n,s);s+=2;var E=a.readUshort(n,s);s+=2;var C,I=h[g],_=f+12*c+E;if(m==0)C=a.readUnicode(n,_,v/2);else if(m==3&&A==0)C=a.readUnicode(n,_,v/2);else if(A==0)C=a.readASCII(n,_,v);else if(A==1)C=a.readUnicode(n,_,v/2);else if(A==3)C=a.readUnicode(n,_,v/2);else{if(m!=1)throw"unknown encoding "+A+", platformID: "+m;C=a.readASCII(n,_,v),console.debug("reading unknown MAC encoding "+A+" as ASCII")}var x="p"+m+","+p.toString(16);l[x]==null&&(l[x]={}),l[x][I!==void 0?I:g]=C,l[x]._lang=p}for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==1033)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==0)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==3084)return l[S];for(var S in l)if(l[S].postScriptName!=null)return l[S];for(var S in l){u=S;break}return console.debug("returning name table with languageID "+l[u]._lang),l[u]},e["OS/2"]={},e["OS/2"].parse=function(n,s,o){var a=e._bin.readUshort(n,s);s+=2;var l={};if(a==0)e["OS/2"].version0(n,s,l);else if(a==1)e["OS/2"].version1(n,s,l);else if(a==2||a==3||a==4)e["OS/2"].version2(n,s,l);else{if(a!=5)throw"unknown OS/2 table version: "+a;e["OS/2"].version5(n,s,l)}return l},e["OS/2"].version0=function(n,s,o){var a=e._bin;return o.xAvgCharWidth=a.readShort(n,s),s+=2,o.usWeightClass=a.readUshort(n,s),s+=2,o.usWidthClass=a.readUshort(n,s),s+=2,o.fsType=a.readUshort(n,s),s+=2,o.ySubscriptXSize=a.readShort(n,s),s+=2,o.ySubscriptYSize=a.readShort(n,s),s+=2,o.ySubscriptXOffset=a.readShort(n,s),s+=2,o.ySubscriptYOffset=a.readShort(n,s),s+=2,o.ySuperscriptXSize=a.readShort(n,s),s+=2,o.ySuperscriptYSize=a.readShort(n,s),s+=2,o.ySuperscriptXOffset=a.readShort(n,s),s+=2,o.ySuperscriptYOffset=a.readShort(n,s),s+=2,o.yStrikeoutSize=a.readShort(n,s),s+=2,o.yStrikeoutPosition=a.readShort(n,s),s+=2,o.sFamilyClass=a.readShort(n,s),s+=2,o.panose=a.readBytes(n,s,10),s+=10,o.ulUnicodeRange1=a.readUint(n,s),s+=4,o.ulUnicodeRange2=a.readUint(n,s),s+=4,o.ulUnicodeRange3=a.readUint(n,s),s+=4,o.ulUnicodeRange4=a.readUint(n,s),s+=4,o.achVendID=[a.readInt8(n,s),a.readInt8(n,s+1),a.readInt8(n,s+2),a.readInt8(n,s+3)],s+=4,o.fsSelection=a.readUshort(n,s),s+=2,o.usFirstCharIndex=a.readUshort(n,s),s+=2,o.usLastCharIndex=a.readUshort(n,s),s+=2,o.sTypoAscender=a.readShort(n,s),s+=2,o.sTypoDescender=a.readShort(n,s),s+=2,o.sTypoLineGap=a.readShort(n,s),s+=2,o.usWinAscent=a.readUshort(n,s),s+=2,o.usWinDescent=a.readUshort(n,s),s+=2},e["OS/2"].version1=function(n,s,o){var a=e._bin;return s=e["OS/2"].version0(n,s,o),o.ulCodePageRange1=a.readUint(n,s),s+=4,o.ulCodePageRange2=a.readUint(n,s),s+=4},e["OS/2"].version2=function(n,s,o){var a=e._bin;return s=e["OS/2"].version1(n,s,o),o.sxHeight=a.readShort(n,s),s+=2,o.sCapHeight=a.readShort(n,s),s+=2,o.usDefault=a.readUshort(n,s),s+=2,o.usBreak=a.readUshort(n,s),s+=2,o.usMaxContext=a.readUshort(n,s),s+=2},e["OS/2"].version5=function(n,s,o){var a=e._bin;return s=e["OS/2"].version2(n,s,o),o.usLowerOpticalPointSize=a.readUshort(n,s),s+=2,o.usUpperOpticalPointSize=a.readUshort(n,s),s+=2},e.post={},e.post.parse=function(n,s,o){var a=e._bin,l={};return l.version=a.readFixed(n,s),s+=4,l.italicAngle=a.readFixed(n,s),s+=4,l.underlinePosition=a.readShort(n,s),s+=2,l.underlineThickness=a.readShort(n,s),s+=2,l},e==null&&(e={}),e.U==null&&(e.U={}),e.U.codeToGlyph=function(n,s){var o=n.cmap,a=-1;if(o.p0e4!=null?a=o.p0e4:o.p3e1!=null?a=o.p3e1:o.p1e0!=null?a=o.p1e0:o.p0e3!=null&&(a=o.p0e3),a==-1)throw"no familiar platform and encoding!";var l=o.tables[a];if(l.format==0)return s>=l.map.length?0:l.map[s];if(l.format==4){for(var c=-1,u=0;u<l.endCount.length;u++)if(s<=l.endCount[u]){c=u;break}return c==-1||l.startCount[c]>s?0:65535&(l.idRangeOffset[c]!=0?l.glyphIdArray[s-l.startCount[c]+(l.idRangeOffset[c]>>1)-(l.idRangeOffset.length-c)]:s+l.idDelta[c])}if(l.format==12){if(s>l.groups[l.groups.length-1][1])return 0;for(u=0;u<l.groups.length;u++){var h=l.groups[u];if(h[0]<=s&&s<=h[1])return h[2]+(s-h[0])}return 0}throw"unknown cmap table format "+l.format},e.U.glyphToPath=function(n,s){var o={cmds:[],crds:[]};if(n.SVG&&n.SVG.entries[s]){var a=n.SVG.entries[s];return a==null?o:(typeof a=="string"&&(a=e.SVG.toPath(a),n.SVG.entries[s]=a),a)}if(n.CFF){var l={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:n.CFF.Private?n.CFF.Private.defaultWidthX:0,open:!1},c=n.CFF,u=n.CFF.Private;if(c.ROS){for(var h=0;c.FDSelect[h+2]<=s;)h+=2;u=c.FDArray[c.FDSelect[h+1]].Private}e.U._drawCFF(n.CFF.CharStrings[s],l,c,u,o)}else n.glyf&&e.U._drawGlyf(s,n,o);return o},e.U._drawGlyf=function(n,s,o){var a=s.glyf[n];a==null&&(a=s.glyf[n]=e.glyf._parseGlyf(s,n)),a!=null&&(a.noc>-1?e.U._simpleGlyph(a,o):e.U._compoGlyph(a,s,o))},e.U._simpleGlyph=function(n,s){for(var o=0;o<n.noc;o++){for(var a=o==0?0:n.endPts[o-1]+1,l=n.endPts[o],c=a;c<=l;c++){var u=c==a?l:c-1,h=c==l?a:c+1,f=1&n.flags[c],d=1&n.flags[u],m=1&n.flags[h],A=n.xs[c],p=n.ys[c];if(c==a)if(f){if(!d){e.U.P.moveTo(s,A,p);continue}e.U.P.moveTo(s,n.xs[u],n.ys[u])}else d?e.U.P.moveTo(s,n.xs[u],n.ys[u]):e.U.P.moveTo(s,(n.xs[u]+A)/2,(n.ys[u]+p)/2);f?d&&e.U.P.lineTo(s,A,p):m?e.U.P.qcurveTo(s,A,p,n.xs[h],n.ys[h]):e.U.P.qcurveTo(s,A,p,(A+n.xs[h])/2,(p+n.ys[h])/2)}e.U.P.closePath(s)}},e.U._compoGlyph=function(n,s,o){for(var a=0;a<n.parts.length;a++){var l={cmds:[],crds:[]},c=n.parts[a];e.U._drawGlyf(c.glyphIndex,s,l);for(var u=c.m,h=0;h<l.crds.length;h+=2){var f=l.crds[h],d=l.crds[h+1];o.crds.push(f*u.a+d*u.b+u.tx),o.crds.push(f*u.c+d*u.d+u.ty)}for(h=0;h<l.cmds.length;h++)o.cmds.push(l.cmds[h])}},e.U._getGlyphClass=function(n,s){var o=e._lctf.getInterval(s,n);return o==-1?0:s[o+2]},e.U._applySubs=function(n,s,o,a){for(var l=n.length-s-1,c=0;c<o.tabs.length;c++)if(o.tabs[c]!=null){var u,h=o.tabs[c];if(!h.coverage||(u=e._lctf.coverageIndex(h.coverage,n[s]))!=-1){if(o.ltype==1)n[s],h.fmt==1?n[s]=n[s]+h.delta:n[s]=h.newg[u];else if(o.ltype==4)for(var f=h.vals[u],d=0;d<f.length;d++){var m=f[d],A=m.chain.length;if(!(A>l)){for(var p=!0,g=0,v=0;v<A;v++){for(;n[s+g+(1+v)]==-1;)g++;m.chain[v]!=n[s+g+(1+v)]&&(p=!1)}if(p){for(n[s]=m.nglyph,v=0;v<A+g;v++)n[s+v+1]=-1;break}}}else if(o.ltype==5&&h.fmt==2)for(var E=e._lctf.getInterval(h.cDef,n[s]),C=h.cDef[E+2],I=h.scset[C],_=0;_<I.length;_++){var x=I[_],S=x.input;if(!(S.length>l)){for(p=!0,v=0;v<S.length;v++){var b=e._lctf.getInterval(h.cDef,n[s+1+v]);if(E==-1&&h.cDef[b+2]!=S[v]){p=!1;break}}if(p){var T=x.substLookupRecords;for(d=0;d<T.length;d+=2)T[d],T[d+1]}}}else if(o.ltype==6&&h.fmt==3){if(!e.U._glsCovered(n,h.backCvg,s-h.backCvg.length)||!e.U._glsCovered(n,h.inptCvg,s)||!e.U._glsCovered(n,h.ahedCvg,s+h.inptCvg.length))continue;var B=h.lookupRec;for(_=0;_<B.length;_+=2){E=B[_];var w=a[B[_+1]];e.U._applySubs(n,s+E,w,a)}}}}},e.U._glsCovered=function(n,s,o){for(var a=0;a<s.length;a++)if(e._lctf.coverageIndex(s[a],n[o+a])==-1)return!1;return!0},e.U.glyphsToPath=function(n,s,o){for(var a={cmds:[],crds:[]},l=0,c=0;c<s.length;c++){var u=s[c];if(u!=-1){for(var h=c<s.length-1&&s[c+1]!=-1?s[c+1]:0,f=e.U.glyphToPath(n,u),d=0;d<f.crds.length;d+=2)a.crds.push(f.crds[d]+l),a.crds.push(f.crds[d+1]);for(o&&a.cmds.push(o),d=0;d<f.cmds.length;d++)a.cmds.push(f.cmds[d]);o&&a.cmds.push("X"),l+=n.hmtx.aWidth[u],c<s.length-1&&(l+=e.U.getPairAdjustment(n,u,h))}}return a},e.U.P={},e.U.P.moveTo=function(n,s,o){n.cmds.push("M"),n.crds.push(s,o)},e.U.P.lineTo=function(n,s,o){n.cmds.push("L"),n.crds.push(s,o)},e.U.P.curveTo=function(n,s,o,a,l,c,u){n.cmds.push("C"),n.crds.push(s,o,a,l,c,u)},e.U.P.qcurveTo=function(n,s,o,a,l){n.cmds.push("Q"),n.crds.push(s,o,a,l)},e.U.P.closePath=function(n){n.cmds.push("Z")},e.U._drawCFF=function(n,s,o,a,l){for(var c=s.stack,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open,m=0,A=s.x,p=s.y,g=0,v=0,E=0,C=0,I=0,_=0,x=0,S=0,b=0,T=0,B={val:0,size:0};m<n.length;){e.CFF.getCharString(n,m,B);var w=B.val;if(m+=B.size,w=="o1"||w=="o18")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o3"||w=="o23")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o4")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),d&&e.U.P.closePath(l),p+=c.pop(),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o5")for(;c.length>0;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);else if(w=="o6"||w=="o7")for(var R=c.length,D=w=="o6",G=0;G<R;G++){var z=c.shift();D?A+=z:p+=z,D=!D,e.U.P.lineTo(l,A,p)}else if(w=="o8"||w=="o24"){R=c.length;for(var W=0;W+6<=R;)g=A+c.shift(),v=p+c.shift(),E=g+c.shift(),C=v+c.shift(),A=E+c.shift(),p=C+c.shift(),e.U.P.curveTo(l,g,v,E,C,A,p),W+=6;w=="o24"&&(A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p))}else{if(w=="o11")break;if(w=="o1234"||w=="o1235"||w=="o1236"||w=="o1237")w=="o1234"&&(v=p,E=(g=A+c.shift())+c.shift(),T=C=v+c.shift(),_=C,S=p,A=(x=(I=(b=E+c.shift())+c.shift())+c.shift())+c.shift(),e.U.P.curveTo(l,g,v,E,C,b,T),e.U.P.curveTo(l,I,_,x,S,A,p)),w=="o1235"&&(g=A+c.shift(),v=p+c.shift(),E=g+c.shift(),C=v+c.shift(),b=E+c.shift(),T=C+c.shift(),I=b+c.shift(),_=T+c.shift(),x=I+c.shift(),S=_+c.shift(),A=x+c.shift(),p=S+c.shift(),c.shift(),e.U.P.curveTo(l,g,v,E,C,b,T),e.U.P.curveTo(l,I,_,x,S,A,p)),w=="o1236"&&(g=A+c.shift(),v=p+c.shift(),E=g+c.shift(),T=C=v+c.shift(),_=C,x=(I=(b=E+c.shift())+c.shift())+c.shift(),S=_+c.shift(),A=x+c.shift(),e.U.P.curveTo(l,g,v,E,C,b,T),e.U.P.curveTo(l,I,_,x,S,A,p)),w=="o1237"&&(g=A+c.shift(),v=p+c.shift(),E=g+c.shift(),C=v+c.shift(),b=E+c.shift(),T=C+c.shift(),I=b+c.shift(),_=T+c.shift(),x=I+c.shift(),S=_+c.shift(),Math.abs(x-A)>Math.abs(S-p)?A=x+c.shift():p=S+c.shift(),e.U.P.curveTo(l,g,v,E,C,b,T),e.U.P.curveTo(l,I,_,x,S,A,p));else if(w=="o14"){if(c.length>0&&!h&&(f=c.shift()+o.nominalWidthX,h=!0),c.length==4){var q=c.shift(),F=c.shift(),N=c.shift(),L=c.shift(),$=e.CFF.glyphBySE(o,N),j=e.CFF.glyphBySE(o,L);e.U._drawCFF(o.CharStrings[$],s,o,a,l),s.x=q,s.y=F,e.U._drawCFF(o.CharStrings[j],s,o,a,l)}d&&(e.U.P.closePath(l),d=!1)}else if(w=="o19"||w=="o20")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0,m+=u+7>>3;else if(w=="o21")c.length>2&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),p+=c.pop(),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o22")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o25"){for(;c.length>6;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);g=A+c.shift(),v=p+c.shift(),E=g+c.shift(),C=v+c.shift(),A=E+c.shift(),p=C+c.shift(),e.U.P.curveTo(l,g,v,E,C,A,p)}else if(w=="o26")for(c.length%2&&(A+=c.shift());c.length>0;)g=A,v=p+c.shift(),A=E=g+c.shift(),p=(C=v+c.shift())+c.shift(),e.U.P.curveTo(l,g,v,E,C,A,p);else if(w=="o27")for(c.length%2&&(p+=c.shift());c.length>0;)v=p,E=(g=A+c.shift())+c.shift(),C=v+c.shift(),A=E+c.shift(),p=C,e.U.P.curveTo(l,g,v,E,C,A,p);else if(w=="o10"||w=="o29"){var V=w=="o10"?a:o;if(c.length==0)console.debug("error: empty stack");else{var k=c.pop(),Q=V.Subrs[k+V.Bias];s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d,e.U._drawCFF(Q,s,o,a,l),A=s.x,p=s.y,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open}}else if(w=="o30"||w=="o31"){var O=c.length,U=(W=0,w=="o31");for(W+=O-(R=-3&O);W<R;)U?(v=p,E=(g=A+c.shift())+c.shift(),p=(C=v+c.shift())+c.shift(),R-W==5?(A=E+c.shift(),W++):A=E,U=!1):(g=A,v=p+c.shift(),E=g+c.shift(),C=v+c.shift(),A=E+c.shift(),R-W==5?(p=C+c.shift(),W++):p=C,U=!0),e.U.P.curveTo(l,g,v,E,C,A,p),W+=4}else{if((w+"").charAt(0)=="o")throw console.debug("Unknown operation: "+w,n),w;c.push(w)}}}s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d};var t=e,i={Typr:t};return r.Typr=t,r.default=i,Object.defineProperty(r,"__esModule",{value:!0}),r}({}).Typr}/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/function Vb(){return function(r){var e=Uint8Array,t=Uint16Array,i=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),s=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(w,R){for(var D=new t(31),G=0;G<31;++G)D[G]=R+=1<<w[G-1];var z=new i(D[30]);for(G=1;G<30;++G)for(var W=D[G];W<D[G+1];++W)z[W]=W-D[G]<<5|G;return[D,z]},l=a(n,2),c=l[0],u=l[1];c[28]=258,u[258]=28;for(var h=a(s,0)[0],f=new t(32768),d=0;d<32768;++d){var m=(43690&d)>>>1|(21845&d)<<1;m=(61680&(m=(52428&m)>>>2|(13107&m)<<2))>>>4|(3855&m)<<4,f[d]=((65280&m)>>>8|(255&m)<<8)>>>1}var A=function(w,R,D){for(var G=w.length,z=0,W=new t(R);z<G;++z)++W[w[z]-1];var q,F=new t(R);for(z=0;z<R;++z)F[z]=F[z-1]+W[z-1]<<1;{q=new t(1<<R);var N=15-R;for(z=0;z<G;++z)if(w[z])for(var L=z<<4|w[z],$=R-w[z],j=F[w[z]-1]++<<$,V=j|(1<<$)-1;j<=V;++j)q[f[j]>>>N]=L}return q},p=new e(288);for(d=0;d<144;++d)p[d]=8;for(d=144;d<256;++d)p[d]=9;for(d=256;d<280;++d)p[d]=7;for(d=280;d<288;++d)p[d]=8;var g=new e(32);for(d=0;d<32;++d)g[d]=5;var v=A(p,9),E=A(g,5),C=function(w){for(var R=w[0],D=1;D<w.length;++D)w[D]>R&&(R=w[D]);return R},I=function(w,R,D){var G=R/8|0;return(w[G]|w[G+1]<<8)>>(7&R)&D},_=function(w,R){var D=R/8|0;return(w[D]|w[D+1]<<8|w[D+2]<<16)>>(7&R)},x=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],S=function(w,R,D){var G=new Error(R||x[w]);if(G.code=w,Error.captureStackTrace&&Error.captureStackTrace(G,S),!D)throw G;return G},b=function(w,R,D){var G=w.length;if(!G||D&&!D.l&&G<5)return R||new e(0);var z=!R||D,W=!D||D.i;D||(D={}),R||(R=new e(3*G));var q,F=function(Je){var re=R.length;if(Je>re){var Re=new e(Math.max(2*re,Je));Re.set(R),R=Re}},N=D.f||0,L=D.p||0,$=D.b||0,j=D.l,V=D.d,k=D.m,Q=D.n,O=8*G;do{if(!j){D.f=N=I(w,L,1);var U=I(w,L+1,3);if(L+=3,!U){var te=w[(J=((q=L)/8|0)+(7&q&&1)+4)-4]|w[J-3]<<8,le=J+te;if(le>G){W&&S(0);break}z&&F($+te),R.set(w.subarray(J,le),$),D.b=$+=te,D.p=L=8*le;continue}if(U==1)j=v,V=E,k=9,Q=5;else if(U==2){var ee=I(w,L,31)+257,se=I(w,L+10,15)+4,Ee=ee+I(w,L+5,31)+1;L+=14;for(var Ie=new e(Ee),oe=new e(19),ce=0;ce<se;++ce)oe[o[ce]]=I(w,L+3*ce,7);L+=3*se;var Ae=C(oe),he=(1<<Ae)-1,Z=A(oe,Ae);for(ce=0;ce<Ee;){var J,ue=Z[I(w,L,he)];if(L+=15&ue,(J=ue>>>4)<16)Ie[ce++]=J;else{var Te=0,we=0;for(J==16?(we=3+I(w,L,3),L+=2,Te=Ie[ce-1]):J==17?(we=3+I(w,L,7),L+=3):J==18&&(we=11+I(w,L,127),L+=7);we--;)Ie[ce++]=Te}}var Le=Ie.subarray(0,ee),Be=Ie.subarray(ee);k=C(Le),Q=C(Be),j=A(Le,k),V=A(Be,Q)}else S(1);if(L>O){W&&S(0);break}}z&&F($+131072);for(var qe=(1<<k)-1,Oe=(1<<Q)-1,Ke=L;;Ke=L){var $e=(Te=j[_(w,L)&qe])>>>4;if((L+=15&Te)>O){W&&S(0);break}if(Te||S(2),$e<256)R[$++]=$e;else{if($e==256){Ke=L,j=null;break}var Ze=$e-254;if($e>264){var ut=n[ce=$e-257];Ze=I(w,L,(1<<ut)-1)+c[ce],L+=ut}var Ct=V[_(w,L)&Oe],lt=Ct>>>4;if(Ct||S(3),L+=15&Ct,Be=h[lt],lt>3&&(ut=s[lt],Be+=_(w,L)&(1<<ut)-1,L+=ut),L>O){W&&S(0);break}z&&F($+131072);for(var tt=$+Ze;$<tt;$+=4)R[$]=R[$-Be],R[$+1]=R[$+1-Be],R[$+2]=R[$+2-Be],R[$+3]=R[$+3-Be];$=tt}}D.l=j,D.p=Ke,D.b=$,j&&(N=1,D.m=k,D.d=V,D.n=Q)}while(!N);return $==R.length?R:function(Je,re,Re){(Re==null||Re>Je.length)&&(Re=Je.length);var Ue=new(Je instanceof t?t:Je instanceof i?i:e)(Re-re);return Ue.set(Je.subarray(re,Re)),Ue}(R,0,$)},T=new e(0),B=typeof TextDecoder<"u"&&new TextDecoder;try{B.decode(T,{stream:!0})}catch{}return r.convert_streams=function(w){var R=new DataView(w),D=0;function G(){var ee=R.getUint16(D);return D+=2,ee}function z(){var ee=R.getUint32(D);return D+=4,ee}function W(ee){te.setUint16(le,ee),le+=2}function q(ee){te.setUint32(le,ee),le+=4}for(var F={signature:z(),flavor:z(),length:z(),numTables:G(),reserved:G(),totalSfntSize:z(),majorVersion:G(),minorVersion:G(),metaOffset:z(),metaLength:z(),metaOrigLength:z(),privOffset:z(),privLength:z()},N=0;Math.pow(2,N)<=F.numTables;)N++;N--;for(var L=16*Math.pow(2,N),$=16*F.numTables-L,j=12,V=[],k=0;k<F.numTables;k++)V.push({tag:z(),offset:z(),compLength:z(),origLength:z(),origChecksum:z()}),j+=16;var Q,O=new Uint8Array(12+16*V.length+V.reduce(function(ee,se){return ee+se.origLength+4},0)),U=O.buffer,te=new DataView(U),le=0;return q(F.flavor),W(F.numTables),W(L),W(N),W($),V.forEach(function(ee){q(ee.tag),q(ee.origChecksum),q(j),q(ee.origLength),ee.outOffset=j,(j+=ee.origLength)%4!=0&&(j+=4-j%4)}),V.forEach(function(ee){var se,Ee=w.slice(ee.offset,ee.offset+ee.compLength);if(ee.compLength!=ee.origLength){var Ie=new Uint8Array(ee.origLength);se=new Uint8Array(Ee,2),b(se,Ie)}else Ie=new Uint8Array(Ee);O.set(Ie,ee.outOffset);var oe=0;(j=ee.outOffset+ee.origLength)%4!=0&&(oe=4-j%4),O.set(new Uint8Array(oe).buffer,ee.outOffset+ee.origLength),Q=j+oe}),U.slice(0,Q)},Object.defineProperty(r,"__esModule",{value:!0}),r}({}).convert_streams}function Kb(r,e){const t={M:2,L:2,Q:4,C:6,Z:0},i={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},n=1,s=2,o=4,a=8,l=16,c=32;let u;function h(x){if(!u){const S={R:s,L:n,D:o,C:l,U:c,T:a};u=new Map;for(let b in i){let T=0;i[b].split(",").forEach(B=>{let[w,R]=B.split("+");w=parseInt(w,36),R=R?parseInt(R,36):0,u.set(T+=w,S[b]);for(let D=R;D--;)u.set(++T,S[b])})}}return u.get(x)||c}const f=1,d=2,m=3,A=4,p=[null,"isol","init","fina","medi"];function g(x){const S=new Uint8Array(x.length);let b=c,T=f,B=-1;for(let w=0;w<x.length;w++){const R=x.codePointAt(w);let D=h(R)|0,G=f;D&a||(b&(n|o|l)?D&(s|o|l)?(G=m,(T===f||T===m)&&S[B]++):D&(n|c)&&(T===d||T===A)&&S[B]--:b&(s|c)&&(T===d||T===A)&&S[B]--,T=S[w]=G,b=D,B=w,R>65535&&w++)}return S}function v(x,S){const b=[];for(let B=0;B<S.length;B++){const w=S.codePointAt(B);w>65535&&B++,b.push(r.U.codeToGlyph(x,w))}const T=x.GSUB;if(T){const{lookupList:B,featureList:w}=T;let R;const D=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,G=[];w.forEach(z=>{if(D.test(z.tag))for(let W=0;W<z.tab.length;W++){if(G[z.tab[W]])continue;G[z.tab[W]]=!0;const q=B[z.tab[W]],F=/^(isol|init|fina|medi)$/.test(z.tag);F&&!R&&(R=g(S));for(let N=0;N<b.length;N++)(!R||!F||p[R[N]]===z.tag)&&r.U._applySubs(b,N,q,B)}})}return b}function E(x,S){const b=new Int16Array(S.length*3);let T=0;for(;T<S.length;T++){const D=S[T];if(D===-1)continue;b[T*3+2]=x.hmtx.aWidth[D];const G=x.GPOS;if(G){const z=G.lookupList;for(let W=0;W<z.length;W++){const q=z[W];for(let F=0;F<q.tabs.length;F++){const N=q.tabs[F];if(q.ltype===1){if(r._lctf.coverageIndex(N.coverage,D)!==-1&&N.pos){R(N.pos,T);break}}else if(q.ltype===2){let L=null,$=B();if($!==-1){const j=r._lctf.coverageIndex(N.coverage,S[$]);if(j!==-1){if(N.fmt===1){const V=N.pairsets[j];for(let k=0;k<V.length;k++)V[k].gid2===D&&(L=V[k])}else if(N.fmt===2){const V=r.U._getGlyphClass(S[$],N.classDef1),k=r.U._getGlyphClass(D,N.classDef2);L=N.matrix[V][k]}if(L){L.val1&&R(L.val1,$),L.val2&&R(L.val2,T);break}}}}else if(q.ltype===4){const L=r._lctf.coverageIndex(N.markCoverage,D);if(L!==-1){const $=B(w),j=$===-1?-1:r._lctf.coverageIndex(N.baseCoverage,S[$]);if(j!==-1){const V=N.markArray[L],k=N.baseArray[j][V.markClass];b[T*3]=k.x-V.x+b[$*3]-b[$*3+2],b[T*3+1]=k.y-V.y+b[$*3+1];break}}}else if(q.ltype===6){const L=r._lctf.coverageIndex(N.mark1Coverage,D);if(L!==-1){const $=B();if($!==-1){const j=S[$];if(C(x,j)===3){const V=r._lctf.coverageIndex(N.mark2Coverage,j);if(V!==-1){const k=N.mark1Array[L],Q=N.mark2Array[V][k.markClass];b[T*3]=Q.x-k.x+b[$*3]-b[$*3+2],b[T*3+1]=Q.y-k.y+b[$*3+1];break}}}}}}}}else if(x.kern&&!x.cff){const z=B();if(z!==-1){const W=x.kern.glyph1.indexOf(S[z]);if(W!==-1){const q=x.kern.rval[W].glyph2.indexOf(D);q!==-1&&(b[z*3+2]+=x.kern.rval[W].vals[q])}}}}return b;function B(D){for(let G=T-1;G>=0;G--)if(S[G]!==-1&&(!D||D(S[G])))return G;return-1}function w(D){return C(x,D)===1}function R(D,G){for(let z=0;z<3;z++)b[G*3+z]+=D[z]||0}}function C(x,S){const b=x.GDEF&&x.GDEF.glyphClassDef;return b?r.U._getGlyphClass(S,b):0}function I(...x){for(let S=0;S<x.length;S++)if(typeof x[S]=="number")return x[S]}function _(x){const S=Object.create(null),b=x["OS/2"],T=x.hhea,B=x.head.unitsPerEm,w=I(b&&b.sTypoAscender,T&&T.ascender,B),R={unitsPerEm:B,ascender:w,descender:I(b&&b.sTypoDescender,T&&T.descender,0),capHeight:I(b&&b.sCapHeight,w),xHeight:I(b&&b.sxHeight,w),lineGap:I(b&&b.sTypoLineGap,T&&T.lineGap),supportsCodePoint(D){return r.U.codeToGlyph(x,D)>0},forEachGlyph(D,G,z,W){let q=0;const F=1/R.unitsPerEm*G,N=v(x,D);let L=0;const $=E(x,N);return N.forEach((j,V)=>{if(j!==-1){let k=S[j];if(!k){const{cmds:Q,crds:O}=r.U.glyphToPath(x,j);let U="",te=0;for(let Ie=0,oe=Q.length;Ie<oe;Ie++){const ce=t[Q[Ie]];U+=Q[Ie];for(let Ae=1;Ae<=ce;Ae++)U+=(Ae>1?",":"")+O[te++]}let le,ee,se,Ee;if(O.length){le=ee=1/0,se=Ee=-1/0;for(let Ie=0,oe=O.length;Ie<oe;Ie+=2){let ce=O[Ie],Ae=O[Ie+1];ce<le&&(le=ce),Ae<ee&&(ee=Ae),ce>se&&(se=ce),Ae>Ee&&(Ee=Ae)}}else le=se=ee=Ee=0;k=S[j]={index:j,advanceWidth:x.hmtx.aWidth[j],xMin:le,yMin:ee,xMax:se,yMax:Ee,path:U}}W.call(null,k,q+$[V*3]*F,$[V*3+1]*F,L),q+=$[V*3+2]*F,z&&(q+=z*G)}L+=D.codePointAt(L)>65535?2:1}),q}};return R}return function(S){const b=new Uint8Array(S,0,4),T=r._bin.readASCII(b,0,4);if(T==="wOFF")S=e(S);else if(T==="wOF2")throw new Error("woff2 fonts not supported");return _(r.parse(S)[0])}}const $b=_a({name:"Typr Font Parser",dependencies:[Hb,Vb,Kb],init(r,e,t){const i=r(),n=e();return t(i,n)}});/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/function jb(){return function(r){var e=function(){this.buckets=new Map};e.prototype.add=function(E){var C=E>>5;this.buckets.set(C,(this.buckets.get(C)||0)|1<<(31&E))},e.prototype.has=function(E){var C=this.buckets.get(E>>5);return C!==void 0&&(C&1<<(31&E))!=0},e.prototype.serialize=function(){var E=[];return this.buckets.forEach(function(C,I){E.push((+I).toString(36)+":"+C.toString(36))}),E.join(",")},e.prototype.deserialize=function(E){var C=this;this.buckets.clear(),E.split(",").forEach(function(I){var _=I.split(":");C.buckets.set(parseInt(_[0],36),parseInt(_[1],36))})};var t=Math.pow(2,8),i=t-1,n=~i;function s(E){var C=function(_){return _&n}(E).toString(16),I=function(_){return(_&n)+t-1}(E).toString(16);return"codepoint-index/plane"+(E>>16)+"/"+C+"-"+I+".json"}function o(E,C){var I=E&i,_=C.codePointAt(I/6|0);return((_=(_||48)-48)&1<<I%6)!=0}function a(E,C){var I;(I=E,I.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map(function(_){return _.split("-").map(function(x){return parseInt(x.trim(),16)})})).forEach(function(_){var x=_[0],S=_[1];S===void 0&&(S=x),C(x,S)})}function l(E,C){a(E,function(I,_){for(var x=I;x<=_;x++)C(x)})}var c={},u={},h=new WeakMap,f="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(E){var C=h.get(E);return C||(C=new e,l(E.ranges,function(I){return C.add(I)}),h.set(E,C)),C}var m,A=new Map;function p(E,C,I){return E[C]?C:E[I]?I:function(_){for(var x in _)return x}(E)}function g(E,C){var I=C;if(!E.includes(I)){I=1/0;for(var _=0;_<E.length;_++)Math.abs(E[_]-C)<Math.abs(I-C)&&(I=E[_])}return I}function v(E){return m||(m=new Set,l("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",function(C){m.add(C)})),m.has(E)}return r.CodePointSet=e,r.clearCache=function(){c={},u={}},r.getFontsForString=function(E,C){C===void 0&&(C={});var I,_=C.lang;_===void 0&&(_=/\p{Script=Hangul}/u.test(I=E)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(I)?"ja":"en");var x=C.category;x===void 0&&(x="sans-serif");var S=C.style;S===void 0&&(S="normal");var b=C.weight;b===void 0&&(b=400);var T=(C.dataUrl||f).replace(/\/$/g,""),B=new Map,w=new Uint8Array(E.length),R={},D={},G=new Array(E.length),z=new Map,W=!1;function q(L){var $=A.get(L);return $||($=fetch(T+"/"+L).then(function(j){if(!j.ok)throw new Error(j.statusText);return j.json().then(function(V){if(!Array.isArray(V)||V[0]!==1)throw new Error("Incorrect schema version; need 1, got "+V[0]);return V[1]})}).catch(function(j){if(T!==f)return W||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+T+'", trying default CDN. '+j.message),W=!0),T=f,A.delete(L),q(L);throw j}),A.set(L,$)),$}for(var F=function(L){var $=E.codePointAt(L),j=s($);G[L]=j,c[j]||z.has(j)||z.set(j,q(j).then(function(V){c[j]=V})),$>65535&&(L++,N=L)},N=0;N<E.length;N++)F(N);return Promise.all(z.values()).then(function(){z.clear();for(var L=function(j){var V=E.codePointAt(j),k=null,Q=c[G[j]],O=void 0;for(var U in Q){var te=D[U];if(te===void 0&&(te=D[U]=new RegExp(U).test(_||"en")),te){for(var le in O=U,Q[U])if(o(V,Q[U][le])){k=le;break}break}}if(!k){e:for(var ee in Q)if(ee!==O){for(var se in Q[ee])if(o(V,Q[ee][se])){k=se;break e}}}k||(console.debug("No font coverage for U+"+V.toString(16)),k="latin"),G[j]=k,u[k]||z.has(k)||z.set(k,q("font-meta/"+k+".json").then(function(Ee){u[k]=Ee})),V>65535&&(j++,$=j)},$=0;$<E.length;$++)L($);return Promise.all(z.values())}).then(function(){for(var L,$=null,j=0;j<E.length;j++){var V=E.codePointAt(j);if($&&(v(V)||d($).has(V)))w[j]=w[j-1];else{$=u[G[j]];var k=R[$.id];if(!k){var Q=$.typeforms,O=p(Q,x,"sans-serif"),U=p(Q[O],S,"normal"),te=g((L=Q[O])===null||L===void 0?void 0:L[U],b);k=R[$.id]=T+"/font-files/"+$.id+"/"+O+"."+U+"."+te+".woff"}var le=B.get(k);le==null&&(le=B.size,B.set(k,le)),w[j]=le}V>65535&&(j++,w[j]=w[j-1])}return{fontUrls:Array.from(B.keys()),chars:w}})},Object.defineProperty(r,"__esModule",{value:!0}),r}({})}function Yb(r,e){const t=Object.create(null),i=Object.create(null);function n(o,a){const l=c=>{console.error(`Failure loading font ${o}`,c)};try{const c=new XMLHttpRequest;c.open("get",o,!0),c.responseType="arraybuffer",c.onload=function(){if(c.status>=400)l(new Error(c.statusText));else if(c.status>0)try{const u=r(c.response);u.src=o,a(u)}catch(u){l(u)}},c.onerror=l,c.send()}catch(c){l(c)}}function s(o,a){let l=t[o];l?a(l):i[o]?i[o].push(a):(i[o]=[a],n(o,c=>{c.src=o,t[o]=c,i[o].forEach(u=>u(c)),delete i[o]}))}return function(o,a,{lang:l,fonts:c=[],style:u="normal",weight:h="normal",unicodeFontsURL:f}={}){const d=new Uint8Array(o.length),m=[];o.length||v();const A=new Map,p=[];if(u!=="italic"&&(u="normal"),typeof h!="number"&&(h=h==="bold"?700:400),c&&!Array.isArray(c)&&(c=[c]),c=c.slice().filter(C=>!C.lang||C.lang.test(l)).reverse(),c.length){let x=0;(function S(b=0){for(let T=b,B=o.length;T<B;T++){const w=o.codePointAt(T);if(x===1&&m[d[T-1]].supportsCodePoint(w)||T>0&&/\s/.test(o[T]))d[T]=d[T-1],x===2&&(p[p.length-1][1]=T);else for(let R=d[T],D=c.length;R<=D;R++)if(R===D){const G=x===2?p[p.length-1]:p[p.length]=[T,T];G[1]=T,x=2}else{d[T]=R;const{src:G,unicodeRange:z}=c[R];if(!z||E(w,z)){const W=t[G];if(!W){s(G,()=>{S(T)});return}if(W.supportsCodePoint(w)){let q=A.get(W);typeof q!="number"&&(q=m.length,m.push(W),A.set(W,q)),d[T]=q,x=1;break}}}w>65535&&T+1<B&&(d[T+1]=d[T],T++,x===2&&(p[p.length-1][1]=T))}g()})()}else p.push([0,o.length-1]),g();function g(){if(p.length){const C=p.map(I=>o.substring(I[0],I[1]+1)).join(`
`);e.getFontsForString(C,{lang:l||void 0,style:u,weight:h,dataUrl:f}).then(({fontUrls:I,chars:_})=>{const x=m.length;let S=0;p.forEach(T=>{for(let B=0,w=T[1]-T[0];B<=w;B++)d[T[0]+B]=_[S++]+x;S++});let b=0;I.forEach((T,B)=>{s(T,w=>{m[B+x]=w,++b===I.length&&v()})})})}else v()}function v(){a({chars:d,fonts:m})}function E(C,I){for(let _=0;_<I.length;_++){const[x,S=x]=I[_];if(x<=C&&C<=S)return!0}return!1}}}const Wb=_a({name:"FontResolver",dependencies:[Yb,$b,jb],init(r,e,t){return r(e,t())}});function qb(r,e){const i=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,n="[^\\S\\u00A0]",s=new RegExp(`${n}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function o({text:m,lang:A,fonts:p,style:g,weight:v,preResolvedFonts:E,unicodeFontsURL:C},I){const _=({chars:x,fonts:S})=>{let b,T;const B=[];for(let w=0;w<x.length;w++)x[w]!==T?(T=x[w],B.push(b={start:w,end:w,fontObj:S[x[w]]})):b.end=w;I(B)};E?_(E):r(m,_,{lang:A,fonts:p,style:g,weight:v,unicodeFontsURL:C})}function a({text:m="",font:A,lang:p,sdfGlyphSize:g=64,fontSize:v=400,fontWeight:E=1,fontStyle:C="normal",letterSpacing:I=0,lineHeight:_="normal",maxWidth:x=1/0,direction:S,textAlign:b="left",textIndent:T=0,whiteSpace:B="normal",overflowWrap:w="normal",anchorX:R=0,anchorY:D=0,metricsOnly:G=!1,unicodeFontsURL:z,preResolvedFonts:W=null,includeCaretPositions:q=!1,chunkedBoundsSize:F=8192,colorRanges:N=null},L){const $=h(),j={fontLoad:0,typesetting:0};m.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),m=m.replace(/\r\n/g,`
`).replace(/\r/g,`
`)),v=+v,I=+I,x=+x,_=_||"normal",T=+T,o({text:m,lang:p,style:C,weight:E,fonts:typeof A=="string"?[{src:A}]:A,unicodeFontsURL:z,preResolvedFonts:W},V=>{j.fontLoad=h()-$;const k=isFinite(x);let Q=null,O=null,U=null,te=null,le=null,ee=null,se=null,Ee=null,Ie=0,oe=0,ce=B!=="nowrap";const Ae=new Map,he=h();let Z=T,J=0,ue=new f;const Te=[ue];V.forEach(Oe=>{const{fontObj:Ke}=Oe,{ascender:$e,descender:Ze,unitsPerEm:ut,lineGap:Ct,capHeight:lt,xHeight:tt}=Ke;let Je=Ae.get(Ke);if(!Je){const ve=v/ut,ft=_==="normal"?($e-Ze+Ct)*ve:_*v,ii=(ft-($e-Ze)*ve)/2,kt=Math.min(ft,($e-Ze)*ve),It=($e+Ze)/2*ve+kt/2;Je={index:Ae.size,src:Ke.src,fontObj:Ke,fontSizeMult:ve,unitsPerEm:ut,ascender:$e*ve,descender:Ze*ve,capHeight:lt*ve,xHeight:tt*ve,lineHeight:ft,baseline:-ii-$e*ve,caretTop:It,caretBottom:It-kt},Ae.set(Ke,Je)}const{fontSizeMult:re}=Je,Re=m.slice(Oe.start,Oe.end+1);let Ue,Xe;Ke.forEachGlyph(Re,v,I,(ve,ft,ii,kt)=>{ft+=J,kt+=Oe.start,Ue=ft,Xe=ve;const It=m.charAt(kt),Pt=ve.advanceWidth*re,ie=ue.count;let P;if("isEmpty"in ve||(ve.isWhitespace=!!It&&new RegExp(n).test(It),ve.canBreakAfter=!!It&&s.test(It),ve.isEmpty=ve.xMin===ve.xMax||ve.yMin===ve.yMax||i.test(It)),!ve.isWhitespace&&!ve.isEmpty&&oe++,ce&&k&&!ve.isWhitespace&&ft+Pt+Z>x&&ie){if(ue.glyphAt(ie-1).glyphObj.canBreakAfter)P=new f,Z=-ft;else for(let ae=ie;ae--;)if(ae===0&&w==="break-word"){P=new f,Z=-ft;break}else if(ue.glyphAt(ae).glyphObj.canBreakAfter){P=ue.splitAt(ae+1);const ke=P.glyphAt(0).x;Z-=ke;for(let at=P.count;at--;)P.glyphAt(at).x-=ke;break}P&&(ue.isSoftWrapped=!0,ue=P,Te.push(ue),Ie=x)}let Y=ue.glyphAt(ue.count);Y.glyphObj=ve,Y.x=ft+Z,Y.y=ii,Y.width=Pt,Y.charIndex=kt,Y.fontData=Je,It===`
`&&(ue=new f,Te.push(ue),Z=-(ft+Pt+I*v)+T)}),J=Ue+Xe.advanceWidth*re+I*v});let we=0;Te.forEach(Oe=>{let Ke=!0;for(let $e=Oe.count;$e--;){const Ze=Oe.glyphAt($e);Ke&&!Ze.glyphObj.isWhitespace&&(Oe.width=Ze.x+Ze.width,Oe.width>Ie&&(Ie=Oe.width),Ke=!1);let{lineHeight:ut,capHeight:Ct,xHeight:lt,baseline:tt}=Ze.fontData;ut>Oe.lineHeight&&(Oe.lineHeight=ut);const Je=tt-Oe.baseline;Je<0&&(Oe.baseline+=Je,Oe.cap+=Je,Oe.ex+=Je),Oe.cap=Math.max(Oe.cap,Oe.baseline+Ct),Oe.ex=Math.max(Oe.ex,Oe.baseline+lt)}Oe.baseline-=we,Oe.cap-=we,Oe.ex-=we,we+=Oe.lineHeight});let Le=0,Be=0;if(R&&(typeof R=="number"?Le=-R:typeof R=="string"&&(Le=-Ie*(R==="left"?0:R==="center"?.5:R==="right"?1:c(R)))),D&&(typeof D=="number"?Be=-D:typeof D=="string"&&(Be=D==="top"?0:D==="top-baseline"?-Te[0].baseline:D==="top-cap"?-Te[0].cap:D==="top-ex"?-Te[0].ex:D==="middle"?we/2:D==="bottom"?we:D==="bottom-baseline"?-Te[Te.length-1].baseline:c(D)*we)),!G){const Oe=e.getEmbeddingLevels(m,S);Q=new Uint16Array(oe),O=new Uint8Array(oe),U=new Float32Array(oe*2),te={},se=[1/0,1/0,-1/0,-1/0],Ee=[],q&&(ee=new Float32Array(m.length*4)),N&&(le=new Uint8Array(oe*3));let Ke=0,$e=-1,Ze=-1,ut,Ct;if(Te.forEach((lt,tt)=>{let{count:Je,width:re}=lt;if(Je>0){let Re=0;for(let kt=Je;kt--&&lt.glyphAt(kt).glyphObj.isWhitespace;)Re++;let Ue=0,Xe=0;if(b==="center")Ue=(Ie-re)/2;else if(b==="right")Ue=Ie-re;else if(b==="justify"&&lt.isSoftWrapped){let kt=0;for(let It=Je-Re;It--;)lt.glyphAt(It).glyphObj.isWhitespace&&kt++;Xe=(Ie-re)/kt}if(Xe||Ue){let kt=0;for(let It=0;It<Je;It++){let Pt=lt.glyphAt(It);const ie=Pt.glyphObj;Pt.x+=Ue+kt,Xe!==0&&ie.isWhitespace&&It<Je-Re&&(kt+=Xe,Pt.width+=Xe)}}const ve=e.getReorderSegments(m,Oe,lt.glyphAt(0).charIndex,lt.glyphAt(lt.count-1).charIndex);for(let kt=0;kt<ve.length;kt++){const[It,Pt]=ve[kt];let ie=1/0,P=-1/0;for(let Y=0;Y<Je;Y++)if(lt.glyphAt(Y).charIndex>=It){let ae=Y,ke=Y;for(;ke<Je;ke++){let at=lt.glyphAt(ke);if(at.charIndex>Pt)break;ke<Je-Re&&(ie=Math.min(ie,at.x),P=Math.max(P,at.x+at.width))}for(let at=ae;at<ke;at++){const bt=lt.glyphAt(at);bt.x=P-(bt.x+bt.width-ie)}break}}let ft;const ii=kt=>ft=kt;for(let kt=0;kt<Je;kt++){const It=lt.glyphAt(kt);ft=It.glyphObj;const Pt=ft.index,ie=Oe.levels[It.charIndex]&1;if(ie){const P=e.getMirroredCharacter(m[It.charIndex]);P&&It.fontData.fontObj.forEachGlyph(P,0,0,ii)}if(q){const{charIndex:P,fontData:Y}=It,ae=It.x+Le,ke=It.x+It.width+Le;ee[P*4]=ie?ke:ae,ee[P*4+1]=ie?ae:ke,ee[P*4+2]=lt.baseline+Y.caretBottom+Be,ee[P*4+3]=lt.baseline+Y.caretTop+Be;const at=P-$e;at>1&&u(ee,$e,at),$e=P}if(N){const{charIndex:P}=It;for(;P>Ze;)Ze++,N.hasOwnProperty(Ze)&&(Ct=N[Ze])}if(!ft.isWhitespace&&!ft.isEmpty){const P=Ke++,{fontSizeMult:Y,src:ae,index:ke}=It.fontData,at=te[ae]||(te[ae]={});at[Pt]||(at[Pt]={path:ft.path,pathBounds:[ft.xMin,ft.yMin,ft.xMax,ft.yMax]});const bt=It.x+Le,Yt=It.y+lt.baseline+Be;U[P*2]=bt,U[P*2+1]=Yt;const Pi=bt+ft.xMin*Y,Bi=Yt+ft.yMin*Y,Ft=bt+ft.xMax*Y,At=Yt+ft.yMax*Y;Pi<se[0]&&(se[0]=Pi),Bi<se[1]&&(se[1]=Bi),Ft>se[2]&&(se[2]=Ft),At>se[3]&&(se[3]=At),P%F===0&&(ut={start:P,end:P,rect:[1/0,1/0,-1/0,-1/0]},Ee.push(ut)),ut.end++;const ni=ut.rect;if(Pi<ni[0]&&(ni[0]=Pi),Bi<ni[1]&&(ni[1]=Bi),Ft>ni[2]&&(ni[2]=Ft),At>ni[3]&&(ni[3]=At),Q[P]=Pt,O[P]=ke,N){const fn=P*3;le[fn]=Ct>>16&255,le[fn+1]=Ct>>8&255,le[fn+2]=Ct&255}}}}}),ee){const lt=m.length-$e;lt>1&&u(ee,$e,lt)}}const qe=[];Ae.forEach(({index:Oe,src:Ke,unitsPerEm:$e,ascender:Ze,descender:ut,lineHeight:Ct,capHeight:lt,xHeight:tt})=>{qe[Oe]={src:Ke,unitsPerEm:$e,ascender:Ze,descender:ut,lineHeight:Ct,capHeight:lt,xHeight:tt}}),j.typesetting=h()-he,L({glyphIds:Q,glyphFontIndices:O,glyphPositions:U,glyphData:te,fontData:qe,caretPositions:ee,glyphColors:le,chunkedBounds:Ee,fontSize:v,topBaseline:Be+Te[0].baseline,blockBounds:[Le,Be-we,Le+Ie,Be],visibleBounds:se,timings:j})})}function l(m,A){a({...m,metricsOnly:!0},p=>{const[g,v,E,C]=p.blockBounds;A({width:E-g,height:C-v})})}function c(m){let A=m.match(/^([\d.]+)%$/),p=A?parseFloat(A[1]):NaN;return isNaN(p)?0:p/100}function u(m,A,p){const g=m[A*4],v=m[A*4+1],E=m[A*4+2],C=m[A*4+3],I=(v-g)/p;for(let _=0;_<p;_++){const x=(A+_)*4;m[x]=g+I*_,m[x+1]=g+I*(_+1),m[x+2]=E,m[x+3]=C}}function h(){return(self.performance||Date).now()}function f(){this.data=[]}const d=["glyphObj","x","y","width","charIndex","fontData"];return f.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/d.length)},glyphAt(m){let A=f.flyweight;return A.data=this.data,A.index=m,A},splitAt(m){let A=new f;return A.data=this.data.splice(m*d.length),A}},f.flyweight=d.reduce((m,A,p,g)=>(Object.defineProperty(m,A,{get(){return this.data[this.index*d.length+p]},set(v){this.data[this.index*d.length+p]=v}}),m),{data:null,index:0}),{typeset:a,measure:l}}const ro=()=>(self.performance||Date).now(),Vh=N3();let d1;function Xb(r,e,t,i,n,s,o,a,l,c,u=!0){return u?Zb(r,e,t,i,n,s,o,a,l,c).then(null,h=>(d1||(console.warn("WebGL SDF generation failed, falling back to JS",h),d1=!0),A1(r,e,t,i,n,s,o,a,l,c))):A1(r,e,t,i,n,s,o,a,l,c)}const Hu=[],Jb=5;let tm=0;function Q3(){const r=ro();for(;Hu.length&&ro()-r<Jb;)Hu.shift()();tm=Hu.length?setTimeout(Q3,0):0}const Zb=(...r)=>new Promise((e,t)=>{Hu.push(()=>{const i=ro();try{Vh.webgl.generateIntoCanvas(...r),e({timing:ro()-i})}catch(n){t(n)}}),tm||(tm=setTimeout(Q3,0))}),ew=4,tw=2e3,m1={};let iw=0;function A1(r,e,t,i,n,s,o,a,l,c){const u="TroikaTextSDFGenerator_JS_"+iw++%ew;let h=m1[u];return h||(h=m1[u]={workerModule:_a({name:u,workerId:u,dependencies:[N3,ro],init(f,d){const m=f().javascript.generate;return function(...A){const p=d();return{textureData:m(...A),timing:d()-p}}},getTransferables(f){return[f.textureData.buffer]}}),requests:0,idleTimer:null}),h.requests++,clearTimeout(h.idleTimer),h.workerModule(r,e,t,i,n,s).then(({textureData:f,timing:d})=>{const m=ro(),A=new Uint8Array(f.length*4);for(let p=0;p<f.length;p++)A[p*4+c]=f[p];return Vh.webglUtils.renderImageData(o,A,a,l,r,e,1<<3-c),d+=ro()-m,--h.requests===0&&(h.idleTimer=setTimeout(()=>{Lb(u)},tw)),{timing:d}})}function nw(r){r._warm||(Vh.webgl.isSupported(r),r._warm=!0)}const sw=Vh.webglUtils.resizeWebGLCanvasWithoutClearing,Tl={unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},rw=new et;function Eo(){return(self.performance||Date).now()}const p1=Object.create(null);function z3(r,e){r=lw({},r);const t=Eo(),i=[];if(r.font&&i.push({label:"user",src:cw(r.font)}),r.font=i,r.text=""+r.text,r.sdfGlyphSize=r.sdfGlyphSize||Tl.sdfGlyphSize,r.unicodeFontsURL=r.unicodeFontsURL||Tl.unicodeFontsURL,r.colorRanges!=null){let f={};for(let d in r.colorRanges)if(r.colorRanges.hasOwnProperty(d)){let m=r.colorRanges[d];typeof m!="number"&&(m=rw.set(m).getHex()),f[d]=m}r.colorRanges=f}Object.freeze(r);const{textureWidth:n,sdfExponent:s}=Tl,{sdfGlyphSize:o}=r,a=n/o*4;let l=p1[o];if(!l){const f=document.createElement("canvas");f.width=n,f.height=o*256/a,l=p1[o]={glyphCount:0,sdfGlyphSize:o,sdfCanvas:f,sdfTexture:new tn(f,void 0,void 0,void 0,jt,jt),contextLost:!1,glyphsByFont:new Map},l.sdfTexture.generateMipmaps=!1,ow(l)}const{sdfTexture:c,sdfCanvas:u}=l;K3(r).then(f=>{const{glyphIds:d,glyphFontIndices:m,fontData:A,glyphPositions:p,fontSize:g,timings:v}=f,E=[],C=new Float32Array(d.length*4);let I=0,_=0;const x=Eo(),S=A.map(R=>{let D=l.glyphsByFont.get(R.src);return D||l.glyphsByFont.set(R.src,D=new Map),D});d.forEach((R,D)=>{const G=m[D],{src:z,unitsPerEm:W}=A[G];let q=S[G].get(R);if(!q){const{path:j,pathBounds:V}=f.glyphData[z][R],k=Math.max(V[2]-V[0],V[3]-V[1])/o*(Tl.sdfMargin*o+.5),Q=l.glyphCount++,O=[V[0]-k,V[1]-k,V[2]+k,V[3]+k];S[G].set(R,q={path:j,atlasIndex:Q,sdfViewBox:O}),E.push(q)}const{sdfViewBox:F}=q,N=p[_++],L=p[_++],$=g/W;C[I++]=N+F[0]*$,C[I++]=L+F[1]*$,C[I++]=N+F[2]*$,C[I++]=L+F[3]*$,d[D]=q.atlasIndex}),v.quads=(v.quads||0)+(Eo()-x);const b=Eo();v.sdf={};const T=u.height,B=Math.ceil(l.glyphCount/a),w=Math.pow(2,Math.ceil(Math.log2(B*o)));w>T&&(console.info(`Increasing SDF texture size ${T}->${w}`),sw(u,n,w),c.dispose()),Promise.all(E.map(R=>H3(R,l,r.gpuAccelerateSDF).then(({timing:D})=>{v.sdf[R.atlasIndex]=D}))).then(()=>{E.length&&!l.contextLost&&(V3(l),c.needsUpdate=!0),v.sdfTotal=Eo()-b,v.total=Eo()-t,e(Object.freeze({parameters:r,sdfTexture:c,sdfGlyphSize:o,sdfExponent:s,glyphBounds:C,glyphAtlasIndices:d,glyphColors:f.glyphColors,caretPositions:f.caretPositions,chunkedBounds:f.chunkedBounds,ascender:f.ascender,descender:f.descender,lineHeight:f.lineHeight,capHeight:f.capHeight,xHeight:f.xHeight,topBaseline:f.topBaseline,blockBounds:f.blockBounds,visibleBounds:f.visibleBounds,timings:f.timings}))})}),Promise.resolve().then(()=>{l.contextLost||nw(u)})}function H3({path:r,atlasIndex:e,sdfViewBox:t},{sdfGlyphSize:i,sdfCanvas:n,contextLost:s},o){if(s)return Promise.resolve({timing:-1});const{textureWidth:a,sdfExponent:l}=Tl,c=Math.max(t[2]-t[0],t[3]-t[1]),u=Math.floor(e/4),h=u%(a/i)*i,f=Math.floor(u/(a/i))*i,d=e%4;return Xb(i,i,r,t,c,l,n,h,f,d,o)}function ow(r){const e=r.sdfCanvas;e.addEventListener("webglcontextlost",t=>{console.log("Context Lost",t),t.preventDefault(),r.contextLost=!0}),e.addEventListener("webglcontextrestored",t=>{console.log("Context Restored",t),r.contextLost=!1;const i=[];r.glyphsByFont.forEach(n=>{n.forEach(s=>{i.push(H3(s,r,!0))})}),Promise.all(i).then(()=>{V3(r),r.sdfTexture.needsUpdate=!0})})}function aw({font:r,characters:e,sdfGlyphSize:t},i){let n=Array.isArray(e)?e.join(`
`):""+e;z3({font:r,sdfGlyphSize:t,text:n},i)}function lw(r,e){for(let t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}let Vc;function cw(r){return Vc||(Vc=typeof document>"u"?{}:document.createElement("a")),Vc.href=r,Vc.href}function V3(r){if(typeof createImageBitmap!="function"){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:e,sdfTexture:t}=r,{width:i,height:n}=e,s=r.sdfCanvas.getContext("webgl");let o=t.image.data;(!o||o.length!==i*n*4)&&(o=new Uint8Array(i*n*4),t.image={width:i,height:n,data:o},t.flipY=!1,t.isDataTexture=!0),s.readPixels(0,0,i,n,s.RGBA,s.UNSIGNED_BYTE,o)}}const uw=_a({name:"Typesetter",dependencies:[qb,Wb,Fb],init(r,e,t){return r(e,t())}}),K3=_a({name:"Typesetter",dependencies:[uw],init(r){return function(e){return new Promise(t=>{r.typeset(e,t)})}},getTransferables(r){const e=[];for(let t in r)r[t]&&r[t].buffer&&e.push(r[t].buffer);return e}});K3.onMainThread;const g1={};function hw(r){let e=g1[r];return e||(e=g1[r]=new an(1,1,r,r).translate(.5,.5,0)),e}const fw="aTroikaGlyphBounds",y1="aTroikaGlyphIndex",dw="aTroikaGlyphColor";class mw extends Um{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new un,this.boundingBox=new oi}computeBoundingSphere(){}computeBoundingBox(){}set detail(e){if(e!==this._detail){this._detail=e,(typeof e!="number"||e<1)&&(e=1);let t=hw(e);["position","normal","uv"].forEach(i=>{this.attributes[i]=t.attributes[i].clone()}),this.setIndex(t.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,t,i,n,s){this.updateAttributeData(fw,e,4),this.updateAttributeData(y1,t,1),this.updateAttributeData(dw,s,3),this._blockBounds=i,this._chunkedBounds=n,this.instanceCount=t.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:t,boundingBox:i}=this;if(t){const{PI:n,floor:s,min:o,max:a,sin:l,cos:c}=Math,u=n/2,h=n*2,f=Math.abs(t),d=e[0]/f,m=e[2]/f,A=s((d+u)/h)!==s((m+u)/h)?-f:o(l(d)*f,l(m)*f),p=s((d-u)/h)!==s((m-u)/h)?f:a(l(d)*f,l(m)*f),g=s((d+n)/h)!==s((m+n)/h)?f*2:a(f-c(d)*f,f-c(m)*f);i.min.set(A,e[1],t<0?-g:0),i.max.set(p,e[3],t<0?0:g)}else i.min.set(e[0],e[1],0),i.max.set(e[2],e[3],0);i.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let t=this.getAttribute(y1).count,i=this._chunkedBounds;if(i)for(let n=i.length;n--;){t=i[n].end;let s=i[n].rect;if(s[1]<e.w&&s[3]>e.y&&s[0]<e.z&&s[2]>e.x)break}this.instanceCount=t}updateAttributeData(e,t,i){const n=this.getAttribute(e);t?n&&n.array.length===t.length?(n.array.set(t),n.needsUpdate=!0):(this.setAttribute(e,new $l(t,i)),delete this._maxInstanceCount,this.dispose()):n&&this.deleteAttribute(e)}}const Aw=`
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform vec4 uTroikaTotalBounds;
uniform vec4 uTroikaClipRect;
uniform mat3 uTroikaOrient;
uniform bool uTroikaUseGlyphColors;
uniform float uTroikaEdgeOffset;
uniform float uTroikaBlurRadius;
uniform vec2 uTroikaPositionOffset;
uniform float uTroikaCurveRadius;
attribute vec4 aTroikaGlyphBounds;
attribute float aTroikaGlyphIndex;
attribute vec3 aTroikaGlyphColor;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec3 vTroikaGlyphColor;
varying vec2 vTroikaGlyphDimensions;
`,pw=`
vec4 bounds = aTroikaGlyphBounds;
bounds.xz += uTroikaPositionOffset.x;
bounds.yw -= uTroikaPositionOffset.y;

vec4 outlineBounds = vec4(
  bounds.xy - uTroikaEdgeOffset - uTroikaBlurRadius,
  bounds.zw + uTroikaEdgeOffset + uTroikaBlurRadius
);
vec4 clippedBounds = vec4(
  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),
  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)
);

vec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);

position.xy = mix(bounds.xy, bounds.zw, clippedXY);

uv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);

float rad = uTroikaCurveRadius;
if (rad != 0.0) {
  float angle = position.x / rad;
  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);
  normal.xz = vec2(sin(angle), cos(angle));
}
  
position = uTroikaOrient * position;
normal = uTroikaOrient * normal;

vTroikaGlyphUV = clippedXY.xy;
vTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);


float txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;
vec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;
vec2 txStartUV = txUvPerSquare * vec2(
  mod(floor(aTroikaGlyphIndex / 4.0), txCols),
  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)
);
vTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);
vTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);
`,gw=`
uniform sampler2D uTroikaSDFTexture;
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform float uTroikaSDFExponent;
uniform float uTroikaEdgeOffset;
uniform float uTroikaFillOpacity;
uniform float uTroikaBlurRadius;
uniform vec3 uTroikaStrokeColor;
uniform float uTroikaStrokeWidth;
uniform float uTroikaStrokeOpacity;
uniform bool uTroikaSDFDebug;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec2 vTroikaGlyphDimensions;

float troikaSdfValueToSignedDistance(float alpha) {
  // Inverse of exponential encoding in webgl-sdf-generator
  
  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);
  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;
  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);
  return signedDist;
}

float troikaGlyphUvToSdfValue(vec2 glyphUV) {
  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);
  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);
  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1
  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;
}

float troikaGlyphUvToDistance(vec2 uv) {
  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));
}

float troikaGetAADist() {
  
  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300
  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;
  #else
  return vTroikaGlyphDimensions.x / 64.0;
  #endif
}

float troikaGetFragDistValue() {
  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);
  float distance = troikaGlyphUvToDistance(clampedGlyphUV);
 
  // Extrapolate distance when outside bounds:
  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : 
    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);

  

  return distance;
}

float troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {
  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)
  float alpha = step(-distanceOffset, -distance);
  #else

  float alpha = smoothstep(
    distanceOffset + aaDist,
    distanceOffset - aaDist,
    distance
  );
  #endif

  return alpha;
}
`,yw=`
float aaDist = troikaGetAADist();
float fragDistance = troikaGetFragDistValue();
float edgeAlpha = uTroikaSDFDebug ?
  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :
  troikaGetEdgeAlpha(fragDistance, uTroikaEdgeOffset, max(aaDist, uTroikaBlurRadius));

#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)
vec4 fillRGBA = gl_FragColor;
fillRGBA.a *= uTroikaFillOpacity;
vec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);
if (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;
gl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(
  -uTroikaStrokeWidth - aaDist,
  -uTroikaStrokeWidth + aaDist,
  fragDistance
));
gl_FragColor.a *= edgeAlpha;
#endif

if (edgeAlpha == 0.0) {
  discard;
}
`;function vw(r){const e=em(r,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new Fe},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new Ci(0,0,0,0)},uTroikaClipRect:{value:new Ci(0,0,0,0)},uTroikaEdgeOffset:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new Fe},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new et},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new bn},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:Aw,vertexTransform:pw,fragmentDefs:gw,fragmentColorTransform:yw,customRewriter({vertexShader:t,fragmentShader:i}){let n=/\buniform\s+vec3\s+diffuse\b/;return n.test(i)&&(i=i.replace(n,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),n.test(t)||(t=t.replace(G3,`uniform vec3 diffuse;
$&
vTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;
`))),{vertexShader:t,fragmentShader:i}}});return e.transparent=!0,e.forceSinglePass=!0,Object.defineProperties(e,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),e}const dA=new ms({color:16777215,side:wi,transparent:!0}),v1=8421504,E1=new Me,Kc=new K,ed=new K,il=[],Ew=new K,td="+x+y";function C1(r){return Array.isArray(r)?r[0]:r}let $3=()=>{const r=new je(new an(1,1),dA);return $3=()=>r,r},j3=()=>{const r=new je(new an(1,1,32,1),dA);return j3=()=>r,r};const Cw={type:"syncstart"},Iw={type:"synccomplete"},Y3=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],_w=Y3.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");let W3=class extends je{constructor(){const e=new mw;super(e,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=v1,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=td,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(Cw),z3({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},t=>{this._isSyncing=!1,this._textRenderInfo=t,this.geometry.updateGlyphs(t.glyphBounds,t.glyphAtlasIndices,t.blockBounds,t.chunkedBounds,t.glyphColors);const i=this._queuedSyncs;i&&(this._queuedSyncs=null,this._needsSync=!0,this.sync(()=>{i.forEach(n=>n&&n())})),this.dispatchEvent(Iw),e&&e()})))}onBeforeRender(e,t,i,n,s,o){this.sync(),s.isTroikaTextMaterial&&this._prepareForRender(s)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}createDerivedMaterial(e){return vw(e)}get material(){let e=this._derivedMaterial;const t=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=dA.clone());if((!e||!e.isDerivedFrom(t))&&(e=this._derivedMaterial=this.createDerivedMaterial(t),t.addEventListener("dispose",function i(){t.removeEventListener("dispose",i),e.dispose()})),this.hasOutline()){let i=e._outlineMtl;return i||(i=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),i.isTextOutlineMaterial=!0,i.depthWrite=!1,i.map=null,e.addEventListener("dispose",function n(){e.removeEventListener("dispose",n),i.dispose()})),[i,e]}else return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}hasOutline(){return!!(this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY)}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return C1(this.material).getDepthMaterial()}set customDepthMaterial(e){}get customDistanceMaterial(){return C1(this.material).getDistanceMaterial()}set customDistanceMaterial(e){}_prepareForRender(e){const t=e.isTextOutlineMaterial,i=e.uniforms,n=this.textRenderInfo;if(n){const{sdfTexture:a,blockBounds:l}=n;i.uTroikaSDFTexture.value=a,i.uTroikaSDFTextureSize.value.set(a.image.width,a.image.height),i.uTroikaSDFGlyphSize.value=n.sdfGlyphSize,i.uTroikaSDFExponent.value=n.sdfExponent,i.uTroikaTotalBounds.value.fromArray(l),i.uTroikaUseGlyphColors.value=!t&&!!n.glyphColors;let c=0,u=0,h=0,f,d,m,A=0,p=0;if(t){let{outlineWidth:v,outlineOffsetX:E,outlineOffsetY:C,outlineBlur:I,outlineOpacity:_}=this;c=this._parsePercent(v)||0,u=Math.max(0,this._parsePercent(I)||0),f=_,A=this._parsePercent(E)||0,p=this._parsePercent(C)||0}else h=Math.max(0,this._parsePercent(this.strokeWidth)||0),h&&(m=this.strokeColor,i.uTroikaStrokeColor.value.set(m??v1),d=this.strokeOpacity,d==null&&(d=1)),f=this.fillOpacity;i.uTroikaEdgeOffset.value=c,i.uTroikaPositionOffset.value.set(A,p),i.uTroikaBlurRadius.value=u,i.uTroikaStrokeWidth.value=h,i.uTroikaStrokeOpacity.value=d,i.uTroikaFillOpacity.value=f??1,i.uTroikaCurveRadius.value=this.curveRadius||0;let g=this.clipRect;if(g&&Array.isArray(g)&&g.length===4)i.uTroikaClipRect.value.fromArray(g);else{const v=(this.fontSize||.1)*100;i.uTroikaClipRect.value.set(l[0]-v,l[1]-v,l[2]+v,l[3]+v)}this.geometry.applyClipRect(i.uTroikaClipRect.value)}i.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const s=t?this.outlineColor||0:this.color;if(s==null)delete e.color;else{const a=e.hasOwnProperty("color")?e.color:e.color=new et;(s!==a._input||typeof s=="object")&&a.set(a._input=s)}let o=this.orientation||td;if(o!==e._orientation){let a=i.uTroikaOrient.value;o=o.replace(/[^-+xyz]/g,"");let l=o!==td&&o.match(/^([-+])([xyz])([-+])([xyz])$/);if(l){let[,c,u,h,f]=l;Kc.set(0,0,0)[u]=c==="-"?1:-1,ed.set(0,0,0)[f]=h==="-"?-1:1,E1.lookAt(Ew,Kc.cross(ed),ed),a.setFromMatrix4(E1)}else a.identity();e._orientation=o}}_parsePercent(e){if(typeof e=="string"){let t=e.match(/^(-?[\d.]+)%$/),i=t?parseFloat(t[1]):NaN;e=(isNaN(i)?0:i/100)*this.fontSize}return e}localPositionToTextCoords(e,t=new Fe){t.copy(e);const i=this.curveRadius;return i&&(t.x=Math.atan2(e.x,Math.abs(i)-Math.abs(e.z))*Math.abs(i)),t}worldPositionToTextCoords(e,t=new Fe){return Kc.copy(e),this.localPositionToTextCoords(this.worldToLocal(Kc),t)}raycast(e,t){const{textRenderInfo:i,curveRadius:n}=this;if(i){const s=i.blockBounds,o=n?j3():$3(),a=o.geometry,{position:l,uv:c}=a.attributes;for(let u=0;u<c.count;u++){let h=s[0]+c.getX(u)*(s[2]-s[0]);const f=s[1]+c.getY(u)*(s[3]-s[1]);let d=0;n&&(d=n-Math.cos(h/n)*n,h=Math.sin(h/n)*n),l.setXYZ(u,h,f,d)}a.boundingSphere=this.geometry.boundingSphere,a.boundingBox=this.geometry.boundingBox,o.matrixWorld=this.matrixWorld,o.material.side=this.material.side,il.length=0,o.raycast(e,il);for(let u=0;u<il.length;u++)il[u].object=this,t.push(il[u])}}copy(e){const t=this.geometry;return super.copy(e),this.geometry=t,_w.forEach(i=>{this[i]=e[i]}),this}clone(){return new this.constructor().copy(this)}};Y3.forEach(r=>{const e="_private_"+r;Object.defineProperty(W3.prototype,r,{get(){return this[e]},set(t){t!==this[e]&&(this[e]=t,this._needsSync=!0)}})});new oi;new et;const DF=y.forwardRef(({sdfGlyphSize:r=64,anchorX:e="center",anchorY:t="middle",font:i,fontSize:n=1,children:s,characters:o,onSync:a,...l},c)=>{const u=de(({invalidate:m})=>m),[h]=y.useState(()=>new W3),[f,d]=y.useMemo(()=>{const m=[];let A="";return y.Children.forEach(s,p=>{typeof p=="string"||typeof p=="number"?A+=p:m.push(p)}),[m,A]},[s]);return fr(()=>new Promise(m=>aw({font:i,characters:o},m)),["troika-text",i,o]),y.useLayoutEffect(()=>void h.sync(()=>{u(),a&&a(h)})),y.useEffect(()=>()=>h.dispose(),[h]),y.createElement("primitive",_e({object:h,ref:c,font:i,text:d,anchorX:e,anchorY:t,fontSize:n,sdfGlyphSize:r},l),f)});let id=null;async function xw(r){return typeof r=="string"?await(await fetch(r)).json():r}function Sw(r){return id||(id=new N6),id.parse(r)}async function q3(r){const e=await xw(r);return Sw(e)}function mA(r){return fr(q3,[r])}mA.preload=r=>g_(q3,[r]);mA.clear=r=>Bh([r]);const Tw=["string","number"],bw=r=>{let e="";const t=[];return y.Children.forEach(r,i=>{Tw.includes(typeof i)?e+=i+"":t.push(i)}),[e,...t]},ww=y.forwardRef(({font:r,letterSpacing:e=0,lineHeight:t=1,size:i=1,height:n=.2,bevelThickness:s=.1,bevelSize:o=.01,bevelEnabled:a=!1,bevelOffset:l=0,bevelSegments:c=4,curveSegments:u=8,smooth:h,children:f,...d},m)=>{y.useMemo(()=>xi({RenamedTextGeometry:d6}),[]);const A=y.useRef(null),p=mA(r),g=y.useMemo(()=>({font:p,size:i,height:n,bevelThickness:s,bevelSize:o,bevelEnabled:a,bevelSegments:c,bevelOffset:l,curveSegments:u,letterSpacing:e,lineHeight:t}),[p,i,n,s,o,a,c,l,u,e,t]),[v,...E]=y.useMemo(()=>bw(f),[f]),C=y.useMemo(()=>[v,g],[v,g]);return y.useLayoutEffect(()=>{h&&(A.current.geometry=_S(A.current.geometry,h),A.current.geometry.computeVertexNormals())},[C,h]),y.useImperativeHandle(m,()=>A.current,[]),y.createElement("mesh",_e({},d,{ref:A}),y.createElement("renamedTextGeometry",{args:C}),E)}),MF=()=>{try{var r=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&r.getContext("webgl2"))}catch{return!1}},LF=y.forwardRef(({children:r,multisamping:e=8,renderIndex:t=1,disableRender:i,disableGamma:n,disableRenderPass:s,depthBuffer:o=!0,stencilBuffer:a=!1,anisotropy:l=1,encoding:c,type:u,...h},f)=>{y.useMemo(()=>xi({EffectComposer:bT,RenderPass:RT,ShaderPass:j0}),[]);const d=y.useRef(null);y.useImperativeHandle(f,()=>d.current,[]);const{scene:m,camera:A,gl:p,size:g,viewport:v}=de(),[E]=y.useState(()=>{const I=new _i(g.width,g.height,{type:u||Ai,format:Mi,depthBuffer:o,stencilBuffer:a,anisotropy:l});return u===$i&&c!=null&&("colorSpace"in I?I.texture.colorSpace=c:I.texture.encoding=c),I.samples=e,I});y.useEffect(()=>{var I,_;(I=d.current)==null||I.setSize(g.width,g.height),(_=d.current)==null||_.setPixelRatio(v.dpr)},[p,g,v.dpr]),We(()=>{var I;i||(I=d.current)==null||I.render()},t);const C=[];return s||C.push(y.createElement("renderPass",{key:"renderpass",attach:`passes-${C.length}`,args:[m,A]})),n||C.push(y.createElement("shaderPass",{attach:`passes-${C.length}`,key:"gammapass",args:[m6]})),y.Children.forEach(r,I=>{I&&C.push(y.cloneElement(I,{key:C.length,attach:`passes-${C.length}`}))}),y.createElement("effectComposer",_e({ref:d,args:[p,E]},h),C)});let I1=function(r){return r.Linear="linear",r.Radial="radial",r}({});function PF({stops:r,colors:e,size:t=1024,width:i=16,type:n=I1.Linear,innerCircleRadius:s=0,outerCircleRadius:o="auto",...a}){const l=de(u=>u.gl),c=y.useMemo(()=>{const u=document.createElement("canvas"),h=u.getContext("2d");u.width=i,u.height=t;let f;if(n===I1.Linear)f=h.createLinearGradient(0,0,0,t);else{const A=u.width/2,p=u.height/2,g=o!=="auto"?Math.abs(Number(o)):Math.sqrt(A**2+p**2);f=h.createRadialGradient(A,p,Math.abs(s),A,p,g)}const d=new et;let m=r.length;for(;m--;)f.addColorStop(r[m],d.set(e[m]).getStyle());return h.save(),h.fillStyle=f,h.fillRect(0,0,i,t),h.restore(),u},[r]);return y.createElement("canvasTexture",_e({colorSpace:l.outputColorSpace,args:[c],attach:"map"},a))}function vs(r,e,t,i){const n=class extends bi{constructor(o={}){const a=Object.entries(r);super({uniforms:a.reduce((l,[c,u])=>{const h=Kl.clone({[c]:{value:u}});return{...l,...h}},{}),vertexShader:e,fragmentShader:t}),this.key="",a.forEach(([l])=>Object.defineProperty(this,l,{get:()=>this.uniforms[l].value,set:c=>this.uniforms[l].value=c})),Object.assign(this,o),i&&i(this)}};return n.key=ot.generateUUID(),n}const Ul=r=>r===Object(r)&&!Array.isArray(r)&&typeof r!="function";function ho(r,e){const t=de(s=>s.gl),i=gi(lr,Ul(r)?Object.values(r):r);return y.useLayoutEffect(()=>{e?.(i)},[e]),y.useEffect(()=>{if("initTexture"in t){let s=[];Array.isArray(i)?s=i:i instanceof tn?s=[i]:Ul(i)&&(s=Object.values(i)),s.forEach(o=>{o instanceof tn&&t.initTexture(o)})}},[t,i]),y.useMemo(()=>{if(Ul(r)){const s={};let o=0;for(const a in r)s[a]=i[o++];return s}else return i},[r,i])}ho.preload=r=>gi.preload(lr,r);ho.clear=r=>gi.clear(lr,r);const kF=({children:r,input:e,onLoad:t})=>{const i=ho(e,t);return y.createElement(y.Fragment,null,r?.(i))},Bw=()=>parseInt(Nm.replace(/\D+/g,"")),sn=Bw(),_1=vs({color:new et("white"),scale:new Fe(1,1),imageBounds:new Fe(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},`
  varying vec2 vUv;
  varying vec2 vPos;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
    vPos = position.xy;
  }
`,`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  varying vec2 vPos;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform float resolution;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float radius;
  uniform float zoom;
  uniform float grayscale;
  uniform float opacity;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  
  const float PI = 3.14159265;
    
  // from https://iquilezles.org/articles/distfunctions
  float udRoundBox( vec2 p, vec2 b, float r ) {
    return length(max(abs(p)-b+r,0.0))-r;
  }

  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);

    vec2 res = vec2(scale * resolution);
    vec2 halfRes = 0.5 * res;
    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    
	  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);
    
    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
  }
`),X3=y.forwardRef(({children:r,color:e,segments:t=1,scale:i=1,zoom:n=1,grayscale:s=0,opacity:o=1,radius:a=0,texture:l,toneMapped:c,transparent:u,side:h,...f},d)=>{xi({ImageMaterial:_1});const m=y.useRef(null),A=de(E=>E.size),p=Array.isArray(i)?[i[0],i[1]]:[i,i],g=[l.image.width,l.image.height],v=Math.max(A.width,A.height);return y.useImperativeHandle(d,()=>m.current,[]),y.useLayoutEffect(()=>{m.current.geometry.parameters&&m.current.material.scale.set(p[0]*m.current.geometry.parameters.width,p[1]*m.current.geometry.parameters.height)},[p[0],p[1]]),y.createElement("mesh",_e({ref:m,scale:Array.isArray(i)?[...i,1]:i},f),y.createElement("planeGeometry",{args:[1,1,t,t]}),y.createElement("imageMaterial",{color:e,map:l,zoom:n,grayscale:s,opacity:o,scale:p,imageBounds:g,resolution:v,radius:a,toneMapped:c,transparent:u,side:h,key:_1.key}),r)}),Rw=y.forwardRef(({url:r,...e},t)=>{const i=ho(r);return y.createElement(X3,_e({},e,{texture:i,ref:t}))}),Dw=y.forwardRef(({url:r,...e},t)=>y.createElement(X3,_e({},e,{ref:t}))),OF=y.forwardRef((r,e)=>{if(r.url)return y.createElement(Rw,_e({},r,{ref:e}));if(r.texture)return y.createElement(Dw,_e({},r,{ref:e}));throw new Error("<Image /> requires a url or texture")}),Mw=y.forwardRef(({threshold:r=15,geometry:e,...t},i)=>{const n=y.useRef(null);y.useImperativeHandle(i,()=>n.current,[]);const s=y.useMemo(()=>[0,0,0,1,0,0],[]),o=y.useRef(),a=y.useRef();return y.useLayoutEffect(()=>{const l=n.current.parent,c=e??l?.geometry;if(!c||o.current===c&&a.current===r)return;o.current=c,a.current=r;const h=new y_(c,r).attributes.position.array;n.current.geometry.setPositions(h),n.current.geometry.attributes.instanceStart.needsUpdate=!0,n.current.geometry.attributes.instanceEnd.needsUpdate=!0,n.current.computeLineDistances()}),y.createElement(Qs,_e({segments:!0,points:s,ref:n,raycast:()=>null},t))}),x1=vs({screenspace:!1,color:new et("black"),opacity:1,thickness:.05,size:new Fe},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   #include <clipping_planes_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     #include <clipping_planes_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   #include <clipping_planes_pars_fragment>
   void main(){
     #include <clipping_planes_fragment>
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function UF({color:r="black",opacity:e=1,transparent:t=!1,screenspace:i=!1,toneMapped:n=!0,polygonOffset:s=!1,polygonOffsetFactor:o=0,renderOrder:a=0,thickness:l=.05,angle:c=Math.PI,clippingPlanes:u,...h}){const f=y.useRef(),[d]=y.useState(()=>new x1({side:hc})),{gl:m}=de(),A=m.getDrawingBufferSize(new Fe);y.useMemo(()=>xi({OutlinesMaterial:x1}),[]);const p=y.useRef(0),g=y.useRef();return y.useLayoutEffect(()=>{const v=f.current;if(!v)return;const E=v.parent;if(E&&E.geometry&&(p.current!==c||g.current!==E.geometry)){var C;p.current=c,g.current=E.geometry;let I=(C=v.children)==null?void 0:C[0];I&&(c&&I.geometry.dispose(),v.remove(I)),E.skeleton?(I=new km,I.material=d,I.bind(E.skeleton,E.bindMatrix),v.add(I)):E.isInstancedMesh?(I=new Lm(E.geometry,d,E.count),I.instanceMatrix=E.instanceMatrix,v.add(I)):(I=new je,I.material=d,v.add(I)),I.geometry=c?qE(E.geometry,c):E.geometry,I.morphTargetInfluences=E.morphTargetInfluences,I.morphTargetDictionary=E.morphTargetDictionary}}),y.useLayoutEffect(()=>{const v=f.current;if(!v)return;const E=v.children[0];if(E){E.renderOrder=a;const C=v.parent;wn(E,{morphTargetInfluences:C.morphTargetInfluences,morphTargetDictionary:C.morphTargetDictionary}),wn(E.material,{transparent:t,thickness:l,color:r,opacity:e,size:A,screenspace:i,toneMapped:n,polygonOffset:s,polygonOffsetFactor:o,clippingPlanes:u,clipping:u&&u.length>0})}}),y.useEffect(()=>()=>{const v=f.current;if(!v)return;const E=v.children[0];E&&(c&&E.geometry.dispose(),v.remove(E))},[]),y.createElement("group",_e({ref:f},h))}var Lw=Object.defineProperty,Pw=(r,e,t)=>e in r?Lw(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,zt=(r,e,t)=>(Pw(r,typeof e!="symbol"?e+"":e,t),t);function nd(r,e,t,i,n){let s;if(r=r.subarray||r.slice?r:r.buffer,t=t.subarray||t.slice?t:t.buffer,r=e?r.subarray?r.subarray(e,n&&e+n):r.slice(e,n&&e+n):r,t.set)t.set(r,i);else for(s=0;s<r.length;s++)t[s+i]=r[s];return t}function Fw(r){return r instanceof Float32Array?r:r instanceof Gi?r.getAttribute("position").array:r.map(e=>{const t=Array.isArray(e);return e instanceof K?[e.x,e.y,e.z]:e instanceof Fe?[e.x,e.y,0]:t&&e.length===3?[e[0],e[1],e[2]]:t&&e.length===2?[e[0],e[1],0]:e}).flat()}class kw extends Gi{constructor(){super(),zt(this,"type","MeshLine"),zt(this,"isMeshLine",!0),zt(this,"positions",[]),zt(this,"previous",[]),zt(this,"next",[]),zt(this,"side",[]),zt(this,"width",[]),zt(this,"indices_array",[]),zt(this,"uvs",[]),zt(this,"counters",[]),zt(this,"widthCallback",null),zt(this,"_attributes"),zt(this,"_points",[]),zt(this,"points"),zt(this,"matrixWorld",new Me),Object.defineProperties(this,{points:{enumerable:!0,get(){return this._points},set(e){this.setPoints(e,this.widthCallback)}}})}setMatrixWorld(e){this.matrixWorld=e}setPoints(e,t){if(e=Fw(e),this._points=e,this.widthCallback=t??null,this.positions=[],this.counters=[],e.length&&e[0]instanceof K)for(let i=0;i<e.length;i++){const n=e[i],s=i/(e.length-1);this.positions.push(n.x,n.y,n.z),this.positions.push(n.x,n.y,n.z),this.counters.push(s),this.counters.push(s)}else for(let i=0;i<e.length;i+=3){const n=i/(e.length-1);this.positions.push(e[i],e[i+1],e[i+2]),this.positions.push(e[i],e[i+1],e[i+2]),this.counters.push(n),this.counters.push(n)}this.process()}compareV3(e,t){const i=e*6,n=t*6;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]}copyV3(e){const t=e*6;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}process(){const e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];let t,i;this.compareV3(0,e-1)?i=this.copyV3(e-2):i=this.copyV3(0),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);for(let n=0;n<e;n++){if(this.side.push(1),this.side.push(-1),this.widthCallback?t=this.widthCallback(n/(e-1)):t=1,this.width.push(t),this.width.push(t),this.uvs.push(n/(e-1),0),this.uvs.push(n/(e-1),1),n<e-1){i=this.copyV3(n),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);const s=n*2;this.indices_array.push(s,s+1,s+2),this.indices_array.push(s+2,s+1,s+3)}n>0&&(i=this.copyV3(n),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]))}this.compareV3(e-1,0)?i=this.copyV3(1):i=this.copyV3(e-1),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]),!this._attributes||this._attributes.position.count!==this.counters.length?this._attributes={position:new Jt(new Float32Array(this.positions),3),previous:new Jt(new Float32Array(this.previous),3),next:new Jt(new Float32Array(this.next),3),side:new Jt(new Float32Array(this.side),1),width:new Jt(new Float32Array(this.width),1),uv:new Jt(new Float32Array(this.uvs),2),index:new Jt(new Uint16Array(this.indices_array),1),counters:new Jt(new Float32Array(this.counters),1)}:(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}advance({x:e,y:t,z:i}){const n=this._attributes.position.array,s=this._attributes.previous.array,o=this._attributes.next.array,a=n.length;nd(n,0,s,0,a),nd(n,6,n,0,a-6),n[a-6]=e,n[a-5]=t,n[a-4]=i,n[a-3]=e,n[a-2]=t,n[a-1]=i,nd(n,6,o,0,a-6),o[a-6]=e,o[a-5]=t,o[a-4]=i,o[a-3]=e,o[a-2]=t,o[a-1]=i,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}const Ow=`
  #include <common>
  #include <logdepthbuf_pars_vertex>
  #include <fog_pars_vertex>
  #include <clipping_planes_pars_vertex>

  attribute vec3 previous;
  attribute vec3 next;
  attribute float side;
  attribute float width;
  attribute float counters;
  
  uniform vec2 resolution;
  uniform float lineWidth;
  uniform vec3 color;
  uniform float opacity;
  uniform float sizeAttenuation;
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  vec2 fix(vec4 i, float aspect) {
    vec2 res = i.xy / i.w;
    res.x *= aspect;
    return res;
  }
  
  void main() {
    float aspect = resolution.x / resolution.y;
    vColor = vec4(color, opacity);
    vUV = uv;
    vCounters = counters;
  
    mat4 m = projectionMatrix * modelViewMatrix;
    vec4 finalPosition = m * vec4(position, 1.0) * aspect;
    vec4 prevPos = m * vec4(previous, 1.0);
    vec4 nextPos = m * vec4(next, 1.0);
  
    vec2 currentP = fix(finalPosition, aspect);
    vec2 prevP = fix(prevPos, aspect);
    vec2 nextP = fix(nextPos, aspect);
  
    float w = lineWidth * width;
  
    vec2 dir;
    if (nextP == currentP) dir = normalize(currentP - prevP);
    else if (prevP == currentP) dir = normalize(nextP - currentP);
    else {
      vec2 dir1 = normalize(currentP - prevP);
      vec2 dir2 = normalize(nextP - currentP);
      dir = normalize(dir1 + dir2);
  
      vec2 perp = vec2(-dir1.y, dir1.x);
      vec2 miter = vec2(-dir.y, dir.x);
      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);
    }
  
    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;
    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);
    normal.xy *= .5 * w;
    //normal *= projectionMatrix;
    if (sizeAttenuation == 0.) {
      normal.xy *= finalPosition.w;
      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy * aspect;
    }
  
    finalPosition.xy += normal.xy * side;
    gl_Position = finalPosition;
    #include <logdepthbuf_vertex>
    #include <fog_vertex>
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    #include <clipping_planes_vertex>
    #include <fog_vertex>
  }
`,Uw=parseInt(Nm.replace(/\D+/g,"")),Nw=Uw>=154?"colorspace_fragment":"encodings_fragment",Gw=`
  #include <fog_pars_fragment>
  #include <logdepthbuf_pars_fragment>
  #include <clipping_planes_pars_fragment>
  
  uniform sampler2D map;
  uniform sampler2D alphaMap;
  uniform float useGradient;
  uniform float useMap;
  uniform float useAlphaMap;
  uniform float useDash;
  uniform float dashArray;
  uniform float dashOffset;
  uniform float dashRatio;
  uniform float visibility;
  uniform float alphaTest;
  uniform vec2 repeat;
  uniform vec3 gradient[2];
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  void main() {
    #include <logdepthbuf_fragment>
    vec4 diffuseColor = vColor;
    if (useGradient == 1.) diffuseColor = vec4(mix(gradient[0], gradient[1], vCounters), 1.0);
    if (useMap == 1.) diffuseColor *= texture2D(map, vUV * repeat);
    if (useAlphaMap == 1.) diffuseColor.a *= texture2D(alphaMap, vUV * repeat).a;
    if (diffuseColor.a < alphaTest) discard;
    if (useDash == 1.) diffuseColor.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));
    diffuseColor.a *= step(vCounters, visibility);
    #include <clipping_planes_fragment>
    gl_FragColor = diffuseColor;     
    #include <fog_fragment>
    #include <tonemapping_fragment>
    #include <${Nw}>
  }
`;class Qw extends bi{constructor(e){super({uniforms:{...R0.fog,lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new et(16777215)},gradient:{value:[new et(16711680),new et(65280)]},opacity:{value:1},resolution:{value:new Fe(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},useGradient:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new Fe(1,1)}},vertexShader:Ow,fragmentShader:Gw}),zt(this,"lineWidth"),zt(this,"map"),zt(this,"useMap"),zt(this,"alphaMap"),zt(this,"useAlphaMap"),zt(this,"color"),zt(this,"gradient"),zt(this,"resolution"),zt(this,"sizeAttenuation"),zt(this,"dashArray"),zt(this,"dashOffset"),zt(this,"dashRatio"),zt(this,"useDash"),zt(this,"useGradient"),zt(this,"visibility"),zt(this,"repeat"),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get(){return this.uniforms.lineWidth.value},set(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get(){return this.uniforms.map.value},set(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get(){return this.uniforms.useMap.value},set(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get(){return this.uniforms.alphaMap.value},set(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get(){return this.uniforms.useAlphaMap.value},set(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get(){return this.uniforms.color.value},set(t){this.uniforms.color.value=t}},gradient:{enumerable:!0,get(){return this.uniforms.gradient.value},set(t){this.uniforms.gradient.value=t}},opacity:{enumerable:!0,get(){return this.uniforms.opacity.value},set(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get(){return this.uniforms.resolution.value},set(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get(){return this.uniforms.sizeAttenuation.value},set(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get(){return this.uniforms.dashArray.value},set(t){this.uniforms.dashArray.value=t,this.useDash=t!==0?1:0}},dashOffset:{enumerable:!0,get(){return this.uniforms.dashOffset.value},set(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get(){return this.uniforms.dashRatio.value},set(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get(){return this.uniforms.useDash.value},set(t){this.uniforms.useDash.value=t}},useGradient:{enumerable:!0,get(){return this.uniforms.useGradient.value},set(t){this.uniforms.useGradient.value=t}},visibility:{enumerable:!0,get(){return this.uniforms.visibility.value},set(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get(){return this.uniforms.alphaTest.value},set(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get(){return this.uniforms.repeat.value},set(t){this.uniforms.repeat.value.copy(t)}}}),this.setValues(e)}copy(e){return super.copy(e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.gradient=e.gradient,this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.useGradient=e.useGradient,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}const J3={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},zw=(r,e=1)=>(r.set(r.subarray(e)),r.fill(-1/0,-e),r);function Hw(r,e){const{length:t,local:i,decay:n,interval:s,stride:o}={...J3,...e},a=y.useRef(),[l]=y.useState(()=>new K);y.useLayoutEffect(()=>{r&&(a.current=Float32Array.from({length:t*10*3},(h,f)=>r.position.getComponent(f%3)))},[t,r]);const c=y.useRef(new K),u=y.useRef(0);return We(()=>{if(r&&a.current){if(u.current===0){let h;i?h=r.position:(r.getWorldPosition(l),h=l);const f=1*n;for(let d=0;d<f;d++)h.distanceTo(c.current)<o||(zw(a.current,3),a.current.set(h.toArray(),a.current.length-3));c.current.copy(h)}u.current++,u.current=u.current%s}}),a}const NF=y.forwardRef((r,e)=>{const{children:t}=r,{width:i,length:n,decay:s,local:o,stride:a,interval:l}={...J3,...r},{color:c="hotpink",attenuation:u,target:h}=r,f=de(C=>C.size),d=de(C=>C.scene),m=y.useRef(null),[A,p]=y.useState(null),g=Hw(A,{length:n,decay:s,local:o,stride:a,interval:l});y.useEffect(()=>{const C=h?.current||m.current.children.find(I=>I instanceof Ei);C&&p(C)},[g,h]);const v=y.useMemo(()=>new kw,[]),E=y.useMemo(()=>{var C;const I=new Qw({lineWidth:.1*i,color:c,sizeAttenuation:1,resolution:new Fe(f.width,f.height)});let _;if(t)if(Array.isArray(t))_=t.find(x=>{const S=x;return typeof S.type=="string"&&S.type==="meshLineMaterial"});else{const x=t;typeof x.type=="string"&&x.type==="meshLineMaterial"&&(_=x)}return typeof((C=_)==null?void 0:C.props)=="object"&&I.setValues(_.props),I},[i,c,f,t]);return y.useEffect(()=>{E.uniforms.resolution.value.set(f.width,f.height)},[f]),We(()=>{g.current&&v.setPoints(g.current,u)}),y.createElement("group",null,uo(y.createElement("mesh",{ref:e,geometry:v,material:E}),d),y.createElement("group",{ref:m},t))});function Vw(r,e=16,t,i,n){const[s,o]=y.useState(()=>{const a=Array.from({length:e},()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]).flat();return new $l(Float32Array.from(a),16)});return y.useLayoutEffect(()=>{if(typeof r.current>"u")return;const a=new jS(r.current);i&&a.setWeightAttribute(i),a.build();const l=new K,c=new K,u=new et,h=new Ei;r.current.updateMatrixWorld(!0);for(let f=0;f<e;f++)a.sample(l,c,u),typeof t=="function"?t({dummy:h,sampledMesh:r.current,position:l,normal:c,color:u},f):h.position.copy(l),h.updateMatrix(),n!=null&&n.current&&n.current.setMatrixAt(f,h.matrix),h.matrix.toArray(s.array,f*16);n!=null&&n.current&&(n.current.instanceMatrix.needsUpdate=!0),s.needsUpdate=!0,o(new $l(s.array,s.itemSize).copy(s))},[r,n,i,e,t]),s}function GF({children:r,weight:e,transform:t,instances:i,mesh:n,count:s=16,...o}){const a=y.useRef(null),l=y.useRef(null),c=y.useRef(null);return y.useLayoutEffect(()=>{var u,h;l.current=(u=i?.current)!==null&&u!==void 0?u:a.current.children.find(f=>f.hasOwnProperty("instanceMatrix")),c.current=(h=n?.current)!==null&&h!==void 0?h:a.current.children.find(f=>f.type==="Mesh")},[r,n?.current,i?.current]),Vw(c,s,t,e,l),y.createElement("group",_e({ref:a},o),r)}const QF=({compute:r,name:e,...t})=>{const[i]=y.useState(()=>new Jt(new Float32Array(0),1)),n=y.useRef(null);return y.useLayoutEffect(()=>{if(n.current){var s;const o=(s=n.current.parent)!==null&&s!==void 0?s:n.current.__r3f.parent,a=r(o);n.current.copy(a)}},[r]),y.createElement("primitive",_e({ref:n,object:i,attach:`attributes-${e}`},t))};function Kw(r,{keys:e=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:t,inject:i,castShadow:n,receiveShadow:s}){let o={};for(const a of e)o[a]=r[a];return t&&(o.geometry&&t!=="materialsOnly"&&(o.geometry=o.geometry.clone()),o.material&&t!=="geometriesOnly"&&(o.material=o.material.clone())),i&&(typeof i=="function"?o={...o,children:i(r)}:y.isValidElement(i)?o={...o,children:i}:o={...o,...i}),r instanceof je&&(n&&(o.castShadow=!0),s&&(o.receiveShadow=!0)),o}const dh=y.forwardRef(({isChild:r=!1,object:e,children:t,deep:i,castShadow:n,receiveShadow:s,inject:o,keys:a,...l},c)=>{const u={keys:a,deep:i,inject:o,castShadow:n,receiveShadow:s};if(e=y.useMemo(()=>{if(r===!1&&!Array.isArray(e)){let m=!1;if(e.traverse(A=>{A.isSkinnedMesh&&(m=!0)}),m)return $S.clone(e)}return e},[e,r]),Array.isArray(e))return y.createElement("group",_e({},l,{ref:c}),e.map(m=>y.createElement(dh,_e({key:m.uuid,object:m},u))),t);const{children:h,...f}=Kw(e,u),d=e.type[0].toLowerCase()+e.type.slice(1);return y.createElement(d,_e({},f,l,{ref:c}),e.children.map(m=>m.type==="Bone"?y.createElement("primitive",_e({key:m.uuid,object:m},u)):y.createElement(dh,_e({key:m.uuid,object:m},u,{isChild:!0}))),t,h)}),AA=y.createContext(null),zF=y.forwardRef(({resolution:r=28,maxPolyCount:e=1e4,enableUvs:t=!1,enableColors:i=!1,children:n,...s},o)=>{const a=y.useRef(null);y.useImperativeHandle(o,()=>a.current,[]);const l=y.useMemo(()=>new OS(r,null,t,i,e),[r,e,t,i]),c=y.useMemo(()=>({getParent:()=>a}),[]);return We(()=>{l.update(),l.reset()},-1),y.createElement(y.Fragment,null,y.createElement("primitive",_e({object:l,ref:a},s),y.createElement(AA.Provider,{value:c},n)))}),HF=y.forwardRef(({strength:r=.5,subtract:e=12,color:t,...i},n)=>{const{getParent:s}=y.useContext(AA),o=y.useMemo(()=>s(),[s]),a=y.useRef(null);y.useImperativeHandle(n,()=>a.current,[]);const l=new K;return We(c=>{!o.current||!a.current||(a.current.getWorldPosition(l),o.current.addBall(.5+l.x*.5,.5+l.y*.5,.5+l.z*.5,r,e,t))}),y.createElement("group",_e({ref:a},i))}),VF=y.forwardRef(({planeType:r="x",strength:e=.5,subtract:t=12,...i},n)=>{const{getParent:s}=y.useContext(AA),o=y.useMemo(()=>s(),[s]),a=y.useRef(null);y.useImperativeHandle(n,()=>a.current,[]);const l=y.useMemo(()=>r==="x"?"addPlaneX":r==="y"?"addPlaneY":"addPlaneZ",[r]);return We(()=>{!o.current||!a.current||o.current[l](e,t)}),y.createElement("group",_e({ref:a},i))});function $w(r){return Array.isArray(r)}function sd(r=[0,0,0]){return $w(r)?r:r instanceof K||r instanceof Wn?[r.x,r.y,r.z]:[r,r,r]}const KF=y.forwardRef(function({debug:e,depthTest:t=!1,polygonOffsetFactor:i=-10,map:n,mesh:s,children:o,position:a,rotation:l,scale:c,...u},h){const f=y.useRef(null);y.useImperativeHandle(h,()=>f.current);const d=y.useRef(null),m=y.useRef({position:new K,rotation:new Wn,scale:new K(1,1,1)});return y.useLayoutEffect(()=>{const A=s?.current||f.current.parent,p=f.current;if(!(A instanceof je))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(A){wn(m.current,{position:a,scale:c});const g=A.matrixWorld.clone();if(A.matrixWorld.identity(),!l||typeof l=="number"){const v=new Ei;v.position.copy(m.current.position);const E=A.geometry.attributes.position.array;A.geometry.attributes.normal===void 0&&A.geometry.computeVertexNormals();const C=A.geometry.attributes.normal.array;let I=1/0;new K;let _=new K;const x=v.position.x,S=v.position.y,b=v.position.z,T=E.length;let B=-1;for(let w=0;w<T;w+=3){const R=E[w],D=E[w+1],G=E[w+2],z=R-x,W=D-S,q=G-b,F=z*z+W*W+q*q;F<I&&(I=F,B=w)}_.fromArray(C,B),v.lookAt(v.position.clone().add(_)),v.rotateZ(Math.PI),v.rotateY(Math.PI),typeof l=="number"&&v.rotateZ(l),wn(m.current,{rotation:v.rotation})}else wn(m.current,{rotation:l});return p.geometry=new f6(A,m.current.position,m.current.rotation,m.current.scale),A.matrixWorld=g,()=>{p.geometry.dispose()}}},[s,...sd(a),...sd(c),...sd(l)]),y.useLayoutEffect(()=>{d.current&&(wn(d.current,m.current),d.current.traverse(A=>A.raycast=()=>null))},[e]),y.createElement("mesh",_e({ref:f,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":i,"material-depthTest":t,"material-map":n},u),o,e&&y.createElement("mesh",{ref:d},y.createElement("boxGeometry",null),y.createElement("meshNormalMaterial",{wireframe:!0}),y.createElement("axesHelper",null)))}),$F=y.forwardRef(function({src:e,skipFill:t,skipStrokes:i,fillMaterial:n,strokeMaterial:s,fillMeshProps:o,strokeMeshProps:a,...l},c){const u=gi(jf,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),h=y.useMemo(()=>i?[]:u.paths.map(d=>{var m;return((m=d.userData)==null?void 0:m.style.stroke)===void 0||d.userData.style.stroke==="none"?null:d.subPaths.map(A=>jf.pointsToStroke(A.getPoints(),d.userData.style))}),[u,i]);y.useEffect(()=>()=>h.forEach(d=>d&&d.map(m=>m.dispose())),[h]);let f=0;return y.createElement("object3D",_e({ref:c},l),y.createElement("object3D",{scale:[1,-1,1]},u.paths.map((d,m)=>{var A,p;return y.createElement(y.Fragment,{key:m},!t&&((A=d.userData)==null?void 0:A.style.fill)!==void 0&&d.userData.style.fill!=="none"&&jf.createShapes(d).map((g,v)=>y.createElement("mesh",_e({key:v},o,{renderOrder:f++}),y.createElement("shapeGeometry",{args:[g]}),y.createElement("meshBasicMaterial",_e({color:d.userData.style.fill,opacity:d.userData.style.fillOpacity,transparent:!0,side:wi,depthWrite:!1},n)))),!i&&((p=d.userData)==null?void 0:p.style.stroke)!==void 0&&d.userData.style.stroke!=="none"&&d.subPaths.map((g,v)=>y.createElement("mesh",_e({key:v,geometry:h[m][v]},a,{renderOrder:f++}),y.createElement("meshBasicMaterial",_e({color:d.userData.style.stroke,opacity:d.userData.style.strokeOpacity,transparent:!0,side:wi,depthWrite:!1},s)))))})))});let $c=null,Z3="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function e4(r=!0,e=!0,t){return i=>{t&&t(i),r&&($c||($c=new Ab),$c.setDecoderPath(typeof r=="string"?r:Z3),i.setDRACOLoader($c)),e&&i.setMeshoptDecoder(typeof Jf=="function"?Jf():Jf)}}const Kh=(r,e,t,i)=>gi(lA,r,e4(e,t,i));Kh.preload=(r,e,t,i)=>gi.preload(lA,r,e4(e,t,i));Kh.clear=r=>gi.clear(lA,r);Kh.setDecoderPath=r=>{Z3=r};const jF=y.forwardRef(({src:r,useDraco:e,useMeshOpt:t,extendLoader:i,...n},s)=>{const{scene:o}=Kh(r,e,t,i);return y.createElement(dh,_e({ref:s},n,{object:o}))});function YF({renderIndex:r=1,bgColor:e="black",fgColor:t="white",characters:i=" .:-+*=%@#",invert:n=!0,color:s=!1,resolution:o=.15}){const{size:a,gl:l,scene:c,camera:u}=de(),h=y.useMemo(()=>{const f=new y6(l,i,{invert:n,color:s,resolution:o});return f.domElement.style.position="absolute",f.domElement.style.top="0px",f.domElement.style.left="0px",f.domElement.style.pointerEvents="none",f},[i,n,s,o]);return y.useLayoutEffect(()=>{h.domElement.style.color=t,h.domElement.style.backgroundColor=e},[t,e]),y.useEffect(()=>(l.domElement.style.opacity="0",l.domElement.parentNode.appendChild(h.domElement),()=>{l.domElement.style.opacity="1",l.domElement.parentNode.removeChild(h.domElement)}),[h]),y.useEffect(()=>{h.setSize(a.width,a.height)},[h,a]),We(f=>{h.render(c,u)},r),y.createElement(y.Fragment,null)}const S1=vs({alphaTest:0,viewport:new Fe(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},`
    precision highp sampler2D;
    precision highp usampler2D;
    out vec4 vColor;
    out vec3 vPosition;
    uniform vec2 resolution;
    uniform vec2 viewport;
    uniform float focal;
    attribute uint splatIndex;
    uniform sampler2D centerAndScaleTexture;
    uniform usampler2D covAndColorTexture;    

    vec2 unpackInt16(in uint value) {
      int v = int(value);
      int v0 = v >> 16;
      int v1 = (v & 0xFFFF);
      if((v & 0x8000) != 0)
        v1 |= 0xFFFF0000;
      return vec2(float(v1), float(v0));
    }

    void main () {
      ivec2 texSize = textureSize(centerAndScaleTexture, 0);
      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));
      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);
      vec4 center = vec4(centerAndScaleData.xyz, 1);
      vec4 camspace = modelViewMatrix * center;
      vec4 pos2d = projectionMatrix * camspace;

      float bounds = 1.2 * pos2d.w;
      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds
        || pos2d.y < -bounds || pos2d.y > bounds) {
        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);
        return;
      }

      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);
      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;
      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;
      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;
      mat3 Vrk = mat3(
        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,
        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,
        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y
      );

      mat3 J = mat3(
        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),
        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),
        0., 0., 0.
      );

      mat3 W = transpose(mat3(modelViewMatrix));
      mat3 T = W * J;
      mat3 cov = transpose(T) * Vrk * T;
      vec2 vCenter = vec2(pos2d) / pos2d.w;
      float diagonal1 = cov[0][0] + 0.3;
      float offDiagonal = cov[0][1];
      float diagonal2 = cov[1][1] + 0.3;
      float mid = 0.5 * (diagonal1 + diagonal2);
      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
      float lambda1 = mid + radius;
      float lambda2 = max(mid - radius, 0.1);
      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);
      uint colorUint = covAndColorData.w;
      vColor = vec4(
        float(colorUint & uint(0xFF)) / 255.0,
        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,
        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,
        float(colorUint >> uint(24)) / 255.0
      );
      vPosition = position;

      gl_Position = vec4(
        vCenter 
          + position.x * v2 / viewport * 2.0 
          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);
    }
    `,`
    #include <alphatest_pars_fragment>
    #include <alphahash_pars_fragment>
    in vec4 vColor;
    in vec3 vPosition;
    void main () {
      float A = -dot(vPosition.xy, vPosition.xy);
      if (A < -4.0) discard;
      float B = exp(A) * vColor.a;
      vec4 diffuseColor = vec4(vColor.rgb, B);
      #include <alphatest_fragment>
      #include <alphahash_fragment>
      gl_FragColor = diffuseColor;
      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `);function jw(r){let e=null,t=0;function i(n,s=!1){const o=e.length/16,a=-1e-4;let l=-1/0,c=1/0;const u=new Float32Array(o),h=new Int32Array(u.buffer),f=new Int32Array(o);let d=0;for(let v=0;v<o;v++){const E=n[0]*e[v*16+12]+n[1]*e[v*16+13]+n[2]*e[v*16+14]+n[3];(s||E<0&&e[v*16+15]>a*E)&&(u[d]=E,f[d]=v,d++,E>l&&(l=E),E<c&&(c=E))}const m=(256*256-1)/(l-c),A=new Uint32Array(256*256);for(let v=0;v<d;v++)h[v]=(u[v]-c)*m|0,A[h[v]]++;const p=new Uint32Array(256*256);for(let v=1;v<256*256;v++)p[v]=p[v-1]+A[v-1];const g=new Uint32Array(d);for(let v=0;v<d;v++)g[p[h[v]]++]=f[v];return g}r.onmessage=n=>{if(n.data.method=="push"){t===0&&(e=new Float32Array(n.data.length));const s=new Float32Array(n.data.matrices);e.set(s,t),t+=s.length}else if(n.data.method=="sort"&&e!==null){const s=i(new Float32Array(n.data.view),n.data.hashed);r.postMessage({indices:s,key:n.data.key},[s.buffer])}}}class Yw extends Ur{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,i,n){const s={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",jw.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(o,a,l)=>Xw(a,s,o,l),connect:o=>Jw(s,o),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:i};Ww(s).then(t).catch(o=>{n?.(o),s.manager.itemError(s.url)})}}async function Ww(r){r.manager.itemStart(r.url);const e=await fetch(r.url);if(e.body===null)throw"Failed to fetch file";let t=e.headers.get("Content-Length");const i=t?parseInt(t):void 0;if(i==null)throw"Failed to get content length";r.stream=e.body.getReader(),r.totalDownloadBytes=i,r.numVertices=Math.floor(r.totalDownloadBytes/r.rowLength);const n=r.gl.getContext();let s=n.getParameter(n.MAX_TEXTURE_SIZE);return r.maxVertexes=s*s,r.numVertices>r.maxVertexes&&(r.numVertices=r.maxVertexes),r.bufferTextureWidth=s,r.bufferTextureHeight=Math.floor((r.numVertices-1)/s)+1,r.centerAndScaleData=new Float32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.covAndColorData=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.centerAndScaleTexture=new Fr(r.centerAndScaleData,r.bufferTextureWidth,r.bufferTextureHeight,Mi,hi),r.centerAndScaleTexture.needsUpdate=!0,r.covAndColorTexture=new Fr(r.covAndColorData,r.bufferTextureWidth,r.bufferTextureHeight,ih,no),r.covAndColorTexture.internalFormat="RGBA32UI",r.covAndColorTexture.needsUpdate=!0,r}async function qw(r){r.loading=!0;let e=0,t=0;const i=[];let n=0;const s=r.totalDownloadBytes!==0;for(;;)try{const{value:o,done:a}=await r.stream.read();if(a)break;if(e+=o.length,r.totalDownloadBytes!=null){const c=e/r.totalDownloadBytes*100;if(r.onProgress&&c-n>1){const u=new ProgressEvent("progress",{lengthComputable:s,loaded:e,total:r.totalDownloadBytes});r.onProgress(u),n=c}}i.push(o);const l=e-t;if(r.totalDownloadBytes!=null&&l>r.rowLength*r.chunkSize){let c=Math.floor(l/r.rowLength);const u=new Uint8Array(l);let h=0;for(const m of i)u.set(m,h),h+=m.length;if(i.length=0,l>c*r.rowLength){const m=new Uint8Array(l-c*r.rowLength);m.set(u.subarray(l-m.length,l),0),i.push(m)}const f=new Uint8Array(c*r.rowLength);f.set(u.subarray(0,f.byteLength),0);const d=T1(r,f.buffer,c);if(r.worker.postMessage({method:"push",src:r.url,length:r.numVertices*16,matrices:d.buffer},[d.buffer]),t+=c*r.rowLength,r.onProgress){const m=new ProgressEvent("progress",{lengthComputable:s,loaded:r.totalDownloadBytes,total:r.totalDownloadBytes});r.onProgress(m)}}}catch(o){console.error(o);break}if(e-t>0){let o=new Uint8Array(i.reduce((u,h)=>u+h.length,0)),a=0;for(const u of i)o.set(u,a),a+=u.length;let l=Math.floor(o.byteLength/r.rowLength);const c=T1(r,o.buffer,l);r.worker.postMessage({method:"push",src:r.url,length:l*16,matrices:c.buffer},[c.buffer])}r.loaded=!0,r.manager.itemEnd(r.url)}function Xw(r,e,t,i){if(r.updateMatrixWorld(),e.gl.getCurrentViewport(t.viewport),t.material.viewport.x=t.viewport.z,t.material.viewport.y=t.viewport.w,t.material.focal=t.viewport.w/2*Math.abs(r.projectionMatrix.elements[5]),t.ready){if(i&&t.sorted)return;t.ready=!1;const n=new Float32Array([t.modelViewMatrix.elements[2],-t.modelViewMatrix.elements[6],t.modelViewMatrix.elements[10],t.modelViewMatrix.elements[14]]);e.worker.postMessage({method:"sort",src:e.url,key:t.uuid,view:n.buffer,hashed:i},[n.buffer]),i&&e.loaded&&(t.sorted=!0)}}function Jw(r,e){r.loading||qw(r),e.ready=!1,e.pm=new Me,e.vm1=new Me,e.vm2=new Me,e.viewport=new Ci;let t=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight);const i=new $l(t,1,!1);i.setUsage(nn);const n=e.geometry=new Um,s=new Float32Array(6*3),o=new Jt(s,3);n.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,n.setAttribute("splatIndex",i),n.instanceCount=1;function a(c){if(e&&c.data.key===e.uuid){let u=new Uint32Array(c.data.indices);n.attributes.splatIndex.set(u),n.attributes.splatIndex.needsUpdate=!0,n.instanceCount=u.length,e.ready=!0}}r.worker.addEventListener("message",a);async function l(){for(;;){const c=r.gl.properties.get(r.centerAndScaleTexture),u=r.gl.properties.get(r.covAndColorTexture);if(c!=null&&c.__webglTexture&&u!=null&&u.__webglTexture&&r.loadedVertexCount>0)break;await new Promise(h=>setTimeout(h,10))}e.ready=!0}return l(),()=>r.worker.removeEventListener("message",a)}function T1(r,e,t){const i=r.gl.getContext();if(r.loadedVertexCount+t>r.maxVertexes&&(t=r.maxVertexes-r.loadedVertexCount),t<=0)throw"Failed to parse file";const n=new Uint8Array(e),s=new Float32Array(e),o=new Float32Array(t*16),a=new Uint8Array(r.covAndColorData.buffer),l=new Int16Array(r.covAndColorData.buffer);for(let c=0;c<t;c++){const u=new ht(-(n[32*c+28+1]-128)/128,(n[32*c+28+2]-128)/128,(n[32*c+28+3]-128)/128,-(n[32*c+28+0]-128)/128);u.invert();const h=new K(s[8*c+0],s[8*c+1],-s[8*c+2]),f=new K(s[8*c+3+0],s[8*c+3+1],s[8*c+3+2]),d=new Me;d.makeRotationFromQuaternion(u),d.transpose(),d.scale(f);const m=d.clone();d.transpose(),d.premultiply(m),d.setPosition(h);const A=[0,1,2,5,6,10];let p=0;for(let E=0;E<A.length;E++)Math.abs(d.elements[A[E]])>p&&(p=Math.abs(d.elements[A[E]]));let g=r.loadedVertexCount*4+c*4;r.centerAndScaleData[g+0]=h.x,r.centerAndScaleData[g+1]=-h.y,r.centerAndScaleData[g+2]=h.z,r.centerAndScaleData[g+3]=p/32767,g=r.loadedVertexCount*8+c*4*2;for(let E=0;E<A.length;E++)l[g+E]=d.elements[A[E]]*32767/p;g=r.loadedVertexCount*16+(c*4+3)*4;const v=new et(n[32*c+24+0]/255,n[32*c+24+1]/255,n[32*c+24+2]/255);v.convertSRGBToLinear(),a[g+0]=v.r*255,a[g+1]=v.g*255,a[g+2]=v.b*255,a[g+3]=n[32*c+24+3],d.elements[15]=Math.max(f.x,f.y,f.z)*n[32*c+24+3]/255;for(let E=0;E<16;E++)o[c*16+E]=d.elements[E]}for(;t>0;){let c=0,u=0;const h=r.loadedVertexCount%r.bufferTextureWidth,f=Math.floor(r.loadedVertexCount/r.bufferTextureWidth);r.loadedVertexCount%r.bufferTextureWidth!=0?(c=Math.min(r.bufferTextureWidth,h+t)-h,u=1):Math.floor(t/r.bufferTextureWidth)>0?(c=r.bufferTextureWidth,u=Math.floor(t/r.bufferTextureWidth)):(c=t%r.bufferTextureWidth,u=1);const d=r.gl.properties.get(r.centerAndScaleTexture);i.bindTexture(i.TEXTURE_2D,d.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA,i.FLOAT,r.centerAndScaleData,r.loadedVertexCount*4);const m=r.gl.properties.get(r.covAndColorTexture);i.bindTexture(i.TEXTURE_2D,m.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA_INTEGER,i.UNSIGNED_INT,r.covAndColorData,r.loadedVertexCount*4),r.gl.resetState(),r.loadedVertexCount+=c*u,t-=c*u}return o}function WF({src:r,toneMapped:e=!1,alphaTest:t=0,alphaHash:i=!1,chunkSize:n=25e3,...s}){xi({SplatMaterial:S1});const o=y.useRef(null),a=de(u=>u.gl),l=de(u=>u.camera),c=gi(Yw,r,u=>{u.gl=a,u.chunkSize=n});return y.useLayoutEffect(()=>c.connect(o.current),[r]),We(()=>c.update(o.current,l,i)),y.createElement("mesh",_e({ref:o,frustumCulled:!1},s),y.createElement("splatMaterial",{key:`${r}/${t}/${i}${S1.key}`,transparent:!i,depthTest:!0,alphaTest:i?0:t,centerAndScaleTexture:c.centerAndScaleTexture,covAndColorTexture:c.covAndColorTexture,depthWrite:i?!0:t>0,blending:i?v_:$2,blendSrcAlpha:K2,alphaHash:!!i,toneMapped:e}))}function En(r,e,t){const i=de(f=>f.size),n=de(f=>f.viewport),s=typeof r=="number"?r:i.width*n.dpr,o=typeof e=="number"?e:i.height*n.dpr,a=(typeof r=="number"?t:r)||{},{samples:l=0,depth:c,...u}=a,h=y.useMemo(()=>{const f=new _i(s,o,{minFilter:jt,magFilter:jt,type:Ai,...u});return c&&(f.depthTexture=new Rh(s,o,hi)),f.samples=l,f},[]);return y.useLayoutEffect(()=>{h.setSize(s,o),l&&(h.samples=l)},[l,h,s,o]),y.useEffect(()=>()=>h.dispose(),[]),h}const qF=({children:r,width:e,height:t,...i})=>{const n=En(e,t,i);return y.createElement(y.Fragment,null,r?.(n))},Zw=r=>typeof r=="function",e8=y.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,children:i,makeDefault:n,...s},o)=>{const a=de(({set:p})=>p),l=de(({camera:p})=>p),c=de(({size:p})=>p),u=y.useRef(null);y.useImperativeHandle(o,()=>u.current,[]);const h=y.useRef(null),f=En(e);y.useLayoutEffect(()=>{s.manual||u.current.updateProjectionMatrix()},[c,s]),y.useLayoutEffect(()=>{u.current.updateProjectionMatrix()}),y.useLayoutEffect(()=>{if(n){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,n,a]);let d=0,m=null;const A=Zw(i);return We(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),y.createElement(y.Fragment,null,y.createElement("orthographicCamera",_e({left:c.width/-2,right:c.width/2,top:c.height/2,bottom:c.height/-2,ref:u},s),!A&&i),y.createElement("group",{ref:h},A&&i(f.texture)))}),t8=r=>typeof r=="function",XF=y.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,makeDefault:i,children:n,...s},o)=>{const a=de(({set:p})=>p),l=de(({camera:p})=>p),c=de(({size:p})=>p),u=y.useRef(null);y.useImperativeHandle(o,()=>u.current,[]);const h=y.useRef(null),f=En(e);y.useLayoutEffect(()=>{s.manual||(u.current.aspect=c.width/c.height)},[c,s]),y.useLayoutEffect(()=>{u.current.updateProjectionMatrix()});let d=0,m=null;const A=t8(n);return We(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),y.useLayoutEffect(()=>{if(i){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,i,a]),y.createElement(y.Fragment,null,y.createElement("perspectiveCamera",_e({ref:u},s),!A&&n),y.createElement("group",{ref:h},A&&n(f.texture)))});function i8({resolution:r=256,near:e=.1,far:t=1e3,envMap:i,fog:n}={}){const s=de(({gl:f})=>f),o=de(({scene:f})=>f),a=y.useMemo(()=>{const f=new Dh(r);return f.texture.type=Ai,f},[r]);y.useEffect(()=>()=>{a.dispose()},[a]);const l=y.useMemo(()=>new j2(e,t,a),[e,t,a]);let c,u;const h=y.useCallback(()=>{c=o.fog,u=o.background,o.background=i||u,o.fog=n||c,l.update(s,o),o.fog=c,o.background=u},[s,o,l]);return{fbo:a,camera:l,update:h}}function JF({children:r,frames:e=1/0,resolution:t,near:i,far:n,envMap:s,fog:o,...a}){const l=y.useRef(null),{fbo:c,camera:u,update:h}=i8({resolution:t,near:i,far:n,envMap:s,fog:o});let f=0;return We(()=>{l.current&&(e===1/0||f<e)&&(l.current.visible=!1,h(),l.current.visible=!0,f++)}),y.createElement("group",a,y.createElement("primitive",{object:u}),y.createElement("group",{ref:l},r?.(c.texture)))}const ZF=y.forwardRef((r,e)=>{const{camera:t,onChange:i,makeDefault:n,...s}=r,o=de(f=>f.camera),a=de(f=>f.invalidate),l=de(f=>f.get),c=de(f=>f.set),u=t||o,h=y.useMemo(()=>new sT(u),[u]);return y.useEffect(()=>{const f=d=>{a(),i&&i(d)};return h==null||h.addEventListener==null||h.addEventListener("change",f),()=>h==null||h.removeEventListener==null?void 0:h.removeEventListener("change",f)},[i,h,a]),We(()=>h?.update(),-1),y.useEffect(()=>{const f=h;return f?.connect(),()=>f?.dispose()},[h]),y.useEffect(()=>{if(n){const f=l().controls;return c({controls:h}),()=>c({controls:f})}},[n,h]),h?y.createElement("primitive",_e({ref:e,object:h},s)):null}),ek=y.forwardRef(({domElement:r,...e},t)=>{const{onChange:i,makeDefault:n,...s}=e,o=de(m=>m.invalidate),a=de(m=>m.camera),l=de(m=>m.gl),c=de(m=>m.events),u=de(m=>m.get),h=de(m=>m.set),f=r||c.connected||l.domElement,d=y.useMemo(()=>new gT(a),[a]);return y.useEffect(()=>(d.connect(f),()=>void d.dispose()),[f,d,o]),y.useEffect(()=>{const m=A=>{o(),i&&i(A)};return d.addEventListener==null||d.addEventListener("change",m),()=>d.removeEventListener==null?void 0:d.removeEventListener("change",m)},[i,o]),y.useEffect(()=>{if(n){const m=u().controls;return h({controls:d}),()=>h({controls:m})}},[n,d]),We((m,A)=>d.update(A)),y.createElement("primitive",_e({ref:t,object:d,args:[a,f]},s))}),tk=y.forwardRef((r={enableDamping:!0},e)=>{const{domElement:t,camera:i,makeDefault:n,onChange:s,onStart:o,onEnd:a,...l}=r,c=de(v=>v.invalidate),u=de(v=>v.camera),h=de(v=>v.gl),f=de(v=>v.events),d=de(v=>v.set),m=de(v=>v.get),A=t||f.connected||h.domElement,p=i||u,g=y.useMemo(()=>new hT(p),[p]);return y.useEffect(()=>{g.connect(A);const v=E=>{c(),s&&s(E)};return g.addEventListener("change",v),o&&g.addEventListener("start",o),a&&g.addEventListener("end",a),()=>{g.dispose(),g.removeEventListener("change",v),o&&g.removeEventListener("start",o),a&&g.removeEventListener("end",a)}},[s,o,a,g,c,A]),y.useEffect(()=>{if(n){const v=m().controls;return d({controls:g}),()=>d({controls:v})}},[n,g]),We(()=>g.update(),-1),y.createElement("primitive",_e({ref:e,object:g,enableDamping:!0},l))}),ik=y.forwardRef(({makeDefault:r,camera:e,regress:t,domElement:i,enableDamping:n=!0,keyEvents:s=!1,onChange:o,onStart:a,onEnd:l,...c},u)=>{const h=de(_=>_.invalidate),f=de(_=>_.camera),d=de(_=>_.gl),m=de(_=>_.events),A=de(_=>_.setEvents),p=de(_=>_.set),g=de(_=>_.get),v=de(_=>_.performance),E=e||f,C=i||m.connected||d.domElement,I=y.useMemo(()=>new o3(E),[E]);return We(()=>{I.enabled&&I.update()},-1),y.useEffect(()=>(s&&I.connect(s===!0?C:s),I.connect(C),()=>void I.dispose()),[s,C,t,I,h]),y.useEffect(()=>{const _=b=>{h(),t&&v.regress(),o&&o(b)},x=b=>{a&&a(b)},S=b=>{l&&l(b)};return I.addEventListener("change",_),I.addEventListener("start",x),I.addEventListener("end",S),()=>{I.removeEventListener("start",x),I.removeEventListener("end",S),I.removeEventListener("change",_)}},[o,a,l,I,h,A]),y.useEffect(()=>{if(r){const _=g().controls;return p({controls:I}),()=>p({controls:_})}},[r,I]),y.createElement("primitive",_e({ref:u,object:I,enableDamping:n},c))}),nk=y.forwardRef(({makeDefault:r,camera:e,domElement:t,regress:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const{invalidate:c,camera:u,gl:h,events:f,set:d,get:m,performance:A,viewport:p}=de(),g=e||u,v=t||f.connected||h.domElement,E=y.useMemo(()=>new aT(g),[g]);return We(()=>{E.enabled&&E.update()},-1),y.useEffect(()=>(E.connect(v),()=>void E.dispose()),[v,i,E,c]),y.useEffect(()=>{const C=I=>{c(),i&&A.regress(),n&&n(I)};return E.addEventListener("change",C),s&&E.addEventListener("start",s),o&&E.addEventListener("end",o),()=>{s&&E.removeEventListener("start",s),o&&E.removeEventListener("end",o),E.removeEventListener("change",C)}},[n,s,o,E,c]),y.useEffect(()=>{E.handleResize()},[p]),y.useEffect(()=>{if(r){const C=m().controls;return d({controls:E}),()=>d({controls:C})}},[r,E]),y.createElement("primitive",_e({ref:l,object:E},a))}),sk=y.forwardRef(({camera:r,makeDefault:e,regress:t,domElement:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const c=de(E=>E.invalidate),u=de(E=>E.camera),h=de(E=>E.gl),f=de(E=>E.events),d=de(E=>E.set),m=de(E=>E.get),A=de(E=>E.performance),p=r||u,g=i||f.connected||h.domElement,v=y.useMemo(()=>new mT(p),[p]);return We(()=>{v.enabled&&v.update()},-1),y.useEffect(()=>(v.connect(g),()=>void v.dispose()),[g,t,v,c]),y.useEffect(()=>{const E=C=>{c(),t&&A.regress(),n&&n(C)};return v.addEventListener("change",E),s&&v.addEventListener("start",s),o&&v.addEventListener("end",o),()=>{v.removeEventListener("change",E),s&&v.removeEventListener("start",s),o&&v.removeEventListener("end",o)}},[n,s,o]),y.useEffect(()=>{if(e){const E=m().controls;return d({controls:v}),()=>d({controls:E})}},[e,v]),y.createElement("primitive",_e({ref:l,object:v},a))}),rk=y.forwardRef(({children:r,domElement:e,onChange:t,onMouseDown:i,onMouseUp:n,onObjectChange:s,object:o,makeDefault:a,camera:l,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:g,showY:v,showZ:E,...C},I)=>{const _=de(L=>L.controls),x=de(L=>L.gl),S=de(L=>L.events),b=de(L=>L.camera),T=de(L=>L.invalidate),B=de(L=>L.get),w=de(L=>L.set),R=l||b,D=e||S.connected||x.domElement,G=y.useMemo(()=>new ZS(R,D),[R,D]),z=y.useRef(null);y.useLayoutEffect(()=>(o?G.attach(o instanceof Ei?o:o.current):z.current instanceof Ei&&G.attach(z.current),()=>void G.detach()),[o,r,G]),y.useEffect(()=>{if(_){const L=$=>_.enabled=!$.value;return G.addEventListener("dragging-changed",L),()=>G.removeEventListener("dragging-changed",L)}},[G,_]);const W=y.useRef(),q=y.useRef(),F=y.useRef(),N=y.useRef();return y.useLayoutEffect(()=>void(W.current=t),[t]),y.useLayoutEffect(()=>void(q.current=i),[i]),y.useLayoutEffect(()=>void(F.current=n),[n]),y.useLayoutEffect(()=>void(N.current=s),[s]),y.useEffect(()=>{const L=k=>{T(),W.current==null||W.current(k)},$=k=>q.current==null?void 0:q.current(k),j=k=>F.current==null?void 0:F.current(k),V=k=>N.current==null?void 0:N.current(k);return G.addEventListener("change",L),G.addEventListener("mouseDown",$),G.addEventListener("mouseUp",j),G.addEventListener("objectChange",V),()=>{G.removeEventListener("change",L),G.removeEventListener("mouseDown",$),G.removeEventListener("mouseUp",j),G.removeEventListener("objectChange",V)}},[T,G]),y.useEffect(()=>{if(a){const L=B().controls;return w({controls:G}),()=>w({controls:L})}},[a,G]),y.createElement(y.Fragment,null,y.createElement("primitive",{ref:I,object:G,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:g,showY:v,showZ:E}),y.createElement("group",_e({ref:z},C),r))}),ok=y.forwardRef(({domElement:r,makeDefault:e,...t},i)=>{const n=de(h=>h.camera),s=de(h=>h.gl),o=de(h=>h.events),a=de(h=>h.get),l=de(h=>h.set),c=r||o.connected||s.domElement,[u]=y.useState(()=>new qS(n,c));return y.useEffect(()=>{if(e){const h=a().controls;return l({controls:u}),()=>l({controls:h})}},[e,u]),We((h,f)=>{u.update(f)},-1),u?y.createElement("primitive",_e({ref:i,object:u},t)):null});/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const yi={LEFT:1,RIGHT:2,MIDDLE:4},ye=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),Co={NONE:0,IN:1,OUT:-1};function jr(r){return r.isPerspectiveCamera}function _r(r){return r.isOrthographicCamera}const Io=Math.PI*2,b1=Math.PI/2,t4=1e-5,nl=Math.PI/180;function cs(r,e,t){return Math.max(e,Math.min(t,r))}function ai(r,e=t4){return Math.abs(r)<e}function Vt(r,e,t=t4){return ai(r-e,t)}function w1(r,e){return Math.round(r/e)*e}function sl(r){return isFinite(r)?r:r<0?-Number.MAX_VALUE:Number.MAX_VALUE}function rl(r){return Math.abs(r)<Number.MAX_VALUE?r:r*(1/0)}function jc(r,e,t,i,n=1/0,s){i=Math.max(1e-4,i);const o=2/i,a=o*s,l=1/(1+a+.48*a*a+.235*a*a*a);let c=r-e;const u=e,h=n*i;c=cs(c,-h,h),e=r-c;const f=(t.value+o*c)*s;t.value=(t.value-o*f)*l;let d=e+(c+f)*l;return u-r>0==d>u&&(d=u,t.value=(d-u)/s),d}function B1(r,e,t,i,n=1/0,s,o){i=Math.max(1e-4,i);const a=2/i,l=a*s,c=1/(1+l+.48*l*l+.235*l*l*l);let u=e.x,h=e.y,f=e.z,d=r.x-u,m=r.y-h,A=r.z-f;const p=u,g=h,v=f,E=n*i,C=E*E,I=d*d+m*m+A*A;if(I>C){const G=Math.sqrt(I);d=d/G*E,m=m/G*E,A=A/G*E}u=r.x-d,h=r.y-m,f=r.z-A;const _=(t.x+a*d)*s,x=(t.y+a*m)*s,S=(t.z+a*A)*s;t.x=(t.x-a*_)*c,t.y=(t.y-a*x)*c,t.z=(t.z-a*S)*c,o.x=u+(d+_)*c,o.y=h+(m+x)*c,o.z=f+(A+S)*c;const b=p-r.x,T=g-r.y,B=v-r.z,w=o.x-p,R=o.y-g,D=o.z-v;return b*w+T*R+B*D>0&&(o.x=p,o.y=g,o.z=v,t.x=(o.x-p)/s,t.y=(o.y-g)/s,t.z=(o.z-v)/s),o}function rd(r,e){e.set(0,0),r.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=r.length,e.y/=r.length}function od(r,e){return _r(r)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class n8{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=i.slice(0);for(let s=0,o=n.length;s<o;s++)n[s].call(this,e)}}}var ad;const s8="2.10.1",Yc=1/8,r8=/Mac/.test((ad=globalThis?.navigator)===null||ad===void 0?void 0:ad.platform);let gt,R1,Wc,ld,pn,St,Ot,_o,ol,_s,xs,Yr,D1,M1,Nn,al,xo,L1,cd,P1,ud,hd,qc,fd=class im extends n8{static install(e){gt=e.THREE,R1=Object.freeze(new gt.Vector3(0,0,0)),Wc=Object.freeze(new gt.Vector3(0,1,0)),ld=Object.freeze(new gt.Vector3(0,0,1)),pn=new gt.Vector2,St=new gt.Vector3,Ot=new gt.Vector3,_o=new gt.Vector3,ol=new gt.Vector3,_s=new gt.Vector3,xs=new gt.Vector3,Yr=new gt.Vector3,D1=new gt.Vector3,M1=new gt.Vector3,Nn=new gt.Spherical,al=new gt.Spherical,xo=new gt.Box3,L1=new gt.Box3,cd=new gt.Sphere,P1=new gt.Quaternion,ud=new gt.Quaternion,hd=new gt.Matrix4,qc=new gt.Raycaster}static get ACTION(){return ye}set verticalDragToForward(e){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=ye.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Co.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new gt.Vector3,this._focalOffsetVelocity=new gt.Vector3,this._zoomVelocity={value:0},this._truckInternal=(g,v,E,C)=>{let I,_;if(jr(this._camera)){const x=St.copy(this._camera.position).sub(this._target),S=this._camera.getEffectiveFOV()*nl,b=x.length()*Math.tan(S*.5);I=this.truckSpeed*g*b/this._elementRect.height,_=this.truckSpeed*v*b/this._elementRect.height}else if(_r(this._camera)){const x=this._camera;I=this.truckSpeed*g*(x.right-x.left)/x.zoom/this._elementRect.width,_=this.truckSpeed*v*(x.top-x.bottom)/x.zoom/this._elementRect.height}else return;C?(E?this.setFocalOffset(this._focalOffsetEnd.x+I,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(I,0,!0),this.forward(-_,!0)):E?this.setFocalOffset(this._focalOffsetEnd.x+I,this._focalOffsetEnd.y+_,this._focalOffsetEnd.z,!0):this.truck(I,_,!0)},this._rotateInternal=(g,v)=>{const E=Io*this.azimuthRotateSpeed*g/this._elementRect.height,C=Io*this.polarRotateSpeed*v/this._elementRect.height;this.rotate(E,C,!0)},this._dollyInternal=(g,v,E)=>{const C=Math.pow(.95,-g*this.dollySpeed),I=this._sphericalEnd.radius,_=this._sphericalEnd.radius*C,x=cs(_,this.minDistance,this.maxDistance),S=x-_;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(_,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(S,!0),this._dollyToNoClamp(x,!0)):this._dollyToNoClamp(x,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?_:x)-I,this._dollyControlCoord.set(v,E)),this._lastDollyDirection=Math.sign(-g)},this._zoomInternal=(g,v,E)=>{const C=Math.pow(.95,g*this.dollySpeed),I=this._zoom,_=this._zoom*C;this.zoomTo(_,!0),this.dollyToCursor&&(this._changedZoom+=_-I,this._dollyControlCoord.set(v,E))},typeof gt>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new gt.Quaternion().setFromUnitVectors(this._camera.up,Wc),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=ye.NONE,this._target=new gt.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new gt.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new gt.Spherical().setFromVector3(St.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new gt.Vector3,new gt.Vector3,new gt.Vector3,new gt.Vector3],this._updateNearPlaneCorners(),this._boundary=new gt.Box3(new gt.Vector3(-1/0,-1/0,-1/0),new gt.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new gt.Vector2,this.mouseButtons={left:ye.ROTATE,middle:ye.DOLLY,right:ye.TRUCK,wheel:jr(this._camera)?ye.DOLLY:_r(this._camera)?ye.ZOOM:ye.NONE},this.touches={one:ye.TOUCH_ROTATE,two:jr(this._camera)?ye.TOUCH_DOLLY_TRUCK:_r(this._camera)?ye.TOUCH_ZOOM_TRUCK:ye.NONE,three:ye.TOUCH_TRUCK};const i=new gt.Vector2,n=new gt.Vector2,s=new gt.Vector2,o=g=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const C=this._domElement.getBoundingClientRect(),I=g.clientX/C.width,_=g.clientY/C.height;if(I<this._interactiveArea.left||I>this._interactiveArea.right||_<this._interactiveArea.top||_>this._interactiveArea.bottom)return}const v=g.pointerType!=="mouse"?null:(g.buttons&yi.LEFT)===yi.LEFT?yi.LEFT:(g.buttons&yi.MIDDLE)===yi.MIDDLE?yi.MIDDLE:(g.buttons&yi.RIGHT)===yi.RIGHT?yi.RIGHT:null;if(v!==null){const C=this._findPointerByMouseButton(v);C&&this._disposePointer(C)}if((g.buttons&yi.LEFT)===yi.LEFT&&this._lockedPointer)return;const E={pointerId:g.pointerId,clientX:g.clientX,clientY:g.clientY,deltaX:0,deltaY:0,mouseButton:v};this._activePointers.push(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,f(g)},a=g=>{g.cancelable&&g.preventDefault();const v=g.pointerId,E=this._lockedPointer||this._findPointerById(v);if(E){if(E.clientX=g.clientX,E.clientY=g.clientY,E.deltaX=g.movementX,E.deltaY=g.movementY,this._state=0,g.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(g.buttons&yi.LEFT)===yi.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(g.buttons&yi.MIDDLE)===yi.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(g.buttons&yi.RIGHT)===yi.RIGHT&&(this._state=this._state|this.mouseButtons.right);d()}},l=g=>{const v=this._findPointerById(g.pointerId);if(!(v&&v===this._lockedPointer)){if(v&&this._disposePointer(v),g.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=ye.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=ye.NONE;m()}};let c=-1;const u=g=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===ye.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const _=this._domElement.getBoundingClientRect(),x=g.clientX/_.width,S=g.clientY/_.height;if(x<this._interactiveArea.left||x>this._interactiveArea.right||S<this._interactiveArea.top||S>this._interactiveArea.bottom)return}if(g.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===ye.ROTATE||this.mouseButtons.wheel===ye.TRUCK){const _=performance.now();c-_<1e3&&this._getClientRect(this._elementRect),c=_}const v=r8?-1:-3,E=g.deltaMode===1||g.ctrlKey?g.deltaY/v:g.deltaY/(v*10),C=this.dollyToCursor?(g.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,I=this.dollyToCursor?(g.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case ye.ROTATE:{this._rotateInternal(g.deltaX,g.deltaY),this._isUserControllingRotate=!0;break}case ye.TRUCK:{this._truckInternal(g.deltaX,g.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case ye.SCREEN_PAN:{this._truckInternal(g.deltaX,g.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case ye.OFFSET:{this._truckInternal(g.deltaX,g.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case ye.DOLLY:{this._dollyInternal(-E,C,I),this._isUserControllingDolly=!0;break}case ye.ZOOM:{this._zoomInternal(-E,C,I),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},h=g=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===im.ACTION.NONE){const v=g instanceof PointerEvent?g.pointerId:0,E=this._findPointerById(v);E&&this._disposePointer(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}g.preventDefault()}},f=g=>{if(!this._enabled)return;if(rd(this._activePointers,pn),this._getClientRect(this._elementRect),i.copy(pn),n.copy(pn),this._activePointers.length>=2){const E=pn.x-this._activePointers[1].clientX,C=pn.y-this._activePointers[1].clientY,I=Math.sqrt(E*E+C*C);s.set(0,I);const _=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,x=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;n.set(_,x)}if(this._state=0,!g)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in g&&g.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(g.buttons&yi.LEFT)===yi.LEFT&&(this._state=this._state|this.mouseButtons.left),(g.buttons&yi.MIDDLE)===yi.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(g.buttons&yi.RIGHT)===yi.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&ye.ROTATE)===ye.ROTATE||(this._state&ye.TOUCH_ROTATE)===ye.TOUCH_ROTATE||(this._state&ye.TOUCH_DOLLY_ROTATE)===ye.TOUCH_DOLLY_ROTATE||(this._state&ye.TOUCH_ZOOM_ROTATE)===ye.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&ye.TRUCK)===ye.TRUCK||(this._state&ye.SCREEN_PAN)===ye.SCREEN_PAN||(this._state&ye.TOUCH_TRUCK)===ye.TOUCH_TRUCK||(this._state&ye.TOUCH_SCREEN_PAN)===ye.TOUCH_SCREEN_PAN||(this._state&ye.TOUCH_DOLLY_TRUCK)===ye.TOUCH_DOLLY_TRUCK||(this._state&ye.TOUCH_DOLLY_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN||(this._state&ye.TOUCH_ZOOM_TRUCK)===ye.TOUCH_ZOOM_TRUCK||(this._state&ye.TOUCH_ZOOM_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&ye.DOLLY)===ye.DOLLY||(this._state&ye.TOUCH_DOLLY)===ye.TOUCH_DOLLY||(this._state&ye.TOUCH_DOLLY_TRUCK)===ye.TOUCH_DOLLY_TRUCK||(this._state&ye.TOUCH_DOLLY_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN||(this._state&ye.TOUCH_DOLLY_OFFSET)===ye.TOUCH_DOLLY_OFFSET||(this._state&ye.TOUCH_DOLLY_ROTATE)===ye.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&ye.ZOOM)===ye.ZOOM||(this._state&ye.TOUCH_ZOOM)===ye.TOUCH_ZOOM||(this._state&ye.TOUCH_ZOOM_TRUCK)===ye.TOUCH_ZOOM_TRUCK||(this._state&ye.TOUCH_ZOOM_SCREEN_PAN)===ye.TOUCH_ZOOM_SCREEN_PAN||(this._state&ye.TOUCH_ZOOM_OFFSET)===ye.TOUCH_ZOOM_OFFSET||(this._state&ye.TOUCH_ZOOM_ROTATE)===ye.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&ye.OFFSET)===ye.OFFSET||(this._state&ye.TOUCH_OFFSET)===ye.TOUCH_OFFSET||(this._state&ye.TOUCH_DOLLY_OFFSET)===ye.TOUCH_DOLLY_OFFSET||(this._state&ye.TOUCH_ZOOM_OFFSET)===ye.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,rd(this._activePointers,pn);const v=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,E=v?-v.deltaX:n.x-pn.x,C=v?-v.deltaY:n.y-pn.y;if(n.copy(pn),((this._state&ye.ROTATE)===ye.ROTATE||(this._state&ye.TOUCH_ROTATE)===ye.TOUCH_ROTATE||(this._state&ye.TOUCH_DOLLY_ROTATE)===ye.TOUCH_DOLLY_ROTATE||(this._state&ye.TOUCH_ZOOM_ROTATE)===ye.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(E,C),this._isUserControllingRotate=!0),(this._state&ye.DOLLY)===ye.DOLLY||(this._state&ye.ZOOM)===ye.ZOOM){const I=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,_=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,x=this.dollyDragInverted?-1:1;(this._state&ye.DOLLY)===ye.DOLLY?(this._dollyInternal(x*C*Yc,I,_),this._isUserControllingDolly=!0):(this._zoomInternal(x*C*Yc,I,_),this._isUserControllingZoom=!0)}if((this._state&ye.TOUCH_DOLLY)===ye.TOUCH_DOLLY||(this._state&ye.TOUCH_ZOOM)===ye.TOUCH_ZOOM||(this._state&ye.TOUCH_DOLLY_TRUCK)===ye.TOUCH_DOLLY_TRUCK||(this._state&ye.TOUCH_ZOOM_TRUCK)===ye.TOUCH_ZOOM_TRUCK||(this._state&ye.TOUCH_DOLLY_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN||(this._state&ye.TOUCH_ZOOM_SCREEN_PAN)===ye.TOUCH_ZOOM_SCREEN_PAN||(this._state&ye.TOUCH_DOLLY_OFFSET)===ye.TOUCH_DOLLY_OFFSET||(this._state&ye.TOUCH_ZOOM_OFFSET)===ye.TOUCH_ZOOM_OFFSET||(this._state&ye.TOUCH_DOLLY_ROTATE)===ye.TOUCH_DOLLY_ROTATE||(this._state&ye.TOUCH_ZOOM_ROTATE)===ye.TOUCH_ZOOM_ROTATE){const I=pn.x-this._activePointers[1].clientX,_=pn.y-this._activePointers[1].clientY,x=Math.sqrt(I*I+_*_),S=s.y-x;s.set(0,x);const b=this.dollyToCursor?(n.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(n.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&ye.TOUCH_DOLLY)===ye.TOUCH_DOLLY||(this._state&ye.TOUCH_DOLLY_ROTATE)===ye.TOUCH_DOLLY_ROTATE||(this._state&ye.TOUCH_DOLLY_TRUCK)===ye.TOUCH_DOLLY_TRUCK||(this._state&ye.TOUCH_DOLLY_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN||(this._state&ye.TOUCH_DOLLY_OFFSET)===ye.TOUCH_DOLLY_OFFSET?(this._dollyInternal(S*Yc,b,T),this._isUserControllingDolly=!0):(this._zoomInternal(S*Yc,b,T),this._isUserControllingZoom=!0)}((this._state&ye.TRUCK)===ye.TRUCK||(this._state&ye.TOUCH_TRUCK)===ye.TOUCH_TRUCK||(this._state&ye.TOUCH_DOLLY_TRUCK)===ye.TOUCH_DOLLY_TRUCK||(this._state&ye.TOUCH_ZOOM_TRUCK)===ye.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(E,C,!1,!1),this._isUserControllingTruck=!0),((this._state&ye.SCREEN_PAN)===ye.SCREEN_PAN||(this._state&ye.TOUCH_SCREEN_PAN)===ye.TOUCH_SCREEN_PAN||(this._state&ye.TOUCH_DOLLY_SCREEN_PAN)===ye.TOUCH_DOLLY_SCREEN_PAN||(this._state&ye.TOUCH_ZOOM_SCREEN_PAN)===ye.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(E,C,!1,!0),this._isUserControllingTruck=!0),((this._state&ye.OFFSET)===ye.OFFSET||(this._state&ye.TOUCH_OFFSET)===ye.TOUCH_OFFSET||(this._state&ye.TOUCH_DOLLY_OFFSET)===ye.TOUCH_DOLLY_OFFSET||(this._state&ye.TOUCH_ZOOM_OFFSET)===ye.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(E,C,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},m=()=>{rd(this._activePointers,pn),n.copy(pn),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",A),this._domElement.ownerDocument.addEventListener("pointerlockerror",p),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),f())},this.unlockPointer=()=>{var g,v,E;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(g=this._domElement)===null||g===void 0||g.ownerDocument.exitPointerLock(),(v=this._domElement)===null||v===void 0||v.ownerDocument.removeEventListener("pointerlockchange",A),(E=this._domElement)===null||E===void 0||E.ownerDocument.removeEventListener("pointerlockerror",p),this.cancel()};const A=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},p=()=>{this.unlockPointer()};this._addAllEventListeners=g=>{this._domElement=g,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",o),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",u,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",o),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",u,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",p))},this.cancel=()=>{this._state!==ye.NONE&&(this._state=ye.NONE,this._activePointers.length=0,m())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=cs(e.width,0,1),this._interactiveArea.height=cs(e.height,0,1),this._interactiveArea.x=cs(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=cs(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,i=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,i)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,i=!1){this._isUserControllingRotate=!1;const n=cs(e,this.minAzimuthAngle,this.maxAzimuthAngle),s=cs(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=n,this._sphericalEnd.phi=s,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const o=!i||Vt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Vt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(o)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Co.NONE,this._changedDolly=0,this._dollyToNoClamp(cs(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const o=this._collisionTest(),a=Vt(o,this._spherical.radius);if(!(i>e)&&a)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,o)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const s=!t||Vt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(ol).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const i=!t||Vt(this._target.x,this._targetEnd.x,this.restThreshold)&&Vt(this._target.y,this._targetEnd.y,this.restThreshold)&&Vt(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=cs(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const i=!t||Vt(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(e,t,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,i)}truck(e,t,i=!1){this._camera.updateMatrix(),_s.setFromMatrixColumn(this._camera.matrix,0),xs.setFromMatrixColumn(this._camera.matrix,1),_s.multiplyScalar(e),xs.multiplyScalar(-t);const n=St.copy(_s).add(xs),s=Ot.copy(this._targetEnd).add(n);return this.moveTo(s.x,s.y,s.z,i)}forward(e,t=!1){St.setFromMatrixColumn(this._camera.matrix,0),St.crossVectors(this._camera.up,St),St.multiplyScalar(e);const i=Ot.copy(this._targetEnd).add(St);return this.moveTo(i.x,i.y,i.z,t)}elevate(e,t=!1){return St.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+St.x,this._targetEnd.y+St.y,this._targetEnd.z+St.z,t)}moveTo(e,t,i,n=!1){this._isUserControllingTruck=!1;const s=St.set(e,t,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,s,this.boundaryFriction),this._needsUpdate=!0,n||this._target.copy(this._targetEnd);const o=!n||Vt(this._target.x,this._targetEnd.x,this.restThreshold)&&Vt(this._target.y,this._targetEnd.y,this.restThreshold)&&Vt(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(o)}lookInDirectionOf(e,t,i,n=!1){const a=St.set(e,t,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(a.x,a.y,a.z,n)}fitToBox(e,t,{cover:i=!1,paddingLeft:n=0,paddingRight:s=0,paddingBottom:o=0,paddingTop:a=0}={}){const l=[],c=e.isBox3?xo.copy(e):xo.setFromObject(e);c.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const u=w1(this._sphericalEnd.theta,b1),h=w1(this._sphericalEnd.phi,b1);l.push(this.rotateTo(u,h,t));const f=St.setFromSpherical(this._sphericalEnd).normalize(),d=P1.setFromUnitVectors(f,ld),m=Vt(Math.abs(f.y),1);m&&d.multiply(ud.setFromAxisAngle(Wc,u)),d.multiply(this._yAxisUpSpaceInverse);const A=L1.makeEmpty();Ot.copy(c.min).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.min).setX(c.max.x).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.min).setY(c.max.y).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.max).setZ(c.min.z).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.min).setZ(c.max.z).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.max).setY(c.min.y).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.max).setX(c.min.x).applyQuaternion(d),A.expandByPoint(Ot),Ot.copy(c.max).applyQuaternion(d),A.expandByPoint(Ot),A.min.x-=n,A.min.y-=o,A.max.x+=s,A.max.y+=a,d.setFromUnitVectors(ld,f),m&&d.premultiply(ud.invert()),d.premultiply(this._yAxisUpSpace);const p=A.getSize(St),g=A.getCenter(Ot).applyQuaternion(d);if(jr(this._camera)){const v=this.getDistanceToFitBox(p.x,p.y,p.z,i);l.push(this.moveTo(g.x,g.y,g.z,t)),l.push(this.dollyTo(v,t)),l.push(this.setFocalOffset(0,0,0,t))}else if(_r(this._camera)){const v=this._camera,E=v.right-v.left,C=v.top-v.bottom,I=i?Math.max(E/p.x,C/p.y):Math.min(E/p.x,C/p.y);l.push(this.moveTo(g.x,g.y,g.z,t)),l.push(this.zoomTo(I,t)),l.push(this.setFocalOffset(0,0,0,t))}return Promise.all(l)}fitToSphere(e,t){const i=[],s="isObject3D"in e?im.createBoundingSphere(e,cd):cd.copy(e);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,t)),jr(this._camera)){const o=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(o,t))}else if(_r(this._camera)){const o=this._camera.right-this._camera.left,a=this._camera.top-this._camera.bottom,l=2*s.radius,c=Math.min(o/l,a/l);i.push(this.zoomTo(c,t))}return i.push(this.setFocalOffset(0,0,0,t)),Promise.all(i)}setLookAt(e,t,i,n,s,o,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Co.NONE,this._changedDolly=0;const l=Ot.set(n,s,o),c=St.set(e,t,i);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(c.sub(l).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!a||Vt(this._target.x,this._targetEnd.x,this.restThreshold)&&Vt(this._target.y,this._targetEnd.y,this.restThreshold)&&Vt(this._target.z,this._targetEnd.z,this.restThreshold)&&Vt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Vt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Vt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerpLookAt(e,t,i,n,s,o,a,l,c,u,h,f,d,m=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Co.NONE,this._changedDolly=0;const A=St.set(n,s,o),p=Ot.set(e,t,i);Nn.setFromVector3(p.sub(A).applyQuaternion(this._yAxisUpSpace));const g=_o.set(u,h,f),v=Ot.set(a,l,c);al.setFromVector3(v.sub(g).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(A.lerp(g,d));const E=al.theta-Nn.theta,C=al.phi-Nn.phi,I=al.radius-Nn.radius;this._sphericalEnd.set(Nn.radius+I*d,Nn.phi+C*d,Nn.theta+E*d),this.normalizeRotations(),this._needsUpdate=!0,m||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const _=!m||Vt(this._target.x,this._targetEnd.x,this.restThreshold)&&Vt(this._target.y,this._targetEnd.y,this.restThreshold)&&Vt(this._target.z,this._targetEnd.z,this.restThreshold)&&Vt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Vt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Vt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(_)}setPosition(e,t,i,n=!1){return this.setLookAt(e,t,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,n)}setTarget(e,t,i,n=!1){const s=this.getPosition(St),o=this.setLookAt(s.x,s.y,s.z,e,t,i,n);return this._sphericalEnd.phi=cs(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),o}setFocalOffset(e,t,i,n=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,i),this._needsUpdate=!0,n||this._focalOffset.copy(this._focalOffsetEnd);const s=!n||Vt(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Vt(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Vt(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}setOrbitPoint(e,t,i){this._camera.updateMatrixWorld(),_s.setFromMatrixColumn(this._camera.matrixWorldInverse,0),xs.setFromMatrixColumn(this._camera.matrixWorldInverse,1),Yr.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const n=St.set(e,t,i),s=n.distanceTo(this._camera.position),o=n.sub(this._camera.position);_s.multiplyScalar(o.x),xs.multiplyScalar(o.y),Yr.multiplyScalar(o.z),St.copy(_s).add(xs).add(Yr),St.z=St.z+s,this.dollyTo(s,!1),this.setFocalOffset(-St.x,St.y,-St.z,!1),this.moveTo(e,t,i,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,i,n){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new gt.Vector4,typeof e=="number"?this._viewport.set(e,t,i,n):this._viewport.copy(e)}getDistanceToFitBox(e,t,i,n=!1){if(od(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const s=e/t,o=this._camera.getEffectiveFOV()*nl,a=this._camera.aspect;return((n?s>a:s<a)?t:e/a)*.5/Math.tan(o*.5)+i*.5}getDistanceToFitSphere(e){if(od(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*nl,i=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,n=1<this._camera.aspect?t:i;return e/Math.sin(n*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new gt.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new gt.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new gt.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new gt.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Io,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Io),this._spherical.theta+=Io*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Io)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!Vt(this._camera.up.x,this._cameraUp0.x)||!Vt(this._camera.up.y,this._cameraUp0.y)||!Vt(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const i=this.getPosition(St);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,Wc),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=St.subVectors(this._target,this._camera.position).normalize(),t=Ot.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(St);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,n=this._sphericalEnd.radius-this._spherical.radius,s=D1.subVectors(this._targetEnd,this._target),o=M1.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(ai(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=jc(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,h,1/0,e),this._needsUpdate=!0}if(ai(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=jc(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,h,1/0,e),this._needsUpdate=!0}if(ai(n))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const h=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=jc(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,h,this.maxSpeed,e),this._needsUpdate=!0}if(ai(s.x)&&ai(s.y)&&ai(s.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const h=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;B1(this._target,this._targetEnd,this._targetVelocity,h,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(ai(o.x)&&ai(o.y)&&ai(o.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const h=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;B1(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,h,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(ai(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const h=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=jc(this._zoom,this._zoomEnd,this._zoomVelocity,h,1/0,e)}if(this.dollyToCursor){if(jr(this._camera)&&this._changedDolly!==0){const h=this._spherical.radius-this._lastDistance,f=this._camera,d=this._getCameraDirection(ol),m=St.copy(d).cross(f.up).normalize();m.lengthSq()===0&&(m.x=1);const A=Ot.crossVectors(m,d),p=this._sphericalEnd.radius*Math.tan(f.getEffectiveFOV()*nl*.5),v=(this._sphericalEnd.radius-h-this._sphericalEnd.radius)/this._sphericalEnd.radius,E=_o.copy(this._targetEnd).add(m.multiplyScalar(this._dollyControlCoord.x*p*f.aspect)).add(A.multiplyScalar(this._dollyControlCoord.y*p)),C=St.copy(this._targetEnd).lerp(E,v),I=this._lastDollyDirection===Co.IN&&this._spherical.radius<=this.minDistance,_=this._lastDollyDirection===Co.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(I||_)){this._sphericalEnd.radius-=h,this._spherical.radius-=h;const S=Ot.copy(d).multiplyScalar(-h);C.add(S)}this._boundary.clampPoint(C,C);const x=Ot.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(x),this._changedDolly-=h,ai(this._changedDolly)&&(this._changedDolly=0)}else if(_r(this._camera)&&this._changedZoom!==0){const h=this._zoom-this._lastZoom,f=this._camera,d=St.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(f.near+f.far)/(f.near-f.far)).unproject(f),m=Ot.set(0,0,-1).applyQuaternion(f.quaternion),A=_o.copy(d).add(m.multiplyScalar(-d.dot(f.up))),g=-(this._zoom-h-this._zoom)/this._zoom,v=this._getCameraDirection(ol),E=this._targetEnd.dot(v),C=St.copy(this._targetEnd).lerp(A,g),I=C.dot(v),_=v.multiplyScalar(I-E);C.sub(_),this._boundary.clampPoint(C,C);const x=Ot.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(x),this._changedZoom-=h,ai(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!ai(this._focalOffset.x)||!ai(this._focalOffset.y)||!ai(this._focalOffset.z))&&(_s.setFromMatrixColumn(this._camera.matrix,0),xs.setFromMatrixColumn(this._camera.matrix,1),Yr.setFromMatrixColumn(this._camera.matrix,2),_s.multiplyScalar(this._focalOffset.x),xs.multiplyScalar(-this._focalOffset.y),Yr.multiplyScalar(this._focalOffset.z),St.copy(_s).add(xs).add(Yr),this._camera.position.add(St),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),St.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const u=this._needsUpdate;return u&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):u?(this.dispatchEvent({type:"update"}),ai(t,this.restThreshold)&&ai(i,this.restThreshold)&&ai(n,this.restThreshold)&&ai(s.x,this.restThreshold)&&ai(s.y,this.restThreshold)&&ai(s.z,this.restThreshold)&&ai(o.x,this.restThreshold)&&ai(o.y,this.restThreshold)&&ai(o.z,this.restThreshold)&&ai(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!u&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=u,this._needsUpdate=!1,u}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:sl(this.maxDistance),minZoom:this.minZoom,maxZoom:sl(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:sl(this.maxPolarAngle),minAzimuthAngle:sl(this.minAzimuthAngle),maxAzimuthAngle:sl(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:St.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const i=JSON.parse(e);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=rl(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=rl(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=rl(i.maxPolarAngle),this.minAzimuthAngle=rl(i.minAzimuthAngle),this.maxAzimuthAngle=rl(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],t),Nn.setFromVector3(St.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Nn.theta,Nn.phi,t),this.dollyTo(Nn.radius,t),this.zoomTo(i.zoom,t),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",s8),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,i){const n=t.lengthSq();if(n===0)return e;const s=Ot.copy(t).add(e),a=this._boundary.clampPoint(s,_o).sub(s),l=a.lengthSq();if(l===0)return e.add(t);if(l===n)return e;if(i===0)return e.add(t).add(a);{const c=1+i*l/t.dot(a);return e.add(Ot.copy(t).multiplyScalar(c)).add(a.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(jr(this._camera)){const e=this._camera,t=e.near,i=e.getEffectiveFOV()*nl,n=Math.tan(i*.5)*t,s=n*e.aspect;this._nearPlaneCorners[0].set(-s,-n,0),this._nearPlaneCorners[1].set(s,-n,0),this._nearPlaneCorners[2].set(s,n,0),this._nearPlaneCorners[3].set(-s,n,0)}else if(_r(this._camera)){const e=this._camera,t=1/e.zoom,i=e.left*t,n=e.right*t,s=e.top*t,o=e.bottom*t;this._nearPlaneCorners[0].set(i,s,0),this._nearPlaneCorners[1].set(n,s,0),this._nearPlaneCorners[2].set(n,o,0),this._nearPlaneCorners[3].set(i,o,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||od(this._camera,"_collisionTest"))return e;const i=this._getTargetDirection(ol);hd.lookAt(R1,i,this._camera.up);for(let n=0;n<4;n++){const s=Ot.copy(this._nearPlaneCorners[n]);s.applyMatrix4(hd);const o=_o.addVectors(this._target,s);qc.set(o,i),qc.far=this._spherical.radius+1;const a=qc.intersectObjects(this.colliderMeshes);a.length!==0&&a[0].distance<e&&(e=a[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const i=()=>{this.removeEventListener("rest",i),t()};this.addEventListener("rest",i)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new gt.Sphere){const i=t,n=i.center;xo.makeEmpty(),e.traverseVisible(o=>{o.isMesh&&xo.expandByObject(o)}),xo.getCenter(n);let s=0;return e.traverseVisible(o=>{if(!o.isMesh)return;const a=o;if(!a.geometry)return;const l=a.geometry.clone();l.applyMatrix4(a.matrixWorld);const u=l.attributes.position;for(let h=0,f=u.count;h<f;h++)St.fromBufferAttribute(u,h),s=Math.max(s,n.distanceToSquared(St))}),i.radius=Math.sqrt(s),i}};const ak=y.forwardRef((r,e)=>{y.useMemo(()=>{const I={Box3:oi,MathUtils:{clamp:ot.clamp},Matrix4:Me,Quaternion:ht,Raycaster:Th,Sphere:un,Spherical:fa,Vector2:Fe,Vector3:K,Vector4:Ci};fd.install({THREE:I}),xi({CameraControlsImpl:fd})},[]);const{camera:t,domElement:i,makeDefault:n,onStart:s,onEnd:o,onChange:a,regress:l,...c}=r,u=de(I=>I.camera),h=de(I=>I.gl),f=de(I=>I.invalidate),d=de(I=>I.events),m=de(I=>I.setEvents),A=de(I=>I.set),p=de(I=>I.get),g=de(I=>I.performance),v=t||u,E=i||d.connected||h.domElement,C=y.useMemo(()=>new fd(v),[v]);return We((I,_)=>{C.enabled&&C.update(_)},-1),y.useEffect(()=>(C.connect(E),()=>void C.disconnect()),[E,C]),y.useEffect(()=>{const I=S=>{f(),l&&g.regress(),a&&a(S)},_=S=>{s&&s(S)},x=S=>{o&&o(S)};return C.addEventListener("update",I),C.addEventListener("controlstart",_),C.addEventListener("controlend",x),C.addEventListener("control",I),C.addEventListener("transitionstart",I),C.addEventListener("wake",I),()=>{C.removeEventListener("update",I),C.removeEventListener("controlstart",_),C.removeEventListener("controlend",x),C.removeEventListener("control",I),C.removeEventListener("transitionstart",I),C.removeEventListener("wake",I)}},[C,s,o,f,m,l,a]),y.useEffect(()=>{if(n){const I=p().controls;return A({controls:C}),()=>A({controls:I})}},[n,C]),y.createElement("primitive",_e({ref:e,object:C},c))}),o8=r=>r?.current instanceof Ei,i4=y.createContext(null);function a8(){const r=y.useContext(i4);if(!r)throw new Error("useMotion hook must be used in a MotionPathControls component.");return r}function l8({points:r=50,color:e="black"}){const{path:t}=a8(),[i,n]=y.useState([]),s=y.useMemo(()=>new ms({color:e}),[e]),o=y.useMemo(()=>new D2(.025,16,16),[]),a=y.useRef([]);return y.useEffect(()=>{t.curves!==a.current&&(n(t.getPoints(r)),a.current=t.curves)}),i.map((l,c)=>y.createElement("mesh",{key:c,material:s,geometry:o,position:[l.x,l.y,l.z]}))}const lk=y.forwardRef(({children:r,curves:e=[],debug:t=!1,debugColor:i="black",object:n,focus:s,loop:o=!0,offset:a=void 0,smooth:l=!1,eps:c=1e-5,damping:u=.1,focusDamping:h=.1,maxSpeed:f=1/0,...d},m)=>{const{camera:A}=de(),p=y.useRef(null),g=y.useRef(a??0),v=y.useMemo(()=>new E_,[]),E=y.useMemo(()=>({focus:s,object:n?.current instanceof Ei?n:{current:A},path:v,current:g.current,offset:g.current,point:new K,tangent:new K,next:new K}),[s,n]);y.useLayoutEffect(()=>{var I,_;v.curves=[];const x=e.length>0?e:(I=(_=p.current)==null||(_=_.__r3f)==null?void 0:_.objects)!==null&&I!==void 0?I:[];for(let S=0;S<x.length;S++)v.add(x[S]);if(l){const S=v.getPoints(typeof l=="number"?l:1),b=new z2(S);v.curves=[b]}v.updateArcLengths()}),y.useImperativeHandle(m,()=>Object.assign(p.current,{motion:E}),[E]),y.useLayoutEffect(()=>{g.current=Bc.repeat(g.current,1)},[a]);const C=y.useMemo(()=>new K,[]);return We((I,_)=>{const x=E.offset;if(da.damp(g,"current",a!==void 0?a:E.current,u,_,f,void 0,c),E.offset=o?Bc.repeat(g.current,1):Bc.clamp(g.current,0,1),v.getCurveLengths().length>0){v.getPointAt(E.offset,E.point),v.getTangentAt(E.offset,E.tangent).normalize(),v.getPointAt(Bc.repeat(g.current-(x-E.offset),1),E.next);const S=n?.current instanceof Ei?n.current:A;S.position.copy(E.point),s&&da.dampLookAt(S,o8(s)?s.current.getWorldPosition(C):s,h,_,f,void 0,c)}}),y.createElement("group",_e({ref:p},d),y.createElement(i4.Provider,{value:E},r,t&&y.createElement(l8,{color:i})))});function c8({defaultScene:r,defaultCamera:e,renderPriority:t=1}){const{gl:i,scene:n,camera:s}=de();let o;return We(()=>{o=i.autoClear,t===1&&(i.autoClear=!0,i.render(r,e)),i.autoClear=!1,i.clearDepth(),i.render(n,s),i.autoClear=o},t),y.createElement("group",{onPointerOver:()=>null})}function u8({children:r,renderPriority:e=1}){const{scene:t,camera:i}=de(),[n]=y.useState(()=>new Nr);return y.createElement(y.Fragment,null,uo(y.createElement(y.Fragment,null,r,y.createElement(c8,{defaultScene:t,defaultCamera:i,renderPriority:e})),n,{events:{priority:e+1}}))}const n4=y.createContext({}),pA=()=>y.useContext(n4),h8=2*Math.PI,dd=new Ei,F1=new Me,[So,md]=[new ht,new ht],k1=new K,O1=new K,f8=r=>"minPolarAngle"in r,U1=r=>"getTarget"in r,ck=({alignment:r="bottom-right",margin:e=[80,80],renderPriority:t=1,onUpdate:i,onTarget:n,children:s})=>{const o=de(_=>_.size),a=de(_=>_.camera),l=de(_=>_.controls),c=de(_=>_.invalidate),u=y.useRef(null),h=y.useRef(null),f=y.useRef(!1),d=y.useRef(0),m=y.useRef(new K(0,0,0)),A=y.useRef(new K(0,0,0));y.useEffect(()=>{A.current.copy(a.up),dd.up.copy(a.up)},[a]);const p=y.useCallback(_=>{f.current=!0,(l||n)&&(m.current=n?.()||(U1(l)?l.getTarget(m.current):l?.target)),d.current=a.position.distanceTo(k1),So.copy(a.quaternion),O1.copy(_).multiplyScalar(d.current).add(k1),dd.lookAt(O1),md.copy(dd.quaternion),c()},[l,a,n,c]);We((_,x)=>{if(h.current&&u.current){var S;if(f.current)if(So.angleTo(md)<.01)f.current=!1,f8(l)&&a.up.copy(A.current);else{const b=x*h8;So.rotateTowards(md,b),a.position.set(0,0,1).applyQuaternion(So).multiplyScalar(d.current).add(m.current),a.up.set(0,1,0).applyQuaternion(So).normalize(),a.quaternion.copy(So),U1(l)&&l.setPosition(a.position.x,a.position.y,a.position.z),i?i():l&&l.update(x),c()}F1.copy(a.matrix).invert(),(S=u.current)==null||S.quaternion.setFromRotationMatrix(F1)}});const g=y.useMemo(()=>({tweenCamera:p}),[p]),[v,E]=e,C=r.endsWith("-center")?0:r.endsWith("-left")?-o.width/2+v:o.width/2-v,I=r.startsWith("center-")?0:r.startsWith("top-")?o.height/2-E:-o.height/2+E;return y.createElement(u8,{renderPriority:t},y.createElement(n4.Provider,{value:g},y.createElement(e8,{makeDefault:!0,ref:h,position:[0,0,200]}),y.createElement("group",{ref:u,position:[C,I,0]},s)))},bl={bg:"#f0f0f0",hover:"#999",text:"black",stroke:"black"},d8=["Right","Left","Top","Bottom","Front","Back"],s4=r=>new K(...r).multiplyScalar(.38),m8=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(s4),A8=[.25,.25,.25],r4=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(s4),p8=r4.map(r=>r.toArray().map(e=>e==0?.5:.25)),g8=({hover:r,index:e,font:t="20px Inter var, Arial, sans-serif",faces:i=d8,color:n=bl.bg,hoverColor:s=bl.hover,textColor:o=bl.text,strokeColor:a=bl.stroke,opacity:l=1})=>{const c=de(h=>h.gl),u=y.useMemo(()=>{const h=document.createElement("canvas");h.width=128,h.height=128;const f=h.getContext("2d");return f.fillStyle=n,f.fillRect(0,0,h.width,h.height),f.strokeStyle=a,f.strokeRect(0,0,h.width,h.height),f.font=t,f.textAlign="center",f.fillStyle=o,f.fillText(i[e].toUpperCase(),64,76),new Y2(h)},[e,i,t,n,o,a]);return y.createElement("meshBasicMaterial",{map:u,"map-anisotropy":c.capabilities.getMaxAnisotropy()||1,attach:`material-${e}`,color:r?s:"white",transparent:!0,opacity:l})},y8=r=>{const{tweenCamera:e}=pA(),[t,i]=y.useState(null),n=a=>{a.stopPropagation(),i(null)},s=a=>{a.stopPropagation(),e(a.face.normal)},o=a=>{a.stopPropagation(),i(Math.floor(a.faceIndex/2))};return y.createElement("mesh",{onPointerOut:n,onPointerMove:o,onClick:r.onClick||s},[...Array(6)].map((a,l)=>y.createElement(g8,_e({key:l,index:l,hover:t===l},r))),y.createElement("boxGeometry",null))},N1=({onClick:r,dimensions:e,position:t,hoverColor:i=bl.hover})=>{const{tweenCamera:n}=pA(),[s,o]=y.useState(!1),a=u=>{u.stopPropagation(),o(!1)},l=u=>{u.stopPropagation(),o(!0)},c=u=>{u.stopPropagation(),n(t)};return y.createElement("mesh",{scale:1.01,position:t,onPointerOver:l,onPointerOut:a,onClick:r||c},y.createElement("meshBasicMaterial",{color:s?i:"white",transparent:!0,opacity:.6,visible:s}),y.createElement("boxGeometry",{args:e}))},uk=r=>y.createElement("group",{scale:[60,60,60]},y.createElement(y8,r),r4.map((e,t)=>y.createElement(N1,_e({key:t,position:e,dimensions:p8[t]},r))),m8.map((e,t)=>y.createElement(N1,_e({key:t,position:e,dimensions:A8},r))));function Ad({scale:r=[.8,.05,.05],color:e,rotation:t}){return y.createElement("group",{rotation:t},y.createElement("mesh",{position:[.4,0,0]},y.createElement("boxGeometry",{args:r}),y.createElement("meshBasicMaterial",{color:e,toneMapped:!1})))}function To({onClick:r,font:e,disabled:t,arcStyle:i,label:n,labelColor:s,axisHeadScale:o=1,...a}){const l=de(A=>A.gl),c=y.useMemo(()=>{const A=document.createElement("canvas");A.width=64,A.height=64;const p=A.getContext("2d");return p.beginPath(),p.arc(32,32,16,0,2*Math.PI),p.closePath(),p.fillStyle=i,p.fill(),n&&(p.font=e,p.textAlign="center",p.fillStyle=s,p.fillText(n,32,41)),new Y2(A)},[i,n,s,e]),[u,h]=y.useState(!1),f=(n?1:.75)*(u?1.2:1)*o,d=A=>{A.stopPropagation(),h(!0)},m=A=>{A.stopPropagation(),h(!1)};return y.createElement("sprite",_e({scale:f,onPointerOver:t?void 0:d,onPointerOut:t?void 0:r||m},a),y.createElement("spriteMaterial",{map:c,"map-anisotropy":l.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:n?1:.75,toneMapped:!1}))}const hk=({hideNegativeAxes:r,hideAxisHeads:e,disabled:t,font:i="18px Inter var, Arial, sans-serif",axisColors:n=["#ff2060","#20df80","#2080ff"],axisHeadScale:s=1,axisScale:o,labels:a=["X","Y","Z"],labelColor:l="#000",onClick:c,...u})=>{const[h,f,d]=n,{tweenCamera:m}=pA(),A={font:i,disabled:t,labelColor:l,onClick:c,axisHeadScale:s,onPointerDown:t?void 0:p=>{m(p.object.position),p.stopPropagation()}};return y.createElement("group",_e({scale:40},u),y.createElement(Ad,{color:h,rotation:[0,0,0],scale:o}),y.createElement(Ad,{color:f,rotation:[0,0,Math.PI/2],scale:o}),y.createElement(Ad,{color:d,rotation:[0,-Math.PI/2,0],scale:o}),!e&&y.createElement(y.Fragment,null,y.createElement(To,_e({arcStyle:h,position:[1,0,0],label:a[0]},A)),y.createElement(To,_e({arcStyle:f,position:[0,1,0],label:a[1]},A)),y.createElement(To,_e({arcStyle:d,position:[0,0,1],label:a[2]},A)),!r&&y.createElement(y.Fragment,null,y.createElement(To,_e({arcStyle:h,position:[-1,0,0]},A)),y.createElement(To,_e({arcStyle:f,position:[0,-1,0]},A)),y.createElement(To,_e({arcStyle:d,position:[0,0,-1]},A)))))},v8=vs({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new et,sectionColor:new et,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new K,worldPlanePosition:new K},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),fk=y.forwardRef(({args:r,cellColor:e="#000000",sectionColor:t="#2080ff",cellSize:i=.5,sectionSize:n=1,followCamera:s=!1,infiniteGrid:o=!1,fadeDistance:a=100,fadeStrength:l=1,fadeFrom:c=1,cellThickness:u=.5,sectionThickness:h=1,side:f=hc,...d},m)=>{xi({GridMaterial:v8});const A=y.useRef(null);y.useImperativeHandle(m,()=>A.current,[]);const p=new Hs,g=new K(0,1,0),v=new K(0,0,0);We(I=>{p.setFromNormalAndCoplanarPoint(g,v).applyMatrix4(A.current.matrixWorld);const _=A.current.material,x=_.uniforms.worldCamProjPosition,S=_.uniforms.worldPlanePosition;p.projectPoint(I.camera.position,x.value),S.value.set(0,0,0).applyMatrix4(A.current.matrixWorld)});const E={cellSize:i,sectionSize:n,cellColor:e,sectionColor:t,cellThickness:u,sectionThickness:h},C={fadeDistance:a,fadeStrength:l,fadeFrom:c,infiniteGrid:o,followCamera:s};return y.createElement("mesh",_e({ref:A,frustumCulled:!1},d),y.createElement("gridMaterial",_e({transparent:!0,"extensions-derivatives":!0,side:f},E,C)),y.createElement("planeGeometry",{args:r}))});function o4(r,{path:e}){const[t]=gi(Gm,[r],i=>i.setPath(e));return t}o4.preload=(r,{path:e})=>gi.preload(Gm,[r],t=>t.setPath(e));function dk({children:r,files:e,...t}){const i=o4(e,{...t});return y.createElement(y.Fragment,null,r?.(i))}function gA(r){return gi(cA,r)}gA.preload=r=>gi.preload(cA,r);gA.clear=r=>gi.clear(cA,r);function mk({path:r,...e}){const i=gA(r).children[0];return y.createElement(dh,_e({},e,{object:i}))}const a4="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function yA(r,e=`${a4}/basis/`){const t=de(n=>n.gl),i=gi(hA,Ul(r)?Object.values(r):r,n=>{n.detectSupport(t),n.setTranscoderPath(e)});if(y.useEffect(()=>{(Array.isArray(i)?i:[i]).forEach(t.initTexture)},[t,i]),Ul(r)){const n=Object.keys(r),s={};return n.forEach(o=>Object.assign(s,{[o]:i[n.indexOf(o)]})),s}else return i}yA.preload=(r,e=`${a4}/basis/`)=>gi.preload(hA,r,t=>{t.setTranscoderPath(e)});yA.clear=r=>gi.clear(hA,r);const Ak=({children:r,input:e,basisPath:t})=>{const i=yA(e,t);return y.createElement(y.Fragment,null,r?.(i))},Ye=Number.isFinite||function(r){return typeof r=="number"&&isFinite(r)},E8=Number.isSafeInteger||function(r){return typeof r=="number"&&Math.abs(r)<=C8},C8=Number.MAX_SAFE_INTEGER||9007199254740991;let nt=function(r){return r.NETWORK_ERROR="networkError",r.MEDIA_ERROR="mediaError",r.KEY_SYSTEM_ERROR="keySystemError",r.MUX_ERROR="muxError",r.OTHER_ERROR="otherError",r}({}),me=function(r){return r.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",r.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",r.KEY_SYSTEM_NO_SESSION="keySystemNoSession",r.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",r.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",r.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",r.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",r.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",r.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",r.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",r.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",r.MANIFEST_LOAD_ERROR="manifestLoadError",r.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",r.MANIFEST_PARSING_ERROR="manifestParsingError",r.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",r.LEVEL_EMPTY_ERROR="levelEmptyError",r.LEVEL_LOAD_ERROR="levelLoadError",r.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",r.LEVEL_PARSING_ERROR="levelParsingError",r.LEVEL_SWITCH_ERROR="levelSwitchError",r.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",r.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",r.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",r.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",r.FRAG_LOAD_ERROR="fragLoadError",r.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",r.FRAG_DECRYPT_ERROR="fragDecryptError",r.FRAG_PARSING_ERROR="fragParsingError",r.FRAG_GAP="fragGap",r.REMUX_ALLOC_ERROR="remuxAllocError",r.KEY_LOAD_ERROR="keyLoadError",r.KEY_LOAD_TIMEOUT="keyLoadTimeOut",r.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",r.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",r.BUFFER_APPEND_ERROR="bufferAppendError",r.BUFFER_APPENDING_ERROR="bufferAppendingError",r.BUFFER_STALLED_ERROR="bufferStalledError",r.BUFFER_FULL_ERROR="bufferFullError",r.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",r.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",r.ASSET_LIST_LOAD_ERROR="assetListLoadError",r.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",r.ASSET_LIST_PARSING_ERROR="assetListParsingError",r.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",r.INTERNAL_EXCEPTION="internalException",r.INTERNAL_ABORTED="aborted",r.ATTACH_MEDIA_ERROR="attachMediaError",r.UNKNOWN="unknown",r}({}),M=function(r){return r.MEDIA_ATTACHING="hlsMediaAttaching",r.MEDIA_ATTACHED="hlsMediaAttached",r.MEDIA_DETACHING="hlsMediaDetaching",r.MEDIA_DETACHED="hlsMediaDetached",r.MEDIA_ENDED="hlsMediaEnded",r.STALL_RESOLVED="hlsStallResolved",r.BUFFER_RESET="hlsBufferReset",r.BUFFER_CODECS="hlsBufferCodecs",r.BUFFER_CREATED="hlsBufferCreated",r.BUFFER_APPENDING="hlsBufferAppending",r.BUFFER_APPENDED="hlsBufferAppended",r.BUFFER_EOS="hlsBufferEos",r.BUFFERED_TO_END="hlsBufferedToEnd",r.BUFFER_FLUSHING="hlsBufferFlushing",r.BUFFER_FLUSHED="hlsBufferFlushed",r.MANIFEST_LOADING="hlsManifestLoading",r.MANIFEST_LOADED="hlsManifestLoaded",r.MANIFEST_PARSED="hlsManifestParsed",r.LEVEL_SWITCHING="hlsLevelSwitching",r.LEVEL_SWITCHED="hlsLevelSwitched",r.LEVEL_LOADING="hlsLevelLoading",r.LEVEL_LOADED="hlsLevelLoaded",r.LEVEL_UPDATED="hlsLevelUpdated",r.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",r.LEVELS_UPDATED="hlsLevelsUpdated",r.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",r.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",r.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",r.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",r.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",r.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",r.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",r.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",r.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",r.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",r.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",r.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",r.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",r.CUES_PARSED="hlsCuesParsed",r.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",r.INIT_PTS_FOUND="hlsInitPtsFound",r.FRAG_LOADING="hlsFragLoading",r.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",r.FRAG_LOADED="hlsFragLoaded",r.FRAG_DECRYPTED="hlsFragDecrypted",r.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",r.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",r.FRAG_PARSING_METADATA="hlsFragParsingMetadata",r.FRAG_PARSED="hlsFragParsed",r.FRAG_BUFFERED="hlsFragBuffered",r.FRAG_CHANGED="hlsFragChanged",r.FPS_DROP="hlsFpsDrop",r.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",r.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",r.ERROR="hlsError",r.DESTROYING="hlsDestroying",r.KEY_LOADING="hlsKeyLoading",r.KEY_LOADED="hlsKeyLoaded",r.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",r.BACK_BUFFER_REACHED="hlsBackBufferReached",r.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",r.ASSET_LIST_LOADING="hlsAssetListLoading",r.ASSET_LIST_LOADED="hlsAssetListLoaded",r.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",r.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",r.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",r.INTERSTITIAL_STARTED="hlsInterstitialStarted",r.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",r.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",r.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",r.INTERSTITIAL_ENDED="hlsInterstitialEnded",r.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",r.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",r.EVENT_CUE_ENTER="hlsEventCueEnter",r}({});var Bt={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},it={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class bo{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class I8{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new bo(e),this.fast_=new bo(t),this.defaultTTFB_=n,this.ttfb_=new bo(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:s}=this;i.halfLife!==e&&(this.slow_=new bo(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new bo(t,n.getEstimate(),n.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new bo(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,s=i/n;this.fast_.sample(n,s),this.slow_.sample(n,s)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function _8(r,e,t){return(e=S8(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function ei(){return ei=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},ei.apply(null,arguments)}function G1(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function Kt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?G1(Object(t),!0).forEach(function(i){_8(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):G1(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function x8(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function S8(r){var e=x8(r,"string");return typeof e=="symbol"?e:e+""}class dr{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Sr,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Sr=function(){},T8={trace:Sr,debug:Sr,log:Sr,warn:Sr,info:Sr,error:Sr};function nm(){return ei({},T8)}function b8(r,e){const t=self.console[r];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${r}] >`):Sr}function Q1(r,e,t){return e[r]?e[r].bind(e):b8(r,t)}const sm=nm();function w8(r,e,t){const i=nm();if(typeof console=="object"&&r===!0||typeof r=="object"){const n=["debug","log","info","warn","error"];n.forEach(s=>{i[s]=Q1(s,r,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.2`)}catch{return nm()}n.forEach(s=>{sm[s]=Q1(s,r)})}else ei(sm,i);return i}const Lt=sm;function ur(r=!0){return typeof self>"u"?void 0:(r||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function B8(r){return typeof self<"u"&&r===self.ManagedMediaSource}function l4(r,e){const t=Object.keys(r),i=Object.keys(e),n=t.length,s=i.length;return!n||!s||n===s&&!t.some(o=>i.indexOf(o)===-1)}function Mn(r,e=!1){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(r);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const t=r.length;let i,n,s,o="",a=0;for(;a<t;){if(i=r[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:n=r[a++],o+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=r[a++],s=r[a++],o+=String.fromCharCode((i&15)<<12|(n&63)<<6|(s&63)<<0);break}}return o}const Rs={hexDump:function(r){let e="";for(let t=0;t<r.length;t++){let i=r[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function R8(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var pd={exports:{}},z1;function D8(){return z1||(z1=1,function(r,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var h=a.parseURL(l);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var f=a.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=a.normalizePath(f.path),a.buildURLFromParts(f)):c;var d=a.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var m=n.exec(d.path);d.netLoc=m[1],d.path=m[2]}d.netLoc&&!d.path&&(d.path="/");var A={scheme:d.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(A.netLoc=d.netLoc,f.path[0]!=="/"))if(!f.path)A.path=d.path,f.params||(A.params=d.params,f.query||(A.query=d.query));else{var p=d.path,g=p.substring(0,p.lastIndexOf("/")+1)+f.path;A.path=a.normalizePath(g)}return A.path===null&&(A.path=u.alwaysNormalize?a.normalizePath(f.path):f.path),a.buildURLFromParts(A)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(s,"");l.length!==(l=l.replace(o,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};r.exports=a})()}(pd)),pd.exports}var vA=D8();class $h{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Zt={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class EA{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,M8(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let n;i.length===1?n=t?.byteRangeEndOffset||0:n=parseInt(i[1]),this._byteRange=[n,parseInt(i[0])+n]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[Zt.AUDIO]:null,[Zt.VIDEO]:null,[Zt.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new $h),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=vA.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[Zt.AUDIO]=null,e[Zt.VIDEO]=null,e[Zt.AUDIOVIDEO]=null}}function Yi(r){return r.sn!=="initSegment"}class Vu extends EA{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],t=this.byteRange[1];if(Ye(e)&&Ye(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=Ye(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!Ye(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return Yi(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,n,s,o=!1){const{elementaryStreams:a}=this,l=a[e];if(!l){a[e]={startPTS:t,endPTS:i,startDTS:n,endDTS:s,partial:o};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,n),l.endDTS=Math.max(l.endDTS,s)}}class c4 extends EA{constructor(e,t,i,n,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=n;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function u4(r,e){const t=Object.getPrototypeOf(r);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||u4(t,e)}}function M8(r,e){const t=u4(r,e);t&&(t.enumerable=!0,Object.defineProperty(r,e,t))}const mh=Math.pow(2,32)-1,L8=[].push,h4={video:1,audio:2,id3:3,text:4};function Ui(r){return String.fromCharCode.apply(null,r)}function f4(r,e){const t=r[e]<<8|r[e+1];return t<0?65536+t:t}function mt(r,e){const t=d4(r,e);return t<0?4294967296+t:t}function H1(r,e){let t=mt(r,e);return t*=Math.pow(2,32),t+=mt(r,e+4),t}function d4(r,e){return r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3]}function gd(r,e,t){r[e]=t>>24,r[e+1]=t>>16&255,r[e+2]=t>>8&255,r[e+3]=t&255}function P8(r){const e=r.byteLength;for(let t=0;t<e;){const i=mt(r,t);if(i>8&&r[t+4]===109&&r[t+5]===111&&r[t+6]===111&&r[t+7]===102)return!0;t=i>1?t+i:e}return!1}function vt(r,e){const t=[];if(!e.length)return t;const i=r.byteLength;for(let n=0;n<i;){const s=mt(r,n),o=Ui(r.subarray(n+4,n+8)),a=s>1?n+s:i;if(o===e[0])if(e.length===1)t.push(r.subarray(n+8,a));else{const l=vt(r.subarray(n+8,a),e.slice(1));l.length&&L8.apply(t,l)}n=a}return t}function F8(r){const e=[],t=r[0];let i=8;const n=mt(r,i);i+=4;let s=0,o=0;t===0?(s=mt(r,i),o=mt(r,i+4),i+=8):(s=H1(r,i),o=H1(r,i+8),i+=16),i+=2;let a=r.length+o;const l=f4(r,i);i+=2;for(let c=0;c<l;c++){let u=i;const h=mt(r,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return Lt.warn("SIDX has hierarchical references (not supported)"),null;const m=mt(r,u);u+=4,e.push({referenceSize:f,subsegmentDuration:m,info:{duration:m/n,start:a,end:a+f-1}}),a+=f,u+=4,i=u}return{earliestPresentationTime:s,timescale:n,version:t,referencesCount:l,references:e}}function m4(r){const e=[],t=vt(r,["moov","trak"]);for(let n=0;n<t.length;n++){const s=t[n],o=vt(s,["tkhd"])[0];if(o){let a=o[0];const l=mt(o,a===0?12:20),c=vt(s,["mdia","mdhd"])[0];if(c){a=c[0];const u=mt(c,a===0?12:20),h=vt(s,["mdia","hdlr"])[0];if(h){const f=Ui(h.subarray(8,12)),d={soun:Zt.AUDIO,vide:Zt.VIDEO}[f],m=vt(s,["mdia","minf","stbl","stsd"])[0],A=k8(m);d?(e[l]={timescale:u,type:d,stsd:A},e[d]=Kt({timescale:u,id:l},A)):e[l]={timescale:u,type:f,stsd:A}}}}}return vt(r,["moov","mvex","trex"]).forEach(n=>{const s=mt(n,4),o=e[s];o&&(o.default={duration:mt(n,12),flags:mt(n,20)})}),e}function k8(r){const e=r.subarray(8),t=e.subarray(86),i=Ui(e.subarray(4,8));let n=i,s;const o=i==="enca"||i==="encv";if(o){const c=vt(e,[i])[0].subarray(i==="enca"?28:78);vt(c,["sinf"]).forEach(h=>{const f=vt(h,["schm"])[0];if(f){const d=Ui(f.subarray(4,8));if(d==="cbcs"||d==="cenc"){const m=vt(h,["frma"])[0];m&&(n=Ui(m))}}})}const a=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const l=vt(t,["avcC"])[0];l&&l.length>3&&(n+="."+Jc(l[1])+Jc(l[2])+Jc(l[3]),s=Xc(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=vt(e,[i])[0],c=vt(l.subarray(28),["esds"])[0];if(c&&c.length>7){let u=4;if(c[u++]!==3)break;u=yd(c,u),u+=2;const h=c[u++];if(h&128&&(u+=2),h&64&&(u+=c[u++]),c[u++]!==4)break;u=yd(c,u);const f=c[u++];if(f===64)n+="."+Jc(f);else break;if(u+=12,c[u++]!==5)break;u=yd(c,u);const d=c[u++];let m=(d&248)>>3;m===31&&(m+=1+((d&7)<<3)+((c[u]&224)>>5)),n+="."+m}break}case"hvc1":case"hev1":{const l=vt(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],u=["","A","B","C"][c>>6],h=c&31,f=mt(l,2),d=(c&32)>>5?"H":"L",m=l[12],A=l.subarray(6,12);n+="."+u+h,n+="."+f.toString(16).toUpperCase(),n+="."+d+m;let p="";for(let g=A.length;g--;){const v=A[g];(v||p)&&(p="."+v.toString(16).toUpperCase()+p)}n+=p}s=Xc(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=Xc(n,t)||n;break}case"vp09":{const l=vt(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],u=l[5],h=l[6]>>4&15;n+="."+bs(c)+"."+bs(u)+"."+bs(h)}break}case"av01":{const l=vt(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,u=l[1]&31,h=l[2]>>>7?"H":"M",f=(l[2]&64)>>6,d=(l[2]&32)>>5,m=c===2&&f?d?12:10:f?10:8,A=(l[2]&16)>>4,p=(l[2]&8)>>3,g=(l[2]&4)>>2,v=l[2]&3;n+="."+c+"."+bs(u)+h+"."+bs(m)+"."+A+"."+p+g+v+"."+bs(1)+"."+bs(1)+"."+bs(1)+"."+0,s=Xc("dav1",t)}break}}return{codec:n,encrypted:o,supplemental:s}}function Xc(r,e){const t=vt(e,["dvvC"]),i=t.length?t[0]:vt(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,s=i[2]<<5&32|i[3]>>3&31;return r+"."+bs(n)+"."+bs(s)}}function yd(r,e){const t=e+5;for(;r[e++]&128&&e<t;);return e}function Jc(r){return("0"+r.toString(16).toUpperCase()).slice(-2)}function bs(r){return(r<10?"0":"")+r}function O8(r,e){if(!r||!e)return r;const t=e.keyId;return t&&e.isCommonEncryption&&vt(r,["moov","trak"]).forEach(n=>{const o=vt(n,["mdia","minf","stbl","stsd"])[0].subarray(8);let a=vt(o,["enca"]);const l=a.length>0;l||(a=vt(o,["encv"])),a.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);vt(u,["sinf"]).forEach(f=>{const d=A4(f);if(d){const m=d.subarray(8,24);m.some(A=>A!==0)||(Lt.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${Rs.hexDump(m)} -> ${Rs.hexDump(t)}`),d.set(t,8))}})})}),r}function A4(r){const e=vt(r,["schm"])[0];if(e){const t=Ui(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return vt(r,["schi","tenc"])[0]}return null}function U8(r,e){return vt(e,["moof","traf"]).reduce((t,i)=>{const n=vt(i,["tfdt"])[0],s=n[0],o=vt(i,["tfhd"]).reduce((a,l)=>{const c=mt(l,4),u=r[c];if(u){let h=mt(n,4);if(s===1){if(h===mh)return Lt.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),a;h*=mh+1,h+=mt(n,8)}const f=u.timescale||9e4,d=h/f;if(Ye(d)&&(a===null||d<a))return d}return a},null);return o!==null&&Ye(o)&&(t===null||o<t)?o:t},null)}function N8(r,e){let t=0,i=0,n=0;const s=vt(r,["moof","traf"]);for(let o=0;o<s.length;o++){const a=s[o],l=vt(a,["tfhd"])[0],c=mt(l,4),u=e[c];if(!u)continue;const h=u.default,f=mt(l,0)|h?.flags;let d=h?.duration;f&8&&(f&2?d=mt(l,12):d=mt(l,8));const m=u.timescale||9e4,A=vt(a,["trun"]);for(let p=0;p<A.length;p++){if(t=G8(A[p]),!t&&d){const g=mt(A[p],4);t=d*g}u.type===Zt.VIDEO?i+=t/m:u.type===Zt.AUDIO&&(n+=t/m)}}if(i===0&&n===0){let o=1/0,a=0,l=0;const c=vt(r,["sidx"]);for(let u=0;u<c.length;u++){const h=F8(c[u]);if(h!=null&&h.references){o=Math.min(o,h.earliestPresentationTime/h.timescale);const f=h.references.reduce((d,m)=>d+m.info.duration||0,0);a=Math.max(a,f+h.earliestPresentationTime/h.timescale),l=a-o}}if(l&&Ye(l))return l}return i||n}function G8(r){const e=mt(r,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const n=mt(r,4);for(let s=0;s<n;s++){if(e&256){const o=mt(r,t);i+=o,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function Q8(r,e,t){vt(e,["moof","traf"]).forEach(i=>{vt(i,["tfhd"]).forEach(n=>{const s=mt(n,4),o=r[s];if(!o)return;const a=o.timescale||9e4;vt(i,["tfdt"]).forEach(l=>{const c=l[0],u=t*a;if(u){let h=mt(l,4);if(c===0)h-=u,h=Math.max(h,0),gd(l,4,h);else{h*=Math.pow(2,32),h+=mt(l,8),h-=u,h=Math.max(h,0);const f=Math.floor(h/(mh+1)),d=Math.floor(h%(mh+1));gd(l,4,f),gd(l,8,d)}}})})})}function z8(r){const e={valid:null,remainder:null},t=vt(r,["moof"]);if(t.length<2)return e.remainder=r,e;const i=t[t.length-1];return e.valid=r.slice(0,i.byteOffset-8),e.remainder=r.slice(i.byteOffset-8),e}function Zn(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function V1(r,e){const t=[],i=e.samples,n=e.timescale,s=e.id;let o=!1;return vt(i,["moof"]).map(l=>{const c=l.byteOffset-8;vt(l,["traf"]).map(h=>{const f=vt(h,["tfdt"]).map(d=>{const m=d[0];let A=mt(d,4);return m===1&&(A*=Math.pow(2,32),A+=mt(d,8)),A/n})[0];return f!==void 0&&(r=f),vt(h,["tfhd"]).map(d=>{const m=mt(d,4),A=mt(d,0)&16777215,p=(A&1)!==0,g=(A&2)!==0,v=(A&8)!==0;let E=0;const C=(A&16)!==0;let I=0;const _=(A&32)!==0;let x=8;m===s&&(p&&(x+=8),g&&(x+=4),v&&(E=mt(d,x),x+=4),C&&(I=mt(d,x),x+=4),_&&(x+=4),e.type==="video"&&(o=jh(e.codec)),vt(h,["trun"]).map(S=>{const b=S[0],T=mt(S,0)&16777215,B=(T&1)!==0;let w=0;const R=(T&4)!==0,D=(T&256)!==0;let G=0;const z=(T&512)!==0;let W=0;const q=(T&1024)!==0,F=(T&2048)!==0;let N=0;const L=mt(S,4);let $=8;B&&(w=mt(S,$),$+=4),R&&($+=4);let j=w+c;for(let V=0;V<L;V++){if(D?(G=mt(S,$),$+=4):G=E,z?(W=mt(S,$),$+=4):W=I,q&&($+=4),F&&(b===0?N=mt(S,$):N=d4(S,$),$+=4),e.type===Zt.VIDEO){let k=0;for(;k<W;){const Q=mt(i,j);if(j+=4,H8(o,i[j])){const O=i.subarray(j,j+Q);CA(O,o?2:1,r+N/n,t)}j+=Q,k+=Q+4}}r+=G/n}}))})})}),t}function jh(r){if(!r)return!1;const e=r.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function H8(r,e){if(r){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function CA(r,e,t,i){const n=p4(r);let s=0;s+=e;let o=0,a=0,l=0;for(;s<n.length;){o=0;do{if(s>=n.length)break;l=n[s++],o+=l}while(l===255);a=0;do{if(s>=n.length)break;l=n[s++],a+=l}while(l===255);const c=n.length-s;let u=s;if(a<c)s+=a;else if(a>c){Lt.error(`Malformed SEI payload. ${a} is too small, only ${c} bytes left to parse.`);break}if(o===4){if(n[u++]===181){const f=f4(n,u);if(u+=2,f===49){const d=mt(n,u);if(u+=4,d===1195456820){const m=n[u++];if(m===3){const A=n[u++],p=31&A,g=64&A,v=g?2+p*3:0,E=new Uint8Array(v);if(g){E[0]=A;for(let C=1;C<v;C++)E[C]=n[u++]}i.push({type:m,payloadType:o,pts:t,bytes:E})}}}}}else if(o===5&&a>16){const h=[];for(let m=0;m<16;m++){const A=n[u++].toString(16);h.push(A.length==1?"0"+A:A),(m===3||m===5||m===7||m===9)&&h.push("-")}const f=a-16,d=new Uint8Array(f);for(let m=0;m<f;m++)d[m]=n[u++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:Mn(d),userDataBytes:d})}}}function p4(r){const e=r.byteLength,t=[];let i=1;for(;i<e-2;)r[i]===0&&r[i+1]===0&&r[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return r;const n=e-t.length,s=new Uint8Array(n);let o=0;for(i=0;i<n;o++,i++)o===t[0]&&(o++,t.shift()),s[i]=r[o];return s}function V8(r){const e=r[0];let t="",i="",n=0,s=0,o=0,a=0,l=0,c=0;if(e===0){for(;Ui(r.subarray(c,c+1))!=="\0";)t+=Ui(r.subarray(c,c+1)),c+=1;for(t+=Ui(r.subarray(c,c+1)),c+=1;Ui(r.subarray(c,c+1))!=="\0";)i+=Ui(r.subarray(c,c+1)),c+=1;i+=Ui(r.subarray(c,c+1)),c+=1,n=mt(r,12),s=mt(r,16),a=mt(r,20),l=mt(r,24),c=28}else if(e===1){c+=4,n=mt(r,c),c+=4;const h=mt(r,c);c+=4;const f=mt(r,c);for(c+=4,o=2**32*h+f,E8(o)||(o=Number.MAX_SAFE_INTEGER,Lt.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=mt(r,c),c+=4,l=mt(r,c),c+=4;Ui(r.subarray(c,c+1))!=="\0";)t+=Ui(r.subarray(c,c+1)),c+=1;for(t+=Ui(r.subarray(c,c+1)),c+=1;Ui(r.subarray(c,c+1))!=="\0";)i+=Ui(r.subarray(c,c+1)),c+=1;i+=Ui(r.subarray(c,c+1)),c+=1}const u=r.subarray(c,r.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:o,presentationTimeDelta:s,eventDuration:a,id:l,payload:u}}function K8(r,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=i&255,s.set(r,4),n=0,i=8;n<t;n++)s.set(e[n],i),i+=e[n].byteLength;return s}function $8(r,e,t){if(r.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let s;i>0?(s=new Uint8Array(4),e.length>0&&new DataView(s.buffer).setUint32(0,e.length,!1)):s=new Uint8Array;const o=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),K8([112,115,115,104],new Uint8Array([i,0,0,0]),r,s,n,o,t||new Uint8Array)}function j8(r){const e=[];if(r instanceof ArrayBuffer){const t=r.byteLength;let i=0;for(;i+32<t;){const n=new DataView(r,i),s=Y8(n);e.push(s),i+=s.size}}return e}function Y8(r){const e=r.getUint32(0),t=r.byteOffset,i=r.byteLength;if(i<e)return{offset:t,size:i};if(r.getUint32(4)!==1886614376)return{offset:t,size:e};const s=r.getUint32(8)>>>24;if(s!==0&&s!==1)return{offset:t,size:e};const o=r.buffer,a=Rs.hexDump(new Uint8Array(o,t+12,16)),l=r.getUint32(28);let c=null,u=null;if(s===0){if(e-32<l||l<22)return{offset:t,size:e};u=new Uint8Array(o,t+32,l)}else if(s===1){if(!l||i<t+32+l*16+16)return{offset:t,size:e};c=[];for(let h=0;h<l;h++)c.push(new Uint8Array(o,t+32+h*16,16))}return{version:s,systemId:a,kids:c,data:u,offset:t,size:e}}const g4=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),pa={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function y4(r,e){const t=pa[e];return!!t&&!!t[r.slice(0,4)]}function rm(r,e,t=!0){return!r.split(",").some(i=>!v4(i,e,t))}function v4(r,e,t=!0){var i;const n=ur(t);return(i=n?.isTypeSupported(ic(r,e)))!=null?i:!1}function ic(r,e){return`${e}/mp4;codecs=${r}`}function K1(r){if(r){const e=r.substring(0,4);return pa.video[e]}return 2}function Ah(r){const e=g4();return r.split(",").reduce((t,i)=>{const s=e&&jh(i)?9:pa.video[i];return s?(s*2+t)/(t?3:2):(pa.audio[i]+t)/(t?2:1)},0)}const vd={};function W8(r,e=!0){if(vd[r])return vd[r];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[r];for(let n=0;n<t.length;n++){var i;if(v4(t[n],"audio",e))return vd[r]=t[n],t[n];if(t[n]==="mp3"&&(i=ur(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return r}const q8=/flac|opus|mp4a\.40\.34/i;function ph(r,e=!0){return r.replace(q8,t=>W8(t.toLowerCase(),e))}function X8(r,e){const t=[];if(r){const i=r.split(",");for(let n=0;n<i.length;n++)y4(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function Ku(r,e){if(r&&(r.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(r)!==-1))return r;if(e){const t=e.split(",");if(t.length>1){if(r){for(let i=t.length;i--;)if(t[i].substring(0,4)===r.substring(0,4))return t[i]}return t[0]}}return e||r}function J8(r){const e=r.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");if(i.length>2){let n=i.shift()+".";n+=parseInt(i.shift()).toString(16),n+=("000"+parseInt(i.shift()).toString(16)).slice(-4),e[t]=n}}return e.join(",")}function Z8(r){if(r.startsWith("av01.")){const e=r.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return r}function $1(r){const e=ur(r)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function E4(r){return r.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const C4={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function I4(r,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:r}}const j1={};function e9(r,e,t,i,n,s){const o=r.audioCodec?r.audioGroups:null,a=s?.audioCodec,l=s?.channels,c=l?parseInt(l):a?1/0:2;let u=null;if(o!=null&&o.length)try{o.length===1&&o[0]?u=e.groups[o[0]].channels:u=o.reduce((h,f)=>{if(f){const d=e.groups[f];if(!d)throw new Error(`Audio track group ${f} not found`);Object.keys(d.channels).forEach(m=>{h[m]=(h[m]||0)+d.channels[m]})}return h},{2:0})}catch{return!0}return r.videoCodec!==void 0&&(r.width>1920&&r.height>1088||r.height>1920&&r.width>1088||r.frameRate>Math.max(i,30)||r.videoRange!=="SDR"&&r.videoRange!==t||r.bitrate>Math.max(n,8e6))||!!u&&Ye(c)&&Object.keys(u).some(h=>parseInt(h)>c)}function _4(r,e,t){const i=r.videoCodec,n=r.audioCodec;if(!i&&!n||!t)return Promise.resolve(C4);const s=[];if(i){const o={width:r.width,height:r.height,bitrate:Math.ceil(Math.max(r.bitrate*.9,r.averageBitrate)),framerate:r.frameRate||30},a=r.videoRange;a!=="SDR"&&(o.transferFunction=a.toLowerCase());const l=i.split(","),c=navigator.userAgent;if(l.some(u=>jh(u))&&g4())return Promise.resolve(I4(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${c})`),s));s.push.apply(s,l.map(u=>({type:"media-source",video:Kt(Kt({},o),{},{contentType:ic(Z8(u),"video")})})))}return n&&r.audioGroups&&r.audioGroups.forEach(o=>{var a;o&&((a=e.groups[o])==null||a.tracks.forEach(l=>{if(l.groupId===o){const c=l.channels||"",u=parseFloat(c);Ye(u)&&u>2&&s.push.apply(s,n.split(",").map(h=>({type:"media-source",audio:{contentType:ic(h,"audio"),channels:""+u}})))}}))}),Promise.all(s.map(o=>{const a=t9(o);return j1[a]||(j1[a]=t.decodingInfo(o))})).then(o=>({supported:!o.some(a=>!a.supported),configurations:s,decodingInfoResults:o})).catch(o=>({supported:!1,configurations:s,decodingInfoResults:[],error:o}))}function t9(r){const{audio:e,video:t}=r,i=t||e;if(i){const n=E4(i.contentType);if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${n}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${n}`}return""}const om=["NONE","TYPE-0","TYPE-1",null];function i9(r){return om.indexOf(r)>-1}const gh=["SDR","PQ","HLG"];function n9(r){return!!r&&gh.indexOf(r)>-1}var Nl={No:"",Yes:"YES",v2:"v2"};function Y1(r){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=r,n=i<e/2;return e&&n?t?Nl.v2:Nl.Yes:Nl.No}class am{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class ga{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return W1(this._audioGroups,e)}hasSubtitleGroup(e){return W1(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function W1(r,e){return!e||!r?!1:r.indexOf(e)!==-1}function s9(){if(typeof matchMedia=="function"){const r=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(r.media!==e.media)return r.matches===!0}return!1}function r9(r,e){let t=!1,i=[];if(r&&(t=r!=="SDR",i=[r]),e){i=e.allowedVideoRanges||gh.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&s9(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const o9=r=>{const e=new WeakSet;return(t,i)=>{if(r&&(i=r(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},pi=(r,e)=>JSON.stringify(r,o9(e));function a9(r,e,t,i,n){const s=Object.keys(r),o=i?.channels,a=i?.audioCodec,l=n?.videoCodec,c=o&&parseInt(o)===2;let u=!1,h=!1,f=1/0,d=1/0,m=1/0,A=1/0,p=0,g=[];const{preferHDR:v,allowedVideoRanges:E}=r9(e,n);for(let S=s.length;S--;){const b=r[s[S]];u||(u=b.channels[2]>0),f=Math.min(f,b.minHeight),d=Math.min(d,b.minFramerate),m=Math.min(m,b.minBitrate),E.filter(B=>b.videoRanges[B]>0).length>0&&(h=!0)}f=Ye(f)?f:0,d=Ye(d)?d:0;const C=Math.max(1080,f),I=Math.max(30,d);m=Ye(m)?m:t,t=Math.max(m,t),h||(e=void 0);const _=s.length>1;return{codecSet:s.reduce((S,b)=>{const T=r[b];if(b===S)return S;if(g=h?E.filter(B=>T.videoRanges[B]>0):[],_){if(T.minBitrate>t)return Ss(b,`min bitrate of ${T.minBitrate} > current estimate of ${t}`),S;if(!T.hasDefaultAudio)return Ss(b,"no renditions with default or auto-select sound found"),S;if(a&&b.indexOf(a.substring(0,4))%5!==0)return Ss(b,`audio codec preference "${a}" not found`),S;if(o&&!c){if(!T.channels[o])return Ss(b,`no renditions with ${o} channel sound found (channels options: ${Object.keys(T.channels)})`),S}else if((!a||c)&&u&&T.channels[2]===0)return Ss(b,"no renditions with stereo sound found"),S;if(T.minHeight>C)return Ss(b,`min resolution of ${T.minHeight} > maximum of ${C}`),S;if(T.minFramerate>I)return Ss(b,`min framerate of ${T.minFramerate} > maximum of ${I}`),S;if(!g.some(B=>T.videoRanges[B]>0))return Ss(b,`no variants with VIDEO-RANGE of ${pi(g)} found`),S;if(l&&b.indexOf(l.substring(0,4))%5!==0)return Ss(b,`video codec preference "${l}" not found`),S;if(T.maxScore<p)return Ss(b,`max score of ${T.maxScore} < selected max of ${p}`),S}return S&&(Ah(b)>=Ah(S)||T.fragmentError>r[S].fragmentError)?S:(A=T.minIndex,p=T.maxScore,b)},void 0),videoRanges:g,preferHDR:v,minFramerate:d,minBitrate:m,minIndex:A}}function Ss(r,e){Lt.log(`[abr] start candidates with "${r}" ignored because ${e}`)}function x4(r){return r.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function l9(r,e,t,i){return r.slice(t,i+1).reduce((n,s,o)=>{if(!s.codecSet)return n;const a=s.audioGroups;let l=n[s.codecSet];l||(n[s.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,s.bitrate);const c=Math.min(s.height,s.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,s.frameRate),l.minIndex=Math.min(l.minIndex,o),l.maxScore=Math.max(l.maxScore,s.score),l.fragmentError+=s.fragmentError,l.videoRanges[s.videoRange]=(l.videoRanges[s.videoRange]||0)+1,a&&a.forEach(u=>{if(!u)return;const h=e.groups[u];h&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(f=>{l.channels[f]=(l.channels[f]||0)+h.channels[f]}))}),n},{})}function q1(r){if(!r)return r;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}=r;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}}function ks(r,e,t){if("attrs"in r){const i=e.indexOf(r);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(oo(r,n,t))return i}return-1}function oo(r,e,t){const{groupId:i,name:n,lang:s,assocLang:o,default:a}=r,l=r.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(s===void 0||c9(s,e.lang))&&(s===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(l===void 0||e.forced===l)&&(!("characteristics"in r)||u9(r.characteristics||"",e.characteristics))&&(t===void 0||t(r,e))}function c9(r,e="--"){return r.length===e.length?r===e:r.startsWith(e)||e.startsWith(r)}function u9(r,e=""){const t=r.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function Jr(r,e){const{audioCodec:t,channels:i}=r;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function h9(r,e,t,i,n){const s=e[i],a=e.reduce((f,d,m)=>{const A=d.uri;return(f[A]||(f[A]=[])).push(m),f},{})[s.uri];a.length>1&&(i=Math.max.apply(Math,a));const l=s.videoRange,c=s.frameRate,u=s.codecSet.substring(0,4),h=X1(e,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return ks(r,m,n)>-1});return h>-1?h:X1(e,i,f=>{const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return ks(r,m,n)>-1})}function X1(r,e,t){for(let i=e;i>-1;i--)if(t(r[i]))return i;for(let i=e+1;i<r.length;i++)if(t(r[i]))return i;return-1}function yh(r,e){var t;return!!r&&r!==((t=e.loadLevelObj)==null?void 0:t.uri)}class S4 extends dr{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:s,hls:o}=this,{autoLevelEnabled:a,media:l}=o;if(!n||!l)return;const c=performance.now(),u=s?s.stats:n.stats,h=s?s.duration:n.duration,f=c-u.loading.start,d=o.minAutoLevel,m=n.level,A=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||m<=d){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const p=A>-1&&A!==m,g=!!t||p;if(!g&&(l.paused||!l.playbackRate||!l.readyState))return;const v=o.mainForwardBufferInfo;if(!g&&v===null)return;const E=this.bwEstimator.getEstimateTTFB(),C=Math.abs(l.playbackRate);if(f<=Math.max(E,1e3*(h/(C*2))))return;const I=v?v.len/C:0,_=u.loading.first?u.loading.first-u.loading.start:-1,x=u.loaded&&_>-1,S=this.getBwEstimate(),b=o.levels,T=b[m],B=Math.max(u.loaded,Math.round(h*(n.bitrate||T.averageBitrate)/8));let w=x?f-_:f;w<1&&x&&(w=Math.min(f,u.loaded*8/S));const R=x?u.loaded*1e3/w:0,D=E/1e3,G=R?(B-u.loaded)/R:B*8/S+D;if(G<=I)return;const z=R?R*8:S,W=((i=t?.details||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,q=this.hls.config.abrBandWidthUpFactor;let F=Number.POSITIVE_INFINITY,N;for(N=m-1;N>d;N--){const V=b[N].maxBitrate,k=!b[N].details||W;if(F=this.getTimeToLoadFrag(D,z,h*V,k),F<Math.min(I,h+D))break}if(F>=G||F>h*10)return;x?this.bwEstimator.sample(f-Math.min(E,_),u.loaded):this.bwEstimator.sampleTTFB(f);const L=b[N].maxBitrate;this.getBwEstimate()*q>L&&this.resetEstimator(L);const $=this.findBestLevel(L,d,N,0,I,1,1);$>-1&&(N=$),this.warn(`Fragment ${n.sn}${s?" part "+s.index:""} of level ${m} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${I.toFixed(3)} s
      Estimated load time for current fragment: ${G.toFixed(3)} s
      Estimated load time for down switch fragment: ${F.toFixed(3)} s
      TTFB estimate: ${_|0} ms
      Current BW estimate: ${Ye(S)?S|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${N} @ ${L|0} bps`),o.nextLoadLevel=o.nextAutoLevel=N,this.clearTimer();const j=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===N&&N>0){const V=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${N>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${V.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,N>d){let k=this.findBestLevel(this.hls.levels[d].bitrate,d,N,0,V,1,1);k===-1&&(k=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=k,this.resetEstimator(this.hls.levels[k].bitrate)}}};p||G>F*2?j():this.timer=self.setInterval(j,F*1e3),o.trigger(M.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:s,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new I8(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.FRAG_LOADING,this.onFragLoading,this),e.on(M.FRAG_LOADED,this.onFragLoaded,this),e.on(M.FRAG_BUFFERED,this.onFragBuffered,this),e.on(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(M.LEVEL_LOADED,this.onLevelLoaded,this),e.on(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(M.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.FRAG_LOADING,this.onFragLoading,this),e.off(M.FRAG_LOADED,this.onFragLoaded,this),e.off(M.FRAG_BUFFERED,this.onFragBuffered,this),e.off(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(M.LEVEL_LOADED,this.onLevelLoaded,this),e.off(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(M.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(M.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case me.BUFFER_ADD_CODEC_ERROR:case me.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case me.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:s}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const o=performance.now(),a=s?s.stats:i.stats,l=o-a.loading.start,c=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&c>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(h,c),a.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,n){const s=e+i/t,o=n?e+this.lastLevelLoadSec:0;return s+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,s=n.end-n.first;Ye(s)&&(this.lastLevelLoadSec=s/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===it.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const s=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+n.loaded,l=(o.loaded?o.loaded.duration:0)+s;o.loaded={bytes:a,duration:l},o.realBitrate=Math.round(8*a/l)}if(t.bitrateTest){const s={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(M.FRAG_BUFFERED,s),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,s=n!=null&&n.stats.loaded?n.stats:i.stats;if(s.aborted||this.ignoreFragment(i))return;const o=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==it.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,t,e,0,n,1,1);if(s>-1)return s;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const s=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,s)&&o[e].loadError<=o[s].loadError)return e}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:s,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=s.abrBandWidthFactor,h=s.abrBandWidthUpFactor;if(c){const p=this.findBestLevel(l,o,n,c,0,u,h);if(p>=0)return this.rebufferNotice=-1,p}let f=a?Math.min(a,s.maxStarvationDelay):s.maxStarvationDelay;if(!c){const p=this.bitrateTestDelay;p&&(f=(a?Math.min(a,s.maxLoadingDelay):s.maxLoadingDelay)-p,this.info(`bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const d=this.findBestLevel(l,o,n,c,f,u,h);if(this.rebufferNotice!==d&&(this.rebufferNotice=d,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`)),d>-1)return d;const m=i.levels[o],A=i.loadLevelObj;return A&&m?.bitrate<A.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,s,o,a){var l;const c=n+s,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:d}=this,{levels:m,allAudioTracks:A,loadLevel:p,config:g}=this.hls;if(m.length===1)return 0;const v=m[h],E=!!((l=this.hls.latestLevelDetails)!=null&&l.live),C=p===-1||u===-1;let I,_="SDR",x=v?.frameRate||0;const{audioPreference:S,videoPreference:b}=g,T=this.audioTracksByGroup||(this.audioTracksByGroup=x4(A));let B=-1;if(C){if(this.firstSelection!==-1)return this.firstSelection;const z=this.codecTiers||(this.codecTiers=l9(m,T,t,i)),W=a9(z,_,e,S,b),{codecSet:q,videoRanges:F,minFramerate:N,minBitrate:L,minIndex:$,preferHDR:j}=W;B=$,I=q,_=j?F[F.length-1]:F[0],x=N,e=Math.max(e,L),this.log(`picked start tier ${pi(W)}`)}else I=v?.codecSet,_=v?.videoRange;const w=d?d.duration:f?f.duration:0,R=this.bwEstimator.getEstimateTTFB()/1e3,D=[];for(let z=i;z>=t;z--){var G;const W=m[z],q=z>h;if(!W)continue;if(g.useMediaCapabilities&&!W.supportedResult&&!W.supportedPromise){const k=navigator.mediaCapabilities;typeof k?.decodingInfo=="function"&&(e9(W,T,_,x,e,S)||jh(W.videoCodec))?(W.supportedPromise=_4(W,T,k),W.supportedPromise.then(Q=>{if(!this.hls)return;W.supportedResult=Q;const O=this.hls.levels,U=O.indexOf(W);Q.error?this.warn(`MediaCapabilities decodingInfo error: "${Q.error}" for level ${U} ${pi(Q)}`):Q.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${U} ${pi(Q)}`),U>-1&&O.length>1&&(this.log(`Removing unsupported level ${U}`),this.hls.removeLevel(U),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):W.supportedResult=C4}if((I&&W.codecSet!==I||_&&W.videoRange!==_||q&&x>W.frameRate||!q&&x>0&&x<W.frameRate||W.supportedResult&&!((G=W.supportedResult.decodingInfoResults)!=null&&G[0].smooth))&&(!C||z!==B)){D.push(z);continue}const F=W.details,N=(d?F?.partTarget:F?.averagetargetduration)||w;let L;q?L=a*e:L=o*e;const $=w&&n>=w*2&&s===0?W.averageBitrate:W.maxBitrate,j=this.getTimeToLoadFrag(R,L,$*N,F===void 0);if(L>=$&&(z===u||W.loadError===0&&W.fragmentError===0)&&(j<=R||!Ye(j)||E&&!this.bitrateTestDelay||j<c)){const k=this.forcedAutoLevel;return z!==p&&(k===-1||k!==p)&&(D.length&&this.trace(`Skipped level(s) ${D.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[D[0]].codecs}" ${m[D[0]].videoRange}; not compatible with "${I}" ${_}`),this.info(`switch candidate:${h}->${z} adjustedbw(${Math.round(L)})-bitrate=${Math.round(L-$)} ttfb:${R.toFixed(1)} avgDuration:${N.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${j.toFixed(1)} firstSelection:${C} codecSet:${W.codecSet} videoRange:${W.videoRange} hls.loadLevel:${p}`)),C&&(this.firstSelection=z),z}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const IA={search:function(r,e){let t=0,i=r.length-1,n=null,s=null;for(;t<=i;){n=(t+i)/2|0,s=r[n];const o=e(s);if(o>0)t=n+1;else if(o<0)i=n-1;else return s}return null}};function f9(r,e,t){if(e===null||!Array.isArray(r)||!r.length||!Ye(e))return null;const i=r[0].programDateTime;if(e<(i||0))return null;const n=r[r.length-1].endProgramDateTime;if(e>=(n||0))return null;t=t||0;for(let s=0;s<r.length;++s){const o=r[s];if(m9(e,t,o))return o}return null}function co(r,e,t=0,i=0,n=.005){let s=null;if(r){s=e[1+r.sn-e[0].sn]||null;const a=r.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),s&&r.level!==s.level&&s.end<=r.end&&(s=e[2+r.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(s=e[0]);if(s&&((!r||r.level===s.level)&&J1(t,i,s)===0||d9(s,r,Math.min(n,i))))return s;const o=IA.search(e,J1.bind(null,t,i));return o&&(o!==r||!s)?o:s}function d9(r,e,t){if(e&&e.start===0&&e.level<r.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,s)=>(s[0]==="INF"&&(n+=parseFloat(s[1])),n),t);return r.start<=i}return!1}function J1(r=0,e=0,t){if(t.start<=r&&t.start+t.duration>r)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=r?1:t.start-i>r&&t.start?-1:0}function m9(r,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>r}function T4(r,e){return IA.search(r,t=>t.cc<e?1:t.cc>e?-1:0)}function A9(r,e,t){if(r&&r.startCC<=e&&r.endCC>=e){const i=t.start,n=t.end;let s=r.fragments;if(!t.relurl){const{fragmentHint:o}=r;o&&(s=s.concat(o))}return IA.search(s,o=>o.cc<e||o.end<=i?1:o.cc>e||o.start>=n?-1:0)}return null}function vh(r){switch(r.details){case me.FRAG_LOAD_TIMEOUT:case me.KEY_LOAD_TIMEOUT:case me.LEVEL_LOAD_TIMEOUT:case me.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Z1(r,e){const t=vh(e);return r.default[`${t?"timeout":"error"}Retry`]}function _A(r,e){const t=r.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*r.retryDelayMs,r.maxRetryDelayMs)}function ey(r){return Kt(Kt({},r),{errorRetry:null,timeoutRetry:null})}function Eh(r,e,t,i){if(!r)return!1;const n=i?.code,s=e<r.maxNumRetry&&(p9(n)||!!t);return r.shouldRetry?r.shouldRetry(r,e,t,i,s):s}function p9(r){return r===0&&navigator.onLine===!1||!!r&&(r<400||r>499)}var Ki={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Vn={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class b4 extends dr{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(M.ERROR,this.onError,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(M.ERROR,this.onError,this),e.off(M.ERROR,this.onErrorOut,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===it.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,s=t.context;switch(t.details){case me.FRAG_LOAD_ERROR:case me.FRAG_LOAD_TIMEOUT:case me.KEY_LOAD_ERROR:case me.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case me.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=nc();return}case me.FRAG_GAP:case me.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Ki.SendAlternateToPenaltyBox;return}case me.LEVEL_EMPTY_ERROR:case me.LEVEL_PARSING_ERROR:{var o,a;const c=t.parent===it.MAIN?t.level:n.loadLevel;t.details===me.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(a=o.levelDetails)!=null&&a.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case me.LEVEL_LOAD_ERROR:case me.LEVEL_LOAD_TIMEOUT:typeof s?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.level));return;case me.AUDIO_TRACK_LOAD_ERROR:case me.AUDIO_TRACK_LOAD_TIMEOUT:case me.SUBTITLE_LOAD_ERROR:case me.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const c=n.loadLevelObj;if(c&&(s.type===Bt.AUDIO_TRACK&&c.hasAudioGroup(s.groupId)||s.type===Bt.SUBTITLE_TRACK&&c.hasSubtitleGroup(s.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=Ki.SendAlternateToPenaltyBox,t.errorAction.flags=Vn.MoveAllAlternatesMatchingHost;return}}return;case me.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=n.loadLevelObj,u=c?.attrs["HDCP-LEVEL"];u?t.errorAction={action:Ki.SendAlternateToPenaltyBox,flags:Vn.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(t)}return;case me.BUFFER_ADD_CODEC_ERROR:case me.REMUX_ALLOC_ERROR:case me.BUFFER_APPEND_ERROR:if(!t.errorAction){var l;t.errorAction=this.getLevelSwitchAction(t,(l=t.level)!=null?l:n.loadLevel)}return;case me.INTERNAL_EXCEPTION:case me.BUFFER_APPENDING_ERROR:case me.BUFFER_FULL_ERROR:case me.LEVEL_SWITCH_ERROR:case me.BUFFER_STALLED_ERROR:case me.BUFFER_SEEK_OVER_HOLE:case me.BUFFER_NUDGE_ON_STALL:t.errorAction=nc();return}t.type===nt.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=Z1(i.config.playlistLoadPolicy,e),s=this.playlistError++;if(Eh(n,s,vh(e),e.response))return{action:Ki.RetryRequest,flags:Vn.None,retryConfig:n,retryCount:s};const a=this.getLevelSwitchAction(e,t);return n&&(a.retryConfig=n,a.retryCount=s),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:s,keyLoadPolicy:o}=t.config,a=Z1(e.details.startsWith("key")?o:s,e),l=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(n&&(e.details!==me.FRAG_GAP&&n.fragmentError++,Eh(a,l,vh(e),e.response)))return{action:Ki.RetryRequest,flags:Vn.None,retryConfig:a,retryCount:l};const c=this.getLevelSwitchAction(e,i);return a&&(c.retryConfig=a,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var s,o;const c=e.details;n.loadError++,c===me.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:d,maxAutoLevel:m}=i;i.autoLevelEnabled||(i.loadLevel=-1);const A=(s=e.frag)==null?void 0:s.type,g=(A===it.AUDIO&&c===me.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===me.BUFFER_ADD_CODEC_ERROR||c===me.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:_})=>n.audioCodec!==_),E=e.sourceBufferName==="video"&&(c===me.BUFFER_ADD_CODEC_ERROR||c===me.BUFFER_APPEND_ERROR)&&h.some(({codecSet:_,audioCodec:x})=>n.codecSet!==_&&n.audioCodec===x),{type:C,groupId:I}=(o=e.context)!=null?o:{};for(let _=h.length;_--;){const x=(_+f)%h.length;if(x!==f&&x>=d&&x<=m&&h[x].loadError===0){var a,l;const S=h[x];if(c===me.FRAG_GAP&&A===it.MAIN&&e.frag){const b=h[x].details;if(b){const T=co(e.frag,b.fragments,e.frag.start);if(T!=null&&T.gap)continue}}else{if(C===Bt.AUDIO_TRACK&&S.hasAudioGroup(I)||C===Bt.SUBTITLE_TRACK&&S.hasSubtitleGroup(I))continue;if(A===it.AUDIO&&(a=n.audioGroups)!=null&&a.some(b=>S.hasAudioGroup(b))||A===it.SUBTITLE&&(l=n.subtitleGroups)!=null&&l.some(b=>S.hasSubtitleGroup(b))||g&&n.audioCodec===S.audioCodec||!g&&n.audioCodec!==S.audioCodec||E&&n.codecSet===S.codecSet)continue}u=x;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:Ki.SendAlternateToPenaltyBox,flags:Vn.None,nextAutoLevel:u}}return{action:Ki.SendAlternateToPenaltyBox,flags:Vn.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Ki.DoNothing:break;case Ki.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==me.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case Ki.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n,hdcpLevel:s,nextAutoLevel:o}=i;switch(n){case Vn.None:this.switchLevel(e,o);break;case Vn.MoveAllAlternatesMatchingHDCP:s&&(t.maxHdcpLevel=om[om.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,o)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===me.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=E4(e.mimeType),n=this.hls.levels;for(let s=n.length;s--;)n[s][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(s)}}}function nc(r){const e={action:Ki.DoNothing,flags:Vn.None};return r&&(e.resolved=!0),e}var Ni={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class g9{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.BUFFER_APPENDED,this.onBufferAppended,this),e.on(M.FRAG_BUFFERED,this.onFragBuffered,this),e.on(M.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.BUFFER_APPENDED,this.onBufferAppended,this),e.off(M.FRAG_BUFFERED,this.onFragBuffered,this),e.off(M.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let n=i.length;n--;){const s=i[n];if(!s)break;const o=s.end;if(s.start<=e&&o!==null&&e<=o)return s}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:n}=this,s=Object.keys(n);for(let o=s.length;o--;){const a=n[s[o]];if(a?.body.type===t&&(!i||a.buffered)){const l=a.body;if(l.start<=e&&e<=l.end)return l}}return null}detectEvictedFragments(e,t,i,n,s){this.timeRanges&&(this.timeRanges[e]=t);const o=n?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{const l=this.fragments[a];if(!l||o>=l.body.sn)return;if(!l.buffered&&(!l.loaded||s)){l.body.type===i&&this.removeFragment(l.body);return}const c=l.range[e];if(c){if(c.time.length===0){this.removeFragment(l.body);return}c.time.some(u=>{const h=!this.isTimeBuffered(u.startPTS,u.endPTS,t);return h&&this.removeFragment(l.body),h})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,n=wo(i),s=this.fragments[n];if(!s||s.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const l=i.elementaryStreams[a];if(!l)return;const c=t[a],u=o||l.partial===!0;s.range[a]=this.getBufferedTimes(i,e.part,u,c)}),s.loaded=null,Object.keys(s.range).length?(s.buffered=!0,(s.body.endList=i.endList||s.body.endList)&&(this.endListFragments[s.body.type]=s),Zc(s)||this.removeParts(i.sn-1,i.type)):this.removeFragment(s.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=ty(i,n=>n.fragment.sn>=e))}fragBuffered(e,t){const i=wo(e);let n=this.fragments[i];!n&&t&&(n=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)}getBufferedTimes(e,t,i,n){const s={time:[],partial:i},o=e.start,a=e.end,l=e.minEndPTS||a,c=e.maxStartPTS||o;for(let u=0;u<n.length;u++){const h=n.start(u)-this.bufferPadding,f=n.end(u)+this.bufferPadding;if(c>=h&&l<=f){s.time.push({startPTS:Math.max(o,n.start(u)),endPTS:Math.min(a,n.end(u))});break}else if(o<f&&a>h){const d=Math.max(o,n.start(u)),m=Math.min(a,n.end(u));m>d&&(s.partial=!0,s.time.push({startPTS:d,endPTS:m}))}else if(a<=h)break}return s}getPartialFragment(e){let t=null,i,n,s,o=0;const{bufferPadding:a,fragments:l}=this;return Object.keys(l).forEach(c=>{const u=l[c];u&&Zc(u)&&(n=u.body.start-a,s=u.body.end+a,e>=n&&e<=s&&(i=Math.min(e-n,s-e),o<=i&&(t=u.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Zc(t))}getState(e){const t=wo(e),i=this.fragments[t];return i?i.buffered?Zc(i)?Ni.PARTIAL:Ni.OK:Ni.APPENDING:Ni.NOT_LOADED}isTimeBuffered(e,t,i){let n,s;for(let o=0;o<i.length;o++){if(n=i.start(o)-this.bufferPadding,s=i.end(o)+this.bufferPadding,e>=n&&t<=s)return!0;if(t<=n)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,n=t.part?null:t,s=wo(i);this.fragments[s]={body:i,appendedPTS:null,loaded:n,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:n,timeRanges:s,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(n){let c=this.activePartLists[a];c||(this.activePartLists[a]=c=[]),c.push(n)}this.timeRanges=s;const l=s[o];this.detectEvictedFragments(o,l,a,n)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=wo(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let n=i.length;n--;){const s=t[i[n]];if(s?.body.type===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,n,s){n&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const l=a.body;l.type!==i||n&&!l.gap||l.start<t&&l.end>e&&(a.buffered||s)&&this.removeFragment(l)})}removeFragment(e){const t=wo(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const n=e.sn;this.activePartLists[e.type]=ty(i,s=>s.fragment.sn!==n)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const i=(e=this.hls)==null||(t=e.latestLevelDetails)==null?void 0:t.partList;i&&i.forEach(n=>n.clearElementaryStreamInfo())}}function Zc(r){var e,t,i;return r.buffered&&(r.body.gap||((e=r.range.video)==null?void 0:e.partial)||((t=r.range.audio)==null?void 0:t.partial)||((i=r.range.audiovideo)==null?void 0:i.partial))}function wo(r){return`${r.type}_${r.level}_${r.sn}`}function ty(r,e){return r.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var kr={cbc:0,ctr:1};class y9{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case kr.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case kr.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function v9(r){const e=r.byteLength,t=e&&new DataView(r.buffer).getUint8(e-1);return t?r.slice(0,e-t):r}class E9{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],s=i[1],o=i[2],a=i[3],l=this.invSubMix,c=l[0],u=l[1],h=l[2],f=l[3],d=new Uint32Array(256);let m=0,A=0,p=0;for(p=0;p<256;p++)p<128?d[p]=p<<1:d[p]=p<<1^283;for(p=0;p<256;p++){let g=A^A<<1^A<<2^A<<3^A<<4;g=g>>>8^g&255^99,e[m]=g,t[g]=m;const v=d[m],E=d[v],C=d[E];let I=d[g]*257^g*16843008;n[m]=I<<24|I>>>8,s[m]=I<<16|I>>>16,o[m]=I<<8|I>>>24,a[m]=I,I=C*16843009^E*65537^v*257^m*16843008,c[g]=I<<24|I>>>8,u[g]=I<<16|I>>>16,h[g]=I<<8|I>>>24,f[g]=I,m?(m=v^d[d[d[C^v]]],A^=d[d[A]]):m=A=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const s=this.keySize=t.length;if(s!==4&&s!==6&&s!==8)throw new Error("Invalid aes key size="+s);const o=this.ksRows=(s+6+1)*4;let a,l;const c=this.keySchedule=new Uint32Array(o),u=this.invKeySchedule=new Uint32Array(o),h=this.sBox,f=this.rcon,d=this.invSubMix,m=d[0],A=d[1],p=d[2],g=d[3];let v,E;for(a=0;a<o;a++){if(a<s){v=c[a]=t[a];continue}E=v,a%s===0?(E=E<<8|E>>>24,E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255],E^=f[a/s|0]<<24):s>6&&a%s===4&&(E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255]),c[a]=v=(c[a-s]^E)>>>0}for(l=0;l<o;l++)a=o-l,l&3?E=c[a]:E=c[a-4],l<4||a<=4?u[l]=E:u[l]=m[h[E>>>24]]^A[h[E>>>16&255]]^p[h[E>>>8&255]]^g[h[E&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,s=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,l=a[0],c=a[1],u=a[2],h=a[3],f=this.uint8ArrayToUint32Array_(i);let d=f[0],m=f[1],A=f[2],p=f[3];const g=new Int32Array(e),v=new Int32Array(g.length);let E,C,I,_,x,S,b,T,B,w,R,D,G,z;const W=this.networkToHostOrderSwap;for(;t<g.length;){for(B=W(g[t]),w=W(g[t+1]),R=W(g[t+2]),D=W(g[t+3]),x=B^s[0],S=D^s[1],b=R^s[2],T=w^s[3],G=4,z=1;z<n;z++)E=l[x>>>24]^c[S>>16&255]^u[b>>8&255]^h[T&255]^s[G],C=l[S>>>24]^c[b>>16&255]^u[T>>8&255]^h[x&255]^s[G+1],I=l[b>>>24]^c[T>>16&255]^u[x>>8&255]^h[S&255]^s[G+2],_=l[T>>>24]^c[x>>16&255]^u[S>>8&255]^h[b&255]^s[G+3],x=E,S=C,b=I,T=_,G=G+4;E=o[x>>>24]<<24^o[S>>16&255]<<16^o[b>>8&255]<<8^o[T&255]^s[G],C=o[S>>>24]<<24^o[b>>16&255]<<16^o[T>>8&255]<<8^o[x&255]^s[G+1],I=o[b>>>24]<<24^o[T>>16&255]<<16^o[x>>8&255]<<8^o[S&255]^s[G+2],_=o[T>>>24]<<24^o[x>>16&255]<<16^o[S>>8&255]<<8^o[b&255]^s[G+3],v[t]=W(E^d),v[t+1]=W(_^m),v[t+2]=W(I^A),v[t+3]=W(C^p),d=B,m=w,A=R,p=D,t=t+4}return v.buffer}}class C9{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=I9(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function I9(r){switch(r){case kr.cbc:return"AES-CBC";case kr.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${r}`)}}const _9=16;class xA{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?v9(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((s,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,n);const l=this.flush();l?s(l.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:s,currentResult:o,remainderData:a}=this;if(n!==kr.cbc||t.byteLength!==16)return Lt.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=Zn(a,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;s&&(i=s);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new E9),c.expandKey(t);const u=o;return this.currentResult=c.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new C9(this.subtle,t,n)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new y9(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(Lt.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const s=this.enableSoftwareAES;if(s){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(s?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%_9;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(Lt.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const iy=Math.pow(2,17);class x9{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new tr({type:nt.NETWORK_ERROR,details:me.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(m=>m[0]==="GAP")){l(sy(e));return}else e.gap=!1;const c=this.loader=s?new s(n):new o(n),u=ny(e);e.loader=c;const h=ey(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:iy};e.stats=c.stats;const d={onSuccess:(m,A,p,g)=>{this.resetLoader(e,c);let v=m.data;p.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),a({frag:e,part:null,payload:v,networkDetails:g})},onError:(m,A,p,g)=>{this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Kt({url:i,data:void 0},m),error:new Error(`HTTP Error ${m.code} ${m.text}`),networkDetails:p,stats:g}))},onAbort:(m,A,p)=>{this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:p,stats:m}))},onTimeout:(m,A,p)=>{this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:p,stats:m}))}};t&&(d.onProgress=(m,A,p,g)=>t({frag:e,part:null,payload:p,networkDetails:g})),c.load(u,f,d)})}loadPart(e,t,i){this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(sy(e,t));return}const c=this.loader=s?new s(n):new o(n),u=ny(e,t);e.loader=c;const h=ey(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:iy};t.stats=c.stats,c.load(u,f,{onSuccess:(d,m,A,p)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const g={frag:e,part:t,payload:d.data,networkDetails:p};i(g),a(g)},onError:(d,m,A,p)=>{this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Kt({url:u.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:A,stats:p}))},onAbort:(d,m,A)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:A,stats:d}))},onTimeout:(d,m,A)=>{this.resetLoader(e,c),l(new tr({type:nt.NETWORK_ERROR,details:me.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:A,stats:d}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,s=n.total;if(i.loaded+=n.loaded,s){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/s),l),h=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=n.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function ny(r,e=null){const t=e||r,i={frag:r,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,s=t.byteRangeEndOffset;if(Ye(n)&&Ye(s)){var o;let a=n,l=s;if(r.sn==="initSegment"&&S9((o=r.decryptdata)==null?void 0:o.method)){const c=s-n;c%16&&(l=s+(16-c%16)),n!==0&&(i.resetIV=!0,a=n-16)}i.rangeStart=a,i.rangeEnd=l}return i}function sy(r,e){const t=new Error(`GAP ${r.gap?"tag":"attribute"} found`),i={type:nt.MEDIA_ERROR,details:me.FRAG_GAP,fatal:!1,frag:r,error:t,networkDetails:null};return e&&(i.part=e),(e||r).stats.aborted=!0,new tr(i)}function S9(r){return r==="AES-128"||r==="AES-256"}class tr extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class w4 extends dr{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Yh{constructor(e,t,i,n=0,s=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=eu(),this.buffering={audio:eu(),video:eu(),audiovideo:eu()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=s,this.partial=o}}function eu(){return{start:0,executeStart:0,executeEnd:0,end:0}}const ry={length:0,start:()=>0,end:()=>0};class Tt{static isBuffered(e,t){if(e){const i=Tt.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=Tt.getBuffered(e);return Tt.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=Tt.bufferedRanges(e);if(n.length)return Tt.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,h)=>u.start-h.start||h.end-u.end);let n=-1,s=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const h=s.length;if(h){const f=s[h-1].end;e[u].start-f<i?e[u].end>f&&(s[h-1].end=e[u].end):s.push(e[u])}else s.push(e[u])}else s=e;let o=0,a,l=t,c=t;for(let u=0;u<s.length;u++){const h=s[u].start,f=s[u].end;if(n===-1&&t>=h&&t<=f&&(n=u),t+i>=h&&t<f)l=h,c=f,o=c-t;else if(t+i<h){a=h;break}}return{len:o,start:l||0,end:c||0,nextStart:a,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||ry}catch(t){return Lt.log("failed to get media.buffered",t),ry}}}const B4=/\{\$([a-zA-Z0-9-_]+)\}/g;function oy(r){return B4.test(r)}function lm(r,e){if(r.variableList!==null||r.hasVariableRefs){const t=r.variableList;return e.replace(B4,i=>{const n=i.substring(2,i.length-1),s=t?.[n];return s===void 0?(r.playlistParsingError||(r.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):s})}return e}function ay(r,e,t){let i=r.variableList;i||(r.variableList=i={});let n,s;if("QUERYPARAM"in e){n=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(n))s=o.get(n);else throw new Error(`"${n}" does not match any query parameter in URI: "${t}"`)}catch(o){r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else n=e.NAME,s=e.VALUE;n in i?r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${n}"`)):i[n]=s||""}function T9(r,e,t){const i=e.IMPORT;if(t&&i in t){let n=r.variableList;n||(r.variableList=n={}),n[i]=t[i]}else r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const b9=/^(\d+)x(\d+)$/,ly=/(.+?)=(".*?"|.*?)(?:,|$)/g;class mi{constructor(e,t){typeof e=="string"&&(e=mi.parseAttrList(e,t)),ei(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,s)=>(n[s.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=b9.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={},s='"';for(ly.lastIndex=0;(i=ly.exec(e))!==null;){const o=i[1].trim();let a=i[2];const l=a.indexOf(s)===0&&a.lastIndexOf(s)===a.length-1;let c=!1;if(l)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":c=!0}if(t&&(l||c))a=lm(t,a);else if(!c&&!l)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Lt.warn(`${e}: attribute ${o} is missing quotes`)}n[o]=a}return n}}const w9="com.apple.hls.interstitial";function B9(r){return r!=="ID"&&r!=="CLASS"&&r!=="CUE"&&r!=="START-DATE"&&r!=="DURATION"&&r!=="END-DATE"&&r!=="END-ON-NEXT"}function R9(r){return r==="SCTE35-OUT"||r==="SCTE35-IN"||r==="SCTE35-CMD"}class SA{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(n=t?.tagOrder)!=null?n:i,t){const s=t.attr;for(const o in s)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==s[o]){Lt.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=ei(new mi({}),s,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const s=t?.endDate||new Date(this.attr["END-DATE"]);Ye(s.getTime())&&(this._endDate=s)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(Lt.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(Ye(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===w9}get isValid(){return!!this.id&&!this._badValueForSameId&&Ye(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const D9=10;class R4{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}get hasProgramDateTime(){return this.fragments.length?Ye(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||D9}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function ca(r){return r==="AES-128"||r==="AES-256"||r==="AES-256-CTR"}function TA(r){switch(r){case"AES-128":case"AES-256":return kr.cbc;case"AES-256-CTR":return kr.ctr;default:throw new Error(`invalid full segment method ${r}`)}}function bA(r){return Uint8Array.from(atob(r),e=>e.charCodeAt(0))}function cm(r){return Uint8Array.from(unescape(encodeURIComponent(r)),e=>e.charCodeAt(0))}function M9(r){const e=cm(r).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function L9(r){const e=function(i,n,s){const o=i[n];i[n]=i[s],i[s]=o};e(r,0,3),e(r,1,2),e(r,4,5),e(r,6,7)}function P9(r){const e=r.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const s=n[0]==="base64",o=n[1];s?(i.splice(-1,1),t=bA(o)):t=M9(o)}}return t}const Ch=typeof self<"u"?self:void 0;var Ht={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},ln={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Ed(r){switch(r){case ln.FAIRPLAY:return Ht.FAIRPLAY;case ln.PLAYREADY:return Ht.PLAYREADY;case ln.WIDEVINE:return Ht.WIDEVINE;case ln.CLEARKEY:return Ht.CLEARKEY}}var tu={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Cd(r){if(r===tu.WIDEVINE)return Ht.WIDEVINE;if(r===tu.PLAYREADY)return Ht.PLAYREADY;if(r===tu.CENC||r===tu.CLEARKEY)return Ht.CLEARKEY}function Id(r){switch(r){case Ht.FAIRPLAY:return ln.FAIRPLAY;case Ht.PLAYREADY:return ln.PLAYREADY;case Ht.WIDEVINE:return ln.WIDEVINE;case Ht.CLEARKEY:return ln.CLEARKEY}}function iu(r){const{drmSystems:e,widevineLicenseUrl:t}=r,i=e?[Ht.FAIRPLAY,Ht.WIDEVINE,Ht.PLAYREADY,Ht.CLEARKEY].filter(n=>!!e[n]):[];return!i[Ht.WIDEVINE]&&t&&i.push(Ht.WIDEVINE),i}const wA=function(r){return Ch!=null&&(r=Ch.navigator)!=null&&r.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function F9(r,e,t,i){let n;switch(r){case Ht.FAIRPLAY:n=["cenc","sinf"];break;case Ht.WIDEVINE:case Ht.PLAYREADY:n=["cenc"];break;case Ht.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${r}`)}return k9(n,e,t,i)}function k9(r,e,t,i){return[{initDataTypes:r,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(s=>({contentType:`audio/mp4; codecs=${s}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(s=>({contentType:`video/mp4; codecs=${s}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function O9(r){var e;return r.sessionType==="persistent-license"||!!((e=r.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function D4(r){const e=new Uint16Array(r.buffer,r.byteOffset,r.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const l=bA(a).subarray(0,16);return L9(l),l}}return null}let nu={};class ya{static clearKeyUriToKeyIdMap(){nu={}}constructor(e,t,i,n=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=s,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!ca(e)}isSupported(){if(this.method){if(ca(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case ln.FAIRPLAY:case ln.WIDEVINE:case ln.PLAYREADY:case ln.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(ca(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(Lt.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=U9(e);return new ya(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=P9(this.uri);if(t)switch(this.keyFormat){case ln.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case ln.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=$8(i,null,t),this.keyId=D4(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){const n=new Uint8Array(16);n.set(i,16-i.length),i=n}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=nu[this.uri];if(!i){const n=Object.keys(nu).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,n),nu[this.uri]=i}this.keyId=i}return this}}function U9(r){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=r>>8*(15-t)&255;return e}const cy=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,uy=/#EXT-X-MEDIA:(.*)/g,N9=/^#EXT(?:INF|-X-TARGETDURATION):/m,_d=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),G9=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ps{static findGroup(e,t){for(let i=0;i<e.length;i++){const n=e[i];if(n.id===t)return n}}static resolve(e,t){return vA.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return N9.test(e)}static parseMasterPlaylist(e,t){const i=oy(e),n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},s=[];cy.lastIndex=0;let o;for(;(o=cy.exec(e))!=null;)if(o[1]){var a;const c=new mi(o[1],n),u=lm(n,o[2]),h={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:ps.resolve(u,t)},f=c.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),dy(c.CODECS,h);const d=c["SUPPLEMENTAL-CODECS"];d&&(h.supplemental={},dy(d,h.supplemental)),(a=h.unknownCodecs)!=null&&a.length||s.push(h),n.levels.push(h)}else if(o[3]){const c=o[3],u=o[4];switch(c){case"SESSION-DATA":{const h=new mi(u,n),f=h["DATA-ID"];f&&(n.sessionData===null&&(n.sessionData={}),n.sessionData[f]=h);break}case"SESSION-KEY":{const h=hy(u,t,n);h.encrypted&&h.isSupported()?(n.sessionKeys===null&&(n.sessionKeys=[]),n.sessionKeys.push(h)):Lt.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new mi(u,n);ay(n,h,t)}break}case"CONTENT-STEERING":{const h=new mi(u,n);n.contentSteering={uri:ps.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{n.startTimeOffset=fy(u);break}}}const l=s.length>0&&s.length<n.levels.length;return n.levels=l?s:n.levels,n.levels.length===0&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,i){let n;const s={},o=i.levels,a={AUDIO:o.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:o.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(uy.lastIndex=0;(n=uy.exec(e))!==null;){const c=new mi(n[1],i),u=c.TYPE;if(u){const h=a[u],f=s[u]||[];s[u]=f;const d=c.LANGUAGE,m=c["ASSOC-LANGUAGE"],A=c.CHANNELS,p=c.CHARACTERISTICS,g=c["INSTREAM-ID"],v={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||d||"",type:u,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:d,url:c.URI?ps.resolve(c.URI,t):""};if(m&&(v.assocLang=m),A&&(v.channels=A),p&&(v.characteristics=p),g&&(v.instreamId=g),h!=null&&h.length){const E=ps.findGroup(h,v.groupId)||h[0];my(v,E,"audioCodec"),my(v,E,"textCodec")}f.push(v)}}return s}static parseLevelPlaylist(e,t,i,n,s,o){var a;const l={url:t},c=new R4(t),u=c.fragments,h=[];let f=null,d=0,m=0,A=0,p=0,g=0,v=null,E=new Vu(n,l),C,I,_,x=-1,S=!1,b=null,T;if(_d.lastIndex=0,c.m3u8=e,c.hasVariableRefs=oy(e),((a=_d.exec(e))==null?void 0:a[0])!=="#EXTM3U")return c.playlistParsingError=new Error("Missing format identifier #EXTM3U"),c;for(;(C=_d.exec(e))!==null;){S&&(S=!1,E=new Vu(n,l),E.playlistOffset=A,E.start=A,E.sn=d,E.cc=p,g&&(E.bitrate=g),E.level=i,f&&(E.initSegment=f,f.rawProgramDateTime&&(E.rawProgramDateTime=f.rawProgramDateTime,f.rawProgramDateTime=null),b&&(E.setByteRange(b),b=null)));const D=C[1];if(D){E.duration=parseFloat(D);const G=(" "+C[2]).slice(1);E.title=G||null,E.tagList.push(G?["INF",D,G]:["INF",D])}else if(C[3]){if(Ye(E.duration)){E.playlistOffset=A,E.start=A,_&&py(E,_,c),E.sn=d,E.level=i,E.cc=p,u.push(E);const G=(" "+C[3]).slice(1);E.relurl=lm(c,G),um(E,v,h),v=E,A+=E.duration,d++,m=0,S=!0}}else{if(C=C[0].match(G9),!C){Lt.warn("No matches on slow regex match for level playlist!");continue}for(I=1;I<C.length&&C[I]===void 0;I++);const G=(" "+C[I]).slice(1),z=(" "+C[I+1]).slice(1),W=C[I+2]?(" "+C[I+2]).slice(1):null;switch(G){case"BYTERANGE":v?E.setByteRange(z,v):E.setByteRange(z);break;case"PROGRAM-DATE-TIME":E.rawProgramDateTime=z,E.tagList.push(["PROGRAM-DATE-TIME",z]),x===-1&&(x=u.length);break;case"PLAYLIST-TYPE":c.type&&Ws(c,G,C),c.type=z.toUpperCase();break;case"MEDIA-SEQUENCE":c.startSN!==0?Ws(c,G,C):u.length>0&&gy(c,G,C),d=c.startSN=parseInt(z);break;case"SKIP":{c.skippedSegments&&Ws(c,G,C);const q=new mi(z,c),F=q.decimalInteger("SKIPPED-SEGMENTS");if(Ye(F)){c.skippedSegments+=F;for(let L=F;L--;)u.push(null);d+=F}const N=q.enumeratedString("RECENTLY-REMOVED-DATERANGES");N&&(c.recentlyRemovedDateranges=(c.recentlyRemovedDateranges||[]).concat(N.split("	")));break}case"TARGETDURATION":c.targetduration!==0&&Ws(c,G,C),c.targetduration=Math.max(parseInt(z),1);break;case"VERSION":c.version!==null&&Ws(c,G,C),c.version=parseInt(z);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":c.live||Ws(c,G,C),c.live=!1;break;case"#":(z||W)&&E.tagList.push(W?[z,W]:[z]);break;case"DISCONTINUITY":p++,E.tagList.push(["DIS"]);break;case"GAP":E.gap=!0,E.tagList.push([G]);break;case"BITRATE":E.tagList.push([G,z]),g=parseInt(z)*1e3,Ye(g)?E.bitrate=g:g=0;break;case"DATERANGE":{const q=new mi(z,c),F=new SA(q,c.dateRanges[q.ID],c.dateRangeTagCount);c.dateRangeTagCount++,F.isValid||c.skippedSegments?c.dateRanges[F.id]=F:Lt.warn(`Ignoring invalid DATERANGE tag: "${z}"`),E.tagList.push(["EXT-X-DATERANGE",z]);break}case"DEFINE":{{const q=new mi(z,c);"IMPORT"in q?T9(c,q,o):ay(c,q,t)}break}case"DISCONTINUITY-SEQUENCE":c.startCC!==0?Ws(c,G,C):u.length>0&&gy(c,G,C),c.startCC=p=parseInt(z);break;case"KEY":{const q=hy(z,t,c);if(q.isSupported()){if(q.method==="NONE"){_=void 0;break}_||(_={}),_[q.keyFormat]&&(_=ei({},_)),_[q.keyFormat]=q}else Lt.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${z}"`);break}case"START":c.startTimeOffset=fy(z);break;case"MAP":{const q=new mi(z,c);if(E.duration){const F=new Vu(n,l);Ay(F,q,i,_),f=F,E.initSegment=f,f.rawProgramDateTime&&!E.rawProgramDateTime&&(E.rawProgramDateTime=f.rawProgramDateTime)}else{const F=E.byteRangeEndOffset;if(F){const N=E.byteRangeStartOffset;b=`${F-N}@${N}`}else b=null;Ay(E,q,i,_),f=E,S=!0}f.cc=p;break}case"SERVER-CONTROL":{T&&Ws(c,G,C),T=new mi(z),c.canBlockReload=T.bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=T.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&T.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=T.optionalFloat("PART-HOLD-BACK",0),c.holdBack=T.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{c.partTarget&&Ws(c,G,C);const q=new mi(z);c.partTarget=q.decimalFloatingPoint("PART-TARGET");break}case"PART":{let q=c.partList;q||(q=c.partList=[]);const F=m>0?q[q.length-1]:void 0,N=m++,L=new mi(z,c),$=new c4(L,E,l,N,F);q.push($),E.duration+=$.duration;break}case"PRELOAD-HINT":{const q=new mi(z,c);c.preloadHint=q;break}case"RENDITION-REPORT":{const q=new mi(z,c);c.renditionReports=c.renditionReports||[],c.renditionReports.push(q);break}default:Lt.warn(`line parsed but not handled: ${C}`);break}}}v&&!v.relurl?(u.pop(),A-=v.duration,c.partList&&(c.fragmentHint=v)):c.partList&&(um(E,v,h),E.cc=p,c.fragmentHint=E,_&&py(E,_,c)),c.targetduration||(c.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const B=u.length,w=u[0],R=u[B-1];if(A+=c.skippedSegments*c.targetduration,A>0&&B&&R){c.averagetargetduration=A/B;const D=R.sn;c.endSN=D!=="initSegment"?D:0,c.live||(R.endList=!0),w&&c.startCC===void 0&&(c.startCC=w.cc),x>0&&(z9(u,x),w&&h.unshift(w))}else c.endSN=0,c.startCC=0;return c.fragmentHint&&(A+=c.fragmentHint.duration),c.totalduration=A,h.length&&c.dateRangeTagCount&&w&&M4(h,c),c.endCC=p,c}}function M4(r,e){const t=r.length,i=r[t-1],n=e.live?1/0:e.totalduration,s=Object.keys(e.dateRanges);for(let o=s.length;o--;){const a=e.dateRanges[s[o]],l=a.startDate.getTime();a.tagAnchor=i.ref;for(let c=t;c--;){const u=Q9(e,l,r,c,n);if(u!==-1){a.tagAnchor=e.fragments[u].ref;break}}}}function Q9(r,e,t,i,n){const s=t[i];if(s){const a=s.programDateTime;if(e>=a||i===0){var o;const l=(((o=t[i+1])==null?void 0:o.start)||n)-s.start;if(e<=a+l*1e3){const c=t[i].sn-r.startSN,u=r.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-r.startSN;for(let d=f;d>c;d--){const m=u[d].programDateTime;if(e>=m&&e<m+u[d].duration*1e3)return d}}return c}}}return-1}function hy(r,e,t){var i,n;const s=new mi(r,t),o=(i=s.METHOD)!=null?i:"",a=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,u=(n=s.KEYFORMAT)!=null?n:"identity";a&&s.IV&&!l&&Lt.error(`Invalid IV: ${s.IV}`);const h=a?ps.resolve(a,e):"",f=(c||"1").split("/").map(Number).filter(Number.isFinite);return new ya(o,h,u,f,l)}function fy(r){const t=new mi(r).decimalFloatingPoint("TIME-OFFSET");return Ye(t)?t:null}function dy(r,e){let t=(r||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const n=t.filter(s=>y4(s,i));n.length&&(e[`${i}Codec`]=n.map(s=>s.split("/")[0]).join(","),t=t.filter(s=>n.indexOf(s)===-1))}),e.unknownCodecs=t}function my(r,e,t){const i=e[t];i&&(r[t]=i)}function z9(r,e){let t=r[e];for(let i=e;i--;){const n=r[i];if(!n)return;n.programDateTime=t.programDateTime-n.duration*1e3,t=n}}function um(r,e,t){r.rawProgramDateTime?t.push(r):e!=null&&e.programDateTime&&(r.programDateTime=e.endProgramDateTime)}function Ay(r,e,t,i){r.relurl=e.URI,e.BYTERANGE&&r.setByteRange(e.BYTERANGE),r.level=t,r.sn="initSegment",i&&(r.levelkeys=i),r.initSegment=null}function py(r,e,t){r.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(n=>e[n].isCommonEncryption)&&i.push(r)}function Ws(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function gy(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function xd(r,e){const t=e.startPTS;if(Ye(t)){let i=0,n;e.sn>r.sn?(i=t-r.start,n=r):(i=r.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>r.sn?r.cc===e.cc&&r.minEndPTS?e.setStart(r.start+(r.minEndPTS-r.start)):e.setStart(r.start+r.duration):e.setStart(Math.max(r.start-e.duration,0))}function L4(r,e,t,i,n,s){i-t<=0&&(Lt.warn("Fragment should have a positive duration",e),i=t+e.duration,s=n+e.duration);let a=t,l=i;const c=e.startPTS,u=e.endPTS;if(Ye(c)){const p=Math.abs(c-t);Ye(e.deltaPTS)?e.deltaPTS=Math.max(p,e.deltaPTS):e.deltaPTS=p,a=Math.max(t,c),t=Math.min(t,c),n=Math.min(n,e.startDTS),l=Math.min(i,u),i=Math.max(i,u),s=Math.max(s,e.endDTS)}const h=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=a,e.startDTS=n,e.endPTS=i,e.minEndPTS=l,e.endDTS=s;const f=e.sn;if(!r||f<r.startSN||f>r.endSN)return 0;let d;const m=f-r.startSN,A=r.fragments;for(A[m]=e,d=m;d>0;d--)xd(A[d],A[d-1]);for(d=m;d<A.length-1;d++)xd(A[d],A[d+1]);return r.fragmentHint&&xd(A[A.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=!0,h}function H9(r,e){if(r===e)return;let t=null;const i=r.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){t=c;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;let n;$9(r,e,(l,c,u,h)=>{if(!e.startCC&&c.cc!==l.cc){var f,d;const m=l.cc-c.cc;for(let A=u;A<h.length;A++)h[A].cc+=m;e.startCC=(f=(d=k4(r,e.startSN-1))==null?void 0:d.cc)!=null?f:h[0].cc,e.endCC=h[h.length-1].cc}Ye(l.startPTS)&&Ye(l.endPTS)&&(c.setStart(c.startPTS=l.startPTS),c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.setDuration(l.endPTS-l.startPTS),c.duration&&(n=c),e.PTSKnown=e.alignedSliding=!0),l.hasStreams&&(c.elementaryStreams=l.elementaryStreams),c.loader=l.loader,l.hasStats&&(c.stats=l.stats),l.initSegment&&(c.initSegment=l.initSegment,t=l.initSegment)});const s=e.fragments,o=e.fragmentHint?s.concat(e.fragmentHint):s;if(t&&o.forEach(l=>{var c;l&&(!l.initSegment||l.initSegment.relurl===((c=t)==null?void 0:c.relurl))&&(l.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=s.some(l=>!l),e.deltaUpdateFailed){Lt.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)s.shift();e.startSN=s[0].sn}else{e.endCC=s[s.length-1].cc,e.canSkipDateRanges&&(e.dateRanges=V9(r.dateRanges,e));const l=r.fragments.filter(c=>c.rawProgramDateTime);if(r.hasProgramDateTime&&!e.hasProgramDateTime)for(let c=1;c<o.length;c++)o[c].programDateTime===null&&um(o[c],o[c-1],l);M4(l,e)}K9(r.partList,e.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),n?L4(e,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS):P4(r,e),s.length&&(e.totalduration=e.edge-s[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;const a=e.advancedDateTime;if(e.advanced&&a){const l=e.edge;e.driftStart||(e.driftStartTime=a,e.driftStart=l),e.driftEndTime=a,e.driftEnd=l}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=r.requestScheduled)}function V9(r,e){const{dateRanges:t,recentlyRemovedDateranges:i}=e,n=ei({},r);i&&i.forEach(a=>{delete n[a]});const o=Object.keys(n).length;return o&&Object.keys(t).forEach(a=>{const l=n[a],c=new SA(t[a].attr,l);c.isValid?(n[a]=c,l||(c.tagOrder+=o)):Lt.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${pi(t[a].attr)}"`)}),n}function K9(r,e,t){if(r&&e){let i=0;for(let n=0,s=r.length;n<=s;n++){const o=r[n],a=e[n+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function $9(r,e,t){const i=e.skippedSegments,n=Math.max(r.startSN,e.startSN)-e.startSN,s=(r.fragmentHint?1:0)+(i?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,o=e.startSN-r.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments;for(let c=n;c<=s;c++){const u=l[o+c];let h=a[c];if(i&&!h&&u&&(h=e.fragments[c]=u),u&&h){if(t(u,h,c,a),u.url&&u.url!==h.url){e.playlistParsingError=yy(`media sequence mismatch ${h.sn}:`,r,e,u,h);return}else if(u.cc!==h.cc){e.playlistParsingError=yy(`discontinuity sequence mismatch (${u.cc}!=${h.cc})`,r,e,u,h);return}}}}function yy(r,e,t,i,n){return new Error(`${r} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function P4(r,e,t=!0){const i=e.startSN+e.skippedSegments-r.startSN,n=r.fragments,s=i>=0;let o=0;if(s&&i<n.length)o=n[i].start;else if(s&&e.startSN===r.endSN+1)o=r.fragmentEnd;else if(s&&t)o=r.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=r.fragmentStart;else return;hm(e,o)}function hm(r,e){if(e){const t=r.fragments;for(let i=r.skippedSegments;i<t.length;i++)t[i].addStart(e);r.fragmentHint&&r.fragmentHint.addStart(e)}}function F4(r,e=1/0){let t=1e3*r.targetduration;if(r.updated){const i=r.fragments;if(i.length&&t*4>e){const s=i[i.length-1].duration*1e3;s<t&&(t=s)}}else t/=2;return Math.round(t)}function k4(r,e,t){if(!r)return null;let i=r.fragments[e-r.startSN];return i||(i=r.fragmentHint,i&&i.sn===e)?i:e<r.startSN&&t&&t.sn===e?t:null}function vy(r,e,t){return r?O4(r.partList,e,t):null}function O4(r,e,t){if(r)for(let i=r.length;i--;){const n=r[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function U4(r){r.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function Gl(r,e){for(let i=0,n=r.length;i<n;i++){var t;if(((t=r[i])==null?void 0:t.cc)===e)return r[i]}return null}function j9(r,e){return!!(r&&e.startCC<r.endCC&&e.endCC>r.startCC)}function Ey(r,e){if(r){const t=r.start+e;r.start=r.startPTS=t,r.endPTS=t+r.duration}}function N4(r,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)Ey(t[i],r);e.fragmentHint&&Ey(e.fragmentHint,r),e.alignedSliding=!0}function Y9(r,e){r&&(G4(e,r),!e.alignedSliding&&r&&Ih(e,r),!e.alignedSliding&&r&&!e.skippedSegments&&P4(r,e,!1))}function G4(r,e){if(!j9(e,r))return;const t=Math.min(e.endCC,r.endCC),i=Gl(e.fragments,t),n=Gl(r.fragments,t);if(!i||!n)return;Lt.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const s=i.start-n.start;N4(s,r)}function Ih(r,e){if(!r.hasProgramDateTime||!e.hasProgramDateTime)return;const t=r.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,s;const o=Math.min(e.endCC,r.endCC);e.startCC<o&&r.startCC<o&&(n=Gl(i,o),s=Gl(t,o)),(!n||!s)&&(n=i[Math.floor(i.length/2)],s=Gl(t,n.cc)||t[Math.floor(t.length/2)]);const a=n.programDateTime,l=s.programDateTime;if(!a||!l)return;const c=(l-a)/1e3-(s.start-n.start);N4(c,r)}const W9={toString:function(r){let e="";const t=r.length;for(let i=0;i<t;i++)e+=`[${r.start(i).toFixed(3)}-${r.end(i).toFixed(3)}]`;return e}},De={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Wh extends w4{constructor(e,t,i,n,s){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=De.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:l,mediaBuffer:c,state:u}=this,h=l?l.currentTime:0,f=Tt.bufferInfo(c||l,h,o.maxBufferHole);if(this.log(`media seeking to ${Ye(h)?h.toFixed(3):h}, state: ${u}`),this.state===De.ENDED)this.resetLoadingState();else if(a){const d=o.maxFragLookUpTolerance,m=a.start-d,A=a.start+a.duration+d;if(!f.len||A<f.start||m>f.end){const p=h>A;(h<m||p)&&(p&&a.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(h,1/0,this.playlistType,!0);const d=this.lastCurrentTime;if(h>d&&(this.lastCurrentTime=h),!this.loadingParts){const m=Math.max(f.end,h),A=this.shouldLoadParts(this.getLevelDetails(),m);A&&(this.log(`LL-Part loading ON after seeking to ${h.toFixed(2)} with buffer @${m.toFixed(2)}`),this.loadingParts=A)}}!this.hls.hasEnoughToStart&&!f.len&&(this.log(`setting startPosition to ${h} because of seek before start`),this.nextLoadPosition=this.startPosition=h),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=s,this.hls=e,this.fragmentLoader=new x9(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new xA(e.config)}registerListeners(){const{hls:e}=this;e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(M.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===De.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=De.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const s=e.nextStart;if(s&&s>n&&s<t.edge||this.media.currentTime<e.start)return!1;const a=t.partList;if(a!=null&&a.length){const c=a[a.length-1];return Tt.isBuffered(this.media,c.start+c.duration/2)}const l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===De.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=De.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=s=>{const o=s.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${s.part?" part: "+s.part.index:""} of ${this.fragInfo(o,!1,s.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(s)};this._doFragLoad(e,t,i,n).then(s=>{if(!s)return;const o=this.state,a=s.frag;if(this.fragContextChanged(a)){(o===De.FRAG_LOADING||!this.fragCurrent&&o===De.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=De.IDLE);return}"payload"in s&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(M.FRAG_LOADED,s)),this._handleFragmentLoadComplete(s)}).catch(s=>{this.state===De.STOPPED||this.state===De.ERROR||(this.warn(`Frag error: ${s?.message||s}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===Ni.APPENDING){const s=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,s),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Ni.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(M.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i?.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:s,payload:o}=i,a=s.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&ca(a.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,TA(a.method)).catch(c=>{throw n.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:s}),c}).then(c=>{const u=self.performance.now();return n.trigger(M.FRAG_DECRYPTED,{frag:s,payload:c,stats:{tstart:l,tdecrypt:u}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===De.STOPPED||this.state===De.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==De.STOPPED&&(this.state=De.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?W9.toString(Tt.getBuffered(i)):"(detached)"})`),Yi(e)){var n;if(e.type!==it.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=De.IDLE;return}}const s=(n=this.levels)==null?void 0:n[e.level];s!=null&&s.fragmentError&&(this.log(`Resetting level fragment error count of ${s.fragmentError} on frag buffered`),s.fragmentError=0)}this.state=De.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:s}=e,o=!s||s.length===0||s.some(l=>!l),a=new Yh(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var s;this.fragCurrent=e;const o=t?.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;e.encrypted&&!((s=e.decryptdata)!=null&&s.key)?(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=De.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(h=>{if(!this.fragContextChanged(h.frag))return this.hls.trigger(M.KEY_LOADED,h),this.state===De.KEY_LOADING&&(this.state=De.IDLE),h}),this.hls.trigger(M.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&o.encryptedFragments.length&&this.keyLoader.loadClear(e,o.encryptedFragments);const l=this.fragPrevious;if(Yi(e)&&(!l||e.sn!==l.sn)){const h=this.shouldLoadParts(t.details,e.end);h!==this.loadingParts&&(this.log(`LL-Part loading ${h?"ON":"OFF"} loading sn ${l?.sn}->${e.sn}`),this.loadingParts=h)}if(i=Math.max(e.start,i||0),this.loadingParts&&Yi(e)){const h=o.partList;if(h&&n){i>e.end&&o.fragmentHint&&(e=o.fragmentHint);const f=this.getNextPart(h,e,i);if(f>-1){const d=h[f];e=this.fragCurrent=d.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${d.index} (${f}/${h.length-1}) of ${this.fragInfo(e,!1,d)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=De.FRAG_LOADING;let m;return a?m=a.then(A=>!A||this.fragContextChanged(A.frag)?null:this.doFragPartsLoad(e,d,t,n)).catch(A=>this.handleFragLoadError(A)):m=this.doFragPartsLoad(e,d,t,n).catch(A=>this.handleFragLoadError(A)),this.hls.trigger(M.FRAG_LOADING,{frag:e,part:d,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):m}else if(!e.url||this.loadedEndOfParts(h,i))return Promise.resolve(null)}}if(Yi(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${o?"["+o.startSN+"-"+o.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),Ye(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=De.FRAG_LOADING;const c=this.config.progressive;let u;return c&&a?u=a.then(h=>!h||this.fragContextChanged(h?.frag)?null:this.fragmentLoader.load(e,n)).catch(h=>this.handleFragLoadError(h)):u=Promise.all([this.fragmentLoader.load(e,c?n:void 0),a]).then(([h])=>(!c&&h&&n&&n(h),h)).catch(h=>this.handleFragLoadError(h)),this.hls.trigger(M.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,i,n){return new Promise((s,o)=>{var a;const l=[],c=(a=i.details)==null?void 0:a.partList,u=h=>{this.fragmentLoader.loadPart(e,h,n).then(f=>{l[h.index]=f;const d=f.part;this.hls.trigger(M.FRAG_LOADED,f);const m=vy(i.details,e.sn,h.index+1)||O4(c,e.sn,h.index+1);if(m)u(m);else return s({frag:e,part:d,partsLoaded:l})}).catch(o)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===me.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(M.ERROR,t)}else this.hls.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==De.PARSING){!this.fragCurrent&&this.state!==De.STOPPED&&this.state!==De.ERROR&&(this.state=De.IDLE);return}const{frag:i,part:n,level:s}=t,o=self.performance.now();i.stats.parsing.end=o,n&&(n.stats.parsing.end=o);const a=this.getLevelDetails(),c=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(i,n,s,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i;const s=e.partList[0],o=s.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>s.start-s.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:s,part:o}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${s} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const a=t[n],l=a.details,c=o>-1?vy(l,s,o):null,u=c?c.fragment:k4(l,s,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:c,level:a}):null}bufferFragmentData(e,t,i,n,s){var o;if(!e||this.state!==De.PARSING)return;const{data1:a,data2:l}=e;let c=a;if(a&&l&&(c=Zn(a,l)),!((o=c)!=null&&o.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:n,parent:t.type,data:c};if(this.hls.trigger(M.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Tt.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=Tt.bufferInfo(t,i,0),s=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,s*.25),a=Math.max(Math.min(e.start-o,n.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!Ye(n))return null;const o=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,o)}getFwdBufferInfoAtPos(e,t,i,n){const s=Tt.bufferInfo(e,t,n);if(s.len===0&&s.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(s.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(s.nextStart,o.end)-t,n);return Tt.bufferInfo(e,t,a)}}return s}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),s=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return s>=n?(i.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0):!1}getAppendedFrag(e,t=it.MAIN){var i;const n=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:s}=this,o=i[0].start,a=s.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const h=s.initialLiveManifestSize;if(n<h)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${h})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var c;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t,i);const f=this.hls.startPosition,d=this.hls.liveSyncPosition,m=l?(f!==-1&&f>=o?f:d)||l.start:e;this.log(`Setting startPosition to ${m} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${d} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=m}}else e<=o&&(l=i[0]);if(!l){const h=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,h,t)}let u=this.filterReplacedPrimary(l,t);if(!u&&l){const h=l.sn-t.startSN;u=this.filterReplacedPrimary(i[h+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Ni.OK||i===Ni.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,s){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(a!==null&&i.len+a.len>=s){const l=o.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(Cy(this.hls.config)){var e,t;if((e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(Cy(this.hls.config)&&e.type!==it.SUBTITLE){const i=this.hls.interstitialsManager,n=i?.bufferingItem;if(n){const o=n.event;if(o){if(o.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&t?.live===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const s=i?.playerQueue;if(s)for(let o=s.length;o--;){const a=s[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,s=!1,o=!0;for(let a=0,l=e.length;a<l;a++){const c=e[a];if(o=o&&!c.independent,n>-1&&i<c.start)break;const u=c.loaded;u?n=-1:(s||c.independent||o)&&c.fragment===t&&(n=a),s=u}return n}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=f9(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const s=i.sn+1;if(s>=e.startSN&&s<=e.endSN){const o=t[s-e.startSN];i.cc===o.cc&&(n=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=T4(t,i.cc),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const s=this.hls.liveSyncPosition;s!==null&&(n=this.getFragmentAtPosition(s,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:s}=this,{fragments:o,endSN:a}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=n,u=i.partList,h=!!(this.loadingParts&&u!=null&&u.length&&l);h&&l&&!this.bitrateTest&&u[u.length-1].fragment.sn===l.sn&&(o=o.concat(l),a=l.sn);let f;if(e<t){var d;const A=e<this.lastCurrentTime||e>t-c||(d=this.media)!=null&&d.paused||!this.startFragRequested?0:c;f=co(s,o,e,A)}else f=o[o.length-1];if(f){const m=f.sn-i.startSN,A=this.fragmentTracker.getState(f);if((A===Ni.OK||A===Ni.PARTIAL&&f.gap)&&(s=f),s&&f.sn===s.sn&&(!h||u[0].fragment.sn>f.sn||!i.live&&!h)&&s&&f.level===s.level){const g=o[m+1];f.sn<a&&this.fragmentTracker.getState(g)!==Ni.OK?f=g:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const s=e.fragmentStart,o=!t,a=e.alignedSliding&&Ye(s);if(o||!a&&!s){Y9(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),l}return s}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const s=this.startTimeOffset!==null,o=s?this.startTimeOffset:e.startTimeOffset;o!==null&&Ye(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${s?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Yi(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==De.FRAG_LOADING_WAITING_RETRY)&&(this.state=De.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const m=this.getCurrentContext(t.chunkMeta);m&&(t.frag=m.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const s=t.details===me.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const o=t.errorAction,{action:a,flags:l,retryCount:c=0,retryConfig:u}=o||{},h=!!o&&!!u,f=h&&a===Ki.RetryRequest,d=h&&!o.resolved&&l===Vn.MoveAllAlternatesMatchingHost;if(!f&&d&&Yi(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),o.resolved=!0;else if((f||d)&&c<u.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const m=_A(u,c);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${c+1}/${u.maxNumRetry} in ${m}ms`),o.resolved=!0,this.retryDate=self.performance.now()+m,this.state=De.FRAG_LOADING_WAITING_RETRY}else if(u&&o)if(this.resetFragmentErrors(e),c<u.maxNumRetry)!s&&a!==Ki.RemoveAlternatePermanently&&(o.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${c})`);return}else a===Ki.SendAlternateToPenaltyBox?this.state=De.WAITING_LEVEL:this.state=De.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===De.PARSING||this.state===De.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),s=n&&n.len>.5;s&&this.reduceMaxBufferLength(n.len,t?.duration||10);const o=!s;return o&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===it.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==De.STOPPED&&(this.state=De.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=Tt.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===De.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==De.STOPPED&&(this.state=De.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const s=i.details;if(!s){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${h})`),l||!1;const f=n?0:L4(s,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(M.LEVEL_PTS_UPDATED,{details:s,level:i,drift:f,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)){var a;if(i.fragmentError===0&&this.treatAsGap(e,i),((a=this.transmuxer)==null?void 0:a.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=De.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(M.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===it.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,s;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((s=t&&!i?e.endPTS:(i||e).end)!=null?s:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function Cy(r){return!!r.interstitialsController&&r.enableInterstitialPlayback!==!1}class Q4{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=q9(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function q9(r,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}var Sd={exports:{}},Iy;function X9(){return Iy||(Iy=1,function(r){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new n(u,h||l,f),m=t?t+c:c;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],d]:l._events[m].push(d):(l._events[m]=d,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)e.call(u,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},a.prototype.listeners=function(c){var u=t?t+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,m=new Array(d);f<d;f++)m[f]=h[f].fn;return m},a.prototype.listenerCount=function(c){var u=t?t+c:c,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(c,u,h,f,d,m){var A=t?t+c:c;if(!this._events[A])return!1;var p=this._events[A],g=arguments.length,v,E;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),g){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,u),!0;case 3:return p.fn.call(p.context,u,h),!0;case 4:return p.fn.call(p.context,u,h,f),!0;case 5:return p.fn.call(p.context,u,h,f,d),!0;case 6:return p.fn.call(p.context,u,h,f,d,m),!0}for(E=1,v=new Array(g-1);E<g;E++)v[E-1]=arguments[E];p.fn.apply(p.context,v)}else{var C=p.length,I;for(E=0;E<C;E++)switch(p[E].once&&this.removeListener(c,p[E].fn,void 0,!0),g){case 1:p[E].fn.call(p[E].context);break;case 2:p[E].fn.call(p[E].context,u);break;case 3:p[E].fn.call(p[E].context,u,h);break;case 4:p[E].fn.call(p[E].context,u,h,f);break;default:if(!v)for(I=1,v=new Array(g-1);I<g;I++)v[I-1]=arguments[I];p[E].fn.apply(p[E].context,v)}}return!0},a.prototype.on=function(c,u,h){return s(this,c,u,h,!1)},a.prototype.once=function(c,u,h){return s(this,c,u,h,!0)},a.prototype.removeListener=function(c,u,h,f){var d=t?t+c:c;if(!this._events[d])return this;if(!u)return o(this,d),this;var m=this._events[d];if(m.fn)m.fn===u&&(!f||m.once)&&(!h||m.context===h)&&o(this,d);else{for(var A=0,p=[],g=m.length;A<g;A++)(m[A].fn!==u||f&&!m[A].once||h&&m[A].context!==h)&&p.push(m[A]);p.length?this._events[d]=p.length===1?p[0]:p:o(this,d)}return this},a.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&o(this,u)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a}(Sd)),Sd.exports}var J9=X9(),BA=R8(J9);const sc="1.6.2",va={};function Z9(){return typeof __HLS_WORKER_BUNDLE__=="function"}function eB(){const r=va[sc];if(r)return r.clientCount++,r;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return va[sc]=n,n}function tB(r){const e=va[r];if(e)return e.clientCount++,e;const t=new self.URL(r,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return va[r]=n,n}function iB(r){const e=va[r||sc];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete va[r||sc],n&&self.URL.revokeObjectURL(n),i.terminate()}}function z4(r,e){return e+10<=r.length&&r[e]===51&&r[e+1]===68&&r[e+2]===73&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function RA(r,e){return e+10<=r.length&&r[e]===73&&r[e+1]===68&&r[e+2]===51&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function qh(r,e){let t=0;return t=(r[e]&127)<<21,t|=(r[e+1]&127)<<14,t|=(r[e+2]&127)<<7,t|=r[e+3]&127,t}function rc(r,e){const t=e;let i=0;for(;RA(r,e);){i+=10;const n=qh(r,e+6);i+=n,z4(r,e+10)&&(i+=10),e+=i}if(i>0)return r.subarray(t,t+i)}function nB(r,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],s=e[t+2],o=s>>2&15;if(o>12){const d=new Error(`invalid ADTS sampling index:${o}`);r.emit(M.ERROR,M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}const a=(s>>6&3)+1,l=e[t+3]>>6&3|(s&1)<<2,c="mp4a.40."+a,u=n[o];let h=o;(a===5||a===29)&&(h-=3);const f=[a<<3|(h&14)>>1,(h&1)<<7|l<<3];return Lt.log(`manifest codec:${i}, parsed codec:${c}, channels:${l}, rate:${u} (ADTS object type:${a} sampling index:${o})`),{config:f,samplerate:u,channelCount:l,codec:c,parsedCodec:c,manifestCodec:i}}function H4(r,e){return r[e]===255&&(r[e+1]&246)===240}function V4(r,e){return r[e+1]&1?7:9}function DA(r,e){return(r[e+3]&3)<<11|r[e+4]<<3|(r[e+5]&224)>>>5}function sB(r,e){return e+5<r.length}function _h(r,e){return e+1<r.length&&H4(r,e)}function rB(r,e){return sB(r,e)&&H4(r,e)&&DA(r,e)<=r.length-e}function oB(r,e){if(_h(r,e)){const t=V4(r,e);if(e+t>=r.length)return!1;const i=DA(r,e);if(i<=t)return!1;const n=e+i;return n===r.length||_h(r,n)}return!1}function K4(r,e,t,i,n){if(!r.samplerate){const s=nB(e,t,i,n);if(!s)return;ei(r,s)}}function $4(r){return 1024*9e4/r}function aB(r,e){const t=V4(r,e);if(e+t<=r.length){const i=DA(r,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function j4(r,e,t,i,n){const s=$4(r.samplerate),o=i+n*s,a=aB(e,t);let l;if(a){const{frameLength:h,headerLength:f}=a,d=f+h,m=Math.max(0,t+d-e.length);m?(l=new Uint8Array(d-f),l.set(e.subarray(t+f,e.length),0)):l=e.subarray(t+f,t+d);const A={unit:l,pts:o};return m||r.samples.push(A),{sample:A,length:d,missing:m}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:o},length:c,missing:-1}}function lB(r,e){return RA(r,e)&&qh(r,e+6)+10<=r.length-e}function cB(r){if(r.size<2)return;const e=Mn(r.data,!0),t=new Uint8Array(r.data.subarray(e.length+1));return{key:r.type,info:e,data:t.buffer}}function uB(r){if(r.size<2)return;if(r.type==="TXXX"){let t=1;const i=Mn(r.data.subarray(t),!0);t+=i.length+1;const n=Mn(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Mn(r.data.subarray(1));return{key:r.type,info:"",data:e}}function hB(r){if(r.type==="WXXX"){if(r.size<2)return;let t=1;const i=Mn(r.data.subarray(t),!0);t+=i.length+1;const n=Mn(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Mn(r.data);return{key:r.type,info:"",data:e}}function fB(r){return btoa(String.fromCharCode(...r))}function Y4(r,e){if(r<0)return-Y4(-r,e);const t=Math.pow(10,e);if(Math.abs(r*t%1-.5)<Number.EPSILON){const n=Math.floor(r*t);return(n%2===0?n:n+1)/t}else return Math.round(r*t)/t}function dB(r,e){const t=new URL(r),i=new URL(e);if(t.origin!==i.origin)return r;const n=t.pathname.split("/").slice(1),s=i.pathname.split("/").slice(1,-1);for(;n[0]===s[0];)n.shift(),s.shift();for(;s.length;)s.shift(),n.unshift("..");return n.join("/")}function mB(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const s=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(n=="x"?s:s&3|8).toString(16)})}}}function AB(r){return r instanceof ArrayBuffer?r:r.byteOffset==0&&r.byteLength==r.buffer.byteLength?r.buffer:new Uint8Array(r).buffer}function Td(r,e=0,t=1/0){return pB(r,e,t,Uint8Array)}function pB(r,e,t,i){const n=gB(r);let s=1;"BYTES_PER_ELEMENT"in i&&(s=i.BYTES_PER_ELEMENT);const o=yB(r)?r.byteOffset:0,a=(o+r.byteLength)/s,l=(o+e)/s,c=Math.floor(Math.max(0,Math.min(l,a))),u=Math.floor(Math.min(c+Math.max(t,0),a));return new i(n,c,u-c)}function gB(r){return r instanceof ArrayBuffer?r:r.buffer}function yB(r){return r&&r.buffer instanceof ArrayBuffer&&r.byteLength!==void 0&&r.byteOffset!==void 0}function vB(r){const e={key:r.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(r.size<2)return;if(r.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=r.data.subarray(1).indexOf(0);if(i===-1)return;const n=Mn(Td(r.data,1,i)),s=r.data[2+i],o=r.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=Mn(Td(r.data,3+i,o));let l;return n==="-->"?l=Mn(Td(r.data,4+i+o)):l=AB(r.data.subarray(4+i+o)),e.mimeType=n,e.pictureType=s,e.description=a,e.data=l,e}function EB(r){return r.type==="PRIV"?cB(r):r.type[0]==="W"?hB(r):r.type==="APIC"?vB(r):uB(r)}function CB(r){const e=String.fromCharCode(r[0],r[1],r[2],r[3]),t=qh(r,4),i=10;return{type:e,size:t,data:r.subarray(i,i+t)}}const su=10,IB=10;function W4(r){let e=0;const t=[];for(;RA(r,e);){const i=qh(r,e+6);r[e+5]>>6&1&&(e+=su),e+=su;const n=e+i;for(;e+IB<n;){const s=CB(r.subarray(e)),o=EB(s);o&&t.push(o),e+=s.size+su}z4(r,e)&&(e+=su)}return t}function q4(r){return r&&r.key==="PRIV"&&r.info==="com.apple.streaming.transportStreamTimestamp"}function _B(r){if(r.data.byteLength===8){const e=new Uint8Array(r.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function MA(r){const e=W4(r);for(let t=0;t<e.length;t++){const i=e[t];if(q4(i))return _B(i)}}let vn=function(r){return r.audioId3="org.id3",r.dateRange="com.apple.quicktime.HLS",r.emsg="https://aomedia.org/emsg/ID3",r.misbklv="urn:misb:KLV:bin:1910.1",r}({});function Ms(r="",e=9e4){return{type:r,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class LA{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Zn(this.cachedData,e),this.cachedData=null);let i=rc(e,0),n=i?i.length:0,s;const o=this._audioTrack,a=this._id3Track,l=i?MA(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&Ye(l))&&(this.basePTS=xB(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:vn.audioId3,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(e,n)){const u=this.appendFrame(o,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,s=n):n=c}else lB(e,n)?(i=rc(e,n),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:vn.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,s=n):n++;if(n===c&&s!==c){const u=e.slice(s);this.cachedData?this.cachedData=Zn(this.cachedData,u):this.cachedData=u}}return{audioTrack:o,videoTrack:Ms(),id3Track:a,textTrack:Ms()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Ms(),id3Track:this._id3Track,textTrack:Ms()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const xB=(r,e,t)=>{if(Ye(r))return r*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let ru=null;const SB=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],TB=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],bB=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],wB=[0,1,1,4];function X4(r,e,t,i,n){if(t+24>e.length)return;const s=J4(e,t);if(s&&t+s.frameLength<=e.length){const o=s.samplesPerFrame*9e4/s.sampleRate,a=i+n*o,l={unit:e.subarray(t,t+s.frameLength),pts:a,dts:a};return r.config=[],r.channelCount=s.channelCount,r.samplerate=s.sampleRate,r.samples.push(l),{sample:l,length:s.frameLength,missing:0}}}function J4(r,e){const t=r[e+1]>>3&3,i=r[e+1]>>1&3,n=r[e+2]>>4&15,s=r[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&s!==3){const o=r[e+2]>>1&1,a=r[e+3]>>6,l=t===3?3-i:i===3?3:4,c=SB[l*14+n-1]*1e3,h=TB[(t===3?0:t===2?1:2)*3+s],f=a===3?1:2,d=bB[t][i],m=wB[i],A=d*8*m,p=Math.floor(d*c/h+o)*m;if(ru===null){const E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ru=E?parseInt(E[1]):0}return!!ru&&ru<=87&&i===2&&c>=224e3&&a===0&&(r[e+3]=r[e+3]|128),{sampleRate:h,channelCount:f,frameLength:p,samplesPerFrame:A}}}function PA(r,e){return r[e]===255&&(r[e+1]&224)===224&&(r[e+1]&6)!==0}function Z4(r,e){return e+1<r.length&&PA(r,e)}function BB(r,e){return PA(r,e)&&4<=r.length-e}function eC(r,e){if(e+1<r.length&&PA(r,e)){const i=J4(r,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const s=e+n;return s===r.length||Z4(r,s)}return!1}class RB extends LA{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=rc(e,0);let n=i?.length||0;if(eC(e,n))return!1;for(let s=e.length;n<s;n++)if(oB(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return rB(e,t)}appendFrame(e,t,i){K4(e,this.observer,t,i,e.manifestCodec);const n=j4(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const tC=(r,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),s=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=r[e];const a=Math.min(i,8),l=8-a;s[0]=4278190080>>>24+l<<l,n[0]=(o[0]&s[0])>>l,t=t?t<<a|n[0]:n[0],e+=1,i-=a}return t};class DB extends LA{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=iC(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=rc(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&MA(t)!==void 0&&tC(e,i)<16}}function iC(r,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const s=e[t+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+s]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const d=(e[t+6]<<8|e[t+7])>>12-f&1,A=[2,1,2,3,3,4,4,5][h]+d,p=e[t+5]>>3,g=e[t+5]&7,v=new Uint8Array([s<<6|p<<1|g>>2,(g&3)<<6|h<<3|d<<2|l>>4,l<<4&224]),E=1536/a*9e4,C=i+n*E,I=e.subarray(t,t+u);return r.config=v,r.channelCount=A,r.samplerate=a,r.samples.push({unit:I,pts:C}),u}class MB extends LA{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=rc(e,0);let i=t?.length||0;if(t&&e[i]===11&&e[i+1]===119&&MA(t)!==void 0&&tC(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(eC(e,i))return Lt.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return BB(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return X4(e,t,i,this.basePTS,this.frameIndex)}}const LB=/\/emsg[-/]ID3/i;class PB{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const s=this.videoTrack=Ms("video",1),o=this.audioTrack=Ms("audio",1),a=this.txtTrack=Ms("text",1);if(this.id3Track=Ms("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=m4(e);if(l.video){const{id:c,timescale:u,codec:h,supplemental:f}=l.video;s.id=c,s.timescale=a.timescale=u,s.codec=h,s.supplemental=f}if(l.audio){const{id:c,timescale:u,codec:h}=l.audio;o.id=c,o.timescale=u,o.codec=h}a.id=h4.text,s.sampleDuration=0,s.duration=o.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return P8(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Zn(this.remainderData,e));const a=z8(i);this.remainderData=a.remainder,n.samples=a.valid||new Uint8Array}else n.samples=i;const o=this.extractID3Track(n,t);return s.samples=V1(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=V1(e,t),{videoTrack:t,audioTrack:Ms(),id3Track:n,textTrack:Ms()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=vt(e.samples,["emsg"]);n&&n.forEach(s=>{const o=V8(s);if(LB.test(o.schemeIdUri)){const a=_y(o,t);let l=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=o.payload;i.samples.push({data:c,len:c.byteLength,dts:a,pts:a,type:vn.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=_y(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:vn.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function _y(r,e){return Ye(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale}class FB{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new xA(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,kr.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const s=n.subarray(16,n.length-n.length%16),o=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(o).then(a=>{const l=new Uint8Array(a);n.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)i.set(e.subarray(s,s+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)e.set(i.subarray(n,n+16),s);return e}decryptAvcSample(e,t,i,n,s){const o=p4(s.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(l=>{s.data=this.getAvcDecryptedUnit(o,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)})}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const s=e[t].units;for(;!(i>=s.length);i++){const o=s[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,n,o),!this.decrypter.isSync()))return}}}}class nC{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const s=i.units;n=s[s.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const s=i[n-1];e.pts=s.pts,e.dts=s.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let s=e.naluState||0;const o=s,a=[];let l=0,c,u,h,f=-1,d=0;for(s===-1&&(f=0,d=this.getNALuType(t,0),s=0,l=1);l<n;){if(c=t[l++],!s){s=c?0:1;continue}if(s===1){s=c?0:2;continue}if(!c)s=3;else if(c===1){if(u=l-s-1,f>=0){const m={data:t.subarray(f,u),type:d};a.push(m)}else{const m=this.getLastNalUnit(e.samples);m&&(o&&l<=4-o&&m.state&&(m.data=m.data.subarray(0,m.data.byteLength-o)),u>0&&(m.data=Zn(m.data,t.subarray(0,u)),m.state=0))}l<n?(h=this.getNALuType(t,l),f=l,d=h,s=0):s=-1}else s=0}if(f>=0&&s>=0){const m={data:t.subarray(f,n),type:d,state:s};a.push(m)}if(a.length===0){const m=this.getLastNalUnit(e.samples);m&&(m.data=Zn(m.data,t))}return e.naluState=s,a}}class Ql{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),s=Math.min(4,t);if(s===0)throw new Error("no bytes available");n.set(e.subarray(i,i+s)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&Lt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class xy extends nC{parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 1:{let A=!1;a=!0;const p=c.data;if(l&&p.length>4){const g=this.readSliceType(p);(g===2||g===4||g===7||g===9)&&(A=!0)}if(A){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=A;break}case 5:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,CA(c.data,1,i.pts,t.samples);break}case 7:{var d,m;a=!0,l=!0;const A=c.data,p=this.readSPS(A);if(!e.sps||e.width!==p.width||e.height!==p.height||((d=e.pixelRatio)==null?void 0:d[0])!==p.pixelRatio[0]||((m=e.pixelRatio)==null?void 0:m[1])!==p.pixelRatio[1]){e.width=p.width,e.height=p.height,e.pixelRatio=p.pixelRatio,e.sps=[A];const g=A.subarray(1,4);let v="avc1.";for(let E=0;E<3;E++){let C=g[E].toString(16);C.length<2&&(C="0"+C),v+=C}e.codec=v}break}case 8:a=!0,e.pps=[c.data];break;case 9:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new Ql(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,s;for(let o=0;o<e;o++)n!==0&&(s=t.readEG(),n=(i+s+256)%256),i=n===0?i:n}readSPS(e){const t=new Ql(e);let i=0,n=0,s=0,o=0,a,l,c;const u=t.readUByte.bind(t),h=t.readBits.bind(t),f=t.readUEG.bind(t),d=t.readBoolean.bind(t),m=t.skipBits.bind(t),A=t.skipEG.bind(t),p=t.skipUEG.bind(t),g=this.skipScalingList.bind(this);u();const v=u();if(h(5),m(3),u(),p(),v===100||v===110||v===122||v===244||v===44||v===83||v===86||v===118||v===128){const S=f();if(S===3&&m(1),p(),p(),m(1),d())for(l=S!==3?8:12,c=0;c<l;c++)d()&&(c<6?g(16,t):g(64,t))}p();const E=f();if(E===0)f();else if(E===1)for(m(1),A(),A(),a=f(),c=0;c<a;c++)A();p(),m(1);const C=f(),I=f(),_=h(1);_===0&&m(1),m(1),d()&&(i=f(),n=f(),s=f(),o=f());let x=[1,1];if(d()&&d())switch(u()){case 1:x=[1,1];break;case 2:x=[12,11];break;case 3:x=[10,11];break;case 4:x=[16,11];break;case 5:x=[40,33];break;case 6:x=[24,11];break;case 7:x=[20,11];break;case 8:x=[32,11];break;case 9:x=[80,33];break;case 10:x=[18,11];break;case 11:x=[15,11];break;case 12:x=[64,33];break;case 13:x=[160,99];break;case 14:x=[4,3];break;case 15:x=[3,2];break;case 16:x=[2,1];break;case 255:{x=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((C+1)*16-i*2-n*2),height:(2-_)*(I+1)*16-(_?2:4)*(s+o),pixelRatio:x}}}class Sy extends nC{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,l){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,CA(c.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=ei(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(a=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const d=this.readSPS(c.data);e.width=d.width,e.height=d.height,e.pixelRatio=d.pixelRatio,e.codec=d.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const m in d.params)e.params[m]=d.params[m]}this.pushParameterSet(e.sps,c.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const d=this.readPPS(c.data);for(const m in d)e.params[m]=d[m]}this.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new Ql(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new Ql(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),s=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),l=t.readUByte(),c=t.readUByte(),u=t.readUByte(),h=t.readUByte(),f=t.readUByte(),d=t.readUByte(),m=t.readUByte(),A=t.readUByte(),p=t.readUByte(),g=t.readUByte(),v=[],E=[];for(let ce=0;ce<i;ce++)v.push(t.readBoolean()),E.push(t.readBoolean());if(i>0)for(let ce=i;ce<8;ce++)t.readBits(2);for(let ce=0;ce<i;ce++)v[ce]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),E[ce]&&t.readUByte();t.readUEG();const C=t.readUEG();C==3&&t.skipBits(1);const I=t.readUEG(),_=t.readUEG(),x=t.readBoolean();let S=0,b=0,T=0,B=0;x&&(S+=t.readUEG(),b+=t.readUEG(),T+=t.readUEG(),B+=t.readUEG());const w=t.readUEG(),R=t.readUEG(),D=t.readUEG(),G=t.readBoolean();for(let ce=G?0:i;ce<=i;ce++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let Ae=0;Ae<4;Ae++)for(let he=0;he<(Ae===3?2:6);he++)if(!t.readBoolean())t.readUEG();else{const J=Math.min(64,1<<4+(Ae<<1));Ae>1&&t.readEG();for(let ue=0;ue<J;ue++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const q=t.readUEG();let F=0;for(let ce=0;ce<q;ce++){let Ae=!1;if(ce!==0&&(Ae=t.readBoolean()),Ae){ce===q&&t.readUEG(),t.readBoolean(),t.readUEG();let he=0;for(let Z=0;Z<=F;Z++){const J=t.readBoolean();let ue=!1;J||(ue=t.readBoolean()),(J||ue)&&he++}F=he}else{const he=t.readUEG(),Z=t.readUEG();F=he+Z;for(let J=0;J<he;J++)t.readUEG(),t.readBoolean();for(let J=0;J<Z;J++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const ce=t.readUEG();for(let Ae=0;Ae<ce;Ae++){for(let he=0;he<D+4;he++)t.readBits(1);t.readBits(1)}}let L=0,$=1,j=1,V=!0,k=1,Q=0;t.readBoolean(),t.readBoolean();let O=!1;if(t.readBoolean()){if(t.readBoolean()){const Te=t.readUByte(),we=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Le=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Te>0&&Te<16?($=we[Te-1],j=Le[Te-1]):Te===255&&($=t.readBits(16),j=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),O=t.readBoolean(),O&&(S+=t.readUEG(),b+=t.readUEG(),T+=t.readUEG(),B+=t.readUEG()),t.readBoolean()&&(k=t.readBits(32),Q=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const Le=t.readBoolean(),Be=t.readBoolean();let qe=!1;(Le||Be)&&(qe=t.readBoolean(),qe&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),qe&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Oe=0;Oe<=i;Oe++){V=t.readBoolean();const Ke=V||t.readBoolean();let $e=!1;Ke?t.readEG():$e=t.readBoolean();const Ze=$e?1:t.readUEG()+1;if(Le)for(let ut=0;ut<Ze;ut++)t.readUEG(),t.readUEG(),qe&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(Be)for(let ut=0;ut<Ze;ut++)t.readUEG(),t.readUEG(),qe&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),L=t.readUEG())}let te=I,le=_;if(x||O){let ce=1,Ae=1;C===1?ce=Ae=2:C==2&&(ce=2),te=I-ce*b-ce*S,le=_-Ae*B-Ae*T}const ee=n?["A","B","C"][n]:"",se=a<<24|l<<16|c<<8|u;let Ee=0;for(let ce=0;ce<32;ce++)Ee=(Ee|(se>>ce&1)<<31-ce)>>>0;let Ie=Ee.toString(16);return o===1&&Ie==="2"&&(Ie="6"),{codecString:`hvc1.${ee}${o}.${Ie}.${s?"H":"L"}${g}.B0`,params:{general_tier_flag:s,general_profile_idc:o,general_profile_space:n,general_profile_compatibility_flags:[a,l,c,u],general_constraint_indicator_flags:[h,f,d,m,A,p],general_level_idc:g,bit_depth:w+8,bit_depth_luma_minus8:w,bit_depth_chroma_minus8:R,min_spatial_segmentation_idc:L,chroma_format_idc:C,frame_rate:{fixed:V,fps:Q/k}},width:te,height:le,pixelRatio:[$,j]}}readPPS(e){const t=new Ql(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),s=t.readBoolean();let o=1;return s&&n?o=0:s?o=3:n&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Vi=188;class Tr{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=Tr.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Vi*5,t-Vi)+1,n=0;for(;n<i;){let s=!1,o=-1,a=0;for(let l=n;l<t;l+=Vi)if(e[l]===71&&(t-l===Vi||e[l+Vi]===71)){if(a++,o===-1&&(o=l,o!==0&&(i=Math.min(o+Vi*99,e.length-Vi)+1)),s||(s=fm(e,l)===0),s&&a>1&&(o===0&&a>2||l+Vi>i))return o}else{if(a)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:h4[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Tr.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=Tr.createTrack("audio",n),this._id3Track=Tr.createTrack("id3"),this._txtTrack=Tr.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let s;const o=this._videoTrack,a=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=o.pid,h=o.pesData,f=a.pid,d=l.pid,m=a.pesData,A=l.pesData,p=null,g=this.pmtParsed,v=this._pmtId,E=e.length;if(this.remainderData&&(e=Zn(this.remainderData,e),E=e.length,this.remainderData=null),E<Vi&&!n)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};const C=Math.max(0,Tr.syncOffset(e));E-=(E-C)%Vi,E<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,E,e.buffer.byteLength-E));let I=0;for(let x=C;x<E;x+=Vi)if(e[x]===71){const S=!!(e[x+1]&64),b=fm(e,x),T=(e[x+3]&48)>>4;let B;if(T>1){if(B=x+5+e[x+4],B===x+Vi)continue}else B=x+4;switch(b){case u:if(S){if(h&&(s=Bo(h,this.logger))){if(this.videoParser===null)switch(o.segmentCodec){case"avc":this.videoParser=new xy;break;case"hevc":this.videoParser=new Sy;break}this.videoParser!==null&&this.videoParser.parsePES(o,c,s,!1)}h={data:[],size:0}}h&&(h.data.push(e.subarray(B,x+Vi)),h.size+=x+Vi-B);break;case f:if(S){if(m&&(s=Bo(m,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s);break;case"ac3":this.parseAC3PES(a,s);break}m={data:[],size:0}}m&&(m.data.push(e.subarray(B,x+Vi)),m.size+=x+Vi-B);break;case d:S&&(A&&(s=Bo(A,this.logger))&&this.parseID3PES(l,s),A={data:[],size:0}),A&&(A.data.push(e.subarray(B,x+Vi)),A.size+=x+Vi-B);break;case 0:S&&(B+=e[B]+1),v=this._pmtId=kB(e,B);break;case v:{S&&(B+=e[B]+1);const w=OB(e,B,this.typeSupported,i,this.observer,this.logger);u=w.videoPid,u>0&&(o.pid=u,o.segmentCodec=w.segmentVideoCodec),f=w.audioPid,f>0&&(a.pid=f,a.segmentCodec=w.segmentAudioCodec),d=w.id3Pid,d>0&&(l.pid=d),p!==null&&!g&&(this.logger.warn(`MPEG-TS PMT found at ${x} after unknown PID '${p}'. Backtracking to sync byte @${C} to parse all TS packets.`),p=null,x=C-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=b;break}}else I++;I>0&&dm(this.observer,new Error(`Found ${I} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=h,a.pesData=m,l.pesData=A;const _={audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};return n&&this.extractRemainingSamples(_),_}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:s}=e,o=i.pesData,a=t.pesData,l=n.pesData;let c;if(o&&(c=Bo(o,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new xy;break;case"hevc":this.videoParser=new Sy;break}this.videoParser!==null&&(this.videoParser.parsePES(i,s,c,!0),i.pesData=null)}else i.pesData=o;if(a&&(c=Bo(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;l&&(c=Bo(l,this.logger))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=l}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),s=this.sampleAes=new FB(this.observer,this.config,t);return this.decrypt(n,s)}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:s}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,()=>{i(e)}):i(e)}):s.samples&&t.decryptAvcSamples(s.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let s=t.data;if(n){this.aacOverFlow=null;const h=n.missing,f=n.sample.unit.byteLength;if(h===-1)s=Zn(n.sample.unit,s);else{const d=f-h;n.sample.unit.set(s.subarray(0,h),d),e.samples.push(n.sample),i=n.missing}}let o,a;for(o=i,a=s.length;o<a-1&&!_h(s,o);o++);if(o!==i){let h;const f=o<a-1;if(f?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",dm(this.observer,new Error(h),f,this.logger),!f)return}K4(e,this.observer,s,o,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(n){const h=$4(e.samplerate);l=n.sample.pts+h}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;o<a;)if(u=j4(e,s,o,l,c),o+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;o<a-1&&!_h(s,o);o++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let s=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<n;)if(Z4(i,o)){const l=X4(e,i,o,a,s);if(l)o+=l.length,s++;else break}else o++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const s=i.length;let o=0,a=0,l;for(;a<s&&(l=iC(e,i,a,n,o++))>0;)a+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=ei({},t,{type:this._videoTrack?vn.emsg:vn.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function fm(r,e){return((r[e+1]&31)<<8)+r[e+2]}function kB(r,e){return(r[e+10]&31)<<8|r[e+11]}function OB(r,e,t,i,n,s){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(r[e+1]&15)<<8|r[e+2],l=e+3+a-4,c=(r[e+10]&15)<<8|r[e+11];for(e+=12+c;e<l;){const u=fm(r,e),h=(r[e+3]&15)<<8|r[e+4];switch(r[e]){case 207:if(!i){bd("ADTS AAC",s);break}case 15:o.audioPid===-1&&(o.audioPid=u);break;case 21:o.id3Pid===-1&&(o.id3Pid=u);break;case 219:if(!i){bd("H.264",s);break}case 27:o.videoPid===-1&&(o.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?s.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="mp3");break;case 193:if(!i){bd("AC-3",s);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="ac3"):s.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&h>0){let f=e+5,d=h;for(;d>2;){switch(r[f]){case 106:t.ac3!==!0?s.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=u,o.segmentAudioCodec="ac3");break}const A=r[f+1]+2;f+=A,d-=A}}break;case 194:case 135:return dm(n,new Error("Unsupported EC-3 in M2TS found"),void 0,s),o;case 36:o.videoPid===-1&&(o.videoPid=u,o.segmentVideoCodec="hevc",s.log("HEVC in M2TS found"));break}e+=h+5}return o}function dm(r,e,t,i){i.warn(`parsing error: ${e.message}`),r.emit(M.ERROR,M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function bd(r,e){e.log(`${r} with AES-128-CBC encryption found in unencrypted stream`)}function Bo(r,e){let t=0,i,n,s,o,a;const l=r.data;if(!r||r.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=Zn(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>r.size-6)return null;const u=i[7];u&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),s=i[8];let h=s+9;if(r.size<=h)return null;r.size-=h;const f=new Uint8Array(r.size);for(let d=0,m=l.length;d<m;d++){i=l[d];let A=i.byteLength;if(h)if(h>A){h-=A;continue}else i=i.subarray(h),A-=h,h=0;f.set(i,t),t+=A}return n&&(n-=s+3),{data:f,pts:o,dts:a,len:n}}return null}class UB{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const vr=Math.pow(2,32)-1;class fe{static init(){fe.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in fe.types)fe.types.hasOwnProperty(e)&&(fe.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);fe.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);fe.STTS=fe.STSC=fe.STCO=s,fe.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),fe.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),fe.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),fe.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);fe.FTYP=fe.box(fe.types.ftyp,o,l,o,a),fe.DINF=fe.box(fe.types.dinf,fe.box(fe.types.dref,n))}static box(e,...t){let i=8,n=t.length;const s=n;for(;n--;)i+=t[n].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),n=0,i=8;n<s;n++)o.set(t[n],i),i+=t[n].byteLength;return o}static hdlr(e){return fe.box(fe.types.hdlr,fe.HDLR_TYPES[e])}static mdat(e){return fe.box(fe.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(vr+1)),n=Math.floor(t%(vr+1));return fe.box(fe.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return fe.box(fe.types.mdia,fe.mdhd(e.timescale||0,e.duration||0),fe.hdlr(e.type),fe.minf(e))}static mfhd(e){return fe.box(fe.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?fe.box(fe.types.minf,fe.box(fe.types.smhd,fe.SMHD),fe.DINF,fe.stbl(e)):fe.box(fe.types.minf,fe.box(fe.types.vmhd,fe.VMHD),fe.DINF,fe.stbl(e))}static moof(e,t,i){return fe.box(fe.types.moof,fe.mfhd(e),fe.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=fe.trak(e[t]);return fe.box.apply(null,[fe.types.moov,fe.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(fe.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=fe.trex(e[t]);return fe.box.apply(null,[fe.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(vr+1)),n=Math.floor(t%(vr+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return fe.box(fe.types.mvhd,s)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,s;for(n=0;n<t.length;n++)s=t[n].flags,i[n+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return fe.box(fe.types.sdtp,i)}static stbl(e){return fe.box(fe.types.stbl,fe.stsd(e),fe.box(fe.types.stts,fe.STTS),fe.box(fe.types.stsc,fe.STSC),fe.box(fe.types.stsz,fe.STSZ),fe.box(fe.types.stco,fe.STCO))}static avc1(e){let t=[],i=[],n,s,o;for(n=0;n<e.sps.length;n++)s=e.sps[n],o=s.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(s));for(n=0;n<e.pps.length;n++)s=e.pps[n],o=s.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(s));const a=fe.box(fe.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return fe.box(fe.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,fe.box(fe.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),fe.box(fe.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return fe.box(fe.types.mp4a,fe.audioStsd(e),fe.box(fe.types.esds,fe.esds(e)))}static mp3(e){return fe.box(fe.types[".mp3"],fe.audioStsd(e))}static ac3(e){return fe.box(fe.types["ac-3"],fe.audioStsd(e),fe.box(fe.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return fe.box(fe.types.stsd,fe.STSD,fe.mp4a(e));if(t==="ac3"&&e.config)return fe.box(fe.types.stsd,fe.STSD,fe.ac3(e));if(t==="mp3"&&e.codec==="mp3")return fe.box(fe.types.stsd,fe.STSD,fe.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return fe.box(fe.types.stsd,fe.STSD,fe.avc1(e));if(t==="hevc"&&e.vps)return fe.box(fe.types.stsd,fe.STSD,fe.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,s=e.height||0,o=Math.floor(i/(vr+1)),a=Math.floor(i%(vr+1));return fe.box(fe.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,s>>8&255,s&255,0,0]))}static traf(e,t){const i=fe.sdtp(e),n=e.id,s=Math.floor(t/(vr+1)),o=Math.floor(t%(vr+1));return fe.box(fe.types.traf,fe.box(fe.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),fe.box(fe.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,o>>24,o>>16&255,o>>8&255,o&255])),fe.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,fe.box(fe.types.trak,fe.tkhd(e),fe.mdia(e))}static trex(e){const t=e.id;return fe.box(fe.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,s=12+16*n,o=new Uint8Array(s);let a,l,c,u,h,f;for(t+=8+s,o.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<n;a++)l=i[a],c=l.duration,u=l.size,h=l.flags,f=l.cts,o.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*a);return fe.box(fe.types.trun,o)}static initSegment(e){fe.types||fe.init();const t=fe.moov(e);return Zn(fe.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,s=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=s.length;for(let m=0;m<i.length;m+=1){o+=3;for(let A=0;A<i[m].length;A+=1)o+=2+i[m][A].length}const a=new Uint8Array(o);a.set(s,0),o=s.length;const l=i.length-1;for(let m=0;m<i.length;m+=1){a.set(new Uint8Array([32+m|(m===l?128:0),0,i[m].length]),o),o+=3;for(let A=0;A<i[m].length;A+=1)a.set(new Uint8Array([i[m][A].length>>8,i[m][A].length&255]),o),o+=2,a.set(i[m][A],o),o+=i[m][A].length}const c=fe.box(fe.types.hvcC,a),u=e.width,h=e.height,f=e.pixelRatio[0],d=e.pixelRatio[1];return fe.box(fe.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,fe.box(fe.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),fe.box(fe.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,d>>24,d>>16&255,d>>8&255,d&255])))}}fe.types=void 0;fe.HDLR_TYPES=void 0;fe.STTS=void 0;fe.STSC=void 0;fe.STCO=void 0;fe.STSZ=void 0;fe.VMHD=void 0;fe.SMHD=void 0;fe.STSD=void 0;fe.FTYP=void 0;fe.DINF=void 0;const sC=9e4;function FA(r,e,t=1,i=!1){const n=r*e*t;return i?Math.round(n):n}function NB(r,e,t=1,i=!1){return FA(r,e,1/t,i)}function ll(r,e=!1){return FA(r,1e3,1/sC,e)}function GB(r,e=1){return FA(r,sC,1/e)}const QB=10*1e3,zB=1024,HB=1152,VB=1536;let Ro=null,wd=null;function Ty(r,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:r?2:1,isNonSync:r?0:1}}}class $u{constructor(e,t,i,n){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.ISGenerated=!1,Ro===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ro=o?parseInt(o[1]):0}if(wd===null){const s=navigator.userAgent.match(/Safari\/(\d+)/i);wd=s?parseInt(s[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((s,o)=>{let a=o.pts,l=a-s;return l<-4294967296&&(t=!0,a=Kn(a,i),l=a-s),l>0?s:a},i);return t&&this.logger.debug("PTS rollover detected"),n}remux(e,t,i,n,s,o,a,l){let c,u,h,f,d,m,A=s,p=s;const g=e.pid>-1,v=t.pid>-1,E=t.samples.length,C=e.samples.length>0,I=a&&E>0||E>1;if((!g||C)&&(!v||I)||this.ISGenerated||a){if(this.ISGenerated){var x,S,b,T;const D=this.videoTrackConfig;(D&&(t.width!==D.width||t.height!==D.height||((x=t.pixelRatio)==null?void 0:x[0])!==((S=D.pixelRatio)==null?void 0:S[0])||((b=t.pixelRatio)==null?void 0:b[1])!==((T=D.pixelRatio)==null?void 0:T[1]))||!D&&I||this.nextAudioPts===null&&C)&&this.resetInitSegment()}this.ISGenerated||(h=this.generateIS(e,t,s,o));const B=this.isVideoContiguous;let w=-1,R;if(I&&(w=KB(t.samples),!B&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,w>0){this.logger.warn(`[mp4-remuxer]: Dropped ${w} out of ${E} video samples due to a missing keyframe`);const D=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(w),t.dropped+=w,p+=(t.samples[0].pts-D)/t.inputTimeScale,R=p}else w===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${E} video samples`),m=!1);if(this.ISGenerated){if(C&&I){const D=this.getVideoStartPts(t.samples),z=(Kn(e.samples[0].pts,D)-D)/t.inputTimeScale;A+=Math.max(0,z),p+=Math.max(0,-z)}if(C){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(e,t,s,o)),u=this.remuxAudio(e,A,this.isAudioContiguous,o,v||I||l===it.AUDIO?p:void 0),I){const D=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(e,t,s,o)),c=this.remuxVideo(t,p,B,D)}}else I&&(c=this.remuxVideo(t,p,B,0));c&&(c.firstKeyFrame=w,c.independent=w!==-1,c.firstKeyFramePTS=R)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(d=rC(i,s,this._initPTS,this._initDTS)),n.samples.length&&(f=oC(n,s,this._initPTS))),{audio:u,video:c,initSegment:h,independent:m,text:f,id3:d}}generateIS(e,t,i,n){const s=e.samples,o=t.samples,a=this.typeSupported,l={},c=this._initPTS;let u=!c||n,h="audio/mp4",f,d,m;if(u&&(f=d=1/0),e.config&&s.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):fe.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(m=e.inputTimeScale,!c||m!==c.timescale?f=d=s[0].pts-Math.round(m*i):u=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:fe.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(m=t.inputTimeScale,!c||m!==c.timescale){const A=this.getVideoStartPts(o),p=Math.round(m*i);d=Math.min(d,Kn(o[0].dts,A)-p),f=Math.min(f,A-p)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:f,timescale:m},this._initDTS={baseTime:d,timescale:m}):f=m=void 0,{tracks:l,initPTS:f,timescale:m}}remuxVideo(e,t,i,n){const s=e.inputTimeScale,o=e.samples,a=[],l=o.length,c=this._initPTS;let u=this.nextAvcDts,h=8,f=this.videoSampleDuration,d,m,A=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,g=!1;if(!i||u===null){const F=t*s,N=o[0].pts-Kn(o[0].dts,o[0].pts);Ro&&u!==null&&Math.abs(F-N-u)<15e3?i=!0:u=F-N}const v=c.baseTime*s/c.timescale;for(let F=0;F<l;F++){const N=o[F];N.pts=Kn(N.pts-v,u),N.dts=Kn(N.dts-v,u),N.dts<o[F>0?F-1:F].dts&&(g=!0)}g&&o.sort(function(F,N){const L=F.dts-N.dts,$=F.pts-N.pts;return L||$}),d=o[0].dts,m=o[o.length-1].dts;const E=m-d,C=E?Math.round(E/(l-1)):f||e.inputTimeScale/30;if(i){const F=d-u,N=F>C,L=F<-1;if((N||L)&&(N?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ll(F,!0)} ms (${F}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ll(-F,!0)} ms (${F}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!L||u>=o[0].pts||Ro)){d=u;const $=o[0].pts-F;if(N)o[0].dts=d,o[0].pts=$;else{let j=!0;for(let V=0;V<o.length&&!(o[V].dts>$&&j);V++){const k=o[V].pts;if(o[V].dts-=F,o[V].pts-=F,V<o.length-1){const Q=o[V+1].pts,O=o[V].pts,U=Q<=O,te=Q<=k;j=U==te}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${ll($,!0)}/${ll(d,!0)}, delta: ${ll(F,!0)} ms`)}}d=Math.max(0,d);let I=0,_=0,x=d;for(let F=0;F<l;F++){const N=o[F],L=N.units,$=L.length;let j=0;for(let V=0;V<$;V++)j+=L[V].data.length;_+=j,I+=$,N.length=j,N.dts<x?(N.dts=x,x+=C/4|0||1):x=N.dts,A=Math.min(N.pts,A),p=Math.max(N.pts,p)}m=o[l-1].dts;const S=_+4*I+8;let b;try{b=new Uint8Array(S)}catch(F){this.observer.emit(M.ERROR,M.ERROR,{type:nt.MUX_ERROR,details:me.REMUX_ALLOC_ERROR,fatal:!1,error:F,bytes:S,reason:`fail allocating video mdat ${S}`});return}const T=new DataView(b.buffer);T.setUint32(0,S),b.set(fe.types.mdat,4);let B=!1,w=Number.POSITIVE_INFINITY,R=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,G=Number.NEGATIVE_INFINITY;for(let F=0;F<l;F++){const N=o[F],L=N.units;let $=0;for(let k=0,Q=L.length;k<Q;k++){const O=L[k],U=O.data,te=O.data.byteLength;T.setUint32(h,te),h+=4,b.set(U,h),h+=te,$+=4+te}let j;if(F<l-1)f=o[F+1].dts-N.dts,j=o[F+1].pts-N.pts;else{const k=this.config,Q=F>0?N.dts-o[F-1].dts:C;if(j=F>0?N.pts-o[F-1].pts:C,k.stretchShortVideoTrack&&this.nextAudioPts!==null){const O=Math.floor(k.maxBufferHole*s),U=(n?A+n*s:this.nextAudioPts)-N.pts;U>O?(f=U-Q,f<0?f=Q:B=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${U/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=Q}else f=Q}const V=Math.round(N.pts-N.dts);w=Math.min(w,f),D=Math.max(D,f),R=Math.min(R,j),G=Math.max(G,j),a.push(Ty(N.key,f,$,V))}if(a.length){if(Ro){if(Ro<70){const F=a[0].flags;F.dependsOn=2,F.isNonSync=0}}else if(wd&&G-R<D-w&&C/D<.025&&a[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let F=d;for(let N=0,L=a.length;N<L;N++){const $=F+a[N].duration,j=F+a[N].cts;if(N<L-1){const V=$+a[N+1].cts;a[N].duration=V-j}else a[N].duration=N?a[N-1].duration:C;a[N].cts=0,F=$}}}f=B||!f?C:f,this.nextAvcDts=u=m+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const q={data1:fe.moof(e.sequenceNumber++,d,ei(e,{samples:a})),data2:b,startPTS:A/s,endPTS:(p+f)/s,startDTS:d/s,endDTS:u/s,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,q}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return HB;case"ac3":return VB;default:return zB}}remuxAudio(e,t,i,n,s){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,l=o/a,c=this.getSamplesPerFrame(e),u=c*l,h=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],m=s!==void 0;let A=e.samples,p=f?0:8,g=this.nextAudioPts||-1;const v=t*o,E=h.baseTime*o/h.timescale;if(this.isAudioContiguous=i=i||A.length&&g>0&&(n&&Math.abs(v-g)<9e3||Math.abs(Kn(A[0].pts-E,v)-g)<20*u),A.forEach(function(z){z.pts=Kn(z.pts-E,v)}),!i||g<0){if(A=A.filter(z=>z.pts>=0),!A.length)return;s===0?g=0:n&&!m?g=Math.max(0,v):g=A[0].pts}if(e.segmentCodec==="aac"){const z=this.config.maxAudioFramesDrift;for(let W=0,q=g;W<A.length;W++){const F=A[W],N=F.pts,L=N-q,$=Math.abs(1e3*L/o);if(L<=-z*u&&m)W===0&&(this.logger.warn(`Audio frame @ ${(N/o).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*L/o)} ms.`),this.nextAudioPts=g=q=N);else if(L>=z*u&&$<QB&&m){let j=Math.round(L/u);q=N-j*u,q<0&&(j--,q+=u),W===0&&(this.nextAudioPts=g=q),this.logger.warn(`[mp4-remuxer]: Injecting ${j} audio frame @ ${(q/o).toFixed(3)}s due to ${Math.round(1e3*L/o)} ms gap.`);for(let V=0;V<j;V++){const k=Math.max(q,0);let Q=UB.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);Q||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),Q=F.unit.subarray()),A.splice(W,0,{unit:Q,pts:k}),q+=u,W++}}F.pts=q,q+=u}}let C=null,I=null,_,x=0,S=A.length;for(;S--;)x+=A[S].unit.byteLength;for(let z=0,W=A.length;z<W;z++){const q=A[z],F=q.unit;let N=q.pts;if(I!==null){const $=d[z-1];$.duration=Math.round((N-I)/l)}else if(i&&e.segmentCodec==="aac"&&(N=g),C=N,x>0){x+=p;try{_=new Uint8Array(x)}catch($){this.observer.emit(M.ERROR,M.ERROR,{type:nt.MUX_ERROR,details:me.REMUX_ALLOC_ERROR,fatal:!1,error:$,bytes:x,reason:`fail allocating audio mdat ${x}`});return}f||(new DataView(_.buffer).setUint32(0,x),_.set(fe.types.mdat,4))}else return;_.set(F,p);const L=F.byteLength;p+=L,d.push(Ty(!0,c,L,0)),I=N}const b=d.length;if(!b)return;const T=d[d.length-1];this.nextAudioPts=g=I+l*T.duration;const B=f?new Uint8Array(0):fe.moof(e.sequenceNumber++,C/l,ei({},e,{samples:d}));e.samples=[];const w=C/o,R=g/o,G={data1:B,data2:_,startPTS:w,endPTS:R,startDTS:w,endDTS:R,type:"audio",hasAudio:!0,hasVideo:!1,nb:b};return this.isAudioContiguous=!0,G}}function Kn(r,e){let t;if(e===null)return r;for(e<r?t=-8589934592:t=8589934592;Math.abs(r-e)>4294967296;)r+=t;return r}function KB(r){for(let e=0;e<r.length;e++)if(r[e].key)return e;return-1}function rC(r,e,t,i){const n=r.samples.length;if(!n)return;const s=r.inputTimeScale;for(let a=0;a<n;a++){const l=r.samples[a];l.pts=Kn(l.pts-t.baseTime*s/t.timescale,e*s)/s,l.dts=Kn(l.dts-i.baseTime*s/i.timescale,e*s)/s}const o=r.samples;return r.samples=[],{samples:o}}function oC(r,e,t){const i=r.samples.length;if(!i)return;const n=r.inputTimeScale;for(let o=0;o<i;o++){const a=r.samples[o];a.pts=Kn(a.pts-t.baseTime*n/t.timescale,e*n)/n}r.samples.sort((o,a)=>o.pts-a.pts);const s=r.samples;return r.samples=[],{samples:s}}class $B{constructor(e,t,i,n){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.logger=n}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(O8(e,n)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const n=this.initData=m4(e);n.audio&&(t=by(n.audio,Zt.AUDIO)),n.video&&(i=by(n.video,Zt.VIDEO));const s={};n.audio&&n.video?s.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:n.audio?s.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:n.video?s.video={container:"video/mp4",codec:i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(e,t,i,n,s,o){var a,l;let{initPTS:c,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};Ye(u)||(u=this.lastEndTime=s||0);const f=t.samples;if(!(f!=null&&f.length))return h;const d={initPTS:void 0,timescale:1};let m=this.initData;if((a=m)!=null&&a.length||(this.generateInitSegment(f),m=this.initData),!((l=m)!=null&&l.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const A=N8(f,m),p=U8(m,f),g=p===null?s:p;(o||!c)&&(jB(c,g,s,A)||d.timescale!==c.timescale)&&(d.initPTS=g-s,c&&c.timescale===1&&this.logger.warn(`Adjusting initPTS @${s} from ${c.baseTime/c.timescale} to ${d.initPTS}`),this.initPTS=c={baseTime:d.initPTS,timescale:1});const v=e?g-c.baseTime/c.timescale:u,E=v+A;Q8(m,f,c.baseTime/c.timescale),A>0?this.lastEndTime=E:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const C=!!m.audio,I=!!m.video;let _="";C&&(_+="audio"),I&&(_+="video");const x={data1:f,startPTS:v,startDTS:v,endPTS:E,endDTS:E,type:_,hasAudio:C,hasVideo:I,nb:1,dropped:0};return h.audio=x.type==="audio"?x:void 0,h.video=x.type!=="audio"?x:void 0,h.initSegment=d,h.id3=rC(i,s,c,c),n.samples.length&&(h.text=oC(n,s,c)),h}}function jB(r,e,t,i){if(r===null)return!0;const n=Math.max(i,1),s=e-r.baseTime/r.timescale;return Math.abs(s-t)>n}function by(r,e){const t=r?.codec;return t&&t.length>4?t:e===Zt.AUDIO?t==="ec-3"||t==="ac-3"||t==="alac"?t:t==="fLaC"||t==="Opus"?ph(t,!1):(Lt.warn(`Unhandled audio codec "${t}" in mp4 MAP`),t||"mp4a"):(Lt.warn(`Unhandled video codec "${t}" in mp4 MAP`),t||"avc1")}let ir;try{ir=self.performance.now.bind(self.performance)}catch{ir=Date.now}const ju=[{demux:PB,remux:$B},{demux:Tr,remux:$u},{demux:RB,remux:$u},{demux:MB,remux:$u}];ju.splice(2,0,{demux:DB,remux:$u});class wy{constructor(e,t,i,n,s,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=s,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const s=i.transmuxing;s.executeStart=ir();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:l}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:d,initSegmentChange:m}=n||a,{audioCodec:A,videoCodec:p,defaultInitPts:g,duration:v,initSegmentData:E}=l,C=YB(o,t);if(C&&ca(C.method)){const S=this.getDecrypter(),b=TA(C.method);if(S.isSync()){let T=S.softwareDecrypt(o,C.key.buffer,C.iv.buffer,b);if(i.part>-1){const w=S.flush();T=w&&w.buffer}if(!T)return s.executeEnd=ir(),Bd(i);o=new Uint8Array(T)}else return this.asyncResult=!0,this.decryptionPromise=S.webCryptoDecrypt(o,C.key.buffer,C.iv.buffer,b).then(T=>{const B=this.push(T,null,i);return this.decryptionPromise=null,B}),this.decryptionPromise}const I=this.needsProbing(u,h);if(I){const S=this.configureTransmuxer(o);if(S)return this.logger.warn(`[transmuxer] ${S.message}`),this.observer.emit(M.ERROR,M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_PARSING_ERROR,fatal:!1,error:S,reason:S.message}),s.executeEnd=ir(),Bd(i)}(u||h||m||I)&&this.resetInitSegment(E,A,p,v,t),(u||m||I)&&this.resetInitialTimestamp(g),c||this.resetContiguity();const _=this.transmux(o,C,d,f,i);this.asyncResult=oc(_);const x=this.currentTransmuxState;return x.contiguous=!0,x.discontinuity=!1,x.trackSwitch=!1,s.executeEnd=ir(),_}flush(e){const t=e.transmuxing;t.executeStart=ir();const{decrypter:i,currentTransmuxState:n,decryptionPromise:s}=this;if(s)return this.asyncResult=!0,s.then(()=>this.flush(e));const o=[],{timeOffset:a}=n;if(i){const h=i.flush();h&&o.push(this.push(h.buffer,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=ir();const h=[Bd(e)];return this.asyncResult?Promise.resolve(h):h}const u=l.flush(a);return oc(u)?(this.asyncResult=!0,u.then(h=>(this.flushRemux(o,h,e),o))):(this.flushRemux(o,u,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:s,id3Track:o,textTrack:a}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===it.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,s,o,a,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=ir()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,s){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,n),a.resetInitSegment(e,t,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,s){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,n,s):o=this.transmuxUnencrypted(e,i,n,s),o}transmuxUnencrypted(e,t,i,n){const{audioTrack:s,videoTrack:o,id3Track:a,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,o,a,l,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,s){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,n,!1,this.id),chunkMeta:s}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let s;for(let h=0,f=ju.length;h<f;h++){var o;if((o=ju[h].demux)!=null&&o.probe(e,this.logger)){s=ju[h];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,l=this.remuxer,c=s.remux,u=s.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(i,t,n,this.logger)),(!a||!(a instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new xA(this.config)),e}}function YB(r,e){let t=null;return r.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Bd=r=>({remuxResult:{},chunkMeta:r});function oc(r){return"then"in r&&r.then instanceof Function}class WB{constructor(e,t,i,n,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=s||null}}class qB{constructor(e,t,i,n,s,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=s,this.initSegmentChange=o}}let By=0;class aC{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=By++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,u=this.hls;if(!(!u||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case"init":{var h;const f=(h=this.workerContext)==null?void 0:h.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(c.data);break}case"flush":{this.onFlush(c.data);break}case"workerLog":{u.logger[c.data.logType]&&u.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,u.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})};const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const o=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===M.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c)};this.observer=new BA,this.observer.on(M.FRAG_DECRYPTED,o),this.observer.on(M.ERROR,o);const a=$1(s.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(s.workerPath||Z9()){try{s.workerPath?(l.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=tB(s.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=eB());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:pi(s)})}catch(u){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new wy(this.observer,a,s,"",t,e.logger)}return}}this.transmuxer=new wy(this.observer,a,s,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=By++;const t=this.hls.config,i=$1(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:pi(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),iB(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,s,o,a,l,c,u){var h,f;c.transmuxing.start=self.performance.now();const{instanceNo:d,transmuxer:m}=this,A=o?o.start:s.start,p=s.decryptdata,g=this.frag,v=!(g&&s.cc===g.cc),E=!(g&&c.level===g.level),C=g?c.sn-g.sn:-1,I=this.part?c.part-this.part.index:-1,_=C===0&&c.id>1&&c.id===g?.stats.chunkCount,x=!E&&(C===1||C===0&&(I===1||_&&I<=0)),S=self.performance.now();(E||C||s.stats.parsing.start===0)&&(s.stats.parsing.start=S),o&&(I||!x)&&(o.stats.parsing.start=S);const b=!(g&&((h=s.initSegment)==null?void 0:h.url)===((f=g.initSegment)==null?void 0:f.url)),T=new qB(v,x,l,E,A,b);if(!x||v||b){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${s.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===it.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${v}
        trackSwitch: ${E}
        contiguous: ${x}
        accurateTimeOffset: ${l}
        timeOffset: ${A}
        initSegmentChange: ${b}`);const B=new WB(i,n,t,a,u);this.configureTransmuxer(B)}if(this.frag=s,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:d,cmd:"demux",data:e,decryptdata:p,chunkMeta:c,state:T},e instanceof ArrayBuffer?[e]:[]);else if(m){const B=m.push(e,p,c,T);oc(B)?B.then(w=>{this.handleTransmuxComplete(w)}).catch(w=>{this.transmuxerError(w,c,"transmuxer-interface push error")}):this.handleTransmuxComplete(B)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);oc(n)?n.then(s=>{this.handleFlushResult(s,e)}).catch(s=>{this.transmuxerError(s,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const Ry=100;class lC extends Wh{constructor(e,t,i){super(e,t,i,"audio-stream-controller",it.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(M.LEVEL_LOADED,this.onLevelLoaded,this),e.on(M.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(M.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(M.BUFFER_RESET,this.onBufferReset,this),e.on(M.BUFFER_CREATED,this.onBufferCreated,this),e.on(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(M.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(M.FRAG_LOADING,this.onFragLoading,this),e.on(M.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(M.LEVEL_LOADED,this.onLevelLoaded,this),e.off(M.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(M.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(M.BUFFER_RESET,this.onBufferReset,this),e.off(M.BUFFER_CREATED,this.onBufferCreated,this),e.off(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(M.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(M.FRAG_LOADING,this.onFragLoading,this),e.off(M.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s}){if(i===it.MAIN){const o=t.cc,a=this.fragCurrent;if(this.initPTS[o]={baseTime:n,timescale:s},this.log(`InitPTS for cc: ${o} found from main: ${n}/${s}`),this.mainAnchor=t,this.state===De.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==o)&&(this.nextLoadPosition=this.findSyncFrag(t).start),this.tick()}else!this.hls.hasEnoughToStart&&a&&a.cc!==o?(this.startFragRequested=!1,this.nextLoadPosition=this.findSyncFrag(t).start,a.abortRequests(),this.resetLoadingState()):this.state===De.IDLE&&this.tick()}}findSyncFrag(e){const t=this.getLevelDetails(),i=e.cc;return A9(t,i,e)||t&&T4(t.fragments,i)||e}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=De.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(Ry),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=De.IDLE):this.state=De.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case De.IDLE:this.doTickIdle();break;case De.WAITING_TRACK:{const{levels:t,trackId:i}=this,n=t?.[i],s=n?.details;if(s&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(s))break;this.state=De.WAITING_INIT_PTS}break}case De.FRAG_LOADING_WAITING_RETRY:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,trackId:s}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(n?.[s]||null),this.state=De.IDLE}break}case De.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:i,part:n,cache:s,complete:o}=t,a=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=De.FRAG_LOADING;const l=s.flush().buffer,c={frag:i,part:n,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),o&&super._handleFragmentLoadComplete(c)}else a&&a.cc!==t.frag.cc&&(this.log(`Waiting fragment cc (${i.cc}) cancelled because video is at cc ${a.cc}`),this.nextLoadPosition=this.findSyncFrag(a).start,this.clearWaitingFragment())}else this.state=De.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.state!==De.STOPPED&&(this.state=De.IDLE))}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:s}=this,o=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[s]))return;const a=i[s],l=a.details;if(!l||this.waitForLive(a)||this.waitForCdnTuneIn(l)){this.state=De.WAITING_TRACK,this.startFragRequested=!1;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,Zt.AUDIO,it.AUDIO));const u=this.getFwdBufferInfo(c,it.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,l)){t.trigger(M.BUFFER_EOS,{type:"audio"}),this.state=De.ENDED;return}const h=u.len,f=t.maxBufferLength,d=l.fragments,m=d[0].start,A=this.getLoadPosition(),p=this.flushing?A:u.end;if(this.switchingTrack&&n){const E=A;l.PTSKnown&&E<m&&(u.end>m||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=m+.05)}if(h>=f&&!this.switchingTrack&&p<d[d.length-1].start)return;let g=this.getNextFragment(p,l);if(g&&this.isLoopLoading(g,p)&&(g=this.getNextFragmentLoopLoading(g,l,u,it.MAIN,f)),!g){this.bufferFlushed=!0;return}let v=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&v&&Yi(g)&&!g.endList&&(!l.live||!this.loadingParts&&p<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===Ni.OK&&(this.mainFragLoading=v=null),v&&Yi(v))){if(g.start>v.end){const C=this.fragmentTracker.getFragAtPos(p,it.MAIN);C&&C.end>v.end&&(v=C,this.mainFragLoading={frag:C,targetBufferTime:null})}if(g.start>v.end)return}this.loadFragment(g,a,p)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new ga(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==De.STOPPED&&(this.setInterval(Ry),this.state=De.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(M.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:s,id:o,groupId:a,track:l}=t;if(!n){this.warn(`Audio tracks reset while loading track ${o} "${l.name}" of "${a}"`);return}const c=this.mainDetails;if(!c||s.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==De.STOPPED&&(this.state=De.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${l.name}" of "${a}" loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const u=n[o];let h=0;if(s.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(s),s.deltaUpdateFailed)return;if(u.details){var f;h=this.alignPlaylists(s,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}s.alignedSliding||(G4(s,c),s.alignedSliding||Ih(s,c),h=s.fragmentStart)}u.details=s,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,h),this.hls.trigger(M.AUDIO_TRACK_UPDATED,{details:s,id:o,groupId:t.groupId}),this.state===De.WAITING_TRACK&&!this.waitForCdnTuneIn(s)&&(this.state=De.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{config:o,trackId:a,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[a];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=o.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new aC(this.hls,it.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[i.cc],m=(t=i.initSegment)==null?void 0:t.data;if(d!==void 0){const p=n?n.index:-1,g=p!==-1,v=new Yh(i.level,i.sn,i.stats.chunkCount,s.byteLength,p,g);f.push(s,m,h,"",i,n,u.totalduration,!1,v,d)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:A}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new Q4,complete:!1};A.push(new Uint8Array(s)),this.state!==De.STOPPED&&(this.state=De.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===it.MAIN&&Yi(t.frag)&&(this.mainFragLoading=t,this.state===De.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==it.AUDIO){!this.audioOnly&&i.type===it.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Yi(i)){this.fragPrevious=i;const s=this.switchingTrack;s&&(this.bufferedTrack=s,this.switchingTrack=null,this.hls.trigger(M.AUDIO_TRACK_SWITCHED,Kt({},s)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=De.ERROR;return}switch(t.details){case me.FRAG_GAP:case me.FRAG_PARSING_ERROR:case me.FRAG_DECRYPT_ERROR:case me.FRAG_LOAD_ERROR:case me.FRAG_LOAD_TIMEOUT:case me.KEY_LOAD_ERROR:case me.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(it.AUDIO,t);break;case me.AUDIO_TRACK_LOAD_ERROR:case me.AUDIO_TRACK_LOAD_TIMEOUT:case me.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===De.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Bt.AUDIO_TRACK&&(this.state=De.IDLE);break;case me.BUFFER_ADD_CODEC_ERROR:case me.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case me.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case me.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==Zt.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==Zt.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===De.ENDED&&(this.state=De.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,it.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:s,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:c,level:u}=a,{details:h}=u,{audio:f,text:d,id3:m,initSegment:A}=s;if(this.fragContextChanged(l)||!h){this.fragmentTracker.removeFragment(l);return}if(this.state=De.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),A!=null&&A.tracks){const p=l.initSegment||l;this._bufferInitSegment(u,A.tracks,p,o),n.trigger(M.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:i,tracks:A.tracks})}if(f){const{startPTS:p,endPTS:g,startDTS:v,endDTS:E}=f;c&&(c.elementaryStreams[Zt.AUDIO]={startPTS:p,endPTS:g,startDTS:v,endDTS:E}),l.setElementaryStreamInfo(Zt.AUDIO,p,g,v,E),this.bufferFragmentData(f,l,c,o)}if(m!=null&&(t=m.samples)!=null&&t.length){const p=ei({id:i,frag:l,details:h},m);n.trigger(M.FRAG_PARSING_METADATA,p)}if(d){const p=ei({id:i,frag:l,details:h},d);n.trigger(M.FRAG_PARSING_USERDATA,p)}}_bufferInitSegment(e,t,i,n){if(this.state!==De.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const s=t.audio;s.id=it.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${o}/${s.codec}]`),o&&o.split(",").length===1&&(s.levelCodec=o),this.hls.trigger(M.BUFFER_CODECS,t);const a=s.initSegment;if(a!=null&&a.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:a};this.hls.trigger(M.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===Ni.NOT_LOADED||n===Ni.PARTIAL){var s;if(!Yi(e))this._loadInitSegment(e,t);else if((s=t.details)!=null&&s.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=De.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&Ih(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a}=this.bufferedTrack;oo({name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a},e,Jr)||(yh(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(M.AUDIO_TRACK_SWITCHED,Kt({},e))}}class Xh extends dr{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t?.renditionReports;if(n){let s=-1;for(let o=0;o<n.length;o++){const a=n[o];let l;try{l=new self.URL(a.URI,t.url).href}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=a.URI||""}if(l===e){s=o;break}else l===e.substring(0,l.length)&&(s=o)}if(s!==-1){const o=n[s],a=parseInt(o["LAST-MSN"])||t?.lastPartSn;let l=parseInt(o["LAST-PART"])||t?.lastPartIndex;if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&u>t.partTarget&&(l+=1)}const c=i&&Y1(i);return new am(a,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:s}=t,o=self.performance.now(),a=s.loading.first?Math.max(0,o-s.loading.first):0;n.advancedDateTime=Date.now()-a;const l=this.hls.config.timelineOffset;if(l!==n.appliedTimelineOffset){const u=Math.max(l||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(h=>{h.start=h.playlistOffset+u})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){H9(i,n);const v=n.playlistParsingError;if(v){this.warn(v);const E=this.hls;if(!E.config.ignorePlaylistParsingErrors){var c;const{networkDetails:C}=t;E.trigger(M.ERROR,{type:nt.NETWORK_ERROR,details:me.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:v,reason:v.message,level:t.level||void 0,parent:(c=n.fragments[0])==null?void 0:c.type,networkDetails:C,stats:s});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=s.loading.start);const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,d=(n.edge-f)*1e3,m=F4(n,d);if(n.requestScheduled+m<o?n.requestScheduled=o:n.requestScheduled+=m,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let A,p,g;if(n.canBlockReload&&n.endSN&&n.advanced){const v=this.hls.config.lowLatencyMode,E=n.lastPartSn,C=n.endSN,I=n.lastPartIndex,_=I!==-1,x=E===C;_?x?(p=C+1,g=v?0:I):(p=E,g=v?I+1:n.maxPartIndex):p=C+1;const S=n.age,b=S+n.ageHeader;let T=Math.min(b-n.partTarget,n.targetduration*1.5);if(T>0){if(b>n.targetduration*3)this.log(`Playlist last advanced ${S.toFixed(2)}s ago. Omitting segment and part directives.`),p=void 0,g=void 0;else if(i!=null&&i.tuneInGoal&&b-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${T} with playlist age: ${n.age}`),T=0;else{const B=Math.floor(T/n.targetduration);if(p+=B,g!==void 0){const w=Math.round(T%n.targetduration/n.partTarget);g+=w}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${S.toFixed(2)}s goal: ${T} skip sn ${B} to part ${g}`)}n.tuneInGoal=T}if(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,g),v||!x){n.requestScheduled=o,this.loadingPlaylist(u,A);return}}else(n.canBlockReload||n.canSkipUntil)&&(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,g));A&&p!==void 0&&n.canBlockReload&&(n.requestScheduled=s.loading.first+Math.max(m-a*2,m/2)),this.scheduleLoading(u,A,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const s=self.performance.now(),o=n.requestScheduled;if(s>=o){this.loadingPlaylist(e,t);return}const a=o-s;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,n){let s=Y1(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,s=Nl.No),new am(i,n,s)}checkRetry(e){const t=e.details,i=vh(e),n=e.errorAction,{action:s,retryCount:o=0,retryConfig:a}=n||{},l=!!n&&!!a&&(s===Ki.RetryRequest||!n.resolved&&s===Ki.SendAlternateToPenaltyBox);if(l){var c;if(o>=a.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=_A(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return l}}function cC(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(!ac(r[t].attrs,e[t].attrs))return!1;return!0}function ac(r,e,t){const i=r["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>r[n]!==e[n])}function mm(r,e){return e.label.toLowerCase()===r.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(r.lang||"").toLowerCase())}class uC extends Xh{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.LEVEL_LOADING,this.onLevelLoading,this),e.on(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(M.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.LEVEL_LOADING,this.onLevelLoading,this),e.off(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(M.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(M.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(a=>n?.indexOf(a)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(f=>f.default)&&(this.selectDefaultTrack=!1),a.forEach((f,d)=>{f.id=d});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const l=this.hls.config.audioPreference;if(!s&&l){const f=ks(l,a,Jr);if(f>-1)s=a[f];else{const d=ks(l,this.tracks);s=this.tracks[d]}}let c=this.findTrackId(s);c===-1&&s&&(c=this.findTrackId(null));const u={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i?.join(",")}`),this.hls.trigger(M.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(c!==-1&&h===-1)this.setAudioTrack(c);else if(a.length&&h===-1){var o;const f=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(f.message),this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===Bt.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&oo(e,n,Jr))return n;const s=ks(e,this.tracksInGroup,Jr);if(s>-1){const o=this.tracksInGroup[s];return this.setAudioTrack(s),o}else if(n){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=h9(e,t.levels,i,o,Jr);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=ks(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],s=n.details&&!n.details.live;if(e===this.trackId&&n===i&&s||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(M.AUDIO_TRACK_SWITCHING,Kt({},n)),s))return;const o=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||oo(e,n,Jr)))return i}if(e){const{name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(oo({name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l},u,Jr))return c}for(let c=0;c<t.length;c++){const u=t[c];if(ac(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(ac(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&yh(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(M.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class XB{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(s){var i;if(n.onError(s),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i?.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const Dy=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,hC="HlsJsTrackRemovedError";class JB extends Error{constructor(e){super(e),this.name=hC}}class fC extends dr{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:s}=this;i&&this.log("Media source opened"),!(!n||!s)&&(s.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(M.MEDIA_ATTACHED,{media:n,mediaSource:s}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=B8(ur(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.BUFFER_RESET,this.onBufferReset,this),e.on(M.BUFFER_APPENDING,this.onBufferAppending,this),e.on(M.BUFFER_CODECS,this.onBufferCodecs,this),e.on(M.BUFFER_EOS,this.onBufferEos,this),e.on(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(M.FRAG_PARSED,this.onFragParsed,this),e.on(M.FRAG_CHANGED,this.onFragChanged,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.BUFFER_RESET,this.onBufferReset,this),e.off(M.BUFFER_APPENDING,this.onBufferAppending,this),e.off(M.BUFFER_CODECS,this.onBufferCodecs,this),e.off(M.BUFFER_EOS,this.onBufferEos,this),e.off(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(M.FRAG_PARSED,this.onFragParsed,this),e.off(M.FRAG_CHANGED,this.onFragChanged,this),e.off(M.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const s=this.isUpdating();s||this.operationQueue.removeBlockers();const o=this.isQueued();(s||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${s?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?ei(i,n.tracks):this.sourceBuffers.forEach(s=>{const[o]=s;o&&(i[o]=ei({},this.tracks[o]),this.removeBuffer(o)),s[0]=s[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media,n=ur(this.appendSource);if(this.transferData=this.overrides=void 0,i&&n){const s=!!t.mediaSource;(s||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(o),s)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&o instanceof l,My(i),ZB(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,s=n?Object.keys(n):null,o=s?s.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(n&&s&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${pi(i,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${pi(n,(l,c)=>l==="initSegment"?void 0:c)}}`),!l4(n,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,u=Math.max(l,c?.fragments[0].start||0);if(u-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${l}`),this.onMediaDetaching(M.MEDIA_DETACHING,{}),this.onMediaAttaching(M.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,s.forEach(l=>{const c=l,u=n[c];if(u){const h=u.buffer;if(h){const f=this.fragmentTracker,d=u.id;if(f.hasFragments(d)||f.hasParts(d)){const p=Tt.getBuffered(h);f.detectEvictedFragments(c,p,d,null,!0)}const m=Rd(c),A=[c,h];this.sourceBuffers[m]=A,h.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,u)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:s,_objectUrl:o}=this;if(s){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=s.readyState==="open";try{const l=s.sourceBuffers;for(let c=l.length;c--;)a&&l[c].abort(),s.removeSourceBuffer(l[c]);a&&s.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}s.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("sourceended",this._onMediaSourceEnded),s.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(s.removeEventListener("startstreaming",this._onStartStreaming),s.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(n.removeAttribute("src"),this.appendSource&&My(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(M.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(s){this.warn(`onBufferReset ${e}`,s)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Rd(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new XB(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const s="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),o=!s&&this.sourceBufferCount&&this.media&&n.some(a=>!i[a]);if(s||o){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(a=>{var l,c,u;const h=t[a],{id:f,codec:d,levelCodec:m,container:A,metadata:p,supplemental:g}=h;let v=i[a];const E=(l=this.transferData)==null||(c=l.tracks)==null?void 0:c[a],C=E!=null&&E.buffer?E:v,I=C?.pendingCodec||C?.codec,_=C?.levelCodec;v||(v=i[a]={buffer:void 0,listeners:[],codec:d,supplemental:g,container:A,levelCodec:m,metadata:p,id:f});const x=Ku(I,_),S=x?.replace(Dy,"$1");let b=Ku(d,m);const T=(u=b)==null?void 0:u.replace(Dy,"$1");b&&x&&S!==T&&(a.slice(0,5)==="audio"&&(b=ph(b,this.appendSource)),this.log(`switching codec ${I} to ${b}`),b!==(v.pendingCodec||v.codec)&&(v.pendingCodec=b),v.container=A,this.appendChangeType(a,A,b))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,s={label:`change-type=${n}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),a.changeType(n),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(s,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,it.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const l=this.tracks.video;(this.lastVideoAppendEnd>n||l!=null&&l.buffer&&Tt.isBuffered(l.buffer,n)||((a=this.fragmentTracker.getAppendedFrag(n,it.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:s,parent:o,frag:a,part:l,chunkMeta:c}=t,u=c.buffering[s],h=a.sn,f=self.performance.now();u.start=f;const d=a.stats.buffering,m=l?l.stats.buffering:null;d.start===0&&(d.start=f),m&&m.start===0&&(m.start=f);const A=i.audio;let p=!1;s==="audio"&&A?.container==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const g=this.tracks.video,v=g?.buffer;if(v&&h!=="initSegment"){const I=l||a,_=this.blockedAudioAppend;if(s==="audio"&&o!=="main"&&!this.blockedAudioAppend){const S=I.start+I.duration*.05,b=v.buffered,T=this.currentOp("video");!b.length&&!T?this.blockAudio(I):!T&&!Tt.isBuffered(v,S)&&this.lastVideoAppendEnd<S&&this.blockAudio(I)}else if(s==="video"){const x=I.end;if(_){const S=_.frag.start;(x>S||x<this.lastVideoAppendEnd||Tt.isBuffered(v,S))&&this.unblockAudio()}this.lastVideoAppendEnd=x}}const E=(l||a).start,C={label:`append-${s}`,execute:()=>{if(u.executeStart=self.performance.now(),p){const I=this.tracks[s];if(I){const _=I.buffer;if(_){const x=E-_.timestampOffset;Math.abs(x)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${E} (delta: ${x}) sn: ${h})`),_.timestampOffset=E)}}}this.appendExecutor(n,s)},onStart:()=>{},onComplete:()=>{const I=self.performance.now();u.executeEnd=u.end=I,d.first===0&&(d.first=I),m&&m.first===0&&(m.first=I);const _={};this.sourceBuffers.forEach(([x,S])=>{x&&(_[x]=Tt.getBuffered(S))}),this.appendErrors[s]=0,s==="audio"||s==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(M.BUFFER_APPENDED,{type:s,frag:a,part:l,chunkMeta:c,parent:a.type,timeRanges:_})},onError:I=>{var _;const x={type:nt.MEDIA_ERROR,parent:a.type,details:me.BUFFER_APPEND_ERROR,sourceBufferName:s,frag:a,part:l,chunkMeta:c,error:I,err:I,fatal:!1},S=(_=this.media)==null?void 0:_.error;if(I.code===DOMException.QUOTA_EXCEEDED_ERR)x.details=me.BUFFER_FULL_ERROR;else if(I.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!S)x.errorAction=nc(!0);else if(I.name===hC&&this.sourceBufferCount===0)x.errorAction=nc(!0);else{const b=++this.appendErrors[s];this.warn(`Failed ${b}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${s}" sourceBuffer (${S||"no media error"})`),(b>=this.hls.config.appendErrorMaxRetry||S)&&(x.fatal=!0)}this.hls.trigger(M.ERROR,x)}};this.append(C,s,this.isPending(this.tracks[s]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(M.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:s}=t;i?this.append(this.getFlushOp(i,n,s),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,n,s),o)})}onFragParsed(e,t){const{frag:i,part:n}=t,s=[],o=n?n.elementaryStreams:i.elementaryStreams;o[Zt.AUDIOVIDEO]?s.push("audiovideo"):(o[Zt.AUDIO]&&s.push("audio"),o[Zt.VIDEO]&&s.push("video"));const a=()=>{const l=self.performance.now();i.stats.buffering.end=l,n&&(n.stats.buffering.end=l);const c=n?n.stats:i.stats;this.hls.trigger(M.FRAG_BUFFERED,{frag:i,part:n,stats:c,id:i.type})};s.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,s).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!((t=this.tracks[e])!=null&&t.ended)||((i=this.tracks[e])==null?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})&&(n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(M.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(M.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===me.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;Ye(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,s=i.currentTime,o=t.levelTargetDuration,a=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(Ye(a)&&a>=0){const l=Math.max(a,o),c=Math.floor(s/o)*o-l;this.flushBackBuffer(s,o,c)}if(Ye(n.frontBufferFlushThreshold)&&n.frontBufferFlushThreshold>0){const l=Math.max(n.maxBufferLength,n.frontBufferFlushThreshold),c=Math.max(l,o),u=Math.floor(s/o)*o+c;this.flushFrontBuffer(s,o,u)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const a=Tt.getBuffered(s);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(M.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[n];if((o=this.details)!=null&&o.live)this.hls.trigger(M.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(M.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const o=Tt.getBuffered(s),a=o.length;if(a<2)return;const l=o.start(a-1),c=o.end(a-1);if(i>l||e>=l&&e<=c)return;this.hls.trigger(M.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||i?.readyState!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),u=Math.max(c,n);return{duration:1/0,start:c,end:u}}return{duration:1/0}}const s=(e=this.overrides)==null?void 0:e.duration;if(s)return Ye(s)?{duration:s}:null;const o=this.media.duration,a=Ye(i.duration)?i.duration:0;return n>a&&n>o||!Ye(o)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(Ye(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${pi(i)}`),this.tracksReady){var n;const s=(n=this.transferData)==null?void 0:n.tracks;s&&Object.keys(s).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(M.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const s in e){const o=s,a=e[o];if(this.isPending(a)){const l=this.getTrackCodec(a,o),c=`${a.container};codecs=${l}`;a.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(o)?" Queued":""} ${pi(a)}`);try{const u=i.addSourceBuffer(c),h=Rd(o),f=[o,u];t[h]=f,a.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(o),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[o],this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:o,mimeType:c,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&rm(i,"video")&&(n=X8(n,i));const s=Ku(n,e.levelCodec);return s?t.slice(0,5)==="audio"?ph(s,this.appendSource):s:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(s,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(M.BUFFER_FLUSHED,{type:s})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i?.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const s=this.currentOp(e);s&&s.onError(n)}removeExecutor(e,t,i){const{media:n,mediaSource:s}=this,o=this.tracks[e],a=o?.buffer;if(!n||!s||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=Ye(n.duration)?n.duration:1/0,c=Ye(s.duration)?s.duration:1/0,u=Math.max(0,t),h=Math.min(i,l,c);h>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${h}] from the ${e} SourceBuffer`),a.remove(u,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i?.buffer;if(!n)throw new JB(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const s=n.buffer;if(!s)return;const o=i.bind(this,e);n.listeners.push({event:t,listener:o}),s.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function My(r){const e=r.querySelectorAll("source");[].slice.call(e).forEach(t=>{r.removeChild(t)})}function ZB(r,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,r.appendChild(t)}function Rd(r){return r==="audio"?1:0}class Jh{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(M.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(M.BUFFER_CODECS,this.onBufferCodecs,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(M.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(M.BUFFER_CODECS,this.onBufferCodecs,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&Ye(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,s)=>this.isLevelAllowed(n)&&s<=e);return this.clientRect=null,Jh.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(a,l)=>l?a.width!==l.width||a.height!==l.height:!0;let s=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const l=e[a];if((l.width>=o||l.height>=o)&&n(l,e[a+1])){s=a;break}}return s}}const eR={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},gn=eR,tR={HLS:"h"},iR=tR,nR="CMCD-Object",sR="CMCD-Request",rR="CMCD-Session",oR="CMCD-Status",wl={OBJECT:nR,REQUEST:sR,SESSION:rR,STATUS:oR},aR={[wl.OBJECT]:["br","d","ot","tb"],[wl.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[wl.SESSION]:["cid","pr","sf","sid","st","v"],[wl.STATUS]:["bs","rtp"]};class Ea{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof Ea?i:new Ea(i))),this.value=e,this.params=t}}const lR="Dict";function cR(r){return Array.isArray(r)?JSON.stringify(r):r instanceof Map?"Map{}":r instanceof Set?"Set{}":typeof r=="object"?JSON.stringify(r):String(r)}function uR(r,e,t,i){return new Error(`failed to ${r} "${cR(e)}" as ${t}`,{cause:i})}function zs(r,e,t){return uR("serialize",r,e,t)}class dC{constructor(e){this.description=e}}const Ly="Bare Item",hR="Boolean";function fR(r){if(typeof r!="boolean")throw zs(r,hR);return r?"?1":"?0"}const dR="Byte Sequence";function mR(r){if(ArrayBuffer.isView(r)===!1)throw zs(r,dR);return`:${fB(r)}:`}const AR="Integer";function pR(r){return r<-999999999999999||999999999999999<r}function mC(r){if(pR(r))throw zs(r,AR);return r.toString()}function gR(r){return`@${mC(r.getTime()/1e3)}`}const yR="Decimal";function vR(r){const e=Y4(r,3);if(Math.floor(Math.abs(e)).toString().length>12)throw zs(r,yR);const t=e.toString();return t.includes(".")?t:`${t}.0`}const ER="String",CR=/[\x00-\x1f\x7f]+/;function IR(r){if(CR.test(r))throw zs(r,ER);return`"${r.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function _R(r){return r.description||r.toString().slice(7,-1)}const xR="Token";function Py(r){const e=_R(r);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw zs(e,xR);return e}function Am(r){switch(typeof r){case"number":if(!Ye(r))throw zs(r,Ly);return Number.isInteger(r)?mC(r):vR(r);case"string":return IR(r);case"symbol":return Py(r);case"boolean":return fR(r);case"object":if(r instanceof Date)return gR(r);if(r instanceof Uint8Array)return mR(r);if(r instanceof dC)return Py(r);default:throw zs(r,Ly)}}const SR="Key";function pm(r){if(/^[a-z*][a-z0-9\-_.*]*$/.test(r)===!1)throw zs(r,SR);return r}function kA(r){return r==null?"":Object.entries(r).map(([e,t])=>t===!0?`;${pm(e)}`:`;${pm(e)}=${Am(t)}`).join("")}function AC(r){return r instanceof Ea?`${Am(r.value)}${kA(r.params)}`:Am(r)}function TR(r){return`(${r.value.map(AC).join(" ")})${kA(r.params)}`}function bR(r,e={whitespace:!0}){if(typeof r!="object")throw zs(r,lR);const t=r instanceof Map?r.entries():Object.entries(r),i=e?.whitespace?" ":"";return Array.from(t).map(([n,s])=>{s instanceof Ea||(s=new Ea(s));let o=pm(n);return s.value===!0?o+=kA(s.params):(o+="=",Array.isArray(s.value)?o+=TR(s):o+=AC(s)),o}).join(`,${i}`)}function wR(r,e){return bR(r,e)}function BR(r){return r==="ot"||r==="sf"||r==="st"}function RR(r){return typeof r=="number"?Ye(r):r!=null&&r!==""&&r!==!1}const Yu=r=>Math.round(r),DR=(r,e)=>(e?.baseUrl&&(r=dB(r,e.baseUrl)),encodeURIComponent(r)),ou=r=>Yu(r/100)*100,MR={br:Yu,d:Yu,bl:ou,dl:ou,mtp:ou,nor:DR,rtp:ou,tb:Yu};function LR(r,e){const t={};if(r==null||typeof r!="object")return t;const i=Object.keys(r).sort(),n=ei({},MR,e?.formatters),s=e?.filter;return i.forEach(o=>{if(s?.(o))return;let a=r[o];const l=n[o];l&&(a=l(a,e)),!(o==="v"&&a===1)&&(o=="pr"&&a===1||RR(a)&&(BR(o)&&typeof a=="string"&&(a=new dC(a)),t[o]=a))}),t}function pC(r,e={}){return r?wR(LR(r,e),ei({whitespace:!1},e)):""}function PR(r,e={}){const t={};if(!r)return t;const i=Object.entries(r),n=Object.entries(aR).concat(Object.entries(e?.customHeaderMap||{})),s=i.reduce((o,a)=>{var l,c;const[u,h]=a,f=((l=n.find(d=>d[1].includes(u)))===null||l===void 0?void 0:l[0])||wl.REQUEST;return(c=o[f])!==null&&c!==void 0||(o[f]={}),o[f][u]=h,o},{});return Object.entries(s).reduce((o,[a,l])=>(o[a]=pC(l,e),o),t)}function FR(r,e,t){return ei(r,PR(e,t))}const kR="CMCD";function OR(r,e={}){if(!r)return"";const t=pC(r,e);return`${kR}=${encodeURIComponent(t)}`}const Fy=/CMCD=[^&#]+/;function UR(r,e,t){const i=OR(e,t);if(!i)return r;if(Fy.test(r))return r.replace(Fy,i);const n=r.includes("?")?"&":"?";return`${r}${n}${i}`}class gC{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:gn.MANIFEST,su:!this.initialized})}catch(s){this.hls.logger.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=n=>{try{const{frag:s,part:o}=n,a=this.hls.levels[s.level],l=this.getObjectType(s),c={d:(o||s).duration*1e3,ot:l};(l===gn.VIDEO||l===gn.AUDIO||l==gn.MUXED)&&(c.br=a.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const u=o?this.getNextPart(o):this.getNextFrag(s);u!=null&&u.url&&u.url!==s.url&&(c.nor=u.url),this.apply(n,c)}catch(s){this.hls.logger.warn("Could not generate segment CMCD data.",s)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHED,this.onMediaDetached,this),e.on(M.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHED,this.onMediaDetached,this),e.off(M.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:iR.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){ei(t,this.createData());const i=t.ot===gn.INIT||t.ot===gn.VIDEO||t.ot===gn.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((o,a)=>(n.includes(a)&&(o[a]=t[a]),o),{}));const s={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),FR(e.headers,t,s)):e.url=UR(e.url,t,s)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t,i;const{index:n,fragment:s}=e,o=(t=this.hls.levels[s.level])==null||(i=t.details)==null?void 0:i.partList;if(o){const{sn:a}=s;for(let l=o.length-1;l>=0;l--){const c=o[l];if(c.index===n&&c.fragment.sn===a)return o[l+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return gn.TIMED_TEXT;if(e.sn==="initSegment")return gn.INIT;if(t==="audio")return gn.AUDIO;if(t==="main")return this.hls.audioTracks.length?gn.VIDEO:gn.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===gn.AUDIO)i=n.audioTracks;else{const s=n.maxAutoLevel,o=s>-1?s+1:n.levels.length;i=n.levels.slice(0,o)}for(const s of i)s.bitrate>t&&(t=s.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===gn.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:Tt.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}}const NR=3e5;class yC extends dr{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if(i?.action===Ki.SendAlternateToPenaltyBox&&i.flags===Vn.MoveAllAlternatesMatchingHost){const n=this.levels;let s=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:l,type:c}=t.context;a&&n?o=this.getPathwayForGroupId(a,c,o):l&&(o=l)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!s&&n&&(s=this.pathways()),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==o),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${n&&n.length} priorities: ${pi(s)} penalized: ${pi(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(s=>{n-i[s]>NR&&delete i[s]});for(let s=0;s<e.length;s++){const o=e[s];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,l=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,U4(t),this.hls.trigger(M.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[a];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let s=0;s<n.length;s++)if(t===Bt.AUDIO_TRACK&&n[s].hasAudioGroup(e)||t===Bt.SUBTITLE_TRACK&&n[s].hasSubtitleGroup(e))return n[s].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(s=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":l}=s;if(t.some(u=>u.pathwayId===o))return;const c=this.getLevelsForPathway(a).map(u=>{const h=new mi(u.attrs);h["PATHWAY-ID"]=o;const f=h.AUDIO&&`${h.AUDIO}_clone_${o}`,d=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),d&&(n[h.SUBTITLES]=d,h.SUBTITLES=d);const m=vC(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),A=new ga({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:m,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let p=1;p<u.audioGroups.length;p++)A.addGroupId("audio",`${u.audioGroups[p]}_clone_${o}`);if(u.subtitleGroups)for(let p=1;p<u.subtitleGroups.length;p++)A.addGroupId("text",`${u.subtitleGroups[p]}_clone_${o}`);return A});t.push(...c),ky(this.audioTracks,i,l,o),ky(this.subtitleTracks,n,l,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const s={responseType:"json",url:n.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},c={onSuccess:(u,h,f,d)=>{this.log(`Loaded steering manifest: "${n}"`);const m=u.data;if(m?.VERSION!==1){this.log(`Steering VERSION ${m.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=m.TTL;const{"RELOAD-URI":A,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":g}=m;if(A)try{this.uri=new self.URL(A,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${A}`);return}this.scheduleRefresh(this.uri||f.url),p&&this.clonePathways(p);const v={steeringManifest:m,url:n.toString()};this.hls.trigger(M.STEERING_MANIFEST_LOADED,v),g&&this.updatePathwayPriority(g)},onError:(u,h,f,d)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let m=this.timeToLoad*1e3;if(u.code===429){const A=this.loader;if(typeof A?.getResponseHeader=="function"){const p=A.getResponseHeader("Retry-After");p&&(m=parseFloat(p)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,m)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(s,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function ky(r,e,t,i){r&&Object.keys(e).forEach(n=>{const s=r.filter(o=>o.groupId===n).map(o=>{const a=ei({},o);return a.details=void 0,a.attrs=new mi(a.attrs),a.url=a.attrs.URI=vC(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[n],a.attrs["PATHWAY-ID"]=i,a});r.push(...s)})}function vC(r,e,t,i){const{HOST:n,PARAMS:s,[t]:o}=i;let a;e&&(a=o?.[e],a&&(r=a));const l=new self.URL(r);return n&&!a&&(l.host=n),s&&Object.keys(s).sort().forEach(c=>{c&&l.searchParams.set(c,s[c])}),l.href}class ao extends dr{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=ao.CDMCleanupPromise?[ao.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,s=`"${t.type}" event: init data type: "${i}"`;if(this.debug(s),n!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=iu(this.config));const a=o.map(Id).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=Ed(o);let l,c;if(i==="sinf"){if(a!==Ht.FAIRPLAY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}const m=Ui(new Uint8Array(n));try{const A=bA(JSON.parse(m).sinf),p=A4(A);if(!p)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(p.subarray(8,24)),c=Ht.FAIRPLAY}catch(A){this.warn(`${s} Failed to parse sinf: ${A}`);return}}else{if(a!==Ht.WIDEVINE&&a!==Ht.PLAYREADY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}const m=j8(n),A=m.filter(g=>!!g.systemId&&Cd(g.systemId)===a);A.length>1&&this.warn(`${s} Using first of ${A.length} pssh found for selected key-system ${a}`);const p=A[0];if(!p){m.length===0||m.some(g=>!g.systemId)?this.warn(`${s} contains incomplete or invalid pssh data`):this.log(`ignoring ${s} for ${m.map(g=>Cd(g.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(c=Cd(p.systemId),p.version===0&&p.data)if(c===Ht.WIDEVINE){const g=p.data.length-22;l=new Uint8Array(p.data.subarray(g,g+16))}else c===Ht.PLAYREADY&&(l=D4(p.data))}if(!c||!l)return;const u=Rs.hexDump(l),{keyIdToKeySessionPromise:h,mediaKeySessions:f}=this;let d=h[u];for(let m=0;m<f.length;m++){const A=f[m],p=A.decryptdata;if(!p.keyId)continue;const g=Rs.hexDump(p.keyId);if(u===g||p.uri.replace(/-/g,"").indexOf(u)!==-1){if(d=h[g],p.pssh)break;delete h[g],p.pssh=new Uint8Array(n),p.keyId=l,d=h[u]=d.then(()=>this.generateRequestWithPreferredKeySession(A,i,n,"encrypted-event-key-match")),d.catch(v=>this.handleError(v));break}}if(!d){if(c!==a){this.log(`Ignoring "${t.type}" event with ${c} init data for selected key-system ${a}`);return}d=h[u]=this.getKeySystemSelectionPromise([c]).then(({keySystem:m,mediaKeys:A})=>{var p;this.throwIfDestroyed();const g=new ya("ISO-23001-7",u,(p=Id(m))!=null?p:"");return g.pssh=new Uint8Array(n),g.keyId=l,this.attemptSetMediaKeys(m,A).then(()=>{this.throwIfDestroyed();const v=this.createMediaKeySessionContext({decryptdata:g,keySystem:m,mediaKeys:A});return this.generateRequestWithPreferredKeySession(v,i,n,"encrypted-event-no-match")})}),d.catch(m=>this.handleError(m))}})}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){const e=this.media;this.unregisterListeners(),this.onMediaDetached(),this._clear(e);const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(M.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(M.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(M.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(M.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(M.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(M.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t[e];if(n)return n.licenseUrl;if(e===Ht.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,l)=>!!o&&l.indexOf(o)===a,n=t.map(o=>o.audioCodec).filter(i),s=t.map(o=>o.videoCodec).filter(i);return n.length+s.length===0&&s.push("avc1.42e01e"),new Promise((o,a)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,n,s).then(h=>o({keySystem:u,mediaKeys:h})).catch(h=>{c.length?l(c):h instanceof Gn?a(h):a(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return wA===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){const n=F9(e,t,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[e];let o=s?.keySystemAccess;if(!o){this.log(`Requesting encrypted media "${e}" key-system access with config: ${pi(n)}`),o=this.requestMediaKeySystemAccess(e,n);const a=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),o.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),a.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),c.then(h=>h?this.setMediaKeysServerCertificate(u,e,h):u))),a.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),a.mediaKeys})}return o.then(()=>s.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Rs.hexDump(e.keyId||[])}`);const n=i.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t),s="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,s,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return Rs.hexDump(e.keyId)}updateKeySession(e,t){var i;const n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyID ${Rs.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),n.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const n=iu(this.config),s=e.map(Ed).filter(o=>!!o&&n.indexOf(o)!==-1);return this.getKeySystemSelectionPromise(s).then(({keySystem:o})=>{const a=Id(o);a?t(a):i(new Error(`Unable to find format for key-system "${o}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),n=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.getKeySystemForKeyPromise(t).then(({keySystem:a,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(a,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:a,mediaKeys:l,decryptdata:t}))))),(this.keyIdToKeySessionPromise[i]=s.then(a=>{const l="cenc",c=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(a,l,c,"playlist-key")})).catch(a=>this.handleError(a))),s}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Gn?this.hls.trigger(M.ERROR,e.data):this.hls.trigger(M.ERROR,{type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=Ed(e.keyFormat),s=n?[n]:iu(this.config);return this.attemptKeySystemAccess(s)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=iu(this.config)),e.length===0)throw new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${pi({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(s=>i.indexOf(s)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var s,o;const a=(s=this.config.drmSystems)==null||(o=s[e.keySystem])==null?void 0:o.generateRequest;if(a)try{const m=a.call(this.hls,t,i,e);if(!m)throw new Error("Invalid response from configured generateRequest filter");t=m.initDataType,i=m.initData?m.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(m){var l;if(this.warn(m.message),(l=this.hls)!=null&&l.config.debug)throw m}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${n}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const u=new BA,h=e._onmessage=m=>{const A=e.mediaKeysSession;if(!A){u.emit("error",new Error("invalid state"));return}const{messageType:p,message:g}=m;this.log(`"${p}" message event for session "${A.sessionId}" message size: ${g.byteLength}`),p==="license-request"||p==="license-renewal"?this.renewLicense(e,g).catch(v=>{u.eventNames().length?u.emit("error",v):this.handleError(v)}):p==="license-release"?e.keySystem===Ht.FAIRPLAY&&(this.updateKeySession(e,cm("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${p}"`)},f=e._onkeystatuseschange=m=>{if(!e.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const p=e.keyStatus;u.emit("keyStatus",p),p==="expired"&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",h),e.mediaKeysSession.addEventListener("keystatuseschange",f);const d=new Promise((m,A)=>{u.on("error",A),u.on("keyStatus",p=>{p.startsWith("usable")?m():p==="output-restricted"?A(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):p==="internal-error"?A(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${p}"`)):p==="expired"?A(new Error("key expired while generating request")):this.warn(`unhandled key status change "${p}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var m;this.log(`Request generated for key-session "${(m=e.mediaKeysSession)==null?void 0:m.sessionId}" keyId: ${c}`)}).catch(m=>{throw new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_NO_SESSION,error:m,fatal:!1},`Error generating key-session request: ${m}`)}).then(()=>d).catch(m=>{throw u.removeAllListeners(),this.removeSession(e),m}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if(typeof i=="string"&&typeof t=="object"){const n=i;i=t,t=n}this.log(`key status change "${t}" for keyStatuses keyId: ${Rs.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Rs.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),s=this.getServerCertificateUrl(e);return s?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const l={responseType:"arraybuffer",url:s},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{o(f.data)},onError:(f,d,m,A)=>{a(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:Kt({url:l.url,data:void 0},f)},`"${e}" certificate request failed (${s}). Status: ${f.code} (${f.text})`))},onTimeout:(f,d,m)=>{a(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${s})`))},onAbort:(f,d,m)=>{a(new Error("aborted"))}};n.load(l,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,s)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i?.byteLength}) on "${t}"`),n(e)}).catch(o=>{s(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:n,fatal:!0},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),s=n.querySelectorAll("HttpHeader");if(s.length>0){let u;for(let h=0,f=s.length;h<f;h++){var o,a;u=s[h];const d=(o=u.querySelector("name"))==null?void 0:o.textContent,m=(a=u.querySelector("value"))==null?void 0:a.textContent;d&&m&&e.setRequestHeader(d,m)}}const l=n.querySelector("Challenge"),c=l?.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return cm(atob(c))}setupLicenseXHR(e,t,i,n){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,i,n)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),s.call(this.hls,e,t,i,n)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,s)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let l=a.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,a,o,e)}catch(u){this.error(u)}n(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||a.status>=400&&a.status<500)s(new Gn({type:nt.KEY_SYSTEM_ERROR,details:me.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==Ht.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.removeEventListener("encrypted",this.onMediaEncrypted),i.removeEventListener("waitingforkey",this.onWaitingForKey),i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null)}_clear(e){var t;const i=this.mediaKeySessions;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},ya.clearKeyUriToKeyIdMap();const n=i.length;ao.CDMCleanupPromise=Promise.all(i.map(s=>this.removeSession(s)).concat(e==null||(t=e.setMediaKeys(null))==null?void 0:t.catch(s=>{var o;this.log(`Could not clear media keys: ${s}`),(o=this.hls)==null||o.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${s}`)})}))).then(()=>{n&&(this.log("finished closing key sessions and clearing media keys"),i.length=0)}).catch(s=>{var o;this.log(`Could not close sessions and clear media keys: ${s}`),(o=this.hls)==null||o.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${s}`)})})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,s)=>(n.indexOf(s.keyFormat)===-1&&n.push(s.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{drmSystemOptions:s}=this.config;return(O9(s)?new Promise((a,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(a)}):Promise.resolve()).catch(a=>{var l;this.log(`Could not remove session: ${a}`),(l=this.hls)==null||l.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${a}`)})}).then(()=>t.close()).catch(a=>{var l;this.log(`Could not close session: ${a}`),(l=this.hls)==null||l.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${a}`)})})}}}ao.CDMCleanupPromise=void 0;class Gn extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class EC{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(M.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(M.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const s=n-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,l=1e3*o/s,c=this.hls;if(c.trigger(M.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),l>0&&o>c.config.fpsDroppedMonitoringThreshold*a){let u=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(M.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function CC(r,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=r,e.dispatchEvent(t)}function IC(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues&&!r.cues.getCueById(e.id))try{if(r.addCue(e),!r.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Lt.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,r.addCue(n)}catch(n){Lt.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(r.mode=t)}function ea(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues)for(let i=r.cues.length;i--;)e&&r.cues[i].removeEventListener("enter",e),r.removeCue(r.cues[i]);t==="disabled"&&(r.mode=t)}function gm(r,e,t,i){const n=r.mode;if(n==="disabled"&&(r.mode="hidden"),r.cues&&r.cues.length>0){const s=QR(r.cues,e,t);for(let o=0;o<s.length;o++)(!i||i(s[o]))&&r.removeCue(s[o])}n==="disabled"&&(r.mode=n)}function GR(r,e){if(e<=r[0].startTime)return 0;const t=r.length-1;if(e>r[t].endTime)return-1;let i=0,n=t,s;for(;i<=n;)if(s=Math.floor((n+i)/2),e<r[s].startTime)n=s-1;else if(e>r[s].startTime&&i<t)i=s+1;else return s;return r[i].startTime-e<e-r[n].startTime?i:n}function QR(r,e,t){const i=[],n=GR(r,e);if(n>-1)for(let s=n,o=r.length;s<o;s++){const a=r[s];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function Wu(r){const e=[];for(let t=0;t<r.length;t++){const i=r[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(r[t])}return e}class _C extends Xh{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=Wu(this.media.textTracks);for(let s=0;s<i.length;s++)if(i[s].mode==="hidden")t=i[s];else if(i[s].mode==="showing"){t=i[s];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.LEVEL_LOADING,this.onLevelLoading,this),e.on(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(M.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(M.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.LEVEL_LOADING,this.onLevelLoading,this),e.off(M.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(M.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(M.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;Wu(i.textTracks).forEach(o=>{ea(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(o=>n?.indexOf(o)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(u=>u.default)&&(this.selectDefaultTrack=!1),o.forEach((u,h)=>{u.id=h});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!s&&a){this.selectDefaultTrack=!1;const u=ks(a,o);if(u>-1)s=o[u];else{const h=ks(a,this.tracks);s=this.tracks[h]}}let l=this.findTrackId(s);l===-1&&s&&(l=this.findTrackId(null));const c={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i?.join(",")}" group-id`),this.hls.trigger(M.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const s=t[n];if(!(i&&!s.default||!i&&!e)&&(!e||oo(s,e)))return n}if(e){for(let n=0;n<t.length;n++){const s=t[n];if(ac(e.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const s=t[n];if(ac(e.attrs,s.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(mm(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Bt.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&oo(e,i))return i;const n=ks(e,this.tracksInGroup);if(n>-1){const s=this.tracksInGroup[n];return this.setSubtitleTrack(n),s}else{if(i)return null;{const s=ks(e,t);if(s>-1)return t[s]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(M.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=Wu(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(s=>mm(i,s))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(s=>{s.mode!=="disabled"&&s!==n&&(s.mode="disabled")}),n){const s=this.subtitleDisplay?"showing":"hidden";n.mode!==s&&(n.mode=s)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!Ye(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(M.SUBTITLE_TRACK_SWITCH,{id:e});return}const s=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&s)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:o,groupId:a="",name:l,type:c,url:u}=n;this.hls.trigger(M.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:l,type:c,url:u});const h=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(h)}}function zl(r){let e=5381,t=r.length;for(;t;)e=e*33^r.charCodeAt(--t);return(e>>>0).toString()}const ua=.025;let xh=function(r){return r[r.Point=0]="Point",r[r.Range=1]="Range",r}({});function zR(r,e,t){return`${r.identifier}-${t+1}-${zl(e)}`}class HR{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){if(e>=this.assetList.length)return!0;const t=this.playoutLimit;return e<=0||isNaN(t)?!1:this.assetList[e].startOffset>t}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return Dd(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=Dd(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=Ye(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return Dd(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<ua))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?xh.Range:xh.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return VR(this)}}function Dd(r,e){return r-e.start<e.duration/2&&!(Math.abs(r-(e.start+e.duration))<ua)?e.start:e.start+e.duration}function xC(r,e,t){const i=new self.URL(r,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function VR(r){return`["${r.identifier}" ${r.cue.pre?"<pre>":r.cue.post?"<post>":""}${r.timelineStart.toFixed(2)}-${r.resumeTime.toFixed(2)}]`}function ym(r){const e=r.timelineStart,t=r.duration||0;return`["${r.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class KR{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{const c=this.interstitial.playoutLimit,u=this.currentTime;this.startOffset+u>=c&&this.hls.trigger(M.PLAYOUT_LIMIT_REACHED,{})};const s=this.hls=new e(t);this.interstitial=i,this.assetItem=n;let o=n.uri;try{o=xC(o,s.sessionId).href}catch{}s.loadSource(o);const a=()=>{this.hasDetails=!0};s.once(M.LEVEL_LOADED,a),s.once(M.AUDIO_TRACK_LOADED,a),s.once(M.SUBTITLE_TRACK_LOADED,a),s.on(M.MEDIA_ATTACHING,(l,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&c.addEventListener("timeupdate",this.checkPlayout)})}bufferedInPlaceToEnd(e){var t;if(!this.interstitial.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const i=this.timelineOffset,n=Tt.bufferInfo(e,i,0);return this.getAssetTime(n.end)>=this._bufferedEosTime-.02}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=Tt.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e,t;return`HlsAssetPlayer: ${ym(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${(t=this.interstitial)!=null&&t.appendInPlace?"append-in-place":""}`}}const Oy=.033;class $R extends dr{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(s=n[i])!=null&&s.event;){var s;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let s=i[n];if(t&&t!=="primary"&&(s=s[t]),e===s.start||e>s.start&&e<s.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const s=i[n].event;if(s!=null&&s.restrictions.jump&&!s.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let s=0;s<n;s++){const o=i[s];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&t<a+(o.duration||0))return s}}return 0}get assetIdAtEnd(){var e,t;const i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){const n=i.assetList,s=n[n.length-1];if(s)return s.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,s=this.events,o=this.parseDateRanges(n,{url:i.url},t),a=Object.keys(n),l=s?s.filter(c=>!a.includes(c.identifier)):[];o.length&&o.sort((c,u)=>{const h=c.cue.pre,f=c.cue.post,d=u.cue.pre,m=u.cue.post;if(h&&!d)return-1;if(d&&!h||f&&!m)return 1;if(m&&!f)return-1;if(!h&&!d&&!f&&!m){const A=c.startTime,p=u.startTime;if(A!==p)return A-p}return c.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=o,l.forEach(c=>{this.removeEvent(c)}),this.updateSchedule(e,l)}updateSchedule(e,t=[]){const i=this.events||[];if(i.length||t.length||this.length<2){const n=this.items,s=this.parseSchedule(i,e);(t.length||n?.length!==s.length||s.some((a,l)=>Math.abs(a.playout.start-n[l].playout.start)>.005||Math.abs(a.playout.end-n[l].playout.end)>.005))&&(this.items=s,this.onScheduleUpdate(t,n))}}parseDateRanges(e,t,i){const n=[],s=Object.keys(e);for(let o=0;o<s.length;o++){const a=s[o],l=e[a];if(l.isInterstitial){let c=this.eventMap[a];c?c.setDateRange(l):(c=new HR(l,t),this.eventMap[a]=c,i===!1&&(c.appendInPlace=i)),n.push(c)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,s=n.live?1/0:n.edge;let o=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((u,h)=>{const f=u.cue.pre,d=u.cue.post,m=e[h-1]||null,A=u.appendInPlace,p=d?s:u.startOffset,g=u.duration,v=u.timelineOccupancy===xh.Range?g:0,E=u.resumptionOffset,C=m?.startTime===p,I=p+u.cumulativeDuration;let _=A?I+g:p+E;if(f||!d&&p<=0){const S=c;c+=v,u.timelineStart=I;const b=o;o+=g,i.push({event:u,start:I,end:_,playout:{start:b,end:o},integrated:{start:S,end:c}})}else if(p<=s){if(!C){const T=p-l;if(T>Oy){const B=l,w=c;c+=T;const R=o;o+=T;const D={previousEvent:e[h-1]||null,nextEvent:u,start:B,end:B+T,playout:{start:R,end:o},integrated:{start:w,end:c}};i.push(D)}else T>0&&m&&(m.cumulativeDuration+=T,i[i.length-1].end=p)}d&&(_=I),u.timelineStart=I;const S=c;c+=v;const b=o;o+=g,i.push({event:u,start:I,end:_,playout:{start:b,end:o},integrated:{start:S,end:c}})}else return;const x=u.resumeTime;d||x>s?l=s:l=x}),l<s){var a;const u=l,h=c,f=s-l;c+=f;const d=o;o+=f,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:l,end:u+f,playout:{start:d,end:o},integrated:{start:h,end:c}})}this.setDurations(s,o,c)}else i.push({previousEvent:null,nextEvent:null,start:0,end:s,playout:{start:0,end:s},integrated:{start:0,end:s}}),this.setDurations(s,s,s);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let s=0,o=-1;e.forEach((a,l)=>{const c=a.cue.pre,u=a.cue.post,h=c?0:u?n:a.startTime;this.updateAssetDurations(a),o===h?a.cumulativeDuration=s:(s=0,o=h),!u&&a.snapOptions.in&&(a.resumeAnchor=co(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<Oy&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const d=Ye(a.resumeOffset)?a.resumeOffset:a.duration;s+=d})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>ua?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):t?!Object.keys(t).some(o=>{const a=t[o].details,l=a.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${l}`),!1;const c=co(null,a.fragments,i);if(!c)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const u=o==="audio"?.175:0;return Math.abs(c.start-i)<ua+u||Math.abs(c.end-i)<ua+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,s=!1;e.assetList.forEach((o,a)=>{const l=t+i;o.startOffset=i,o.timelineStart=l,n||(n=o.duration===null),s||(s=!!o.error);const c=o.error?0:o.duration||0;i+=c}),n&&!s?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Er(r){return`[${r.event?'"'+r.event.identifier+'"':"primary"}: ${r.start.toFixed(2)}-${r.end.toFixed(2)}]`}class jR{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=xC(i,this.hls.sessionId,e.baseUrl)}catch(f){const d=this.assignAssetListError(e,me.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(M.ERROR,d);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const s=this.hls.config,o=s.loader,a=new o(s),l={responseType:"json",url:n.href},c=s.interstitialAssetListLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const p=f.data,g=p?.ASSETS;if(!Array.isArray(g)){const v=this.assignAssetListError(e,me.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),m.url,d,A);this.hls.trigger(M.ERROR,v);return}e.assetListResponse=p,this.hls.trigger(M.ASSET_LIST_LOADED,{event:e,assetListResponse:p,networkDetails:A})},onError:(f,d,m,A)=>{const p=this.assignAssetListError(e,me.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${d.url})`),d.url,A,m);this.hls.trigger(M.ERROR,p)},onTimeout:(f,d,m)=>{const A=this.assignAssetListError(e,me.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${d.url})`),d.url,f,m);this.hls.trigger(M.ERROR,A)}};return a.load(l,u,h),this.hls.trigger(M.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,n,s,o){return e.error=i,{type:nt.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:o,stats:s}}}function rr(r,e,t){Os(r,e,t),r.addEventListener(e,t)}function Os(r,e,t){r.removeEventListener(e,t)}function Uy(r){r?.play().catch(()=>{})}class YR extends dr{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const o=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(),this.checkBuffer(),o&&i<a.start||i>=a.end){var l;const f=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(a)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!o){const d=this.findItemIndex(a);if(f>d){const m=this.schedule.findJumpRestrictedIndex(d+1,f);if(m>d){this.setSchedulePosition(m);return}}}this.setSchedulePosition(f);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(a)){const f=a.event.assetList[0];f&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,f))}return}const u=c.timelineStart,h=c.duration||0;(o&&i<u||i>=u+h)&&this.setScheduleToAssetAtTime(i,c)},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const a=this.findItemIndex(n);this.setSchedulePosition(a+1)}const s=this.playingAsset;if(!s)return;const o=s.timelineStart+(s.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,s)},this.onScheduleUpdate=(i,n)=>{const s=this.schedule,o=this.playingItem,a=s.events||[],l=s.items||[],c=s.durations,u=i.map(d=>d.identifier),h=!!(a.length||u.length);if(h&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${l.map(d=>Er(d))}`),u.length&&this.log(`Removed events ${u}`),this.playerQueue.forEach(d=>{if(d.interstitial.appendInPlace){const m=d.assetItem.timelineStart,A=d.timelineOffset-m;if(A)try{d.timelineOffset=m}catch(p){Math.abs(A)>ua&&this.warn(`${p} ("${d.assetId}" ${d.timelineOffset}->${m})`)}}}),o){const d=this.updateItem(o,this.timelinePos);this.itemsMatch(o,d)&&(this.playingItem=d,this.waitingItem=this.endedItem=null)}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f){const d=this.updateItem(f,this.bufferedPos);this.itemsMatch(f,d)?this.bufferingItem=d:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))}if(i.forEach(d=>{d.assetList.forEach(m=>{this.clearAssetPlayer(m.identifier,null)})}),h||n){if(this.hls.trigger(M.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:l.slice(0),durations:c,removedIds:u}),this.isInterstitial(o)&&u.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new jR(e),this.schedule=new $R(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(M.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(M.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(M.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(M.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(M.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(M.BUFFER_APPENDED,this.onBufferAppended,this),e.on(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(M.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(M.MEDIA_ENDED,this.onMediaEnded,this),e.on(M.ERROR,this.onError,this),e.on(M.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(M.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(M.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(M.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(M.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(M.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(M.BUFFER_CODECS,this.onBufferCodecs,this),e.off(M.BUFFER_APPENDED,this.onBufferAppended,this),e.off(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(M.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(M.MEDIA_ENDED,this.onMediaEnded,this),e.off(M.ERROR,this.onError,this),e.off(M.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Os(e,"play",this.onPlay),Os(e,"pause",this.onPause),Os(e,"seeking",this.onSeeking),Os(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;rr(i,"seeking",this.onSeeking),rr(i,"timeupdate",this.onTimeupdate),rr(i,"play",this.onPlay),rr(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const s=this.findItemIndex(i);this.setSchedulePosition(s)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const s=this.getBufferingPlayer();s&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,s.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=h=>h&&e.getAssetPlayer(h.identifier),n=(h,f,d,m,A)=>{if(h){let p=h[f].start;const g=h.event;if(g){if(f==="playout"||g.timelineOccupancy!==xh.Point){const v=i(d);v?.interstitial===g&&(p+=v.assetItem.startOffset+v[A])}}else{const v=m==="bufferedPos"?o():e[m];p+=v-h.start}return p}return 0},s=(h,f)=>{if(h!==0&&f!=="primary"&&e.schedule.length){var d;const m=e.schedule.findItemIndexAtTime(h),A=(d=e.schedule.items)==null?void 0:d[m];if(A){const p=A[f].start-A.start;return h+p}}return h},o=()=>{const h=e.bufferedPos;return h===Number.MAX_VALUE?a("primary"):Math.max(h,0)},a=h=>{var f;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:e.schedule.durations[h]},l=(h,f)=>{var d,m;const A=e.effectivePlayingItem;if(A!=null&&(d=A.event)!=null&&d.restrictions.skip)return;e.log(`seek to ${h} "${f}"`);const p=e.effectivePlayingItem,g=e.schedule.findItemIndexAtTime(h,f),v=(m=e.schedule.items)==null?void 0:m[g],E=e.getBufferingPlayer(),C=E?.interstitial,I=C?.appendInPlace,_=p&&e.itemsMatch(p,v);if(p&&(I||_)){const S=i(e.playingAsset),b=S?.media||e.primaryMedia;if(b){const T=f==="primary"?b.currentTime:n(p,f,e.playingAsset,"timelinePos","currentTime"),B=h-T,w=(I?T:b.currentTime)+B;if(w>=0&&(!S||I||w<=S.duration)){b.currentTime=w;return}}}if(v){let S=h;if(f!=="primary"){const T=v[f].start,B=h-T;S=v.start+B}const b=!e.isInterstitial(v);if((!e.isInterstitial(p)||p.event.appendInPlace)&&(b||v.event.appendInPlace)){const T=e.media||(I?E?.media:null);T&&(T.currentTime=S)}else if(p){const T=e.findItemIndex(p);if(g>T){const w=e.schedule.findJumpRestrictedIndex(T+1,g);if(w>T){e.setSchedulePosition(w);return}}let B=0;if(b)e.timelinePos=S,e.checkBuffer();else{var x;const w=v==null||(x=v.event)==null?void 0:x.assetList;if(w){const R=h-(v[f]||v).start;for(let D=w.length;D--;){const G=w[D];if(G.duration&&R>=G.startOffset&&R<G.startOffset+G.duration){B=D;break}}}}e.setSchedulePosition(g,B)}}},c=()=>{const h=e.effectivePlayingItem;if(e.isInterstitial(h))return h;const f=t();return e.isInterstitial(f)?f:null},u={get currentTime(){const h=c(),f=e.effectivePlayingItem;return f&&f===h?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(h){const f=c(),d=e.effectivePlayingItem;d&&d===f&&l(h+d.playout.start,"playout")},get duration(){const h=c();return h?h.playout.end-h.playout.start:0},get assetPlayers(){var h;const f=(h=c())==null?void 0:h.event.assetList;return f?f.map(d=>e.getAssetPlayer(d.identifier)):[]},get playingIndex(){var h;const f=(h=c())==null?void 0:h.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};this.manager={get events(){var h,f;return((h=e.schedule)==null||(f=h.events)==null?void 0:f.slice(0))||[]},get schedule(){var h,f;return((h=e.schedule)==null||(f=h.items)==null?void 0:f.slice(0))||[]},get interstitialPlayer(){return c()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const h=t();return e.findItemIndex(h)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const h=e.effectivePlayingItem;return e.findItemIndex(h)},primary:{get bufferedEnd(){return o()},get currentTime(){const h=e.timelinePos;return h>0?h:0},set currentTime(h){l(h,"primary")},get duration(){return a("primary")},get seekableStart(){var h;return((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(h){l(h,"integrated")},get duration(){return a("integrated")},get seekableStart(){var h;return s(((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0,"integrated")}},skip:()=>{const h=e.effectivePlayingItem,f=h?.event;if(f&&!f.restrictions.skip){const d=e.findItemIndex(h);if(f.appendInPlace){const m=h.playout.start+h.event.duration;l(m+.001,"playout")}else e.advanceAfterAssetEnded(f,d,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t,i;if(this.mediaSelection===null)return;const n=this.waitingItem||this.playingItem;if(this.isInterstitial(n)&&!n.event.appendInPlace)return;let s=this.media;!s&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(s=this.primaryMedia);const o=(i=s)==null?void 0:i.currentTime;if(!(o===void 0||!Ye(o)))return o}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const s=e.transferMedia();this.log(`transfer MediaSource from ${e} ${pi(s)}`),this.detachedData=s}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let s=null;const o=this.hls,a=e!==o,l=a&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(o.media)l&&(s=o.transferMedia(),this.detachedData=s),u="Primary";else if(c){const d=this.getBufferingPlayer();d?(s=d.transferMedia(),u=`${d}`):u="detached MediaSource"}else u="detached media";if(!s){if(c)s=this.detachedData,this.log(`using detachedData: MediaSource ${pi(s)}`);else if(!this.detachedData||o.media===t){const d=this.playerQueue;d.length>1&&d.forEach(m=>{if(a&&m.interstitial.appendInPlace!==l){const A=m.interstitial;this.clearInterstitial(m.interstitial,null),A.appendInPlace=!1,A.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${A}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const h=s&&"mediaSource"in s&&((n=s.mediaSource)==null?void 0:n.readyState)!=="closed",f=h&&s?s:t;if(this.log(`${h?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${u}`),f===s){const d=a&&e.assetId===this.schedule.assetIdAtEnd;f.overrides={duration:this.schedule.duration,endOfStream:!a||d,cueRemoval:!a}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const s=this.hls.startPosition;if(this.timelinePos=s,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(s>=0||!this.primaryLive){const o=this.timelinePos=s>0?s:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(n&&!this.playingItem){const s=e.findItemIndex(n);this.setSchedulePosition(s)}}advanceAfterAssetEnded(e,t,i){const n=i+1;if(!e.isAssetPastPlayoutLimit(n)&&!e.assetList[n].error)this.setSchedulePosition(t,n);else{const s=this.schedule.items;if(s){const o=t+1,a=s.length;if(o>=a){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.timelinePos=l,this.checkBuffer()),this.setSchedulePosition(o)}}}setScheduleToAssetAtTime(e,t){const i=this.schedule,n=t.parentIdentifier,s=i.getEvent(n);if(s){const o=i.findEventIndex(n),a=i.findAssetIndex(s,e);this.setSchedulePosition(o,a)}}setSchedulePosition(e,t){const i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const n=e>=0?i[e]:null,s=this.playingItem,o=this.playingLastItem;if(this.isInterstitial(s)){var a;const c=s.event,u=this.playingAsset,h=u?.identifier,f=h?this.getAssetPlayer(h):null;if(f&&h&&(!this.eventItemsMatch(s,n)||t!==void 0&&h!==((a=c.assetList)==null?void 0:a[t].identifier))){var l;const d=c.findAssetIndex(u);this.log(`INTERSTITIAL_ASSET_ENDED ${d+1}/${c.assetList.length} ${ym(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(M.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:d,event:c,schedule:i.slice(0),scheduleIndex:e,player:f}),this.retreiveMediaSource(h,n),f.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&f.detachMedia()}if(!this.eventItemsMatch(s,n)&&(this.endedItem=s,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${c} ${Er(s)}`),c.hasPlayed=!0,this.hls.trigger(M.INTERSTITIAL_ENDED,{event:c,schedule:i.slice(0),scheduleIndex:e}),c.cue.once)){this.updateSchedule();const d=this.schedule.items;if(n&&d){const m=this.schedule.findItemIndex(n);this.advanceSchedule(m,d,t,s,o)}return}}this.advanceSchedule(e,i,t,s,o)}advanceSchedule(e,t,i,n,s){const o=e>=0?t[e]:null,a=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(c=>{const u=c.interstitial,h=this.schedule.findEventIndex(u.identifier);(h<e||h>e+1)&&this.clearInterstitial(u,o)}),this.isInterstitial(o)){this.timelinePos=Math.min(Math.max(this.timelinePos,o.start),o.end);const c=o.event;i===void 0&&(i=this.schedule.findAssetIndex(c,this.timelinePos));const u=this.waitingItem;this.assetsBuffered(o,a)||this.setBufferingItem(o);let h=this.preloadAssets(c,i);if(this.eventItemsMatch(o,u||n)||(this.waitingItem=o,this.log(`INTERSTITIAL_STARTED ${Er(o)} ${c.appendInPlace?"append in place":""}`),this.hls.trigger(M.INTERSTITIAL_STARTED,{event:c,schedule:t.slice(0),scheduleIndex:e})),!c.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${c}`);return}if(c.assetListLoader&&(c.assetListLoader.destroy(),c.assetListLoader=void 0),!a){this.log(`Waiting for attachMedia to start Interstitial ${c}`);return}this.waitingItem=this.endedItem=null,this.playingItem=o;const f=c.assetList[i];if(!f){const d=t[e+1],m=this.media;d&&m&&!this.isInterstitial(d)&&m.currentTime<d.start&&(m.currentTime=this.timelinePos=d.start),this.advanceAfterAssetEnded(c,e,i||0);return}if(h||(h=this.getAssetPlayer(f.identifier)),h===null||h.destroyed){const d=c.assetList.length;this.warn(`asset ${i+1}/${d} player destroyed ${c}`),h=this.createAssetPlayer(c,f,i)}if(!this.eventItemsMatch(o,this.bufferingItem)&&c.appendInPlace&&this.isAssetBuffered(f))return;this.startAssetPlayer(h,i,t,e,a),this.shouldPlay&&Uy(h.media)}else o!==null?(this.resumePrimary(o,e,n),this.shouldPlay&&Uy(this.hls.media)):s&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Er(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let o=this.timelinePos;(o<e.start||o>=e.end)&&(o=this.getPrimaryResumption(e,t),this.timelinePos=o),this.attachPrimary(o,e)}if(!i)return;const s=this.schedule.items;s&&(this.log(`resumed ${Er(e)}`),this.hls.trigger(M.INTERSTITIALS_PRIMARY_RESUMED,{schedule:s.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:Tt.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const s=this.hls;s.media?this.checkBuffer():(this.transferMediaTo(s,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(M.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(M.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1)return;const i=this.hls.levels[t.level],n=Kt(Kt({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Kt(Kt({},this.altSelection),{},{audio:i});return}const s=Kt(Kt({},n),{},{audio:i});this.mediaSelection=s}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Kt(Kt({},this.altSelection),{},{subtitles:i});return}const s=Kt(Kt({},n),{},{subtitles:i});this.mediaSelection=s}onAudioTrackSwitching(e,t){const i=q1(t);this.playerQueue.forEach(n=>n.hls.setAudioOption(t)||n.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){const i=q1(t);this.playerQueue.forEach(n=>n.hls.setSubtitleOption(t)||t.id!==-1&&n.hls.setSubtitleOption(i))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const s=t[n];if(s.cue.post){var i;const o=this.schedule.findEventIndex(s.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){const i=this.schedule.items;if(e&&i){const n=this.findItemIndex(e,t);return i[n]||null}return null}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const i=Tt.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){const n=this.schedule,s=this.bufferingItem;if(this.bufferedPos>e)return;if(t.length===1&&this.itemsMatch(t[0],s)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let l=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var c,u;const h=this.findItemIndex(s),f=Math.min(h+1,t.length-1),d=t[f];if((l===-1&&s&&e>=s.end||(c=d.event)!=null&&c.appendInPlace&&e+.01>=d.start)&&(l=f),f-a>1&&(s==null||(u=s.event)==null?void 0:u.appendInPlace)===!1)return;if(this.bufferedPos=e,l>h&&l>a)this.bufferedToItem(d);else{const m=this.primaryDetails;this.primaryLive&&m&&e>m.edge-m.targetduration&&d.start<m.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(d)&&this.preloadAssets(d.event,0)}}else i&&o&&!this.itemsMatch(o,s)&&(l===a?this.bufferedToItem(o):l===a+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const s=this.getAssetPlayer(n.identifier);return!(s!=null&&s.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:n,events:s}=i;if(!n||!s)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();if(this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos)),!this.playbackDisabled){const l=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`buffered to boundary ${Er(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),o?e.event.assetList.forEach(c=>{const u=this.getAssetPlayer(c.identifier);u&&u.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering()))}this.hls.trigger(M.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:s.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,s=i.cue.once;if(n||!s){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=i.assetList[t],l=this.primaryMedia;a&&l&&this.bufferAssetPlayer(o,l)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,s=n===0&&!e.assetListLoader,o=e.cue.once;if(s){const l=e.timelineStart;if(e.appendInPlace){var a;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(a=f.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let c,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-l;f>0&&(c=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${c?` live-start: ${u} start-offset: ${c}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const h=this.assetListLoader.loadAssetList(e,c);h&&(e.assetListLoader=h)}else if(!o&&n){for(let l=t;l<n;l++){const c=e.assetList[l],u=this.getAssetPlayerQueueIndex(c.identifier);(u===-1||this.playerQueue[u].destroyed)&&!c.error&&this.createAssetPlayer(e,c,l)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(M.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,s,o){const a={parentIdentifier:e.identifier,identifier:zR(e,o,t),duration:s,startOffset:i,timelineStart:n,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){this.log(`create HLSAssetPlayer for ${ym(t)}`);const n=this.hls,s=n.userConfig;let o=s.videoPreference;const a=n.loadLevelObj||n.levels[n.currentLevel];(o||a)&&(o=ei({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const l=n.audioTracks[n.audioTrack],c=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const E=this.timelinePos-t.timelineStart;if(E>1){const C=t.duration;C&&E<C&&(u=E)}}const h=t.identifier,f=Kt(Kt({},s),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:h,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:l||s.audioPreference,subtitlePreference:c||s.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const d=f.cmcd;d!=null&&d.sessionId&&d.contentId&&(f.cmcd=ei({},d,{contentId:zl(t.uri)})),this.getAssetPlayer(h)&&this.warn(`Duplicate date range identifier ${e} and asset ${h}`);const m=new KR(this.HlsPlayerClass,f,e,t);this.playerQueue.push(m),e.assetList[i]=t;const A=E=>{if(E.live){const _=new Error(`Interstitials MUST be VOD assets ${e}`),x={fatal:!0,type:nt.OTHER_ERROR,details:me.INTERSTITIAL_ASSET_ITEM_ERROR,error:_};this.handleAssetItemError(x,e,this.schedule.findEventIndex(e.identifier),i,_.message);return}const C=E.edge-E.fragmentStart,I=t.duration;(I===null||C>I)&&(this.log(`Interstitial asset "${h}" duration change ${I} > ${C}`),t.duration=C,this.updateSchedule())};m.on(M.LEVEL_UPDATED,(E,{details:C})=>A(C)),m.on(M.LEVEL_PTS_UPDATED,(E,{details:C})=>A(C));const p=(E,C)=>{const I=this.getAssetPlayer(h);if(I&&C.tracks){I.off(M.BUFFER_CODECS,p),I.tracks=C.tracks;const _=this.primaryMedia;this.bufferingAsset===I.assetItem&&_&&!I.media&&this.bufferAssetPlayer(I,_)}};m.on(M.BUFFER_CODECS,p);const g=()=>{var E;const C=this.getAssetPlayer(h);if(this.log(`buffered to end of asset ${C}`),!C)return;const I=this.schedule.findEventIndex(e.identifier),_=e.findAssetIndex(t),x=_+1,S=(E=this.schedule.items)==null?void 0:E[I];if(this.isInterstitial(S))if(_!==-1&&!e.isAssetPastPlayoutLimit(x)&&!e.assetList[x].error)this.bufferedToItem(S,x);else{var b;const T=(b=this.schedule.items)==null?void 0:b[I+1];T&&this.bufferedToItem(T)}};m.on(M.BUFFERED_TO_END,g);const v=E=>()=>{if(!this.getAssetPlayer(h))return;this.shouldPlay=!0;const I=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,I,E)};return m.once(M.MEDIA_ENDED,v(i)),m.once(M.PLAYOUT_LIMIT_REACHED,v(1/0)),m.on(M.ERROR,(E,C)=>{const I=this.getAssetPlayer(h);if(C.details===me.BUFFER_STALLED_ERROR){if(I!=null&&I.media){const _=I.currentTime,x=I.duration-_;_&&e.appendInPlace&&x/I.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${h} ${e} at ${I.media.currentTime}`),g()):(this.warn(`Stalled at ${_} of ${_+x} in asset ${h} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(C,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${C.error} ${e}`)}),m.on(M.DESTROYING,()=>{if(!this.getAssetPlayer(h))return;const C=new Error(`Asset player destroyed unexpectedly ${h}`),I={fatal:!0,type:nt.OTHER_ERROR,details:me.INTERSTITIAL_ASSET_ITEM_ERROR,error:C};this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),i,C.message)}),this.hls.trigger(M.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:m}),m}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clearAssetPlayer "${e}" toSegment: ${t&&Er(t)}`);const n=this.playerQueue[i];this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,s){const{interstitial:o,assetItem:a,assetId:l}=e,c=o.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!u||u.identifier!==l)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${e}`),this.hls.trigger(M.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,s)}bufferAssetPlayer(e,t){var i,n;const{interstitial:s,assetItem:o,assetId:a}=e,l=this.schedule.findEventIndex(s.identifier),c=(i=this.schedule.items)==null?void 0:i[l];if(!c)return;this.setBufferingItem(c),this.bufferingAsset=o;const u=this.getBufferingPlayer();if(u===e)return;const h=s.appendInPlace;if(h&&u?.interstitial.appendInPlace===!1)return;const f=u?.tracks||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(h&&o!==this.playingAsset){if(!e.tracks)return;if(f&&!l4(f,e.tracks)){const d=new Error(`Asset "${a}" SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(f)}')`),m={fatal:!0,type:nt.OTHER_ERROR,details:me.INTERSTITIAL_ASSET_ITEM_ERROR,error:d},A=s.findAssetIndex(o);this.handleAssetItemError(m,s,l,A,d.message);return}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,n,s){if(e.details===me.BUFFER_STALLED_ERROR)return;const o=t.assetList[n]||null;let a=null;if(o){const h=this.getAssetPlayerQueueIndex(o.identifier);a=this.playerQueue[h]||null}const l=this.schedule.items,c=ei({},e,{fatal:!1,errorAction:nc(!0),asset:o,assetListIndex:n,event:t,schedule:l,scheduleIndex:i,player:a});if(this.warn(`Asset item error: ${e.error}`),this.hls.trigger(M.INTERSTITIAL_ASSET_ERROR,c),!e.fatal)return;const u=new Error(s);o&&(this.playingAsset!==o&&this.clearAssetPlayer(o.identifier,null),o.error=u),t.assetList.some(h=>!h.error)?t.appendInPlace&&(t.error=u):t.error=u,this.primaryFallback(t)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?Er(i):"<none>"} error: ${e.error}`),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));let n=this.timelinePos;n===-1&&(n=this.hls.startPosition);const s=this.updateItem(i,n);if(this.itemsMatch(i,s))this.clearInterstitial(e,null);else{const o=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(o)}}else this.checkStart()}onAssetListLoaded(e,t){var i;const n=t.event,s=n.identifier,o=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(s))return;const a=n.timelineStart,l=n.duration;let c=0;o.forEach((m,A)=>{const p=parseFloat(m.DURATION);this.createAsset(n,A,c,a+c,p,m.URI),c+=p}),n.duration=c,this.log(`Loaded asset-list with duration: ${c} (was: ${l}) ${n}`);const u=this.waitingItem,h=u?.event.identifier===s;this.updateSchedule();const f=(i=this.bufferingItem)==null?void 0:i.event;if(h){var d;const m=this.schedule.findEventIndex(s),A=(d=this.schedule.items)==null?void 0:d[m];if(A){if(!this.playingItem&&this.timelinePos>A.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==m){n.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${n}`),this.primaryFallback(n);return}this.setBufferingItem(A)}this.setSchedulePosition(m)}else if(f?.identifier===s&&f.appendInPlace){const m=n.assetList[0],A=this.getAssetPlayer(m.identifier),p=this.primaryMedia;m&&A&&p&&this.bufferAssetPlayer(A,p)}}onError(e,t){switch(t.details){case me.ASSET_LIST_PARSING_ERROR:case me.ASSET_LIST_LOAD_ERROR:case me.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&this.primaryFallback(i);break}case me.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}}const Ny=500;class SC extends Wh{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",it.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(M.LEVEL_LOADED,this.onLevelLoaded,this),e.on(M.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(M.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(M.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(M.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(M.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(M.LEVEL_LOADED,this.onLevelLoaded,this),e.off(M.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(M.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(M.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(M.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(M.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=De.IDLE,this.setInterval(Ny),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(Yi(i)&&(this.fragPrevious=i),this.state=De.IDLE,!n)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let o;const a=i.start;for(let c=0;c<s.length;c++)if(a>=s[c].start&&a<=s[c].end){o=s[c];break}const l=i.start+i.duration;o?o.end=l:(o={start:a,end:l},s.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const s=n-1;if(s<=0)return;t.endOffsetSubtitles=Math.max(0,s),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=s){o.shift();continue}else if(o[a].start<s)o[a].start=s;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,s,it.SUBTITLE)}}onError(e,t){const i=t.frag;i?.type===it.SUBTITLE&&(t.details===me.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==De.STOPPED&&(this.state=De.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&cC(this.levels,t)){this.levels=t.map(i=>new ga(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new ga(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,it.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==De.STOPPED&&this.setInterval(Ny)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:s}=this,{details:o,id:a}=t;if(!s){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const l=s[a];if(a>=s.length||!l)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(o.live||(i=l.details)!=null&&i.live){const h=this.mainDetails;if(o.deltaUpdateFailed||!h)return;const f=h.fragments[0];if(!l.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Ih(o,h),c=o.fragmentStart):f&&(c=f.start,hm(o,c));else{var u;c=this.alignPlaylists(o,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,hm(o,c))}}l.details=o,this.levelLastLoaded=l,a===n&&(this.hls.trigger(M.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===De.IDLE&&(co(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&ca(n.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,TA(n.method)).catch(a=>{throw s.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const l=performance.now();s.trigger(M.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:l}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=De.IDLE})}}doTick(){if(!this.media){this.state=De.IDLE;return}if(this.state===De.IDLE){const{currentTrackId:e,levels:t}=this,i=t?.[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,s=this.getLoadPosition(),o=Tt.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,n.maxBufferHole),{end:a,len:l}=o,c=i.details,u=this.hls.maxBufferLength+c.levelTargetDuration;if(l>u)return;const h=c.fragments,f=h.length,d=c.edge;let m=null;const A=this.fragPrevious;if(a<d){const v=n.maxFragLookUpTolerance,E=a>d-v?0:v;m=co(A,h,Math.max(h[0].start,a),E),!m&&A&&A.start<h[0].start&&(m=h[0])}else m=h[f-1];if(m=this.filterReplacedPrimary(m,i.details),!m)return;const p=m.sn-c.startSN,g=h[p-1];if(g&&g.cc===m.cc&&this.fragmentTracker.getState(g)===Ni.NOT_LOADED&&(m=g),this.fragmentTracker.getState(m)===Ni.NOT_LOADED){const v=this.mapToInitFragWhenRequired(m);v&&this.loadFragment(v,i,a)}}}loadFragment(e,t,i){Yi(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new WR(this.tracksBuffered[this.currentTrackId]||[])}}class WR{constructor(e){this.buffered=void 0;const t=(i,n,s)=>{if(n=n>>>0,n>s-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${s})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const qR={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},TC=r=>String.fromCharCode(qR[r]||r),hs=15,qs=100,XR={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},JR={17:2,18:4,21:6,22:8,23:10,19:13,20:15},ZR={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},e7={25:2,26:4,29:6,30:8,31:10,27:13,28:15},t7=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class i7{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;Lt.log(`${this.time} [${e}] ${i}`)}}}const Wr=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class bC{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class n7{constructor(){this.uchar=" ",this.penState=new bC}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class s7{constructor(e){this.chars=[],this.pos=0,this.currPenState=new bC,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<qs;t++)this.chars.push(new n7);this.logger=e}equals(e){for(let t=0;t<qs;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<qs;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<qs;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>qs&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=qs)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=TC(e);if(this.pos>=qs){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<qs;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<qs;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Md{constructor(e){this.rows=[],this.currRow=hs-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<hs;t++)this.rows.push(new s7(e));this.logger=e}reset(){for(let e=0;e<hs;e++)this.rows[e].clear();this.currRow=hs-1}equals(e){let t=!0;for(let i=0;i<hs;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<hs;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<hs;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+pi(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<hs;a++)this.rows[a].clear();const s=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[s].cueStartTime,l=this.logger.time;if(a!==null&&l!==null&&a<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(o.rows[s+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const s=e.indent,o=Math.max(s-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+pi(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let s=0;s<hs;s++){const o=this.rows[s].getTextString();o&&(n=s+1,e?t.push("Row "+n+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Gy{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Md(i),this.nonDisplayedMemory=new Md(i),this.lastOutputScreen=new Md(i),this.currRollUpRow=this.displayedMemory.rows[hs-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[hs-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+pi(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Qy{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=o7(),this.logger=void 0;const n=this.logger=new i7;this.channels=[null,new Gy(e,t,n),new Gy(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,s=t[i+1]&127;let o=!1,a=null;if(n===0&&s===0)continue;this.logger.log(3,()=>"["+Wr([t[i],t[i+1]])+"] -> ("+Wr([n,s])+")");const l=this.cmdHistory;if(n>=16&&n<=31){if(r7(n,s,l)){au(null,null,l),this.logger.log(3,()=>"Repeated command ("+Wr([n,s])+") is dropped");continue}au(n,s,this.cmdHistory),o=this.parseCmd(n,s),o||(o=this.parseMidrow(n,s)),o||(o=this.parsePAC(n,s)),o||(o=this.parseBackgroundAttributes(n,s))}else au(null,null,l);if(!o&&(a=this.parseChars(n,s),a)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Wr([n,s])+" orig: "+Wr([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const s=e===20||e===21||e===23?1:2,o=this.channels[s];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=s,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Wr([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,s=(e===16||e===24)&&t>=64&&t<=95;if(!(n||s))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?XR[e]:ZR[e]:i=o===1?JR[e]:e7[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,s=null;if(e>=25?(i=2,s=e-8):(i=1,s=e),s>=17&&s<=19){let o;s===17?o=t+80:s===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+TC(o)+"' in channel "+i),n=[o]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+Wr(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let s;const o={};e===16||e===24?(s=Math.floor((t-32)/2),o.background=t7[s],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}au(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function au(r,e,t){t.a=r,t.b=e}function r7(r,e,t){return t.a===r&&t.b===e}function o7(){return{a:null,b:null}}var OA=function(){if(Ch!=null&&Ch.VTTCue)return self.VTTCue;const r=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,l){if(typeof l!="string"||!Array.isArray(a))return!1;const c=l.toLowerCase();return~a.indexOf(c)?c:!1}function i(a){return t(r,a)}function n(a){return t(e,a)}function s(a,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const h in u)a[h]=u[h]}return a}function o(a,l,c){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",d=!1,m=a,A=l,p=c,g=null,v="",E=!0,C="auto",I="start",_=50,x="middle",S=50,b="middle";Object.defineProperty(u,"id",s({},h,{get:function(){return f},set:function(T){f=""+T}})),Object.defineProperty(u,"pauseOnExit",s({},h,{get:function(){return d},set:function(T){d=!!T}})),Object.defineProperty(u,"startTime",s({},h,{get:function(){return m},set:function(T){if(typeof T!="number")throw new TypeError("Start time must be set to a number.");m=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",s({},h,{get:function(){return A},set:function(T){if(typeof T!="number")throw new TypeError("End time must be set to a number.");A=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",s({},h,{get:function(){return p},set:function(T){p=""+T,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",s({},h,{get:function(){return g},set:function(T){g=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",s({},h,{get:function(){return v},set:function(T){const B=i(T);if(B===!1)throw new SyntaxError("An invalid or illegal string was specified.");v=B,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",s({},h,{get:function(){return E},set:function(T){E=!!T,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",s({},h,{get:function(){return C},set:function(T){if(typeof T!="number"&&T!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");C=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",s({},h,{get:function(){return I},set:function(T){const B=n(T);if(!B)throw new SyntaxError("An invalid or illegal string was specified.");I=B,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",s({},h,{get:function(){return _},set:function(T){if(T<0||T>100)throw new Error("Position must be between 0 and 100.");_=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",s({},h,{get:function(){return x},set:function(T){const B=n(T);if(!B)throw new SyntaxError("An invalid or illegal string was specified.");x=B,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",s({},h,{get:function(){return S},set:function(T){if(T<0||T>100)throw new Error("Size must be between 0 and 100.");S=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",s({},h,{get:function(){return b},set:function(T){const B=n(T);if(!B)throw new SyntaxError("An invalid or illegal string was specified.");b=B,this.hasBeenReset=!0}})),u.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o}();class a7{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function wC(r){function e(i,n,s,o){return(i|0)*3600+(n|0)*60+(s|0)+parseFloat(o||0)}const t=r.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class l7{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function BC(r,e,t,i){const n=i?r.split(i):[r];for(const s in n){if(typeof n[s]!="string")continue;const o=n[s].split(t);if(o.length!==2)continue;const a=o[0],l=o[1];e(a,l)}}const vm=new OA(0,0,""),lu=vm.align==="middle"?"middle":"center";function c7(r,e,t){const i=r;function n(){const a=wC(r);if(a===null)throw new Error("Malformed timestamp: "+i);return r=r.replace(/^[^\sa-zA-Z-]+/,""),a}function s(a,l){const c=new l7;BC(a,function(f,d){let m;switch(f){case"region":for(let A=t.length-1;A>=0;A--)if(t[A].id===d){c.set(f,t[A].region);break}break;case"vertical":c.alt(f,d,["rl","lr"]);break;case"line":m=d.split(","),c.integer(f,m[0]),c.percent(f,m[0])&&c.set("snapToLines",!1),c.alt(f,m[0],["auto"]),m.length===2&&c.alt("lineAlign",m[1],["start",lu,"end"]);break;case"position":m=d.split(","),c.percent(f,m[0]),m.length===2&&c.alt("positionAlign",m[1],["start",lu,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,d);break;case"align":c.alt(f,d,["start",lu,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&vm.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",lu);let h=c.get("position","auto");h==="auto"&&vm.position===50&&(h=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=h}function o(){r=r.replace(/^\s+/,"")}if(o(),e.startTime=n(),o(),r.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);r=r.slice(3),o(),e.endTime=n(),o(),s(r,e)}function RC(r){return r.replace(/<br(?: \/)?>/gi,`
`)}class u7{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new a7,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let s=t.buffer,o=0;for(s=RC(s);o<s.length&&s[o]!=="\r"&&s[o]!==`
`;)++o;const a=s.slice(0,o);return s[o]==="\r"&&++o,s[o]===`
`&&++o,t.buffer=s.slice(o),a}function n(s){BC(s,function(o,a){},/:/)}try{let s="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;s=i();const a=s.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:s=i(),t.state){case"HEADER":/:/.test(s)?n(s):s||(t.state="ID");continue;case"NOTE":s||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){t.state="NOTE";break}if(!s)continue;if(t.cue=new OA(0,0,""),t.state="CUE",s.indexOf("-->")===-1){t.cue.id=s;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{c7(s,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=s.indexOf("-->")!==-1;if(!s||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=s}continue;case"BADCUE":s||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const h7=/\r\n|\n\r|\n|\r/g,Ld=function(e,t,i=0){return e.slice(i,i+t.length)===t},f7=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!Ye(t)||!Ye(i)||!Ye(n)||!Ye(s))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=60*60*1e3*s,t};function UA(r,e,t){return zl(r.toString())+zl(e.toString())+zl(t)}const d7=function(e,t,i){let n=e[t],s=e[n.prevCC];if(!s||!s.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(o=s)!=null&&o.new;){var o;e.ccOffset+=n.start-s.start,n.new=!1,n=s,s=e[n.prevCC]}e.presentationOffset=i};function m7(r,e,t,i,n,s,o){const a=new u7,l=Mn(new Uint8Array(r)).trim().replace(h7,`
`).split(`
`),c=[],u=e?GB(e.baseTime,e.timescale):0;let h="00:00.000",f=0,d=0,m,A=!0;a.oncue=function(p){const g=t[i];let v=t.ccOffset;const E=(f-u)/9e4;if(g!=null&&g.new&&(d!==void 0?v=t.ccOffset=g.start:d7(t,i,E)),E){if(!e){m=new Error("Missing initPTS for VTT MPEGTS");return}v=E-t.presentationOffset}const C=p.endTime-p.startTime,I=Kn((p.startTime+v-d)*9e4,n*9e4)/9e4;p.startTime=Math.max(I,0),p.endTime=Math.max(I+C,0);const _=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(_)),p.id||(p.id=UA(p.startTime,p.endTime,_)),p.endTime>0&&c.push(p)},a.onparsingerror=function(p){m=p},a.onflush=function(){if(m){o(m);return}s(c)},l.forEach(p=>{if(A)if(Ld(p,"X-TIMESTAMP-MAP=")){A=!1,p.slice(16).split(",").forEach(g=>{Ld(g,"LOCAL:")?h=g.slice(6):Ld(g,"MPEGTS:")&&(f=parseInt(g.slice(7)))});try{d=f7(h)/1e3}catch(g){m=g}return}else p===""&&(A=!1);a.parse(p+`
`)}),a.flush()}const Pd="stpp.ttml.im1t",DC=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,MC=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,A7={left:"start",center:"center",right:"end",start:"start",end:"end"};function zy(r,e,t,i){const n=vt(new Uint8Array(r),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const s=n.map(a=>Mn(a)),o=NB(e.baseTime,1,e.timescale);try{s.forEach(a=>t(p7(a,o)))}catch(a){i(a)}}function p7(r,e){const n=new DOMParser().parseFromString(r,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(s).reduce((h,f)=>(h[f]=n.getAttribute(`ttp:${f}`)||s[f],h),{}),a=n.getAttribute("xml:space")!=="preserve",l=Hy(Fd(n,"styling","style")),c=Hy(Fd(n,"layout","region")),u=Fd(n,"body","[begin]");return[].map.call(u,h=>{const f=LC(h,a);if(!f||!h.hasAttribute("begin"))return null;const d=Od(h.getAttribute("begin"),o),m=Od(h.getAttribute("dur"),o);let A=Od(h.getAttribute("end"),o);if(d===null)throw Vy(h);if(A===null){if(m===null)throw Vy(h);A=d+m}const p=new OA(d-e,A-e,f);p.id=UA(p.startTime,p.endTime,p.text);const g=c[h.getAttribute("region")],v=l[h.getAttribute("style")],E=g7(g,v,l),{textAlign:C}=E;if(C){const I=A7[C];I&&(p.lineAlign=I),p.align=C}return ei(p,E),p}).filter(h=>h!==null)}function Fd(r,e,t){const i=r.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function Hy(r){return r.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function LC(r,e){return[].slice.call(r.childNodes).reduce((t,i,n)=>{var s;return i.nodeName==="br"&&n?t+`
`:(s=i.childNodes)!=null&&s.length?LC(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function g7(r,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=r!=null&&r.hasAttribute("style")?r.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(n=t[o]),s.reduce((a,l)=>{const c=kd(e,i,l)||kd(r,i,l)||kd(n,i,l);return c&&(a[l]=c),a},{})}function kd(r,e,t){return r&&r.hasAttributeNS(e,t)?r.getAttributeNS(e,t):null}function Vy(r){return new Error(`Could not parse ttml timestamp ${r}`)}function Od(r,e){if(!r)return null;let t=wC(r);return t===null&&(DC.test(r)?t=y7(r,e):MC.test(r)&&(t=v7(r,e))),t}function y7(r,e){const t=DC.exec(r),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function v7(r,e){const t=MC.exec(r),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class cu{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class PC{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=$y(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(M.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(M.FRAG_LOADING,this.onFragLoading,this),e.on(M.FRAG_LOADED,this.onFragLoaded,this),e.on(M.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(M.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(M.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(M.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(M.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(M.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(M.FRAG_LOADING,this.onFragLoading,this),e.off(M.FRAG_LOADED,this.onFragLoaded,this),e.off(M.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(M.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(M.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(M.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(M.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new cu(this,"textTrack1"),t=new cu(this,"textTrack2"),i=new cu(this,"textTrack3"),n=new cu(this,"textTrack4");this.cea608Parser1=new Qy(1,e,t),this.cea608Parser2=new Qy(3,i,n)}addCues(e,t,i,n,s){let o=!1;for(let a=s.length;a--;){const l=s[a],c=E7(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),o=!0,c/(i-t)>.5))return}if(o||s.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,n)}else{const a=this.Cues.newCue(null,t,i,n);this.hls.trigger(M.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s}){const{unparsedVttFrags:o}=this;i===it.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:s}),o.length&&(this.unparsedVttFrags=[],o.forEach(a=>{this.onFragLoaded(M.FRAG_LOADED,a)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const s=i.textTracks[n];if(Ky(s,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:s,languageCode:o}=t[e],a=this.getExistingTrack(s,o);if(a)i[e]=a,ea(i[e]),CC(i[e],n);else{const l=this.createTextTrack("captions",s,o);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(M.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(s=>{ea(n[s]),delete n[s]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=$y(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)ea(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(s=>s.textCodec===Pd);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(cC(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?Wu(o.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(a){let h=null;for(let f=0;f<a.length;f++)if(a[f]&&Ky(a[f],l)){h=a[f],a[f]=null;break}h&&(u=h)}if(u)ea(u);else{const h=FC(l);u=this.createTextTrack(h,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),a!=null&&a.length){const l=a.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(M.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const s=`textTrack${n[1]}`,o=this.captionsProperties[s];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===it.MAIN){var i,n;const{cea608Parser1:s,cea608Parser2:o,lastSn:a}=this,{cc:l,sn:c}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;s&&o&&(c!==a+1||c===a&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(s.reset(),o.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===it.SUBTITLE)if(n.byteLength){const s=i.decryptdata,o="stats"in t;if(s==null||!s.encrypted||o){const a=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Pd?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(M.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;zy(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(M.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(M.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:s,unparsedVttFrags:o}=this,a=s.length-1;if(!s[i.cc]&&a===-1){o.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?Zn(i.initSegment.data,new Uint8Array(n)).buffer:n;m7(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(M.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,n),l.logger.log(`Failed to parse VTT cue: ${u}`),!(h&&a>i.cc)&&l.trigger(M.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||zy(t,this.initPTS[e.cc],()=>{i.textCodec=Pd,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(s=>IC(n,s))}else{const n=this.tracks[t];if(!n)return;const s=n.default?"default":"subtitles"+t;i.trigger(M.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===it.SUBTITLE&&this.onFragLoaded(M.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===it.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let s=0;s<n.length;s++){const o=n[s].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(n[s].pts,a[0]),this.cea608Parser2.addData(n[s].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:s}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!s||s==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(l=>gm(a[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(l=>gm(a[l],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let s=0;s<i;s++){const o=e[n++],a=127&e[n++],l=127&e[n++];if(a===0&&l===0)continue;if((4&o)!==0){const u=3&o;(u===0||u===1)&&(t[u].push(a),t[u].push(l))}}return t}}function FC(r){return r.characteristics&&/transcribes-spoken-dialog/gi.test(r.characteristics)&&/describes-music-and-sound/gi.test(r.characteristics)?"captions":"subtitles"}function Ky(r,e){return!!r&&r.kind===FC(e)&&mm(e,r)}function E7(r,e,t,i){return Math.min(e,i)-Math.max(r,t)}function $y(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const C7=/\s/,kC={newCue(r,e,t,i){const n=[];let s,o,a,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(s=i.rows[f],a=!0,l=0,c="",!s.isEmpty()){var h;for(let A=0;A<s.chars.length;A++)C7.test(s.chars[A].uchar)&&a?l++:(c+=s.chars[A].uchar,a=!1);s.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const d=RC(c.trim()),m=UA(e,t,d);r!=null&&(h=r.cues)!=null&&h.getCueById(m)||(o=new u(e,t,d),o.id=m,o.line=f+1,o.align="left",o.position=10+Math.min(80,Math.floor(l*8/32)*10),n.push(o))}return r&&n.length&&(n.sort((f,d)=>f.line==="auto"||d.line==="auto"?0:f.line>8&&d.line>8?d.line-f.line:f.line-d.line),n.forEach(f=>IC(r,f))),n}};function OC(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const I7=/(\d+)-(\d+)\/(\d+)/;class Em{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||T7,this.controller=new self.AbortController,this.stats=new $h}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const s=_7(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=l&&Ye(l)?l:c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},t.timeout),(oc(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(h=>{var f;this.response=this.loader=h;const d=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},c-(d-n.loading.start)),!h.ok){const{status:A,statusText:p}=h;throw new b7(p||"fetch, bad network response",A,h)}n.loading.first=d,n.total=S7(h.headers)||n.total;const m=(f=this.callbacks)==null?void 0:f.onProgress;return m&&Ye(t.highWaterMark)?this.loadProgressively(h,n,e,t.highWaterMark,m):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{var f,d;const m=this.response;if(!m)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const A=h[a];A&&(n.loaded=n.total=A);const p={url:m.url,data:h,code:m.status},g=(f=this.callbacks)==null?void 0:f.onProgress;g&&!Ye(t.highWaterMark)&&g(n,e,h,m),(d=this.callbacks)==null||d.onSuccess(p,n,e,m)}).catch(h=>{var f;if(self.clearTimeout(this.requestTimeout),n.aborted)return;const d=h&&h.code||0,m=h?h.message:null;(f=this.callbacks)==null||f.onError({code:d,text:m},e,h?h.details:null,n)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,n=0,s){const o=new Q4,a=e.body.getReader(),l=()=>a.read().then(c=>{if(c.done)return o.dataLength&&s(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const u=c.value,h=u.length;return t.loaded+=h,h<n||o.dataLength?(o.push(u),o.dataLength>=n&&s(t,i,o.flush().buffer,e)):s(t,i,u.buffer,e),l()}).catch(()=>Promise.reject());return l()}}function _7(r,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(ei({},r.headers))};return r.rangeEnd&&t.headers.set("Range","bytes="+r.rangeStart+"-"+String(r.rangeEnd-1)),t}function x7(r){const e=I7.exec(r);if(e)return parseInt(e[2])-parseInt(e[1])+1}function S7(r){const e=r.get("Content-Range");if(e){const i=x7(e);if(Ye(i))return i}const t=r.get("Content-Length");if(t)return parseInt(t)}function T7(r,e){return new self.Request(r.url,e)}class b7 extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const w7=/^age:\s*[\d.]+\s*$/im;class NA{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new $h,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return s(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),s(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:o}=i.loadPolicy;if(n)for(const a in n)e.setRequestHeader(a,n[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&Ye(s)?s:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,s=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,u=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const m=u??t.response;if(m!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const A=t.responseType==="arraybuffer"?m.byteLength:m.length;i.loaded=i.total=A,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const p=(o=this.callbacks)==null?void 0:o.onProgress;p&&p(i,e,m,t);const g={url:t.responseURL,data:m,code:c};(a=this.callbacks)==null||a.onSuccess(g,i,e,t);return}}const h=s.loadPolicy.errorRetry,f=i.retry,d={url:e.url,data:void 0,code:c};if(Eh(h,f,!1,d))this.retry(h);else{var l;Lt.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Eh(e,t,!0))this.retry(e);else{var i;Lt.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=_A(e,i.retry),i.retry++,Lt.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&w7.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const B7={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},R7=Kt(Kt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:NA,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:S4,bufferController:fC,capLevelController:Jh,errorController:b4,fpsController:EC,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:wA,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,certLoadPolicy:{default:B7},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},D7()),{},{subtitleStreamController:SC,subtitleTrackController:_C,timelineController:PC,audioStreamController:lC,audioTrackController:uC,emeController:ao,cmcdController:gC,contentSteeringController:yC,interstitialsController:YR});function D7(){return{cueHandler:kC,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function M7(r,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Cm(r),n=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return n.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,l=e[a]===void 0,c=[];s.forEach(u=>{const h=`${o}Loading${u}`,f=e[h];if(f!==void 0&&l){c.push(h);const d=i[a].default;switch(e[a]={default:d},u){case"TimeOut":d.maxLoadTimeMs=f,d.maxTimeToFirstByteMs=f;break;case"MaxRetry":d.errorRetry.maxNumRetry=f,d.timeoutRetry.maxNumRetry=f;break;case"RetryDelay":d.errorRetry.retryDelayMs=f,d.timeoutRetry.retryDelayMs=f;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=f,d.timeoutRetry.maxRetryDelayMs=f;break}}}),c.length&&t.warn(`hls.js config: "${c.join('", "')}" setting(s) are deprecated, use "${a}": ${pi(e[a])}`)}),Kt(Kt({},i),e)}function Cm(r){return r&&typeof r=="object"?Array.isArray(r)?r.map(Cm):Object.keys(r).reduce((e,t)=>(e[t]=Cm(r[t]),e),{}):r}function L7(r,e){const t=r.loader;t!==Em&&t!==NA?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),r.progressive=!1):OC()&&(r.loader=Em,r.progressive=!0,r.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const qu=2,P7=.1,F7=.05,k7=100;class O7 extends w4{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(M.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(k7),this.mediaSource=t.mediaSource;const i=this.media=t.media;rr(i,"playing",this.onMediaPlaying),rr(i,"waiting",this.onMediaWaiting),rr(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(Os(i,"playing",this.onMediaPlaying),Os(i,"waiting",this.onMediaWaiting),Os(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,n;const s=(i=this.hls)==null?void 0:i.config;if(!s)return;const{media:o,stalled:a}=this;if(!o)return;const{seeking:l}=o,c=this.seeking&&!l,u=!this.seeking&&l,h=o.paused&&!l||o.ended||o.playbackRate===0;if(this.seeking=l,e!==t){t&&(this.ended=0),this.moved=!0,l||(this.nudgeRetry=0,s.nudgeOnVideoHole&&!h&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(u||c){c&&this.stallResolved(e);return}if(h){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(M.MEDIA_ENDED,{stalled:!1}));return}if(!Tt.getBuffered(o).length){this.nudgeRetry=0;return}const f=Tt.bufferInfo(o,e,0),d=f.nextStart||0,m=this.fragmentTracker;if(l&&m&&this.hls){const _=jy(this.hls.inFlightFragments,e),x=f.len>qu,S=!d||_||d-e>qu&&!m.getPartialFragment(e);if(x||S)return;this.moved=!1}const A=(n=this.hls)==null?void 0:n.latestLevelDetails;if(!this.moved&&this.stalled!==null&&m){if(!(f.len>0)&&!d)return;const x=Math.max(d,f.start||0)-e,b=!!(A!=null&&A.live)?A.targetduration*2:qu,T=m.getPartialFragment(e);if(x>0&&(x<=b||T)){o.paused||this._trySkipBufferHole(T);return}}const p=s.detectStallWithCurrentTimeMs,g=self.performance.now(),v=this.waiting;if(a===null){v>0&&g-v<p?this.stalled=v:this.stalled=g;return}const E=g-a;if(!l&&(E>=p||v)&&this.hls){var C;if(((C=this.mediaSource)==null?void 0:C.readyState)==="ended"&&!(A!=null&&A.live)&&Math.abs(e-(A?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(M.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(f),!this.media||!this.hls)return}const I=Tt.bufferInfo(o,e,s.maxBufferHole);this._tryFixBufferStall(I,E)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(M.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const n=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&n&&n.length>1&&e>n.end(0)){const s=Tt.bufferedInfo(Tt.timeRangesToArray(this.buffered.audio),e,0);if(s.len>1&&t>=s.start){const o=Tt.timeRangesToArray(n),a=Tt.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const l=Tt.bufferedInfo(o,e,0).bufferedIndex,c=o[a].end,u=o[a+1].start;if((l===-1||l>a)&&u-c<1&&e-c<2){const h=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${c} -> ${u} buffered index: ${l}`);this.warn(h.message),this.media.currentTime+=1e-6;const f=this.fragmentTracker.getPartialFragment(e)||void 0,d=Tt.bufferInfo(this.media,e,0);this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:f,buffer:d.len,bufferInfo:d})}}}}}_tryFixBufferStall(e,t){var i,n;const{fragmentTracker:s,media:o}=this,a=(i=this.hls)==null?void 0:i.config;if(!o||!s||!a)return;const l=o.currentTime,c=(n=this.hls)==null?void 0:n.latestLevelDetails,u=s.getPartialFragment(l);if((u||c!=null&&c.live&&l<c.fragmentStart)&&(this._trySkipBufferHole(u)||!this.media))return;const h=e.buffered;(h&&h.length>1&&e.len>a.maxBufferHole||e.nextStart&&e.nextStart-l<a.maxBufferHole)&&(t>a.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}_reportStall(e){const{hls:t,media:i,stallReported:n,stalled:s}=this;if(!n&&s!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${pi(e)})`);this.warn(o.message),t.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:s}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:n}=this,s=(t=this.hls)==null?void 0:t.config;if(!n||!i||!s)return 0;const o=n.currentTime,a=Tt.bufferInfo(n,o,0),l=o<a.start?a.start:a.nextStart;if(l&&this.hls){const u=a.len<=s.maxBufferHole,h=a.len>0&&a.len<1&&n.readyState<3,f=l-o;if(f>0&&(u||h)){if(f>s.maxBufferHole){let m=!1;if(o===0){const A=i.getAppendedFrag(0,it.MAIN);A&&l<A.end&&(m=!0)}if(!m){const A=e||i.getAppendedFrag(o,it.MAIN);if(A){var c;if(!((c=this.hls.loadLevelObj)!=null&&c.details)||jy(this.hls.inFlightFragments,l))return 0;let g=!1,v=A.end;for(;v<l;){const E=i.getPartialFragment(v);if(E)v+=E.duration;else{g=!0;break}}if(g)return 0}}}const d=Math.max(l+F7,o+P7);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${d}`),this.moved=!0,n.currentTime=d,!(e!=null&&e.gap)){const m=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${d}`);this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:m,reason:m.message,frag:e||void 0,buffer:a.len,bufferInfo:a})}return d}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:n}=this,s=t?.config;if(!i||!s)return 0;const o=i.currentTime;if(this.nudgeRetry++,n<s.nudgeMaxRetry){const a=o+(n+1)*s.nudgeOffset,l=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(l.message),i.currentTime=a,t.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_NUDGE_ON_STALL,error:l,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${s.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function jy(r,e){const t=Yy(r.main);if(t&&t.start<=e)return t;const i=Yy(r.audio);return i&&i.start<=e?i:null}function Yy(r){if(!r)return null;switch(r.state){case De.IDLE:case De.STOPPED:case De.ENDED:case De.ERROR:return null}return r.frag}const U7=.25;function Im(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Wy(r,e,t,i,n){let s=new r(e,t,"");try{s.value=i,n&&(s.type=n)}catch{s=new r(e,t,pi(n?Kt({type:n},i):i))}return s}const uu=(()=>{const r=Im();try{r&&new r(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function N7(r){return Uint8Array.from(r.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class G7{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(M.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(M.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(M.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(M.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(M.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&ea(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return CC(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:n}}}=this;if(!i&&!n)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=Im();if(o)for(let a=0;a<s.length;a++){const l=s[a].type;if(l===vn.emsg&&!i||!n)continue;const c=W4(s[a].data);if(c){const u=s[a].pts;let h=u+s[a].duration;h>uu&&(h=uu),h-u<=0&&(h=u+U7);for(let d=0;d<c.length;d++){const m=c[d];if(!q4(m)){this.updateId3CueEnds(u,l);const A=Wy(o,u,h,m,l);A&&this.id3Track.addCue(A)}}}}}updateId3CueEnds(e,t){var i;const n=(i=this.id3Track)==null?void 0:i.cues;if(n)for(let s=n.length;s--;){const o=n[s];o.type===t&&o.startTime<e&&o.endTime===uu&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:n}){const{id3Track:s,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:l}}=o;if(s&&(a||l)){let c;n==="audio"?c=u=>u.type===vn.audioId3&&l:n==="video"?c=u=>u.type===vn.emsg&&a:c=u=>u.type===vn.audioId3&&l||u.type===vn.emsg&&a,gm(s,t,i,c)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:i}=this,{dateRanges:n}=e,s=Object.keys(n);let o=this.dateRangeCuesAppended;if(i&&t){var a;if((a=i.cues)!=null&&a.length){const u=Object.keys(o).filter(h=>!s.includes(h));for(let h=u.length;h--;){const f=u[h],d=o[f].cues;delete o[f],Object.keys(d).forEach(m=>{try{const A=d[m];A.removeEventListener("enter",this.onEventCueEnter),i.removeCue(A)}catch{}})}}else o=this.dateRangeCuesAppended={}}const l=e.fragments[e.fragments.length-1];if(s.length===0||!Ye(l?.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const c=Im();for(let u=0;u<s.length;u++){const h=s[u],f=n[h],d=f.startTime,m=o[h],A=m?.cues||{};let p=m?.durationKnown||!1,g=uu;const{duration:v,endDate:E}=f;if(E&&v!==null)g=d+v,p=!0;else if(f.endOnNext&&!p){const I=s.reduce((_,x)=>{if(x!==f.id){const S=n[x];if(S.class===f.class&&S.startDate>f.startDate&&(!_||f.startDate<_.startDate))return S}return _},null);I&&(g=I.startTime,p=!0)}const C=Object.keys(f.attr);for(let I=0;I<C.length;I++){const _=C[I];if(!B9(_))continue;const x=A[_];if(x)p&&!m.durationKnown?x.endTime=g:Math.abs(x.startTime-d)>.01&&(x.startTime=d,x.endTime=g);else if(c){let S=f.attr[_];R9(_)&&(S=N7(S));const T=Wy(c,d,g,{key:_,data:S},vn.dateRange);T&&(T.id=h,this.id3Track.addCue(T),A[_]=T,this.hls.config.interstitialsController&&(_==="X-ASSET-LIST"||_==="X-ASSET-URL")&&T.addEventListener("enter",this.onEventCueEnter))}}o[h]={cues:A,dateRange:f,durationKnown:p}}}}class Q7{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const n=this.computeLatency();if(n===null)return;this._latency=n;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:o}=this.config;if(!s||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const l=n-a,c=Math.min(this.maxLatency,a+i.targetduration);if(l<c&&l>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,o)),f=Math.round(2/(1+Math.exp(-.75*l-this.edgeStalled))*20)/20,d=Math.min(h,Math.max(1,f));this.changeMediaPlaybackRate(t,d)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:n}=e,{liveSyncDuration:s,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,l=this.hls.userConfig;let c=a&&i||t;(this._targetLatencyUpdated||l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=s!==void 0?s:o*n);const u=n;return c+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,u)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const n=i.edge,s=e-t-this.edgeStalled,o=n-i.totalduration,a=n-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,s),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(M.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(M.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(M.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(M.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===me.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,n;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(n=this.targetLatency)==null?void 0:n.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class z7 extends Xh{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(M.LEVEL_LOADED,this.onLevelLoaded,this),e.on(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(M.FRAG_BUFFERED,this.onFragBuffered,this),e.on(M.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(M.LEVEL_LOADED,this.onLevelLoaded,this),e.off(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(M.FRAG_BUFFERED,this.onFragBuffered,this),e.off(M.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,n=[],s={},o={};let a=!1,l=!1,c=!1;t.levels.forEach(u=>{var h;const f=u.attrs;let{audioCodec:d,videoCodec:m}=u;d&&(u.audioCodec=d=ph(d,i)||void 0),((h=m)==null?void 0:h.indexOf("avc1"))===0&&(m=u.videoCodec=J8(m));const{width:A,height:p,unknownCodecs:g}=u;let v=g?g.length:0;if(g)for(let B=v;B--;){const w=g[B];this.isAudioSupported(w)?(u.audioCodec=d=d?`${d},${w}`:w,v--,pa.audio[d.substring(0,4)]=2):this.isVideoSupported(w)&&(u.videoCodec=m=m?`${m},${w}`:w,v--,pa.video[m.substring(0,4)]=2)}if(a||(a=!!(A&&p)),l||(l=!!m),c||(c=!!d),v||d&&!this.isAudioSupported(d)||m&&!this.isVideoSupported(m)){this.log(`Some or all CODECS not supported "${f.CODECS}"`);return}const{CODECS:E,"FRAME-RATE":C,"HDCP-LEVEL":I,"PATHWAY-ID":_,RESOLUTION:x,"VIDEO-RANGE":S}=f,T=`${`${_||"."}-`}${u.bitrate}-${x}-${C}-${E}-${S}-${I}`;if(s[T])if(s[T].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const B=o[T]+=1;u.attrs["PATHWAY-ID"]=new Array(B+1).join(".");const w=this.createLevel(u);s[T]=w,n.push(w)}else s[T].addGroupId("audio",f.AUDIO),s[T].addGroupId("text",f.SUBTITLES);else{const B=this.createLevel(u);s[T]=B,o[T]=1,n.push(B)}}),this.filterAndSortMediaOptions(n,t,a,l,c)}createLevel(e){const t=new ga(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const n=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(n.message),t.supportedResult=I4(n,[])}return t}isAudioSupported(e){return rm(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return rm(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,n,s){let o=[],a=[],l=e;if((i||n)&&s&&(l=l.filter(({videoCodec:p,videoRange:g,width:v,height:E})=>(!!p||!!(v&&E))&&n9(g))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let p="no level with compatible codecs found in manifest",g=p;t.levels.length&&(g=`one or more CODECS in variant not supported: ${pi(t.levels.map(E=>E.attrs.CODECS).filter((E,C,I)=>I.indexOf(E)===C))}`,this.warn(g),p+=` (${g})`);const v=new Error(p);this.hls.trigger(M.ERROR,{type:nt.MEDIA_ERROR,details:me.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:v,reason:g})}});return}t.audioTracks&&(o=t.audioTracks.filter(p=>!p.audioCodec||this.isAudioSupported(p.audioCodec)),qy(o)),t.subtitles&&(a=t.subtitles,qy(a));const c=l.slice(0);l.sort((p,g)=>{if(p.attrs["HDCP-LEVEL"]!==g.attrs["HDCP-LEVEL"])return(p.attrs["HDCP-LEVEL"]||"")>(g.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&p.height!==g.height)return p.height-g.height;if(p.frameRate!==g.frameRate)return p.frameRate-g.frameRate;if(p.videoRange!==g.videoRange)return gh.indexOf(p.videoRange)-gh.indexOf(g.videoRange);if(p.videoCodec!==g.videoCodec){const v=K1(p.videoCodec),E=K1(g.videoCodec);if(v!==E)return E-v}if(p.uri===g.uri&&p.codecSet!==g.codecSet){const v=Ah(p.codecSet),E=Ah(g.codecSet);if(v!==E)return E-v}return p.averageBitrate!==g.averageBitrate?p.averageBitrate-g.averageBitrate:0});let u=c[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==c.length)){for(let p=0;p<c.length;p++)if(c[p].pathwayId===l[0].pathwayId){u=c[p];break}}this._levels=l;for(let p=0;p<l.length;p++)if(l[p]===u){var h;this._firstLevel=p;const g=u.bitrate,v=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${g}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){const E=Math.min(g,this.hls.config.abrEwmaDefaultEstimateMax);E>v&&v===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=E)}break}const f=s&&!n,d=this.hls.config,m=!!(d.audioStreamController&&d.audioTrackController),A={levels:l,audioTracks:o,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:s,video:n,altAudio:m&&!f&&o.some(p=>!!p.url)};this.hls.trigger(M.MANIFEST_PARSED,A)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,n=this.currentLevel,s=n?n.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&n&&s===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${s?" with Pathway "+s:""}`);const l={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(M.LEVEL_SWITCHING,l);const c=o.details;if(!c||c.live){const u=this.switchParams(o.uri,n?.details,c);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(n=>t.indexOf(n)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===Bt.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===it.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(s=>!!i[s]))return;const n=this._levels[t.level];n!=null&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var i;const{level:n,details:s}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${n}`),(a=t.deliveryDirectives)!=null&&a.skip&&(s.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let l=o.details;l===t.details&&l.advanced&&(l=void 0),this.playlistLoaded(n,t,l)}else(i=t.deliveryDirectives)!=null&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),n=this.currentLevelIndex,s=e.attrs["PATHWAY-ID"],o=e.details,a=o?.age;this.log(`Loading level index ${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${s?" Pathway "+s:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(M.LEVEL_LOADING,{url:i,level:n,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((s,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));U4(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const n=i.length-1;this._firstLevel=Math.min(this._firstLevel,n),this._startLevel&&(this._startLevel=Math.min(this._startLevel,n)),this.hls.trigger(M.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(M.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function qy(r){const e={};r.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function UC(){return self.SourceBuffer||self.WebKitSourceBuffer}function GA(){if(!ur())return!1;const e=UC();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function NC(){if(!GA())return!1;const r=ur();return typeof r?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>r.isTypeSupported(ic(e,"video")))||["mp4a.40.2","fLaC"].some(e=>r.isTypeSupported(ic(e,"audio"))))}function H7(){var r;const e=UC();return typeof(e==null||(r=e.prototype)==null?void 0:r.changeType)=="function"}const V7=100;class K7 extends Wh{constructor(e,t,i){super(e,t,i,"stream-controller",it.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const n=this.media,s=n?n.currentTime:null;if(s===null||!Ye(s)||(this.log(`Media seeked to ${s.toFixed(3)}`),!this.getBufferedFrag(s)))return;const o=this.getFwdBufferInfoAtPos(n,s,it.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${s} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(M.MANIFEST_PARSED,this.onManifestParsed,this),e.on(M.LEVEL_LOADING,this.onLevelLoading,this),e.on(M.LEVEL_LOADED,this.onLevelLoaded,this),e.on(M.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(M.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(M.BUFFER_CREATED,this.onBufferCreated,this),e.on(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(M.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(M.MANIFEST_PARSED,this.onManifestParsed,this),e.off(M.LEVEL_LOADED,this.onLevelLoaded,this),e.off(M.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(M.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(M.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(M.BUFFER_CREATED,this.onBufferCreated,this),e.off(M.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(M.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(M.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:n}=this;if(this.stopLoad(),this.setInterval(V7),this.level=-1,!this.startFragRequested){let s=n.startLevel;s===-1&&(n.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=n.firstAutoLevel),n.nextLoadLevel=s,this.level=n.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=De.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=De.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case De.WAITING_LEVEL:{const{levels:t,level:i}=this,n=t?.[i],s=n?.details;if(s&&(!s.live||this.levelLastLoaded===n&&!this.waitForLive(n))){if(this.waitForCdnTuneIn(s))break;this.state=De.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=De.IDLE;break}break}case De.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,level:s}=this,o=n?.[s];this.resetStartWhenNotLoaded(o||null),this.state=De.IDLE}}break}this.state===De.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:n}=this;if(t===null||!n&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const s=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[s]))return;const o=i[s],a=this.getMainFwdBufferInfo();if(a===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(a,l)){const A={};this.altAudio===2&&(A.type="video"),this.hls.trigger(M.BUFFER_EOS,A),this.state=De.ENDED;return}if(!this.buffering)return;e.loadLevel!==s&&e.manualLevel===-1&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=e.nextLoadLevel=s;const c=o.details;if(!c||this.state===De.WAITING_LEVEL||this.waitForLive(o)){this.level=s,this.state=De.WAITING_LEVEL,this.startFragRequested=!1;return}const u=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(f,c);if(this.couldBacktrack&&!this.fragPrevious&&d&&Yi(d)&&this.fragmentTracker.getState(d)!==Ni.OK){var m;const p=((m=this.backtrackFragment)!=null?m:d).sn-c.startSN,g=c.fragments[p-1];g&&d.cc===g.cc&&(d=g,this.fragmentTracker.removeFragment(g))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,f)){if(!d.gap){const p=this.audioOnly&&!this.altAudio?Zt.AUDIO:Zt.VIDEO,g=(p===Zt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;g&&this.afterBufferFlushed(g,p,it.MAIN)}d=this.getNextFragmentLoopLoading(d,c,a,it.MAIN,h)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,o,f))}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);n===Ni.NOT_LOADED||n===Ni.PARTIAL?Yi(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,it.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);const s=this.getLevelDetails();if(s!=null&&s.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<s.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,l=e[a],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const l=a.maxStartPTS?a.maxStartPTS:a.start,c=a.duration,u=Math.max(o.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case De.KEY_LOADING:case De.FRAG_LOADING:case De.FRAG_LOADING_WAITING_RETRY:case De.PARSING:case De.PARSED:this.state=De.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;rr(i,"playing",this.onMediaPlaying),rr(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(Os(i,"playing",this.onMediaPlaying),Os(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(M.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,n=!1;t.levels.forEach(s=>{const o=s.audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,n=n||o.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&n&&!H7(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==De.IDLE)return;const n=t.levelInfo;(!n.details||n.details.live&&(this.levelLastLoaded!==n||n.details.expired)||this.waitForCdnTuneIn(n.details))&&(this.state=De.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:n,startFragRequested:s}=this,o=t.level,a=t.details,l=a.totalduration;if(!n){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${l}`);const c=t.levelInfo,u=this.fragCurrent;u&&(this.state===De.FRAG_LOADING||this.state===De.FRAG_LOADING_WAITING_RETRY)&&u.level!==t.level&&u.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=c.details)!=null&&i.live){var f;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,c.details,(f=this.levelLastLoaded)==null?void 0:f.details)}if(c.details=a,this.levelLastLoaded=c,s||this.setStartPosition(a,h),this.hls.trigger(M.LEVEL_UPDATED,{details:a,level:o}),this.state===De.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=De.IDLE}s&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const n=this.hls.liveSyncPosition,s=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,l=s>=o-t.maxFragLookUpTolerance&&s<=a;if(n!==null&&i.duration>n&&(s<n||!l)){const c=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!l&&i.readyState<4||s<a-c)&&(this._hasEnoughToStart||(this.nextLoadPosition=n),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${n.toFixed(3)}`),i.currentTime=n))}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const l=a.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=a.videoCodec,u=l.PTSKnown||!l.live,h=(t=i.initSegment)==null?void 0:t.data,f=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new aC(this.hls,it.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=n?n.index:-1,A=m!==-1,p=new Yh(i.level,i.sn,i.stats.chunkCount,s.byteLength,m,A),g=this.initPTS[i.cc];d.push(s,h,f,c,i,n,l.totalduration,u,p,g)}onAudioTrackSwitching(e,t){const i=this.hls,n=this.altAudio===2;if(yh(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(n){this.fragmentTracker.removeAllFragments(),i.once(M.BUFFER_FLUSHED,()=>{var o;(o=this.hls)==null||o.trigger(M.AUDIO_TRACK_SWITCHED,t)}),i.trigger(M.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(M.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=yh(t.url,this.hls);if(i){const n=this.videoBuffer;n&&this.mediaBuffer!==n&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=n)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let n,s,o=!1;for(const a in i){const l=i[a];if(l.id==="main"){if(s=a,n=l,a==="video"){const c=i[a];c&&(this.videoBuffer=c.buffer)}}else o=!0}o&&n?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=n.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:n}=t,s=i.type===it.MAIN;if(s){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===De.PARSED&&(this.state=De.IDLE);return}const a=n?n.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),Yi(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,n)}const o=this.media;o&&(!this._hasEnoughToStart&&Tt.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),s&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=De.ERROR;return}switch(t.details){case me.FRAG_GAP:case me.FRAG_PARSING_ERROR:case me.FRAG_DECRYPT_ERROR:case me.FRAG_LOAD_ERROR:case me.FRAG_LOAD_TIMEOUT:case me.KEY_LOAD_ERROR:case me.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(it.MAIN,t);break;case me.LEVEL_LOAD_ERROR:case me.LEVEL_LOAD_TIMEOUT:case me.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===De.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Bt.LEVEL&&(this.state=De.IDLE);break;case me.BUFFER_ADD_CODEC_ERROR:case me.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.resetLoadingState();break;case me.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case me.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=De.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==Zt.AUDIO||!this.altAudio){const i=(t===Zt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,it.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const n=this.timelineOffset;n&&i&&(i+=n);const s=this.getLevelDetails(),o=Tt.getBuffered(e),a=o.length?o.start(0):0,l=a-i,c=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);l>0&&(l<c||this.loadingParts&&l<2*(s?.partTarget||0))&&(this.log(`adjusting start position by ${l} to match buffer start`),i+=l,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:n}=this,s=i?.frag;if(!s||this.fragContextChanged(s))return;t.fragmentError=0,this.state=De.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=s.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),n.trigger(M.FRAG_LOADED,i),s.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i=this.playlistType,{hls:n}=this,{remuxResult:s,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:c,level:u}=a,{video:h,text:f,id3:d,initSegment:m}=s,{details:A}=u,p=this.altAudio?void 0:s.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=De.PARSING,m){if(m!=null&&m.tracks){const E=l.initSegment||l;this._bufferInitSegment(u,m.tracks,E,o),n.trigger(M.FRAG_PARSING_INIT_SEGMENT,{frag:E,id:i,tracks:m.tracks})}const g=m.initPTS,v=m.timescale;Ye(g)&&(this.initPTS[l.cc]={baseTime:g,timescale:v},n.trigger(M.INIT_PTS_FOUND,{frag:l,id:i,initPTS:g,timescale:v}))}if(h&&A){p&&h.type==="audiovideo"&&this.logMuxedErr(l);const g=A.fragments[l.sn-1-A.startSN],v=l.sn===A.startSN,E=!g||l.cc>g.cc;if(s.independent!==!1){const{startPTS:C,endPTS:I,startDTS:_,endDTS:x}=h;if(c)c.elementaryStreams[h.type]={startPTS:C,endPTS:I,startDTS:_,endDTS:x};else if(h.firstKeyFrame&&h.independent&&o.id===1&&!E&&(this.couldBacktrack=!0),h.dropped&&h.independent){const S=this.getMainFwdBufferInfo(),b=(S?S.end:this.getLoadPosition())+this.config.maxBufferHole,T=h.firstKeyFramePTS?h.firstKeyFramePTS:C;if(!v&&b<T-this.config.maxBufferHole&&!E){this.backtrack(l);return}else E&&(l.gap=!0);l.setElementaryStreamInfo(h.type,l.start,I,l.start,x,!0)}else v&&C-(A.appliedTimelineOffset||0)>qu&&(l.gap=!0);l.setElementaryStreamInfo(h.type,C,I,_,x),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(h,l,c,o,v||E)}else if(v||E)l.gap=!0;else{this.backtrack(l);return}}if(p){const{startPTS:g,endPTS:v,startDTS:E,endDTS:C}=p;c&&(c.elementaryStreams[Zt.AUDIO]={startPTS:g,endPTS:v,startDTS:E,endDTS:C}),l.setElementaryStreamInfo(Zt.AUDIO,g,v,E,C),this.bufferFragmentData(p,l,c,o)}if(A&&d!=null&&(t=d.samples)!=null&&t.length){const g={id:i,frag:l,details:A,samples:d.samples};n.trigger(M.FRAG_PARSING_METADATA,g)}if(A&&f){const g={id:i,frag:l,details:A,samples:f.samples};n.trigger(M.FRAG_PARSING_USERDATA,g)}}logMuxedErr(e){this.warn(`${Yi(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,n){if(this.state!==De.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:s,video:o,audiovideo:a}=t;if(s){let c=Ku(s.codec,e.audioCodec);c==="mp4a"&&(c="mp4a.40.5");const u=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){c&&(c.indexOf("mp4a.40.5")!==-1?c="mp4a.40.2":c="mp4a.40.5");const h=s.metadata;h&&"channelCount"in h&&(h.channelCount||1)!==1&&u.indexOf("firefox")===-1&&(c="mp4a.40.5")}c&&c.indexOf("mp4a.40.5")!==-1&&u.indexOf("android")!==-1&&s.container!=="audio/mpeg"&&(c="mp4a.40.2",this.log(`Android: force audio codec to ${c}`)),e.audioCodec&&e.audioCodec!==c&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${c}"`),s.levelCodec=c,s.id=it.MAIN,this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${c||""}/${e.audioCodec||""}/${s.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=it.MAIN;const c=o.codec;if(c?.length===4)switch(c){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${c}]${o.codec!==c?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const l=Object.keys(t);if(l.length){if(this.hls.trigger(M.BUFFER_CODECS,t),!this.hls)return;l.forEach(c=>{const h=t[c].initSegment;h!=null&&h.byteLength&&this.hls.trigger(M.BUFFER_APPENDING,{type:c,data:h,frag:i,part:null,chunkMeta:n,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,it.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e?.[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=De.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(Tt.isBuffered(e,i)?t=this.getAppendedFrag(i):Tt.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const n=this.fragPlaying,s=t.level;(!n||t.sn!==n.sn||n.level!==s)&&(this.fragPlaying=t,this.hls.trigger(M.FRAG_CHANGED,{frag:t}),(!n||n.level!==s)&&this.hls.trigger(M.LEVEL_SWITCHED,{level:s}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return Ye(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(Ye(t)){const i=this.getLevelDetails(),n=this.currentFrag||(i?co(null,i.fragments,t):null);if(n){const s=n.programDateTime;if(s!==null){const o=s+(t-n.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class $7{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const n=this.keyUriToKeyInfo[i].loader;if(n){var t;if(e&&e!==((t=n.context)==null?void 0:t.frag.type))return;n.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=me.KEY_LOAD_ERROR,i,n,s){return new tr({type:nt.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:i,networkDetails:n})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:n}=e;for(let s=0;s<t.length;s++){const o=t[s];if(n<=o.cc&&(i==="initSegment"||o.sn==="initSegment"||i<o.sn)){this.emeController.selectKeySystemFormat(o).then(a=>{o.setKeyFormat(a)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,n;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const c=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,me.KEY_LOAD_ERROR,c))}const o=s.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,me.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));let a=this.keyUriToKeyInfo[o];if((i=a)!=null&&i.decryptdata.key)return s.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});if((n=a)!=null&&n.keyLoadPromise){var l;switch((l=a.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(c=>(s.key=c.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}}switch(a=this.keyUriToKeyInfo[o]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return s.keyFormat==="identity"?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,me.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const n=this.emeController.loadKey(i);if(n)return(e.keyLoadPromise=n.then(s=>(e.mediaKeySessionContext=s,i))).catch(s=>{throw e.keyLoadPromise=null,s})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,n=i.loader,s=new n(i);return t.keyLoader=e.loader=s,e.keyLoadPromise=new Promise((o,a)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},c=i.keyLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const{frag:p,keyInfo:g,url:v}=m;if(!p.decryptdata||g!==this.keyUriToKeyInfo[v])return a(this.createKeyLoadError(p,me.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),A));g.decryptdata.key=p.decryptdata.key=new Uint8Array(f.data),p.keyLoader=null,g.loader=null,o({frag:p,keyInfo:g})},onError:(f,d,m,A)=>{this.resetLoader(d),a(this.createKeyLoadError(t,me.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),m,Kt({url:l.url,data:void 0},f)))},onTimeout:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,me.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),m))},onAbort:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,me.INTERNAL_ABORTED,new Error("key loading aborted"),m))}};s.load(l,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:n}=e,s=i.loader;t.keyLoader===s&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[n],s&&s.destroy()}}function Xy(r){const{type:e}=r;switch(e){case Bt.AUDIO_TRACK:return it.AUDIO;case Bt.SUBTITLE_TRACK:return it.SUBTITLE;default:return it.MAIN}}function Ud(r,e){let t=r.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class j7{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(M.MANIFEST_LOADING,this.onManifestLoading,this),e.on(M.LEVEL_LOADING,this.onLevelLoading,this),e.on(M.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(M.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(M.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(M.MANIFEST_LOADING,this.onManifestLoading,this),e.off(M.LEVEL_LOADING,this.onLevelLoading,this),e.off(M.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(M.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(M.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,n=t.loader,s=i||n,o=new s(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Bt.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:n,pathwayId:s,url:o,deliveryDirectives:a,levelInfo:l}=t;this.load({id:i,level:n,pathwayId:s,responseType:"text",type:Bt.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:l})}onAudioTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Bt.AUDIO_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Bt.SUBTITLE_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[Bt.LEVEL];if(i){const n=i.context;n&&!t.levels.some(s=>s===n.levelOrTrack)&&(i.abort(),delete this.loaders[Bt.LEVEL])}}load(e){var t;const i=this.hls.config;let n=this.getInternalLoader(e);if(n){const c=this.hls.logger,u=n.context;if(u&&u.levelOrTrack===e.levelOrTrack&&(u.url===e.url||u.deliveryDirectives&&!e.deliveryDirectives)){u.url===e.url?c.log(`[playlist-loader]: ignore ${e.url} ongoing request`):c.log(`[playlist-loader]: ignore ${e.url} in favor of ${u.url}`);return}c.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}let s;if(e.type===Bt.MANIFEST?s=i.manifestLoadPolicy.default:s=ei({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),Ye((t=e.deliveryDirectives)==null?void 0:t.part)){let c;if(e.type===Bt.LEVEL&&e.level!==null?c=this.hls.levels[e.level].details:e.type===Bt.AUDIO_TRACK&&e.id!==null?c=this.hls.audioTracks[e.id].details:e.type===Bt.SUBTITLE_TRACK&&e.id!==null&&(c=this.hls.subtitleTracks[e.id].details),c){const u=c.partTarget,h=c.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;s=ei({},s,{maxTimeToFirstByteMs:Math.min(f,s.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,s.maxTimeToFirstByteMs)})}}}const o=s.errorRetry||s.timeoutRetry||{},a={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},l={onSuccess:(c,u,h,f)=>{const d=this.getInternalLoader(h);this.resetInternalLoader(h.type);const m=c.data;if(m.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(c,h,new Error("no EXTM3U delimiter"),f||null,u);return}u.parsing.start=performance.now(),ps.isMediaPlaylist(m)||h.type!==Bt.MANIFEST?this.handleTrackOrLevelPlaylist(c,u,h,f||null,d):this.handleMasterPlaylist(c,u,h,f)},onError:(c,u,h,f)=>{this.handleNetworkError(u,h,!1,c,f)},onTimeout:(c,u,h)=>{this.handleNetworkError(u,h,!0,void 0,c)}};n.load(e,a,l)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,n){const s=this.hls,o=e.data,a=Ud(e,i),l=ps.parseMasterPlaylist(o,a);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,n,t);return}const{contentSteering:c,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m}=l;this.variableList=m;const{AUDIO:A=[],SUBTITLES:p,"CLOSED-CAPTIONS":g}=ps.parseMasterPlaylistMedia(o,a,l);A.length&&!A.some(E=>!E.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),A.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new mi({}),bitrate:0,url:""})),s.trigger(M.MANIFEST_LOADED,{levels:u,audioTracks:A,subtitles:p,captions:g,contentSteering:c,url:a,stats:t,networkDetails:n,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,n,s){const o=this.hls,{id:a,level:l,type:c}=i,u=Ud(e,i),h=Ye(l)?l:Ye(a)?a:0,f=Xy(i),d=ps.parseLevelPlaylist(e.data,u,h,f,0,this.variableList);if(c===Bt.MANIFEST){const m={attrs:new mi({}),bitrate:0,details:d,name:"",url:u};d.requestScheduled=t.loading.start+F4(d,0),o.trigger(M.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=d,this.handlePlaylistLoaded(d,e,t,i,n,s)}handleManifestParsingError(e,t,i,n,s){this.hls.trigger(M.ERROR,{type:nt.NETWORK_ERROR,details:me.MANIFEST_PARSING_ERROR,fatal:t.type===Bt.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:n,stats:s})}handleNetworkError(e,t,i=!1,n,s){let o=`A network ${i?"timeout":"error"+(n?" (status "+n.code+")":"")} occurred while loading ${e.type}`;e.type===Bt.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===Bt.AUDIO_TRACK||e.type===Bt.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let l=me.UNKNOWN,c=!1;const u=this.getInternalLoader(e);switch(e.type){case Bt.MANIFEST:l=i?me.MANIFEST_LOAD_TIMEOUT:me.MANIFEST_LOAD_ERROR,c=!0;break;case Bt.LEVEL:l=i?me.LEVEL_LOAD_TIMEOUT:me.LEVEL_LOAD_ERROR,c=!1;break;case Bt.AUDIO_TRACK:l=i?me.AUDIO_TRACK_LOAD_TIMEOUT:me.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case Bt.SUBTITLE_TRACK:l=i?me.SUBTITLE_TRACK_LOAD_TIMEOUT:me.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(e.type);const h={type:nt.NETWORK_ERROR,details:l,fatal:c,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:s};if(n){const f=t?.url||e.url;h.response=Kt({url:f,data:void 0},n)}this.hls.trigger(M.ERROR,h)}handlePlaylistLoaded(e,t,i,n,s,o){const a=this.hls,{type:l,level:c,id:u,groupId:h,deliveryDirectives:f}=n,d=Ud(t,n),m=Xy(n),A=typeof n.level=="number"&&m===it.MAIN?c:void 0;if(!e.fragments.length){const g=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(M.ERROR,{type:nt.NETWORK_ERROR,details:me.LEVEL_EMPTY_ERROR,fatal:!1,url:d,error:g,reason:g.message,response:t,context:n,level:A,parent:m,networkDetails:s,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const p=e.playlistParsingError;if(p){if(this.hls.logger.warn(p),!a.config.ignorePlaylistParsingErrors){a.trigger(M.ERROR,{type:nt.NETWORK_ERROR,details:me.LEVEL_PARSING_ERROR,fatal:!1,url:d,error:p,reason:p.message,response:t,context:n,level:A,parent:m,networkDetails:s,stats:i});return}e.playlistParsingError=null}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case Bt.MANIFEST:case Bt.LEVEL:a.trigger(M.LEVEL_LOADED,{details:e,levelInfo:n.levelOrTrack||a.levels[0],level:A||0,id:u||0,stats:i,networkDetails:s,deliveryDirectives:f,withoutMultiVariant:l===Bt.MANIFEST});break;case Bt.AUDIO_TRACK:a.trigger(M.AUDIO_TRACK_LOADED,{details:e,track:n.levelOrTrack,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break;case Bt.SUBTITLE_TRACK:a.trigger(M.SUBTITLE_TRACK_LOADED,{details:e,track:n.levelOrTrack,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break}}}class sr{static get version(){return sc}static isMSESupported(){return GA()}static isSupported(){return NC()}static getMediaSource(){return ur()}static get Events(){return M}static get MetadataSchema(){return vn}static get ErrorTypes(){return nt}static get ErrorDetails(){return me}static get DefaultConfig(){return sr.defaultConfig?sr.defaultConfig:R7}static set DefaultConfig(e){sr.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new BA,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=w8(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=M7(sr.DefaultConfig,e,t);this.userConfig=e,i.progressive&&L7(i,t);const{abrController:n,bufferController:s,capLevelController:o,errorController:a,fpsController:l}=i,c=new a(this),u=this.abrController=new n(this),h=new g9(this),f=i.interstitialsController,d=f?this.interstitialsController=new f(this,sr):null,m=this.bufferController=new s(this,h),A=this.capLevelController=new o(this),p=new l(this),g=new j7(this),v=i.contentSteeringController,E=v?new v(this):null,C=this.levelController=new z7(this,E),I=new G7(this),_=new $7(this.config),x=this.streamController=new K7(this,h,_),S=this.gapController=new O7(this,h);A.setStreamController(x),p.setStreamController(x);const b=[g,C,x];d&&b.splice(1,0,d),E&&b.splice(1,0,E),this.networkControllers=b;const T=[u,m,S,A,p,I,h];this.audioTrackController=this.createController(i.audioTrackController,b);const B=i.audioStreamController;B&&b.push(this.audioStreamController=new B(this,h,_)),this.subtitleTrackController=this.createController(i.subtitleTrackController,b);const w=i.subtitleStreamController;w&&b.push(this.subtititleStreamController=new w(this,h,_)),this.createController(i.timelineController,T),_.emeController=this.emeController=this.createController(i.emeController,T),this.cmcdController=this.createController(i.cmcdController,T),this.latencyController=this.createController(Q7,T),this.coreComponents=T,b.push(c);const R=c.onErrorOut;typeof R=="function"&&this.on(M.ERROR,R,c),this.on(M.MANIFEST_LOADED,g.onManifestLoaded,g)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,n){this._emitter.off(e,t,i,n)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const n=e===M.ERROR;this.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.INTERNAL_EXCEPTION,fatal:n,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(M.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const s=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(M.ERROR,{type:nt.OTHER_ERROR,details:me.ATTACH_MEDIA_ERROR,fatal:!0,error:s});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,n=t?e:{media:i};this._media=i,this.trigger(M.MEDIA_ATTACHING,n)}detachMedia(){this.logger.log("detachMedia"),this.trigger(M.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(M.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,n=this._url=vA.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${n}`),t&&i&&(i!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(M.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[it.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[it.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[it.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e?.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=mB()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){i9(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let n=0;n<i;n++)if(e[n].maxBitrate>=t)return n;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let n;if(t===-1&&e!=null&&e.length?n=e.length-1:n=t,i)for(let s=n;s--;){const o=e[s].attrs["HDCP-LEVEL"];if(o&&o<=i)return s}return n}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=x4(t);return _4(e,i,navigator.mediaCapabilities)}}sr.defaultConfig=void 0;const Y7=Object.freeze(Object.defineProperty({__proto__:null,AbrController:S4,AttrList:mi,AudioStreamController:lC,AudioTrackController:uC,BasePlaylistController:Xh,BaseSegment:EA,BaseStreamController:Wh,BufferController:fC,CMCDController:gC,CapLevelController:Jh,ChunkMetadata:Yh,ContentSteeringController:yC,Cues:kC,DateRange:SA,EMEController:ao,ErrorActionFlags:Vn,ErrorController:b4,ErrorDetails:me,ErrorTypes:nt,Events:M,FPSController:EC,FetchLoader:Em,Fragment:Vu,Hls:sr,HlsSkip:Nl,HlsUrlParameters:am,KeySystemFormats:ln,KeySystems:Ht,Level:ga,LevelDetails:R4,LevelKey:ya,LoadStats:$h,M3U8Parser:ps,MetadataSchema:vn,NetworkErrorAction:Ki,Part:c4,PlaylistLevelType:it,SubtitleStreamController:SC,SubtitleTrackController:_C,TimelineController:PC,XhrLoader:NA,default:sr,fetchSupported:OC,getMediaSource:ur,isMSESupported:GA,isSupported:NC,requestMediaKeySystemAccess:wA},Symbol.toStringTag,{value:"Module"})),W7=((r,e)=>typeof window<"u"&&typeof((r=window.document)==null?void 0:r.createElement)=="function"&&typeof((e=window.navigator)==null?void 0:e.userAgent)=="string")();let Nd=null;async function q7(...r){var e;(e=Nd)!==null&&e!==void 0||(Nd=await W2(()=>Promise.resolve().then(()=>Y7),void 0));const t=Nd.default;return t.isSupported()?new t(...r):null}function X7(r,{unsuspend:e="loadedmetadata",start:t=!0,hls:i={},crossOrigin:n="anonymous",muted:s=!0,loop:o=!0,playsInline:a=!0,onVideoFrame:l,...c}={}){const u=de(m=>m.gl),h=y.useRef(null),f=fr(()=>new Promise(async m=>{let A,p;typeof r=="string"?A=r:p=r;const g=Object.assign(document.createElement("video"),{src:A,srcObject:p,crossOrigin:n,loop:o,muted:s,playsInline:a,...c});if(A&&W7&&A.endsWith(".m3u8")){const E=h.current=await q7(i);E&&(E.on(M.MEDIA_ATTACHED,()=>void E.loadSource(A)),E.attachMedia(g))}const v=new C_(g);"colorSpace"in v?v.colorSpace=u.outputColorSpace:v.encoding=u.outputEncoding,g.addEventListener(e,()=>m(v))}),[r]),d=f.source.data;return J7(d,l),y.useEffect(()=>(t&&f.image.play(),()=>{h.current&&(h.current.destroy(),h.current=null)}),[f,t]),f}const QA=y.forwardRef(({children:r,src:e,...t},i)=>{const n=X7(e,t);return y.useEffect(()=>()=>void n.dispose(),[n]),y.useImperativeHandle(i,()=>n,[n]),y.createElement(y.Fragment,null,r?.(n))}),J7=(r,e)=>{y.useEffect(()=>{if(!e||!r.requestVideoFrameCallback)return;let t;const i=(...n)=>{e(...n),t=r.requestVideoFrameCallback(i)};return r.requestVideoFrameCallback(i),()=>r.cancelVideoFrameCallback(t)},[r,e])},Xu=(r,e)=>{if(Array.isArray(r))return r[0];{const t=e??Object.keys(r)[0];return r[t][0]}},Z7=r=>{for(let e=3;e<r.length;e+=4)if(r[e]!==0)return!1;return!0};function zA(r,e,t,i,n,s){const o=y.useRef(de(w=>w.viewport)),a=y.useRef(null),l=y.useRef(0),c=.1,u=y.useRef(r),h=y.useRef(e),f=y.useRef(t),[d,m]=y.useState(null),[A,p]=y.useState(new tn),g=y.useMemo(()=>new lr,[]),[v,E]=y.useState(null),C=y.useCallback((w,R,D)=>{const G=R*(o.current.aspect>w/R?o.current.width/w:o.current.height/R),W=w*(o.current.aspect>w/R?o.current.width/w:o.current.height/R)*D,q=G*D,F=1;let N=Math.min(F,W),L=Math.min(F,q);return W>F&&(N=F,L=q/W*F),new K(N,L,1)},[]),I=y.useCallback((w,R)=>{if(w.image){const D=document.createElement("canvas"),G=D.getContext("2d",s);if(!G)throw new Error("Failed to get 2d context");D.width=w.image.width,D.height=w.image.height,G.drawImage(w.image,0,0);const z=w.image.width,W=w.image.height,q=Math.round(Math.sqrt(R*(z/W))),F=Math.round(R/q),N=z/q,L=W/F,$=[];for(let j=0;j<F;j++)for(let V=0;V<q;V++){if(j*q+V>=R){$.push({row:j,col:V});continue}const Q=G.getImageData(V*N,j*L,N,L).data;Z7(Q)&&$.push({row:j,col:V})}return{rows:F,columns:q,frameWidth:N,frameHeight:L,emptyFrames:$}}else return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}},[s]),_=y.useCallback(w=>{const R=D=>{let G=null;for(const W of D){const{w:q,h:F}=W.frame,N=q*F;(!G||N>G.area)&&(G={w:q,h:F,area:N})}return D.map(W=>{const{w:q,h:F}=W.frame,N=q*F,L=G?N===G.area?1:Math.sqrt(N/G.area):1;return{...W,scaleRatio:L}})};if(Array.isArray(w))return R(w);{const D={};for(const G in w)D[G]=R(w[G]);return D}},[]),x=y.useCallback(()=>{const w={},R=a.current,D=f.current;if(R)if(D&&Array.isArray(R.frames)){for(let G=0;G<D.length;G++){w[D[G]]=[];for(const z of R.frames){const W=z.frame,q=z.sourceSize.w,F=z.sourceSize.h;typeof z.filename=="string"&&z.filename.toLowerCase().indexOf(D[G].toLowerCase())!==-1&&w[D[G]].push({...z,frame:W,sourceSize:{w:q,h:F}})}}for(const G in w){const z=_(w[G]);Array.isArray(z)&&(w[G]=z)}return w}else if(D&&typeof R.frames=="object"){for(let G=0;G<D.length;G++){w[D[G]]=[];for(const z in R.frames){const W=R.frames[z],q=W.frame,F=W.sourceSize.w,N=W.sourceSize.h;typeof z=="string"&&z.toLowerCase().indexOf(D[G].toLowerCase())!==-1&&w[D[G]].push({...W,frame:q,sourceSize:{w:F,h:N}})}}for(const G in w){const z=_(w[G]);Array.isArray(z)&&(w[G]=z)}return w}else{let G=[];return R!=null&&R.frames&&(Array.isArray(R.frames)?G=R.frames.map(z=>({...z,x:z.frame.x,y:z.frame.y,w:z.frame.w,h:z.frame.h})):G=Object.values(R.frames).flat().map(z=>({...z,x:z.frame.x,y:z.frame.y,w:z.frame.w,h:z.frame.h}))),_(G)}return[]},[_,a]),S=y.useCallback((w,R)=>{let D=new K(1,1,1);if(w===null){if(R&&i){const G=R.image.width,z=R.image.height;l.current=i;const{rows:W,columns:q,frameWidth:F,frameHeight:N,emptyFrames:L}=I(R,i),$={frames:[],meta:{version:"1.0",size:{w:G,h:z},rows:W,columns:q,frameWidth:F,frameHeight:N,scale:"1"}};for(let j=0;j<W;j++)for(let V=0;V<q;V++)(L??[]).some(Q=>Q.row===j&&Q.col===V)||Array.isArray($.frames)&&$.frames.push({frame:{x:V*F,y:j*N,w:F,h:N},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:F,h:N},sourceSize:{w:F,h:N}});D=C(F,N,c),a.current=$}a.current&&a.current.frames&&(a.current.frames=_(a.current.frames))}else if(R){a.current=w,a.current.frames=x(),l.current=Array.isArray(w.frames)?w.frames.length:Object.keys(w.frames).length;const{w:G,h:z}=Xu(w.frames).sourceSize;D=C(G,z,c)}m(a.current),"encoding"in R?R.encoding=3001:"colorSpace"in R&&(R.colorSpace=q2),p(R),E({spriteTexture:R,spriteData:a.current,aspect:D})},[I,i,x,C,_]),b=y.useCallback((w,R,D)=>{const G=fetch(w).then(W=>W.json()),z=new Promise(W=>{g.load(R,W)});Promise.all([G,z]).then(W=>{D(W[0],W[1])})},[g]),T=y.useCallback(w=>{if(!w&&!u.current)throw new Error("Either textureUrl or input must be provided");const R=w??u.current;if(!R)throw new Error("A valid texture URL must be provided");g.load(R,D=>S(null,D))},[g,S]),B=y.useCallback((w,R)=>{R&&w?b(R,w,S):T(w)},[b,T,S]);return y.useLayoutEffect(()=>{h.current&&u.current?b(h.current,u.current,S):u.current&&T();const w=u.current;return()=>{w&&gi.clear(lr,w)}},[b,T,S]),y.useLayoutEffect(()=>{n?.(A,d??null)},[A,d,n]),{spriteObj:v,loadJsonAndTexture:B}}zA.preload=r=>gi.preload(lr,r);zA.clear=r=>gi.clear(lr,r);function GC(r,e,...t){const i=y.useRef(),n=de(s=>s.scene);return y.useLayoutEffect(()=>{let s;if(r&&r!=null&&r.current&&e&&(i.current=s=new e(r.current,...t)),s)return s.traverse(o=>o.raycast=()=>null),n.add(s),()=>{i.current=void 0,n.remove(s),s.dispose==null||s.dispose()}},[n,e,r,...t]),We(()=>{var s;return void((s=i.current)==null||s.update==null?void 0:s.update())}),i}const yk=({type:r,args:e=[]})=>{const t=y.useRef(null),i=y.useRef(null);return y.useLayoutEffect(()=>{i.current=t.current.parent}),GC(i,r,...e),y.createElement("object3D",{ref:t})};var Ju={exports:{}},eD=Ju.exports,Jy;function tD(){return Jy||(Jy=1,function(r,e){(function(t,i){r.exports=i()})(eD,function(){var t=function(){function i(d){return o.appendChild(d.dom),d}function n(d){for(var m=0;m<o.children.length;m++)o.children[m].style.display=m===d?"block":"none";s=d}var s=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(d){d.preventDefault(),n(++s%o.children.length)},!1);var a=(performance||Date).now(),l=a,c=0,u=i(new t.Panel("FPS","#0ff","#002")),h=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:o,addPanel:i,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){c++;var d=(performance||Date).now();if(h.update(d-a,200),d>l+1e3&&(u.update(1e3*c/(d-l),100),l=d,c=0,f)){var m=performance.memory;f.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return d},update:function(){a=this.end()},domElement:o,setMode:n}};return t.Panel=function(i,n,s){var o=1/0,a=0,l=Math.round,c=l(window.devicePixelRatio||1),u=80*c,h=48*c,f=3*c,d=2*c,m=3*c,A=15*c,p=74*c,g=30*c,v=document.createElement("canvas");v.width=u,v.height=h,v.style.cssText="width:80px;height:48px";var E=v.getContext("2d");return E.font="bold "+9*c+"px Helvetica,Arial,sans-serif",E.textBaseline="top",E.fillStyle=s,E.fillRect(0,0,u,h),E.fillStyle=n,E.fillText(i,f,d),E.fillRect(m,A,p,g),E.fillStyle=s,E.globalAlpha=.9,E.fillRect(m,A,p,g),{dom:v,update:function(C,I){o=Math.min(o,C),a=Math.max(a,C),E.fillStyle=s,E.globalAlpha=1,E.fillRect(0,0,u,A),E.fillStyle=n,E.fillText(l(C)+" "+i+" ("+l(o)+"-"+l(a)+")",f,d),E.drawImage(v,m+c,A,p-c,g,m,A,p-c,g),E.fillRect(m+p-c,A,c,g),E.fillStyle=s,E.globalAlpha=.9,E.fillRect(m+p-c,A,c,l((1-C/I)*g))}}},t})}(Ju)),Ju.exports}var iD=tD();const nD=Qm(iD);function sD(r,e=[],t){const[i,n]=y.useState();return y.useLayoutEffect(()=>{const s=r();return n(s),()=>void 0},e),i}function vk({showPanel:r=0,className:e,parent:t}){const i=sD(()=>new nD,[]);return y.useEffect(()=>{if(i){const n=t&&t.current||document.body;i.showPanel(r),n?.appendChild(i.dom);const s=(e??"").split(" ").filter(l=>l);s.length&&i.dom.classList.add(...s);const o=Mm(()=>i.begin()),a=zm(()=>i.end());return()=>{s.length&&i.dom.classList.remove(...s),n?.removeChild(i.dom),o(),a()}}},[t,i,e,r]),null}class rD{constructor(e,t,i){this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i,n,s=0){if(!this.context||!this.gradient)return;const o=Math.min(1/0,e),a=Math.max(i,e);n=Math.max(n,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(s)} ${this.name} (${o.toFixed(s)}-${parseFloat(a.toFixed(s))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const l=this.GRAPH_HEIGHT-(1-t/n)*this.GRAPH_HEIGHT;l>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-l,this.PR,l))}}const QC=class Wo{constructor({trackGPU:e=!1,logsPerSecond:t=30,samplesLog:i=60,samplesGraph:n=10,precision:s=2,minimal:o=!1,horizontal:a=!0,mode:l=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=c=>{c.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=l,this.horizontal=a,this.minimal=o,this.trackGPU=e,this.samplesLog=i,this.samplesGraph=n,this.precision=s,this.logsPerSecond=t,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new Wo.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new Wo.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e)}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){return e.isWebGPURenderer?(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0):!1}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new Wo.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new Wo.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new Wo.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,this.totalCpuDuration===0&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((e,t)=>{if(this.gl){const i=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!n){const o=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=o,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}}))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const i=Math.round(this.frames*1e3/t);this.addToAverage(i,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,i){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const n=performance.measure(i,e,t);this.totalCpuDuration+=n.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,i=2){if(t.logs.length>0){let n=0,s=.01;for(let l=0;l<t.logs.length;l++)n+=t.logs[l],t.logs[l]>s&&(s=t.logs[l]);let o=0,a=.01;for(let l=0;l<t.graph.length;l++)o+=t.graph[l],t.graph[l]>a&&(a=t.graph[l]);e&&e.update(n/Math.min(t.logs.length,this.samplesLog),o/Math.min(t.graph.length,this.samplesGraph),s,a,i)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(n,s){i.begin(),t.call(this,n,s),i.end()},this.threeRendererPatched=!0}};QC.Panel=rD;let oD=QC;const Ek=y.forwardRef(function({className:e,parent:t,id:i,clearStatsGlStyle:n,...s},o){const a=de(c=>c.gl),l=y.useMemo(()=>{const c=new oD({...s});return c.init(a),c},[a]);return y.useImperativeHandle(o,()=>l.domElement,[l]),y.useEffect(()=>{if(l){const c=t&&t.current||document.body;c?.appendChild(l.domElement),l.domElement.querySelectorAll("canvas").forEach(f=>{f.style.removeProperty("position")}),i&&(l.domElement.id=i),n&&l.domElement.removeAttribute("style"),l.domElement.removeAttribute("style");const u=(e??"").split(" ").filter(f=>f);u.length&&l.domElement.classList.add(...u);const h=zm(()=>l.update());return()=>{u.length&&l.domElement.classList.remove(...u),c?.removeChild(l.domElement),h()}}},[t,l,e,i,n]),null});function Ck({size:r=256,frames:e=1/0}={}){const t=de(u=>u.viewport.dpr),{width:i,height:n}=de(u=>u.size),s=r||i*t,o=r||n*t,a=y.useMemo(()=>{const u=new Rh(s,o);return u.format=Hm,u.type=Mh,{depthTexture:u}},[s,o]);let l=0;const c=En(s,o,a);return We(u=>{(e===1/0||l<e)&&(u.gl.setRenderTarget(c),u.gl.render(u.scene,u.camera),u.gl.setRenderTarget(null),l++)}),c.depthTexture}function Ik(r,e,t=1){const i=de(o=>o.viewport),n=e*(i.aspect>r/e?i.width/r:i.height/e);return[r*(i.aspect>r/e?i.width/r:i.height/e)*t,n*t,1]}function _k(r,e){const t=de(n=>n.pointer),[i]=y.useState(()=>{const n=new Th;return e&&wn(n,e,{}),function(s,o){n.setFromCamera(t,r instanceof X2?r:r.current);const a=this.constructor.prototype.raycast.bind(this);a&&a(n,o)}});return i}function Gd(r,e,t,i){return new(t||(t=Promise))(function(n,s){function o(c){try{l(i.next(c))}catch(u){s(u)}}function a(c){try{l(i.throw(c))}catch(u){s(u)}}function l(c){var u;c.done?n(c.value):(u=c.value,u instanceof t?u:new t(function(h){h(u)})).then(o,a)}l((i=i.apply(r,[])).next())})}const aD=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function Zy(r){return r=r.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const zC=typeof window>"u",ws=(()=>{if(zC)return;const{userAgent:r,platform:e,maxTouchPoints:t}=window.navigator,i=/(iphone|ipod|ipad)/i.test(r),n=e==="iPad"||e==="MacIntel"&&t>0&&!window.MSStream;return{isIpad:n,isMobile:/android/i.test(r)||i||n,isSafari12:/Version\/12.+Safari/.test(r),isFirefox:/Firefox/.test(r)}})();function lD(r,e,t){if(!t)return[e];const i=function(c){const u=`
    precision highp float;
    attribute vec3 aPosition;
    varying float vvv;
    void main() {
      vvv = 0.31622776601683794;
      gl_Position = vec4(aPosition, 1.0);
    }
  `,h=`
    precision highp float;
    varying float vvv;
    void main() {
      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;
      enc = fract(enc);
      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
      gl_FragColor = enc;
    }
  `,f=c.createShader(35633),d=c.createShader(35632),m=c.createProgram();if(!(d&&f&&m))return;c.shaderSource(f,u),c.shaderSource(d,h),c.compileShader(f),c.compileShader(d),c.attachShader(m,f),c.attachShader(m,d),c.linkProgram(m),c.detachShader(m,f),c.detachShader(m,d),c.deleteShader(f),c.deleteShader(d),c.useProgram(m);const A=c.createBuffer();c.bindBuffer(34962,A),c.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const p=c.getAttribLocation(m,"aPosition");c.vertexAttribPointer(p,3,5126,!1,0,0),c.enableVertexAttribArray(p),c.clearColor(1,1,1,1),c.clear(16384),c.viewport(0,0,1,1),c.drawArrays(4,0,3);const g=new Uint8Array(4);return c.readPixels(0,0,1,1,6408,5121,g),c.deleteProgram(m),c.deleteBuffer(A),g.join("")}(r),n="801621810",s="8016218135",o="80162181161",a=ws?.isIpad?[["a7",o,12],["a8",s,15],["a8x",s,15],["a9",s,15],["a9x",s,15],["a10",s,15],["a10x",s,15],["a12",n,15],["a12x",n,15],["a12z",n,15],["a14",n,15],["a15",n,15],["m1",n,15],["m2",n,15]]:[["a7",o,12],["a8",s,12],["a9",s,15],["a10",s,15],["a11",n,15],["a12",n,15],["a13",n,15],["a14",n,15],["a15",n,15],["a16",n,15],["a17",n,15]];let l;return i==="80162181255"?l=a.filter(([,,c])=>c>=14):(l=a.filter(([,c])=>c===i),l.length||(l=a)),l.map(([c])=>`apple ${c} gpu`)}let ev=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}};const Qd=[],tv=[];function cD(r,e){if(r===e)return 0;const t=r;r.length>e.length&&(r=e,e=t);let i=r.length,n=e.length;for(;i>0&&r.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let s,o=0;for(;o<i&&r.charCodeAt(o)===e.charCodeAt(o);)o++;if(i-=o,n-=o,i===0)return n;let a,l,c=0,u=0,h=0;for(;u<i;)tv[u]=r.charCodeAt(o+u),Qd[u]=++u;for(;h<n;)for(s=e.charCodeAt(o+h),a=h++,c=h,u=0;u<i;u++)l=s===tv[u]?a:a+1,a=Qd[u],c=Qd[u]=a>c?l>c?c+1:l:l>a?a+1:l;return c}function uD(r){return r!=null}const hD=({mobileTiers:r=[0,15,30,60],desktopTiers:e=[0,15,30,60],override:t={},glContext:i,failIfMajorPerformanceCaveat:n=!1,benchmarksURL:s="https://unpkg.com/detect-gpu@5.0.70/dist/benchmarks"}={})=>Gd(void 0,void 0,void 0,function*(){const o={};if(zC)return{tier:0,type:"SSR"};const{isIpad:a=!!ws?.isIpad,isMobile:l=!!ws?.isMobile,screenSize:c=window.screen,loadBenchmarks:u=I=>Gd(void 0,void 0,void 0,function*(){const _=yield fetch(`${s}/${I}`).then(x=>x.json());if(parseInt(_.shift().split(".")[0],10)<4)throw new ev("Detect GPU benchmark data is out of date. Please update to version 4x");return _})}=t;let{renderer:h}=t;const f=(I,_,x,S,b)=>({device:b,fps:S,gpu:x,isMobile:l,tier:I,type:_});let d,m="";if(h)h=Zy(h),d=[h];else{const I=i||function(x,S=!1){const b={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:S,powerPreference:"high-performance",stencil:!1};x&&delete b.powerPreference;const T=window.document.createElement("canvas"),B=T.getContext("webgl",b)||T.getContext("experimental-webgl",b);return B??void 0}(ws?.isSafari12,n);if(!I)return f(0,"WEBGL_UNSUPPORTED");const _=ws?.isFirefox?null:I.getExtension("WEBGL_debug_renderer_info");if(h=_?I.getParameter(_.UNMASKED_RENDERER_WEBGL):I.getParameter(I.RENDERER),!h)return f(1,"FALLBACK");m=h,h=Zy(h),d=function(x,S,b){return S==="apple gpu"?lD(x,S,b):[S]}(I,h,l)}const A=(yield Promise.all(d.map(function(I){var _;return Gd(this,void 0,void 0,function*(){const x=(j=>{const V=l?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const k of V)if(j.includes(k))return k})(I);if(!x)return;const S=`${l?"m":"d"}-${x}${a?"-ipad":""}.json`,b=o[S]=(_=o[S])!==null&&_!==void 0?_:u(S);let T;try{T=yield b}catch(j){if(j instanceof ev)throw j;return}const B=function(j){var V;const k=(j=j.replace(/\([^)]+\)/,"")).match(/\d+/)||j.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return(V=k?.join("").replace(/\W|amd/g,""))!==null&&V!==void 0?V:""}(I);let w=T.filter(([,j])=>j===B);w.length||(w=T.filter(([j])=>j.includes(I)));const R=w.length;if(R===0)return;const D=I.split(/[.,()\[\]/\s]/g).sort().filter((j,V,k)=>V===0||j!==k[V-1]).join(" ");let G,[z,,,,W]=R>1?w.map(j=>[j,cD(D,j[2])]).sort(([,j],[,V])=>j-V)[0][0]:w[0],q=Number.MAX_VALUE;const{devicePixelRatio:F}=window,N=c.width*F*c.height*F;for(const j of W){const[V,k]=j,Q=V*k,O=Math.abs(N-Q);O<q&&(q=O,G=j)}if(!G)return;const[,,L,$]=G;return[q,L,z,$]})}))).filter(uD).sort(([I=Number.MAX_VALUE,_],[x=Number.MAX_VALUE,S])=>I===x?_-S:I-x);if(!A.length){const I=aD.find(_=>h.includes(_));return I?f(0,"BLOCKLISTED",I):f(1,"FALLBACK",`${h} (${m})`)}const[,p,g,v]=A[0];if(p===-1)return f(0,"BLOCKLISTED",g,p,v);const E=l?r:e;let C=0;for(let I=0;I<E.length;I++)p>=E[I]&&(C=I);return f(C,"BENCHMARK",g,p,v)}),fD=r=>fr(()=>hD(r),["useDetectGPU"]);function Sk({children:r,...e}){const t=fD(e);return y.createElement(y.Fragment,null,r?.(t))}const HC=0,dD=1,Zh=2,iv=2,zd=1.25,nv=1,Lr=6*4+4+4,ef=65535,mD=Math.pow(2,-24),Hd=Symbol("SKIP_GENERATION");function VC(r){return r.index?r.index.count:r.attributes.position.count}function xa(r){return VC(r)/3}function KC(r,e=ArrayBuffer){return r>65535?new Uint32Array(new e(4*r)):new Uint16Array(new e(2*r))}function AD(r,e){if(!r.index){const t=r.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=KC(t,i);r.setIndex(new Jt(n,1));for(let s=0;s<t;s++)n[s]=s}}function $C(r,e){const t=xa(r),i=e||r.drawRange,n=i.start/3,s=(i.start+i.count)/3,o=Math.max(0,n),a=Math.min(t,s)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function jC(r,e){if(!r.groups||!r.groups.length)return $C(r,e);const t=[],i=new Set,n=e||r.drawRange,s=n.start/3,o=(n.start+n.count)/3;for(const l of r.groups){const c=l.start/3,u=(l.start+l.count)/3;i.add(Math.max(s,c)),i.add(Math.min(o,u))}const a=Array.from(i.values()).sort((l,c)=>l-c);for(let l=0;l<a.length-1;l++){const c=a[l],u=a[l+1];t.push({offset:Math.floor(c),count:Math.floor(u-c)})}return t}function pD(r,e){const t=xa(r),i=jC(r,e).sort((o,a)=>o.offset-a.offset),n=i[i.length-1];n.count=Math.min(t-n.offset,n.count);let s=0;return i.forEach(({count:o})=>s+=o),t!==s}function Vd(r,e,t,i,n){let s=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,u=-1/0,h=1/0,f=1/0,d=1/0,m=-1/0,A=-1/0,p=-1/0;for(let g=e*6,v=(e+t)*6;g<v;g+=6){const E=r[g+0],C=r[g+1],I=E-C,_=E+C;I<s&&(s=I),_>l&&(l=_),E<h&&(h=E),E>m&&(m=E);const x=r[g+2],S=r[g+3],b=x-S,T=x+S;b<o&&(o=b),T>c&&(c=T),x<f&&(f=x),x>A&&(A=x);const B=r[g+4],w=r[g+5],R=B-w,D=B+w;R<a&&(a=R),D>u&&(u=D),B<d&&(d=B),B>p&&(p=B)}i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=c,i[5]=u,n[0]=h,n[1]=f,n[2]=d,n[3]=m,n[4]=A,n[5]=p}function gD(r,e=null,t=null,i=null){const n=r.attributes.position,s=r.index?r.index.array:null,o=xa(r),a=n.normalized;let l;e===null?(l=new Float32Array(o*6*4),t=0,i=o):(l=e,t=t||0,i=i||o);const c=n.array,u=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const f=["getX","getY","getZ"];for(let d=t;d<t+i;d++){const m=d*3,A=d*6;let p=m+0,g=m+1,v=m+2;s&&(p=s[p],g=s[g],v=s[v]),a||(p=p*h+u,g=g*h+u,v=v*h+u);for(let E=0;E<3;E++){let C,I,_;a?(C=n[f[E]](p),I=n[f[E]](g),_=n[f[E]](v)):(C=c[p+E],I=c[g+E],_=c[v+E]);let x=C;I<x&&(x=I),_<x&&(x=_);let S=C;I>S&&(S=I),_>S&&(S=_);const b=(S-x)/2,T=E*2;l[A+T+0]=x+b,l[A+T+1]=b+(Math.abs(x)+b)*mD}}return l}function Ii(r,e,t){return t.min.x=e[r],t.min.y=e[r+1],t.min.z=e[r+2],t.max.x=e[r+3],t.max.y=e[r+4],t.max.z=e[r+5],t}function sv(r){let e=-1,t=-1/0;for(let i=0;i<3;i++){const n=r[i+3]-r[i];n>t&&(t=n,e=i)}return e}function rv(r,e){e.set(r)}function ov(r,e,t){let i,n;for(let s=0;s<3;s++){const o=s+3;i=r[s],n=e[s],t[s]=i<n?i:n,i=r[o],n=e[o],t[o]=i>n?i:n}}function hu(r,e,t){for(let i=0;i<3;i++){const n=e[r+2*i],s=e[r+2*i+1],o=n-s,a=n+s;o<t[i]&&(t[i]=o),a>t[i+3]&&(t[i+3]=a)}}function cl(r){const e=r[3]-r[0],t=r[4]-r[1],i=r[5]-r[2];return 2*(e*t+t*i+i*e)}const Js=32,yD=(r,e)=>r.candidate-e.candidate,Cr=new Array(Js).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),fu=new Float32Array(6);function vD(r,e,t,i,n,s){let o=-1,a=0;if(s===HC)o=sv(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(s===dD)o=sv(r),o!==-1&&(a=ED(t,i,n,o));else if(s===Zh){const l=cl(r);let c=zd*n;const u=i*6,h=(i+n)*6;for(let f=0;f<3;f++){const d=e[f],p=(e[f+3]-d)/Js;if(n<Js/4){const g=[...Cr];g.length=n;let v=0;for(let C=u;C<h;C+=6,v++){const I=g[v];I.candidate=t[C+2*f],I.count=0;const{bounds:_,leftCacheBounds:x,rightCacheBounds:S}=I;for(let b=0;b<3;b++)S[b]=1/0,S[b+3]=-1/0,x[b]=1/0,x[b+3]=-1/0,_[b]=1/0,_[b+3]=-1/0;hu(C,t,_)}g.sort(yD);let E=n;for(let C=0;C<E;C++){const I=g[C];for(;C+1<E&&g[C+1].candidate===I.candidate;)g.splice(C+1,1),E--}for(let C=u;C<h;C+=6){const I=t[C+2*f];for(let _=0;_<E;_++){const x=g[_];I>=x.candidate?hu(C,t,x.rightCacheBounds):(hu(C,t,x.leftCacheBounds),x.count++)}}for(let C=0;C<E;C++){const I=g[C],_=I.count,x=n-I.count,S=I.leftCacheBounds,b=I.rightCacheBounds;let T=0;_!==0&&(T=cl(S)/l);let B=0;x!==0&&(B=cl(b)/l);const w=nv+zd*(T*_+B*x);w<c&&(o=f,c=w,a=I.candidate)}}else{for(let E=0;E<Js;E++){const C=Cr[E];C.count=0,C.candidate=d+p+E*p;const I=C.bounds;for(let _=0;_<3;_++)I[_]=1/0,I[_+3]=-1/0}for(let E=u;E<h;E+=6){let _=~~((t[E+2*f]-d)/p);_>=Js&&(_=Js-1);const x=Cr[_];x.count++,hu(E,t,x.bounds)}const g=Cr[Js-1];rv(g.bounds,g.rightCacheBounds);for(let E=Js-2;E>=0;E--){const C=Cr[E],I=Cr[E+1];ov(C.bounds,I.rightCacheBounds,C.rightCacheBounds)}let v=0;for(let E=0;E<Js-1;E++){const C=Cr[E],I=C.count,_=C.bounds,S=Cr[E+1].rightCacheBounds;I!==0&&(v===0?rv(_,fu):ov(_,fu,fu)),v+=I;let b=0,T=0;v!==0&&(b=cl(fu)/l);const B=n-v;B!==0&&(T=cl(S)/l);const w=nv+zd*(b*v+T*B);w<c&&(o=f,c=w,a=C.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${s} used.`);return{axis:o,pos:a}}function ED(r,e,t,i){let n=0;for(let s=e,o=e+t;s<o;s++)n+=r[s*6+i*2];return n/t}class Kd{constructor(){this.boundingData=new Float32Array(6)}}function CD(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){for(let u=0;u<3;u++){let h=e[o*3+u];e[o*3+u]=e[a*3+u],e[a*3+u]=h}for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function ID(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){let u=r[o];r[o]=r[a],r[a]=u;for(let h=0;h<6;h++){let f=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=f}o++,a--}else return o}}function cn(r,e){return e[r+15]===65535}function Cn(r,e){return e[r+6]}function Rn(r,e){return e[r+14]}function Xn(r){return r+8}function Dn(r,e){return e[r+6]}function HA(r,e){return e[r+7]}let YC,Bl,Zu,WC;const _D=Math.pow(2,32);function _m(r){return"count"in r?1:1+_m(r.left)+_m(r.right)}function xD(r,e,t){return YC=new Float32Array(t),Bl=new Uint32Array(t),Zu=new Uint16Array(t),WC=new Uint8Array(t),xm(r,e)}function xm(r,e){const t=r/4,i=r/2,n="count"in e,s=e.boundingData;for(let o=0;o<6;o++)YC[t+o]=s[o];if(n)if(e.buffer){const o=e.buffer;WC.set(new Uint8Array(o),r);for(let a=r,l=r+o.byteLength;a<l;a+=Lr){const c=a/2;cn(c,Zu)||(Bl[a/4+6]+=t)}return r+o.byteLength}else{const o=e.offset,a=e.count;return Bl[t+6]=o,Zu[i+14]=a,Zu[i+15]=ef,r+Lr}else{const o=e.left,a=e.right,l=e.splitAxis;let c;if(c=xm(r+Lr,o),c/4>_D)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Bl[t+6]=c/4,c=xm(c,a),Bl[t+7]=l,c}}function SD(r,e){const t=(r.index?r.index.count:r.attributes.position.count)/3,i=t>2**16,n=i?4:2,s=e?new SharedArrayBuffer(t*n):new ArrayBuffer(t*n),o=i?new Uint32Array(s):new Uint16Array(s);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function TD(r,e,t,i,n){const{maxDepth:s,verbose:o,maxLeafTris:a,strategy:l,onProgress:c,indirect:u}=n,h=r._indirectBuffer,f=r.geometry,d=f.index?f.index.array:null,m=u?ID:CD,A=xa(f),p=new Float32Array(6);let g=!1;const v=new Kd;return Vd(e,t,i,v.boundingData,p),C(v,t,i,p),v;function E(I){c&&c(I/A)}function C(I,_,x,S=null,b=0){if(!g&&b>=s&&(g=!0,o&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(f))),x<=a||b>=s)return E(_+x),I.offset=_,I.count=x,I;const T=vD(I.boundingData,S,e,_,x,l);if(T.axis===-1)return E(_+x),I.offset=_,I.count=x,I;const B=m(h,d,e,_,x,T);if(B===_||B===_+x)E(_+x),I.offset=_,I.count=x;else{I.splitAxis=T.axis;const w=new Kd,R=_,D=B-_;I.left=w,Vd(e,R,D,w.boundingData,p),C(w,R,D,p,b+1);const G=new Kd,z=B,W=x-D;I.right=G,Vd(e,z,W,G.boundingData,p),C(G,z,W,p,b+1)}return I}}function bD(r,e){const t=r.geometry;e.indirect&&(r._indirectBuffer=SD(t,e.useSharedArrayBuffer),pD(t,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),r._indirectBuffer||AD(t,e);const i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=gD(t),s=e.indirect?$C(t,e.range):jC(t,e.range);r._roots=s.map(o=>{const a=TD(r,n,o.offset,o.count,e),l=_m(a),c=new i(Lr*l);return xD(0,a,c),c})}class hr{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,n=-1/0;for(let s=0,o=e.length;s<o;s++){const l=e[s][t];i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}setFromPoints(e,t){let i=1/0,n=-1/0;for(let s=0,o=t.length;s<o;s++){const a=t[s],l=e.dot(a);i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}hr.prototype.setFromBox=function(){const r=new K;return function(t,i){const n=i.min,s=i.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let u=0;u<=1;u++){r.x=n.x*l+s.x*(1-l),r.y=n.y*c+s.y*(1-c),r.z=n.z*u+s.z*(1-u);const h=t.dot(r);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}}();const wD=function(){const r=new K,e=new K,t=new K;return function(n,s,o){const a=n.start,l=r,c=s.start,u=e;t.subVectors(a,c),r.subVectors(n.end,n.start),e.subVectors(s.end,s.start);const h=t.dot(u),f=u.dot(l),d=u.dot(u),m=t.dot(l),p=l.dot(l)*d-f*f;let g,v;p!==0?g=(h*f-m*d)/p:g=0,v=(h+g*f)/d,o.x=g,o.y=v}}(),VA=function(){const r=new Fe,e=new K,t=new K;return function(n,s,o,a){wD(n,s,r);let l=r.x,c=r.y;if(l>=0&&l<=1&&c>=0&&c<=1){n.at(l,o),s.at(c,a);return}else if(l>=0&&l<=1){c<0?s.at(0,a):s.at(1,a),n.closestPointToPoint(a,!0,o);return}else if(c>=0&&c<=1){l<0?n.at(0,o):n.at(1,o),s.closestPointToPoint(o,!0,a);return}else{let u;l<0?u=n.start:u=n.end;let h;c<0?h=s.start:h=s.end;const f=e,d=t;if(n.closestPointToPoint(h,!0,e),s.closestPointToPoint(u,!0,t),f.distanceToSquared(h)<=d.distanceToSquared(u)){o.copy(f),a.copy(h);return}else{o.copy(u),a.copy(d);return}}}}(),BD=function(){const r=new K,e=new K,t=new Hs,i=new Ns;return function(s,o){const{radius:a,center:l}=s,{a:c,b:u,c:h}=o;if(i.start=c,i.end=u,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a||(i.start=c,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a)||(i.start=u,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a))return!0;const A=o.getPlane(t);if(Math.abs(A.distanceToPoint(l))<=a){const g=A.projectPoint(l,e);if(o.containsPoint(g))return!0}return!1}}(),RD=1e-15;function $d(r){return Math.abs(r)<RD}class ys extends qo{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new K),this.satBounds=new Array(4).fill().map(()=>new hr),this.points=[this.a,this.b,this.c],this.sphere=new un,this.plane=new Hs,this.needsUpdate=!0}intersectsSphere(e){return BD(e,this)}update(){const e=this.a,t=this.b,i=this.c,n=this.points,s=this.satAxes,o=this.satBounds,a=s[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=s[1],u=o[1];c.subVectors(e,t),u.setFromPoints(c,n);const h=s[2],f=o[2];h.subVectors(t,i),f.setFromPoints(h,n);const d=s[3],m=o[3];d.subVectors(i,e),m.setFromPoints(d,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}ys.prototype.closestPointToSegment=function(){const r=new K,e=new K,t=new Ns;return function(n,s=null,o=null){const{start:a,end:l}=n,c=this.points;let u,h=1/0;for(let f=0;f<3;f++){const d=(f+1)%3;t.start.copy(c[f]),t.end.copy(c[d]),VA(t,n,r,e),u=r.distanceToSquared(e),u<h&&(h=u,s&&s.copy(r),o&&o.copy(e))}return this.closestPointToPoint(a,r),u=a.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(a)),this.closestPointToPoint(l,r),u=l.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(l)),Math.sqrt(h)}}();ys.prototype.intersectsTriangle=function(){const r=new ys,e=new Array(3),t=new Array(3),i=new hr,n=new hr,s=new K,o=new K,a=new K,l=new K,c=new K,u=new Ns,h=new Ns,f=new Ns,d=new K;function m(A,p,g){const v=A.points;let E=0,C=-1;for(let I=0;I<3;I++){const{start:_,end:x}=u;_.copy(v[I]),x.copy(v[(I+1)%3]),u.delta(o);const S=$d(p.distanceToPoint(_));if($d(p.normal.dot(o))&&S){g.copy(u),E=2;break}const b=p.intersectLine(u,d);if(!b&&S&&d.copy(_),(b||S)&&!$d(d.distanceTo(x))){if(E<=1)(E===1?g.start:g.end).copy(d),S&&(C=E);else if(E>=2){(C===1?g.start:g.end).copy(d),E=2;break}if(E++,E===2&&C===-1)break}}return E}return function(p,g=null,v=!1){this.needsUpdate&&this.update(),p.isExtendedTriangle?p.needsUpdate&&p.update():(r.copy(p),r.update(),p=r);const E=this.plane,C=p.plane;if(Math.abs(E.normal.dot(C.normal))>1-1e-10){const I=this.satBounds,_=this.satAxes;t[0]=p.a,t[1]=p.b,t[2]=p.c;for(let b=0;b<4;b++){const T=I[b],B=_[b];if(i.setFromPoints(B,t),T.isSeparated(i))return!1}const x=p.satBounds,S=p.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let b=0;b<4;b++){const T=x[b],B=S[b];if(i.setFromPoints(B,e),T.isSeparated(i))return!1}for(let b=0;b<4;b++){const T=_[b];for(let B=0;B<4;B++){const w=S[B];if(s.crossVectors(T,w),i.setFromPoints(s,e),n.setFromPoints(s,t),i.isSeparated(n))return!1}}return g&&(v||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),g.start.set(0,0,0),g.end.set(0,0,0)),!0}else{const I=m(this,C,h);if(I===1&&p.containsPoint(h.end))return g&&(g.start.copy(h.end),g.end.copy(h.end)),!0;if(I!==2)return!1;const _=m(p,E,f);if(_===1&&this.containsPoint(f.end))return g&&(g.start.copy(f.end),g.end.copy(f.end)),!0;if(_!==2)return!1;if(h.delta(a),f.delta(l),a.dot(l)<0){let R=f.start;f.start=f.end,f.end=R}const x=h.start.dot(a),S=h.end.dot(a),b=f.start.dot(a),T=f.end.dot(a),B=S<b,w=x<T;return x!==T&&b!==S&&B===w?!1:(g&&(c.subVectors(h.start,f.start),c.dot(a)>0?g.start.copy(h.start):g.start.copy(f.start),c.subVectors(h.end,f.end),c.dot(a)<0?g.end.copy(h.end):g.end.copy(f.end)),!0)}}}();ys.prototype.distanceToPoint=function(){const r=new K;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();ys.prototype.distanceToTriangle=function(){const r=new K,e=new K,t=["a","b","c"],i=new Ns,n=new Ns;return function(o,a=null,l=null){const c=a||l?i:null;if(this.intersectsTriangle(o,c))return(a||l)&&(a&&c.getCenter(a),l&&c.getCenter(l)),0;let u=1/0;for(let h=0;h<3;h++){let f;const d=t[h],m=o[d];this.closestPointToPoint(m,r),f=m.distanceToSquared(r),f<u&&(u=f,a&&a.copy(r),l&&l.copy(m));const A=this[d];o.closestPointToPoint(A,r),f=A.distanceToSquared(r),f<u&&(u=f,a&&a.copy(A),l&&l.copy(r))}for(let h=0;h<3;h++){const f=t[h],d=t[(h+1)%3];i.set(this[f],this[d]);for(let m=0;m<3;m++){const A=t[m],p=t[(m+1)%3];n.set(o[A],o[p]),VA(i,n,r,e);const g=r.distanceToSquared(e);g<u&&(u=g,a&&a.copy(r),l&&l.copy(e))}}return Math.sqrt(u)}}();class hn{constructor(e,t,i){this.isOrientedBox=!0,this.min=new K,this.max=new K,this.matrix=new Me,this.invMatrix=new Me,this.points=new Array(8).fill().map(()=>new K),this.satAxes=new Array(3).fill().map(()=>new K),this.satBounds=new Array(3).fill().map(()=>new hr),this.alignedSatBounds=new Array(3).fill().map(()=>new hr),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}hn.prototype.update=function(){return function(){const e=this.matrix,t=this.min,i=this.max,n=this.points;for(let c=0;c<=1;c++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const f=1*c|2*u|4*h,d=n[f];d.x=c?i.x:t.x,d.y=u?i.y:t.y,d.z=h?i.z:t.z,d.applyMatrix4(e)}const s=this.satBounds,o=this.satAxes,a=n[0];for(let c=0;c<3;c++){const u=o[c],h=s[c],f=1<<c,d=n[f];u.subVectors(a,d),h.setFromPoints(u,n)}const l=this.alignedSatBounds;l[0].setFromPointsField(n,"x"),l[1].setFromPointsField(n,"y"),l[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();hn.prototype.intersectsBox=function(){const r=new hr;return function(t){this.needsUpdate&&this.update();const i=t.min,n=t.max,s=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(r.min=i.x,r.max=n.x,a[0].isSeparated(r)||(r.min=i.y,r.max=n.y,a[1].isSeparated(r))||(r.min=i.z,r.max=n.z,a[2].isSeparated(r)))return!1;for(let l=0;l<3;l++){const c=o[l],u=s[l];if(r.setFromBox(c,t),u.isSeparated(r))return!1}return!0}}();hn.prototype.intersectsTriangle=function(){const r=new ys,e=new Array(3),t=new hr,i=new hr,n=new K;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(r.copy(o),r.update(),o=r);const a=this.satBounds,l=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let f=0;f<3;f++){const d=a[f],m=l[f];if(t.setFromPoints(m,e),d.isSeparated(t))return!1}const c=o.satBounds,u=o.satAxes,h=this.points;for(let f=0;f<3;f++){const d=c[f],m=u[f];if(t.setFromPoints(m,h),d.isSeparated(t))return!1}for(let f=0;f<3;f++){const d=l[f];for(let m=0;m<4;m++){const A=u[m];if(n.crossVectors(d,A),t.setFromPoints(n,e),i.setFromPoints(n,h),t.isSeparated(i))return!1}}return!0}}();hn.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();hn.prototype.distanceToPoint=function(){const r=new K;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();hn.prototype.distanceToBox=function(){const r=["x","y","z"],e=new Array(12).fill().map(()=>new Ns),t=new Array(12).fill().map(()=>new Ns),i=new K,n=new K;return function(o,a=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||c)&&(o.getCenter(n),this.closestPointToPoint(n,i),o.closestPointToPoint(i,n),l&&l.copy(i),c&&c.copy(n)),0;const u=a*a,h=o.min,f=o.max,d=this.points;let m=1/0;for(let p=0;p<8;p++){const g=d[p];n.copy(g).clamp(h,f);const v=g.distanceToSquared(n);if(v<m&&(m=v,l&&l.copy(g),c&&c.copy(n),v<u))return Math.sqrt(v)}let A=0;for(let p=0;p<3;p++)for(let g=0;g<=1;g++)for(let v=0;v<=1;v++){const E=(p+1)%3,C=(p+2)%3,I=g<<E|v<<C,_=1<<p|g<<E|v<<C,x=d[I],S=d[_];e[A].set(x,S);const T=r[p],B=r[E],w=r[C],R=t[A],D=R.start,G=R.end;D[T]=h[T],D[B]=g?h[B]:f[B],D[w]=v?h[w]:f[B],G[T]=f[T],G[B]=g?h[B]:f[B],G[w]=v?h[w]:f[B],A++}for(let p=0;p<=1;p++)for(let g=0;g<=1;g++)for(let v=0;v<=1;v++){n.x=p?f.x:h.x,n.y=g?f.y:h.y,n.z=v?f.z:h.z,this.closestPointToPoint(n,i);const E=n.distanceToSquared(i);if(E<m&&(m=E,l&&l.copy(i),c&&c.copy(n),E<u))return Math.sqrt(E)}for(let p=0;p<12;p++){const g=e[p];for(let v=0;v<12;v++){const E=t[v];VA(g,E,i,n);const C=i.distanceToSquared(n);if(C<m&&(m=C,l&&l.copy(i),c&&c.copy(n),C<u))return Math.sqrt(C)}}return Math.sqrt(m)}}();class KA{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class DD extends KA{constructor(){super(()=>new ys)}}const Jn=new DD;class MD{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=i=>{t&&e.push(t),t=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const fi=new MD;let Dr,ta;const Do=[],du=new KA(()=>new oi);function LD(r,e,t,i,n,s){Dr=du.getPrimitive(),ta=du.getPrimitive(),Do.push(Dr,ta),fi.setBuffer(r._roots[e]);const o=Sm(0,r.geometry,t,i,n,s);fi.clearBuffer(),du.releasePrimitive(Dr),du.releasePrimitive(ta),Do.pop(),Do.pop();const a=Do.length;return a>0&&(ta=Do[a-1],Dr=Do[a-2]),o}function Sm(r,e,t,i,n=null,s=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=fi;let u=r*2;if(cn(u,l)){const f=Cn(r,c),d=Rn(u,l);return Ii(r,a,Dr),i(f,d,!1,o,s+r,Dr)}else{let T=function(w){const{uint16Array:R,uint32Array:D}=fi;let G=w*2;for(;!cn(G,R);)w=Xn(w),G=w*2;return Cn(w,D)},B=function(w){const{uint16Array:R,uint32Array:D}=fi;let G=w*2;for(;!cn(G,R);)w=Dn(w,D),G=w*2;return Cn(w,D)+Rn(G,R)};const f=Xn(r),d=Dn(r,c);let m=f,A=d,p,g,v,E;if(n&&(v=Dr,E=ta,Ii(m,a,v),Ii(A,a,E),p=n(v),g=n(E),g<p)){m=d,A=f;const w=p;p=g,g=w,v=E}v||(v=Dr,Ii(m,a,v));const C=cn(m*2,l),I=t(v,C,p,o+1,s+m);let _;if(I===iv){const w=T(m),D=B(m)-w;_=i(w,D,!0,o+1,s+m,v)}else _=I&&Sm(m,e,t,i,n,s,o+1);if(_)return!0;E=ta,Ii(A,a,E);const x=cn(A*2,l),S=t(E,x,g,o+1,s+A);let b;if(S===iv){const w=T(A),D=B(A)-w;b=i(w,D,!0,o+1,s+A,E)}else b=S&&Sm(A,e,t,i,n,s,o+1);return!!b}}const ul=new K,jd=new K;function PD(r,e,t={},i=0,n=1/0){const s=i*i,o=n*n;let a=1/0,l=null;if(r.shapecast({boundsTraverseOrder:u=>(ul.copy(e).clamp(u.min,u.max),ul.distanceToSquared(e)),intersectsBounds:(u,h,f)=>f<a&&f<o,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,ul);const f=e.distanceToSquared(ul);return f<a&&(jd.copy(ul),a=f,l=h),f<s}}),a===1/0)return null;const c=Math.sqrt(a);return t.point?t.point.copy(jd):t.point=jd.clone(),t.distance=c,t.faceIndex=l,t}const Mo=new K,Lo=new K,Po=new K,mu=new Fe,Au=new Fe,pu=new Fe,av=new K,lv=new K,cv=new K,gu=new K;function FD(r,e,t,i,n,s,o,a){let l;if(s===hc?l=r.intersectTriangle(i,t,e,!0,n):l=r.intersectTriangle(e,t,i,s!==wi,n),l===null)return null;const c=r.origin.distanceTo(n);return c<o||c>a?null:{distance:c,point:n.clone()}}function kD(r,e,t,i,n,s,o,a,l,c,u){Mo.fromBufferAttribute(e,s),Lo.fromBufferAttribute(e,o),Po.fromBufferAttribute(e,a);const h=FD(r,Mo,Lo,Po,gu,l,c,u);if(h){i&&(mu.fromBufferAttribute(i,s),Au.fromBufferAttribute(i,o),pu.fromBufferAttribute(i,a),h.uv=qo.getInterpolation(gu,Mo,Lo,Po,mu,Au,pu,new Fe)),n&&(mu.fromBufferAttribute(n,s),Au.fromBufferAttribute(n,o),pu.fromBufferAttribute(n,a),h.uv1=qo.getInterpolation(gu,Mo,Lo,Po,mu,Au,pu,new Fe)),t&&(av.fromBufferAttribute(t,s),lv.fromBufferAttribute(t,o),cv.fromBufferAttribute(t,a),h.normal=qo.getInterpolation(gu,Mo,Lo,Po,av,lv,cv,new K),h.normal.dot(r.direction)>0&&h.normal.multiplyScalar(-1));const f={a:s,b:o,c:a,normal:new K,materialIndex:0};qo.getNormal(Mo,Lo,Po,f.normal),h.face=f,h.faceIndex=s}return h}function tf(r,e,t,i,n,s,o){const a=i*3;let l=a+0,c=a+1,u=a+2;const h=r.index;r.index&&(l=h.getX(l),c=h.getX(c),u=h.getX(u));const{position:f,normal:d,uv:m,uv1:A}=r.attributes,p=kD(t,f,d,m,A,l,c,u,e,s,o);return p?(p.faceIndex=i,n&&n.push(p),p):null}function Li(r,e,t,i){const n=r.a,s=r.b,o=r.c;let a=e,l=e+1,c=e+2;t&&(a=t.getX(a),l=t.getX(l),c=t.getX(c)),n.x=i.getX(a),n.y=i.getY(a),n.z=i.getZ(a),s.x=i.getX(l),s.y=i.getY(l),s.z=i.getZ(l),o.x=i.getX(c),o.y=i.getY(c),o.z=i.getZ(c)}function OD(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++)tf(l,e,t,u,s,o,a)}function UD(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=tf(a,e,t,h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function ND(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=u,Li(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function GD(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===ef){const g=o[f+6],v=a[A+14];let E=1/0,C=1/0,I=1/0,_=-1/0,x=-1/0,S=-1/0;for(let b=3*g,T=3*(g+v);b<T;b++){let B=i[b];const w=n.getX(B),R=n.getY(B),D=n.getZ(B);w<E&&(E=w),w>_&&(_=w),R<C&&(C=R),R>x&&(x=R),D<I&&(I=D),D>S&&(S=D)}return l[f+0]!==E||l[f+1]!==C||l[f+2]!==I||l[f+3]!==_||l[f+4]!==x||l[f+5]!==S?(l[f+0]=E,l[f+1]=C,l[f+2]=I,l[f+3]=_,l[f+4]=x,l[f+5]=S,!0):!1}else{const g=f+8,v=o[f+6],E=g+d,C=v+d;let I=m,_=!1,x=!1;e?I||(_=e.has(E),x=e.has(C),I=!_&&!x):(_=!0,x=!0);const S=I||_,b=I||x;let T=!1;S&&(T=h(g,d,I));let B=!1;b&&(B=h(v,d,I));const w=T||B;if(w)for(let R=0;R<3;R++){const D=g+R,G=v+R,z=l[D],W=l[D+3],q=l[G],F=l[G+3];l[f+R]=z<q?z:q,l[f+R+3]=W>F?W:F}return w}}}function Or(r,e,t,i,n){let s,o,a,l,c,u;const h=1/t.direction.x,f=1/t.direction.y,d=1/t.direction.z,m=t.origin.x,A=t.origin.y,p=t.origin.z;let g=e[r],v=e[r+3],E=e[r+1],C=e[r+3+1],I=e[r+2],_=e[r+3+2];return h>=0?(s=(g-m)*h,o=(v-m)*h):(s=(v-m)*h,o=(g-m)*h),f>=0?(a=(E-A)*f,l=(C-A)*f):(a=(C-A)*f,l=(E-A)*f),s>l||a>o||((a>s||isNaN(s))&&(s=a),(l<o||isNaN(o))&&(o=l),d>=0?(c=(I-p)*d,u=(_-p)*d):(c=(_-p)*d,u=(I-p)*d),s>u||c>o)?!1:((c>s||s!==s)&&(s=c),(u<o||o!==o)&&(o=u),s<=n&&o>=i)}function QD(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++){let f=c?c[u]:u;tf(l,e,t,f,s,o,a)}}function zD(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=tf(a,e,t,l?l[h]:h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function HD(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=t.resolveTriangleIndex(u),Li(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function VD(r,e,t,i,n,s,o){fi.setBuffer(r._roots[e]),Tm(0,r,t,i,n,s,o),fi.clearBuffer()}function Tm(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=fi,u=r*2;if(cn(u,l)){const f=Cn(r,c),d=Rn(u,l);OD(e,t,i,f,d,n,s,o)}else{const f=Xn(r);Or(f,a,i,s,o)&&Tm(f,e,t,i,n,s,o);const d=Dn(r,c);Or(d,a,i,s,o)&&Tm(d,e,t,i,n,s,o)}}const KD=["x","y","z"];function $D(r,e,t,i,n,s){fi.setBuffer(r._roots[e]);const o=bm(0,r,t,i,n,s);return fi.clearBuffer(),o}function bm(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=fi;let c=r*2;if(cn(c,a)){const h=Cn(r,l),f=Rn(c,a);return UD(e,t,i,h,f,n,s)}else{const h=HA(r,l),f=KD[h],m=i.direction[f]>=0;let A,p;m?(A=Xn(r),p=Dn(r,l)):(A=Dn(r,l),p=Xn(r));const v=Or(A,o,i,n,s)?bm(A,e,t,i,n,s):null;if(v){const I=v.point[f];if(m?I<=o[p+h]:I>=o[p+h+3])return v}const C=Or(p,o,i,n,s)?bm(p,e,t,i,n,s):null;return v&&C?v.distance<=C.distance?v:C:v||C||null}}const yu=new oi,Fo=new ys,ko=new ys,hl=new Me,uv=new hn,vu=new hn;function jD(r,e,t,i){fi.setBuffer(r._roots[e]);const n=wm(0,r,t,i);return fi.clearBuffer(),n}function wm(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=fi;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),uv.set(t.boundingBox.min,t.boundingBox.max,i),n=uv),cn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=Cn(r,a),p=Rn(l,o);if(hl.copy(i).invert(),t.boundsTree)return Ii(r,s,vu),vu.matrix.copy(hl),vu.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>vu.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=A*3,C=(p+A)*3;E<C;E+=3)if(Li(ko,E,h,f),ko.needsUpdate=!0,v.intersectsTriangle(ko))return!0;return!1}});for(let g=A*3,v=(p+A)*3;g<v;g+=3){Li(Fo,g,h,f),Fo.a.applyMatrix4(hl),Fo.b.applyMatrix4(hl),Fo.c.applyMatrix4(hl),Fo.needsUpdate=!0;for(let E=0,C=d.count;E<C;E+=3)if(Li(ko,E,d,m),ko.needsUpdate=!0,Fo.intersectsTriangle(ko))return!0}}else{const u=r+8,h=a[r+6];return Ii(u,s,yu),!!(n.intersectsBox(yu)&&wm(u,e,t,i,n)||(Ii(h,s,yu),n.intersectsBox(yu)&&wm(h,e,t,i,n)))}}const Eu=new Me,Yd=new hn,fl=new hn,YD=new K,WD=new K,qD=new K,XD=new K;function JD(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Yd.set(e.boundingBox.min,e.boundingBox.max,t),Yd.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=Jn.getPrimitive(),d=Jn.getPrimitive();let m=YD,A=WD,p=null,g=null;n&&(p=qD,g=XD);let v=1/0,E=null,C=null;return Eu.copy(t).invert(),fl.matrix.copy(Eu),r.shapecast({boundsTraverseOrder:I=>Yd.distanceToBox(I),intersectsBounds:(I,_,x)=>x<v&&x<o?(_&&(fl.min.copy(I.min),fl.max.copy(I.max),fl.needsUpdate=!0),!0):!1,intersectsRange:(I,_)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:S=>fl.distanceToBox(S),intersectsBounds:(S,b,T)=>T<v&&T<o,intersectsRange:(S,b)=>{for(let T=S,B=S+b;T<B;T++){Li(d,3*T,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let w=I,R=I+_;w<R;w++){Li(f,3*w,c,l),f.needsUpdate=!0;const D=f.distanceToTriangle(d,m,p);if(D<v&&(A.copy(m),g&&g.copy(p),v=D,E=w,C=T),D<s)return!0}}}});{const x=xa(e);for(let S=0,b=x;S<b;S++){Li(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=I,B=I+_;T<B;T++){Li(f,3*T,c,l),f.needsUpdate=!0;const w=f.distanceToTriangle(d,m,p);if(w<v&&(A.copy(m),g&&g.copy(p),v=w,E=T,C=S),w<s)return!0}}}}}),Jn.releasePrimitive(f),Jn.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=v,i.faceIndex=E,n&&(n.point?n.point.copy(g):n.point=g.clone(),n.point.applyMatrix4(Eu),A.applyMatrix4(Eu),n.distance=A.sub(n.point).length(),n.faceIndex=C),i)}function ZD(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===ef){const g=o[f+6],v=a[A+14];let E=1/0,C=1/0,I=1/0,_=-1/0,x=-1/0,S=-1/0;for(let b=g,T=g+v;b<T;b++){const B=3*r.resolveTriangleIndex(b);for(let w=0;w<3;w++){let R=B+w;R=i?i[R]:R;const D=n.getX(R),G=n.getY(R),z=n.getZ(R);D<E&&(E=D),D>_&&(_=D),G<C&&(C=G),G>x&&(x=G),z<I&&(I=z),z>S&&(S=z)}}return l[f+0]!==E||l[f+1]!==C||l[f+2]!==I||l[f+3]!==_||l[f+4]!==x||l[f+5]!==S?(l[f+0]=E,l[f+1]=C,l[f+2]=I,l[f+3]=_,l[f+4]=x,l[f+5]=S,!0):!1}else{const g=f+8,v=o[f+6],E=g+d,C=v+d;let I=m,_=!1,x=!1;e?I||(_=e.has(E),x=e.has(C),I=!_&&!x):(_=!0,x=!0);const S=I||_,b=I||x;let T=!1;S&&(T=h(g,d,I));let B=!1;b&&(B=h(v,d,I));const w=T||B;if(w)for(let R=0;R<3;R++){const D=g+R,G=v+R,z=l[D],W=l[D+3],q=l[G],F=l[G+3];l[f+R]=z<q?z:q,l[f+R+3]=W>F?W:F}return w}}}function eM(r,e,t,i,n,s,o){fi.setBuffer(r._roots[e]),Bm(0,r,t,i,n,s,o),fi.clearBuffer()}function Bm(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=fi,u=r*2;if(cn(u,l)){const f=Cn(r,c),d=Rn(u,l);QD(e,t,i,f,d,n,s,o)}else{const f=Xn(r);Or(f,a,i,s,o)&&Bm(f,e,t,i,n,s,o);const d=Dn(r,c);Or(d,a,i,s,o)&&Bm(d,e,t,i,n,s,o)}}const tM=["x","y","z"];function iM(r,e,t,i,n,s){fi.setBuffer(r._roots[e]);const o=Rm(0,r,t,i,n,s);return fi.clearBuffer(),o}function Rm(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=fi;let c=r*2;if(cn(c,a)){const h=Cn(r,l),f=Rn(c,a);return zD(e,t,i,h,f,n,s)}else{const h=HA(r,l),f=tM[h],m=i.direction[f]>=0;let A,p;m?(A=Xn(r),p=Dn(r,l)):(A=Dn(r,l),p=Xn(r));const v=Or(A,o,i,n,s)?Rm(A,e,t,i,n,s):null;if(v){const I=v.point[f];if(m?I<=o[p+h]:I>=o[p+h+3])return v}const C=Or(p,o,i,n,s)?Rm(p,e,t,i,n,s):null;return v&&C?v.distance<=C.distance?v:C:v||C||null}}const Cu=new oi,Oo=new ys,Uo=new ys,dl=new Me,hv=new hn,Iu=new hn;function nM(r,e,t,i){fi.setBuffer(r._roots[e]);const n=Dm(0,r,t,i);return fi.clearBuffer(),n}function Dm(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=fi;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),hv.set(t.boundingBox.min,t.boundingBox.max,i),n=hv),cn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=Cn(r,a),p=Rn(l,o);if(dl.copy(i).invert(),t.boundsTree)return Ii(r,s,Iu),Iu.matrix.copy(dl),Iu.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Iu.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=A,C=p+A;E<C;E++)if(Li(Uo,3*e.resolveTriangleIndex(E),h,f),Uo.needsUpdate=!0,v.intersectsTriangle(Uo))return!0;return!1}});for(let g=A,v=p+A;g<v;g++){const E=e.resolveTriangleIndex(g);Li(Oo,3*E,h,f),Oo.a.applyMatrix4(dl),Oo.b.applyMatrix4(dl),Oo.c.applyMatrix4(dl),Oo.needsUpdate=!0;for(let C=0,I=d.count;C<I;C+=3)if(Li(Uo,C,d,m),Uo.needsUpdate=!0,Oo.intersectsTriangle(Uo))return!0}}else{const u=r+8,h=a[r+6];return Ii(u,s,Cu),!!(n.intersectsBox(Cu)&&Dm(u,e,t,i,n)||(Ii(h,s,Cu),n.intersectsBox(Cu)&&Dm(h,e,t,i,n)))}}const _u=new Me,Wd=new hn,ml=new hn,sM=new K,rM=new K,oM=new K,aM=new K;function lM(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Wd.set(e.boundingBox.min,e.boundingBox.max,t),Wd.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=Jn.getPrimitive(),d=Jn.getPrimitive();let m=sM,A=rM,p=null,g=null;n&&(p=oM,g=aM);let v=1/0,E=null,C=null;return _u.copy(t).invert(),ml.matrix.copy(_u),r.shapecast({boundsTraverseOrder:I=>Wd.distanceToBox(I),intersectsBounds:(I,_,x)=>x<v&&x<o?(_&&(ml.min.copy(I.min),ml.max.copy(I.max),ml.needsUpdate=!0),!0):!1,intersectsRange:(I,_)=>{if(e.boundsTree){const x=e.boundsTree;return x.shapecast({boundsTraverseOrder:S=>ml.distanceToBox(S),intersectsBounds:(S,b,T)=>T<v&&T<o,intersectsRange:(S,b)=>{for(let T=S,B=S+b;T<B;T++){const w=x.resolveTriangleIndex(T);Li(d,3*w,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let R=I,D=I+_;R<D;R++){const G=r.resolveTriangleIndex(R);Li(f,3*G,c,l),f.needsUpdate=!0;const z=f.distanceToTriangle(d,m,p);if(z<v&&(A.copy(m),g&&g.copy(p),v=z,E=R,C=T),z<s)return!0}}}})}else{const x=xa(e);for(let S=0,b=x;S<b;S++){Li(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=I,B=I+_;T<B;T++){const w=r.resolveTriangleIndex(T);Li(f,3*w,c,l),f.needsUpdate=!0;const R=f.distanceToTriangle(d,m,p);if(R<v&&(A.copy(m),g&&g.copy(p),v=R,E=T,C=S),R<s)return!0}}}}}),Jn.releasePrimitive(f),Jn.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=v,i.faceIndex=E,n&&(n.point?n.point.copy(g):n.point=g.clone(),n.point.applyMatrix4(_u),A.applyMatrix4(_u),n.distance=A.sub(n.point).length(),n.faceIndex=C),i)}function cM(){return typeof SharedArrayBuffer<"u"}const Hl=new fi.constructor,Sh=new fi.constructor,br=new KA(()=>new oi),No=new oi,Go=new oi,qd=new oi,Xd=new oi;let Jd=!1;function uM(r,e,t,i){if(Jd)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Jd=!0;const n=r._roots,s=e._roots;let o,a=0,l=0;const c=new Me().copy(t).invert();for(let u=0,h=n.length;u<h;u++){Hl.setBuffer(n[u]),l=0;const f=br.getPrimitive();Ii(0,Hl.float32Array,f),f.applyMatrix4(c);for(let d=0,m=s.length;d<m&&(Sh.setBuffer(s[d]),o=us(0,0,t,c,i,a,l,0,0,f),Sh.clearBuffer(),l+=s[d].length,!o);d++);if(br.releasePrimitive(f),Hl.clearBuffer(),a+=n[u].length,o)break}return Jd=!1,o}function us(r,e,t,i,n,s=0,o=0,a=0,l=0,c=null,u=!1){let h,f;u?(h=Sh,f=Hl):(h=Hl,f=Sh);const d=h.float32Array,m=h.uint32Array,A=h.uint16Array,p=f.float32Array,g=f.uint32Array,v=f.uint16Array,E=r*2,C=e*2,I=cn(E,A),_=cn(C,v);let x=!1;if(_&&I)u?x=n(Cn(e,g),Rn(e*2,v),Cn(r,m),Rn(r*2,A),l,o+e,a,s+r):x=n(Cn(r,m),Rn(r*2,A),Cn(e,g),Rn(e*2,v),a,s+r,l,o+e);else if(_){const S=br.getPrimitive();Ii(e,p,S),S.applyMatrix4(t);const b=Xn(r),T=Dn(r,m);Ii(b,d,No),Ii(T,d,Go);const B=S.intersectsBox(No),w=S.intersectsBox(Go);x=B&&us(e,b,i,t,n,o,s,l,a+1,S,!u)||w&&us(e,T,i,t,n,o,s,l,a+1,S,!u),br.releasePrimitive(S)}else{const S=Xn(e),b=Dn(e,g);Ii(S,p,qd),Ii(b,p,Xd);const T=c.intersectsBox(qd),B=c.intersectsBox(Xd);if(T&&B)x=us(r,S,t,i,n,s,o,a,l+1,c,u)||us(r,b,t,i,n,s,o,a,l+1,c,u);else if(T)if(I)x=us(r,S,t,i,n,s,o,a,l+1,c,u);else{const w=br.getPrimitive();w.copy(qd).applyMatrix4(t);const R=Xn(r),D=Dn(r,m);Ii(R,d,No),Ii(D,d,Go);const G=w.intersectsBox(No),z=w.intersectsBox(Go);x=G&&us(S,R,i,t,n,o,s,l,a+1,w,!u)||z&&us(S,D,i,t,n,o,s,l,a+1,w,!u),br.releasePrimitive(w)}else if(B)if(I)x=us(r,b,t,i,n,s,o,a,l+1,c,u);else{const w=br.getPrimitive();w.copy(Xd).applyMatrix4(t);const R=Xn(r),D=Dn(r,m);Ii(R,d,No),Ii(D,d,Go);const G=w.intersectsBox(No),z=w.intersectsBox(Go);x=G&&us(b,R,i,t,n,o,s,l,a+1,w,!u)||z&&us(b,D,i,t,n,o,s,l,a+1,w,!u),br.releasePrimitive(w)}}return x}const xu=new hn,fv=new oi,hM={strategy:HC,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class nf{static serialize(e,t={}){t={cloneBuffers:!0,...t};const i=e.geometry,n=e._roots,s=e._indirectBuffer,o=i.getIndex();let a;return t.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o?o.array.slice():null,indirectBuffer:s?s.slice():null}:a={roots:n,index:o?o.array:null,indirectBuffer:s},a}static deserialize(e,t,i={}){i={setIndex:!0,indirect:!!e.indirectBuffer,...i};const{index:n,roots:s,indirectBuffer:o}=e,a=new nf(t,{...i,[Hd]:!0});if(a._roots=s,a._indirectBuffer=o||null,i.setIndex){const l=t.getIndex();if(l===null){const c=new Jt(e.index,1,!1);t.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...hM,[Hd]:!1},t),t.useSharedArrayBuffer&&!cM())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[Hd]||(bD(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new oi))),this.resolveTriangleIndex=t.indirect?i=>this._indirectBuffer[i]:i=>i}refit(e=null){return(this.indirect?ZD:GD)(this,e)}traverse(e,t=0){const i=this._roots[t],n=new Uint32Array(i),s=new Uint16Array(i);o(0);function o(a,l=0){const c=a*2,u=s[c+15]===ef;if(u){const h=n[a+6],f=s[c+14];e(l,u,new Float32Array(i,a*4,6),h,f)}else{const h=a+Lr/4,f=n[a+6],d=n[a+7];e(l,u,new Float32Array(i,a*4,6),d)||(o(h,l+1),o(f,l+1))}}}raycast(e,t=Yl,i=0,n=1/0){const s=this._roots,o=this.geometry,a=[],l=t.isMaterial,c=Array.isArray(t),u=o.groups,h=l?t.side:t,f=this.indirect?eM:VD;for(let d=0,m=s.length;d<m;d++){const A=c?t[u[d].materialIndex].side:h,p=a.length;if(f(this,d,A,e,a,i,n),c){const g=u[d].materialIndex;for(let v=p,E=a.length;v<E;v++)a[v].face.materialIndex=g}}return a}raycastFirst(e,t=Yl,i=0,n=1/0){const s=this._roots,o=this.geometry,a=t.isMaterial,l=Array.isArray(t);let c=null;const u=o.groups,h=a?t.side:t,f=this.indirect?iM:$D;for(let d=0,m=s.length;d<m;d++){const A=l?t[u[d].materialIndex].side:h,p=f(this,d,A,e,i,n);p!=null&&(c==null||p.distance<c.distance)&&(c=p,l&&(p.face.materialIndex=u[d].materialIndex))}return c}intersectsGeometry(e,t){let i=!1;const n=this._roots,s=this.indirect?nM:jD;for(let o=0,a=n.length;o<a&&(i=s(this,o,e,t),!i);o++);return i}shapecast(e){const t=Jn.getPrimitive(),i=this.indirect?HD:ND;let{boundsTraverseOrder:n,intersectsBounds:s,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(f,d,m,A,p)=>h(f,d,m,A,p)?!0:i(f,d,this,a,m,A,t)}else o||(a?o=(h,f,d,m)=>i(h,f,this,a,d,m,t):o=(h,f,d)=>d);let l=!1,c=0;const u=this._roots;for(let h=0,f=u.length;h<f;h++){const d=u[h];if(l=LD(this,h,s,o,n,c),l)break;c+=d.byteLength}return Jn.releasePrimitive(t),l}bvhcast(e,t,i){let{intersectsRanges:n,intersectsTriangles:s}=i;const o=Jn.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?m=>{const A=this.resolveTriangleIndex(m);Li(o,A*3,a,l)}:m=>{Li(o,m*3,a,l)},u=Jn.getPrimitive(),h=e.geometry.index,f=e.geometry.attributes.position,d=e.indirect?m=>{const A=e.resolveTriangleIndex(m);Li(u,A*3,h,f)}:m=>{Li(u,m*3,h,f)};if(s){const m=(A,p,g,v,E,C,I,_)=>{for(let x=g,S=g+v;x<S;x++){d(x),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let b=A,T=A+p;b<T;b++)if(c(b),o.needsUpdate=!0,s(o,u,b,x,E,C,I,_))return!0}return!1};if(n){const A=n;n=function(p,g,v,E,C,I,_,x){return A(p,g,v,E,C,I,_,x)?!0:m(p,g,v,E,C,I,_,x)}}else n=m}return uM(this,e,t,n)}intersectsBox(e,t){return xu.set(e.min,e.max,t),xu.needsUpdate=!0,this.shapecast({intersectsBounds:i=>xu.intersectsBox(i),intersectsTriangle:i=>xu.intersectsTriangle(i)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},n={},s=0,o=1/0){return(this.indirect?lM:JD)(this,e,t,i,n,s,o)}closestPointToPoint(e,t={},i=0,n=1/0){return PD(this,e,t,i,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(i=>{Ii(0,new Float32Array(i),fv),e.union(fv)}),e}}function dv(r,e,t){return r===null?null:(r.point.applyMatrix4(e.matrixWorld),r.distance=r.point.distanceTo(t.ray.origin),r.object=e,r)}const mv=I_||null,Su=new Ia,Av=new K,pv=new Me,fM=je.prototype.raycast,dM=mv!==null?mv.prototype.raycast:null,gv=new K,Ji=new je,Tu=[];function qC(r,e){this.isBatchedMesh?mM.call(this,r,e):AM.call(this,r,e)}function mM(r,e){if(this.boundsTrees){const t=this.boundsTrees,i=this._drawInfo,n=this._drawRanges,s=this.matrixWorld;Ji.material=this.material,Ji.geometry=this.geometry;const o=Ji.geometry.boundsTree,a=Ji.geometry.drawRange;Ji.geometry.boundingSphere===null&&(Ji.geometry.boundingSphere=new un);for(let l=0,c=i.length;l<c;l++){if(!this.getVisibleAt(l))continue;const u=i[l].geometryIndex;if(Ji.geometry.boundsTree=t[u],this.getMatrixAt(l,Ji.matrixWorld).premultiply(s),!Ji.geometry.boundsTree){this.getBoundingBoxAt(u,Ji.geometry.boundingBox),this.getBoundingSphereAt(u,Ji.geometry.boundingSphere);const h=n[u];Ji.geometry.setDrawRange(h.start,h.count)}Ji.raycast(r,Tu);for(let h=0,f=Tu.length;h<f;h++){const d=Tu[h];d.object=this,d.batchId=l,e.push(d)}Tu.length=0}Ji.geometry.boundsTree=o,Ji.geometry.drawRange=a,Ji.material=null,Ji.geometry=null}else dM.call(this,r,e)}function AM(r,e){if(this.geometry.boundsTree){if(this.material===void 0)return;pv.copy(this.matrixWorld).invert(),Su.copy(r.ray).applyMatrix4(pv),gv.setFromMatrixScale(this.matrixWorld),Av.copy(Su.direction).multiply(gv);const t=Av.length(),i=r.near/t,n=r.far/t,s=this.geometry.boundsTree;if(r.firstHitOnly===!0){const o=dv(s.raycastFirst(Su,this.material,i,n),this,r);o&&e.push(o)}else{const o=s.raycast(Su,this.material,i,n);for(let a=0,l=o.length;a<l;a++){const c=dv(o[a],this,r);c&&e.push(c)}}}else fM.call(this,r,e)}function XC(r={}){return this.boundsTree=new nf(this,r),this.boundsTree}function JC(){this.boundsTree=null}function pM(r){switch(r){case 1:return"R";case 2:return"RG";case 3:return"RGBA";case 4:return"RGBA"}throw new Error}function gM(r){switch(r){case 1:return Fs;case 2:return Xo;case 3:return Mi;case 4:return Mi}}function yv(r){switch(r){case 1:return __;case 2:return Z2;case 3:return ih;case 4:return ih}}class ZC extends Fr{constructor(){super(),this.minFilter=li,this.magFilter=li,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,i=e.itemSize,n=e.count;if(t!==null){if(i*n%t!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=n*i/t}const s=e.itemSize,o=e.count,a=e.normalized,l=e.array.constructor,c=l.BYTES_PER_ELEMENT;let u=this._forcedType,h=s;if(u===null)switch(l){case Float32Array:u=hi;break;case Uint8Array:case Uint16Array:case Uint32Array:u=no;break;case Int8Array:case Int16Array:case Int32Array:u=Nu;break}let f,d,m,A,p=pM(s);switch(u){case hi:m=1,d=gM(s),a&&c===1?(A=l,p+="8",l===Uint8Array?f=$i:(f=D0,p+="_SNORM")):(A=Float32Array,p+="32F",f=hi);break;case Nu:p+=c*8+"I",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=yv(s),c===1?(A=Int8Array,f=D0):c===2?(A=Int16Array,f=J2):(A=Int32Array,f=Nu);break;case no:p+=c*8+"UI",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=yv(s),c===1?(A=Uint8Array,f=$i):c===2?(A=Uint16Array,f=Mh):(A=Uint32Array,f=no);break}h===3&&(d===Mi||d===ih)&&(h=4);const g=Math.ceil(Math.sqrt(o))||1,v=h*g*g,E=new A(v),C=e.normalized;e.normalized=!1;for(let I=0;I<o;I++){const _=h*I;E[_]=e.getX(I)/m,s>=2&&(E[_+1]=e.getY(I)/m),s>=3&&(E[_+2]=e.getZ(I)/m,h===4&&(E[_+3]=1)),s>=4&&(E[_+3]=e.getW(I)/m)}e.normalized=C,this.internalFormat=p,this.format=d,this.type=f,this.image.width=g,this.image.height=g,this.image.data=E,this.needsUpdate=!0,this.dispose(),e.itemSize=i,e.count=n}}class yM extends ZC{constructor(){super(),this._forcedType=no}}class vM extends ZC{constructor(){super(),this._forcedType=hi}}class eI{constructor(){this.index=new yM,this.position=new vM,this.bvhBounds=new Fr,this.bvhContents=new Fr,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(CM(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const i=e._indirectBuffer;if(this._cachedIndexAttr===null||this._cachedIndexAttr.count!==i.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const n=KC(VC(t));this._cachedIndexAttr=new Jt(n,1,!1)}EM(t,i,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:i,bvhContents:n}=this;e&&e.dispose(),t&&t.dispose(),i&&i.dispose(),n&&n.dispose()}}function EM(r,e,t){const i=t.array,n=r.index?r.index.array:null;for(let s=0,o=e.length;s<o;s++){const a=3*s,l=3*e[s];for(let c=0;c<3;c++)i[a+c]=n?n[l+c]:l+c}}function CM(r,e,t){const i=r._roots;if(i.length!==1)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const n=i[0],s=new Uint16Array(n),o=new Uint32Array(n),a=new Float32Array(n),l=n.byteLength/Lr,c=2*Math.ceil(Math.sqrt(l/2)),u=new Float32Array(4*c*c),h=Math.ceil(Math.sqrt(l)),f=new Uint32Array(2*h*h);for(let d=0;d<l;d++){const m=d*Lr/4,A=m*2,p=m;for(let g=0;g<3;g++)u[8*d+0+g]=a[p+0+g],u[8*d+4+g]=a[p+3+g];if(cn(A,s)){const g=Rn(A,s),v=Cn(m,o),E=4294901760|g;f[d*2+0]=E,f[d*2+1]=v}else{const g=4*Dn(m,o)/Lr,v=HA(m,o);f[d*2+0]=v,f[d*2+1]=g}}e.image.data=u,e.image.width=c,e.image.height=c,e.format=Mi,e.type=hi,e.internalFormat="RGBA32F",e.minFilter=li,e.magFilter=li,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),t.image.data=f,t.image.width=h,t.image.height=h,t.format=Z2,t.type=no,t.internalFormat="RG32UI",t.minFilter=li,t.magFilter=li,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose()}const IM=`

// A stack of uint32 indices can can store the indices for
// a perfectly balanced tree with a depth up to 31. Lower stack
// depth gets higher performance.
//
// However not all trees are balanced. Best value to set this to
// is the trees max depth.
#ifndef BVH_STACK_DEPTH
#define BVH_STACK_DEPTH 60
#endif

#ifndef INFINITY
#define INFINITY 1e20
#endif

// Utilities
uvec4 uTexelFetch1D( usampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

ivec4 iTexelFetch1D( isampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 texelFetch1D( sampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {

	return
		barycoord.x * texelFetch1D( tex, faceIndices.x ) +
		barycoord.y * texelFetch1D( tex, faceIndices.y ) +
		barycoord.z * texelFetch1D( tex, faceIndices.z );

}

void ndcToCameraRay(
	vec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,
	out vec3 rayOrigin, out vec3 rayDirection
) {

	// get camera look direction and near plane for camera clipping
	vec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );
	vec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );
	float near = abs( nearVector.z / nearVector.w );

	// get the camera direction and position from camera matrices
	vec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );
	direction /= direction.w;
	direction = cameraWorld * direction - origin;

	// slide the origin along the ray until it sits at the near clip plane position
	origin.xyz += direction.xyz * near / dot( direction, lookDirection );

	rayOrigin = origin.xyz;
	rayDirection = direction.xyz;

}
`,_M=`

#ifndef TRI_INTERSECT_EPSILON
#define TRI_INTERSECT_EPSILON 1e-5
#endif

// Raycasting
bool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {

	// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/
	// https://tavianator.com/2011/ray_box.html
	vec3 invDir = 1.0 / rayDirection;

	// find intersection distances for each plane
	vec3 tMinPlane = invDir * ( boundsMin - rayOrigin );
	vec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );

	// get the min and max distances from each intersection
	vec3 tMinHit = min( tMaxPlane, tMinPlane );
	vec3 tMaxHit = max( tMaxPlane, tMinPlane );

	// get the furthest hit distance
	vec2 t = max( tMinHit.xx, tMinHit.yz );
	float t0 = max( t.x, t.y );

	// get the minimum hit distance
	t = min( tMaxHit.xx, tMaxHit.yz );
	float t1 = min( t.x, t.y );

	// set distance to 0.0 if the ray starts inside the box
	dist = max( t0, 0.0 );

	return t1 >= dist;

}

bool intersectsTriangle(
	vec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,
	out vec3 barycoord, out vec3 norm, out float dist, out float side
) {

	// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d
	vec3 edge1 = b - a;
	vec3 edge2 = c - a;
	norm = cross( edge1, edge2 );

	float det = - dot( rayDirection, norm );
	float invdet = 1.0 / det;

	vec3 AO = rayOrigin - a;
	vec3 DAO = cross( AO, rayDirection );

	vec4 uvt;
	uvt.x = dot( edge2, DAO ) * invdet;
	uvt.y = - dot( edge1, DAO ) * invdet;
	uvt.z = dot( AO, norm ) * invdet;
	uvt.w = 1.0 - uvt.x - uvt.y;

	// set the hit information
	barycoord = uvt.wxy; // arranged in A, B, C order
	dist = uvt.z;
	side = sign( det );
	norm = side * normalize( norm );

	// add an epsilon to avoid misses between triangles
	uvt += vec4( TRI_INTERSECT_EPSILON );

	return all( greaterThanEqual( uvt, vec4( 0.0 ) ) );

}

bool intersectTriangles(
	// geometry info and triangle range
	sampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// outputs
	inout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	bool found = false;
	vec3 localBarycoord, localNormal;
	float localDist, localSide;
	for ( uint i = offset, l = offset + count; i < l; i ++ ) {

		uvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;
		vec3 a = texelFetch1D( positionAttr, indices.x ).rgb;
		vec3 b = texelFetch1D( positionAttr, indices.y ).rgb;
		vec3 c = texelFetch1D( positionAttr, indices.z ).rgb;

		if (
			intersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )
			&& localDist < minDistance
		) {

			found = true;
			minDistance = localDist;

			faceIndices = uvec4( indices.xyz, i );
			faceNormal = localNormal;

			side = localSide;
			barycoord = localBarycoord;
			dist = localDist;

		}

	}

	return found;

}

bool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {

	uint cni2 = currNodeIndex * 2u;
	vec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;
	vec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;
	return intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );

}

// use a macro to hide the fact that we need to expand the struct into separate fields
#define	bvhIntersectFirstHit(		bvh,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)	_bvhIntersectFirstHit(		bvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)

bool _bvhIntersectFirstHit(
	// bvh info
	sampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// output variables split into separate variables due to output precision
	inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	// stack needs to be twice as long as the deepest tree we expect because
	// we push both the left and right child onto the stack every traversal
	int ptr = 0;
	uint stack[ BVH_STACK_DEPTH ];
	stack[ 0 ] = 0u;

	float triangleDistance = INFINITY;
	bool found = false;
	while ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {

		uint currNodeIndex = stack[ ptr ];
		ptr --;

		// check if we intersect the current bounds
		float boundsHitDistance;
		if (
			! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )
			|| boundsHitDistance > triangleDistance
		) {

			continue;

		}

		uvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;
		bool isLeaf = bool( boundsInfo.x & 0xffff0000u );

		if ( isLeaf ) {

			uint count = boundsInfo.x & 0x0000ffffu;
			uint offset = boundsInfo.y;

			found = intersectTriangles(
				bvh_position, bvh_index, offset, count,
				rayOrigin, rayDirection, triangleDistance,
				faceIndices, faceNormal, barycoord, side, dist
			) || found;

		} else {

			uint leftIndex = currNodeIndex + 1u;
			uint splitAxis = boundsInfo.x & 0x0000ffffu;
			uint rightIndex = boundsInfo.y;

			bool leftToRight = rayDirection[ splitAxis ] >= 0.0;
			uint c1 = leftToRight ? leftIndex : rightIndex;
			uint c2 = leftToRight ? rightIndex : leftIndex;

			// set c2 in the stack so we traverse it later. We need to keep track of a pointer in
			// the stack while we traverse. The second pointer added is the one that will be
			// traversed first
			ptr ++;
			stack[ ptr ] = c2;

			ptr ++;
			stack[ ptr ] = c1;

		}

	}

	return found;

}
`,xM=`
struct BVH {

	usampler2D index;
	sampler2D position;

	sampler2D bvhBounds;
	usampler2D bvhContents;

};
`,SM=xM,TM=`
	${IM}
	${_M}
`,vv=r=>r.isMesh;function Tk(r,e){e={strategy:Zh,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...e},y.useEffect(()=>{if(r.current){r.current.raycast=qC;const t=r.current.geometry;return t.computeBoundsTree=XC,t.disposeBoundsTree=JC,t.computeBoundsTree(e),()=>{t.boundsTree&&t.disposeBoundsTree()}}},[r,JSON.stringify(e)])}const bk=y.forwardRef(({enabled:r=!0,firstHitOnly:e=!1,children:t,strategy:i=Zh,verbose:n=!1,setBoundingBox:s=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:l=!1,...c},u)=>{const h=y.useRef(null),f=de(d=>d.raycaster);return y.useImperativeHandle(u,()=>h.current,[]),y.useEffect(()=>{if(r){const d={strategy:i,verbose:n,setBoundingBox:s,maxDepth:o,maxLeafTris:a,indirect:l},m=h.current;return f.firstHitOnly=e,m.traverse(A=>{vv(A)&&!A.geometry.boundsTree&&A.raycast===je.prototype.raycast&&(A.raycast=qC,A.geometry.computeBoundsTree=XC,A.geometry.disposeBoundsTree=JC,A.geometry.computeBoundsTree(d))}),()=>{delete f.firstHitOnly,m.traverse(A=>{vv(A)&&A.geometry.boundsTree&&(A.geometry.disposeBoundsTree(),A.raycast=je.prototype.raycast)})}}},[]),y.createElement("group",_e({ref:h},c),t)});function wk(...r){const e=y.useRef([]);return e.current=r.map(t=>y.useContext(t)),y.useMemo(()=>({children:t})=>r.reduceRight((i,n,s)=>y.createElement(n.Provider,{value:e.current[s],children:i}),t),[])}function Bk(r,e){const t=y.useRef(),[i]=y.useState(()=>e?e instanceof Ei?{current:e}:e:t),[n]=y.useState(()=>new R2(void 0));y.useLayoutEffect(()=>{e&&(i.current=e instanceof Ei?e:e.current),n._root=i.current});const s=y.useRef({}),o=y.useMemo(()=>{const a={};return r.forEach(l=>Object.defineProperty(a,l.name,{enumerable:!0,get(){if(i.current)return s.current[l.name]||(s.current[l.name]=n.clipAction(l,i.current))},configurable:!0})),{ref:i,clips:r,actions:a,names:r.map(l=>l.name),mixer:n}},[r]);return We((a,l)=>n.update(l)),y.useEffect(()=>{const a=i.current;return()=>{s.current={},n.stopAllAction(),Object.values(o.actions).forEach(l=>{a&&n.uncacheAction(l,a)})}},[r]),o}function bM(r){const e=y.useRef(null),t=y.useRef(!1),i=y.useRef(!1),n=y.useRef(r);return y.useLayoutEffect(()=>void(n.current=r),[r]),y.useEffect(()=>{const s=e.current;if(s){const o=Mm(()=>(t.current=!1,!0)),a=s.onBeforeRender;s.onBeforeRender=()=>t.current=!0;const l=zm(()=>(t.current!==i.current&&(n.current==null||n.current(i.current=t.current)),!0));return()=>{s.onBeforeRender=a,o(),l()}}},[]),e}const wM=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );
  #ifdef BOX_PROJECTED_ENV_MAP
    vWorldPosition = worldPosition.xyz;
  #endif
#endif
`,BM=`
#ifdef BOX_PROJECTED_ENV_MAP
  uniform vec3 envMapSize;
  uniform vec3 envMapPosition;
  varying vec3 vWorldPosition;
    
  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {
    vec3 nDir = normalize( v );
    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbminmax;
    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;
    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
    vec3 boxIntersection = vWorldPosition + nDir * correction;    
    return boxIntersection - cubePos;
  }
#endif
`,RM=`
#ifdef BOX_PROJECTED_ENV_MAP
  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );
#endif
`,DM=`
#ifdef BOX_PROJECTED_ENV_MAP
  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );
#endif
`;function MM(r,e,t){r.defines.BOX_PROJECTED_ENV_MAP=!0,r.uniforms.envMapPosition={value:e},r.uniforms.envMapSize={value:t},r.vertexShader=`
  varying vec3 vWorldPosition;
  ${r.vertexShader.replace("#include <worldpos_vertex>",wM)}`,r.fragmentShader=`
    ${BM}
    ${r.fragmentShader.replace("#include <envmap_physical_pars_fragment>",Zo.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
         ${RM}
         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
         ${DM}
        `)}`}function Rk(r=new K,e=new K){const[t]=y.useState(()=>({position:new K,size:new K}));wn(t,{position:r,size:e});const i=y.useRef(null),n=y.useMemo(()=>({ref:i,onBeforeCompile:s=>MM(s,t.position,t.size),customProgramCacheKey:()=>JSON.stringify(t.position.toArray())+JSON.stringify(t.size.toArray())}),[...t.position.toArray(),...t.size.toArray()]);return y.useLayoutEffect(()=>void(i.current.needsUpdate=!0),[t]),n}const Ev=new oi,bu=new K,Dk=({anchor:r,...e})=>{const t=y.useRef(null),i=y.useRef(null);return y.useEffect(()=>{var n;(n=t.current)!=null&&(n=n.parent)!=null&&n.parent&&(i.current=t.current.parent,t.current.parent.parent.add(t.current))},[]),We(()=>{i.current&&(Ev.setFromObject(i.current),Ev.getSize(bu),t.current.position.set(i.current.position.x+bu.x*(Array.isArray(r)?r[0]:r.x)/2,i.current.position.y+bu.y*(Array.isArray(r)?r[1]:r.y)/2,i.current.position.z+bu.z*(Array.isArray(r)?r[2]:r.z)/2))}),y.createElement("group",_e({ref:t},e))};function LM(r,e,t=.9){return e*t+r*(1-t)}const PM=r=>Math.sqrt(1-Math.pow(r-1,2));class FM{constructor({size:e=256,maxAge:t=750,radius:i=.3,intensity:n=.2,interpolate:s=0,smoothing:o=0,minForce:a=.3,blend:l="screen",ease:c=PM}={}){this.size=e,this.maxAge=t,this.radius=i,this.intensity=n,this.ease=c,this.interpolate=s,this.smoothing=o,this.minForce=a,this.blend=l,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(e===null)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new tn(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach((t,i)=>{t.age+=e*1e3,t.age>this.maxAge&&this.trail.splice(i,1)}),this.trail.length||(this.force=0),this.trail.forEach(t=>{this.drawTouch(t)}),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const i=t.x-e.x,n=t.y-e.y,s=i*i+n*n,o=Math.max(this.minForce,Math.min(s*1e4,1));if(this.force=LM(o,this.force,this.smoothing),this.interpolate){const a=Math.ceil(s/Math.pow(this.radius*.5/this.interpolate,2));if(a>1)for(let l=1;l<a;l++)this.trail.push({x:t.x-i/a*l,y:t.y-n/a*l,age:0,force:o})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let i=1;e.age<this.maxAge*.3?i=this.ease(e.age/(this.maxAge*.3)):i=this.ease(1-(e.age-this.maxAge*.3)/(this.maxAge*.7)),i*=e.force,this.ctx.globalCompositeOperation=this.blend;const n=this.size*this.radius*i,s=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,n*.25),t.x,t.y,Math.max(0,n));s.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),s.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=s,this.ctx.arc(t.x,t.y,Math.max(0,n),0,Math.PI*2),this.ctx.fill()}}function kM(r={}){const{size:e,maxAge:t,radius:i,intensity:n,interpolate:s,smoothing:o,minForce:a,blend:l,ease:c}=r,u=y.useMemo(()=>new FM(r),[e,t,i,n,s,o,a,l,c]);We((f,d)=>void u.update(d));const h=y.useCallback(f=>u.addTouch(f.uv),[u]);return[u.texture,h]}const Mk=({children:r,...e})=>{const t=kM(e);return y.createElement(y.Fragment,null,r?.(t))},tI=y.forwardRef(function({children:e,disable:t,disableX:i,disableY:n,disableZ:s,left:o,right:a,top:l,bottom:c,front:u,back:h,onCentered:f,precise:d=!0,cacheKey:m=0,...A},p){const g=y.useRef(null),v=y.useRef(null),E=y.useRef(null);return y.useLayoutEffect(()=>{v.current.matrixWorld.identity();const C=new oi().setFromObject(E.current,d),I=new K,_=new un,x=C.max.x-C.min.x,S=C.max.y-C.min.y,b=C.max.z-C.min.z;C.getCenter(I),C.getBoundingSphere(_);const T=l?S/2:c?-S/2:0,B=o?-x/2:a?x/2:0,w=u?b/2:h?-b/2:0;v.current.position.set(t||i?0:-I.x+B,t||n?0:-I.y+T,t||s?0:-I.z+w),typeof f<"u"&&f({parent:g.current.parent,container:g.current,width:x,height:S,depth:b,boundingBox:C,boundingSphere:_,center:I,verticalAlignment:T,horizontalAlignment:B,depthAlignment:w})},[m,f,l,o,u,t,i,n,s,d,a,c,h]),y.useImperativeHandle(p,()=>g.current,[]),y.createElement("group",_e({ref:g},A),y.createElement("group",{ref:v},y.createElement("group",{ref:E},e)))}),Lk=y.forwardRef(({font:r,color:e="#cbcbcb",bevelSize:t=.04,debug:i=!1,children:n,...s},o)=>{const[a,l]=y.useState(0),c=y.useCallback((f=1)=>l(a+f),[a]),u=y.useCallback((f=1)=>l(a-f),[a]),h=y.useMemo(()=>({incr:c,decr:u}),[c,u]);return y.useImperativeHandle(o,()=>h,[h]),y.createElement("group",s,y.createElement(y.Suspense,{fallback:null},y.createElement(tI,{top:!0,cacheKey:JSON.stringify({counter:a,font:r})},y.createElement(ww,{bevelEnabled:!0,bevelSize:t,font:r},i?y.createElement("meshNormalMaterial",{wireframe:!0}):y.createElement("meshStandardMaterial",{color:e}),a))),n)});var Zd={exports:{}},e0,Cv;function OM(){if(Cv)return e0;Cv=1;var r="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";return e0=r,e0}var t0,Iv;function UM(){if(Iv)return t0;Iv=1;var r=OM();function e(){}function t(){}return t.resetWarningCache=e,t0=function(){function i(o,a,l,c,u,h){if(h!==r){var f=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw f.name="Invariant Violation",f}}i.isRequired=i;function n(){return i}var s={array:i,bigint:i,bool:i,func:i,number:i,object:i,string:i,symbol:i,any:i,arrayOf:n,element:i,elementType:i,instanceOf:n,node:i,objectOf:n,oneOf:n,oneOfType:n,shape:n,exact:n,checkPropTypes:t,resetWarningCache:e};return s.PropTypes=s,s},t0}var _v;function NM(){return _v||(_v=1,Zd.exports=UM()()),Zd.exports}var GM=NM();const Al=Qm(GM);function iI(r){return nI(r.children,r.components)}iI.propTypes={children:Al.func.isRequired,components:Al.arrayOf(Al.oneOfType([Al.element,Al.func])).isRequired};function nI(r,e,t){if(t=t||[],!e[0])return r(t);function i(n){return nI(r,e.slice(1),t.concat([n]))}return typeof e[0]=="function"?e[0]({results:t,render:i}):y.cloneElement(e[0],{children:i})}const Vl=(r,e)=>{"updateRanges"in r?r.updateRanges[0]=e:r.updateRange=e},QM=3e3,zM=3001;function HM(r){return typeof r=="function"}const xv=new Me,Sv=new Me,wu=[],pl=new je;class VM extends or{constructor(){super(),this.color=new et("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){const i=this.instance.current;if(!i||!i.geometry||!i.material)return;pl.geometry=i.geometry;const n=i.matrixWorld,s=i.userData.instances.indexOf(this.instanceKey);if(!(s===-1||s>i.count)){i.getMatrixAt(s,xv),Sv.multiplyMatrices(n,xv),pl.matrixWorld=Sv,i.material instanceof Uu?pl.material.side=i.material.side:pl.material.side=i.material[0].side,pl.raycast(e,wu);for(let o=0,a=wu.length;o<a;o++){const l=wu[o];l.instanceId=s,l.object=this,t.push(l)}wu.length=0}}}const sI=y.createContext(null),Tv=new Me,bv=new Me,KM=new Me,wv=new K,Bv=new ht,Rv=new K,$M=r=>r.isInstancedBufferAttribute,$A=y.forwardRef(({context:r,children:e,...t},i)=>{y.useMemo(()=>xi({PositionMesh:VM}),[]);const n=y.useRef();y.useImperativeHandle(i,()=>n.current,[]);const{subscribe:s,getParent:o}=y.useContext(r||sI);return y.useLayoutEffect(()=>s(n),[]),y.createElement("positionMesh",_e({instance:o(),instanceKey:n,ref:n},t),e)}),jA=y.forwardRef(({context:r,children:e,range:t,limit:i=1e3,frames:n=1/0,...s},o)=>{const[{localContext:a,instance:l}]=y.useState(()=>{const v=y.createContext(null);return{localContext:v,instance:y.forwardRef((E,C)=>y.createElement($A,_e({context:v},E,{ref:C})))}}),c=y.useRef(null);y.useImperativeHandle(o,()=>c.current,[]);const[u,h]=y.useState([]),[[f,d]]=y.useState(()=>{const v=new Float32Array(i*16);for(let E=0;E<i;E++)KM.identity().toArray(v,E*16);return[v,new Float32Array([...new Array(i*3)].map(()=>1))]});y.useEffect(()=>{c.current.instanceMatrix.needsUpdate=!0});let m=0,A=0;const p=y.useRef([]);y.useLayoutEffect(()=>{p.current=Object.entries(c.current.geometry.attributes).filter(([v,E])=>$M(E))}),We(()=>{if(n===1/0||m<n){c.current.updateMatrix(),c.current.updateMatrixWorld(),Tv.copy(c.current.matrixWorld).invert(),A=Math.min(i,t!==void 0?t:i,u.length),c.current.count=A,Vl(c.current.instanceMatrix,{offset:0,count:A*16}),Vl(c.current.instanceColor,{offset:0,count:A*3});for(let v=0;v<u.length;v++){const E=u[v].current;E.matrixWorld.decompose(wv,Bv,Rv),bv.compose(wv,Bv,Rv).premultiply(Tv),bv.toArray(f,v*16),c.current.instanceMatrix.needsUpdate=!0,E.color.toArray(d,v*3),c.current.instanceColor.needsUpdate=!0}m++}});const g=y.useMemo(()=>({getParent:()=>c,subscribe:v=>(h(E=>[...E,v]),()=>h(E=>E.filter(C=>C.current!==v.current)))}),[]);return y.createElement("instancedMesh",_e({userData:{instances:u,limit:i,frames:n},matrixAutoUpdate:!1,ref:c,args:[null,null,0],raycast:()=>null},s),y.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:f.length/16,array:f,itemSize:16,usage:nn}),y.createElement("instancedBufferAttribute",{attach:"instanceColor",count:d.length/3,array:d,itemSize:3,usage:nn}),HM(e)?y.createElement(a.Provider,{value:g},e(l)):r?y.createElement(r.Provider,{value:g},e):y.createElement(sI.Provider,{value:g},e))}),Pk=y.forwardRef(function({meshes:e,children:t,...i},n){const s=Array.isArray(e);if(!s)for(const o of Object.keys(e))e[o].isMesh||delete e[o];return y.createElement("group",{ref:n},y.createElement(iI,{components:(s?e:Object.values(e)).map(({geometry:o,material:a})=>y.createElement(jA,_e({key:o.uuid,geometry:o,material:a},i)))},o=>s?t(...o):t(Object.keys(e).filter(a=>e[a].isMesh).reduce((a,l,c)=>({...a,[l]:o[c]}),{}))))});function Fk(){const r=y.createContext(null);return[y.forwardRef((e,t)=>y.createElement(jA,_e({ref:t,context:r},e))),y.forwardRef((e,t)=>y.createElement($A,_e({ref:t,context:r},e)))]}const kk=y.forwardRef(({name:r,defaultValue:e,normalized:t,usage:i=nn},n)=>{const s=y.useRef(null);y.useImperativeHandle(n,()=>s.current,[]),y.useLayoutEffect(()=>{const a=s.current.__r3f.parent;a.geometry.attributes[r]=s.current;const l=Array.isArray(e)?e:[e],c=Array.from({length:a.userData.limit},()=>l).flat();return s.current.array=new Float32Array(c),s.current.itemSize=l.length,s.current.count=c.length/s.current.itemSize,()=>{delete a.geometry.attributes[r]}},[r]);let o=0;return We(()=>{const a=s.current.__r3f.parent;if(a.userData.frames===1/0||o<a.userData.frames){for(let l=0;l<a.userData.instances.length;l++){const u=a.userData.instances[l].current[r];u!==void 0&&(s.current.set(Array.isArray(u)?u:typeof u.toArray=="function"?u.toArray():[u],l*s.current.itemSize),s.current.needsUpdate=!0)}o++}}),y.createElement("instancedBufferAttribute",{ref:s,usage:i,normalized:t})}),rI=y.createContext(null);function Ok(){return y.useContext(rI)}function jM(r){return r!==null&&"meta"in r&&"frames"in r}const Dv=new an(1,1),Uk=y.forwardRef(({startFrame:r=0,endFrame:e,fps:t=30,frameName:i="",textureDataURL:n,textureImageURL:s,loop:o=!1,numberOfFrames:a=1,autoPlay:l=!0,animationNames:c,onStart:u,onEnd:h,onLoopEnd:f,onFrame:d,play:m,pause:A=!1,flipX:p=!1,alphaTest:g=0,children:v,asSprite:E=!1,offset:C,playBackwards:I=!1,resetOnEnd:_=!1,maxItems:x=1,instanceItems:S=[[0,0,0]],spriteDataset:b,canvasRenderingContext2DSettings:T,roundFramePosition:B=!1,meshProps:w={},...R},D)=>{const G=y.useRef(new or),z=y.useRef(null),W=y.useRef(null),q=y.useRef(null),F=y.useRef(window.performance.now()),N=y.useRef(r),L=y.useRef(i),$=t>0?1e3/t:0,[j,V]=y.useState(new tn),k=y.useRef(0),[Q,O]=y.useState(new K(1,1,1)),U=p?-1:1,te=y.useRef(A),le=y.useRef(C),ee=y.useRef(!1),{spriteObj:se,loadJsonAndTexture:Ee}=zA(null,null,c,a,void 0,T),Ie=y.useRef(i),oe=y.useCallback((Te,we)=>{if(we===null)a&&(k.current=a,I&&(N.current=a-1),z.current=we);else{var Le,Be;z.current=we,z.current&&Array.isArray(z.current.frames)?k.current=z.current.frames.length:z.current&&typeof z.current=="object"&&Ie.current?k.current=z.current.frames[Ie.current].length:k.current=0,I&&(N.current=k.current-1);const{w:qe,h:Oe}=Xu((Le=(Be=z.current)==null?void 0:Be.frames)!==null&&Le!==void 0?Le:[],Ie.current).sourceSize,Ke=he(qe,Oe);O(Ke),W.current&&(W.current.map=Te)}V(Te)},[a,I]),ce=y.useCallback(()=>{if(!z.current)return;const{meta:{size:Te},frames:we}=z.current,{w:Le,h:Be}=Array.isArray(we)?we[0].sourceSize:i?we[i]?we[i][0].sourceSize:{w:0,h:0}:{w:0,h:0};W.current&&W.current.map&&(W.current.map.wrapS=W.current.map.wrapT=Ln,W.current.map.center.set(0,0),W.current.map.repeat.set(1*U/(Te.w/Le),1/(Te.h/Be)));const Oe=1/((Te.h-1)/Be);W.current&&W.current.map&&(W.current.map.offset.x=0,W.current.map.offset.y=1-Oe),u&&u({currentFrameName:i??"",currentFrame:N.current})},[U,i,u]),Ae=y.useMemo(()=>({current:le.current,offset:le.current,imageUrl:s,hasEnded:!1,ref:D}),[s,D]);y.useImperativeHandle(D,()=>G.current,[]),y.useLayoutEffect(()=>{le.current=C},[C]);const he=(Te,we)=>{var Le;const Be=new K,qe=we/Te;return Be.set(1,qe,1),(Le=q.current)==null||Le.scale.copy(Be),Be};y.useEffect(()=>{if(b){var Te;oe(b==null||(Te=b.spriteTexture)==null?void 0:Te.clone(),b.spriteData)}else s&&n&&Ee(s,n)},[Ee,b,n,s,oe]),y.useEffect(()=>{if(se){var Te;oe(se==null||(Te=se.spriteTexture)==null?void 0:Te.clone(),se?.spriteData)}},[se,oe]),y.useEffect(()=>{if(Ae.hasEnded=!1,z.current&&I===!0){var Te;N.current=((Te=z.current.frames.length)!==null&&Te!==void 0?Te:0)-1}else N.current=0},[I,Ae]),y.useLayoutEffect(()=>{ce()},[j,p,ce]),y.useEffect(()=>{l&&(te.current=!1)},[l]),y.useLayoutEffect(()=>{if(L.current!==i&&i&&(N.current=0,L.current=i,Ae.hasEnded=!1,$<=0&&(N.current=e||r||0),z.current)){const{w:Te,h:we}=Xu(z.current.frames,i).sourceSize,Le=he(Te,we);O(Le)}},[i,$,Ae,e,r]);const Z=()=>{if(!jM(z.current))return;const{meta:{size:Te},frames:we}=z.current,{w:Le,h:Be}=Xu(we,i).sourceSize,qe=Array.isArray(we)?we:i?we[i]:[],Oe=e||qe.length-1;var Ke=C===void 0?Ae.current:C;if($<=0){N.current=e||r||0,J(Le,Be,Te,qe);return}const $e=window.performance.now(),Ze=$e-F.current;if(!(Ze<=$)){var ut=I?N.current<0:N.current>Oe,Ct=I?N.current===Oe:N.current===0,lt=I?N.current<0:N.current>=Oe;if(ut){if(N.current=o?r??0:0,I&&(N.current=Oe),o?f?.({currentFrameName:i??"",currentFrame:N.current}):(h?.({currentFrameName:i??"",currentFrame:N.current}),Ae.hasEnded=!_,_&&(te.current=!0)),!o)return}else Ct&&u?.({currentFrameName:i??"",currentFrame:N.current});Ke!==void 0&&lt?ee.current===!1&&(h?.({currentFrameName:i??"",currentFrame:N.current}),ee.current=!0):ee.current=!1,!(Ze<=$)&&(F.current=$e-Ze%$,J(Le,Be,Te,qe))}},J=(Te,we,Le,Be)=>{var qe=C===void 0?Ae.current:C;const Oe=N.current;let Ke=0,$e=0;he(Te,we);const Ze=B?Math.round((Le.w-1)/Te):(Le.w-1)/Te,ut=B?Math.round((Le.h-1)/we):(Le.h-1)/we;if(!Be[Oe])return;const{frame:{x:Ct,y:lt},sourceSize:{w:tt,h:Je}}=Be[Oe],re=1/Ze,Re=1/ut;if(W.current&&W.current.map&&(Ke=U>0?re*(Ct/tt):re*(Ct/tt)-W.current.map.repeat.x,$e=Math.abs(1-Re)-Re*(lt/Je),W.current.map.offset.x=Ke,W.current.map.offset.y=$e),qe!=null){let Ue=Math.floor(qe*Be.length);Ue=Math.max(0,Math.min(Ue,Be.length-1)),isNaN(Ue)&&(Ue=0),N.current=Ue}else I?N.current-=1:N.current+=1};We((Te,we)=>{var Le,Be;!((Le=z.current)!=null&&Le.frames)||!((Be=W.current)!=null&&Be.map)||te.current||!Ae.hasEnded&&(l||m)&&(Z(),d?.({currentFrameName:L.current,currentFrame:N.current}))});function ue(Te=new K(1,1,1),we=1){if(typeof we=="number")return Te.multiplyScalar(we);if(Array.isArray(we))return Te.multiply(new K(...we));if(we instanceof K)return Te.multiply(we)}return y.createElement("group",_e({},R,{ref:G,scale:ue(Q,R.scale)}),y.createElement(rI.Provider,{value:Ae},E&&y.createElement(Cb,null,y.createElement("mesh",_e({ref:q,scale:1,geometry:Dv},w),y.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:wi,ref:W,map:j,transparent:!0,alphaTest:g??0}))),!E&&y.createElement(jA,_e({geometry:Dv,limit:x??1},w),y.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:wi,ref:W,map:j,transparent:!0,alphaTest:g??0}),(S??[0]).map((Te,we)=>y.createElement($A,_e({key:we,ref:S?.length===1?q:null,position:Te,scale:1},w)))),v))}),Nk=y.forwardRef(({children:r,curve:e},t)=>{const[i]=y.useState(()=>new Nr),[n,s]=y.useState(),o=y.useRef(null);return y.useLayoutEffect(()=>{o.current=new IS(i.children[0]),s(o.current.object3D)},[r]),y.useEffect(()=>{var a;e&&((a=o.current)==null||a.updateCurve(0,e))},[e]),y.useImperativeHandle(t,()=>o.current),y.createElement(y.Fragment,null,uo(r,i),n&&y.createElement("primitive",{object:n}))});var YM=`#define GLSLIFY 1
vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;class WM extends es{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`
      uniform float time;
      uniform float radius;
      uniform float distort;
      ${YM}
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`
        float updateTime = time / 50.0;
        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));
        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));
        `)}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const Gk=y.forwardRef(({speed:r=1,...e},t)=>{const[i]=y.useState(()=>new WM);return We(n=>i&&(i.time=n.clock.elapsedTime*r)),y.createElement("primitive",_e({object:i,ref:t,attach:"material"},e))});class qM extends bh{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`
      uniform float time;
      uniform float factor;
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`float theta = sin( time + position.y ) / 2.0 * factor;
        float c = cos( theta );
        float s = sin( theta );
        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );
        vec3 transformed = vec3( position ) * m;
        vNormal = vNormal * m;`)}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const Qk=y.forwardRef(({speed:r=1,...e},t)=>{const[i]=y.useState(()=>new qM);return We(n=>i&&(i.time=n.clock.elapsedTime*r)),y.createElement("primitive",_e({object:i,ref:t,attach:"material"},e))});class XM extends bi{constructor(e=new Fe){super({uniforms:{inputBuffer:new Sn(null),depthBuffer:new Sn(null),resolution:new Sn(new Fe),texelSize:new Sn(new Fe),halfTexelSize:new Sn(new Fe),kernel:new Sn(0),scale:new Sn(1),cameraNear:new Sn(0),cameraFar:new Sn(1),minDepthThreshold:new Sn(0),maxDepthThreshold:new Sn(1),depthScale:new Sn(0),depthToBlurRatioBias:new Sn(.25)},fragmentShader:`#include <common>
        #include <dithering_pars_fragment>      
        uniform sampler2D inputBuffer;
        uniform sampler2D depthBuffer;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          float depthFactor = 0.0;
          
          #ifdef USE_DEPTH
            vec4 depth = texture2D(depthBuffer, vUv);
            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
            depthFactor *= depthScale;
            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));
          #endif
          
          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));
          gl_FragColor = sum * 0.25 ;

          #include <dithering_fragment>
          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }`,vertexShader:`uniform vec2 texelSize;
        uniform vec2 halfTexelSize;
        uniform float kernel;
        uniform float scale;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          vec2 uv = position.xy * 0.5 + 0.5;
          vUv = uv;

          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;
          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);
          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);
          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);
          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);

          gl_Position = vec4(position.xy, 1.0, 1.0);
        }`,blending:Fm,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class oI{constructor({gl:e,resolution:t,width:i=500,height:n=500,minDepthThreshold:s=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:l=.25}){this.renderToScreen=!1,this.renderTargetA=new _i(t,t,{minFilter:jt,magFilter:jt,stencilBuffer:!1,depthBuffer:!1,type:Ai}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new XM,this.convolutionMaterial.setTexelSize(1/i,1/n),this.convolutionMaterial.setResolution(new Fe(i,n)),this.scene=new Nr,this.camera=new X2,this.convolutionMaterial.uniforms.minDepthThreshold.value=s,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=l,this.convolutionMaterial.defines.USE_DEPTH=a>0;const c=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),u=new Float32Array([0,0,2,0,0,2]),h=new Gi;h.setAttribute("position",new Jt(c,3)),h.setAttribute("uv",new Jt(u,2)),this.screen=new je(h,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,i){const n=this.scene,s=this.camera,o=this.renderTargetA,a=this.renderTargetB;let l=this.convolutionMaterial,c=l.uniforms;c.depthBuffer.value=t.depthTexture;const u=l.kernel;let h=t,f,d,m;for(d=0,m=u.length-1;d<m;++d)f=(d&1)===0?o:a,c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(f),e.render(n,s),h=f;c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(n,s)}}let aI=class extends bh{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;(t=e.defines)!=null&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`
        uniform mat4 textureMatrix;
        varying vec4 my_vUv;
      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
        my_vUv = textureMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );`),e.fragmentShader=`
        uniform sampler2D tDiffuse;
        uniform sampler2D tDiffuseBlur;
        uniform sampler2D tDepth;
        uniform sampler2D distortionMap;
        uniform float distortion;
        uniform float cameraNear;
			  uniform float cameraFar;
        uniform bool hasBlur;
        uniform float mixBlur;
        uniform float mirror;
        uniform float mixStrength;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float mixContrast;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec4 my_vUv;
        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>

      float distortionFactor = 0.0;
      #ifdef USE_DISTORTION
        distortionFactor = texture2D(distortionMap, vUv).r * distortion;
      #endif

      vec4 new_vUv = my_vUv;
      new_vUv.x += distortionFactor;
      new_vUv.y += distortionFactor;

      vec4 base = texture2DProj(tDiffuse, new_vUv);
      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);

      vec4 merge = base;

      #ifdef USE_NORMALMAP
        vec2 normal_uv = vec2(0.0);
        vec4 normalColor = texture2D(normalMap, vUv * normalScale);
        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );
        vec3 coord = new_vUv.xyz / new_vUv.w;
        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;
        vec4 base_normal = texture2D(tDiffuse, normal_uv);
        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);
        merge = base_normal;
        blur = blur_normal;
      #endif

      float depthFactor = 0.0001;
      float blurFactor = 0.0;

      #ifdef USE_DEPTH
        vec4 depth = texture2DProj(tDepth, new_vUv);
        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
        depthFactor *= depthScale;
        depthFactor = max(0.0001, min(1.0, depthFactor));

        #ifdef USE_BLUR
          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);
          merge = merge * min(1.0, depthFactor + 0.5);
        #else
          merge = merge * depthFactor;
        #endif

      #endif

      float reflectorRoughnessFactor = roughness;
      #ifdef USE_ROUGHNESSMAP
        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );
        reflectorRoughnessFactor *= reflectorTexelRoughness.g;
      #endif

      #ifdef USE_BLUR
        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);
        merge = mix(merge, blur, blurFactor);
      #endif

      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);
      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;
      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;
      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;

      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);
      `)}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}};const Hk=y.forwardRef(({mixBlur:r=0,mixStrength:e=1,resolution:t=256,blur:i=[0,0],minDepthThreshold:n=.9,maxDepthThreshold:s=1,depthScale:o=0,depthToBlurRatioBias:a=.25,mirror:l=0,distortion:c=1,mixContrast:u=1,distortionMap:h,reflectorOffset:f=0,...d},m)=>{xi({MeshReflectorMaterialImpl:aI});const A=de(({gl:L})=>L),p=de(({camera:L})=>L),g=de(({scene:L})=>L);i=Array.isArray(i)?i:[i,i];const v=i[0]+i[1]>0,E=y.useRef(null);y.useImperativeHandle(m,()=>E.current,[]);const[C]=y.useState(()=>new Hs),[I]=y.useState(()=>new K),[_]=y.useState(()=>new K),[x]=y.useState(()=>new K),[S]=y.useState(()=>new Me),[b]=y.useState(()=>new K(0,0,-1)),[T]=y.useState(()=>new Ci),[B]=y.useState(()=>new K),[w]=y.useState(()=>new K),[R]=y.useState(()=>new Ci),[D]=y.useState(()=>new Me),[G]=y.useState(()=>new ri),z=y.useCallback(()=>{var L;const $=E.current.parent||((L=E.current)==null?void 0:L.__r3f.parent);if(!$||(_.setFromMatrixPosition($.matrixWorld),x.setFromMatrixPosition(p.matrixWorld),S.extractRotation($.matrixWorld),I.set(0,0,1),I.applyMatrix4(S),_.addScaledVector(I,f),B.subVectors(_,x),B.dot(I)>0))return;B.reflect(I).negate(),B.add(_),S.extractRotation(p.matrixWorld),b.set(0,0,-1),b.applyMatrix4(S),b.add(x),w.subVectors(_,b),w.reflect(I).negate(),w.add(_),G.position.copy(B),G.up.set(0,1,0),G.up.applyMatrix4(S),G.up.reflect(I),G.lookAt(w),G.far=p.far,G.updateMatrixWorld(),G.projectionMatrix.copy(p.projectionMatrix),D.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),D.multiply(G.projectionMatrix),D.multiply(G.matrixWorldInverse),D.multiply($.matrixWorld),C.setFromNormalAndCoplanarPoint(I,_),C.applyMatrix4(G.matrixWorldInverse),T.set(C.normal.x,C.normal.y,C.normal.z,C.constant);const j=G.projectionMatrix;R.x=(Math.sign(T.x)+j.elements[8])/j.elements[0],R.y=(Math.sign(T.y)+j.elements[9])/j.elements[5],R.z=-1,R.w=(1+j.elements[10])/j.elements[14],T.multiplyScalar(2/T.dot(R)),j.elements[2]=T.x,j.elements[6]=T.y,j.elements[10]=T.z+1,j.elements[14]=T.w},[p,f]),[W,q,F,N]=y.useMemo(()=>{const L={minFilter:jt,magFilter:jt,type:Ai},$=new _i(t,t,L);$.depthBuffer=!0,$.depthTexture=new Rh(t,t),$.depthTexture.format=Hm,$.depthTexture.type=Mh;const j=new _i(t,t,L),V=new oI({gl:A,resolution:t,width:i[0],height:i[1],minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a}),k={mirror:l,textureMatrix:D,mixBlur:r,tDiffuse:$.texture,tDepth:$.depthTexture,tDiffuseBlur:j.texture,hasBlur:v,mixStrength:e,minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a,distortion:c,distortionMap:h,mixContrast:u,"defines-USE_BLUR":v?"":void 0,"defines-USE_DEPTH":o>0?"":void 0,"defines-USE_DISTORTION":h?"":void 0};return[$,j,V,k]},[A,i,D,t,l,v,r,e,n,s,o,a,c,h,u]);return We(()=>{var L;const $=E.current.parent||((L=E.current)==null?void 0:L.__r3f.parent);if(!$)return;$.visible=!1;const j=A.xr.enabled,V=A.shadowMap.autoUpdate;z(),A.xr.enabled=!1,A.shadowMap.autoUpdate=!1,A.setRenderTarget(W),A.state.buffers.depth.setMask(!0),A.autoClear||A.clear(),A.render(g,G),v&&F.render(A,W,q),A.xr.enabled=j,A.shadowMap.autoUpdate=V,$.visible=!0,A.setRenderTarget(null)}),y.createElement("meshReflectorMaterialImpl",_e({attach:"material",key:"key"+N["defines-USE_BLUR"]+N["defines-USE_DEPTH"]+N["defines-USE_DISTORTION"],ref:E},N,d))}),JM=vs({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new eI,color:new et("white"),opacity:1,resolution:new Fe,viewMatrixInverse:new Me,projectionMatrixInverse:new Me},`
  uniform mat4 viewMatrixInverse;

  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_vertex>

  void main() {
    #include <color_vertex>

    vec4 transformedNormal = vec4(normal, 0.0);
    vec4 transformedPosition = vec4(position, 1.0);
    #ifdef USE_INSTANCING
      transformedNormal = instanceMatrix * transformedNormal;
      transformedPosition = instanceMatrix * transformedPosition;
    #endif

    #ifdef USE_INSTANCING
      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);
    #else
      vModelMatrixInverse = inverse(modelMatrix);
    #endif

    vWorldPosition = (modelMatrix * transformedPosition).xyz;
    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;
  }`,`
  #define ENVMAP_TYPE_CUBE_UV
  precision highp isampler2D;
  precision highp usampler2D;
  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    uniform samplerCube envMap;
  #else
    uniform sampler2D envMap;
  #endif

  uniform float bounces;
  ${SM}
  ${TM}
  uniform BVH bvh;
  uniform float ior;
  uniform bool correctMips;
  uniform vec2 resolution;
  uniform float fresnel;
  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrixInverse;
  uniform mat4 viewMatrixInverse;
  uniform float aberrationStrength;
  uniform vec3 color;
  uniform float opacity;

  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {
    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );
  }

  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {
    vec3 rayOrigin = ro;
    vec3 rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = vWorldPosition + rayDirection * 0.001;
    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;
    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);
    for(float i = 0.0; i < bounces; i++) {
      uvec4 faceIndices = uvec4( 0u );
      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );
      vec3 barycoord = vec3( 0.0 );
      float side = 1.0;
      float dist = 0.0;
      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );
      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);
      vec3 tempDir = refract(rayDirection, faceNormal, ior);
      if (length(tempDir) != 0.0) {
        rayDirection = tempDir;
        break;
      }
      rayDirection = reflect(rayDirection, faceNormal);
      rayOrigin = hitPos + rayDirection * 0.01;
    }
    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);
    return rayDirection;
  }

  #include <common>
  #include <cube_uv_reflection_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));
    }
  #else
    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      vec2 uvv = equirectUv( rayDirection );
      vec2 smoothUv = equirectUv( directionCamPerfect );
      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));
    }
  #endif

  void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;
    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;
    directionCamPerfect = normalize(directionCamPerfect);
    vec3 normal = vNormal;
    vec3 rayOrigin = cameraPosition;
    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);

    vec4 diffuseColor = vec4(color, opacity);
    #include <color_fragment>

    #ifdef CHROMATIC_ABERRATIONS
      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      #ifdef FAST_CHROMA
        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));
        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));
      #else
        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);
        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);
      #endif
      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;
      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;
      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;
      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);
    #else
      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;
    #endif

    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);
    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;
    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);

    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
  }`),ZM=r=>r&&r.isCubeTexture;function Vk({aberrationStrength:r=0,fastChroma:e=!0,envMap:t,...i}){xi({MeshRefractionMaterial:JM});const n=y.useRef(),{size:s}=de(),o=y.useMemo(()=>{var a,l;const c={},u=ZM(t),f=((a=u?(l=t.image[0])==null?void 0:l.width:t.image.width)!==null&&a!==void 0?a:1024)/4,d=Math.floor(Math.log2(f)),m=Math.pow(2,d),A=3*Math.max(m,16*7),p=4*m;return u&&(c.ENVMAP_TYPE_CUBEM=""),c.CUBEUV_TEXEL_WIDTH=`${1/A}`,c.CUBEUV_TEXEL_HEIGHT=`${1/p}`,c.CUBEUV_MAX_MIP=`${d}.0`,r>0&&(c.CHROMATIC_ABERRATIONS=""),e&&(c.FAST_CHROMA=""),c},[r,e]);return y.useLayoutEffect(()=>{var a;const l=(a=n.current)==null||(a=a.__r3f)==null||(a=a.parent)==null?void 0:a.geometry;l&&(n.current.bvh=new eI,n.current.bvh.updateFrom(new nf(l.clone().toNonIndexed(),{strategy:Zh})))},[]),We(({camera:a})=>{n.current.viewMatrixInverse=a.matrixWorld,n.current.projectionMatrixInverse=a.projectionMatrixInverse}),y.createElement("meshRefractionMaterial",_e({key:JSON.stringify(o),defines:o,ref:n,resolution:[s.width,s.height],aberrationStrength:r,envMap:t},i))}const YA=vs({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }");class eL extends es{constructor(e=6,t=!1){super(),this.uniforms={chromaticAberration:{value:.05},transmission:{value:0},_transmission:{value:1},transmissionMap:{value:null},roughness:{value:0},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:1/0},attenuationColor:{value:new et("white")},anisotropicBlur:{value:.1},time:{value:0},distortion:{value:0},distortionScale:{value:.5},temporalDistortion:{value:0},buffer:{value:null}},this.onBeforeCompile=i=>{i.uniforms={...i.uniforms,...this.uniforms},this.anisotropy>0&&(i.defines.USE_ANISOTROPY=""),t?i.defines.USE_SAMPLER="":i.defines.USE_TRANSMISSION="",i.fragmentShader=`
      uniform float chromaticAberration;         
      uniform float anisotropicBlur;      
      uniform float time;
      uniform float distortion;
      uniform float distortionScale;
      uniform float temporalDistortion;
      uniform sampler2D buffer;

      vec3 random3(vec3 c) {
        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));
        vec3 r;
        r.z = fract(512.0*j);
        j *= .125;
        r.x = fract(512.0*j);
        j *= .125;
        r.y = fract(512.0*j);
        return r-0.5;
      }

      uint hash( uint x ) {
        x += ( x << 10u );
        x ^= ( x >>  6u );
        x += ( x <<  3u );
        x ^= ( x >> 11u );
        x += ( x << 15u );
        return x;
      }

      // Compound versions of the hashing algorithm I whipped together.
      uint hash( uvec2 v ) { return hash( v.x ^ hash(v.y)                         ); }
      uint hash( uvec3 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z)             ); }
      uint hash( uvec4 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z) ^ hash(v.w) ); }

      // Construct a float with half-open range [0:1] using low 23 bits.
      // All zeroes yields 0.0, all ones yields the next smallest representable value below 1.0.
      float floatConstruct( uint m ) {
        const uint ieeeMantissa = 0x007FFFFFu; // binary32 mantissa bitmask
        const uint ieeeOne      = 0x3F800000u; // 1.0 in IEEE binary32
        m &= ieeeMantissa;                     // Keep only mantissa bits (fractional part)
        m |= ieeeOne;                          // Add fractional part to 1.0
        float  f = uintBitsToFloat( m );       // Range [1:2]
        return f - 1.0;                        // Range [0:1]
      }

      // Pseudo-random value in half-open range [0:1].
      float randomBase( float x ) { return floatConstruct(hash(floatBitsToUint(x))); }
      float randomBase( vec2  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec3  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec4  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float rand(float seed) {
        float result = randomBase(vec3(gl_FragCoord.xy, seed));
        return result;
      }

      const float F3 =  0.3333333;
      const float G3 =  0.1666667;

      float snoise(vec3 p) {
        vec3 s = floor(p + dot(p, vec3(F3)));
        vec3 x = p - s + dot(s, vec3(G3));
        vec3 e = step(vec3(0.0), x - x.yzx);
        vec3 i1 = e*(1.0 - e.zxy);
        vec3 i2 = 1.0 - e.zxy*(1.0 - e);
        vec3 x1 = x - i1 + G3;
        vec3 x2 = x - i2 + 2.0*G3;
        vec3 x3 = x - 1.0 + 3.0*G3;
        vec4 w, d;
        w.x = dot(x, x);
        w.y = dot(x1, x1);
        w.z = dot(x2, x2);
        w.w = dot(x3, x3);
        w = max(0.6 - w, 0.0);
        d.x = dot(random3(s), x);
        d.y = dot(random3(s + i1), x1);
        d.z = dot(random3(s + i2), x2);
        d.w = dot(random3(s + 1.0), x3);
        w *= w;
        w *= w;
        d *= w;
        return dot(d, vec4(52.0));
      }

      float snoiseFractal(vec3 m) {
        return 0.5333333* snoise(m)
              +0.2666667* snoise(2.0*m)
              +0.1333333* snoise(4.0*m)
              +0.0666667* snoise(8.0*m);
      }
`+i.fragmentShader,i.fragmentShader=i.fragmentShader.replace("#include <transmission_pars_fragment>",`
        #ifdef USE_TRANSMISSION
          // Transmission code is based on glTF-Sampler-Viewer
          // https://github.com/KhronosGroup/glTF-Sample-Viewer
          uniform float _transmission;
          uniform float thickness;
          uniform float attenuationDistance;
          uniform vec3 attenuationColor;
          #ifdef USE_TRANSMISSIONMAP
            uniform sampler2D transmissionMap;
          #endif
          #ifdef USE_THICKNESSMAP
            uniform sampler2D thicknessMap;
          #endif
          uniform vec2 transmissionSamplerSize;
          uniform sampler2D transmissionSamplerMap;
          uniform mat4 modelMatrix;
          uniform mat4 projectionMatrix;
          varying vec3 vWorldPosition;
          vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
            // Direction of refracted light.
            vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
            // Compute rotation-independant scaling of the model matrix.
            vec3 modelScale;
            modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
            modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
            modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
            // The thickness is specified in local space.
            return normalize( refractionVector ) * thickness * modelScale;
          }
          float applyIorToRoughness( const in float roughness, const in float ior ) {
            // Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and
            // an IOR of 1.5 results in the default amount of microfacet refraction.
            return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
          }
          vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
            float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );            
            #ifdef USE_SAMPLER
              #ifdef texture2DLodEXT
                return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #else
                return texture2D(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #endif
            #else
              return texture2D(buffer, fragCoord.xy);
            #endif
          }
          vec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
            if ( isinf( attenuationDistance ) ) {
              // Attenuation distance is +∞, i.e. the transmitted color is not attenuated at all.
              return radiance;
            } else {
              // Compute light attenuation using Beer's law.
              vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
              vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law
              return transmittance * radiance;
            }
          }
          vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
            const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
            const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
            const in vec3 attenuationColor, const in float attenuationDistance ) {
            vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
            vec3 refractedRayExit = position + transmissionRay;
            // Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
            vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
            vec2 refractionCoords = ndcPos.xy / ndcPos.w;
            refractionCoords += 1.0;
            refractionCoords /= 2.0;
            // Sample framebuffer to get pixel the refracted ray hits.
            vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
            vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
            // Get the specular component.
            vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
            return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
          }
        #endif
`),i.fragmentShader=i.fragmentShader.replace("#include <transmission_fragment>",`  
        // Improve the refraction to use the world pos
        material.transmission = _transmission;
        material.transmissionAlpha = 1.0;
        material.thickness = thickness;
        material.attenuationDistance = attenuationDistance;
        material.attenuationColor = attenuationColor;
        #ifdef USE_TRANSMISSIONMAP
          material.transmission *= texture2D( transmissionMap, vUv ).r;
        #endif
        #ifdef USE_THICKNESSMAP
          material.thickness *= texture2D( thicknessMap, vUv ).g;
        #endif
        
        vec3 pos = vWorldPosition;
        float runningSeed = 0.0;
        vec3 v = normalize( cameraPosition - pos );
        vec3 n = inverseTransformDirection( normal, viewMatrix );
        vec3 transmission = vec3(0.0);
        float transmissionR, transmissionB, transmissionG;
        float randomCoords = rand(runningSeed++);
        float thickness_smear = thickness * max(pow(roughnessFactor, 0.33), anisotropicBlur);
        vec3 distortionNormal = vec3(0.0);
        vec3 temporalOffset = vec3(time, -time, -time) * temporalDistortion;
        if (distortion > 0.0) {
          distortionNormal = distortion * vec3(snoiseFractal(vec3((pos * distortionScale + temporalOffset))), snoiseFractal(vec3(pos.zxy * distortionScale - temporalOffset)), snoiseFractal(vec3(pos.yxz * distortionScale + temporalOffset)));
        }
        for (float i = 0.0; i < ${e}.0; i ++) {
          vec3 sampleNorm = normalize(n + roughnessFactor * roughnessFactor * 2.0 * normalize(vec3(rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5)) * pow(rand(runningSeed++), 0.33) + distortionNormal);
          transmissionR = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness  + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).r;
          transmissionG = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior  * (1.0 + chromaticAberration * (i + randomCoords) / float(${e})) , material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).g;
          transmissionB = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior * (1.0 + 2.0 * chromaticAberration * (i + randomCoords) / float(${e})), material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).b;
          transmission.r += transmissionR;
          transmission.g += transmissionG;
          transmission.b += transmissionB;
        }
        transmission /= ${e}.0;
        totalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );
`)},Object.keys(this.uniforms).forEach(i=>Object.defineProperty(this,i,{get:()=>this.uniforms[i].value,set:n=>this.uniforms[i].value=n}))}}const Kk=y.forwardRef(({buffer:r,transmissionSampler:e=!1,backside:t=!1,side:i=Yl,transmission:n=1,thickness:s=0,backsideThickness:o=0,backsideEnvMapIntensity:a=1,samples:l=10,resolution:c,backsideResolution:u,background:h,anisotropy:f,anisotropicBlur:d,...m},A)=>{xi({MeshTransmissionMaterial:eL});const p=y.useRef(null),[g]=y.useState(()=>new YA),v=En(u||c),E=En(c);let C,I,_,x;return We(S=>{p.current.time=S.clock.elapsedTime,p.current.buffer===E.texture&&!e&&(x=p.current.__r3f.parent,x&&(_=S.gl.toneMapping,C=S.scene.background,I=p.current.envMapIntensity,S.gl.toneMapping=x_,h&&(S.scene.background=h),x.material=g,t&&(S.gl.setRenderTarget(v),S.gl.render(S.scene,S.camera),x.material=p.current,x.material.buffer=v.texture,x.material.thickness=o,x.material.side=hc,x.material.envMapIntensity=a),S.gl.setRenderTarget(E),S.gl.render(S.scene,S.camera),x.material=p.current,x.material.thickness=s,x.material.side=i,x.material.buffer=E.texture,x.material.envMapIntensity=I,S.scene.background=C,S.gl.setRenderTarget(null),S.gl.toneMapping=_))}),y.useImperativeHandle(A,()=>p.current,[]),y.createElement("meshTransmissionMaterial",_e({args:[l,e],ref:p},m,{buffer:r||E.texture,_transmission:n,anisotropicBlur:d??f,transmission:e?n:0,thickness:s,side:i}))}),$k=y.forwardRef((r,e)=>(xi({DiscardMaterialImpl:YA}),y.createElement("discardMaterialImpl",_e({ref:e},r))));function jk(r){const e=y.useRef(null);return y.useLayoutEffect(()=>{var t;const i=(t=e.current)==null?void 0:t.parent,n=i?.geometry;if(n){const s=i.material;i.material=e.current.__r3f.objects;const o=[...n.groups];return n.clearGroups(),i.material.forEach((a,l)=>{l<i.material.length-1&&(a.depthWrite=!1),n.addGroup(0,1/0,l)}),()=>{i.material=s,n.groups=o}}}),y.createElement("group",_e({ref:e},r))}const i0=sn>=154?"opaque_fragment":"output_fragment";class tL extends P2{constructor(e){super(e),this.onBeforeCompile=(t,i)=>{const{isWebGL2:n}=i.capabilities;t.fragmentShader=t.fragmentShader.replace(`#include <${i0}>`,`
        ${n?`#include <${i0}>`:`#extension GL_OES_standard_derivatives : enable
#include <${i0}>`}
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      float r = dot(cxy, cxy);
      float delta = fwidth(r);     
      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );
      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
      `)}}}const Yk=y.forwardRef((r,e)=>{const[t]=y.useState(()=>new tL(null));return y.createElement("primitive",_e({},r,{object:t,ref:e,attach:"material"}))}),iL=({focus:r=0,size:e=25,samples:t=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${e})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${r});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${t}; i ++) {
    offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${t}; i++) {
    vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${e}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${t}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function Mv(r,e,t){e.traverse(i=>{i.material&&(r.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),r.info.programs.length=0,r.compile(e,t)}function Wk({focus:r=0,samples:e=10,size:t=25}){const i=de(o=>o.gl),n=de(o=>o.scene),s=de(o=>o.camera);return y.useEffect(()=>{const o=Zo.shadowmap_pars_fragment;return Zo.shadowmap_pars_fragment=Zo.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+iL({size:t,samples:e,focus:r})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),Mv(i,n,s),()=>{Zo.shadowmap_pars_fragment=o,Mv(i,n,s)}},[r,t,e]),null}function zi(r,e){const t=r+"Geometry";return y.forwardRef(({args:i,children:n,...s},o)=>{const a=y.useRef(null);return y.useImperativeHandle(o,()=>a.current),y.useLayoutEffect(()=>void e?.(a.current)),y.createElement("mesh",_e({ref:a},s),y.createElement(t,{attach:"geometry",args:i}),n)})}const qk=zi("box"),Xk=zi("circle"),Jk=zi("cone"),Zk=zi("cylinder"),eO=zi("sphere"),tO=zi("plane"),iO=zi("tube"),nO=zi("torus"),sO=zi("torusKnot"),rO=zi("tetrahedron"),oO=zi("ring"),aO=zi("polyhedron"),lO=zi("icosahedron"),cO=zi("octahedron"),uO=zi("dodecahedron"),hO=zi("extrude"),fO=zi("lathe"),dO=zi("capsule"),mO=zi("shape",({geometry:r})=>{const e=r.attributes.position,t=new oi().setFromBufferAttribute(e),i=new K;t.getSize(i);const n=[];let s=0,o=0,a=0,l=0;for(let c=0;c<e.count;c++)s=e.getX(c),o=e.getY(c),a=(s-t.min.x)/i.x,l=(o-t.min.y)/i.y,n.push(a,l);r.setAttribute("uv",new ji(n,2))}),Ts=1e-5;function nL(r,e,t){const i=new Q2,n=t-Ts;return i.absarc(Ts,Ts,Ts,-Math.PI/2,-Math.PI,!0),i.absarc(Ts,e-n*2,Ts,Math.PI,Math.PI/2,!0),i.absarc(r-n*2,e-n*2,Ts,Math.PI/2,0,!0),i.absarc(r-n*2,Ts,Ts,0,-Math.PI/2,!0),i}const AO=y.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:s=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:l=.4,children:c,...u},h){const f=y.useMemo(()=>nL(e,t,n),[e,t,n]),d=y.useMemo(()=>({depth:i-n*2,bevelEnabled:!0,bevelSegments:a*2,steps:s,bevelSize:n-Ts,bevelThickness:n,curveSegments:o}),[i,n,o]),m=y.useRef(null);return y.useLayoutEffect(()=>{m.current&&(m.current.center(),qE(m.current,l))},[f,d]),y.createElement("mesh",_e({ref:h},u),y.createElement("extrudeGeometry",{ref:m,args:[f,d]}),c)});function sL(){const r=new Gi,e=new Float32Array([-1,-1,3,-1,-1,3]);return r.boundingSphere=new un,r.boundingSphere.set(new K,1/0),r.setAttribute("position",new Jt(e,2)),r}const pO=y.forwardRef(function({children:e,...t},i){const n=y.useMemo(sL,[]);return y.createElement("mesh",_e({ref:i,geometry:n,frustumCulled:!1},t),e)}),gO=y.forwardRef(({children:r,width:e,height:t,depth:i,box3:n,precise:s=!0,...o},a)=>{const l=y.useRef(null),c=y.useRef(null),u=y.useRef(null);return y.useLayoutEffect(()=>{c.current.matrixWorld.identity();let h=n||new oi().setFromObject(u.current,s);const f=h.max.x-h.min.x,d=h.max.y-h.min.y,m=h.max.z-h.min.z;let A=Math.max(f,d,m);e&&(A=f),t&&(A=d),i&&(A=m),c.current.scale.setScalar(1/A)},[e,t,i,n,s]),y.useImperativeHandle(a,()=>l.current,[]),y.createElement("group",_e({ref:l},o),y.createElement("group",{ref:c},y.createElement("group",{ref:u},r)))});var zn=function(r){return r[r.NONE=0]="NONE",r[r.START=1]="START",r[r.ACTIVE=2]="ACTIVE",r}(zn||{});const Qo=r=>r&&r.isOrthographicCamera,rL=r=>r&&r.isBox3,oL=r=>1-Math.exp(-5*r)+.007*r,lI=y.createContext(null);function aL({children:r,maxDuration:e=1,margin:t=1.2,observe:i,fit:n,clip:s,interpolateFunc:o=oL,onFit:a}){const l=y.useRef(null),{camera:c,size:u,invalidate:h}=de(),f=de(I=>I.controls),d=y.useRef(a);d.current=a;const m=y.useRef({camPos:new K,camRot:new ht,camZoom:1}),A=y.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),p=y.useRef(zn.NONE),g=y.useRef(0),[v]=y.useState(()=>new oi),E=y.useMemo(()=>{function I(){const _=v.getSize(new K),x=v.getCenter(new K),S=Math.max(_.x,_.y,_.z),b=Qo(c)?S*4:S/(2*Math.atan(Math.PI*c.fov/360)),T=Qo(c)?S*4:b/c.aspect,B=t*Math.max(b,T);return{box:v,size:_,center:x,distance:B}}return{getSize:I,refresh(_){if(rL(_))v.copy(_);else{const x=_||l.current;if(!x)return this;x.updateWorldMatrix(!0,!0),v.setFromObject(x)}if(v.isEmpty()){const x=c.position.length()||10;v.setFromCenterAndSize(new K,new K(x,x,x))}return m.current.camPos.copy(c.position),m.current.camRot.copy(c.quaternion),Qo(c)&&(m.current.camZoom=c.zoom),A.current.camPos=void 0,A.current.camRot=void 0,A.current.camZoom=void 0,A.current.camUp=void 0,A.current.target=void 0,this},reset(){const{center:_,distance:x}=I(),S=c.position.clone().sub(_).normalize();A.current.camPos=_.clone().addScaledVector(S,x),A.current.target=_.clone();const b=new Me().lookAt(A.current.camPos,A.current.target,c.up);return A.current.camRot=new ht().setFromRotationMatrix(b),p.current=zn.START,g.current=0,this},moveTo(_){return A.current.camPos=Array.isArray(_)?new K(..._):_.clone(),p.current=zn.START,g.current=0,this},lookAt({target:_,up:x}){A.current.target=Array.isArray(_)?new K(..._):_.clone(),x?A.current.camUp=Array.isArray(x)?new K(...x):x.clone():A.current.camUp=c.up.clone();const S=new Me().lookAt(A.current.camPos||c.position,A.current.target,A.current.camUp);return A.current.camRot=new ht().setFromRotationMatrix(S),p.current=zn.START,g.current=0,this},to({position:_,target:x}){return this.moveTo(_).lookAt({target:x})},fit(){if(!Qo(c))return this.reset();let _=0,x=0;const S=[new K(v.min.x,v.min.y,v.min.z),new K(v.min.x,v.max.y,v.min.z),new K(v.min.x,v.min.y,v.max.z),new K(v.min.x,v.max.y,v.max.z),new K(v.max.x,v.max.y,v.max.z),new K(v.max.x,v.max.y,v.min.z),new K(v.max.x,v.min.y,v.max.z),new K(v.max.x,v.min.y,v.min.z)],b=A.current.camPos||c.position,T=A.current.target||f?.target,B=A.current.camUp||c.up,w=T?new Me().lookAt(b,T,B).setPosition(b).invert():c.matrixWorldInverse;for(const G of S)G.applyMatrix4(w),_=Math.max(_,Math.abs(G.y)),x=Math.max(x,Math.abs(G.x));_*=2,x*=2;const R=(c.top-c.bottom)/_,D=(c.right-c.left)/x;return A.current.camZoom=Math.min(R,D)/t,p.current=zn.START,g.current=0,d.current&&d.current(this.getSize()),this},clip(){const{distance:_}=I();return c.near=_/100,c.far=_*100,c.updateProjectionMatrix(),f&&(f.maxDistance=_*10,f.update()),h(),this}}},[v,c,f,t,h]);y.useLayoutEffect(()=>{if(f){const I=()=>{if(f&&A.current.target&&p.current!==zn.NONE){const _=new K().setFromMatrixColumn(c.matrix,2),x=m.current.camPos.distanceTo(f.target),S=(A.current.camPos||m.current.camPos).distanceTo(A.current.target),b=(1-g.current)*x+g.current*S;f.target.copy(c.position).addScaledVector(_,-b),f.update()}p.current=zn.NONE};return f.addEventListener("start",I),()=>f.removeEventListener("start",I)}},[f]);const C=y.useRef(0);return y.useLayoutEffect(()=>{(i||C.current++===0)&&(E.refresh(),n&&E.reset().fit(),s&&E.clip())},[u,s,n,i,c,f]),We((I,_)=>{if(p.current===zn.START)p.current=zn.ACTIVE,h();else if(p.current===zn.ACTIVE){if(g.current+=_/e,g.current>=1)A.current.camPos&&c.position.copy(A.current.camPos),A.current.camRot&&c.quaternion.copy(A.current.camRot),A.current.camUp&&c.up.copy(A.current.camUp),A.current.camZoom&&Qo(c)&&(c.zoom=A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix(),f&&A.current.target&&(f.target.copy(A.current.target),f.update()),p.current=zn.NONE;else{const x=o(g.current);A.current.camPos&&c.position.lerpVectors(m.current.camPos,A.current.camPos,x),A.current.camRot&&c.quaternion.slerpQuaternions(m.current.camRot,A.current.camRot,x),A.current.camUp&&c.up.set(0,1,0).applyQuaternion(c.quaternion),A.current.camZoom&&Qo(c)&&(c.zoom=(1-x)*m.current.camZoom+x*A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix()}h()}}),y.createElement("group",{ref:l},y.createElement(lI.Provider,{value:E},r))}function lL(){return y.useContext(lI)}const yO=y.forwardRef(({intensity:r=1,decay:e,decayRate:t=.65,maxYaw:i=.1,maxPitch:n=.1,maxRoll:s=.1,yawFrequency:o=.1,pitchFrequency:a=.1,rollFrequency:l=.1},c)=>{const u=de(v=>v.camera),h=de(v=>v.controls),f=y.useRef(r),d=y.useRef(u.rotation.clone()),[m]=y.useState(()=>new Df),[A]=y.useState(()=>new Df),[p]=y.useState(()=>new Df),g=()=>{(f.current<0||f.current>1)&&(f.current=f.current<0?0:1)};return y.useImperativeHandle(c,()=>({getIntensity:()=>f.current,setIntensity:v=>{f.current=v,g()}}),[]),y.useEffect(()=>{if(h){const v=()=>void(d.current=u.rotation.clone());return h.addEventListener("change",v),v(),()=>void h.removeEventListener("change",v)}},[u,h]),We((v,E)=>{const C=Math.pow(f.current,2),I=i*C*m.noise(v.clock.elapsedTime*o,1),_=n*C*A.noise(v.clock.elapsedTime*a,1),x=s*C*p.noise(v.clock.elapsedTime*l,1);u.rotation.set(d.current.x+_,d.current.y+I,d.current.z+x),e&&f.current>0&&(f.current-=t*E,g())}),null}),vO=y.forwardRef(({children:r,enabled:e=!0,speed:t=1,rotationIntensity:i=1,floatIntensity:n=1,floatingRange:s=[-.1,.1],autoInvalidate:o=!1,...a},l)=>{const c=y.useRef(null);y.useImperativeHandle(l,()=>c.current,[]);const u=y.useRef(Math.random()*1e4);return We(h=>{var f,d;if(!e||t===0)return;o&&h.invalidate();const m=u.current+h.clock.elapsedTime;c.current.rotation.x=Math.cos(m/4*t)/8*i,c.current.rotation.y=Math.sin(m/4*t)/8*i,c.current.rotation.z=Math.sin(m/4*t)/20*i;let A=Math.sin(m/4*t)/10;A=ot.mapLinear(A,-.1,.1,(f=s?.[0])!==null&&f!==void 0?f:-.1,(d=s?.[1])!==null&&d!==void 0?d:.1),c.current.position.y=A*n,c.current.updateMatrix()}),y.createElement("group",a,y.createElement("group",{ref:c,matrixAutoUpdate:!1},r))}),cI=(r,e,t)=>{let i;switch(r){case $i:i=new Uint8ClampedArray(e*t*4);break;case Ai:i=new Uint16Array(e*t*4);break;case no:i=new Uint32Array(e*t*4);break;case D0:i=new Int8Array(e*t*4);break;case J2:i=new Int16Array(e*t*4);break;case Nu:i=new Int32Array(e*t*4);break;case hi:i=new Float32Array(e*t*4);break;default:throw new Error("Unsupported data type")}return i};let Bu;const cL=(r,e,t,i)=>{if(Bu!==void 0)return Bu;const n=new _i(1,1,i);e.setRenderTarget(n);const s=new je(new an,new ms({color:16777215}));e.render(s,t),e.setRenderTarget(null);const o=cI(r,n.width,n.height);return e.readRenderTargetPixels(n,0,0,n.width,n.height,o),n.dispose(),s.geometry.dispose(),s.material.dispose(),Bu=o[0]!==0,Bu};class WA{constructor(e){var t,i,n,s,o,a,l,c,u,h,f,d,m,A,p,g;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(E){throw this._renderer.setRenderTarget(null),E}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const v={format:Mi,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((t=e.renderTargetOptions)===null||t===void 0?void 0:t.anisotropy)!==void 0?(i=e.renderTargetOptions)===null||i===void 0?void 0:i.anisotropy:1,generateMipmaps:((n=e.renderTargetOptions)===null||n===void 0?void 0:n.generateMipmaps)!==void 0?(s=e.renderTargetOptions)===null||s===void 0?void 0:s.generateMipmaps:!1,magFilter:((o=e.renderTargetOptions)===null||o===void 0?void 0:o.magFilter)!==void 0?(a=e.renderTargetOptions)===null||a===void 0?void 0:a.magFilter:jt,minFilter:((l=e.renderTargetOptions)===null||l===void 0?void 0:l.minFilter)!==void 0?(c=e.renderTargetOptions)===null||c===void 0?void 0:c.minFilter:jt,samples:((u=e.renderTargetOptions)===null||u===void 0?void 0:u.samples)!==void 0?(h=e.renderTargetOptions)===null||h===void 0?void 0:h.samples:void 0,wrapS:((f=e.renderTargetOptions)===null||f===void 0?void 0:f.wrapS)!==void 0?(d=e.renderTargetOptions)===null||d===void 0?void 0:d.wrapS:Bn,wrapT:((m=e.renderTargetOptions)===null||m===void 0?void 0:m.wrapT)!==void 0?(A=e.renderTargetOptions)===null||A===void 0?void 0:A.wrapT:Bn};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=WA.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Nr,this._camera=new vi,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!cL(this._type,this._renderer,this._camera,v)){let E;switch(this._type){case Ai:E=this._renderer.extensions.has("EXT_color_buffer_float")?hi:void 0;break}E!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${hi}`),this._type=E):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new je(new an,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new _i(this.width,this.height,v),this._renderTarget.texture.mapping=((p=e.renderTargetOptions)===null||p===void 0?void 0:p.mapping)!==void 0?(g=e.renderTargetOptions)===null||g===void 0?void 0:g.mapping:nh}static instantiateRenderer(){const e=new S_;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=cI(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new Fr(this.toArray(),this.width,this.height,Mi,this._type,e?.mapping||nh,e?.wrapS||Bn,e?.wrapT||Bn,e?.magFilter||jt,e?.minFilter||jt,e?.anisotropy||1,M0);return t.generateMipmaps=e?.generateMipmaps!==void 0?e?.generateMipmaps:!1,t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof bi&&Object.values(this.material.uniforms).forEach(t=>{t.value instanceof tn&&t.value.dispose()}),Object.values(this.material).forEach(t=>{t instanceof tn&&t.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}const uL=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,hL=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class fL extends bi{constructor({gamma:e,offsetHdr:t,offsetSdr:i,gainMapMin:n,gainMapMax:s,maxDisplayBoost:o,hdrCapacityMin:a,hdrCapacityMax:l,sdr:c,gainMap:u}){super({name:"GainMapDecoderMaterial",vertexShader:uL,fragmentShader:hL,uniforms:{sdr:{value:c},gainMap:{value:u},gamma:{value:new K(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:new K().fromArray(t)},offsetSdr:{value:new K().fromArray(i)},gainMapMin:{value:new K().fromArray(n)},gainMapMax:{value:new K().fromArray(s)},weightFactor:{value:(Math.log2(o)-a)/(l-a)}},blending:Fm,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=o,this._hdrCapacityMin=a,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class uI extends Error{}class hI extends Error{}const gl=(r,e,t)=>{const i=new RegExp(`${e}="([^"]*)"`,"i").exec(r);if(i)return i[1];const n=new RegExp(`<${e}[^>]*>([\\s\\S]*?)</${e}>`,"i").exec(r);if(n){const s=n[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return s&&s.length===3?s.map(o=>o.replace(/<\/?rdf:li>/g,"")):n[1].trim()}if(t!==void 0)return t;throw new Error(`Can't find ${e} in gainmap metadata`)},dL=r=>{let e;typeof TextDecoder<"u"?e=new TextDecoder().decode(r):e=r.toString();let t=e.indexOf("<x:xmpmeta");for(;t!==-1;){const i=e.indexOf("x:xmpmeta>",t),n=e.slice(t,i+10);try{const s=gl(n,"hdrgm:GainMapMin","0"),o=gl(n,"hdrgm:GainMapMax"),a=gl(n,"hdrgm:Gamma","1"),l=gl(n,"hdrgm:OffsetSDR","0.015625"),c=gl(n,"hdrgm:OffsetHDR","0.015625"),u=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(n),h=u?u[1]:"0",f=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(n);if(!f)throw new Error("Incomplete gainmap metadata");const d=f[1];return{gainMapMin:Array.isArray(s)?s.map(m=>parseFloat(m)):[parseFloat(s),parseFloat(s),parseFloat(s)],gainMapMax:Array.isArray(o)?o.map(m=>parseFloat(m)):[parseFloat(o),parseFloat(o),parseFloat(o)],gamma:Array.isArray(a)?a.map(m=>parseFloat(m)):[parseFloat(a),parseFloat(a),parseFloat(a)],offsetSdr:Array.isArray(l)?l.map(m=>parseFloat(m)):[parseFloat(l),parseFloat(l),parseFloat(l)],offsetHdr:Array.isArray(c)?c.map(m=>parseFloat(m)):[parseFloat(c),parseFloat(c),parseFloat(c)],hdrCapacityMin:parseFloat(h),hdrCapacityMax:parseFloat(d)}}catch{}t=e.indexOf("<x:xmpmeta",i)}};class mL{constructor(e){this.options={debug:e&&e.debug!==void 0?e.debug:!1,extractFII:e&&e.extractFII!==void 0?e.extractFII:!0,extractNonFII:e&&e.extractNonFII!==void 0?e.extractNonFII:!0}}extract(e){return new Promise((t,i)=>{const n=this.options.debug,s=new DataView(e.buffer);if(s.getUint16(0)!==65496){i(new Error("Not a valid jpeg"));return}const o=s.byteLength;let a=2,l=0,c;for(;a<o;){if(++l>250){i(new Error(`Found no marker after ${l} loops 😵`));return}if(s.getUint8(a)!==255){i(new Error(`Not a valid marker at offset 0x${a.toString(16)}, found: 0x${s.getUint8(a).toString(16)}`));return}if(c=s.getUint8(a+1),n&&console.log(`Marker: ${c.toString(16)}`),c===226){n&&console.log("Found APP2 marker (0xffe2)");const u=a+4;if(s.getUint32(u)===1297106432){const h=u+4;let f;if(s.getUint16(h)===18761)f=!1;else if(s.getUint16(h)===19789)f=!0;else{i(new Error("No valid endianness marker found in TIFF header"));return}if(s.getUint16(h+2,!f)!==42){i(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const d=s.getUint32(h+4,!f);if(d<8){i(new Error("Not valid TIFF data! (First offset less than 8)"));return}const m=h+d,A=s.getUint16(m,!f),p=m+2;let g=0;for(let I=p;I<p+12*A;I+=12)s.getUint16(I,!f)===45057&&(g=s.getUint32(I+8,!f));const E=m+2+A*12+4,C=[];for(let I=E;I<E+g*16;I+=16){const _={MPType:s.getUint32(I,!f),size:s.getUint32(I+4,!f),dataOffset:s.getUint32(I+8,!f),dependantImages:s.getUint32(I+12,!f),start:-1,end:-1,isFII:!1};_.dataOffset?(_.start=h+_.dataOffset,_.isFII=!1):(_.start=0,_.isFII=!0),_.end=_.start+_.size,C.push(_)}if(this.options.extractNonFII&&C.length){const I=new Blob([s]),_=[];for(const x of C){if(x.isFII&&!this.options.extractFII)continue;const S=I.slice(x.start,x.end+1,"image/jpeg");_.push(S)}t(_)}}}a+=2+s.getUint16(a+2)}})}}const AL=async r=>{const e=dL(r);if(!e)throw new hI("Gain map XMP metadata not found");const i=await new mL({extractFII:!0,extractNonFII:!0}).extract(r);if(i.length!==2)throw new uI("Gain map recovery image not found");return{sdr:new Uint8Array(await i[0].arrayBuffer()),gainMap:new Uint8Array(await i[1].arrayBuffer()),metadata:e}},Lv=r=>new Promise((e,t)=>{const i=document.createElement("img");i.onload=()=>{e(i)},i.onerror=n=>{t(n)},i.src=URL.createObjectURL(r)});class fI extends Ur{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new T_}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const e=new fL({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new tn,sdr:new tn});return new WA({width:16,height:16,type:Ai,colorSpace:M0,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,i,n){const s=n?new Blob([n],{type:"image/jpeg"}):void 0,o=new Blob([i],{type:"image/jpeg"});let a,l,c=!1;if(typeof createImageBitmap>"u"){const f=await Promise.all([s?Lv(s):Promise.resolve(void 0),Lv(o)]);l=f[0],a=f[1],c=!0}else{const f=await Promise.all([s?createImageBitmap(s,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(o,{imageOrientation:"flipY"})]);l=f[0],a=f[1]}const u=new tn(l||new ImageData(2,2),nh,Bn,Bn,jt,yp,Mi,$i,1,M0);u.flipY=c,u.needsUpdate=!0;const h=new tn(a,nh,Bn,Bn,jt,yp,Mi,$i,1,q2);h.flipY=c,h.needsUpdate=!0,e.width=a.width,e.height=a.height,e.material.gainMap=u,e.material.sdr=h,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class pL extends fI{load([e,t,i],n,s,o){const a=this.prepareQuadRenderer();let l,c,u;const h=async()=>{if(l&&c&&u){try{await this.render(a,u,l,c)}catch(b){this.manager.itemError(e),this.manager.itemError(t),this.manager.itemError(i),typeof o=="function"&&o(b),a.disposeOnDemandRenderer();return}typeof n=="function"&&n(a),this.manager.itemEnd(e),this.manager.itemEnd(t),this.manager.itemEnd(i),a.disposeOnDemandRenderer()}};let f=!0,d=0,m=0,A=!0,p=0,g=0,v=!0,E=0,C=0;const I=()=>{if(typeof s=="function"){const b=d+p+E,T=m+g+C,B=f&&A&&v;s(new ProgressEvent("progress",{lengthComputable:B,loaded:T,total:b}))}};this.manager.itemStart(e),this.manager.itemStart(t),this.manager.itemStart(i);const _=new In(this._internalLoadingManager);_.setResponseType("arraybuffer"),_.setRequestHeader(this.requestHeader),_.setPath(this.path),_.setWithCredentials(this.withCredentials),_.load(e,async b=>{if(typeof b=="string")throw new Error("Invalid sdr buffer");l=b,await h()},b=>{f=b.lengthComputable,m=b.loaded,d=b.total,I()},b=>{this.manager.itemError(e),typeof o=="function"&&o(b)});const x=new In(this._internalLoadingManager);x.setResponseType("arraybuffer"),x.setRequestHeader(this.requestHeader),x.setPath(this.path),x.setWithCredentials(this.withCredentials),x.load(t,async b=>{if(typeof b=="string")throw new Error("Invalid gainmap buffer");c=b,await h()},b=>{A=b.lengthComputable,g=b.loaded,p=b.total,I()},b=>{this.manager.itemError(t),typeof o=="function"&&o(b)});const S=new In(this._internalLoadingManager);return S.setRequestHeader(this.requestHeader),S.setPath(this.path),S.setWithCredentials(this.withCredentials),S.load(i,async b=>{if(typeof b!="string")throw new Error("Invalid metadata string");u=JSON.parse(b),await h()},b=>{v=b.lengthComputable,C=b.loaded,E=b.total,I()},b=>{this.manager.itemError(i),typeof o=="function"&&o(b)}),a}}class gL extends fI{load(e,t,i,n){const s=this.prepareQuadRenderer(),o=new In(this._internalLoadingManager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(this.withCredentials),this.manager.itemStart(e),o.load(e,async a=>{if(typeof a=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const l=new Uint8Array(a);let c,u,h;try{const f=await AL(l);c=f.sdr,u=f.gainMap,h=f.metadata}catch(f){if(f instanceof hI||f instanceof uI)console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),h={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},c=l;else throw f}try{await this.render(s,h,c,u)}catch(f){this.manager.itemError(e),typeof n=="function"&&n(f),s.disposeOnDemandRenderer();return}typeof t=="function"&&t(s),this.manager.itemEnd(e),s.disposeOnDemandRenderer()},i,a=>{this.manager.itemError(e),typeof n=="function"&&n(a)}),s}}const lc={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},dI="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",ha=r=>Array.isArray(r),qA=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function sf({files:r=qA,path:e="",preset:t=void 0,encoding:i=void 0,extensions:n}={}){let s=null,o=!1;t&&(XA(t),r=lc[t],e=dI),o=ha(r);const{extension:a,isCubemap:l}=JA(r);if(s=ZA(a),!s)throw new Error("useEnvironment: Unrecognized file extension: "+r);const c=de(d=>d.gl);y.useLayoutEffect(()=>{if(a!=="webp"&&a!=="jpg"&&a!=="jpeg")return;function d(){gi.clear(s,o?[r]:r)}c.domElement.addEventListener("webglcontextlost",d,{once:!0})},[r,c.domElement]);const u=gi(s,o?[r]:r,d=>{(a==="webp"||a==="jpg"||a==="jpeg")&&d.setRenderer(c),d.setPath==null||d.setPath(e),n&&n(d)});let h=o?u[0]:u;if(a==="jpg"||a==="jpeg"||a==="webp"){var f;h=(f=h.renderTarget)==null?void 0:f.texture}return h.mapping=l?N2:U2,"colorSpace"in h?h.colorSpace=i??l?"srgb":"srgb-linear":h.encoding=i??l?zM:QM,h}const yL={files:qA,path:"",preset:void 0,extensions:void 0};sf.preload=r=>{const e={...yL,...r};let{files:t,path:i=""}=e;const{preset:n,extensions:s}=e;n&&(XA(n),t=lc[n],i=dI);const{extension:o}=JA(t);if(o==="webp"||o==="jpg"||o==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const a=ZA(o);if(!a)throw new Error("useEnvironment: Unrecognized file extension: "+t);gi.preload(a,ha(t)?[t]:t,l=>{l.setPath==null||l.setPath(i),s&&s(l)})};const vL={files:qA,preset:void 0};sf.clear=r=>{const e={...vL,...r};let{files:t}=e;const{preset:i}=e;i&&(XA(i),t=lc[i]);const{extension:n}=JA(t),s=ZA(n);if(!s)throw new Error("useEnvironment: Unrecognized file extension: "+t);gi.clear(s,ha(t)?[t]:t)};function XA(r){if(!(r in lc))throw new Error("Preset must be one of: "+Object.keys(lc).join(", "))}function JA(r){var e;const t=ha(r)&&r.length===6,i=ha(r)&&r.length===3&&r.some(o=>o.endsWith("json")),n=ha(r)?r[0]:r;return{extension:t?"cube":i?"webp":n.startsWith("data:application/exr")?"exr":n.startsWith("data:application/hdr")?"hdr":n.startsWith("data:image/jpeg")?"jpg":(e=n.split(".").pop())==null||(e=e.split("?"))==null||(e=e.shift())==null?void 0:e.toLowerCase(),isCubemap:t,isGainmap:i}}function ZA(r){return r==="cube"?Gm:r==="hdr"?fb:r==="exr"?db:r==="jpg"||r==="jpeg"?gL:r==="webp"?pL:null}const EL=r=>r.current&&r.current.isScene,CL=r=>EL(r)?r.current:r;function ep(r,e,t,i,n={}){var s,o,a,l;n={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...n};const c=CL(e||t),u=c.background,h=c.environment,f={backgroundBlurriness:c.backgroundBlurriness,backgroundIntensity:c.backgroundIntensity,backgroundRotation:(s=(o=c.backgroundRotation)==null||o.clone==null?void 0:o.clone())!==null&&s!==void 0?s:[0,0,0],environmentIntensity:c.environmentIntensity,environmentRotation:(a=(l=c.environmentRotation)==null||l.clone==null?void 0:l.clone())!==null&&a!==void 0?a:[0,0,0]};return r!=="only"&&(c.environment=i),r&&(c.background=i),wn(c,n),()=>{r!=="only"&&(c.environment=h),r&&(c.background=u),wn(c,f)}}function tp({scene:r,background:e=!1,map:t,...i}){const n=de(s=>s.scene);return y.useLayoutEffect(()=>{if(t)return ep(e,r,n,t,i)}),null}function mI({background:r=!1,scene:e,blur:t,backgroundBlurriness:i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a,...l}){const c=sf(l),u=de(h=>h.scene);return y.useLayoutEffect(()=>ep(r,e,u,c,{backgroundBlurriness:t??i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a})),y.useEffect(()=>()=>{c.dispose()},[c]),null}function IL({children:r,near:e=.1,far:t=1e3,resolution:i=256,frames:n=1,map:s,background:o=!1,blur:a,backgroundBlurriness:l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f,scene:d,files:m,path:A,preset:p=void 0,extensions:g}){const v=de(S=>S.gl),E=de(S=>S.scene),C=y.useRef(null),[I]=y.useState(()=>new Nr),_=y.useMemo(()=>{const S=new Dh(i);return S.texture.type=Ai,S},[i]);y.useEffect(()=>()=>{_.dispose()},[_]),y.useLayoutEffect(()=>{if(n===1){const S=v.autoClear;v.autoClear=!0,C.current.update(v,I),v.autoClear=S}return ep(o,d,E,_.texture,{backgroundBlurriness:a??l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f})},[r,I,_.texture,d,E,o,n,v]);let x=1;return We(()=>{if(n===1/0||x<n){const S=v.autoClear;v.autoClear=!0,C.current.update(v,I),v.autoClear=S,x++}}),y.createElement(y.Fragment,null,uo(y.createElement(y.Fragment,null,r,y.createElement("cubeCamera",{ref:C,args:[e,t,_]}),m||p?y.createElement(mI,{background:!0,files:m,preset:p,path:A,extensions:g}):s?y.createElement(tp,{background:!0,map:s,extensions:g}):null),I))}function _L(r){var e,t,i,n;const s=sf(r),o=r.map||s;y.useMemo(()=>xi({GroundProjectedEnvImpl:zS}),[]),y.useEffect(()=>()=>{s.dispose()},[s]);const a=y.useMemo(()=>[o],[o]),l=(e=r.ground)==null?void 0:e.height,c=(t=r.ground)==null?void 0:t.radius,u=(i=(n=r.ground)==null?void 0:n.scale)!==null&&i!==void 0?i:1e3;return y.createElement(y.Fragment,null,y.createElement(tp,_e({},r,{map:o})),y.createElement("groundProjectedEnvImpl",{args:a,scale:u,height:l,radius:c}))}function xL(r){return r.ground?y.createElement(_L,r):r.map?y.createElement(tp,r):r.children?y.createElement(IL,r):y.createElement(mI,r)}const SL=y.forwardRef(({scale:r=10,frames:e=1/0,opacity:t=1,width:i=1,height:n=1,blur:s=1,near:o=0,far:a=10,resolution:l=512,smooth:c=!0,color:u="#000000",depthWrite:h=!1,renderOrder:f,...d},m)=>{const A=y.useRef(null),p=de(D=>D.scene),g=de(D=>D.gl),v=y.useRef(null);i=i*(Array.isArray(r)?r[0]:r||1),n=n*(Array.isArray(r)?r[1]:r||1);const[E,C,I,_,x,S,b]=y.useMemo(()=>{const D=new _i(l,l),G=new _i(l,l);G.texture.generateMipmaps=D.texture.generateMipmaps=!1;const z=new an(i,n).rotateX(Math.PI/2),W=new je(z),q=new H2;q.depthTest=q.depthWrite=!1,q.onBeforeCompile=L=>{L.uniforms={...L.uniforms,ucolor:{value:new et(u)}},L.fragmentShader=L.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),L.fragmentShader=L.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const F=new bi(A6),N=new bi(p6);return N.depthTest=F.depthTest=!1,[D,z,q,W,F,N,G]},[l,i,n,r,u]),T=D=>{_.visible=!0,_.material=x,x.uniforms.tDiffuse.value=E.texture,x.uniforms.h.value=D*1/256,g.setRenderTarget(b),g.render(_,v.current),_.material=S,S.uniforms.tDiffuse.value=b.texture,S.uniforms.v.value=D*1/256,g.setRenderTarget(E),g.render(_,v.current),_.visible=!1};let B=0,w,R;return We(()=>{v.current&&(e===1/0||B<e)&&(B++,w=p.background,R=p.overrideMaterial,A.current.visible=!1,p.background=null,p.overrideMaterial=I,g.setRenderTarget(E),g.render(p,v.current),T(s),c&&T(s*.4),g.setRenderTarget(null),A.current.visible=!0,p.overrideMaterial=R,p.background=w)}),y.useImperativeHandle(m,()=>A.current,[]),y.createElement("group",_e({"rotation-x":Math.PI/2},d,{ref:A}),y.createElement("mesh",{renderOrder:f,geometry:C,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},y.createElement("meshBasicMaterial",{transparent:!0,map:E.texture,opacity:t,depthWrite:h})),y.createElement("orthographicCamera",{ref:v,args:[-i/2,i/2,n/2,-n/2,o,a]}))});function TL(r){return r.isLight}function bL(r){return!!r.geometry}const AI=y.createContext(null),wL=vs({color:new et,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),BL=y.forwardRef(({children:r,temporal:e,frames:t=40,limit:i=1/0,blend:n=20,scale:s=10,opacity:o=1,alphaTest:a=.75,color:l="black",colorBlend:c=2,resolution:u=1024,toneMapped:h=!0,...f},d)=>{xi({SoftShadowMaterial:wL});const m=de(_=>_.gl),A=de(_=>_.scene),p=de(_=>_.camera),g=de(_=>_.invalidate),v=y.useRef(null),E=y.useRef(null),[C]=y.useState(()=>new DL(m,A,u));y.useLayoutEffect(()=>{C.configure(v.current)},[]);const I=y.useMemo(()=>({lights:new Map,temporal:!!e,frames:Math.max(2,t),blend:Math.max(2,t===1/0?n:t),count:0,getMesh:()=>v.current,reset:()=>{C.clear();const _=v.current.material;_.opacity=0,_.alphaTest=0,I.count=0},update:(_=1)=>{const x=v.current.material;I.temporal?(x.opacity=Math.min(o,x.opacity+o/I.blend),x.alphaTest=Math.min(a,x.alphaTest+a/I.blend)):(x.opacity=o,x.alphaTest=a),E.current.visible=!0,C.prepare();for(let S=0;S<_;S++)I.lights.forEach(b=>b.update()),C.update(p,I.blend);E.current.visible=!1,C.finish()}}),[C,p,A,e,t,n,o,a]);return y.useLayoutEffect(()=>{I.reset(),!I.temporal&&I.frames!==1/0&&I.update(I.blend)}),y.useImperativeHandle(d,()=>I,[I]),We(()=>{(I.temporal||I.frames===1/0)&&I.count<I.frames&&I.count<i&&(g(),I.update(),I.count++)}),y.createElement("group",f,y.createElement("group",{traverse:()=>null,ref:E},y.createElement(AI.Provider,{value:I},r)),y.createElement("mesh",{receiveShadow:!0,ref:v,scale:s,rotation:[-Math.PI/2,0,0]},y.createElement("planeGeometry",null),y.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:h,color:l,blend:c,map:C.progressiveLightMap2.texture})))}),RL=y.forwardRef(({castShadow:r=!0,bias:e=.001,mapSize:t=512,size:i=5,near:n=.5,far:s=500,frames:o=1,position:a=[0,0,0],radius:l=1,amount:c=8,intensity:u=sn>=155?Math.PI:1,ambient:h=.5,...f},d)=>{const m=y.useRef(null),A=new K(...a).length(),p=y.useContext(AI),g=y.useCallback(()=>{let E;if(m.current)for(let C=0;C<m.current.children.length;C++)if(E=m.current.children[C],Math.random()>h)E.position.set(a[0]+ot.randFloatSpread(l),a[1]+ot.randFloatSpread(l),a[2]+ot.randFloatSpread(l));else{let I=Math.acos(2*Math.random()-1)-Math.PI/2,_=2*Math.PI*Math.random();E.position.set(Math.cos(I)*Math.cos(_)*A,Math.abs(Math.cos(I)*Math.sin(_)*A),Math.sin(I)*A)}},[l,h,A,...a]),v=y.useMemo(()=>({update:g}),[g]);return y.useImperativeHandle(d,()=>v,[v]),y.useLayoutEffect(()=>{var E;const C=m.current;return p&&((E=p.lights)==null||E.set(C.uuid,v)),()=>{var I;return void(p==null||(I=p.lights)==null?void 0:I.delete(C.uuid))}},[p,v]),y.createElement("group",_e({ref:m},f),Array.from({length:c},(E,C)=>y.createElement("directionalLight",{key:C,castShadow:r,"shadow-bias":e,"shadow-mapSize":[t,t],intensity:u/c},y.createElement("orthographicCamera",{attach:"shadow-camera",args:[-i,i,i,-i,n,s]}))))});class DL{constructor(e,t,i=1024){this.renderer=e,this.res=i,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new et,this.clearAlpha=0;const n={type:Ai,magFilter:li,minFilter:li};this.progressiveLightMap1=new _i(this.res,this.res,n),this.progressiveLightMap2=new _i(this.res,this.res,n),this.discardMat=new YA,this.targetMat=new Om({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=s=>{s.vertexShader=`varying vec2 vUv;
`+s.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const o=s.fragmentShader.indexOf("void main() {");s.fragmentShader=`varying vec2 vUv;
`+s.fragmentShader.slice(0,o)+`uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+s.fragmentShader.slice(o-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,s.uniforms.previousShadowMap=this.previousShadowMap,s.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{bL(e)?this.meshes.push({object:e,material:e.material}):TL(e)&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,n=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,s=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(i),this.previousShadowMap.value=n.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=s}}const ML={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function LL({radius:r,adjustCamera:e}){const t=lL();return y.useEffect(()=>{e&&t.refresh().clip().fit()},[r,e]),null}function EO({children:r,center:e,adjustCamera:t=!0,intensity:i=.5,shadows:n="contact",environment:s="city",preset:o="rembrandt",...a}){var l,c,u,h,f,d,m,A;const p=typeof o=="string"?ML[o]:o,[{radius:g,height:v},E]=y.useState({radius:0,width:0,height:0,depth:0}),C=(l=n?.bias)!==null&&l!==void 0?l:-1e-4,I=(c=n?.normalBias)!==null&&c!==void 0?c:0,_=(u=n?.size)!==null&&u!==void 0?u:1024,x=(h=n?.offset)!==null&&h!==void 0?h:0,S=n==="contact"||n?.type==="contact",b=n==="accumulative"||n?.type==="accumulative",T={...typeof n=="object"?n:{}},B=s?typeof s=="string"?{preset:s}:s:null,w=y.useCallback(R=>{const{width:D,height:G,depth:z,boundingSphere:W}=R;E({radius:W.radius,width:D,height:G,depth:z}),e!=null&&e.onCentered&&e.onCentered(R)},[]);return y.createElement(y.Fragment,null,y.createElement("ambientLight",{intensity:i/3}),y.createElement("spotLight",{penumbra:1,position:[p.main[0]*g,p.main[1]*g,p.main[2]*g],intensity:i*2,castShadow:!!n,"shadow-bias":C,"shadow-normalBias":I,"shadow-mapSize":_}),y.createElement("pointLight",{position:[p.fill[0]*g,p.fill[1]*g,p.fill[2]*g],intensity:i}),y.createElement(aL,_e({fit:!!t,clip:!!t,margin:Number(t),observe:!0},a),y.createElement(LL,{radius:g,adjustCamera:t}),y.createElement(tI,_e({},e,{position:[0,x/2,0],onCentered:w}),r)),y.createElement("group",{position:[0,-v/2-x/2,0]},S&&y.createElement(SL,_e({scale:g*4,far:g,blur:2},T)),b&&y.createElement(BL,_e({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:g*4},T),y.createElement(RL,{amount:(f=T.amount)!==null&&f!==void 0?f:8,radius:(d=T.radius)!==null&&d!==void 0?d:g,ambient:(m=T.ambient)!==null&&m!==void 0?m:.5,intensity:(A=T.intensity)!==null&&A!==void 0?A:1,position:[p.main[0]*g,p.main[1]*g,p.main[2]*g],size:g*4,bias:-C,mapSize:_}))),s&&y.createElement(xL,B))}const PL=r=>r===0?0:Math.pow(2,10*r-10);function CO({children:r,floor:e=.25,segments:t=20,receiveShadow:i,...n}){const s=y.useRef(null);return y.useLayoutEffect(()=>{let o=0;const a=t/t/2,l=s.current.attributes.position;for(let c=0;c<t+1;c++)for(let u=0;u<t+1;u++)l.setXYZ(o++,c/t-a+(c===0?-e:0),u/t-a,PL(c/t));l.needsUpdate=!0,s.current.computeVertexNormals()},[t,e]),y.createElement("group",n,y.createElement("mesh",{receiveShadow:i,rotation:[-Math.PI/2,0,Math.PI/2]},y.createElement("planeGeometry",{ref:s,args:[1,1,t,t]}),r))}const IO=y.forwardRef(({fog:r=!1,renderOrder:e,depthWrite:t=!1,colorStop:i=0,color:n="black",opacity:s=.5,...o},a)=>{const l=y.useMemo(()=>{const c=document.createElement("canvas");c.width=128,c.height=128;const u=c.getContext("2d"),h=u.createRadialGradient(c.width/2,c.height/2,0,c.width/2,c.height/2,c.width/2);return h.addColorStop(i,new et(n).getStyle()),h.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=h,u.fillRect(0,0,c.width,c.height),c},[n,i]);return y.createElement("mesh",_e({renderOrder:e,ref:a,"rotation-x":-Math.PI/2},o),y.createElement("planeGeometry",null),y.createElement("meshBasicMaterial",{transparent:!0,opacity:s,fog:r,depthWrite:t,side:wi},y.createElement("canvasTexture",{attach:"map",args:[l]})))});function Pv(r=Yl){const e={value:new Me};return Object.assign(new B_({side:r}),{viewMatrix:e,onBeforeCompile:t=>{t.uniforms.viewMatrix=e,t.fragmentShader=`vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
           return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
         }
`+t.fragmentShader.replace("#include <normal_fragment_maps>",`#include <normal_fragment_maps>
           normal = inverseTransformDirection( normal, viewMatrix );
`)}})}const FL=vs({causticsTexture:null,causticsTextureB:null,color:new et,lightProjMatrix:new Me,lightViewMatrix:new Me},`varying vec3 vWorldPosition;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vec4 worldPosition = modelMatrix * vec4(position, 1.);
     vWorldPosition = worldPosition.xyz;
   }`,`varying vec3 vWorldPosition;
  uniform vec3 color;
  uniform sampler2D causticsTexture;
  uniform sampler2D causticsTextureB;
  uniform mat4 lightProjMatrix;
  uniform mat4 lightViewMatrix;
   void main() {
    // Apply caustics
    vec4 lightSpacePos = lightProjMatrix * lightViewMatrix * vec4(vWorldPosition, 1.0);
    lightSpacePos.xyz /= lightSpacePos.w;
    lightSpacePos.xyz = lightSpacePos.xyz * 0.5 + 0.5;
    vec3 front = texture2D(causticsTexture, lightSpacePos.xy).rgb;
    vec3 back = texture2D(causticsTextureB, lightSpacePos.xy).rgb;
    gl_FragColor = vec4((front + back) * color, 1.0);
    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),kL=vs({cameraMatrixWorld:new Me,cameraProjectionMatrixInv:new Me,normalTexture:null,depthTexture:null,lightDir:new K(0,1,0),lightPlaneNormal:new K(0,1,0),lightPlaneConstant:0,near:.1,far:100,modelMatrix:new Me,worldRadius:1/40,ior:1.1,bounces:0,resolution:1024,size:10,intensity:.5},`
  varying vec2 vUv;
  void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }`,`
  uniform mat4 cameraMatrixWorld;
  uniform mat4 cameraProjectionMatrixInv;
  uniform vec3 lightDir;
  uniform vec3 lightPlaneNormal;
  uniform float lightPlaneConstant;
  uniform float near;
  uniform float far;
  uniform float time;
  uniform float worldRadius;
  uniform float resolution;
  uniform float size;
  uniform float intensity;
  uniform float ior;
  precision highp isampler2D;
  precision highp usampler2D;
  uniform sampler2D normalTexture;
  uniform sampler2D depthTexture;
  uniform float bounces;
  varying vec2 vUv;
  vec3 WorldPosFromDepth(float depth, vec2 coord) {
    float z = depth * 2.0 - 1.0;
    vec4 clipSpacePosition = vec4(coord * 2.0 - 1.0, z, 1.0);
    vec4 viewSpacePosition = cameraProjectionMatrixInv * clipSpacePosition;
    // Perspective division
    viewSpacePosition /= viewSpacePosition.w;
    vec4 worldSpacePosition = cameraMatrixWorld * viewSpacePosition;
    return worldSpacePosition.xyz;
  }
  float sdPlane( vec3 p, vec3 n, float h ) {
    // n must be normalized
    return dot(p,n) + h;
  }
  float planeIntersect( vec3 ro, vec3 rd, vec4 p ) {
    return -(dot(ro,p.xyz)+p.w)/dot(rd,p.xyz);
  }
  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 pos, vec3 normal, float ior, out vec3 rayOrigin, out vec3 rayDirection) {
    rayOrigin = ro;
    rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = pos + rayDirection * 0.1;
    return rayDirection;
  }
  void main() {
    // Each sample consists of random offset in the x and y direction
    float caustic = 0.0;
    float causticTexelSize = (1.0 / resolution) * size * 2.0;
    float texelsNeeded = worldRadius / causticTexelSize;
    float sampleRadius = texelsNeeded / resolution;
    float sum = 0.0;
    if (texture2D(depthTexture, vUv).x == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec2 offset1 = vec2(-0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset2 = vec2(-0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset3 = vec2(0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset4 = vec2(0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 uv1 = vUv + offset1 * sampleRadius;
    vec2 uv2 = vUv + offset2 * sampleRadius;
    vec2 uv3 = vUv + offset3 * sampleRadius;
    vec2 uv4 = vUv + offset4 * sampleRadius;
    vec3 normal1 = texture2D(normalTexture, uv1, -10.0).rgb * 2.0 - 1.0;
    vec3 normal2 = texture2D(normalTexture, uv2, -10.0).rgb * 2.0 - 1.0;
    vec3 normal3 = texture2D(normalTexture, uv3, -10.0).rgb * 2.0 - 1.0;
    vec3 normal4 = texture2D(normalTexture, uv4, -10.0).rgb * 2.0 - 1.0;
    float depth1 = texture2D(depthTexture, uv1, -10.0).x;
    float depth2 = texture2D(depthTexture, uv2, -10.0).x;
    float depth3 = texture2D(depthTexture, uv3, -10.0).x;
    float depth4 = texture2D(depthTexture, uv4, -10.0).x;
    // Sanity check the depths
    if (depth1 == 1.0 || depth2 == 1.0 || depth3 == 1.0 || depth4 == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec3 pos1 = WorldPosFromDepth(depth1, uv1);
    vec3 pos2 = WorldPosFromDepth(depth2, uv2);
    vec3 pos3 = WorldPosFromDepth(depth3, uv3);
    vec3 pos4 = WorldPosFromDepth(depth4, uv4);
    vec3 originPos1 = WorldPosFromDepth(0.0, uv1);
    vec3 originPos2 = WorldPosFromDepth(0.0, uv2);
    vec3 originPos3 = WorldPosFromDepth(0.0, uv3);
    vec3 originPos4 = WorldPosFromDepth(0.0, uv4);
    vec3 endPos1, endPos2, endPos3, endPos4;
    vec3 endDir1, endDir2, endDir3, endDir4;
    totalInternalReflection(originPos1, lightDir, pos1, normal1, ior, endPos1, endDir1);
    totalInternalReflection(originPos2, lightDir, pos2, normal2, ior, endPos2, endDir2);
    totalInternalReflection(originPos3, lightDir, pos3, normal3, ior, endPos3, endDir3);
    totalInternalReflection(originPos4, lightDir, pos4, normal4, ior, endPos4, endDir4);
    float lightPosArea = length(cross(originPos2 - originPos1, originPos3 - originPos1)) + length(cross(originPos3 - originPos1, originPos4 - originPos1));
    float t1 = planeIntersect(endPos1, endDir1, vec4(lightPlaneNormal, lightPlaneConstant));
    float t2 = planeIntersect(endPos2, endDir2, vec4(lightPlaneNormal, lightPlaneConstant));
    float t3 = planeIntersect(endPos3, endDir3, vec4(lightPlaneNormal, lightPlaneConstant));
    float t4 = planeIntersect(endPos4, endDir4, vec4(lightPlaneNormal, lightPlaneConstant));
    vec3 finalPos1 = endPos1 + endDir1 * t1;
    vec3 finalPos2 = endPos2 + endDir2 * t2;
    vec3 finalPos3 = endPos3 + endDir3 * t3;
    vec3 finalPos4 = endPos4 + endDir4 * t4;
    float finalArea = length(cross(finalPos2 - finalPos1, finalPos3 - finalPos1)) + length(cross(finalPos3 - finalPos1, finalPos4 - finalPos1));
    caustic += intensity * (lightPosArea / finalArea);
    // Calculate the area of the triangle in light spaces
    gl_FragColor = vec4(vec3(max(caustic, 0.0)), 1.0);
  }`),Fv={depth:!0,minFilter:jt,magFilter:jt,type:$i},kv={minFilter:uc,magFilter:jt,type:hi,generateMipmaps:!0},_O=y.forwardRef(({debug:r,children:e,frames:t=1,ior:i=1.1,color:n="white",causticsOnly:s=!1,backside:o=!1,backsideIOR:a=1.1,worldRadius:l=.3125,intensity:c=.05,resolution:u=2024,lightSource:h=[5,5,5],...f},d)=>{xi({CausticsProjectionMaterial:FL});const m=y.useRef(null),A=y.useRef(null),p=y.useRef(null),g=y.useRef(null),v=de(Q=>Q.gl),E=GC(r&&A,b_),C=En(u,u,Fv),I=En(u,u,Fv),_=En(u,u,kv),x=En(u,u,kv),[S]=y.useState(()=>Pv()),[b]=y.useState(()=>Pv(hc)),[T]=y.useState(()=>new kL),[B]=y.useState(()=>new nr(T));y.useLayoutEffect(()=>{m.current.updateWorldMatrix(!1,!0)});let w=0;const R=new K,D=new O2,G=new Me,z=new Hs,W=new K,q=new K,F=new oi,N=new K,L=[],$=[],j=[],V=[],k=new K;for(let Q=0;Q<8;Q++)L.push(new K),$.push(new K),j.push(new K),V.push(new K);return We(()=>{if(t===1/0||w++<t){var Q,O;Array.isArray(h)?W.fromArray(h).normalize():W.copy(m.current.worldToLocal(h.current.getWorldPosition(R)).normalize()),q.copy(W).multiplyScalar(-1),(Q=p.current.parent)==null||Q.matrixWorld.identity(),F.setFromObject(p.current,!0),L[0].set(F.min.x,F.min.y,F.min.z),L[1].set(F.min.x,F.min.y,F.max.z),L[2].set(F.min.x,F.max.y,F.min.z),L[3].set(F.min.x,F.max.y,F.max.z),L[4].set(F.max.x,F.min.y,F.min.z),L[5].set(F.max.x,F.min.y,F.max.z),L[6].set(F.max.x,F.max.y,F.min.z),L[7].set(F.max.x,F.max.y,F.max.z);for(let Z=0;Z<8;Z++)$[Z].copy(L[Z]);F.getCenter(N),L.map(Z=>Z.sub(N));const U=z.set(q,0);L.map((Z,J)=>U.projectPoint(Z,j[J]));const te=j.reduce((Z,J)=>Z.add(J),R.set(0,0,0)).divideScalar(j.length),le=j.map(Z=>Z.distanceTo(te)).reduce((Z,J)=>Math.max(Z,J)),ee=L.map(Z=>Z.dot(W)).reduce((Z,J)=>Math.max(Z,J));A.current.position.copy(k.copy(W).multiplyScalar(ee).add(N)),A.current.lookAt(p.current.localToWorld(N));const se=G.lookAt(A.current.position,N,R.set(0,1,0));A.current.left=-le,A.current.right=le,A.current.top=le,A.current.bottom=-le;const Ee=R.set(0,le,0).applyMatrix4(se),Ie=(A.current.position.y+Ee.y)/W.y;A.current.near=.1,A.current.far=Ie,A.current.updateProjectionMatrix(),A.current.updateMatrixWorld();const oe=$.map((Z,J)=>Z.add(V[J].copy(W).multiplyScalar(-Z.y/W.y))),ce=oe.reduce((Z,J)=>Z.add(J),R.set(0,0,0)).divideScalar(oe.length),Ae=2*oe.map(Z=>Math.hypot(Z.x-ce.x,Z.z-ce.z)).reduce((Z,J)=>Math.max(Z,J));g.current.scale.setScalar(Ae),g.current.position.copy(ce),r&&((O=E.current)==null||O.update()),b.viewMatrix.value=S.viewMatrix.value=A.current.matrixWorldInverse;const he=D.setFromProjectionMatrix(G.multiplyMatrices(A.current.projectionMatrix,A.current.matrixWorldInverse)).planes[4];T.cameraMatrixWorld=A.current.matrixWorld,T.cameraProjectionMatrixInv=A.current.projectionMatrixInverse,T.lightDir=q,T.lightPlaneNormal=he.normal,T.lightPlaneConstant=he.constant,T.near=A.current.near,T.far=A.current.far,T.resolution=u,T.size=le,T.intensity=c,T.worldRadius=l,p.current.visible=!0,v.setRenderTarget(C),v.clear(),p.current.overrideMaterial=S,v.render(p.current,A.current),v.setRenderTarget(I),v.clear(),o&&(p.current.overrideMaterial=b,v.render(p.current,A.current)),p.current.overrideMaterial=null,T.ior=i,g.current.material.lightProjMatrix=A.current.projectionMatrix,g.current.material.lightViewMatrix=A.current.matrixWorldInverse,T.normalTexture=C.texture,T.depthTexture=C.depthTexture,v.setRenderTarget(_),v.clear(),B.render(v),T.ior=a,T.normalTexture=I.texture,T.depthTexture=I.depthTexture,v.setRenderTarget(x),v.clear(),o&&B.render(v),v.setRenderTarget(null),s&&(p.current.visible=!1)}}),y.useImperativeHandle(d,()=>m.current,[]),y.createElement("group",_e({ref:m},f),y.createElement("scene",{ref:p},y.createElement("orthographicCamera",{ref:A,up:[0,1,0]}),e),y.createElement("mesh",{renderOrder:2,ref:g,"rotation-x":-Math.PI/2},y.createElement("planeGeometry",null),y.createElement("causticsProjectionMaterial",{transparent:!0,color:n,causticsTexture:_.texture,causticsTextureB:x.texture,blending:$2,blendSrc:K2,blendDst:w_,depthWrite:!1}),r&&y.createElement(Mw,null,y.createElement("lineBasicMaterial",{color:"#ffff00",toneMapped:!1}))))}),xO=y.forwardRef(({mixBlur:r=0,mixStrength:e=.5,resolution:t=256,blur:i=[0,0],args:n=[1,1],minDepthThreshold:s=.9,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:l=.25,mirror:c=0,children:u,debug:h=0,distortion:f=1,mixContrast:d=1,distortionMap:m,...A},p)=>{xi({MeshReflectorMaterial:aI}),y.useEffect(()=>{console.warn("Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!")},[]);const g=de(({gl:j})=>j),v=de(({camera:j})=>j),E=de(({scene:j})=>j);i=Array.isArray(i)?i:[i,i];const C=i[0]+i[1]>0,I=y.useRef(null);y.useImperativeHandle(p,()=>I.current,[]);const[_]=y.useState(()=>new Hs),[x]=y.useState(()=>new K),[S]=y.useState(()=>new K),[b]=y.useState(()=>new K),[T]=y.useState(()=>new Me),[B]=y.useState(()=>new K(0,0,-1)),[w]=y.useState(()=>new Ci),[R]=y.useState(()=>new K),[D]=y.useState(()=>new K),[G]=y.useState(()=>new Ci),[z]=y.useState(()=>new Me),[W]=y.useState(()=>new ri),q=y.useCallback(()=>{if(S.setFromMatrixPosition(I.current.matrixWorld),b.setFromMatrixPosition(v.matrixWorld),T.extractRotation(I.current.matrixWorld),x.set(0,0,1),x.applyMatrix4(T),R.subVectors(S,b),R.dot(x)>0)return;R.reflect(x).negate(),R.add(S),T.extractRotation(v.matrixWorld),B.set(0,0,-1),B.applyMatrix4(T),B.add(b),D.subVectors(S,B),D.reflect(x).negate(),D.add(S),W.position.copy(R),W.up.set(0,1,0),W.up.applyMatrix4(T),W.up.reflect(x),W.lookAt(D),W.far=v.far,W.updateMatrixWorld(),W.projectionMatrix.copy(v.projectionMatrix),z.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),z.multiply(W.projectionMatrix),z.multiply(W.matrixWorldInverse),z.multiply(I.current.matrixWorld),_.setFromNormalAndCoplanarPoint(x,S),_.applyMatrix4(W.matrixWorldInverse),w.set(_.normal.x,_.normal.y,_.normal.z,_.constant);const j=W.projectionMatrix;G.x=(Math.sign(w.x)+j.elements[8])/j.elements[0],G.y=(Math.sign(w.y)+j.elements[9])/j.elements[5],G.z=-1,G.w=(1+j.elements[10])/j.elements[14],w.multiplyScalar(2/w.dot(G)),j.elements[2]=w.x,j.elements[6]=w.y,j.elements[10]=w.z+1,j.elements[14]=w.w},[]),[F,N,L,$]=y.useMemo(()=>{const j={type:Ai,minFilter:jt,magFilter:jt},V=new _i(t,t,j);V.depthBuffer=!0,V.depthTexture=new Rh(t,t),V.depthTexture.format=Hm,V.depthTexture.type=Mh;const k=new _i(t,t,j),Q=new oI({gl:g,resolution:t,width:i[0],height:i[1],minDepthThreshold:s,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:l}),O={mirror:c,textureMatrix:z,mixBlur:r,tDiffuse:V.texture,tDepth:V.depthTexture,tDiffuseBlur:k.texture,hasBlur:C,mixStrength:e,minDepthThreshold:s,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:l,transparent:!0,debug:h,distortion:f,distortionMap:m,mixContrast:d,"defines-USE_BLUR":C?"":void 0,"defines-USE_DEPTH":a>0?"":void 0,"defines-USE_DISTORTION":m?"":void 0};return[V,k,Q,O]},[g,i,z,t,c,C,r,e,s,o,a,l,h,f,m,d]);return We(()=>{if(!(I!=null&&I.current))return;I.current.visible=!1;const j=g.xr.enabled,V=g.shadowMap.autoUpdate;q(),g.xr.enabled=!1,g.shadowMap.autoUpdate=!1,g.setRenderTarget(F),g.state.buffers.depth.setMask(!0),g.autoClear||g.clear(),g.render(E,W),C&&L.render(g,F,N),g.xr.enabled=j,g.shadowMap.autoUpdate=V,I.current.visible=!0,g.setRenderTarget(null)}),y.createElement("mesh",_e({ref:I},A),y.createElement("planeGeometry",{args:n}),u?u("meshReflectorMaterial",$):y.createElement("meshReflectorMaterial",$))});class OL extends bi{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new K(0,0,0)},lightColor:{value:new et("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new Fe(0,0)}},transparent:!0,depthWrite:!1,vertexShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;
        uniform vec3 spotPosition;
        uniform float attenuation;

        #include <common>
        #include <logdepthbuf_pars_vertex>

        void main() {
          // compute intensity
          vNormal = normalize(normalMatrix * normal);
          vec4 worldPosition = modelMatrix * vec4(position, 1);
          vec4 viewPosition = viewMatrix * worldPosition;
          vViewZ = viewPosition.z;

          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);

          gl_Position = projectionMatrix * viewPosition;

          #include <logdepthbuf_vertex>
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;

        uniform vec3 lightColor;
        uniform float anglePower;
        uniform sampler2D depth;
        uniform vec2 resolution;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float opacity;

        #include <packing>
        #include <logdepthbuf_pars_fragment>

        float readDepth(sampler2D depthSampler, vec2 uv) {
          float fragCoordZ = texture(depthSampler, uv).r;

          // https://github.com/mrdoob/three.js/issues/23072
          #ifdef USE_LOGDEPTHBUF
            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));
          #else
            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
          #endif

          return viewZ;
        }

        void main() {
          #include <logdepthbuf_fragment>

          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);
          float intensity = vIntensity * angleIntensity;

          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry
          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;
          if (isSoft) {
            vec2 uv = gl_FragCoord.xy / resolution;
            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));
          }

          gl_FragColor = vec4(lightColor, intensity * opacity);

          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}}var UL=`#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}`;const NL=r=>r?.isSpotLight;function GL({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5}){const c=y.useRef(null),u=de(p=>p.size),h=de(p=>p.camera),f=de(p=>p.viewport.dpr),[d]=y.useState(()=>new OL),[m]=y.useState(()=>new K);e=e===void 0?.1:e,t=t===void 0?o*7:t,We(()=>{d.uniforms.spotPosition.value.copy(c.current.getWorldPosition(m)),c.current.lookAt(c.current.parent.target.getWorldPosition(m))});const A=y.useMemo(()=>{const p=new Qn(e,t,s,128,64,!0);return p.applyMatrix4(new Me().makeTranslation(0,-s/2,0)),p.applyMatrix4(new Me().makeRotationX(-Math.PI/2)),p},[s,e,t]);return y.createElement(y.Fragment,null,y.createElement("mesh",{ref:c,geometry:A,raycast:()=>null},y.createElement("primitive",{object:d,attach:"material","uniforms-opacity-value":r,"uniforms-lightColor-value":n,"uniforms-attenuation-value":a,"uniforms-anglePower-value":l,"uniforms-depth-value":i,"uniforms-cameraNear-value":h.near,"uniforms-cameraFar-value":h.far,"uniforms-resolution-value":i?[u.width*f,u.height*f]:[0,0]})))}function pI(r,e,t,i,n){const[[s,o]]=y.useState(()=>[new K,new K]);y.useLayoutEffect(()=>{if(NL(r.current))r.current.shadow.mapSize.set(t,i),r.current.shadow.needsUpdate=!0;else throw new Error("SpotlightShadow must be a child of a SpotLight")},[r,t,i]),We(()=>{if(!r.current)return;const a=r.current.position,l=r.current.target.position;o.copy(l).sub(a);var c=o.length();o.normalize().multiplyScalar(c*n),s.copy(a).add(o),e.current.position.copy(s),e.current.lookAt(r.current.target.position)})}function QL({distance:r=.4,alphaTest:e=.5,map:t,shader:i=UL,width:n=512,height:s=512,scale:o=1,children:a,...l}){const c=y.useRef(null),u=l.spotlightRef,h=l.debug;pI(u,c,n,s,r);const f=y.useMemo(()=>new _i(n,s,{format:Mi,stencilBuffer:!1}),[n,s]),d=y.useRef({uShadowMap:{value:t},uTime:{value:0}});y.useEffect(()=>void(d.current.uShadowMap.value=t),[t]);const m=y.useMemo(()=>new nr(new bi({uniforms:d.current,vertexShader:`
          varying vec2 vUv;

          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
          `,fragmentShader:i})),[i]);return y.useEffect(()=>()=>{m.material.dispose(),m.dispose()},[m]),y.useEffect(()=>()=>f.dispose(),[f]),We(({gl:A},p)=>{d.current.uTime.value+=p,A.setRenderTarget(f),m.render(A),A.setRenderTarget(null)}),y.createElement(y.Fragment,null,y.createElement("mesh",{ref:c,scale:o,castShadow:!0},y.createElement("planeGeometry",null),y.createElement("meshBasicMaterial",{transparent:!0,side:wi,alphaTest:e,alphaMap:f.texture,"alphaMap-wrapS":Ln,"alphaMap-wrapT":Ln,opacity:h?1:0},a)))}function zL({distance:r=.4,alphaTest:e=.5,map:t,width:i=512,height:n=512,scale:s,children:o,...a}){const l=y.useRef(null),c=a.spotlightRef,u=a.debug;return pI(c,l,i,n,r),y.createElement(y.Fragment,null,y.createElement("mesh",{ref:l,scale:s,castShadow:!0},y.createElement("planeGeometry",null),y.createElement("meshBasicMaterial",{transparent:!0,side:wi,alphaTest:e,alphaMap:t,"alphaMap-wrapS":Ln,"alphaMap-wrapT":Ln,opacity:u?1:0},o)))}function SO(r){return r.shader?y.createElement(QL,r):y.createElement(zL,r)}const TO=y.forwardRef(({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5,volumetric:c=!0,debug:u=!1,children:h,...f},d)=>{const m=y.useRef(null);return y.useImperativeHandle(d,()=>m.current,[]),y.createElement("group",null,u&&m.current&&y.createElement("spotLightHelper",{args:[m.current]}),y.createElement("spotLight",_e({ref:m,angle:o,color:n,distance:s,castShadow:!0},f),c&&y.createElement(GL,{debug:u,opacity:r,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n,distance:s,angle:o,attenuation:a,anglePower:l})),h&&y.cloneElement(h,{spotlightRef:m,debug:u}))}),bO=y.forwardRef(({light:r,args:e,map:t,toneMapped:i=!1,color:n="white",form:s="rect",intensity:o=1,scale:a=1,target:l=[0,0,0],children:c,...u},h)=>{const f=y.useRef(null);return y.useImperativeHandle(h,()=>f.current,[]),y.useLayoutEffect(()=>{!c&&!u.material&&(wn(f.current.material,{color:n}),f.current.material.color.multiplyScalar(o))},[n,o,c,u.material]),y.useLayoutEffect(()=>{u.rotation||f.current.quaternion.identity(),l&&!u.rotation&&(typeof l=="boolean"?f.current.lookAt(0,0,0):f.current.lookAt(Array.isArray(l)?new K(...l):l))},[l,u.rotation]),a=Array.isArray(a)&&a.length===2?[a[0],a[1],1]:a,y.createElement("mesh",_e({ref:f,scale:a},u),s==="circle"?y.createElement("ringGeometry",{args:e||[0,.5,64]}):s==="ring"?y.createElement("ringGeometry",{args:e||[.25,.5,64]}):s==="rect"||s==="plane"?y.createElement("planeGeometry",{args:e||[1,1]}):s==="box"?y.createElement("boxGeometry",{args:e||[1,1,1]}):y.createElement(s,{args:e}),c||y.createElement("meshBasicMaterial",{toneMapped:i,map:t,side:wi}),r&&y.createElement("pointLight",_e({castShadow:!0},r)))});class HL extends bi{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const VL=r=>new K().setFromSpherical(new fa(r,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),wO=y.forwardRef(({radius:r=100,depth:e=50,count:t=5e3,saturation:i=0,factor:n=4,fade:s=!1,speed:o=1},a)=>{const l=y.useRef(),[c,u,h]=y.useMemo(()=>{const d=[],m=[],A=Array.from({length:t},()=>(.5+.5*Math.random())*n),p=new et;let g=r+e;const v=e/t;for(let E=0;E<t;E++)g-=v*Math.random(),d.push(...VL(g).toArray()),p.setHSL(E/t,i,.9),m.push(p.r,p.g,p.b);return[new Float32Array(d),new Float32Array(m),new Float32Array(A)]},[t,e,n,r,i]);We(d=>l.current&&(l.current.uniforms.time.value=d.clock.elapsedTime*o));const[f]=y.useState(()=>new HL);return y.createElement("points",{ref:a},y.createElement("bufferGeometry",null,y.createElement("bufferAttribute",{attach:"attributes-position",args:[c,3]}),y.createElement("bufferAttribute",{attach:"attributes-color",args:[u,3]}),y.createElement("bufferAttribute",{attach:"attributes-size",args:[h,1]})),y.createElement("primitive",{ref:l,object:f,attach:"material",blending:R_,"uniforms-fade-value":s,depthWrite:!1,transparent:!0,vertexColors:!0}))}),KL="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",Ov=new Me,Ru=new K,Du=new ht,Uv=new K,Nv=new ht,yl=new K,ip=y.createContext(null),$L=y.forwardRef(({children:r,material:e=Om,texture:t=KL,range:i,limit:n=200,frustumCulled:s,...o},a)=>{var l,c;const u=y.useMemo(()=>class extends e{constructor(){super();const S=parseInt(Nm.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=b=>{b.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+b.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),b.fragmentShader=`varying float vOpacity;
              `+b.fragmentShader.replace(`#include <${S}>`,`#include <${S}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}},[e]);xi({CloudMaterial:u});const h=y.useRef(null),f=y.useRef([]),d=y.useMemo(()=>new Float32Array(Array.from({length:n},()=>1)),[n]),m=y.useMemo(()=>new Float32Array(Array.from({length:n},()=>[1,1,1]).flat()),[n]),A=ho(t);let p=0,g=0,v;const E=new ht,C=new K(0,0,1),I=new K;We((S,b)=>{for(p=S.clock.elapsedTime,Ov.copy(h.current.matrixWorld).invert(),S.camera.matrixWorld.decompose(Uv,Nv,yl),g=0;g<f.current.length;g++)v=f.current[g],v.ref.current.matrixWorld.decompose(Ru,Du,yl),Ru.add(I.copy(v.position).applyQuaternion(Du).multiply(yl)),Du.copy(Nv).multiply(E.setFromAxisAngle(C,v.rotation+=b*v.rotationFactor)),yl.multiplyScalar(v.volume+(1+Math.sin(p*v.density*v.speed))/2*v.growth),v.matrix.compose(Ru,Du,yl).premultiply(Ov),v.dist=Ru.distanceTo(Uv);for(f.current.sort((T,B)=>B.dist-T.dist),g=0;g<f.current.length;g++)v=f.current[g],d[g]=v.opacity*(v.dist<v.fade-1?v.dist/v.fade:1),h.current.setMatrixAt(g,v.matrix),h.current.setColorAt(g,v.color);h.current.geometry.attributes.cloudOpacity.needsUpdate=!0,h.current.instanceMatrix.needsUpdate=!0,h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}),y.useLayoutEffect(()=>{const S=Math.min(n,i!==void 0?i:n,f.current.length);h.current.count=S,Vl(h.current.instanceMatrix,{offset:0,count:S*16}),h.current.instanceColor&&Vl(h.current.instanceColor,{offset:0,count:S*3}),Vl(h.current.geometry.attributes.cloudOpacity,{offset:0,count:S})});let _=[(l=A.image.width)!==null&&l!==void 0?l:1,(c=A.image.height)!==null&&c!==void 0?c:1];const x=Math.max(_[0],_[1]);return _=[_[0]/x,_[1]/x],y.createElement("group",_e({ref:a},o),y.createElement(ip.Provider,{value:f},r,y.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:h,args:[null,null,n],frustumCulled:s},y.createElement("instancedBufferAttribute",{usage:nn,attach:"instanceColor",args:[m,3]}),y.createElement("planeGeometry",{args:[..._]},y.createElement("instancedBufferAttribute",{usage:nn,attach:"attributes-cloudOpacity",args:[d,1]})),y.createElement("cloudMaterial",{key:e.name,map:A,transparent:!0,depthWrite:!1}))))}),Gv=y.forwardRef(({opacity:r=1,speed:e=0,bounds:t=[5,1,1],segments:i=20,color:n="#ffffff",fade:s=10,volume:o=6,smallestVolume:a=.25,distribute:l=null,growth:c=4,concentrate:u="inside",seed:h=Math.random(),...f},d)=>{function m(){const E=Math.sin(h++)*1e4;return E-Math.floor(E)}const A=y.useContext(ip),p=y.useRef(null),g=y.useId(),v=y.useMemo(()=>[...new Array(i)].map((E,C)=>({segments:i,bounds:new K(1,1,1),position:new K,uuid:g,index:C,ref:p,dist:0,matrix:new Me,color:new et,rotation:C*(Math.PI/i)})),[i,g]);return y.useLayoutEffect(()=>{v.forEach((E,C)=>{wn(E,{volume:o,color:n,speed:e,growth:c,opacity:r,fade:s,bounds:t,density:Math.max(.5,m()),rotationFactor:Math.max(.2,.5*m())*e});const I=l?.(E,C);if(I||i>1){var _;E.position.copy(E.bounds).multiply((_=I?.point)!==null&&_!==void 0?_:{x:m()*2-1,y:m()*2-1,z:m()*2-1})}const x=Math.abs(E.position.x),S=Math.abs(E.position.y),b=Math.abs(E.position.z),T=Math.max(x,S,b);E.length=1,x===T&&(E.length-=x/E.bounds.x),S===T&&(E.length-=S/E.bounds.y),b===T&&(E.length-=b/E.bounds.z),E.volume=(I?.volume!==void 0?I.volume:Math.max(Math.max(0,a),u==="random"?m():u==="inside"?E.length:1-E.length))*o})},[u,t,s,n,r,c,o,h,i,e]),y.useLayoutEffect(()=>{const E=v;return A.current=[...A.current,...E],()=>{A.current=A.current.filter(C=>C.uuid!==g)}},[v]),y.useImperativeHandle(d,()=>p.current,[]),y.createElement("group",_e({ref:p},f))}),BO=y.forwardRef((r,e)=>y.useContext(ip)?y.createElement(Gv,_e({ref:e},r)):y.createElement($L,null,y.createElement(Gv,_e({ref:e},r))));class jL extends bi{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:`
        uniform float pixelRatio;
        uniform float time;
        attribute float size;  
        attribute float speed;  
        attribute float opacity;
        attribute vec3 noise;
        attribute vec3 color;
        varying vec3 vColor;
        varying float vOpacity;

        void main() {
          vec4 modelPosition = modelMatrix * vec4(position, 1.0);
          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
          vec4 viewPosition = viewMatrix * modelPosition;
          vec4 projectionPostion = projectionMatrix * viewPosition;
          gl_Position = projectionPostion;
          gl_PointSize = size * 25. * pixelRatio;
          gl_PointSize *= (1.0 / - viewPosition.z);
          vColor = color;
          vOpacity = opacity;
        }
      `,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
          float strength = 0.05 / distanceToCenter - 0.1;
          gl_FragColor = vec4(vColor, strength * vOpacity);
          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(e){this.uniforms.pixelRatio.value=e}}const gI=r=>r&&r.constructor===Float32Array,YL=r=>[r.r,r.g,r.b],yI=r=>r instanceof Fe||r instanceof K||r instanceof Ci,vI=r=>Array.isArray(r)?r:yI(r)?r.toArray():[r,r,r];function vl(r,e,t){return y.useMemo(()=>{if(e!==void 0){if(gI(e))return e;if(e instanceof et){const i=Array.from({length:r*3},()=>YL(e)).flat();return Float32Array.from(i)}else if(yI(e)||Array.isArray(e)){const i=Array.from({length:r*3},()=>vI(e)).flat();return Float32Array.from(i)}return Float32Array.from({length:r},()=>e)}return Float32Array.from({length:r},t)},[e])}const RO=y.forwardRef(({noise:r=1,count:e=100,speed:t=1,opacity:i=1,scale:n=1,size:s,color:o,children:a,...l},c)=>{y.useMemo(()=>xi({SparklesImplMaterial:jL}),[]);const u=y.useRef(null),h=de(E=>E.viewport.dpr),f=vI(n),d=y.useMemo(()=>Float32Array.from(Array.from({length:e},()=>f.map(ot.randFloatSpread)).flat()),[e,...f]),m=vl(e,s,Math.random),A=vl(e,i),p=vl(e,t),g=vl(e*3,r),v=vl(o===void 0?e*3:e,gI(o)?o:new et(o),()=>1);return We(E=>{u.current&&u.current.material&&(u.current.material.time=E.clock.elapsedTime)}),y.useImperativeHandle(c,()=>u.current,[]),y.createElement("points",_e({key:`particle-${e}-${JSON.stringify(n)}`},l,{ref:u}),y.createElement("bufferGeometry",null,y.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),y.createElement("bufferAttribute",{attach:"attributes-size",args:[m,1]}),y.createElement("bufferAttribute",{attach:"attributes-opacity",args:[A,1]}),y.createElement("bufferAttribute",{attach:"attributes-speed",args:[p,1]}),y.createElement("bufferAttribute",{attach:"attributes-color",args:[v,3]}),y.createElement("bufferAttribute",{attach:"attributes-noise",args:[g,3]})),a||y.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:h,depthWrite:!1}))});function WL(r){switch(r){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}const qL="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",XL="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function JL(r=0,e=1024,t){const i=fr(()=>fetch(qL).then(u=>u.json()),["matcapList"]),n=i[0],s=y.useMemo(()=>Object.keys(i).length,[]),a=`${y.useMemo(()=>typeof r=="string"?r:typeof r=="number"?i[r]:null,[r])||n}${WL(e)}.png`,l=`${XL}/${e}/${a}`;return[ho(l,t),l,s]}const DO=({children:r,id:e,format:t,onLoad:i})=>{const n=JL(e,t,i);return y.createElement(y.Fragment,null,r?.(n))},ZL="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",eP="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function tP(r=0,e={},t){const{repeat:i=[1,1],anisotropy:n=1,offset:s=[0,0]}=e,o=fr(()=>fetch(eP).then(f=>f.json()),["normalsList"]),a=y.useMemo(()=>Object.keys(o).length,[]),l=o[0],c=o[r]||l,u=`${ZL}/normals/${c}`,h=ho(u,t);return y.useLayoutEffect(()=>{h&&(h.wrapS=h.wrapT=Ln,h.repeat=new Fe(i[0],i[1]),h.offset=new Fe(s[0],s[1]),h.anisotropy=n)},[h,n,i,s]),[h,u,a]}const MO=({children:r,id:e,onLoad:t,...i})=>{const n=tP(e,i,t);return y.createElement(y.Fragment,null,r?.(n))},Pr={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new et("#ff0000"),backfaceStroke:new et("#0000ff"),fill:new et("#00ff00")},vertex:`
	  attribute vec3 barycentric;
	
		varying vec3 v_edges_Barycentric;
		varying vec3 v_edges_Position;

		void initWireframe() {
			v_edges_Barycentric = barycentric;
			v_edges_Position = position.xyz;
		}
	  `,fragment:`
		#ifndef PI
	  	#define PI 3.1415926535897932384626433832795
		#endif
  
	  varying vec3 v_edges_Barycentric;
	  varying vec3 v_edges_Position;
  
	  uniform float strokeOpacity;
	  uniform float fillOpacity;
	  uniform float fillMix;
	  uniform float thickness;
	  uniform bool colorBackfaces;
  
	  // Dash
	  uniform bool dashInvert;
	  uniform bool dash;
	  uniform bool dashOnly;
	  uniform float dashRepeats;
	  uniform float dashLength;
  
	  // Squeeze
	  uniform bool squeeze;
	  uniform float squeezeMin;
	  uniform float squeezeMax;
  
	  // Colors
	  uniform vec3 stroke;
	  uniform vec3 backfaceStroke;
	  uniform vec3 fill;
  
	  // This is like
	  float wireframe_aastep(float threshold, float dist) {
		  float afwidth = fwidth(dist) * 0.5;
		  return smoothstep(threshold - afwidth, threshold + afwidth, dist);
	  }
  
	  float wireframe_map(float value, float min1, float max1, float min2, float max2) {
		  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
	  }
  
	  float getWireframe() {
			vec3 barycentric = v_edges_Barycentric;
		
			// Distance from center of each triangle to its edges.
			float d = min(min(barycentric.x, barycentric.y), barycentric.z);

			// for dashed rendering, we can use this to get the 0 .. 1 value of the line length
			float positionAlong = max(barycentric.x, barycentric.y);
			if (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {
				positionAlong = 1.0 - positionAlong;
			}

			// the thickness of the stroke
			float computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);

			// if we want to shrink the thickness toward the center of the line segment
			if (squeeze) {
				computedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));
			}

			// Create dash pattern
			if (dash) {
				// here we offset the stroke position depending on whether it
				// should overlap or not
				float offset = 1.0 / dashRepeats * dashLength / 2.0;
				if (!dashInvert) {
					offset += 1.0 / dashRepeats / 2.0;
				}

				// if we should animate the dash or not
				// if (dashAnimate) {
				// 	offset += time * 0.22;
				// }

				// create the repeating dash pattern
				float pattern = fract((positionAlong + offset) * dashRepeats);
				computedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);
			}

			// compute the anti-aliased stroke edge  
			float edge = 1.0 - wireframe_aastep(computedThickness, d);

			return edge;
	  }
	  `},iP=vs(Pr.uniforms,Pr.vertex+`
  	void main() {
		initWireframe();
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}
  `,Pr.fragment+`
  void main () {
		// Compute color

		float edge = getWireframe();
		vec4 colorStroke = vec4(stroke, edge);

		#ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		#endif
    
		vec4 colorFill = vec4(fill, fillOpacity);
		vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		gl_FragColor = outColor;
	}
  `);function nP(r,e){r.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...e},t.vertexShader=t.vertexShader.replace("void main() {",`
		  ${Pr.vertex}
		  void main() {
			initWireframe();
		`),t.fragmentShader=t.fragmentShader.replace("void main() {",`
		  ${Pr.fragment}
		  void main() {
		`),t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>",`
		  #include <color_fragment>
			  float edge = getWireframe();
		  vec4 colorStroke = vec4(stroke, edge);
		  #ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		  #endif
		  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));
		  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		  diffuseColor.rgb = outColor.rgb;
		  diffuseColor.a *= outColor.a;
		`)},r.side=wi,r.transparent=!0}function sP(r,e){y.useEffect(()=>{var t;return void(r.fillOpacity.value=(t=e.fillOpacity)!==null&&t!==void 0?t:r.fillOpacity.value)},[e.fillOpacity]),y.useEffect(()=>{var t;return void(r.fillMix.value=(t=e.fillMix)!==null&&t!==void 0?t:r.fillMix.value)},[e.fillMix]),y.useEffect(()=>{var t;return void(r.strokeOpacity.value=(t=e.strokeOpacity)!==null&&t!==void 0?t:r.strokeOpacity.value)},[e.strokeOpacity]),y.useEffect(()=>{var t;return void(r.thickness.value=(t=e.thickness)!==null&&t!==void 0?t:r.thickness.value)},[e.thickness]),y.useEffect(()=>void(r.colorBackfaces.value=!!e.colorBackfaces),[e.colorBackfaces]),y.useEffect(()=>void(r.dash.value=!!e.dash),[e.dash]),y.useEffect(()=>void(r.dashInvert.value=!!e.dashInvert),[e.dashInvert]),y.useEffect(()=>{var t;return void(r.dashRepeats.value=(t=e.dashRepeats)!==null&&t!==void 0?t:r.dashRepeats.value)},[e.dashRepeats]),y.useEffect(()=>{var t;return void(r.dashLength.value=(t=e.dashLength)!==null&&t!==void 0?t:r.dashLength.value)},[e.dashLength]),y.useEffect(()=>void(r.squeeze.value=!!e.squeeze),[e.squeeze]),y.useEffect(()=>{var t;return void(r.squeezeMin.value=(t=e.squeezeMin)!==null&&t!==void 0?t:r.squeezeMin.value)},[e.squeezeMin]),y.useEffect(()=>{var t;return void(r.squeezeMax.value=(t=e.squeezeMax)!==null&&t!==void 0?t:r.squeezeMax.value)},[e.squeezeMax]),y.useEffect(()=>void(r.stroke.value=e.stroke?new et(e.stroke):r.stroke.value),[e.stroke]),y.useEffect(()=>void(r.fill.value=e.fill?new et(e.fill):r.fill.value),[e.fill]),y.useEffect(()=>void(r.backfaceStroke.value=e.backfaceStroke?new et(e.backfaceStroke):r.backfaceStroke.value),[e.backfaceStroke])}function rP(r){return!!(r!=null&&r.geometry)}function oP(r){return!!(r!=null&&r.isBufferGeometry)}function aP(r){return!!(r!=null&&r.current)}function Qv(r){return r?.current!==void 0}function zv(r){return r.type==="WireframeGeometry"}function lP(){const r={};for(const e in Pr.uniforms)r[e]={value:Pr.uniforms[e]};return r}function cP(r,e){const i=r.getAttribute("position").count,n=[];for(let s=0;s<i;s++){const o=s%2===0,a=e?1:0;o?n.push(0,0,1,0,1,0,1,0,a):n.push(0,1,0,0,0,1,1,0,a)}return new Jt(Float32Array.from(n),3)}function EI(r){const e=aP(r)?r.current:r;if(oP(e))return e;{if(zv(e))throw new Error("Wireframe: WireframeGeometry is not supported.");const t=e.parent;if(rP(t)){if(zv(t.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return t.geometry}}}function CI(r,e){if(r.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const i=r.toNonIndexed();r.copy(i),r.setIndex(null)}const t=cP(r,e);r.setAttribute("barycentric",t)}function uP({geometry:r,simplify:e=!1,...t}){xi({MeshWireframeMaterial:iP});const[i,n]=y.useState(null);y.useLayoutEffect(()=>{const o=EI(r);if(!o)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");CI(o,e),Qv(r)&&n(o)},[e,r]);const s=Qv(r)?i:r;return y.createElement(y.Fragment,null,s&&y.createElement("mesh",{geometry:s},y.createElement("meshWireframeMaterial",_e({attach:"material",transparent:!0,side:wi,polygonOffset:!0,polygonOffsetFactor:-4},t,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function hP({simplify:r=!1,...e}){const t=y.useRef(null),i=y.useMemo(()=>lP(),[Pr.uniforms]);return sP(i,e),y.useLayoutEffect(()=>{const n=EI(t);if(!n)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const s=n.clone();return CI(n,r),()=>{n.copy(s),s.dispose()}},[r]),y.useLayoutEffect(()=>{const n=t.current.parent,s=n.material.clone();return nP(n.material,i),()=>{n.material.dispose(),n.material=s}},[]),y.createElement("object3D",{ref:t})}function LO({geometry:r,...e}){return r?y.createElement(uP,_e({geometry:r},e)):y.createElement(hP,e)}function PO({opacity:r,alphaMap:e}){const t=y.useRef(null),i=y.useRef(null),n=y.useRef({value:1}),s=y.useRef({value:null}),o=y.useRef({value:!1});return y.useLayoutEffect(()=>{t.current.onBeforeCompile=i.current.onBeforeCompile=a=>{const l=a.fragmentShader.indexOf("void main");let c="",u,h=l;for(;u!==`
`&&h<l+100;)u=a.fragmentShader.charAt(h),c+=u,h++;c=c.trim(),a.vertexShader=a.vertexShader.replace("void main() {",`
        varying vec2 custom_vUv;

        void main() {
          custom_vUv = uv;
          
        `),a.fragmentShader=a.fragmentShader.replace(c,`
          uniform float uShadowOpacity;
          uniform sampler2D uAlphaMap;
          uniform bool uHasAlphaMap;

          varying vec2 custom_vUv;
  
          float bayerDither2x2( vec2 v ) {
            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );
          }
    
          float bayerDither4x4( vec2 v ) {
            vec2 P1 = mod( v, 2.0 );
            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );
            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );
          }
  
          void main() {
            float alpha = 
              uHasAlphaMap ? 
                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x
              : uShadowOpacity;

            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;
            
          `),a.uniforms.uShadowOpacity=n.current,a.uniforms.uAlphaMap=s.current,a.uniforms.uHasAlphaMap=o.current}},[]),We(()=>{var a;const l=(a=t.current.__r3f)==null?void 0:a.parent;if(l){const c=l.material;c&&(n.current.value=r??c.opacity,e===!1?(s.current.value=null,o.current.value=!1):(s.current.value=e||c.alphaMap,o.current.value=!!s.current.value))}}),y.createElement(y.Fragment,null,y.createElement("meshDepthMaterial",{ref:t,attach:"customDepthMaterial",depthPacking:V2}),y.createElement("meshDistanceMaterial",{ref:i,attach:"customDistanceMaterial"}))}const Hv=new Me,n0=new Ia,Vv=new un,fP=new K;class dP extends or{constructor(){super(),this.size=0,this.color=new et("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){var i,n;const s=this.instance.current;if(!s||!s.geometry)return;const o=s.userData.instances.indexOf(this.instanceKey);if(o===-1||o>s.geometry.drawRange.count)return;const a=(i=(n=e.params.Points)==null?void 0:n.threshold)!==null&&i!==void 0?i:1;if(Vv.set(this.getWorldPosition(fP),a),e.ray.intersectsSphere(Vv)===!1)return;Hv.copy(s.matrixWorld).invert(),n0.copy(e.ray).applyMatrix4(Hv);const l=a/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,u=n0.distanceSqToPoint(this.position);if(u<c){const h=new K;n0.closestPointToPoint(this.position,h),h.applyMatrix4(this.matrixWorld);const f=e.ray.origin.distanceTo(h);if(f<e.near||f>e.far)return;t.push({distance:f,distanceToRay:Math.sqrt(u),point:h,index:o,face:null,object:this})}}}let qr,El;const II=y.createContext(null),Kv=new Me,$v=new K,mP=y.forwardRef(({children:r,range:e,limit:t=1e3,...i},n)=>{const s=y.useRef(null);y.useImperativeHandle(n,()=>s.current,[]);const[o,a]=y.useState([]),[[l,c,u]]=y.useState(()=>[new Float32Array(t*3),Float32Array.from({length:t*3},()=>1),Float32Array.from({length:t},()=>1)]);y.useEffect(()=>{s.current.geometry.attributes.position.needsUpdate=!0}),We(()=>{for(s.current.updateMatrix(),s.current.updateMatrixWorld(),Kv.copy(s.current.matrixWorld).invert(),s.current.geometry.drawRange.count=Math.min(t,e!==void 0?e:t,o.length),qr=0;qr<o.length;qr++)El=o[qr].current,El.getWorldPosition($v).applyMatrix4(Kv),$v.toArray(l,qr*3),s.current.geometry.attributes.position.needsUpdate=!0,El.matrixWorldNeedsUpdate=!0,El.color.toArray(c,qr*3),s.current.geometry.attributes.color.needsUpdate=!0,u.set([El.size],qr),s.current.geometry.attributes.size.needsUpdate=!0});const h=y.useMemo(()=>({getParent:()=>s,subscribe:f=>(a(d=>[...d,f]),()=>a(d=>d.filter(m=>m.current!==f.current)))}),[]);return y.createElement("points",_e({userData:{instances:o},matrixAutoUpdate:!1,ref:s,raycast:()=>null},i),y.createElement("bufferGeometry",null,y.createElement("bufferAttribute",{attach:"attributes-position",count:l.length/3,array:l,itemSize:3,usage:nn}),y.createElement("bufferAttribute",{attach:"attributes-color",count:c.length/3,array:c,itemSize:3,usage:nn}),y.createElement("bufferAttribute",{attach:"attributes-size",count:u.length,array:u,itemSize:1,usage:nn})),y.createElement(II.Provider,{value:h},r))}),FO=y.forwardRef(({children:r,...e},t)=>{y.useMemo(()=>xi({PositionPoint:dP}),[]);const i=y.useRef(null);y.useImperativeHandle(t,()=>i.current,[]);const{subscribe:n,getParent:s}=y.useContext(II);return y.useLayoutEffect(()=>n(i),[]),y.createElement("positionPoint",_e({instance:s(),instanceKey:i,ref:i},e),r)}),AP=y.forwardRef(({children:r,positions:e,colors:t,sizes:i,stride:n=3,...s},o)=>{const a=y.useRef(null);return y.useImperativeHandle(o,()=>a.current,[]),We(()=>{const l=a.current.geometry.attributes;l.position.needsUpdate=!0,t&&(l.color.needsUpdate=!0),i&&(l.size.needsUpdate=!0)}),y.createElement("points",_e({ref:a},s),y.createElement("bufferGeometry",null,y.createElement("bufferAttribute",{attach:"attributes-position",count:e.length/n,array:e,itemSize:n,usage:nn}),t&&y.createElement("bufferAttribute",{attach:"attributes-color",count:t.length/n,array:t,itemSize:3,usage:nn}),i&&y.createElement("bufferAttribute",{attach:"attributes-size",count:i.length/n,array:i,itemSize:1,usage:nn})),r)}),kO=y.forwardRef((r,e)=>r.positions instanceof Float32Array?y.createElement(AP,_e({},r,{ref:e})):y.createElement(mP,_e({},r,{ref:e}))),_I=y.createContext(null),OO=y.forwardRef((r,e)=>{y.useMemo(()=>xi({SegmentObject:pP}),[]);const{limit:t=1e3,lineWidth:i=1,children:n,...s}=r,[o,a]=y.useState([]),[l]=y.useState(()=>new k3),[c]=y.useState(()=>new Hh),[u]=y.useState(()=>new zh),[h]=y.useState(()=>new Fe(512,512)),[f]=y.useState(()=>Array(t*6).fill(0)),[d]=y.useState(()=>Array(t*6).fill(0)),m=y.useMemo(()=>({subscribe:A=>(a(p=>[...p,A]),()=>a(p=>p.filter(g=>g.current!==A.current)))}),[]);return We(()=>{for(let p=0;p<t;p++){var A;const g=(A=o[p])==null?void 0:A.current;g&&(f[p*6+0]=g.start.x,f[p*6+1]=g.start.y,f[p*6+2]=g.start.z,f[p*6+3]=g.end.x,f[p*6+4]=g.end.y,f[p*6+5]=g.end.z,d[p*6+0]=g.color.r,d[p*6+1]=g.color.g,d[p*6+2]=g.color.b,d[p*6+3]=g.color.r,d[p*6+4]=g.color.g,d[p*6+5]=g.color.b)}u.setColors(d),u.setPositions(f),l.computeLineDistances()}),y.createElement("primitive",{object:l,ref:e},y.createElement("primitive",{object:u,attach:"geometry"}),y.createElement("primitive",_e({object:c,attach:"material",vertexColors:!0,resolution:h,linewidth:i},s)),y.createElement(_I.Provider,{value:m},n))});class pP{constructor(){this.color=new et("white"),this.start=new K(0,0,0),this.end=new K(0,0,0)}}const jv=r=>r instanceof K?r:new K(...typeof r=="number"?[r,r,r]:r),UO=y.forwardRef(({color:r,start:e,end:t},i)=>{const n=y.useContext(_I);if(!n)throw"Segment must used inside Segments component.";const s=y.useRef(null);return y.useImperativeHandle(i,()=>s.current,[]),y.useLayoutEffect(()=>n.subscribe(s),[]),y.createElement("segmentObject",{ref:s,color:r,start:jv(e),end:jv(t)})}),NO=y.forwardRef(({children:r,hysteresis:e=0,distances:t,...i},n)=>{const s=y.useRef(null);return y.useImperativeHandle(n,()=>s.current,[]),y.useLayoutEffect(()=>{const{current:o}=s;o.levels.length=0,o.children.forEach((a,l)=>o.levels.push({object:a,hysteresis:e,distance:t[l]}))}),We(o=>{var a;return(a=s.current)==null?void 0:a.update(o.camera)}),y.createElement("lOD",_e({ref:s},i),r)});function GO({all:r,scene:e,camera:t}){const i=de(({gl:o})=>o),n=de(({camera:o})=>o),s=de(({scene:o})=>o);return y.useLayoutEffect(()=>{const o=[];r&&(e||s).traverse(c=>{c.visible===!1&&(o.push(c),c.visible=!0)}),i.compile(e||s,t||n);const a=new Dh(128);new j2(.01,1e5,a).update(i,e||s),a.dispose(),o.forEach(c=>c.visible=!1)},[]),null}function QO(){const r=de(e=>e.gl);return y.useEffect(()=>(r.shadowMap.autoUpdate=!1,r.shadowMap.needsUpdate=!0,()=>{r.shadowMap.autoUpdate=r.shadowMap.needsUpdate=!0}),[r.shadowMap]),null}const Yv=new Me,Wv=new Ia,s0=new un,r0=new K;function zO(r,e){const t=this.geometry,i=this.material,n=this.matrixWorld;i!==void 0&&(t.boundingSphere===null&&t.computeBoundingSphere(),s0.copy(t.boundingSphere),s0.applyMatrix4(n),r.ray.intersectsSphere(s0)!==!1&&(Yv.copy(n).invert(),Wv.copy(r.ray).applyMatrix4(Yv),!(t.boundingBox!==null&&Wv.intersectBox(t.boundingBox,r0)===null)&&e.push({distance:r0.distanceTo(r.ray.origin),point:r0.clone(),object:this})))}function HO({pixelated:r}){const e=de(o=>o.gl),t=de(o=>o.internal.active),i=de(o=>o.performance.current),n=de(o=>o.viewport.initialDpr),s=de(o=>o.setDpr);return y.useEffect(()=>{const o=e.domElement;return()=>{t&&s(n),r&&o&&(o.style.imageRendering="auto")}},[]),y.useEffect(()=>{s(i*n),r&&e.domElement&&(e.domElement.style.imageRendering=i===1?"auto":"pixelated")},[i]),null}function VO(){const r=de(i=>i.get),e=de(i=>i.setEvents),t=de(i=>i.performance.current);return y.useEffect(()=>{const i=r().events.enabled;return()=>e({enabled:i})},[]),y.useEffect(()=>e({enabled:t===1}),[t]),null}const xI=y.createContext(null);function KO({iterations:r=10,ms:e=250,threshold:t=.75,step:i=.1,factor:n=.5,flipflops:s=1/0,bounds:o=f=>f>100?[60,100]:[40,60],onIncline:a,onDecline:l,onChange:c,onFallback:u,children:h}){const f=Math.pow(10,0),[d,m]=y.useState(()=>({fps:0,index:0,factor:n,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:p=>{const g=Symbol();return d.subscriptions.set(g,p.current),()=>void d.subscriptions.delete(g)}}));let A=0;return We(()=>{const{frames:p,averages:g}=d;if(!d.fallback&&g.length<r){p.push(performance.now());const v=p[p.length-1]-p[0];if(v>=e){if(d.fps=Math.round(p.length/v*1e3*f)/f,d.refreshrate=Math.max(d.refreshrate,d.fps),g[d.index++%r]=d.fps,g.length===r){const[E,C]=o(d.refreshrate),I=g.filter(x=>x>=C),_=g.filter(x=>x<E);I.length>r*t&&(d.factor=Math.min(1,d.factor+i),d.flipped++,a&&a(d),d.subscriptions.forEach(x=>x.onIncline&&x.onIncline(d))),_.length>r*t&&(d.factor=Math.max(0,d.factor-i),d.flipped++,l&&l(d),d.subscriptions.forEach(x=>x.onDecline&&x.onDecline(d))),A!==d.factor&&(A=d.factor,c&&c(d),d.subscriptions.forEach(x=>x.onChange&&x.onChange(d))),d.flipped>s&&!d.fallback&&(d.fallback=!0,u&&u(d),d.subscriptions.forEach(x=>x.onFallback&&x.onFallback(d))),d.averages=[]}d.frames=[]}}}),y.createElement(xI.Provider,{value:d},h)}function $O({onIncline:r,onDecline:e,onChange:t,onFallback:i}){const n=y.useContext(xI),s=y.useRef({onIncline:r,onDecline:e,onChange:t,onFallback:i});y.useLayoutEffect(()=>{s.current.onIncline=r,s.current.onDecline=e,s.current.onChange=t,s.current.onFallback=i},[r,e,t,i]),y.useLayoutEffect(()=>n.subscribe(s),[n])}const gP=y.forwardRef(({children:r,compute:e,width:t,height:i,samples:n=8,renderPriority:s=0,eventPriority:o=0,frames:a=1/0,stencilBuffer:l=!1,depthBuffer:c=!0,generateMipmaps:u=!1,...h},f)=>{const{size:d,viewport:m}=de(),A=En((t||d.width)*m.dpr,(i||d.height)*m.dpr,{samples:n,stencilBuffer:l,depthBuffer:c,generateMipmaps:u}),[p]=y.useState(()=>new Nr),g=y.useCallback((v,E,C)=>{var I,_;let x=(I=A.texture)==null?void 0:I.__r3f.parent;for(;x&&!(x instanceof Ei);)x=x.__r3f.parent;if(!x)return!1;C.raycaster.camera||C.events.compute(v,C,(_=C.previousRoot)==null?void 0:_.getState());const[S]=C.raycaster.intersectObject(x);if(!S)return!1;const b=S.uv;if(!b)return!1;E.raycaster.setFromCamera(E.pointer.set(b.x*2-1,b.y*2-1),E.camera)},[]);return y.useImperativeHandle(f,()=>A.texture,[A]),y.createElement(y.Fragment,null,uo(y.createElement(yP,{renderPriority:s,frames:a,fbo:A},r,y.createElement("group",{onPointerOver:()=>null})),p,{events:{compute:e||g,priority:o}}),y.createElement("primitive",_e({object:A.texture},h)))});function yP({frames:r,renderPriority:e,children:t,fbo:i}){let n=0,s,o,a,l;return We(c=>{(r===1/0||n<r)&&(s=c.gl.autoClear,o=c.gl.xr.enabled,a=c.gl.getRenderTarget(),l=c.gl.xr.isPresenting,c.gl.autoClear=!0,c.gl.xr.enabled=!1,c.gl.xr.isPresenting=!1,c.gl.setRenderTarget(i),c.gl.render(c.scene,c.camera),c.gl.setRenderTarget(a),c.gl.autoClear=s,c.gl.xr.enabled=o,c.gl.xr.isPresenting=l,n++)},e),y.createElement(y.Fragment,null,t)}const vP=y.forwardRef(({children:r,compute:e,renderPriority:t=-1,eventPriority:i=0,frames:n=1/0,stencilBuffer:s=!1,depthBuffer:o=!0,generateMipmaps:a=!1,resolution:l=896,near:c=.1,far:u=1e3,flip:h=!1,position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:g,...v},E)=>{const{size:C,viewport:I}=de(),_=y.useRef(null),x=y.useMemo(()=>{const b=new Dh(Math.max((l||C.width)*I.dpr,(l||C.height)*I.dpr),{stencilBuffer:s,depthBuffer:o,generateMipmaps:a});return b.texture.isRenderTargetTexture=!h,b.texture.flipY=!0,b.texture.type=Ai,b},[l,h]);y.useEffect(()=>()=>x.dispose(),[x]);const[S]=y.useState(()=>new Nr);return y.useImperativeHandle(E,()=>({scene:S,fbo:x,camera:_.current}),[x]),y.createElement(y.Fragment,null,uo(y.createElement(EP,{renderPriority:t,frames:n,camera:_},r,y.createElement("group",{onPointerOver:()=>null})),S,{events:{compute:e,priority:i}}),y.createElement("primitive",_e({object:x.texture},v)),y.createElement("cubeCamera",{ref:_,args:[c,u,x],position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:g}))});function EP({frames:r,renderPriority:e,children:t,camera:i}){let n=0;return We(s=>{(r===1/0||n<r)&&(i.current.update(s.gl,s.scene),n++)},e),y.createElement(y.Fragment,null,t)}const jO=y.forwardRef(({id:r=1,colorWrite:e=!1,depthWrite:t=!1,...i},n)=>{const s=y.useRef(null),o=y.useMemo(()=>({colorWrite:e,depthWrite:t,stencilWrite:!0,stencilRef:r,stencilFunc:D_,stencilFail:yf,stencilZFail:yf,stencilZPass:yf}),[r,e,t]);return y.useLayoutEffect(()=>{Object.assign(s.current.material,o)}),y.useImperativeHandle(n,()=>s.current,[]),y.createElement("mesh",_e({ref:s,renderOrder:-r},i))});function YO(r,e=!1){return{stencilWrite:!0,stencilRef:r,stencilFunc:e?M_:L_,stencilFail:vf,stencilZFail:vf,stencilZPass:vf}}function WO({renderPriority:r=1,zoom:e=0,segments:t=64,children:i,resolution:n=896,...s}){const o=y.useRef(null),a=y.useRef(null),{width:l,height:c}=de(p=>p.size),[u]=y.useState(()=>new vi);y.useLayoutEffect(()=>{u.position.set(0,0,100),u.zoom=100,u.left=l/-2,u.right=l/2,u.top=c/2,u.bottom=c/-2,u.updateProjectionMatrix()},[l,c]);const h=Math.sqrt(l*l+c*c)/100*(.5+e/2),f=new K,d=new un(new K,h),m=new bn,A=y.useCallback((p,g,v)=>{if(g.pointer.set(p.offsetX/g.size.width*2-1,-(p.offsetY/g.size.height)*2+1),g.raycaster.setFromCamera(g.pointer,u),g.raycaster.ray.intersectSphere(d,f))f.normalize();else return;m.getNormalMatrix(a.current.camera.matrixWorld),a.current.camera.getWorldPosition(g.raycaster.ray.origin),g.raycaster.ray.direction.set(0,0,1).reflect(f),g.raycaster.ray.direction.x*=-1,g.raycaster.ray.direction.applyNormalMatrix(m).multiplyScalar(-1)},[]);return We(p=>{r&&p.gl.render(o.current,u)},r),y.createElement(y.Fragment,null,y.createElement("mesh",_e({ref:o},s,{scale:h}),y.createElement("sphereGeometry",{args:[1,t,t]}),y.createElement("meshBasicMaterial",null,y.createElement(vP,{compute:A,attach:"envMap",flip:!0,resolution:n,ref:a},i,y.createElement(CP,{api:a})))))}function CP({api:r}){const e=new K,t=new ht,i=new K,n=new Wn(0,Math.PI,0);return We(s=>{s.camera.matrixWorld.decompose(e,t,i),r.current.camera.position.copy(e),r.current.camera.quaternion.setFromEuler(n).premultiply(t)}),null}const IP=vs({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new Fe},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),qO=y.forwardRef(({children:r,events:e=void 0,blur:t=0,eventPriority:i=0,renderPriority:n=0,worldUnits:s=!1,resolution:o=512,...a},l)=>{xi({PortalMaterialImpl:IP});const c=y.useRef(null),{scene:u,gl:h,size:f,viewport:d,setEvents:m}=de(),A=En(o,o),[p,g]=y.useState(0);We(()=>{const _=c.current.blend>0?Math.max(1,n):0;p!==_&&g(_)}),y.useEffect(()=>{e!==void 0&&m({enabled:!e})},[e]);const[v,E]=y.useState(!0),C=bM(E);y.useLayoutEffect(()=>{var _;C.current=(_=c.current)==null?void 0:_.__r3f.parent},[]),y.useLayoutEffect(()=>{if(C.current&&t&&c.current.sdf===null){const _=new je(C.current.geometry,new ms),x=new oi().setFromBufferAttribute(_.geometry.attributes.position),S=new vi(x.min.x*(1+2/o),x.max.x*(1+2/o),x.max.y*(1+2/o),x.min.y*(1+2/o),.1,1e3);S.position.set(0,0,1),S.lookAt(0,0,0),h.setRenderTarget(A),h.render(_,S);const T=xP(o,o,h)(A.texture),B=new Float32Array(o*o);h.readRenderTargetPixels(T,0,0,o,o,B);let w=1/0;for(let R=0;R<B.length;R++)B[R]<w&&(w=B[R]);w=-w,c.current.size=w,c.current.sdf=T.texture,h.setRenderTarget(null)}},[o,t]),y.useImperativeHandle(l,()=>c.current);const I=y.useCallback((_,x,S)=>{var b;if(!C.current)return!1;if(x.pointer.set(_.offsetX/x.size.width*2-1,-(_.offsetY/x.size.height)*2+1),x.raycaster.setFromCamera(x.pointer,x.camera),((b=c.current)==null?void 0:b.blend)===0){const[T]=x.raycaster.intersectObject(C.current);if(!T)return x.raycaster.camera=void 0,!1}},[]);return y.createElement("portalMaterialImpl",_e({ref:c,blur:t,blend:0,resolution:[f.width*d.dpr,f.height*d.dpr],attach:"material"},a),y.createElement(gP,{attach:"map",frames:v?1/0:0,eventPriority:i,renderPriority:n,compute:I},r,y.createElement(_P,{events:e,rootScene:u,priority:p,material:c,worldUnits:s})))});function _P({events:r=void 0,rootScene:e,material:t,priority:i,worldUnits:n}){const s=de(h=>h.scene),o=de(h=>h.setEvents),a=En(),l=En();y.useLayoutEffect(()=>{s.matrixAutoUpdate=!1},[]),y.useEffect(()=>{r!==void 0&&o({enabled:r})},[r]);const[c,u]=y.useMemo(()=>{const h={value:0};return[new nr(new bi({uniforms:{a:{value:a.texture},b:{value:l.texture},blend:h},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
          }`,fragmentShader:`
          uniform sampler2D a;
          uniform sampler2D b;
          uniform float blend;
          varying vec2 vUv;
          #include <packing>
          void main() {
            vec4 ta = texture2D(a, vUv);
            vec4 tb = texture2D(b, vUv);
            gl_FragColor = mix(tb, ta, blend);
            #include <tonemapping_fragment>
            #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
          }`})),h]},[]);return We(h=>{var f;let d=t==null||(f=t.current)==null?void 0:f.__r3f.parent;if(d){if(n)s.matrixWorld.identity();else{var m;i&&((m=t.current)==null?void 0:m.blend)===1&&d.updateWorldMatrix(!0,!1),s.matrixWorld.copy(d.matrixWorld)}if(i){var A,p,g;((A=t.current)==null?void 0:A.blend)>0&&((p=t.current)==null?void 0:p.blend)<1?(u.value=t.current.blend,h.gl.setRenderTarget(a),h.gl.render(s,h.camera),h.gl.setRenderTarget(l),h.gl.render(e,h.camera),h.gl.setRenderTarget(null),c.render(h.gl)):((g=t.current)==null?void 0:g.blend)===1&&h.gl.render(s,h.camera)}}},i),y.createElement(y.Fragment,null)}const xP=(r,e,t)=>{let i=new _i(r,e,{minFilter:uc,magFilter:jt,type:hi,format:Fs,generateMipmaps:!0}),n=new _i(r,e,{minFilter:li,magFilter:li}),s=new _i(r,e,{minFilter:li,magFilter:li}),o=new _i(r,e,{minFilter:li,magFilter:li}),a=new _i(r,e,{minFilter:li,magFilter:li}),l=new _i(r,e,{minFilter:li,magFilter:li,type:hi,format:Fs}),c=new _i(r,e,{minFilter:li,magFilter:li,type:hi,format:Fs});const u=new nr(new bi({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));
        }`})),h=new nr(new bi({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));
        }`})),f=new nr(new bi({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform float offset;
        uniform float level;
        uniform float maxSteps;
        #include <packing>
        void main() {
          float closestDist = 9999999.9;
          vec2 closestPos = vec2(0.0);
          for (float x = -1.0; x <= 1.0; x += 1.0) {
            for (float y = -1.0; y <= 1.0; y += 1.0) {
              vec2 voffset = vUv;
              voffset += vec2(x, y) * vec2(${1/r}, ${1/e}) * offset;
              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));
              float dist = distance(pos.xy, vUv);
              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {
                closestDist = dist;
                closestPos = pos;
              }
            }
          }
          gl_FragColor = pack2HalfToRGBA(closestPos);
        }`})),d=new nr(new bi({uniforms:{tex:{value:null},size:{value:new Fe(r,e)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform vec2 size;
        #include <packing>
        void main() {
          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);
        }`})),m=new nr(new bi({uniforms:{inside:{value:c.texture},outside:{value:l.texture},tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D inside;
        uniform sampler2D outside;
        uniform sampler2D tex;
        #include <packing>
        void main() {
          float i = texture2D(inside, vUv).x;
          float o =texture2D(outside, vUv).x;
          if (texture2D(tex, vUv).x == 0.0) {
            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);
          } else {
            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);
          }
        }`}));return A=>{let p=i;A.minFilter=li,A.magFilter=li,u.material.uniforms.tex.value=A,t.setRenderTarget(n),u.render(t);const g=Math.ceil(Math.log(Math.max(r,e))/Math.log(2));let v=n,E=null;for(let C=0;C<g;C++){const I=Math.pow(2,g-C-1);E=v===n?o:n,f.material.uniforms.level.value=C,f.material.uniforms.maxSteps.value=g,f.material.uniforms.offset.value=I,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}t.setRenderTarget(l),d.material.uniforms.tex.value=E.texture,d.render(t),h.material.uniforms.tex.value=A,t.setRenderTarget(s),h.render(t),v=s;for(let C=0;C<g;C++){const I=Math.pow(2,g-C-1);E=v===s?a:s,f.material.uniforms.level.value=C,f.material.uniforms.maxSteps.value=g,f.material.uniforms.offset.value=I,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}return t.setRenderTarget(c),d.material.uniforms.tex.value=E.texture,d.render(t),t.setRenderTarget(p),m.material.uniforms.tex.value=A,m.render(t),t.setRenderTarget(null),p}},SP={},qv=r=>{let e;const t=new Set,i=(u,h)=>{const f=typeof u=="function"?u(e):u;if(!Object.is(f,e)){const d=e;e=h??(typeof f!="object"||f===null)?f:Object.assign({},e,f),t.forEach(m=>m(e,d))}},n=()=>e,l={setState:i,getState:n,getInitialState:()=>c,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{(SP?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},c=e=r(i,n,l);return l},TP=r=>r?qv(r):qv;var o0={exports:{}},a0={},l0={exports:{}},c0={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Xv;function bP(){if(Xv)return c0;Xv=1;var r=eE();function e(h,f){return h===f&&(h!==0||1/h===1/f)||h!==h&&f!==f}var t=typeof Object.is=="function"?Object.is:e,i=r.useState,n=r.useEffect,s=r.useLayoutEffect,o=r.useDebugValue;function a(h,f){var d=f(),m=i({inst:{value:d,getSnapshot:f}}),A=m[0].inst,p=m[1];return s(function(){A.value=d,A.getSnapshot=f,l(A)&&p({inst:A})},[h,d,f]),n(function(){return l(A)&&p({inst:A}),h(function(){l(A)&&p({inst:A})})},[h]),o(d),d}function l(h){var f=h.getSnapshot;h=h.value;try{var d=f();return!t(h,d)}catch{return!0}}function c(h,f){return f()}var u=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:a;return c0.useSyncExternalStore=r.useSyncExternalStore!==void 0?r.useSyncExternalStore:u,c0}var Jv;function wP(){return Jv||(Jv=1,l0.exports=bP()),l0.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Zv;function BP(){if(Zv)return a0;Zv=1;var r=eE(),e=wP();function t(c,u){return c===u&&(c!==0||1/c===1/u)||c!==c&&u!==u}var i=typeof Object.is=="function"?Object.is:t,n=e.useSyncExternalStore,s=r.useRef,o=r.useEffect,a=r.useMemo,l=r.useDebugValue;return a0.useSyncExternalStoreWithSelector=function(c,u,h,f,d){var m=s(null);if(m.current===null){var A={hasValue:!1,value:null};m.current=A}else A=m.current;m=a(function(){function g(_){if(!v){if(v=!0,E=_,_=f(_),d!==void 0&&A.hasValue){var x=A.value;if(d(x,_))return C=x}return C=_}if(x=C,i(E,_))return x;var S=f(_);return d!==void 0&&d(x,S)?(E=_,x):(E=_,C=S)}var v=!1,E,C,I=h===void 0?null:h;return[function(){return g(u())},I===null?void 0:function(){return g(I())}]},[u,h,f,d]);var p=n(c,m[0],m[1]);return o(function(){A.hasValue=!0,A.value=p},[p]),l(p),p},a0}var e2;function RP(){return e2||(e2=1,o0.exports=BP()),o0.exports}var DP=RP();const MP=Qm(DP),SI={},{useDebugValue:LP}=Us,{useSyncExternalStoreWithSelector:PP}=MP;let t2=!1;const FP=r=>r;function kP(r,e=FP,t){(SI?"production":void 0)!=="production"&&t&&!t2&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),t2=!0);const i=PP(r.subscribe,r.getState,r.getServerState||r.getInitialState,e,t);return LP(i),i}const i2=r=>{(SI?"production":void 0)!=="production"&&typeof r!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof r=="function"?TP(r):r,t=(i,n)=>kP(e,i,n);return Object.assign(t,e),t},OP=r=>r?i2(r):i2;var n2,s2;const r2=typeof window<"u"&&((n2=window.document)!=null&&n2.createElement||((s2=window.navigator)==null?void 0:s2.product)==="ReactNative")?Us.useLayoutEffect:Us.useEffect;function UP(){const r=OP(e=>({current:new Array,version:0,set:e}));return{In:({children:e})=>{const t=r(n=>n.set),i=r(n=>n.version);return r2(()=>{t(n=>({version:n.version+1}))},[]),r2(()=>(t(({current:n})=>({current:[...n,e]})),()=>t(({current:n})=>({current:n.filter(s=>s!==e)}))),[e,i]),null},Out:()=>{const e=r(t=>t.current);return Us.createElement(Us.Fragment,null,e)}}}const NP=r=>r&&r.isOrthographicCamera,o2=new et,TI=UP();function bI(r){return"top"in r}function u0(r,e){const{right:t,top:i,left:n,bottom:s,width:o,height:a}=e,l=e.bottom<0||i>r.height||t<0||e.left>r.width;if(bI(r)){const h=r.top+r.height-s,f=n-r.left;return{position:{width:o,height:a,left:f,top:i,bottom:h,right:t},isOffscreen:l}}const c=r.height-s;return{position:{width:o,height:a,top:i,left:n,bottom:c,right:t},isOffscreen:l}}function h0(r,{left:e,bottom:t,width:i,height:n}){let s;const o=i/n;return NP(r.camera)?r.camera.manual?r.camera.updateProjectionMatrix():(r.camera.left!==i/-2||r.camera.right!==i/2||r.camera.top!==n/2||r.camera.bottom!==n/-2)&&(Object.assign(r.camera,{left:i/-2,right:i/2,top:n/2,bottom:n/-2}),r.camera.updateProjectionMatrix()):r.camera.aspect!==o&&(r.camera.aspect=o,r.camera.updateProjectionMatrix()),s=r.gl.autoClear,r.gl.autoClear=!1,r.gl.setViewport(e,t,i,n),r.gl.setScissor(e,t,i,n),r.gl.setScissorTest(!0),s}function f0(r,e){r.gl.setScissorTest(!1),r.gl.autoClear=e}function a2(r){r.gl.getClearColor(o2),r.gl.setClearColor(o2,r.gl.getClearAlpha()),r.gl.clear(!0,!0)}function GP({visible:r=!0,canvasSize:e,scene:t,index:i,children:n,frames:s,rect:o,track:a}){const l=de(),[c,u]=y.useState(!1);let h=0;return We(f=>{if(s===1/0||h<=s){var d;a&&(o.current=(d=a.current)==null?void 0:d.getBoundingClientRect()),h++}if(o.current){const{position:m,isOffscreen:A}=u0(e,o.current);if(c!==A&&u(A),r&&!c&&o.current){const p=h0(f,m);f.gl.render(n?f.scene:t,f.camera),f0(f,p)}}},i),y.useLayoutEffect(()=>{const f=o.current;if(f&&(!r||!c)){const{position:d}=u0(e,f),m=h0(l,d);a2(l),f0(l,m)}},[r,c]),y.useEffect(()=>{if(!a)return;const f=o.current,d=l.get().events.connected;return l.setEvents({connected:a.current}),()=>{if(f){const{position:m}=u0(e,f),A=h0(l,m);a2(l),f0(l,A)}l.setEvents({connected:d})}},[a]),y.useEffect(()=>{bI(e)||console.warn(`Detected @react-three/fiber canvas size does not include position information. <View /> may not work as expected. Upgrade to @react-three/fiber ^8.1.0 for support.
 See https://github.com/pmndrs/drei/issues/944`)},[]),y.createElement(y.Fragment,null,n,y.createElement("group",{onPointerOver:()=>null}))}const wI=y.forwardRef(({track:r,visible:e=!0,index:t=1,id:i,style:n,className:s,frames:o=1/0,children:a,...l},c)=>{var u,h,f,d;const m=y.useRef(null),{size:A,scene:p}=de(),[g]=y.useState(()=>new Nr),[v,E]=y.useReducer(()=>!0,!1),C=y.useCallback((I,_)=>{if(m.current&&r&&r.current&&I.target===r.current){const{width:x,height:S,left:b,top:T}=m.current,B=I.clientX-b,w=I.clientY-T;_.pointer.set(B/x*2-1,-(w/S)*2+1),_.raycaster.setFromCamera(_.pointer,_.camera)}},[m,r]);return y.useEffect(()=>{var I;r&&(m.current=(I=r.current)==null?void 0:I.getBoundingClientRect()),E()},[r]),y.createElement("group",_e({ref:c},l),v&&uo(y.createElement(GP,{visible:e,canvasSize:A,frames:o,scene:p,track:r,rect:m,index:t},a),g,{events:{compute:C,priority:t},size:{width:(u=m.current)==null?void 0:u.width,height:(h=m.current)==null?void 0:h.height,top:(f=m.current)==null?void 0:f.top,left:(d=m.current)==null?void 0:d.left}}))}),QP=y.forwardRef(({as:r="div",id:e,visible:t,className:i,style:n,index:s=1,track:o,frames:a=1/0,children:l,...c},u)=>{const h=y.useId(),f=y.useRef(null);return y.useImperativeHandle(u,()=>f.current),y.createElement(y.Fragment,null,y.createElement(r,_e({ref:f,id:e,className:i,style:n},c)),y.createElement(TI.In,null,y.createElement(wI,{visible:t,key:h,track:f,frames:a,index:s},l)))}),XO=(()=>{const r=y.forwardRef((e,t)=>y.useContext(x0)?y.createElement(wI,_e({ref:t},e)):y.createElement(QP,_e({ref:t},e)));return r.Port=()=>y.createElement(TI.Out,null),r})(),yc=y.createContext(null),Mu=new K,l2=new K,zP=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(Mu.copy(i).multiplyScalar(n/o).sub(e),l2.copy(i).multiplyScalar(s/o).add(t).sub(r),-Mu.dot(l2)/Mu.dot(Mu))},HP=new K(0,1,0),c2=new Me,d0=({direction:r,axis:e})=>{const{translation:t,translationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:m,onDragEnd:A,userData:p}=y.useContext(yc),g=de(W=>W.controls),v=y.useRef(null),E=y.useRef(null),C=y.useRef(null),I=y.useRef(0),[_,x]=y.useState(!1),S=y.useCallback(W=>{n&&(v.current.innerText=`${t.current[e].toFixed(2)}`,v.current.style.display="block"),W.stopPropagation();const q=new Me().extractRotation(E.current.matrixWorld),F=W.point.clone(),N=new K().setFromMatrixPosition(E.current.matrixWorld),L=r.clone().applyMatrix4(q).normalize();C.current={clickPoint:F,dir:L},I.current=t.current[e],d({component:"Arrow",axis:e,origin:N,directions:[L]}),g&&(g.enabled=!1),W.target.setPointerCapture(W.pointerId)},[n,r,g,d,t,e]),b=y.useCallback(W=>{if(W.stopPropagation(),_||x(!0),C.current){const{clickPoint:q,dir:F}=C.current,[N,L]=i?.[e]||[void 0,void 0];let $=zP(q,F,W.ray.origin,W.ray.direction);N!==void 0&&($=Math.max($,N-I.current)),L!==void 0&&($=Math.min($,L-I.current)),t.current[e]=I.current+$,n&&(v.current.innerText=`${t.current[e].toFixed(2)}`),c2.makeTranslation(F.x*$,F.y*$,F.z*$),m(c2)}},[n,m,_,t,i,e]),T=y.useCallback(W=>{n&&(v.current.style.display="none"),W.stopPropagation(),C.current=null,A(),g&&(g.enabled=!0),W.target.releasePointerCapture(W.pointerId)},[n,g,A]),B=y.useCallback(W=>{W.stopPropagation(),x(!1)},[]),{cylinderLength:w,coneWidth:R,coneLength:D,matrixL:G}=y.useMemo(()=>{const W=c?l/a*1.6:a/20,q=c?.2:a/5,F=c?1-q:a-q,N=new ht().setFromUnitVectors(HP,r.clone().normalize()),L=new Me().makeRotationFromQuaternion(N);return{cylinderLength:F,coneWidth:W,coneLength:q,matrixL:L}},[r,a,l,c]),z=_?h:u[e];return y.createElement("group",{ref:E},y.createElement("group",{matrix:G,matrixAutoUpdate:!1,onPointerDown:S,onPointerMove:b,onPointerUp:T,onPointerOut:B},n&&y.createElement(Lh,{position:[0,-D,0]},y.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),y.createElement("mesh",{visible:!1,position:[0,(w+D)/2,0],userData:p},y.createElement("cylinderGeometry",{args:[R*1.4,R*1.4,w+D,8,1]})),y.createElement(Qs,{transparent:!0,raycast:()=>null,depthTest:o,points:[0,0,0,0,w,0],lineWidth:l,side:wi,color:z,opacity:f,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),y.createElement("mesh",{raycast:()=>null,position:[0,w+D/2,0],renderOrder:500},y.createElement("coneGeometry",{args:[R,D,24,1]}),y.createElement("meshBasicMaterial",{transparent:!0,depthTest:o,color:z,opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},m0=new K,A0=new K,p0=r=>r*180/Math.PI,VP=r=>r*Math.PI/180,KP=(r,e,t,i,n)=>{m0.copy(r).sub(t),A0.copy(e).sub(t);const s=i.dot(i),o=n.dot(n),a=m0.dot(i)/s,l=m0.dot(n)/o,c=A0.dot(i)/s,u=A0.dot(n)/o,h=Math.atan2(l,a);return Math.atan2(u,c)-h},$P=(r,e)=>{let t=Math.floor(r/e);return t=t<0?t+1:t,r-t*e},u2=r=>{let e=$P(r,2*Math.PI);return Math.abs(e)<1e-6?0:(e<0&&(e+=2*Math.PI),e)},Lu=new Me,h2=new K,Pu=new Ia,g0=new K,y0=({dir1:r,dir2:e,axis:t})=>{const{rotationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:m,onDragEnd:A,userData:p}=y.useContext(yc),g=de(z=>z.controls),v=y.useRef(null),E=y.useRef(null),C=y.useRef(0),I=y.useRef(0),_=y.useRef(null),[x,S]=y.useState(!1),b=y.useCallback(z=>{n&&(v.current.innerText=`${p0(I.current).toFixed(0)}º`,v.current.style.display="block"),z.stopPropagation();const W=z.point.clone(),q=new K().setFromMatrixPosition(E.current.matrixWorld),F=new K().setFromMatrixColumn(E.current.matrixWorld,0).normalize(),N=new K().setFromMatrixColumn(E.current.matrixWorld,1).normalize(),L=new K().setFromMatrixColumn(E.current.matrixWorld,2).normalize(),$=new Hs().setFromNormalAndCoplanarPoint(L,q);_.current={clickPoint:W,origin:q,e1:F,e2:N,normal:L,plane:$},d({component:"Rotator",axis:t,origin:q,directions:[F,N,L]}),g&&(g.enabled=!1),z.target.setPointerCapture(z.pointerId)},[n,g,d,t]),T=y.useCallback(z=>{if(z.stopPropagation(),x||S(!0),_.current){const{clickPoint:W,origin:q,e1:F,e2:N,normal:L,plane:$}=_.current,[j,V]=i?.[t]||[void 0,void 0];Pu.copy(z.ray),Pu.intersectPlane($,g0),Pu.direction.negate(),Pu.intersectPlane($,g0);let k=KP(W,g0,q,F,N),Q=p0(k);z.shiftKey&&(Q=Math.round(Q/10)*10,k=VP(Q)),j!==void 0&&V!==void 0&&V-j<2*Math.PI?(k=u2(k),k=k>Math.PI?k-2*Math.PI:k,k=ot.clamp(k,j-C.current,V-C.current),I.current=C.current+k):(I.current=u2(C.current+k),I.current=I.current>Math.PI?I.current-2*Math.PI:I.current),n&&(Q=p0(I.current),v.current.innerText=`${Q.toFixed(0)}º`),Lu.makeRotationAxis(L,k),h2.copy(q).applyMatrix4(Lu).sub(q).negate(),Lu.setPosition(h2),m(Lu)}},[n,m,x,i,t]),B=y.useCallback(z=>{n&&(v.current.style.display="none"),z.stopPropagation(),C.current=I.current,_.current=null,A(),g&&(g.enabled=!0),z.target.releasePointerCapture(z.pointerId)},[n,g,A]),w=y.useCallback(z=>{z.stopPropagation(),S(!1)},[]),R=y.useMemo(()=>{const z=r.clone().normalize(),W=e.clone().normalize();return new Me().makeBasis(z,W,z.clone().cross(W))},[r,e]),D=c?.65:a*.65,G=y.useMemo(()=>{const W=[];for(let q=0;q<=32;q++){const F=q*(Math.PI/2)/32;W.push(new K(Math.cos(F)*D,Math.sin(F)*D,0))}return W},[D]);return y.createElement("group",{ref:E,onPointerDown:b,onPointerMove:T,onPointerUp:B,onPointerOut:w,matrix:R,matrixAutoUpdate:!1},n&&y.createElement(Lh,{position:[D,D,0]},y.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),y.createElement(Qs,{points:G,lineWidth:l*4,visible:!1,userData:p}),y.createElement(Qs,{transparent:!0,raycast:()=>null,depthTest:o,points:G,lineWidth:l,side:wi,color:x?h:u[t],opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))},jP=(r,e,t)=>{const i=Math.abs(r.x)>=Math.abs(r.y)&&Math.abs(r.x)>=Math.abs(r.z)?0:Math.abs(r.y)>=Math.abs(r.x)&&Math.abs(r.y)>=Math.abs(r.z)?1:2,n=[0,1,2].sort((m,A)=>Math.abs(e.getComponent(A))-Math.abs(e.getComponent(m))),s=i===n[0]?n[1]:n[0],o=r.getComponent(i),a=r.getComponent(s),l=e.getComponent(i),c=e.getComponent(s),u=t.getComponent(i),f=(t.getComponent(s)-u*(a/o))/(c-l*(a/o));return[(u-f*l)/o,f]},Fu=new Ia,ku=new K,f2=new Me,v0=({dir1:r,dir2:e,axis:t})=>{const{translation:i,translationLimits:n,annotations:s,annotationsClass:o,depthTest:a,scale:l,lineWidth:c,fixed:u,axisColors:h,hoveredColor:f,opacity:d,onDragStart:m,onDrag:A,onDragEnd:p,userData:g}=y.useContext(yc),v=de(F=>F.controls),E=y.useRef(null),C=y.useRef(null),I=y.useRef(null),_=y.useRef(0),x=y.useRef(0),[S,b]=y.useState(!1),T=y.useCallback(F=>{s&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`,E.current.style.display="block"),F.stopPropagation();const N=F.point.clone(),L=new K().setFromMatrixPosition(C.current.matrixWorld),$=new K().setFromMatrixColumn(C.current.matrixWorld,0).normalize(),j=new K().setFromMatrixColumn(C.current.matrixWorld,1).normalize(),V=new K().setFromMatrixColumn(C.current.matrixWorld,2).normalize(),k=new Hs().setFromNormalAndCoplanarPoint(V,L);I.current={clickPoint:N,e1:$,e2:j,plane:k},_.current=i.current[(t+1)%3],x.current=i.current[(t+2)%3],m({component:"Slider",axis:t,origin:L,directions:[$,j,V]}),v&&(v.enabled=!1),F.target.setPointerCapture(F.pointerId)},[s,v,m,t]),B=y.useCallback(F=>{if(F.stopPropagation(),S||b(!0),I.current){const{clickPoint:N,e1:L,e2:$,plane:j}=I.current,[V,k]=n?.[(t+1)%3]||[void 0,void 0],[Q,O]=n?.[(t+2)%3]||[void 0,void 0];Fu.copy(F.ray),Fu.intersectPlane(j,ku),Fu.direction.negate(),Fu.intersectPlane(j,ku),ku.sub(N);let[U,te]=jP(L,$,ku);V!==void 0&&(U=Math.max(U,V-_.current)),k!==void 0&&(U=Math.min(U,k-_.current)),Q!==void 0&&(te=Math.max(te,Q-x.current)),O!==void 0&&(te=Math.min(te,O-x.current)),i.current[(t+1)%3]=_.current+U,i.current[(t+2)%3]=x.current+te,s&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`),f2.makeTranslation(U*L.x+te*$.x,U*L.y+te*$.y,U*L.z+te*$.z),A(f2)}},[s,A,S,i,n,t]),w=y.useCallback(F=>{s&&(E.current.style.display="none"),F.stopPropagation(),I.current=null,p(),v&&(v.enabled=!0),F.target.releasePointerCapture(F.pointerId)},[s,v,p]),R=y.useCallback(F=>{F.stopPropagation(),b(!1)},[]),D=y.useMemo(()=>{const F=r.clone().normalize(),N=e.clone().normalize();return new Me().makeBasis(F,N,F.clone().cross(N))},[r,e]),G=u?1/7:l/7,z=u?.225:l*.225,W=S?f:h[t],q=y.useMemo(()=>[new K(0,0,0),new K(0,z,0),new K(z,z,0),new K(z,0,0),new K(0,0,0)],[z]);return y.createElement("group",{ref:C,matrix:D,matrixAutoUpdate:!1},s&&y.createElement(Lh,{position:[0,0,0]},y.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:o,ref:E})),y.createElement("group",{position:[G*1.7,G*1.7,0]},y.createElement("mesh",{visible:!0,onPointerDown:T,onPointerMove:B,onPointerUp:w,onPointerOut:R,scale:z,userData:g},y.createElement("planeGeometry",null),y.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:W,polygonOffset:!0,polygonOffsetFactor:-10,side:wi,fog:!1})),y.createElement(Qs,{position:[-z/2,-z/2,0],transparent:!0,depthTest:a,points:q,lineWidth:c,color:W,opacity:d,polygonOffset:!0,polygonOffsetFactor:-10,userData:g,fog:!1})))},Rl=new K,d2=new K,YP=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(Rl.copy(i).multiplyScalar(n/o).sub(e),d2.copy(i).multiplyScalar(s/o).add(t).sub(r),-Rl.dot(d2)/Rl.dot(Rl))},WP=new K(0,1,0),Cl=new K,m2=new Me,E0=({direction:r,axis:e})=>{const{scaleLimits:t,annotations:i,annotationsClass:n,depthTest:s,scale:o,lineWidth:a,fixed:l,axisColors:c,hoveredColor:u,opacity:h,onDragStart:f,onDrag:d,onDragEnd:m,userData:A}=y.useContext(yc),p=de(q=>q.size),g=de(q=>q.controls),v=y.useRef(null),E=y.useRef(null),C=y.useRef(null),I=y.useRef(1),_=y.useRef(1),x=y.useRef(null),[S,b]=y.useState(!1),T=l?1.2:1.2*o,B=y.useCallback(q=>{i&&(v.current.innerText=`${_.current.toFixed(2)}`,v.current.style.display="block"),q.stopPropagation();const F=new Me().extractRotation(E.current.matrixWorld),N=q.point.clone(),L=new K().setFromMatrixPosition(E.current.matrixWorld),$=r.clone().applyMatrix4(F).normalize(),j=E.current.matrixWorld.clone(),V=j.clone().invert(),k=l?1/fA(E.current.getWorldPosition(Rl),o,q.camera,p):1;x.current={clickPoint:N,dir:$,mPLG:j,mPLGInv:V,offsetMultiplier:k},f({component:"Sphere",axis:e,origin:L,directions:[$]}),g&&(g.enabled=!1),q.target.setPointerCapture(q.pointerId)},[i,g,r,f,e,l,o,p]),w=y.useCallback(q=>{if(q.stopPropagation(),S||b(!0),x.current){const{clickPoint:F,dir:N,mPLG:L,mPLGInv:$,offsetMultiplier:j}=x.current,[V,k]=t?.[e]||[1e-5,void 0],O=YP(F,N,q.ray.origin,q.ray.direction)*j,U=l?O:O/o;let te=Math.pow(2,U*.2);q.shiftKey&&(te=Math.round(te*10)/10),te=Math.max(te,V/I.current),k!==void 0&&(te=Math.min(te,k/I.current)),_.current=I.current*te,C.current.position.set(0,T+O,0),i&&(v.current.innerText=`${_.current.toFixed(2)}`),Cl.set(1,1,1),Cl.setComponent(e,te),m2.makeScale(Cl.x,Cl.y,Cl.z).premultiply(L).multiply($),d(m2)}},[i,T,d,S,t,e]),R=y.useCallback(q=>{i&&(v.current.style.display="none"),q.stopPropagation(),I.current=_.current,x.current=null,C.current.position.set(0,T,0),m(),g&&(g.enabled=!0),q.target.releasePointerCapture(q.pointerId)},[i,g,m,T]),D=y.useCallback(q=>{q.stopPropagation(),b(!1)},[]),{radius:G,matrixL:z}=y.useMemo(()=>{const q=l?a/o*1.8:o/22.5,F=new ht().setFromUnitVectors(WP,r.clone().normalize()),N=new Me().makeRotationFromQuaternion(F);return{radius:q,matrixL:N}},[r,o,a,l]),W=S?u:c[e];return y.createElement("group",{ref:E},y.createElement("group",{matrix:z,matrixAutoUpdate:!1,onPointerDown:B,onPointerMove:w,onPointerUp:R,onPointerOut:D},i&&y.createElement(Lh,{position:[0,T/2,0]},y.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:n,ref:v})),y.createElement("mesh",{ref:C,position:[0,T,0],renderOrder:500,userData:A},y.createElement("sphereGeometry",{args:[G,12,12]}),y.createElement("meshBasicMaterial",{transparent:!0,depthTest:s,color:W,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},A2=new Me,p2=new Me,g2=new Me,Ou=new Me,C0=new Me,zo=new Me,y2=new Me,v2=new Me,E2=new Me,Ho=new oi,I0=new oi,C2=new K,I2=new K,_2=new K,x2=new K,Il=new K,Vo=new K(1,0,0),Ko=new K(0,1,0),$o=new K(0,0,1),JO=y.forwardRef(({enabled:r=!0,matrix:e,onDragStart:t,onDrag:i,onDragEnd:n,autoTransform:s=!0,anchor:o,disableAxes:a=!1,disableSliders:l=!1,disableRotations:c=!1,disableScaling:u=!1,activeAxes:h=[!0,!0,!0],offset:f=[0,0,0],rotation:d=[0,0,0],scale:m=1,lineWidth:A=4,fixed:p=!1,translationLimits:g,rotationLimits:v,scaleLimits:E,depthTest:C=!0,axisColors:I=["#ff2060","#20df80","#2080ff"],hoveredColor:_="#ffff40",annotations:x=!1,annotationsClass:S,opacity:b=1,visible:T=!0,userData:B,children:w,...R},D)=>{const G=de(k=>k.invalidate),z=y.useRef(null),W=y.useRef(null),q=y.useRef(null),F=y.useRef(null),N=y.useRef([0,0,0]),L=y.useRef(new K(1,1,1)),$=y.useRef(new K(1,1,1));y.useLayoutEffect(()=>{o&&(F.current.updateWorldMatrix(!0,!0),Ou.copy(F.current.matrixWorld).invert(),Ho.makeEmpty(),F.current.traverse(k=>{k.geometry&&(k.geometry.boundingBox||k.geometry.computeBoundingBox(),zo.copy(k.matrixWorld).premultiply(Ou),I0.copy(k.geometry.boundingBox),I0.applyMatrix4(zo),Ho.union(I0))}),C2.copy(Ho.max).add(Ho.min).multiplyScalar(.5),I2.copy(Ho.max).sub(Ho.min).multiplyScalar(.5),_2.copy(I2).multiply(new K(...o)).add(C2),x2.set(...f).add(_2),q.current.position.copy(x2),G())});const j=y.useMemo(()=>({onDragStart:k=>{A2.copy(W.current.matrix),p2.copy(W.current.matrixWorld),t&&t(k),G()},onDrag:k=>{g2.copy(z.current.matrixWorld),Ou.copy(g2).invert(),C0.copy(p2).premultiply(k),zo.copy(C0).premultiply(Ou),y2.copy(A2).invert(),v2.copy(zo).multiply(y2),s&&W.current.matrix.copy(zo),i&&i(zo,v2,C0,k),G()},onDragEnd:()=>{n&&n(),G()},translation:N,translationLimits:g,rotationLimits:v,axisColors:I,hoveredColor:_,opacity:b,scale:m,lineWidth:A,fixed:p,depthTest:C,userData:B,annotations:x,annotationsClass:S}),[t,i,n,N,g,v,E,C,m,A,p,...I,_,b,B,s,x,S]),V=new K;return We(k=>{if(p){const Q=fA(q.current.getWorldPosition(V),m,k.camera,k.size);L.current.setScalar(Q)}e&&e instanceof Me&&(W.current.matrix=e),W.current.updateWorldMatrix(!0,!0),E2.makeRotationFromEuler(q.current.rotation).setPosition(q.current.position).premultiply(W.current.matrixWorld),$.current.setFromMatrixScale(E2),Il.copy(L.current).divide($.current),(Math.abs(q.current.scale.x-Il.x)>1e-4||Math.abs(q.current.scale.y-Il.y)>1e-4||Math.abs(q.current.scale.z-Il.z)>1e-4)&&(q.current.scale.copy(Il),k.invalidate())}),y.useImperativeHandle(D,()=>W.current,[]),y.createElement(yc.Provider,{value:j},y.createElement("group",{ref:z},y.createElement("group",_e({ref:W,matrix:e,matrixAutoUpdate:!1},R),y.createElement("group",{visible:T,ref:q,position:f,rotation:d},r&&y.createElement(y.Fragment,null,!a&&h[0]&&y.createElement(d0,{axis:0,direction:Vo}),!a&&h[1]&&y.createElement(d0,{axis:1,direction:Ko}),!a&&h[2]&&y.createElement(d0,{axis:2,direction:$o}),!l&&h[0]&&h[1]&&y.createElement(v0,{axis:2,dir1:Vo,dir2:Ko}),!l&&h[0]&&h[2]&&y.createElement(v0,{axis:1,dir1:$o,dir2:Vo}),!l&&h[2]&&h[1]&&y.createElement(v0,{axis:0,dir1:Ko,dir2:$o}),!c&&h[0]&&h[1]&&y.createElement(y0,{axis:2,dir1:Vo,dir2:Ko}),!c&&h[0]&&h[2]&&y.createElement(y0,{axis:1,dir1:$o,dir2:Vo}),!c&&h[2]&&h[1]&&y.createElement(y0,{axis:0,dir1:Ko,dir2:$o}),!u&&h[0]&&y.createElement(E0,{axis:0,direction:Vo}),!u&&h[1]&&y.createElement(E0,{axis:1,direction:Ko}),!u&&h[2]&&y.createElement(E0,{axis:2,direction:$o}))),y.createElement("group",{ref:F},w))))}),ZO=y.forwardRef(({options:r={video:!0},...e},t)=>{const i=fr(()=>navigator.mediaDevices.getDisplayMedia(r),[]);return y.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),Bh([])},[i]),y.createElement(QA,_e({ref:t},e,{src:i}))}),qP=y.forwardRef(({constraints:r={audio:!1,video:{facingMode:"user"}},...e},t)=>{const i=fr(()=>navigator.mediaDevices.getUserMedia(r),[]);return y.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),Bh([])},[i]),y.createElement(QA,_e({ref:t},e,{src:i}))}),XP=new K(0,0,-1),JP=function(){const r=new K,e=new K,t=new K,i=new K,n=new K;return function(s,o,a,l){return r.copy(s),e.copy(o),t.copy(a),i.copy(e).sub(r),n.copy(t).sub(r),l.crossVectors(n,i).normalize()}}();function ZP(r,e){return r.clone().add(e).multiplyScalar(.5)}const eF=y.forwardRef(({points:r=_0.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:e,facialTransformationMatrix:t,faceBlendshapes:i,offset:n,offsetScalar:s=80,width:o,height:a,depth:l=1,verticalTri:c=[159,386,152],origin:u,eyes:h=!0,eyesAsOrigin:f=!1,debug:d=!1,children:m,...A},p)=>{var g;e&&(r=e.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const v=y.useRef(null),E=y.useRef(null),C=y.useRef(null),I=y.useRef(null),_=y.useRef(null),x=y.useRef(null),S=y.useRef(null),[b]=y.useState(()=>new K),[T]=y.useState(()=>new Ei),[B]=y.useState(()=>new ht),[w]=y.useState(()=>new K),{invalidate:R}=de();y.useEffect(()=>{var F;(F=_.current)==null||F.geometry.setIndex(_0.TRIANGULATION)},[]);const[D]=y.useState(()=>new K);y.useEffect(()=>{var F,N;const L=(F=_.current)==null?void 0:F.geometry;if(!L)return;if(L.setFromPoints(r),L.setDrawRange(0,_0.TRIANGULATION.length),t)if(T.matrix.fromArray(t.data),T.matrix.decompose(T.position,T.quaternion,T.scale),T.rotation.y*=-1,T.rotation.z*=-1,B.setFromEuler(T.rotation),n){var $;T.position.y*=-1,T.position.z*=-1,($=v.current)==null||$.position.copy(T.position.divideScalar(s))}else{var j;(j=v.current)==null||j.position.set(0,0,0)}else JP(r[c[0]],r[c[1]],r[c[2]],b),B.setFromUnitVectors(XP,b);const V=B.clone().invert();if(L.computeBoundingBox(),d&&R(),L.center(),L.applyQuaternion(V),(N=I.current)==null||N.setRotationFromQuaternion(B),h){if(!i)console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");else if(x.current&&S.current&&C.current)if(f){const k=x.current._computeSphere(L),Q=S.current._computeSphere(L);u=ZP(k.center,Q.center).negate(),x.current._update(L,i,k),S.current._update(L,i,Q)}else x.current._update(L,i),S.current._update(L,i)}if(C.current){if(u!==void 0)if(typeof u=="number"){const k=L.getAttribute("position");w.set(-k.getX(u),-k.getY(u),-k.getZ(u))}else u.isVector3&&w.copy(u);else w.setScalar(0);C.current.position.copy(w)}if(E.current){let k=1;(o||a||l)&&(L.boundingBox.getSize(D),o&&(k=o/D.x),a&&(k=a/D.y),l&&(k=l/D.z)),E.current.scale.setScalar(k!==1?k:1)}L.computeVertexNormals(),L.attributes.position.needsUpdate=!0},[r,t,i,T,n,s,o,a,l,c,u,h,d,R,b,B,D,w]);const G=y.useMemo(()=>({outerRef:I,meshRef:_,eyeRightRef:x,eyeLeftRef:S}),[]);y.useImperativeHandle(p,()=>G,[G]);const[z]=y.useState(()=>new K),W=(g=_.current)==null?void 0:g.geometry.boundingBox,q=W?.getSize(z).z||1;return y.createElement("group",A,y.createElement("group",{ref:v},y.createElement("group",{ref:I},y.createElement("group",{ref:E},d?y.createElement(y.Fragment,null,y.createElement("axesHelper",{args:[q]}),y.createElement(Qs,{points:[[0,0,0],[0,0,-q]],color:65535})):null,y.createElement("group",{ref:C},h&&i&&y.createElement("group",{name:"eyes"},y.createElement(S2,{side:"left",ref:x,debug:d}),y.createElement(S2,{side:"right",ref:S,debug:d})),y.createElement("mesh",{ref:_,name:"face"},m,d?y.createElement(y.Fragment,null,W&&y.createElement("box3Helper",{args:[W]})):null))))))}),_l={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},S2=y.forwardRef(({side:r,debug:e=!0},t)=>{const i=y.useRef(null),n=y.useRef(null),[s]=y.useState(()=>new un),o=y.useCallback(h=>{const f=h.getAttribute("position"),m=_l.contourLandmarks[r].map(A=>new K(f.getX(A),f.getY(A),f.getZ(A)));return s.center.set(0,0,0),m.forEach(A=>s.center.add(A)),s.center.divideScalar(m.length),s.radius=m[0].sub(m[1]).length()/2,s},[s,r]),[a]=y.useState(()=>new Wn),l=y.useCallback((h,f,d)=>{if(i.current){var m;(m=d)!==null&&m!==void 0||(d=o(h)),i.current.position.copy(d.center),i.current.scale.setScalar(d.radius)}if(f&&n.current){const A=_l.blendshapes[r],p=f.categories[A[0]].score,g=f.categories[A[1]].score,v=f.categories[A[2]].score,E=f.categories[A[3]].score,C=_l.fov.horizontal*ot.DEG2RAD,I=_l.fov.vertical*ot.DEG2RAD,_=C*.5*(E-v),x=I*.5*(p-g)*(r==="left"?1:-1);a.set(_,x,0),n.current.setRotationFromEuler(a)}},[o,r,a]),c=y.useMemo(()=>({eyeMeshRef:i,irisDirRef:n,_computeSphere:o,_update:l}),[o,l]);y.useImperativeHandle(t,()=>c,[c]);const u=_l.color[r];return y.createElement("group",null,y.createElement("group",{ref:i},e&&y.createElement("axesHelper",null),y.createElement("group",{ref:n},y.createElement(y.Fragment,null,e&&y.createElement(Qs,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:u})))))}),_0={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:34500112633395474e-23,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:483789051486383e-21,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:108198406678639e-21,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},BI=y.createContext({}),T2={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}},eU=y.forwardRef(({basePath:r=T2.basePath,options:e=T2.options,children:t},i)=>{const n=JSON.stringify(e),s=fr(async()=>{const{FilesetResolver:o,FaceLandmarker:a}=await W2(async()=>{const{FilesetResolver:c,FaceLandmarker:u}=await import("./vision_bundle-0RleX_6f.js");return{FilesetResolver:c,FaceLandmarker:u}},[]),l=await o.forVisionTasks(r);return a.createFromOptions(l,e)},[r,n]);return y.useEffect(()=>()=>{s?.close(),Bh([r,n])},[s,r,n]),y.useImperativeHandle(i,()=>s,[s]),y.createElement(BI.Provider,{value:s},t)});function tF(){return y.useContext(BI)}function b2(r,e){return r.clone().add(e).multiplyScalar(.5)}function jo(r,e,t){const i=r.localToWorld(e);return t.worldToLocal(i)}const RI=y.createContext({}),tU=y.forwardRef(({camera:r,videoTexture:e={start:!0},manualDetect:t=!1,faceLandmarkerResult:i,manualUpdate:n=!1,makeDefault:s,smoothTime:o=.25,offset:a=!0,offsetScalar:l=80,eyes:c=!1,eyesAsOrigin:u=!0,depth:h=.15,debug:f=!1,facemesh:d},m)=>{var A,p;const g=de(Q=>Q.scene),v=de(Q=>Q.camera),E=de(Q=>Q.set),C=de(Q=>Q.get),I=r||v,_=y.useRef(null),[x]=y.useState(()=>new Ei),[S]=y.useState(()=>new K),[b]=y.useState(()=>new K),[T]=y.useState(()=>new K),[B]=y.useState(()=>new K),w=y.useCallback(()=>{x.parent=I.parent;const Q=_.current;if(Q){const{outerRef:O,eyeRightRef:U,eyeLeftRef:te}=Q;if(U.current&&te.current){const{irisDirRef:le}=U.current,{irisDirRef:ee}=te.current;le.current&&ee.current&&O.current&&(S.copy(jo(le.current,new K(0,0,0),O.current)),b.copy(jo(ee.current,new K(0,0,0),O.current)),x.position.copy(jo(O.current,b2(S,b),I.parent||g)),T.copy(jo(le.current,new K(0,0,1),O.current)),B.copy(jo(ee.current,new K(0,0,1),O.current)),x.lookAt(O.current.localToWorld(b2(T,B))))}else O.current&&(x.position.copy(jo(O.current,new K(0,0,0),I.parent||g)),x.lookAt(O.current.localToWorld(new K(0,0,1))))}return x},[I,b,B,S,T,g,x]),[R]=y.useState(()=>new Ei),D=y.useCallback(function(Q,O){if(I){var U;(U=O)!==null&&U!==void 0||(O=w()),o>0?(da.damp3(R.position,O.position,o,Q,void 0,void 0,1e-9),da.dampE(R.rotation,O.rotation,o,Q,void 0,void 0,1e-9)):(R.position.copy(O.position),R.rotation.copy(O.rotation)),I.position.copy(R.position),I.rotation.copy(R.rotation)}},[I,w,o,R.position,R.rotation]);We((Q,O)=>{n||D(O)});const G=y.useRef(null),[z,W]=y.useState(),q=tF(),F=y.useCallback((Q,O)=>{const U=G.current;if(!U)return;const te=U.source.data,le=q?.detectForVideo(te,Q);W(le)},[q]),N=y.useMemo(()=>Object.assign(Object.create(P_.prototype),{computeTarget:w,update:D,facemeshApiRef:_}),[w,D]);y.useImperativeHandle(m,()=>N,[N]),y.useEffect(()=>{if(s){const Q=C().controls;return E({controls:N}),()=>E({controls:Q})}},[s,N,C,E]);const L=i??z,$=L?.faceLandmarks[0],j=L==null||(A=L.facialTransformationMatrixes)==null?void 0:A[0],V=L==null||(p=L.faceBlendshapes)==null?void 0:p[0],k={onVideoFrame:F,...e};return y.createElement(RI.Provider,{value:N},!t&&y.createElement(y.Suspense,{fallback:null},"src"in k?y.createElement(QA,_e({ref:G},k)):y.createElement(qP,_e({ref:G},k))),y.createElement(eF,_e({ref:_,children:y.createElement("meshNormalMaterial",{side:wi})},d,{points:$,depth:h,facialTransformationMatrix:j,faceBlendshapes:V,eyes:c,eyesAsOrigin:u,offset:a,offsetScalar:l,debug:f,"rotation-z":Math.PI,visible:f})))}),iU=()=>y.useContext(RI);export{BL as AccumulativeShadows,HO as AdaptiveDpr,VO as AdaptiveEvents,sk as ArcballControls,YF as AsciiRenderer,Dk as BBAnchor,CO as Backdrop,QO as BakeShadows,Cb as Billboard,aL as Bounds,qk as Box,bk as Bvh,ak as CameraControls,yO as CameraShake,dO as Capsule,wF as CatmullRomLine,_O as Caustics,tI as Center,Xk as Circle,dh as Clone,BO as Cloud,Gv as CloudInstance,$L as Clouds,QF as ComputedAttribute,Jk as Cone,SL as ContactShadows,JF as CubeCamera,dk as CubeTexture,bF as CubicBezierLine,Nk as CurveModifier,nF as CycleRaycast,Zk as Cylinder,KF as Decal,NO as Detailed,Sk as DetectGPU,ZF as DeviceOrientationControls,uO as Dodecahedron,aF as DragControls,Mw as Edges,LF as Effects,xL as Environment,mI as EnvironmentCube,tp as EnvironmentMap,IL as EnvironmentPortal,Lk as Example,hO as Extrude,tU as FaceControls,eU as FaceLandmarker,T2 as FaceLandmarkerDefaults,eF as Facemesh,_0 as FacemeshDatas,S2 as FacemeshEye,_l as FacemeshEyeDefaults,qF as Fbo,mk as Fbx,ok as FirstPersonControls,WO as Fisheye,vO as Float,ek as FlyControls,ck as GizmoHelper,uk as GizmoViewcube,hk as GizmoViewport,jF as Gltf,PF as GradientTexture,I1 as GradientType,fk as Grid,yk as Helper,Lh as Html,u8 as Hud,lO as Icosahedron,OF as Image,$A as Instance,kk as InstancedAttribute,jA as Instances,Ul as IsObject,hF as KeyboardControls,Ak as Ktx2,fO as Lathe,bO as Lightformer,Qs as Line,oF as Loader,tk as MapControls,HF as MarchingCube,zF as MarchingCubes,VF as MarchingPlane,jO as Mask,DO as MatcapTexture,Pk as Merged,$k as MeshDiscardMaterial,Gk as MeshDistortMaterial,qO as MeshPortalMaterial,Hk as MeshReflectorMaterial,Vk as MeshRefractionMaterial,Kk as MeshTransmissionMaterial,Qk as MeshWobbleMaterial,lk as MotionPathControls,jk as MultiMaterial,MO as NormalTexture,cO as Octahedron,ik as OrbitControls,e8 as OrthographicCamera,UF as Outlines,KO as PerformanceMonitor,XF as PerspectiveCamera,JO as PivotControls,tO as Plane,FO as Point,Yk as PointMaterial,tL as PointMaterialImpl,rU as PointerLockControls,kO as Points,AP as PointsBuffer,aO as Polyhedron,VM as PositionMesh,dP as PositionPoint,BF as PositionalAudio,GO as Preload,uF as PresentationControls,rF as Progress,TF as QuadraticBezierLine,RL as RandomizedLight,xO as Reflector,vP as RenderCubeTexture,gP as RenderTexture,gO as Resize,oO as Ring,AO as RoundedBox,GF as Sampler,pO as ScreenQuad,SF as ScreenSizer,xF as ScreenSpace,ZO as ScreenVideoTexture,cF as Scroll,lF as ScrollControls,UO as Segment,pP as SegmentObject,OO as Segments,IF as Select,IO as Shadow,PO as ShadowAlpha,mO as Shape,oU as Sky,Wk as SoftShadows,RO as Sparkles,eO as Sphere,WF as Splat,TO as SpotLight,SO as SpotLightShadow,Uk as SpriteAnimator,EO as Stage,wO as Stars,vk as Stats,Ek as StatsGl,$F as Svg,rO as Tetrahedron,DF as Text,ww as Text3D,kF as Texture,nO as Torus,sO as TorusKnot,nk as TrackballControls,NF as Trail,Mk as TrailTexture,rk as TransformControls,iO as Tube,QA as VideoTexture,XO as View,qP as WebcamVideoTexture,LO as Wireframe,AI as accumulativeContext,aU as calcPosFromAngles,fA as calculateScaleFactor,Z7 as checkIfFrameIsEmpty,Fk as createInstances,Xu as getFirstFrame,MF as isWebGL2Available,zO as meshBounds,vs as shaderMaterial,Bk as useAnimations,Ik as useAspect,Tk as useBVH,lL as useBounds,Rk as useBoxProjectedEnv,_k as useCamera,wk as useContextBridge,i8 as useCubeCamera,o4 as useCubeTexture,sF as useCursor,Ck as useDepthBuffer,fD as useDetectGPU,sf as useEnvironment,En as useFBO,gA as useFBX,iU as useFaceControls,tF as useFaceLandmarker,mA as useFont,Kh as useGLTF,pA as useGizmoContext,GC as useHelper,bM as useIntersect,yA as useKTX2,fF as useKeyboardControls,YO as useMask,JL as useMatcapTexture,a8 as useMotion,tP as useNormalTexture,$O as usePerformanceMonitor,nE as useProgress,pE as useScroll,_F as useSelect,Ok as useSpriteAnimator,zA as useSpriteLoader,Vw as useSurfaceSampler,ho as useTexture,Hw as useTrail,kM as useTrailTexture,X7 as useVideoTexture};
